{"content":"---\ntitle: \"How to: Create a Custom Client Identity Verifier\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: f2d34e43-fa8b-46d2-91cf-d2960e13e16b\n---\n# How to: Create a Custom Client Identity Verifier\nThe *identity* feature of Windows Communication Foundation (WCF) enables a client to specify in advance the expected identity of the service. Whenever a server authenticates itself to the client, the identity is checked against the expected identity. (For an explanation of identity and how it works, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).)  \n  \n If needed, the verification can be customized using a custom identity verifier. For example, you can perform additional service identity verification checks. In this example, the custom identity verifier checks additional claims in the X.509 certificate returned from the server. For a sample application, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md).  \n  \n### To extend the EndpointIdentity class  \n  \n1.  Define a new class that derives from the <xref:System.ServiceModel.EndpointIdentity> class. This example names the extension `OrgEndpointIdentity`.  \n  \n2.  Add private members along with properties that will be used by the extended <xref:System.ServiceModel.Security.IdentityVerifier> class to perform the identity check against claims in the security token returned from the service. This example defines one property: the `OrganizationClaim` property.  \n  \n     [!code-csharp[c_HowToSetCustomClientIdentity#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#6)]\n     [!code-vb[c_HowToSetCustomClientIdentity#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#6)]  \n  \n### To extend the IdentityVerifier class  \n  \n1.  Define a new class that derives from <xref:System.ServiceModel.Security.IdentityVerifier>. This example names the extension `CustomIdentityVerifier`.  \n  \n     [!code-csharp[c_HowToSetCustomClientIdentity#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#7)]\n     [!code-vb[c_HowToSetCustomClientIdentity#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#7)]  \n  \n2.  Override the <xref:System.ServiceModel.Security.IdentityVerifier.CheckAccess%2A> method. The method determines whether the identity check succeeded or failed.  \n  \n3.  The `CheckAccess` method has two parameters. The first is an instance of the <xref:System.ServiceModel.EndpointIdentity> class. The second is an instance of the <xref:System.IdentityModel.Policy.AuthorizationContext> class.  \n  \n     In the method implementation, examine the collection of claims returned by the <xref:System.IdentityModel.Policy.AuthorizationContext.ClaimSets%2A> property of the <xref:System.IdentityModel.Policy.AuthorizationContext> class, and perform authentication checks as required. This example begins by finding any claim that is of type \"Distinguished Name\" and then compares the name to the extension of the <xref:System.ServiceModel.EndpointIdentity> (`OrgEndpointIdentity`).  \n  \n     [!code-csharp[c_HowToSetCustomClientIdentity#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#1)]\n     [!code-vb[c_HowToSetCustomClientIdentity#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#1)]  \n  \n### To implement the TryGetIdentity method  \n  \n1.  Implement the <xref:System.ServiceModel.Security.IdentityVerifier.TryGetIdentity%2A> method, which determines whether an instance of the <xref:System.ServiceModel.EndpointIdentity> class can be returned by the client. The WCF infrastructure calls the implementation of the `TryGetIdentity` method first to retrieve the service's identity from the message. Next, the infrastructure calls the `CheckAccess` implementation with the returned `EndpointIdentity` and <xref:System.IdentityModel.Policy.AuthorizationContext>.  \n  \n2.  In the `TryGetIdentity` method, put the following code:  \n  \n     [!code-csharp[c_HowToSetCustomClientIdentity#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#2)]\n     [!code-vb[c_HowToSetCustomClientIdentity#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#2)]  \n  \n### To implement a custom binding and set the custom IdentityVerifier  \n  \n1.  Create a method that returns a <xref:System.ServiceModel.Channels.Binding> object. This example begins creates an instance of the <xref:System.ServiceModel.WSHttpBinding> class and sets its security mode to <xref:System.ServiceModel.SecurityMode.Message>, and its <xref:System.ServiceModel.MessageSecurityOverHttp.ClientCredentialType%2A> to <xref:System.ServiceModel.MessageCredentialType.None>.  \n  \n2.  Create a <xref:System.ServiceModel.Channels.BindingElementCollection> using the <xref:System.ServiceModel.WSHttpBinding.CreateBindingElements%2A> method.  \n  \n3.  Return the <xref:System.ServiceModel.Channels.SecurityBindingElement> from the collection and cast it to a <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> variable.  \n  \n4.  Set the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings.IdentityVerifier%2A> property of the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings> class to a new instance of the `CustomIdentityVerifier` class created previously.  \n  \n     [!code-csharp[c_HowToSetCustomClientIdentity#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#3)]\n     [!code-vb[c_HowToSetCustomClientIdentity#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#3)]  \n  \n5.  The custom binding that is returned is used to create an instance of the client and class. The client can then perform a custom identity verification check of the service as shown in the following code.  \n  \n     [!code-csharp[c_HowToSetCustomClientIdentity#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#4)]\n     [!code-vb[c_HowToSetCustomClientIdentity#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#4)]  \n  \n## Example  \n The following example shows a complete implementation of the <xref:System.ServiceModel.Security.IdentityVerifier> class.  \n  \n [!code-csharp[c_HowToSetCustomClientIdentity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#5)]\n [!code-vb[c_HowToSetCustomClientIdentity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#5)]  \n  \n## Example  \n The following example shows a complete implementation of the <xref:System.ServiceModel.EndpointIdentity> class.  \n  \n [!code-csharp[c_HowToSetCustomClientIdentity#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#6)]\n [!code-vb[c_HowToSetCustomClientIdentity#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#6)]  \n  \n## See also\n\n- <xref:System.ServiceModel.ServiceAuthorizationManager>\n- <xref:System.ServiceModel.EndpointIdentity>\n- <xref:System.ServiceModel.Security.IdentityVerifier>\n- [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md)\n- [Authorization Policy](../../../../docs/framework/wcf/samples/authorization-policy.md)\n","nodes":[{"pos":[4,166],"embed":true,"restype":"x-metadata","content":"title: \"How to: Create a Custom Client Identity Verifier\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: f2d34e43-fa8b-46d2-91cf-d2960e13e16b","nodes":[{"content":"How to: Create a Custom Client Identity Verifier","nodes":[{"pos":[0,48],"content":"How to: Create a Custom Client Identity Verifier","nodes":[{"content":"How to: Create a Custom Client Identity Verifier","pos":[0,48]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[173,221],"content":"How to: Create a Custom Client Identity Verifier","linkify":"How to: Create a Custom Client Identity Verifier","nodes":[{"content":"How to: Create a Custom Client Identity Verifier","pos":[0,48]}]},{"content":"The <bpt id=\"p1\">*</bpt>identity<ept id=\"p1\">*</ept> feature of Windows Communication Foundation (WCF) enables a client to specify in advance the expected identity of the service.","pos":[222,363],"source":"The *identity* feature of Windows Communication Foundation (WCF) enables a client to specify in advance the expected identity of the service."},{"content":"Whenever a server authenticates itself to the client, the identity is checked against the expected identity.","pos":[364,472]},{"content":"(For an explanation of identity and how it works, see <bpt id=\"p1\">[</bpt>Service Identity and Authentication<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)</ept>.)","pos":[473,653],"source":" (For an explanation of identity and how it works, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).)"},{"content":"If needed, the verification can be customized using a custom identity verifier.","pos":[660,739]},{"content":"For example, you can perform additional service identity verification checks.","pos":[740,817]},{"content":"In this example, the custom identity verifier checks additional claims in the X.509 certificate returned from the server.","pos":[818,939]},{"content":"For a sample application, see <bpt id=\"p1\">[</bpt>Service Identity Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/service-identity-sample.md)</ept>.","pos":[940,1063],"source":" For a sample application, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md)."},{"pos":[1073,1109],"content":"To extend the EndpointIdentity class","linkify":"To extend the EndpointIdentity class","nodes":[{"content":"To extend the EndpointIdentity class","pos":[0,36]}]},{"content":"Define a new class that derives from the <ph id=\"ph1\">&lt;xref:System.ServiceModel.EndpointIdentity&gt;</ph> class.","pos":[1119,1210],"source":"Define a new class that derives from the <xref:System.ServiceModel.EndpointIdentity> class."},{"content":"This example names the extension <ph id=\"ph1\">`OrgEndpointIdentity`</ph>.","pos":[1211,1266],"source":" This example names the extension `OrgEndpointIdentity`."},{"content":"Add private members along with properties that will be used by the extended <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.IdentityVerifier&gt;</ph> class to perform the identity check against claims in the security token returned from the service.","pos":[1276,1504],"source":"Add private members along with properties that will be used by the extended <xref:System.ServiceModel.Security.IdentityVerifier> class to perform the identity check against claims in the security token returned from the service."},{"content":"This example defines one property: the <ph id=\"ph1\">`OrganizationClaim`</ph> property.","pos":[1505,1573],"source":" This example defines one property: the `OrganizationClaim` property."},{"pos":[1584,1885],"content":"[!code-csharp[c_HowToSetCustomClientIdentity#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#6)]\n [!code-vb[c_HowToSetCustomClientIdentity#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#6)]","leadings":["","    "],"nodes":[]},{"pos":[1895,1931],"content":"To extend the IdentityVerifier class","linkify":"To extend the IdentityVerifier class","nodes":[{"content":"To extend the IdentityVerifier class","pos":[0,36]}]},{"content":"Define a new class that derives from <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.IdentityVerifier&gt;</ph>.","pos":[1941,2031],"source":"Define a new class that derives from <xref:System.ServiceModel.Security.IdentityVerifier>."},{"content":"This example names the extension <ph id=\"ph1\">`CustomIdentityVerifier`</ph>.","pos":[2032,2090],"source":" This example names the extension `CustomIdentityVerifier`."},{"pos":[2101,2402],"content":"[!code-csharp[c_HowToSetCustomClientIdentity#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#7)]\n [!code-vb[c_HowToSetCustomClientIdentity#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#7)]","leadings":["","    "],"nodes":[]},{"content":"Override the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.IdentityVerifier.CheckAccess%2A&gt;</ph> method.","pos":[2412,2500],"source":"Override the <xref:System.ServiceModel.Security.IdentityVerifier.CheckAccess%2A> method."},{"content":"The method determines whether the identity check succeeded or failed.","pos":[2501,2570]},{"content":"The <ph id=\"ph1\">`CheckAccess`</ph> method has two parameters.","pos":[2580,2624],"source":"The `CheckAccess` method has two parameters."},{"content":"The first is an instance of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.EndpointIdentity&gt;</ph> class.","pos":[2625,2707],"source":" The first is an instance of the <xref:System.ServiceModel.EndpointIdentity> class."},{"content":"The second is an instance of the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.AuthorizationContext&gt;</ph> class.","pos":[2708,2803],"source":" The second is an instance of the <xref:System.IdentityModel.Policy.AuthorizationContext> class."},{"content":"In the method implementation, examine the collection of claims returned by the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.AuthorizationContext.ClaimSets%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Policy.AuthorizationContext&gt;</ph> class, and perform authentication checks as required.","pos":[2814,3087],"source":"In the method implementation, examine the collection of claims returned by the <xref:System.IdentityModel.Policy.AuthorizationContext.ClaimSets%2A> property of the <xref:System.IdentityModel.Policy.AuthorizationContext> class, and perform authentication checks as required."},{"content":"This example begins by finding any claim that is of type \"Distinguished Name\" and then compares the name to the extension of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.EndpointIdentity&gt;</ph> (<ph id=\"ph2\">`OrgEndpointIdentity`</ph>).","pos":[3088,3285],"source":" This example begins by finding any claim that is of type \"Distinguished Name\" and then compares the name to the extension of the <xref:System.ServiceModel.EndpointIdentity> (`OrgEndpointIdentity`)."},{"pos":[3296,3597],"content":"[!code-csharp[c_HowToSetCustomClientIdentity#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#1)]\n [!code-vb[c_HowToSetCustomClientIdentity#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#1)]","leadings":["","    "],"nodes":[]},{"pos":[3607,3645],"content":"To implement the TryGetIdentity method","linkify":"To implement the TryGetIdentity method","nodes":[{"content":"To implement the TryGetIdentity method","pos":[0,38]}]},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.IdentityVerifier.TryGetIdentity%2A&gt;</ph> method, which determines whether an instance of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.EndpointIdentity&gt;</ph> class can be returned by the client.","pos":[3655,3872],"source":"Implement the <xref:System.ServiceModel.Security.IdentityVerifier.TryGetIdentity%2A> method, which determines whether an instance of the <xref:System.ServiceModel.EndpointIdentity> class can be returned by the client."},{"content":"The WCF infrastructure calls the implementation of the <ph id=\"ph1\">`TryGetIdentity`</ph> method first to retrieve the service's identity from the message.","pos":[3873,4010],"source":" The WCF infrastructure calls the implementation of the `TryGetIdentity` method first to retrieve the service's identity from the message."},{"content":"Next, the infrastructure calls the <ph id=\"ph1\">`CheckAccess`</ph> implementation with the returned <ph id=\"ph2\">`EndpointIdentity`</ph> and <ph id=\"ph3\">&lt;xref:System.IdentityModel.Policy.AuthorizationContext&gt;</ph>.","pos":[4011,4172],"source":" Next, the infrastructure calls the `CheckAccess` implementation with the returned `EndpointIdentity` and <xref:System.IdentityModel.Policy.AuthorizationContext>."},{"pos":[4182,4237],"content":"In the <ph id=\"ph1\">`TryGetIdentity`</ph> method, put the following code:","source":"In the `TryGetIdentity` method, put the following code:"},{"pos":[4248,4549],"content":"[!code-csharp[c_HowToSetCustomClientIdentity#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#2)]\n [!code-vb[c_HowToSetCustomClientIdentity#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#2)]","leadings":["","    "],"nodes":[]},{"pos":[4559,4624],"content":"To implement a custom binding and set the custom IdentityVerifier","linkify":"To implement a custom binding and set the custom IdentityVerifier","nodes":[{"content":"To implement a custom binding and set the custom IdentityVerifier","pos":[0,65]}]},{"content":"Create a method that returns a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.Binding&gt;</ph> object.","pos":[4634,4716],"source":"Create a method that returns a <xref:System.ServiceModel.Channels.Binding> object."},{"content":"This example begins creates an instance of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.WSHttpBinding&gt;</ph> class and sets its security mode to <ph id=\"ph2\">&lt;xref:System.ServiceModel.SecurityMode.Message&gt;</ph>, and its <ph id=\"ph3\">&lt;xref:System.ServiceModel.MessageSecurityOverHttp.ClientCredentialType%2A&gt;</ph> to <ph id=\"ph4\">&lt;xref:System.ServiceModel.MessageCredentialType.None&gt;</ph>.","pos":[4717,5030],"source":" This example begins creates an instance of the <xref:System.ServiceModel.WSHttpBinding> class and sets its security mode to <xref:System.ServiceModel.SecurityMode.Message>, and its <xref:System.ServiceModel.MessageSecurityOverHttp.ClientCredentialType%2A> to <xref:System.ServiceModel.MessageCredentialType.None>."},{"pos":[5040,5193],"content":"Create a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.BindingElementCollection&gt;</ph> using the <ph id=\"ph2\">&lt;xref:System.ServiceModel.WSHttpBinding.CreateBindingElements%2A&gt;</ph> method.","source":"Create a <xref:System.ServiceModel.Channels.BindingElementCollection> using the <xref:System.ServiceModel.WSHttpBinding.CreateBindingElements%2A> method."},{"pos":[5203,5387],"content":"Return the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement&gt;</ph> from the collection and cast it to a <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement&gt;</ph> variable.","source":"Return the <xref:System.ServiceModel.Channels.SecurityBindingElement> from the collection and cast it to a <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> variable."},{"pos":[5397,5650],"content":"Set the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.LocalClientSecuritySettings.IdentityVerifier%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.LocalClientSecuritySettings&gt;</ph> class to a new instance of the <ph id=\"ph3\">`CustomIdentityVerifier`</ph> class created previously.","source":"Set the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings.IdentityVerifier%2A> property of the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings> class to a new instance of the `CustomIdentityVerifier` class created previously."},{"pos":[5661,5962],"content":"[!code-csharp[c_HowToSetCustomClientIdentity#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#3)]\n [!code-vb[c_HowToSetCustomClientIdentity#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#3)]","leadings":["","    "],"nodes":[]},{"content":"The custom binding that is returned is used to create an instance of the client and class.","pos":[5972,6062]},{"content":"The client can then perform a custom identity verification check of the service as shown in the following code.","pos":[6063,6174]},{"pos":[6185,6486],"content":"[!code-csharp[c_HowToSetCustomClientIdentity#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howtosetcustomclientidentity/cs/source.cs#4)]\n [!code-vb[c_HowToSetCustomClientIdentity#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howtosetcustomclientidentity/vb/source.vb#4)]","leadings":["","    "],"nodes":[]},{"pos":[6495,6502],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[6506,6626],"content":"The following example shows a complete implementation of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.IdentityVerifier&gt;</ph> class.","source":"The following example shows a complete implementation of the <xref:System.ServiceModel.Security.IdentityVerifier> class."},{"pos":[6939,6946],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[6950,7061],"content":"The following example shows a complete implementation of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.EndpointIdentity&gt;</ph> class.","source":"The following example shows a complete implementation of the <xref:System.ServiceModel.EndpointIdentity> class."},{"pos":[7374,7382],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[7544,7636],"content":"<bpt id=\"p1\">[</bpt>Service Identity Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/service-identity-sample.md)</ept>","source":"[Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md)"},{"pos":[7639,7725],"content":"<bpt id=\"p1\">[</bpt>Authorization Policy<ept id=\"p1\">](../../../../docs/framework/wcf/samples/authorization-policy.md)</ept>","source":"[Authorization Policy](../../../../docs/framework/wcf/samples/authorization-policy.md)"}]}