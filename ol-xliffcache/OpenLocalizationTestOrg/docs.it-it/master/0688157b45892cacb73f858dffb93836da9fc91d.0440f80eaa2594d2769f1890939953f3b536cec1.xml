{"content":"---\ntitle: \"Managing Permissions with Stored Procedures in SQL Server\"\nms.date: \"03/30/2017\"\nms.assetid: 08fa34e8-2ffa-470d-ba62-e511a5f8558e\n---\n# Managing Permissions with Stored Procedures in SQL Server\nOne method of creating multiple lines of defense around your database is to implement all data access using stored procedures or user-defined functions. You revoke or deny all permissions to underlying objects, such as tables, and grant EXECUTE permissions on stored procedures. This effectively creates a security perimeter around your data and database objects.  \n  \n## Stored Procedure Benefits  \n Stored procedures have the following benefits:  \n  \n-   Data logic and business rules can be encapsulated so that users can access data and objects only in ways that developers and database administrators intend.  \n  \n-   Parameterized stored procedures that validate all user input can be used to thwart SQL injection attacks. If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into a query string.  \n  \n-   Ad hoc queries and data modifications can be disallowed. This prevents users from maliciously or inadvertently destroying data or executing queries that impair performance on the server or the network.  \n  \n-   Errors can be handled in procedure code without being passed directly to client applications. This prevents error messages from being returned that could aid in a probing attack. Log errors and handle them on the server.  \n  \n-   Stored procedures can be written once, and accessed by many applications.  \n  \n-   Client applications do not need to know anything about the underlying data structures. Stored procedure code can be changed without requiring changes in client applications as long as the changes do not affect parameter lists or returned data types.  \n  \n-   Stored procedures can reduce network traffic by combining multiple operations into one procedure call.  \n  \n## Stored Procedure Execution  \n Stored procedures take advantage of ownership chaining to provide access to data so that users do not need to have explicit permission to access database objects. An ownership chain exists when objects that access each other sequentially are owned by the same user. For example, a stored procedure can call other stored procedures, or a stored procedure can access multiple tables. If all objects in the chain of execution have the same owner, then SQL Server only checks the EXECUTE permission for the caller, not the caller's permissions on other objects. Therefore you need to grant only EXECUTE permissions on stored procedures; you can revoke or deny all permissions on the underlying tables.  \n  \n## Best Practices  \n Simply writing stored procedures isn't enough to adequately secure your application. You should also consider the following potential security holes.  \n  \n-   Grant EXECUTE permissions on the stored procedures for database roles you want to be able to access the data.  \n  \n-   Revoke or deny all permissions to the underlying tables for all roles and users in the database, including the `public` role. All users inherit permissions from public. Therefore denying permissions to `public` means that only owners and `sysadmin` members have access; all other users will be unable to inherit permissions from membership in other roles.  \n  \n-   Do not add users or roles to the `sysadmin` or `db_owner` roles. System administrators and database owners can access all database objects.  \n  \n-   Disable the `guest` account. This will prevent anonymous users from connecting to the database. The guest account is disabled by default in new databases.  \n  \n-   Implement error handling and log errors.  \n  \n-   Create parameterized stored procedures that validate all user input. Treat all user input as untrusted.  \n  \n-   Avoid dynamic SQL unless absolutely necessary. Use the Transact-SQL QUOTENAME() function to delimit a string value and escape any occurrence of the delimiter in the input string.  \n  \n## External Resources  \n For more information, see the following resources.  \n  \n|Resource|Description|  \n|--------------|-----------------|  \n|[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](https://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online|Topics describe how to create stored procedures and how SQL Injection works.|  \n  \n## See also\n\n- [Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)\n- [Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)\n- [Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)\n- [Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)\n- [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)\n- [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)\n- [Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)\n- [ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)\n","nodes":[{"pos":[4,141],"embed":true,"restype":"x-metadata","content":"title: \"Managing Permissions with Stored Procedures in SQL Server\"\nms.date: \"03/30/2017\"\nms.assetid: 08fa34e8-2ffa-470d-ba62-e511a5f8558e","nodes":[{"content":"Managing Permissions with Stored Procedures in SQL Server","nodes":[{"pos":[0,57],"content":"Managing Permissions with Stored Procedures in SQL Server","nodes":[{"content":"Managing Permissions with Stored Procedures in SQL Server","pos":[0,57]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[148,205],"content":"Managing Permissions with Stored Procedures in SQL Server","linkify":"Managing Permissions with Stored Procedures in SQL Server","nodes":[{"content":"Managing Permissions with Stored Procedures in SQL Server","pos":[0,57]}]},{"content":"One method of creating multiple lines of defense around your database is to implement all data access using stored procedures or user-defined functions.","pos":[206,358]},{"content":"You revoke or deny all permissions to underlying objects, such as tables, and grant EXECUTE permissions on stored procedures.","pos":[359,484]},{"content":"This effectively creates a security perimeter around your data and database objects.","pos":[485,569]},{"pos":[578,603],"content":"Stored Procedure Benefits","linkify":"Stored Procedure Benefits","nodes":[{"content":"Stored Procedure Benefits","pos":[0,25]}]},{"content":"Stored procedures have the following benefits:","pos":[607,653]},{"content":"Data logic and business rules can be encapsulated so that users can access data and objects only in ways that developers and database administrators intend.","pos":[663,819]},{"content":"Parameterized stored procedures that validate all user input can be used to thwart SQL injection attacks.","pos":[829,934]},{"content":"If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into a query string.","pos":[935,1062]},{"content":"Ad hoc queries and data modifications can be disallowed.","pos":[1072,1128]},{"content":"This prevents users from maliciously or inadvertently destroying data or executing queries that impair performance on the server or the network.","pos":[1129,1273]},{"content":"Errors can be handled in procedure code without being passed directly to client applications.","pos":[1283,1376]},{"content":"This prevents error messages from being returned that could aid in a probing attack.","pos":[1377,1461]},{"content":"Log errors and handle them on the server.","pos":[1462,1503]},{"content":"Stored procedures can be written once, and accessed by many applications.","pos":[1513,1586]},{"content":"Client applications do not need to know anything about the underlying data structures.","pos":[1596,1682]},{"content":"Stored procedure code can be changed without requiring changes in client applications as long as the changes do not affect parameter lists or returned data types.","pos":[1683,1845]},{"content":"Stored procedures can reduce network traffic by combining multiple operations into one procedure call.","pos":[1855,1957]},{"pos":[1966,1992],"content":"Stored Procedure Execution","linkify":"Stored Procedure Execution","nodes":[{"content":"Stored Procedure Execution","pos":[0,26]}]},{"content":"Stored procedures take advantage of ownership chaining to provide access to data so that users do not need to have explicit permission to access database objects.","pos":[1996,2158]},{"content":"An ownership chain exists when objects that access each other sequentially are owned by the same user.","pos":[2159,2261]},{"content":"For example, a stored procedure can call other stored procedures, or a stored procedure can access multiple tables.","pos":[2262,2377]},{"content":"If all objects in the chain of execution have the same owner, then SQL Server only checks the EXECUTE permission for the caller, not the caller's permissions on other objects.","pos":[2378,2553]},{"content":"Therefore you need to grant only EXECUTE permissions on stored procedures; you can revoke or deny all permissions on the underlying tables.","pos":[2554,2693]},{"pos":[2702,2716],"content":"Best Practices","linkify":"Best Practices","nodes":[{"content":"Best Practices","pos":[0,14]}]},{"content":"Simply writing stored procedures isn't enough to adequately secure your application.","pos":[2720,2804]},{"content":"You should also consider the following potential security holes.","pos":[2805,2869]},{"content":"Grant EXECUTE permissions on the stored procedures for database roles you want to be able to access the data.","pos":[2879,2988]},{"content":"Revoke or deny all permissions to the underlying tables for all roles and users in the database, including the <ph id=\"ph1\">`public`</ph> role.","pos":[2998,3123],"source":"Revoke or deny all permissions to the underlying tables for all roles and users in the database, including the `public` role."},{"content":"All users inherit permissions from public.","pos":[3124,3166]},{"content":"Therefore denying permissions to <ph id=\"ph1\">`public`</ph> means that only owners and <ph id=\"ph2\">`sysadmin`</ph> members have access; all other users will be unable to inherit permissions from membership in other roles.","pos":[3167,3353],"source":" Therefore denying permissions to `public` means that only owners and `sysadmin` members have access; all other users will be unable to inherit permissions from membership in other roles."},{"content":"Do not add users or roles to the <ph id=\"ph1\">`sysadmin`</ph> or <ph id=\"ph2\">`db_owner`</ph> roles.","pos":[3363,3427],"source":"Do not add users or roles to the `sysadmin` or `db_owner` roles."},{"content":"System administrators and database owners can access all database objects.","pos":[3428,3502]},{"content":"Disable the <ph id=\"ph1\">`guest`</ph> account.","pos":[3512,3540],"source":"Disable the `guest` account."},{"content":"This will prevent anonymous users from connecting to the database.","pos":[3541,3607]},{"content":"The guest account is disabled by default in new databases.","pos":[3608,3666]},{"content":"Implement error handling and log errors.","pos":[3676,3716]},{"content":"Create parameterized stored procedures that validate all user input.","pos":[3726,3794]},{"content":"Treat all user input as untrusted.","pos":[3795,3829]},{"content":"Avoid dynamic SQL unless absolutely necessary.","pos":[3839,3885]},{"content":"Use the Transact-SQL QUOTENAME() function to delimit a string value and escape any occurrence of the delimiter in the input string.","pos":[3886,4017]},{"pos":[4026,4044],"content":"External Resources","linkify":"External Resources","nodes":[{"content":"External Resources","pos":[0,18]}]},{"content":"For more information, see the following resources.","pos":[4048,4098]},{"content":"Resource","pos":[4105,4113]},{"content":"Description","pos":[4114,4125]},{"pos":[4167,4359],"content":"<bpt id=\"p1\">[</bpt>Stored Procedures<ept id=\"p1\">](/sql/relational-databases/stored-procedures/stored-procedures-database-engine)</ept> and <bpt id=\"p2\">[</bpt>SQL Injection<ept id=\"p2\">](https://go.microsoft.com/fwlink/?LinkId=98234)</ept> in SQL Server Books Online","source":"[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](https://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online"},{"content":"Topics describe how to create stored procedures and how SQL Injection works.","pos":[4360,4436]},{"pos":[4446,4454],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[4458,4565],"content":"<bpt id=\"p1\">[</bpt>Securing ADO.NET Applications<ept id=\"p1\">](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</ept>","source":"[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)"},{"pos":[4568,4683],"content":"<bpt id=\"p1\">[</bpt>Overview of SQL Server Security<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)</ept>","source":"[Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)"},{"pos":[4686,4827],"content":"<bpt id=\"p1\">[</bpt>Application Security Scenarios in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)</ept>","source":"[Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)"},{"pos":[4830,4963],"content":"<bpt id=\"p1\">[</bpt>Writing Secure Dynamic SQL in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)</ept>","source":"[Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)"},{"pos":[4966,5097],"content":"<bpt id=\"p1\">[</bpt>Signing Stored Procedures in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)</ept>","source":"[Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)"},{"pos":[5100,5265],"content":"<bpt id=\"p1\">[</bpt>Customizing Permissions with Impersonation in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)</ept>","source":"[Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)"},{"pos":[5268,5391],"content":"<bpt id=\"p1\">[</bpt>Modifying Data with Stored Procedures<ept id=\"p1\">](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)</ept>","source":"[Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)"},{"pos":[5394,5498],"content":"<bpt id=\"p1\">[</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=217917)</ept>","source":"[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)"}]}