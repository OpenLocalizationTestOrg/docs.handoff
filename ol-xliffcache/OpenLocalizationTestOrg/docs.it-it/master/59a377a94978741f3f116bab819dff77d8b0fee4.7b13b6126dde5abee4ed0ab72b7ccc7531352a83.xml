{"content":"---\ntitle: \"Extended Protection Policy\"\nms.date: \"03/30/2017\"\nms.assetid: e2616a10-317e-4c34-8023-0c015a80a82f\n---\n# Extended Protection Policy\nExtended Protection is a security initiative for protecting against man-in-the-middle (MITM) attacks. A MITM attack is a security threat in which a MITM takes a client’s credentials and forwards it to a server.  \n  \n## Demonstrates  \n Extended protection  \n  \n## Discussion  \n When applications authenticate using Kerberos, Digest or NTLM using HTTPS, a Transport Level Security (TLS) channel is first established and then authentication takes place using the secure channel. However, there is no binding between the session key generated by SSL and the session key generated during authentication. Any MITM can establish itself between the client and the server and start forwarding the requests from the client, even when the transport channel itself is secure, because the server has no way of knowing whether the secure channel has been established from the client or a MITM. The solution in this scenario is to bind the outer TLS channel with the inner authentication channel such that the server can detect if there is a MITM.  \n  \n> [!NOTE]\n>  This sample only works when hosted on IIS and cannot work on Cassini – Visual Studio Development Server because Cassini does not support HTTPS.  \n  \n> [!NOTE]\n>  This feature is currently only available on Windows 7. The following steps are specific to Windows 7.  \n  \n#### To set up, build, and run the sample  \n  \n1.  Install Internet Information Services from **Control Panel**, **Add/Remove Programs**, **Windows Features**.  \n  \n2.  Install **Windows Authentication** in **Windows Features**, **Internet Information Services**, **World Wide Web Services**, **Security**, and **Windows Authentication**.  \n  \n3.  Install **Windows Communication Foundation HTTP Activation** in **Windows Features**, **Microsoft .NET Framework 3.5.1**, and **Windows Communication Foundation HTTP Activation**.  \n  \n4.  This sample requires the client to establish a secure channel with the server, so it requires the presence of a server certificate which can be installed from Internet Information Services (IIS) Manager.  \n  \n    1.  Open IIS Manager. Open **Server certificates**, which appears in the **Feature View** tab when the root node (machine name) is selected.  \n  \n    2.  For the purpose of testing this sample, create a self-signed certificate. If you do not want Internet Explorer to prompt you about the certificate not being secure, install the certificate in the Trusted Certificate Root authority store.  \n  \n5.  Open the **Actions** pane for the default Web site. Click **Edit Site**, **Bindings**. Add HTTPS as a type if not already present, with port number 443. Assign the SSL certificate created in the preceding step.  \n  \n6.  Build the service. This creates a virtual directory in IIS, and copies the .dll, .svc and .config files as required for the service to be Web hosted.  \n  \n7.  Open IIS Manager. Right-click the virtual directory (**ExtendedProtection**), which was created in the preceding step. Select **Convert to Application**.  \n  \n8.  Open the **Authentication** module in IIS Manager for this virtual directory and enable **Windows Authentication**.  \n  \n9. Open **Advanced Settings** under **Windows Authentication** for this virtual directory and set it to **Required**.  \n  \n10. You can test the service by accessing the HTTPS URL from a browser window (Provide a fully-qualified domain name). If you want to access this URL from a remote machine, make sure that the firewall is opened for all incoming HTTP and HTTPS connections.  \n  \n11. Open the client configuration file and provide a fully-qualified domain name for the client or endpoint address attribute that replaces `<<full_machine_name>>`.  \n  \n12. Run the client. The client communicates with the service, which establishes a secure channel and uses extended protection.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Services\\Security\\ExtendedProtection`\n","nodes":[{"pos":[4,110],"embed":true,"restype":"x-metadata","content":"title: \"Extended Protection Policy\"\nms.date: \"03/30/2017\"\nms.assetid: e2616a10-317e-4c34-8023-0c015a80a82f","nodes":[{"content":"Extended Protection Policy","nodes":[{"pos":[0,26],"content":"Extended Protection Policy","nodes":[{"content":"Extended Protection Policy","pos":[0,26]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[117,143],"content":"Extended Protection Policy","linkify":"Extended Protection Policy","nodes":[{"content":"Extended Protection Policy","pos":[0,26]}]},{"content":"Extended Protection is a security initiative for protecting against man-in-the-middle (MITM) attacks.","pos":[144,245]},{"content":"A MITM attack is a security threat in which a MITM takes a client’s credentials and forwards it to a server.","pos":[246,354]},{"pos":[363,375],"content":"Demonstrates","linkify":"Demonstrates","nodes":[{"content":"Demonstrates","pos":[0,12]}]},{"content":"Extended protection","pos":[379,398]},{"pos":[407,417],"content":"Discussion","linkify":"Discussion","nodes":[{"content":"Discussion","pos":[0,10]}]},{"content":"When applications authenticate using Kerberos, Digest or NTLM using HTTPS, a Transport Level Security (TLS) channel is first established and then authentication takes place using the secure channel.","pos":[421,619]},{"content":"However, there is no binding between the session key generated by SSL and the session key generated during authentication.","pos":[620,742]},{"content":"Any MITM can establish itself between the client and the server and start forwarding the requests from the client, even when the transport channel itself is secure, because the server has no way of knowing whether the secure channel has been established from the client or a MITM.","pos":[743,1023]},{"content":"The solution in this scenario is to bind the outer TLS channel with the inner authentication channel such that the server can detect if there is a MITM.","pos":[1024,1176]},{"pos":[1184,1338],"content":"[!NOTE]\n This sample only works when hosted on IIS and cannot work on Cassini – Visual Studio Development Server because Cassini does not support HTTPS.","leadings":["","> "],"nodes":[{"content":"This sample only works when hosted on IIS and cannot work on Cassini – Visual Studio Development Server because Cassini does not support HTTPS.","pos":[9,152]}]},{"pos":[1346,1458],"content":"[!NOTE]\n This feature is currently only available on Windows 7. The following steps are specific to Windows 7.","leadings":["","> "],"nodes":[{"content":"This feature is currently only available on Windows 7. The following steps are specific to Windows 7.","pos":[9,110],"nodes":[{"content":"This feature is currently only available on Windows 7.","pos":[0,54]},{"content":"The following steps are specific to Windows 7.","pos":[55,101]}]}]},{"pos":[1469,1505],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[1515,1623],"content":"Install Internet Information Services from <bpt id=\"p1\">**</bpt>Control Panel<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Add/Remove Programs<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Windows Features<ept id=\"p3\">**</ept>.","source":"Install Internet Information Services from **Control Panel**, **Add/Remove Programs**, **Windows Features**."},{"pos":[1633,1802],"content":"Install <bpt id=\"p1\">**</bpt>Windows Authentication<ept id=\"p1\">**</ept> in <bpt id=\"p2\">**</bpt>Windows Features<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Internet Information Services<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>World Wide Web Services<ept id=\"p4\">**</ept>, <bpt id=\"p5\">**</bpt>Security<ept id=\"p5\">**</ept>, and <bpt id=\"p6\">**</bpt>Windows Authentication<ept id=\"p6\">**</ept>.","source":"Install **Windows Authentication** in **Windows Features**, **Internet Information Services**, **World Wide Web Services**, **Security**, and **Windows Authentication**."},{"pos":[1812,1991],"content":"Install <bpt id=\"p1\">**</bpt>Windows Communication Foundation HTTP Activation<ept id=\"p1\">**</ept> in <bpt id=\"p2\">**</bpt>Windows Features<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Microsoft .NET Framework 3.5.1<ept id=\"p3\">**</ept>, and <bpt id=\"p4\">**</bpt>Windows Communication Foundation HTTP Activation<ept id=\"p4\">**</ept>.","source":"Install **Windows Communication Foundation HTTP Activation** in **Windows Features**, **Microsoft .NET Framework 3.5.1**, and **Windows Communication Foundation HTTP Activation**."},{"content":"This sample requires the client to establish a secure channel with the server, so it requires the presence of a server certificate which can be installed from Internet Information Services (IIS) Manager.","pos":[2001,2204]},{"content":"Open IIS Manager.","pos":[2218,2235]},{"content":"Open <bpt id=\"p1\">**</bpt>Server certificates<ept id=\"p1\">**</ept>, which appears in the <bpt id=\"p2\">**</bpt>Feature View<ept id=\"p2\">**</ept> tab when the root node (machine name) is selected.","pos":[2236,2354],"source":" Open **Server certificates**, which appears in the **Feature View** tab when the root node (machine name) is selected."},{"content":"For the purpose of testing this sample, create a self-signed certificate.","pos":[2368,2441]},{"content":"If you do not want Internet Explorer to prompt you about the certificate not being secure, install the certificate in the Trusted Certificate Root authority store.","pos":[2442,2605]},{"content":"Open the <bpt id=\"p1\">**</bpt>Actions<ept id=\"p1\">**</ept> pane for the default Web site.","pos":[2615,2666],"source":"Open the **Actions** pane for the default Web site."},{"content":"Click <bpt id=\"p1\">**</bpt>Edit Site<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Bindings<ept id=\"p2\">**</ept>.","pos":[2667,2701],"source":" Click **Edit Site**, **Bindings**."},{"content":"Add HTTPS as a type if not already present, with port number 443.","pos":[2702,2767]},{"content":"Assign the SSL certificate created in the preceding step.","pos":[2768,2825]},{"content":"Build the service.","pos":[2835,2853]},{"content":"This creates a virtual directory in IIS, and copies the .dll, .svc and .config files as required for the service to be Web hosted.","pos":[2854,2984]},{"content":"Open IIS Manager.","pos":[2994,3011]},{"content":"Right-click the virtual directory (<bpt id=\"p1\">**</bpt>ExtendedProtection<ept id=\"p1\">**</ept>), which was created in the preceding step.","pos":[3012,3112],"source":" Right-click the virtual directory (**ExtendedProtection**), which was created in the preceding step."},{"content":"Select <bpt id=\"p1\">**</bpt>Convert to Application<ept id=\"p1\">**</ept>.","pos":[3113,3147],"source":" Select **Convert to Application**."},{"pos":[3157,3272],"content":"Open the <bpt id=\"p1\">**</bpt>Authentication<ept id=\"p1\">**</ept> module in IIS Manager for this virtual directory and enable <bpt id=\"p2\">**</bpt>Windows Authentication<ept id=\"p2\">**</ept>.","source":"Open the **Authentication** module in IIS Manager for this virtual directory and enable **Windows Authentication**."},{"pos":[3281,3395],"content":"Open <bpt id=\"p1\">**</bpt>Advanced Settings<ept id=\"p1\">**</ept> under <bpt id=\"p2\">**</bpt>Windows Authentication<ept id=\"p2\">**</ept> for this virtual directory and set it to <bpt id=\"p3\">**</bpt>Required<ept id=\"p3\">**</ept>.","source":"Open **Advanced Settings** under **Windows Authentication** for this virtual directory and set it to **Required**."},{"content":"You can test the service by accessing the HTTPS URL from a browser window (Provide a fully-qualified domain name).","pos":[3405,3519]},{"content":"If you want to access this URL from a remote machine, make sure that the firewall is opened for all incoming HTTP and HTTPS connections.","pos":[3520,3656]},{"pos":[3666,3826],"content":"Open the client configuration file and provide a fully-qualified domain name for the client or endpoint address attribute that replaces <ph id=\"ph1\">`&lt;&lt;full_machine_name&gt;&gt;`</ph>.","source":"Open the client configuration file and provide a fully-qualified domain name for the client or endpoint address attribute that replaces `<<full_machine_name>>`."},{"content":"Run the client.","pos":[3836,3851]},{"content":"The client communicates with the service, which establishes a secure channel and uses extended protection.","pos":[3852,3958]},{"pos":[3966,4098],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[4152,4462],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[4463,4513]}]}