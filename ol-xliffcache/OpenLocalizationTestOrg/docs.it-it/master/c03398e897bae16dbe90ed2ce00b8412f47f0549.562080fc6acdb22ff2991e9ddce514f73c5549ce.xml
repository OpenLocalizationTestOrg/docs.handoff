{"content":"---\ntitle: \"Duplex\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"Duplex Service Contract\"\nms.assetid: bc5de6b6-1a63-42a3-919a-67d21bae24e0\n---\n# Duplex\nThe Duplex sample demonstrates how to define and implement a duplex contract. Duplex communication occurs when a client establishes a session with a service and gives the service a channel on which the service can send messages back to the client. This sample is based on the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md). A duplex contract is defined as a pair of interfacesâ€”a primary interface from the client to the service and a callback interface from the service to the client. In this sample, the `ICalculatorDuplex` interface allows the client to perform math operations, calculating the result over a session. The service returns results on the `ICalculatorDuplexCallback` interface. A duplex contract requires a session, because a context must be established to correlate the set of messages being sent between the client and the service.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n In this sample, the client is a console application (.exe) and the service is hosted by Internet Information Services (IIS). The duplex contract is defined as follows:  \n  \n```csharp\n[ServiceContract(Namespace = \"http://Microsoft.ServiceModel.Samples\", SessionMode=SessionMode.Required,  \n                 CallbackContract=typeof(ICalculatorDuplexCallback))]  \npublic interface ICalculatorDuplex  \n{  \n    [OperationContract(IsOneWay = true)]  \n    void Clear();  \n    [OperationContract(IsOneWay = true)]  \n    void AddTo(double n);  \n    [OperationContract(IsOneWay = true)]  \n    void SubtractFrom(double n);  \n    [OperationContract(IsOneWay = true)]  \n    void MultiplyBy(double n);  \n    [OperationContract(IsOneWay = true)]  \n    void DivideBy(double n);  \n}  \n  \npublic interface ICalculatorDuplexCallback  \n{  \n    [OperationContract(IsOneWay = true)]  \n    void Result(double result);  \n    [OperationContract(IsOneWay = true)]  \n    void Equation(string eqn);  \n}  \n```  \n  \n The `CalculatorService` class implements the primary `ICalculatorDuplex` interface. The service uses the <xref:System.ServiceModel.InstanceContextMode.PerSession> instance mode to maintain the result for each session. A private property named `Callback` is used to access the callback channel to the client. The service uses the callback for sending messages back to the client through the callback interface.  \n  \n```csharp\n[ServiceBehavior(InstanceContextMode = InstanceContextMode.PerSession)]  \npublic class CalculatorService : ICalculatorDuplex  \n{  \n    double result = 0.0D;  \n    string equation;  \n  \n    public CalculatorService()  \n    {  \n        equation = result.ToString();  \n    }  \n  \n    public void Clear()  \n    {  \n        Callback.Equation($\"{equation} = {result}\");  \n        equation = result.ToString();  \n    }  \n  \n    public void AddTo(double n)  \n    {  \n        result += n;  \n        equation += $\" + {n}\";  \n        Callback.Result(result);  \n    }  \n    \n    //...  \n    \n    ICalculatorDuplexCallback Callback  \n    {  \n        get  \n        {  \n            return OperationContext.Current.GetCallbackChannel<ICalculatorDuplexCallback>();  \n        }  \n    }  \n}  \n```  \n  \n The client must provide a class that implements the callback interface of the duplex contract, for receiving messages from the service. In the sample, a `CallbackHandler` class is defined to implement the `ICalculatorDuplexCallback` interface.  \n  \n```csharp \npublic class CallbackHandler : ICalculatorDuplexCallback  \n{  \n   public void Result(double result)  \n   {  \n      Console.WriteLine(\"Result({0})\", result);  \n   }  \n  \n   public void Equation(string equation)  \n   {  \n      Console.WriteLine(\"Equation({0}\", equation);  \n   }  \n}  \n```  \n  \n The proxy that is generated for a duplex contract requires a <xref:System.ServiceModel.InstanceContext> to be provided upon construction. This <xref:System.ServiceModel.InstanceContext> is used as the site for an object that implements the callback interface and handles messages that are sent back from the service. An <xref:System.ServiceModel.InstanceContext> is constructed with an instance of the `CallbackHandler` class. This object handles messages sent from the service to the client on the callback interface.  \n  \n```csharp\n// Construct InstanceContext to handle messages on callback interface.  \nInstanceContext instanceContext = new InstanceContext(new CallbackHandler());  \n  \n// Create a client.  \nCalculatorDuplexClient client = new CalculatorDuplexClient(instanceContext);  \n  \nConsole.WriteLine(\"Press <ENTER> to terminate client once the output is displayed.\");  \nConsole.WriteLine();  \n  \n// Call the AddTo service operation.  \ndouble value = 100.00D;  \nclient.AddTo(value);  \n  \n// Call the SubtractFrom service operation.  \nvalue = 50.00D;  \nclient.SubtractFrom(value);  \n  \n// Call the MultiplyBy service operation.  \nvalue = 17.65D;  \nclient.MultiplyBy(value);  \n  \n// Call the DivideBy service operation.  \nvalue = 2.00D;  \nclient.DivideBy(value);  \n  \n// Complete equation.  \nclient.Clear();  \n  \nConsole.ReadLine();  \n  \n//Closing the client gracefully closes the connection and cleans up resources.  \nclient.Close();  \n```  \n  \n The configuration has been modified to provide a binding that supports both session communication and duplex communication. The `wsDualHttpBinding` supports session communication and allows duplex communication by providing dual HTTP connections, one for each direction. On the service, the only difference in configuration is the binding that is used. On the client, you must configure an address that the server can use to connect to the client as shown in the following sample configuration.  \n  \n```xml  \n<client>  \n  <endpoint name=\"\"  \n            address=\"http://localhost/servicemodelsamples/service.svc\"   \n            binding=\"wsDualHttpBinding\"   \n            bindingConfiguration=\"DuplexBinding\"   \n            contract=\"Microsoft.ServiceModel.Samples.ICalculatorDuplex\" />  \n</client>  \n  \n<bindings>  \n  <!-- Configure a binding that support duplex communication. -->  \n  <wsDualHttpBinding>  \n    <binding name=\"DuplexBinding\"   \n             clientBaseAddress=\"http://localhost:8000/myClient/\">  \n    </binding>  \n  </wsDualHttpBinding>  \n</bindings>  \n```  \n  \n When you run the sample, you see the messages that are returned to the client on the callback interface that is sent from the service. Each intermediate result is displayed, followed by the entire equation upon the completion of all operations. Press ENTER to shut down the client.  \n  \n### To set up, build, and run the sample  \n  \n1.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).  \n  \n2.  To build the C#, C++, or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n3.  To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).  \n  \n    > [!IMPORTANT]\n    >  When running the client in a cross-machine configuration, be sure to replace \"localhost\" in both the `address` attribute of the [\\<endpoint> of \\<client>](../../configure-apps/file-schema/wcf/endpoint-of-client.md) element and the `clientBaseAddress` attribute of the [\\<binding>](../../../../docs/framework/misc/binding.md) element of the [\\<wsDualHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsdualhttpbinding.md) element with the name of the appropriate machine, as shown in the following:  \n  \n    ```xml  \n    <client>  \n        <endpoint name = \"\"  \n        address=\"http://service_machine_name/servicemodelsamples/service.svc\"  \n        ... />  \n    </client>  \n    ...  \n    <wsDualHttpBinding>  \n        <binding name=\"DuplexBinding\" clientBaseAddress=\"http://client_machine_name:8000/myClient/\">  \n        </binding>  \n    </wsDualHttpBinding>  \n    ```  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Contract\\Service\\Duplex`  \n","nodes":[{"pos":[4,142],"embed":true,"restype":"x-metadata","content":"title: \"Duplex\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"Duplex Service Contract\"\nms.assetid: bc5de6b6-1a63-42a3-919a-67d21bae24e0","nodes":[{"content":"Duplex","nodes":[{"pos":[0,6],"content":"Duplex","nodes":[{"content":"Duplex","pos":[0,6]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[149,155],"content":"Duplex","linkify":"Duplex","nodes":[{"content":"Duplex","pos":[0,6]}]},{"content":"The Duplex sample demonstrates how to define and implement a duplex contract.","pos":[156,233]},{"content":"Duplex communication occurs when a client establishes a session with a service and gives the service a channel on which the service can send messages back to the client.","pos":[234,403]},{"content":"This sample is based on the <bpt id=\"p1\">[</bpt>Getting Started<ept id=\"p1\">](../../../../docs/framework/wcf/samples/getting-started-sample.md)</ept>.","pos":[404,516],"source":" This sample is based on the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md)."},{"content":"A duplex contract is defined as a pair of interfacesâ€”a primary interface from the client to the service and a callback interface from the service to the client.","pos":[517,677]},{"content":"In this sample, the <ph id=\"ph1\">`ICalculatorDuplex`</ph> interface allows the client to perform math operations, calculating the result over a session.","pos":[678,812],"source":" In this sample, the `ICalculatorDuplex` interface allows the client to perform math operations, calculating the result over a session."},{"content":"The service returns results on the <ph id=\"ph1\">`ICalculatorDuplexCallback`</ph> interface.","pos":[813,886],"source":" The service returns results on the `ICalculatorDuplexCallback` interface."},{"content":"A duplex contract requires a session, because a context must be established to correlate the set of messages being sent between the client and the service.","pos":[887,1042]},{"pos":[1050,1157],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"content":"In this sample, the client is a console application (.exe) and the service is hosted by Internet Information Services (IIS).","pos":[1164,1288]},{"content":"The duplex contract is defined as follows:","pos":[1289,1331]},{"content":"The <ph id=\"ph1\">`CalculatorService`</ph> class implements the primary <ph id=\"ph2\">`ICalculatorDuplex`</ph> interface.","pos":[2151,2234],"source":"The `CalculatorService` class implements the primary `ICalculatorDuplex` interface."},{"content":"The service uses the <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContextMode.PerSession&gt;</ph> instance mode to maintain the result for each session.","pos":[2235,2368],"source":" The service uses the <xref:System.ServiceModel.InstanceContextMode.PerSession> instance mode to maintain the result for each session."},{"content":"A private property named <ph id=\"ph1\">`Callback`</ph> is used to access the callback channel to the client.","pos":[2369,2458],"source":" A private property named `Callback` is used to access the callback channel to the client."},{"content":"The service uses the callback for sending messages back to the client through the callback interface.","pos":[2459,2560]},{"content":"The client must provide a class that implements the callback interface of the duplex contract, for receiving messages from the service.","pos":[3360,3495]},{"content":"In the sample, a <ph id=\"ph1\">`CallbackHandler`</ph> class is defined to implement the <ph id=\"ph2\">`ICalculatorDuplexCallback`</ph> interface.","pos":[3496,3603],"source":" In the sample, a `CallbackHandler` class is defined to implement the `ICalculatorDuplexCallback` interface."},{"content":"The proxy that is generated for a duplex contract requires a <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> to be provided upon construction.","pos":[3913,4050],"source":"The proxy that is generated for a duplex contract requires a <xref:System.ServiceModel.InstanceContext> to be provided upon construction."},{"content":"This <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> is used as the site for an object that implements the callback interface and handles messages that are sent back from the service.","pos":[4051,4229],"source":" This <xref:System.ServiceModel.InstanceContext> is used as the site for an object that implements the callback interface and handles messages that are sent back from the service."},{"content":"An <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> is constructed with an instance of the <ph id=\"ph2\">`CallbackHandler`</ph> class.","pos":[4230,4339],"source":" An <xref:System.ServiceModel.InstanceContext> is constructed with an instance of the `CallbackHandler` class."},{"content":"This object handles messages sent from the service to the client on the callback interface.","pos":[4340,4431]},{"content":"The configuration has been modified to provide a binding that supports both session communication and duplex communication.","pos":[5369,5492]},{"content":"The <ph id=\"ph1\">`wsDualHttpBinding`</ph> supports session communication and allows duplex communication by providing dual HTTP connections, one for each direction.","pos":[5493,5639],"source":" The `wsDualHttpBinding` supports session communication and allows duplex communication by providing dual HTTP connections, one for each direction."},{"content":"On the service, the only difference in configuration is the binding that is used.","pos":[5640,5721]},{"content":"On the client, you must configure an address that the server can use to connect to the client as shown in the following sample configuration.","pos":[5722,5863]},{"content":"When you run the sample, you see the messages that are returned to the client on the callback interface that is sent from the service.","pos":[6448,6582]},{"content":"Each intermediate result is displayed, followed by the entire equation upon the completion of all operations.","pos":[6583,6692]},{"content":"Press ENTER to shut down the client.","pos":[6693,6729]},{"pos":[6739,6775],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[6785,6984],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"pos":[6994,7209],"content":"To build the C#, C++, or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C#, C++, or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[7219,7427],"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[7439,7978],"content":"[!IMPORTANT]\nWhen running the client in a cross-machine configuration, be sure to replace \"localhost\" in both the `address` attribute of the [\\<endpoint> of \\<client>](../../configure-apps/file-schema/wcf/endpoint-of-client.md) element and the `clientBaseAddress` attribute of the [\\<binding>](../../../../docs/framework/misc/binding.md) element of the [\\<wsDualHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsdualhttpbinding.md) element with the name of the appropriate machine, as shown in the following:","leadings":["","    >  "],"nodes":[{"content":"When running the client in a cross-machine configuration, be sure to replace \"localhost\" in both the <ph id=\"ph1\">`address`</ph> attribute of the <bpt id=\"p1\">[</bpt><ph id=\"ph2\">\\&lt;</ph>endpoint&gt; of <ph id=\"ph3\">\\&lt;</ph>client&gt;<ept id=\"p1\">](../../configure-apps/file-schema/wcf/endpoint-of-client.md)</ept> element and the <ph id=\"ph4\">`clientBaseAddress`</ph> attribute of the <bpt id=\"p2\">[</bpt><ph id=\"ph5\">\\&lt;</ph>binding&gt;<ept id=\"p2\">](../../../../docs/framework/misc/binding.md)</ept> element of the <bpt id=\"p3\">[</bpt><ph id=\"ph6\">\\&lt;</ph>wsDualHttpBinding&gt;<ept id=\"p3\">](../../../../docs/framework/configure-apps/file-schema/wcf/wsdualhttpbinding.md)</ept> element with the name of the appropriate machine, as shown in the following:","pos":[13,532],"source":"When running the client in a cross-machine configuration, be sure to replace \"localhost\" in both the `address` attribute of the [\\<endpoint> of \\<client>](../../configure-apps/file-schema/wcf/endpoint-of-client.md) element and the `clientBaseAddress` attribute of the [\\<binding>](../../../../docs/framework/misc/binding.md) element of the [\\<wsDualHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsdualhttpbinding.md) element with the name of the appropriate machine, as shown in the following:"}]},{"pos":[8357,8489],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[8543,8853],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[8854,8904]}]}