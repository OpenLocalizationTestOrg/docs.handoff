{"content":"---\ntitle: \"How To: Enable Token Replay Detection\"\nms.date: \"03/30/2017\"\nms.assetid: 5a9f5771-f5f6-4100-8501-406aa20d731a\nauthor: \"BrucePerlerMS\"\n---\n# How To: Enable Token Replay Detection\n## Applies To  \n  \n-   Microsoft® Windows® Identity Foundation (WIF)  \n  \n-   ASP.NET® Web Forms  \n  \n## Summary  \n This How-To provides detailed step-by-step procedures for enabling token replay detection in an ASP.NET application that uses WIF. It also provides instructions for how to test the application to verify that token replay detection is enabled. This How-To does not have detailed instructions for creating a Security Token Service (STS), and instead uses the Development STS that comes with the Identity and Access tool. The Development STS does not perform real authentication and is intended for testing purposes only. You will need to install the Identity and Access tool to complete this How-To. It can be downloaded from the following location: [Identity and Access Tool](https://go.microsoft.com/fwlink/?LinkID=245849)  \n  \n## Contents  \n  \n-   Objectives  \n  \n-   Overview  \n  \n-   Summary of Steps  \n  \n-   Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection  \n  \n-   Step 2 – Test Your Solution  \n  \n## Objectives  \n  \n-   Create a simple ASP.NET application that uses WIF and the Development STS from the Identity and Access Tool  \n  \n-   Enable token replay detection and verify that it is working  \n  \n## Overview  \n A replay attack occurs when a client attempts to authenticate to a relying party with an STS token that the client has already used. To help prevent this attack, WIF contains a replay detection cache of previously used STS tokens. When enabled, replay detection checks the token of the incoming request and verifies whether or not the token has been previously used. If the token has been used already, the request is refused and a <xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException> exception is thrown.  \n  \n The following steps demonstrate the configuration changes required to enable replay detection.  \n  \n## Summary of Steps  \n  \n-   Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection  \n  \n-   Step 2 – Test Your Solution  \n  \n## Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection  \n In this step, you will create a new ASP.NET Web Forms application and modify the *Web.config* file to enable replay detection.  \n  \n#### To create a simple ASP.NET application  \n  \n1.  Start Visual Studio and click **File**, **New**, and then **Project**.  \n  \n2.  In the **New Project** window, click **ASP.NET Web Forms Application**.  \n  \n3.  In **Name**, enter `TestApp` and press **OK**.  \n  \n4.  Right-click the **TestApp** project under **Solution Explorer**, then select **Identity and Access**.  \n  \n5.  The **Identity and Access** window appears. Under **Providers**, select **Test your application with the Local Development STS**, then click **Apply**.  \n  \n6.  Add the following **\\<tokenReplayDetection>** element to the *Web.config* configuration file immediately following the **\\<system.identityModel>** and **\\<identityConfiguration>** elements, like shown:  \n  \n    ```xml  \n    <system.identityModel>  \n        <identityConfiguration>  \n            <tokenReplayDetection enabled=\"true\"/>  \n    ```  \n  \n## Step 2 – Test Your Solution  \n In this step, you will test your WIF-enabled ASP.NET application to verify that replay detection has been enabled.  \n  \n#### To test your WIF-enabled ASP.NET application for replay detection  \n  \n1.  Run the solution by pressing the **F5** key. You should be presented with the default ASP.NET Home Page and automatically authenticated with the username *Terry*, which is the default user that is returned by the Development STS.  \n  \n2.  Press the browser’s **Back** button. You should be presented with a **Server Error in ‘/’ Application** page with the following description: *ID1062: Replay has been detected for: Token: 'System.IdentityModel.Tokens.SamlSecurityToken'*, followed by an *AssertionId* and an *Issuer*.  \n  \n     You are seeing this error page because an exception of type <xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException> was thrown when the token replay was detected. This error occurs because you are attempting to re-send the initial POST request when the token was first presented. The **Back** button will not cause this behavior on subsequent requests to the server.\n","nodes":[{"pos":[4,145],"embed":true,"restype":"x-metadata","content":"title: \"How To: Enable Token Replay Detection\"\nms.date: \"03/30/2017\"\nms.assetid: 5a9f5771-f5f6-4100-8501-406aa20d731a\nauthor: \"BrucePerlerMS\"","nodes":[{"content":"How To: Enable Token Replay Detection","nodes":[{"pos":[0,37],"content":"How To: Enable Token Replay Detection","nodes":[{"content":"How To: Enable Token Replay Detection","pos":[0,37]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[152,189],"content":"How To: Enable Token Replay Detection","linkify":"How To: Enable Token Replay Detection","nodes":[{"content":"How To: Enable Token Replay Detection","pos":[0,37]}]},{"pos":[193,203],"content":"Applies To","linkify":"Applies To","nodes":[{"content":"Applies To","pos":[0,10]}]},{"content":"Microsoft® Windows® Identity Foundation (WIF)","pos":[213,258]},{"content":"ASP.NET® Web Forms","pos":[268,286]},{"pos":[295,302],"content":"Summary","linkify":"Summary","nodes":[{"content":"Summary","pos":[0,7]}]},{"content":"This How-To provides detailed step-by-step procedures for enabling token replay detection in an ASP.NET application that uses WIF.","pos":[306,436]},{"content":"It also provides instructions for how to test the application to verify that token replay detection is enabled.","pos":[437,548]},{"content":"This How-To does not have detailed instructions for creating a Security Token Service (STS), and instead uses the Development STS that comes with the Identity and Access tool.","pos":[549,724]},{"content":"The Development STS does not perform real authentication and is intended for testing purposes only.","pos":[725,824]},{"content":"You will need to install the Identity and Access tool to complete this How-To.","pos":[825,903]},{"content":"It can be downloaded from the following location: <bpt id=\"p1\">[</bpt>Identity and Access Tool<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkID=245849)</ept>","pos":[904,1028],"source":" It can be downloaded from the following location: [Identity and Access Tool](https://go.microsoft.com/fwlink/?LinkID=245849)"},{"pos":[1037,1045],"content":"Contents","linkify":"Contents","nodes":[{"content":"Contents","pos":[0,8]}]},{"content":"Objectives","pos":[1055,1065]},{"content":"Overview","pos":[1075,1083]},{"content":"Summary of Steps","pos":[1093,1109]},{"content":"Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection","pos":[1119,1201]},{"content":"Step 2 – Test Your Solution","pos":[1211,1238]},{"pos":[1247,1257],"content":"Objectives","linkify":"Objectives","nodes":[{"content":"Objectives","pos":[0,10]}]},{"content":"Create a simple ASP.NET application that uses WIF and the Development STS from the Identity and Access Tool","pos":[1267,1374]},{"content":"Enable token replay detection and verify that it is working","pos":[1384,1443]},{"pos":[1452,1460],"content":"Overview","linkify":"Overview","nodes":[{"content":"Overview","pos":[0,8]}]},{"content":"A replay attack occurs when a client attempts to authenticate to a relying party with an STS token that the client has already used.","pos":[1464,1596]},{"content":"To help prevent this attack, WIF contains a replay detection cache of previously used STS tokens.","pos":[1597,1694]},{"content":"When enabled, replay detection checks the token of the incoming request and verifies whether or not the token has been previously used.","pos":[1695,1830]},{"content":"If the token has been used already, the request is refused and a <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException&gt;</ph> exception is thrown.","pos":[1831,1988],"source":" If the token has been used already, the request is refused and a <xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException> exception is thrown."},{"content":"The following steps demonstrate the configuration changes required to enable replay detection.","pos":[1995,2089]},{"pos":[2098,2114],"content":"Summary of Steps","linkify":"Summary of Steps","nodes":[{"content":"Summary of Steps","pos":[0,16]}]},{"content":"Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection","pos":[2124,2206]},{"content":"Step 2 – Test Your Solution","pos":[2216,2243]},{"pos":[2252,2334],"content":"Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection","linkify":"Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection","nodes":[{"content":"Step 1 – Create a Simple ASP.NET Web Forms Application and Enable Replay Detection","pos":[0,82]}]},{"pos":[2338,2464],"content":"In this step, you will create a new ASP.NET Web Forms application and modify the <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> file to enable replay detection.","source":"In this step, you will create a new ASP.NET Web Forms application and modify the *Web.config* file to enable replay detection."},{"pos":[2475,2513],"content":"To create a simple ASP.NET application","linkify":"To create a simple ASP.NET application","nodes":[{"content":"To create a simple ASP.NET application","pos":[0,38]}]},{"pos":[2523,2593],"content":"Start Visual Studio and click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>New<ept id=\"p2\">**</ept>, and then <bpt id=\"p3\">**</bpt>Project<ept id=\"p3\">**</ept>.","source":"Start Visual Studio and click **File**, **New**, and then **Project**."},{"pos":[2603,2674],"content":"In the <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> window, click <bpt id=\"p2\">**</bpt>ASP.NET Web Forms Application<ept id=\"p2\">**</ept>.","source":"In the **New Project** window, click **ASP.NET Web Forms Application**."},{"pos":[2684,2730],"content":"In <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept>, enter <ph id=\"ph1\">`TestApp`</ph> and press <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","source":"In **Name**, enter `TestApp` and press **OK**."},{"pos":[2740,2841],"content":"Right-click the <bpt id=\"p1\">**</bpt>TestApp<ept id=\"p1\">**</ept> project under <bpt id=\"p2\">**</bpt>Solution Explorer<ept id=\"p2\">**</ept>, then select <bpt id=\"p3\">**</bpt>Identity and Access<ept id=\"p3\">**</ept>.","source":"Right-click the **TestApp** project under **Solution Explorer**, then select **Identity and Access**."},{"content":"The <bpt id=\"p1\">**</bpt>Identity and Access<ept id=\"p1\">**</ept> window appears.","pos":[2851,2894],"source":"The **Identity and Access** window appears."},{"content":"Under <bpt id=\"p1\">**</bpt>Providers<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>Test your application with the Local Development STS<ept id=\"p2\">**</ept>, then click <bpt id=\"p3\">**</bpt>Apply<ept id=\"p3\">**</ept>.","pos":[2895,3002],"source":" Under **Providers**, select **Test your application with the Local Development STS**, then click **Apply**."},{"pos":[3012,3213],"content":"Add the following <bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\&lt;</ph>tokenReplayDetection&gt;<ept id=\"p1\">**</ept> element to the <bpt id=\"p2\">*</bpt>Web.config<ept id=\"p2\">*</ept> configuration file immediately following the <bpt id=\"p3\">**</bpt><ph id=\"ph2\">\\&lt;</ph>system.identityModel&gt;<ept id=\"p3\">**</ept> and <bpt id=\"p4\">**</bpt><ph id=\"ph3\">\\&lt;</ph>identityConfiguration&gt;<ept id=\"p4\">**</ept> elements, like shown:","source":"Add the following **\\<tokenReplayDetection>** element to the *Web.config* configuration file immediately following the **\\<system.identityModel>** and **\\<identityConfiguration>** elements, like shown:"},{"pos":[3364,3391],"content":"Step 2 – Test Your Solution","linkify":"Step 2 – Test Your Solution","nodes":[{"content":"Step 2 – Test Your Solution","pos":[0,27]}]},{"content":"In this step, you will test your WIF-enabled ASP.NET application to verify that replay detection has been enabled.","pos":[3395,3509]},{"pos":[3520,3585],"content":"To test your WIF-enabled ASP.NET application for replay detection","linkify":"To test your WIF-enabled ASP.NET application for replay detection","nodes":[{"content":"To test your WIF-enabled ASP.NET application for replay detection","pos":[0,65]}]},{"content":"Run the solution by pressing the <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept> key.","pos":[3595,3639],"source":"Run the solution by pressing the **F5** key."},{"content":"You should be presented with the default ASP.NET Home Page and automatically authenticated with the username <bpt id=\"p1\">*</bpt>Terry<ept id=\"p1\">*</ept>, which is the default user that is returned by the Development STS.","pos":[3640,3824],"source":" You should be presented with the default ASP.NET Home Page and automatically authenticated with the username *Terry*, which is the default user that is returned by the Development STS."},{"content":"Press the browser’s <bpt id=\"p1\">**</bpt>Back<ept id=\"p1\">**</ept> button.","pos":[3834,3870],"source":"Press the browser’s **Back** button."},{"content":"You should be presented with a <bpt id=\"p1\">**</bpt>Server Error in ‘/’ Application<ept id=\"p1\">**</ept> page with the following description: <bpt id=\"p2\">*</bpt>ID1062: Replay has been detected for: Token: 'System.IdentityModel.Tokens.SamlSecurityToken'<ept id=\"p2\">*</ept>, followed by an <bpt id=\"p3\">*</bpt>AssertionId<ept id=\"p3\">*</ept> and an <bpt id=\"p4\">*</bpt>Issuer<ept id=\"p4\">*</ept>.","pos":[3871,4116],"source":" You should be presented with a **Server Error in ‘/’ Application** page with the following description: *ID1062: Replay has been detected for: Token: 'System.IdentityModel.Tokens.SamlSecurityToken'*, followed by an *AssertionId* and an *Issuer*."},{"content":"You are seeing this error page because an exception of type <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException&gt;</ph> was thrown when the token replay was detected.","pos":[4127,4305],"source":"You are seeing this error page because an exception of type <xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException> was thrown when the token replay was detected."},{"content":"This error occurs because you are attempting to re-send the initial POST request when the token was first presented.","pos":[4306,4422]},{"content":"The <bpt id=\"p1\">**</bpt>Back<ept id=\"p1\">**</ept> button will not cause this behavior on subsequent requests to the server.","pos":[4423,4509],"source":" The **Back** button will not cause this behavior on subsequent requests to the server."}]}