{"content":"---\ntitle: \"How to: Get Progress from the .NET Framework 4.5 Installer\"\nms.date: \"03/30/2017\"\ndev_langs:\n  - \"cpp\"\nhelpviewer_keywords:\n  - \"progress information, .NET Framework installer\"\n  - \".NET Framework, installing\"\nms.assetid: 0a1a3ba3-7e46-4df2-afd3-f3a8237e1c4f\nauthor: \"mairaw\"\nms.author: \"mairaw\"\n---\n\n# How to: Get Progress from the .NET Framework 4.5 Installer\n\nThe [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] is a redistributable runtime. If you develop apps for this version of the .NET Framework, you can include (chain) [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup as a prerequisite part of your app's setup. To present a customized or unified setup experience, you may want to silently launch [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup and track its progress while showing your app's setup progress. To enable silent tracking, [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup (which can be watched) defines a protocol by using a memory-mapped I/O (MMIO) segment to communicate with your setup (the watcher or chainer). This protocol defines a way for a chainer to obtain progress information, get detailed results, respond to messages, and cancel the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup.\n\n- **Invocation**. To call [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup and receive progress information from the MMIO section, your setup program must do the following:\n\n    1. Call the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]redistributable program:\n\n        ```\n        dotNetFx45_Full_x86_x64.exe /q /norestart /pipe section-name\n        ```\n\n        Where *section name* is any name you want to use to identify your app. .NET Framework setup reads and writes to the MMIO section asynchronously, so you might find it convenient to use events and messages during that time. In the example, the .NET Framework setup process is created by a constructor that both allocates the MMIO section (`TheSectionName`) and defines an event (`TheEventName`):\n\n        ```\n        Server():ChainerSample::MmioChainer(L\"TheSectionName\", L\"TheEventName\")\n        ```\n\n        Please replace those names with names that are unique to your setup program.\n\n    2. Read from the MMIO section. In the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)], the download and installation operations are simultaneous: One part of the .NET Framework might be installing while another part is downloading. As a result, progress is sent back (that is, written) to the MMIO section as two numbers (`m_downloadSoFar` and `m_installSoFar`) that increase from 0 to 255. When 255 is written and the .NET Framework exits, the installation is complete.\n\n- **Exit codes**. The following exit codes from the command to call the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable program indicate whether setup has succeeded or failed:\n\n    - 0 - Setup completed successfully.\n\n    - 3010 – Setup completed successfully; a system restart is required.\n\n    - 1602 – Setup has been canceled.\n\n    - All other codes - Setup encountered errors; examine the log files created in %temp% for details.\n\n- **Canceling setup**. You can cancel setup at any time by using the `Abort` method to set the `m_downloadAbort` and `m_ installAbort` flags in the MMIO section.\n\n## Chainer Sample\n\nThe Chainer sample silently launches and tracks [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup while showing progress. This sample is similar to the Chainer sample provided for the .NET Framework 4. However, in addition, it can avoid system restarts by processing the message box for closing .NET Framework 4 apps. For information about this message box, see [Reducing System Restarts During .NET Framework 4.5 Installations](../../../docs/framework/deployment/reducing-system-restarts.md). You can use this sample with the .NET Framework 4 installer; in that scenario, the message is simply not sent.\n\n> [!WARNING]\n> You must run the example as an administrator.\n\nYou can download the complete Visual Studio solution for the [.NET Framework 4.5 Chainer Sample](https://go.microsoft.com/fwlink/?LinkId=231345) from the MSDN Samples Gallery.\n\nThe following sections describe the significant files in this sample: MMIOChainer.h, ChainingdotNet4.cpp, and IProgressObserver.h.\n\n#### MMIOChainer.h\n\n- The MMIOChainer.h file (see [complete code](https://go.microsoft.com/fwlink/?LinkId=231369)) contains the data structure definition and the base class from which the chainer class should be derived. The [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] extends the MMIO data structure to handle data that the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] installer needs. The changes to the MMIO structure are backward-compatible, so a .NET Framework 4 chainer can work with .NET Framework 4.5 setup without requiring recompilation. However, this scenario does not support the feature for reducing system restarts.\n\n    A version field provides a means of identifying revisions to the structure and message format. The .NET Framework setup determines the version of the chainer interface by calling the `VirtualQuery` function to determine the size of the file mapping. If the size is large enough to accommodate the version field, .NET Framework setup uses the specified value. If the file mapping is too small to contain a version field, which is the case with the .NET Framework 4, the setup process assumes version 0 (4). If the chainer does not support the version of the message that .NET Framework setup wants to send, .NET Framework setup assumes an ignore response.\n\n    The MMIO data structure is defined as follows:\n\n    ```cpp\n    // MMIO data structure for interprocess communication\n        struct MmioDataStructure\n        {\n            bool m_downloadFinished;               // Is download complete?\n            bool m_installFinished;                // Is installation complete?\n            bool m_downloadAbort;                  // Set to cause downloader to abort.\n            bool m_installAbort;                   // Set to cause installer to abort.\n            HRESULT m_hrDownloadFinished;          // Resulting HRESULT for download.\n            HRESULT m_hrInstallFinished;           // Resulting HRESULT for installation.\n            HRESULT m_hrInternalError;\n            WCHAR m_szCurrentItemStep[MAX_PATH];\n            unsigned char m_downloadSoFar;         // Download progress 0-255 (0-100% done).\n            unsigned char m_installSoFar;          // Installation progress 0-255 (0-100% done).\n            WCHAR m_szEventName[MAX_PATH];         // Event that chainer creates and chainee opens to sync communications.\n\n            BYTE m_version;                        // Version of the data structure, set by chainer:\n                                                   // 0x0: .NET Framework 4\n                                                   // 0x1: .NET Framework 4.5\n\n            DWORD m_messageCode;                   // Current message sent by the chainee; 0 if no message is active.\n            DWORD m_messageResponse;               // Chainer's response to current message; 0 if not yet handled.\n            DWORD m_messageDataLength;             // Length of the m_messageData field, in bytes.\n            BYTE m_messageData[1];                 // Variable-length buffer; content depends on m_messageCode.\n        };\n    ```\n\n- The `MmioDataStructure` data structure should not be used directly; use the `MmioChainer` class instead to implement your chainer. Derive from the `MmioChainer` class to chain the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable.\n\n#### IProgressObserver.h\n\n- The IProgressObserver.h file implements a progress observer ([see complete code](https://go.microsoft.com/fwlink/?LinkId=231370)). This observer gets notified of download and installation progress (specified as an unsigned `char`, 0-255, indicating 1%-100% complete). The observer is also notified when the chainee sends a message, and the observer should send a response.\n\n    ```cpp\n        class IProgressObserver\n        {\n        public:\n            virtual void OnProgress(unsigned char) = 0; // 0 - 255:  255 == 100%\n            virtual void Finished(HRESULT) = 0;         // Called when operation is complete\n            virtual DWORD Send(DWORD dwMessage, LPVOID pData, DWORD dwDataLength) = 0; // Called when a message is sent\n        };\n    ```\n\n#### ChainingdotNet4.5.cpp\n\n- The [ChainingdotNet4.5.cpp](https://go.microsoft.com/fwlink/?LinkId=231368) file implements the `Server` class, which derives from the `MmioChainer` class and overrides the appropriate methods to display progress information. The MmioChainer creates a section with the specified section name and initializes the chainer with the specified event name. The event name is saved in the mapped data structure. You should make the section and event names unique. The `Server` class in the following code launches the specified setup program, monitors its progress, and returns an exit code.\n\n    ```cpp\n    class Server : public ChainerSample::MmioChainer, public ChainerSample::IProgressObserver\n    {\n    public:\n        …………….\n        Server():ChainerSample::MmioChainer(L\"TheSectionName\", L\"TheEventName\") //customize for your event names\n        {}\n    ```\n\n    The installation is started in the Main method.\n\n    ```cpp\n    // Main entry point for program\n    int __cdecl main(int argc, _In_count_(argc) char **_argv)\n    {\n        int result = 0;\n        CString args;\n        if (argc > 1)\n        {\n            args = CString(_argv[1]);\n        }\n\n        if (IsNetFx4Present(NETFX45_RC_REVISION))\n        {\n            printf(\".NET Framework 4.5 is already installed\");\n        }\n        else\n        {\n            result = Server().Launch(args);\n        }\n\n        return result;\n    }\n    ```\n\n- Before launching the installation, the chainer checks to see if the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] is already installed by calling `IsNetFx4Present`:\n\n    ```cpp\n    ///  Checks for presence of the .NET Framework 4.\n    ///    A value of 0 for dwMinimumRelease indicates a check for the .NET Framework 4 full\n    ///    Any other value indicates a check for a specific compatible release of the .NET Framework 4.\n    #define NETFX40_FULL_REVISION 0\n    // TODO: Replace with released revision number\n    #define NETFX45_RC_REVISION MAKELONG(50309, 5)   // .NET Framework 4.5\n    bool IsNetFx4Present(DWORD dwMinimumRelease)\n    {\n        DWORD dwError = ERROR_SUCCESS;\n        HKEY hKey = NULL;\n        DWORD dwData = 0;\n        DWORD dwType = 0;\n        DWORD dwSize = sizeof(dwData);\n\n        dwError = ::RegOpenKeyExW(HKEY_LOCAL_MACHINE, L\"SOFTWARE\\\\Microsoft\\\\NET Framework Setup\\\\NDP\\\\v4\\\\Full\", 0, KEY_READ, &hKey);\n        if (ERROR_SUCCESS == dwError)\n        {\n            dwError = ::RegQueryValueExW(hKey, L\"Release\", 0, &dwType, (LPBYTE)&dwData, &dwSize);\n\n            if ((ERROR_SUCCESS == dwError) && (REG_DWORD != dwType))\n            {\n                dwError = ERROR_INVALID_DATA;\n            }\n            else if (ERROR_FILE_NOT_FOUND == dwError)\n            {\n                // Release value was not found, let's check for 4.0.\n                dwError = ::RegQueryValueExW(hKey, L\"Install\", 0, &dwType, (LPBYTE)&dwData, &dwSize);\n\n                // Install = (REG_DWORD)1;\n                if ((ERROR_SUCCESS == dwError) && (REG_DWORD == dwType) && (dwData == 1))\n                {\n                    // treat 4.0 as Release = 0\n                    dwData = 0;\n                }\n                else\n                {\n                    dwError = ERROR_INVALID_DATA;\n                }\n            }\n        }\n\n        if (hKey != NULL)\n        {\n            ::RegCloseKey(hKey);\n        }\n\n        return ((ERROR_SUCCESS == dwError) && (dwData >= dwMinimumRelease));\n    }\n    ```\n\n- You can change the path of the executable (Setup.exe in the example) in the `Launch` method to point to its correct location, or customize the code to determine the location. The `MmioChainer` base class provides a blocking `Run()` method that the derived class calls.\n\n    ```cpp\n    bool Launch(const CString& args)\n    {\n    CString cmdline = L\"dotNetFx45_Full_x86_x64.exe -pipe TheSectionName \" + args; // Customize with name and location of setup .exe that you want to run\n    STARTUPINFO si = {0};\n    si.cb = sizeof(si);\n    PROCESS_INFORMATION pi = {0};\n\n    // Launch the Setup.exe that installs the .NET Framework 4.5\n    BOOL bLaunchedSetup = ::CreateProcess(NULL,\n     cmdline.GetBuffer(),\n     NULL, NULL, FALSE, 0, NULL, NULL,\n     &si,\n     &pi);\n\n    // If successful\n    if (bLaunchedSetup != 0)\n    {\n    IProgressObserver& observer = dynamic_cast<IProgressObserver&>(*this);\n    Run(pi.hProcess, observer);\n\n    ……………………..\n    return (bLaunchedSetup != 0);\n    }\n    ```\n\n- The `Send` method intercepts and processes the messages. In this version of the .NET Framework, the only supported message is the close application message.\n\n    ```cpp\n            // SendMessage\n            //\n            // Send a message and wait for the response.\n            // dwMessage: Message to send\n            // pData: The buffer to copy the data to\n            // dwDataLength: Initially a pointer to the size of pBuffer. Upon successful call, the number of bytes copied to pBuffer.\n            //--------------------------------------------------------------\n        virtual DWORD Send(DWORD dwMessage, LPVOID pData, DWORD dwDataLength)\n        {\n            DWORD dwResult = 0;\n            printf(\"received message: %d\\n\", dwMessage);\n            // Handle message\n            switch (dwMessage)\n            {\n            case MMIO_CLOSE_APPS:\n                {\n                    printf(\"    applications are holding files in use:\\n\");\n                    IronMan::MmioCloseApplications* applications = reinterpret_cast<IronMan::MmioCloseApplications*>(pData);\n                    for(DWORD i = 0; i < applications->m_dwApplicationsSize; i++)\n                    {\n                        printf(\"      %ls (%d)\\n\", applications->m_applications[i].m_szName, applications->m_applications[i].m_dwPid);\n                    }\n\n                    printf(\"    should appliations be closed? (Y)es, (N)o, (R)efresh : \");\n                    while (dwResult == 0)\n                    {\n                        switch (toupper(getwchar()))\n                        {\n                        case 'Y':\n                            dwResult = IDYES;  // Close apps\n                            break;\n                        case 'N':\n                            dwResult = IDNO;\n                            break;\n                        case 'R':\n                            dwResult = IDRETRY;\n                            break;\n                        }\n                    }\n                    printf(\"\\n\");\n                    break;\n                }\n            default:\n                break;\n            }\n            printf(\"  response: %d\\n  \", dwResult);\n            return dwResult;\n        }\n    };\n    ```\n\n- Progress data is an unsigned `char` between 0 (0%) and 255 (100%).\n\n    ```cpp\n    private: // IProgressObserver\n        virtual void OnProgress(unsigned char ubProgressSoFar)\n        {…………\n       }\n    ```\n\n- The HRESULT is passed to the `Finished` method.\n\n    ```cpp\n    virtual void Finished(HRESULT hr)\n    {\n    // This HRESULT is communicated over MMIO and may be different than process\n    // Exit code of the Chainee Setup.exe itself\n    printf(\"\\r\\nFinished HRESULT: 0x%08X\\r\\n\", hr);\n    }\n    ```\n\n    > [!IMPORTANT]\n    > The [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable typically writes many progress messages and a single message that indicates completion (on the chainer side). It also reads asynchronously, looking for `Abort` records. If it receives an `Abort` record, it cancels the installation, and writes a finished record with E_ABORT as its data after the installation has been aborted and setup operations have been rolled back.\n\nA typical server creates a random MMIO file name, creates the file (as shown in the previous code example, in `Server::CreateSection`), and launches the redistributable by using the `CreateProcess` method and passing the pipe name with the `-pipe someFileSectionName` option. The server should implement `OnProgress`, `Send`, and `Finished` methods with application UI-specific code.\n\n## See also\n\n- [Deployment Guide for Developers](../../../docs/framework/deployment/deployment-guide-for-developers.md)\n- [Deployment](../../../docs/framework/deployment/index.md)\n","nodes":[{"pos":[4,307],"embed":true,"restype":"x-metadata","content":"title: \"How to: Get Progress from the .NET Framework 4.5 Installer\"\nms.date: \"03/30/2017\"\ndev_langs:\n  - \"cpp\"\nhelpviewer_keywords:\n  - \"progress information, .NET Framework installer\"\n  - \".NET Framework, installing\"\nms.assetid: 0a1a3ba3-7e46-4df2-afd3-f3a8237e1c4f\nauthor: \"mairaw\"\nms.author: \"mairaw\"","nodes":[{"content":"How to: Get Progress from the .NET Framework 4.5 Installer","nodes":[{"pos":[0,58],"content":"How to: Get Progress from the .NET Framework 4.5 Installer","nodes":[{"content":"How to: Get Progress from the .NET Framework 4.5 Installer","pos":[0,58]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[315,373],"content":"How to: Get Progress from the .NET Framework 4.5 Installer","linkify":"How to: Get Progress from the .NET Framework 4.5 Installer","nodes":[{"content":"How to: Get Progress from the .NET Framework 4.5 Installer","pos":[0,58]}]},{"content":"The <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> is a redistributable runtime.","pos":[375,461],"source":"The [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] is a redistributable runtime."},{"content":"If you develop apps for this version of the .NET Framework, you can include (chain) <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> setup as a prerequisite part of your app's setup.","pos":[462,648],"source":" If you develop apps for this version of the .NET Framework, you can include (chain) [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup as a prerequisite part of your app's setup."},{"content":"To present a customized or unified setup experience, you may want to silently launch <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> setup and track its progress while showing your app's setup progress.","pos":[649,856],"source":" To present a customized or unified setup experience, you may want to silently launch [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup and track its progress while showing your app's setup progress."},{"content":"To enable silent tracking, <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> setup (which can be watched) defines a protocol by using a memory-mapped I/O (MMIO) segment to communicate with your setup (the watcher or chainer).","pos":[857,1085],"source":" To enable silent tracking, [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup (which can be watched) defines a protocol by using a memory-mapped I/O (MMIO) segment to communicate with your setup (the watcher or chainer)."},{"content":"This protocol defines a way for a chainer to obtain progress information, get detailed results, respond to messages, and cancel the <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> setup.","pos":[1086,1277],"source":" This protocol defines a way for a chainer to obtain progress information, get detailed results, respond to messages, and cancel the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup."},{"content":"<bpt id=\"p1\">**</bpt>Invocation<ept id=\"p1\">**</ept>.","pos":[1281,1296],"source":"**Invocation**."},{"content":"To call <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> setup and receive progress information from the MMIO section, your setup program must do the following:","pos":[1297,1461],"source":" To call [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup and receive progress information from the MMIO section, your setup program must do the following:"},{"pos":[1470,1555],"content":"Call the <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>redistributable program:","source":"Call the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]redistributable program:"},{"content":"Where <bpt id=\"p1\">*</bpt>section name<ept id=\"p1\">*</ept> is any name you want to use to identify your app.","pos":[1659,1729],"source":"Where *section name* is any name you want to use to identify your app."},{"content":".NET Framework setup reads and writes to the MMIO section asynchronously, so you might find it convenient to use events and messages during that time.","pos":[1730,1880]},{"content":"In the example, the .NET Framework setup process is created by a constructor that both allocates the MMIO section (<ph id=\"ph1\">`TheSectionName`</ph>) and defines an event (<ph id=\"ph2\">`TheEventName`</ph>):","pos":[1881,2052],"source":" In the example, the .NET Framework setup process is created by a constructor that both allocates the MMIO section (`TheSectionName`) and defines an event (`TheEventName`):"},{"content":"Please replace those names with names that are unique to your setup program.","pos":[2167,2243]},{"content":"Read from the MMIO section.","pos":[2252,2279]},{"content":"In the <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>, the download and installation operations are simultaneous: One part of the .NET Framework might be installing while another part is downloading.","pos":[2280,2485],"source":" In the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)], the download and installation operations are simultaneous: One part of the .NET Framework might be installing while another part is downloading."},{"content":"As a result, progress is sent back (that is, written) to the MMIO section as two numbers (<ph id=\"ph1\">`m_downloadSoFar`</ph> and <ph id=\"ph2\">`m_installSoFar`</ph>) that increase from 0 to 255.","pos":[2486,2644],"source":" As a result, progress is sent back (that is, written) to the MMIO section as two numbers (`m_downloadSoFar` and `m_installSoFar`) that increase from 0 to 255."},{"content":"When 255 is written and the .NET Framework exits, the installation is complete.","pos":[2645,2724]},{"content":"<bpt id=\"p1\">**</bpt>Exit codes<ept id=\"p1\">**</ept>.","pos":[2728,2743],"source":"**Exit codes**."},{"content":"The following exit codes from the command to call the <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> redistributable program indicate whether setup has succeeded or failed:","pos":[2744,2922],"source":" The following exit codes from the command to call the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable program indicate whether setup has succeeded or failed:"},{"content":"0 - Setup completed successfully.","pos":[2930,2963]},{"content":"3010 – Setup completed successfully; a system restart is required.","pos":[2971,3037]},{"content":"1602 – Setup has been canceled.","pos":[3045,3076]},{"content":"All other codes - Setup encountered errors; examine the log files created in %temp% for details.","pos":[3084,3180]},{"content":"<bpt id=\"p1\">**</bpt>Canceling setup<ept id=\"p1\">**</ept>.","pos":[3184,3204],"source":"**Canceling setup**."},{"content":"You can cancel setup at any time by using the <ph id=\"ph1\">`Abort`</ph> method to set the <ph id=\"ph2\">`m_downloadAbort`</ph> and <ph id=\"ph3\">`m_ installAbort`</ph> flags in the MMIO section.","pos":[3205,3343],"source":" You can cancel setup at any time by using the `Abort` method to set the `m_downloadAbort` and `m_ installAbort` flags in the MMIO section."},{"pos":[3348,3362],"content":"Chainer Sample","linkify":"Chainer Sample","nodes":[{"content":"Chainer Sample","pos":[0,14]}]},{"content":"The Chainer sample silently launches and tracks <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> setup while showing progress.","pos":[3364,3494],"source":"The Chainer sample silently launches and tracks [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] setup while showing progress."},{"content":"This sample is similar to the Chainer sample provided for the .NET Framework 4.","pos":[3495,3574]},{"content":"However, in addition, it can avoid system restarts by processing the message box for closing .NET Framework 4 apps.","pos":[3575,3690]},{"content":"For information about this message box, see <bpt id=\"p1\">[</bpt>Reducing System Restarts During .NET Framework 4.5 Installations<ept id=\"p1\">](../../../docs/framework/deployment/reducing-system-restarts.md)</ept>.","pos":[3691,3866],"source":" For information about this message box, see [Reducing System Restarts During .NET Framework 4.5 Installations](../../../docs/framework/deployment/reducing-system-restarts.md)."},{"content":"You can use this sample with the .NET Framework 4 installer; in that scenario, the message is simply not sent.","pos":[3867,3977]},{"pos":[3981,4039],"content":"[!WARNING]\nYou must run the example as an administrator.","leadings":["","> "],"nodes":[{"content":"You must run the example as an administrator.","pos":[11,56]}]},{"pos":[4041,4216],"content":"You can download the complete Visual Studio solution for the <bpt id=\"p1\">[</bpt>.NET Framework 4.5 Chainer Sample<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=231345)</ept> from the MSDN Samples Gallery.","source":"You can download the complete Visual Studio solution for the [.NET Framework 4.5 Chainer Sample](https://go.microsoft.com/fwlink/?LinkId=231345) from the MSDN Samples Gallery."},{"content":"The following sections describe the significant files in this sample: MMIOChainer.h, ChainingdotNet4.cpp, and IProgressObserver.h.","pos":[4218,4348]},{"pos":[4355,4368],"content":"MMIOChainer.h","linkify":"MMIOChainer.h","nodes":[{"content":"MMIOChainer.h","pos":[0,13]}]},{"content":"The MMIOChainer.h file (see <bpt id=\"p1\">[</bpt>complete code<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=231369)</ept>) contains the data structure definition and the base class from which the chainer class should be derived.","pos":[4372,4570],"source":"The MMIOChainer.h file (see [complete code](https://go.microsoft.com/fwlink/?LinkId=231369)) contains the data structure definition and the base class from which the chainer class should be derived."},{"content":"The <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> extends the MMIO data structure to handle data that the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> installer needs.","pos":[4571,4753],"source":" The [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] extends the MMIO data structure to handle data that the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] installer needs."},{"content":"The changes to the MMIO structure are backward-compatible, so a .NET Framework 4 chainer can work with .NET Framework 4.5 setup without requiring recompilation.","pos":[4754,4914]},{"content":"However, this scenario does not support the feature for reducing system restarts.","pos":[4915,4996]},{"content":"A version field provides a means of identifying revisions to the structure and message format.","pos":[5002,5096]},{"content":"The .NET Framework setup determines the version of the chainer interface by calling the <ph id=\"ph1\">`VirtualQuery`</ph> function to determine the size of the file mapping.","pos":[5097,5251],"source":" The .NET Framework setup determines the version of the chainer interface by calling the `VirtualQuery` function to determine the size of the file mapping."},{"content":"If the size is large enough to accommodate the version field, .NET Framework setup uses the specified value.","pos":[5252,5360]},{"content":"If the file mapping is too small to contain a version field, which is the case with the .NET Framework 4, the setup process assumes version 0 (4).","pos":[5361,5507]},{"content":"If the chainer does not support the version of the message that .NET Framework setup wants to send, .NET Framework setup assumes an ignore response.","pos":[5508,5656]},{"content":"The MMIO data structure is defined as follows:","pos":[5662,5708]},{"content":"The <ph id=\"ph1\">`MmioDataStructure`</ph> data structure should not be used directly; use the <ph id=\"ph2\">`MmioChainer`</ph> class instead to implement your chainer.","pos":[7453,7583],"source":"The `MmioDataStructure` data structure should not be used directly; use the `MmioChainer` class instead to implement your chainer."},{"content":"Derive from the <ph id=\"ph1\">`MmioChainer`</ph> class to chain the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> redistributable.","pos":[7584,7702],"source":" Derive from the `MmioChainer` class to chain the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable."},{"pos":[7709,7728],"content":"IProgressObserver.h","linkify":"IProgressObserver.h","nodes":[{"content":"IProgressObserver.h","pos":[0,19]}]},{"content":"The IProgressObserver.h file implements a progress observer (<bpt id=\"p1\">[</bpt>see complete code<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=231370)</ept>).","pos":[7732,7862],"source":"The IProgressObserver.h file implements a progress observer ([see complete code](https://go.microsoft.com/fwlink/?LinkId=231370))."},{"content":"This observer gets notified of download and installation progress (specified as an unsigned <ph id=\"ph1\">`char`</ph>, 0-255, indicating 1%-100% complete).","pos":[7863,7999],"source":" This observer gets notified of download and installation progress (specified as an unsigned `char`, 0-255, indicating 1%-100% complete)."},{"content":"The observer is also notified when the chainee sends a message, and the observer should send a response.","pos":[8000,8104]},{"pos":[8494,8515],"content":"ChainingdotNet4.5.cpp","linkify":"ChainingdotNet4.5.cpp","nodes":[{"content":"ChainingdotNet4.5.cpp","pos":[0,21]}]},{"content":"The <bpt id=\"p1\">[</bpt>ChainingdotNet4.5.cpp<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=231368)</ept> file implements the <ph id=\"ph1\">`Server`</ph> class, which derives from the <ph id=\"ph2\">`MmioChainer`</ph> class and overrides the appropriate methods to display progress information.","pos":[8519,8744],"source":"The [ChainingdotNet4.5.cpp](https://go.microsoft.com/fwlink/?LinkId=231368) file implements the `Server` class, which derives from the `MmioChainer` class and overrides the appropriate methods to display progress information."},{"content":"The MmioChainer creates a section with the specified section name and initializes the chainer with the specified event name.","pos":[8745,8869]},{"content":"The event name is saved in the mapped data structure.","pos":[8870,8923]},{"content":"You should make the section and event names unique.","pos":[8924,8975]},{"content":"The <ph id=\"ph1\">`Server`</ph> class in the following code launches the specified setup program, monitors its progress, and returns an exit code.","pos":[8976,9103],"source":" The `Server` class in the following code launches the specified setup program, monitors its progress, and returns an exit code."},{"content":"The installation is started in the Main method.","pos":[9380,9427]},{"pos":[9922,10093],"content":"Before launching the installation, the chainer checks to see if the <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> is already installed by calling <ph id=\"ph2\">`IsNetFx4Present`</ph>:","source":"Before launching the installation, the chainer checks to see if the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] is already installed by calling `IsNetFx4Present`:"},{"content":"You can change the path of the executable (Setup.exe in the example) in the <ph id=\"ph1\">`Launch`</ph> method to point to its correct location, or customize the code to determine the location.","pos":[11951,12125],"source":"You can change the path of the executable (Setup.exe in the example) in the `Launch` method to point to its correct location, or customize the code to determine the location."},{"content":"The <ph id=\"ph1\">`MmioChainer`</ph> base class provides a blocking <ph id=\"ph2\">`Run()`</ph> method that the derived class calls.","pos":[12126,12219],"source":" The `MmioChainer` base class provides a blocking `Run()` method that the derived class calls."},{"content":"The <ph id=\"ph1\">`Send`</ph> method intercepts and processes the messages.","pos":[12944,13000],"source":"The `Send` method intercepts and processes the messages."},{"content":"In this version of the .NET Framework, the only supported message is the close application message.","pos":[13001,13100]},{"pos":[15174,15240],"content":"Progress data is an unsigned <ph id=\"ph1\">`char`</ph> between 0 (0%) and 255 (100%).","source":"Progress data is an unsigned `char` between 0 (0%) and 255 (100%)."},{"pos":[15384,15431],"content":"The HRESULT is passed to the <ph id=\"ph1\">`Finished`</ph> method.","source":"The HRESULT is passed to the `Finished` method."},{"pos":[15690,16151],"content":"[!IMPORTANT]\nThe [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable typically writes many progress messages and a single message that indicates completion (on the chainer side). It also reads asynchronously, looking for `Abort` records. If it receives an `Abort` record, it cancels the installation, and writes a finished record with E_ABORT as its data after the installation has been aborted and setup operations have been rolled back.","leadings":["","    > "],"nodes":[{"content":"The [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable typically writes many progress messages and a single message that indicates completion (on the chainer side). It also reads asynchronously, looking for `Abort` records. If it receives an `Abort` record, it cancels the installation, and writes a finished record with E_ABORT as its data after the installation has been aborted and setup operations have been rolled back.","pos":[13,455],"nodes":[{"content":"The <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> redistributable typically writes many progress messages and a single message that indicates completion (on the chainer side).","pos":[0,182],"source":"The [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] redistributable typically writes many progress messages and a single message that indicates completion (on the chainer side)."},{"content":"It also reads asynchronously, looking for <ph id=\"ph1\">`Abort`</ph> records.","pos":[183,241],"source":" It also reads asynchronously, looking for `Abort` records."},{"content":"If it receives an <ph id=\"ph1\">`Abort`</ph> record, it cancels the installation, and writes a finished record with E_ABORT as its data after the installation has been aborted and setup operations have been rolled back.","pos":[242,442],"source":" If it receives an `Abort` record, it cancels the installation, and writes a finished record with E_ABORT as its data after the installation has been aborted and setup operations have been rolled back."}]}]},{"content":"A typical server creates a random MMIO file name, creates the file (as shown in the previous code example, in <ph id=\"ph1\">`Server::CreateSection`</ph>), and launches the redistributable by using the <ph id=\"ph2\">`CreateProcess`</ph> method and passing the pipe name with the <ph id=\"ph3\">`-pipe someFileSectionName`</ph> option.","pos":[16153,16428],"source":"A typical server creates a random MMIO file name, creates the file (as shown in the previous code example, in `Server::CreateSection`), and launches the redistributable by using the `CreateProcess` method and passing the pipe name with the `-pipe someFileSectionName` option."},{"content":"The server should implement <ph id=\"ph1\">`OnProgress`</ph>, <ph id=\"ph2\">`Send`</ph>, and <ph id=\"ph3\">`Finished`</ph> methods with application UI-specific code.","pos":[16429,16536],"source":" The server should implement `OnProgress`, `Send`, and `Finished` methods with application UI-specific code."},{"pos":[16541,16549],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[16553,16657],"content":"<bpt id=\"p1\">[</bpt>Deployment Guide for Developers<ept id=\"p1\">](../../../docs/framework/deployment/deployment-guide-for-developers.md)</ept>","source":"[Deployment Guide for Developers](../../../docs/framework/deployment/deployment-guide-for-developers.md)"},{"pos":[16660,16717],"content":"<bpt id=\"p1\">[</bpt>Deployment<ept id=\"p1\">](../../../docs/framework/deployment/index.md)</ept>","source":"[Deployment](../../../docs/framework/deployment/index.md)"}]}