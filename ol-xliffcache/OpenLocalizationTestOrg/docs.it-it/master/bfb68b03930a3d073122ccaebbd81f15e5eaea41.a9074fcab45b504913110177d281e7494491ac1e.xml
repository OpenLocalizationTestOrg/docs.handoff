{"content":"---\ntitle: \"Debugging Windows Authentication Errors | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"WCF, authentication\"\n  - \"WCF, Windows authentication\"\nms.assetid: 181be4bd-79b1-4a66-aee2-931887a6d7cc\ncaps.latest.revision: 21\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Debugging Windows Authentication Errors\nWhen using Windows authentication as a security mechanism, the Security Support Provider Interface (SSPI) handles security processes. When security errors occur at the SSPI layer, they are surfaced by [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]. This topic provides a framework and set of questions to help diagnose the errors.  \n  \n For an overview of the Kerberos protocol, see [Kerberos Explained](http://go.microsoft.com/fwlink/?LinkID=86946); for an overview of SSPI, see [SSPI](http://go.microsoft.com/fwlink/?LinkId=88941).  \n  \n For Windows authentication, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] typically uses the *Negotiate* Security Support Provider (SSP), which performs Kerberos mutual authentication between the client and service. If the Kerberos protocol is not available, by default [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] falls back to NT LAN Manager (NTLM). However, you can configure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to use only the Kerberos protocol (and to throw an exception if Kerberos is not available). You can also configure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to use restricted forms of the Kerberos protocol.  \n  \n## Debugging Methodology  \n The basic method is as follows:  \n  \n1.  Determine whether you are using Windows authentication. If you are using any other scheme, this topic does not apply.  \n  \n2.  If you are sure you are using Windows authentication, determine whether your [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] configuration uses Kerberos direct or Negotiate.  \n  \n3.  Once you have determined whether your configuration is using the Kerberos protocol or NTLM, you can understand error messages in the correct context.  \n  \n### Availability of the Kerberos Protocol and NTLM  \n The Kerberos SSP requires a domain controller to act as the Kerberos Key Distribution Center (KDC). The Kerberos protocol is available only when both the client and service are using domain identities. In other account combinations, NTLM is used, as summarized in the following table.  \n  \n The table headers show possible account types used by the server. The left column shows possible account types used by the client.  \n  \n||Local User|Local System|Domain User|Domain Machine|  \n|-|----------------|------------------|-----------------|--------------------|  \n|Local User|NTLM|NTLM|NTLM|NTLM|  \n|Local System|Anonymous NTLM|Anonymous NTLM|Anonymous NTLM|Anonymous NTLM|  \n|Domain User|NTLM|NTLM|Kerberos|Kerberos|  \n|Domain Machine|NTLM|NTLM|Kerberos|Kerberos|  \n  \n Specifically, the four account types include:  \n  \n-   Local User: Machine-only user profile. For example: `MachineName\\Administrator` or `MachineName\\ProfileName`.  \n  \n-   Local System: The built-in account SYSTEM on a machine that is not joined to a domain.  \n  \n-   Domain User: A user account on a Windows domain. For example: `DomainName\\ProfileName`.  \n  \n-   Domain Machine: A process with machine identity running on a machine joined to a Windows domain. For example: `MachineName\\Network Service`.  \n  \n> [!NOTE]\n>  The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called. The client credential is read whenever the client sends a message.  \n  \n## Common Windows Authentication Problems  \n This section discusses some common Windows authentication problems and possible remedies.  \n  \n### Kerberos Protocol  \n  \n#### SPN/UPN Problems with the Kerberos Protocol  \n When using Windows authentication, and the Kerberos protocol is used or negotiated by SSPI, the URL the client endpoint uses must include the fully qualified domain name of the service's host inside the service URL. This assumes that the account under which the service is running has access to the machine (default) service principal name (SPN) key that is created when the computer is added to the Active Directory domain, which is most commonly done by running the service under the Network Service account. If the service does not have access to the machine SPN key, you must supply the correct SPN or user principal name (UPN) of the account under which the service is running in the client's endpoint identity. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] how [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] works with SPN and UPN, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).  \n  \n In load-balancing scenarios, such as Web farms or Web gardens, a common practice is to define a unique account for each application, assign an SPN to that account, and ensure that all of the application's services run in that account.  \n  \n To obtain an SPN for your service's account, you need to be an Active Directory domain administrator. [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Kerberos Technical Supplement for Windows](http://go.microsoft.com/fwlink/?LinkID=88330).  \n  \n#### Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account  \n This occurs when the `ClientCredentialType` property is set to `Windows` and the <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> property is set to `false`, as shown in the following code.  \n  \n [!code-csharp[C_DebuggingWindowsAuth#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#1)]\n [!code-vb[C_DebuggingWindowsAuth#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#1)]  \n  \n To remedy, run the service using a Domain Machine account, such as Network Service, on a domain joined machine.  \n  \n### Delegation Requires Credential Negotiation  \n To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called \"multi-leg\" or \"multi-step\" Kerberos). If you implement Kerberos authentication without credential negotiation (sometimes called \"one-shot\" or \"single-leg\" Kerberos), an exception will be thrown.  \n  \n To implement Kerberos with credential negotiation, do the following steps:  \n  \n1.  Implement delegation by setting <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> to <xref:System.Security.Principal.TokenImpersonationLevel>.  \n  \n2.  Require SSPI negotiation:  \n  \n    1.  If you are using standard bindings, set the `NegotiateServiceCredential` property to `true`.  \n  \n    2.  If you are using custom bindings, set the `AuthenticationMode` attribute of the `Security` element to `SspiNegotiated`.  \n  \n3.  Require the SSPI negotiation to use Kerberos by disallowing the use of NTLM:  \n  \n    1.  Do this in code, with the following statement: `ChannelFactory.Credentials.Windows.AllowNtlm = false`  \n  \n    2.  Or you can do this in the configuration file by setting the `allowNtlm` attribute to `false`. This attribute is contained in the [\\<windows>](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md).  \n  \n### NTLM Protocol  \n  \n#### Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled  \n The <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> property is set to `false`, which causes [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] to make a best-effort to throw an exception if NTLM is used. Note that setting this property to `false` may not prevent NTLM credentials from being sent over the wire.  \n  \n The following shows how to disable fallback to NTLM.  \n  \n [!code-csharp[C_DebuggingWindowsAuth#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#4)]\n [!code-vb[C_DebuggingWindowsAuth#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#4)]  \n  \n#### NTLM Logon Fails  \n The client credentials are not valid on the service. Check that the user name and password are correctly set and correspond to an account that is known to the computer where the service is running. NTLM uses the specified credentials to log on to the service's computer. While the credentials may be valid on the computer where the client is running, this logon will fail if the credentials are not valid on the service's computer.  \n  \n#### Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default  \n When creating a client, the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property is set to <xref:System.Security.Principal.TokenImpersonationLevel>, as shown in the following example, but by default the server disallows anonymous logons. This occurs because the default value of the <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> property of the <xref:System.ServiceModel.Security.WindowsServiceCredential> class is `false`.  \n  \n The following client code attempts to enable anonymous logons (note that the default property is `Identification`).  \n  \n [!code-csharp[C_DebuggingWindowsAuth#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#5)]\n [!code-vb[C_DebuggingWindowsAuth#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#5)]  \n  \n The following service code changes the default to enable anonymous logons by the server.  \n  \n [!code-csharp[C_DebuggingWindowsAuth#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#6)]\n [!code-vb[C_DebuggingWindowsAuth#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#6)]  \n  \n [!INCLUDE[crabout](../../../../includes/crabout-md.md)] impersonation, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).  \n  \n Alternatively, the client is running as a Windows service, using the built-in account SYSTEM.  \n  \n### Other Problems  \n  \n#### Client Credentials Are Not Set Correctly  \n Windows authentication uses the <xref:System.ServiceModel.Security.WindowsClientCredential> instance returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, not the <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>. The following shows an incorrect example.  \n  \n [!code-csharp[C_DebuggingWindowsAuth#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#2)]\n [!code-vb[C_DebuggingWindowsAuth#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#2)]  \n  \n The following shows the correct example.  \n  \n [!code-csharp[C_DebuggingWindowsAuth#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#3)]\n [!code-vb[C_DebuggingWindowsAuth#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#3)]  \n  \n#### SSPI Is Not Available  \n The following operating systems do not support Windows authentication when used as a server: [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Media Center Edition, and [!INCLUDE[wv](../../../../includes/wv-md.md)]Home editions.  \n  \n#### Developing and Deploying with Different Identities  \n If you develop your application on one machine, and deploy on another, and use different account types to authenticate on each machine, you may experience different behavior. For example, suppose you develop your application on a Windows XP Pro machine using the `SSPI Negotiated` authentication mode. If you use a local user account to authenticate with, then NTLM protocol will be used. Once the application is developed, you deploy the service to a Windows Server 2003 machine where it runs under a domain account. At this point the client will not be able to authenticate the service because it will be using Kerberos and a domain controller.  \n  \n## See Also  \n <xref:System.ServiceModel.Security.WindowsClientCredential>   \n <xref:System.ServiceModel.Security.WindowsServiceCredential>   \n <xref:System.ServiceModel.Security.WindowsClientCredential>   \n <xref:System.ServiceModel.ClientBase%601>   \n [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)   \n [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)","nodes":[{"pos":[4,442],"embed":true,"restype":"x-metadata","content":"title: \"Debugging Windows Authentication Errors | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"WCF, authentication\"\n  - \"WCF, Windows authentication\"\nms.assetid: 181be4bd-79b1-4a66-aee2-931887a6d7cc\ncaps.latest.revision: 21\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","nodes":[{"content":"Debugging Windows Authentication Errors | Microsoft Docs","nodes":[{"pos":[0,56],"content":"Debugging Windows Authentication Errors | Microsoft Docs","nodes":[{"content":"Debugging Windows Authentication Errors | Microsoft Docs","pos":[0,56]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[449,488],"content":"Debugging Windows Authentication Errors","linkify":"Debugging Windows Authentication Errors","nodes":[{"content":"Debugging Windows Authentication Errors","pos":[0,39]}]},{"content":"When using Windows authentication as a security mechanism, the Security Support Provider Interface (SSPI) handles security processes.","pos":[489,622]},{"content":"When security errors occur at the SSPI layer, they are surfaced by <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph>.","pos":[623,746],"source":" When security errors occur at the SSPI layer, they are surfaced by [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]."},{"content":"This topic provides a framework and set of questions to help diagnose the errors.","pos":[747,828]},{"pos":[835,1031],"content":"For an overview of the Kerberos protocol, see <bpt id=\"p1\">[</bpt>Kerberos Explained<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkID=86946)</ept>; for an overview of SSPI, see <bpt id=\"p2\">[</bpt>SSPI<ept id=\"p2\">](http://go.microsoft.com/fwlink/?LinkId=88941)</ept>.","source":"For an overview of the Kerberos protocol, see [Kerberos Explained](http://go.microsoft.com/fwlink/?LinkID=86946); for an overview of SSPI, see [SSPI](http://go.microsoft.com/fwlink/?LinkId=88941)."},{"content":"For Windows authentication, <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> typically uses the <bpt id=\"p1\">*</bpt>Negotiate<ept id=\"p1\">*</ept> Security Support Provider (SSP), which performs Kerberos mutual authentication between the client and service.","pos":[1038,1263],"source":"For Windows authentication, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] typically uses the *Negotiate* Security Support Provider (SSP), which performs Kerberos mutual authentication between the client and service."},{"content":"If the Kerberos protocol is not available, by default <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> falls back to NT LAN Manager (NTLM).","pos":[1264,1410],"source":" If the Kerberos protocol is not available, by default [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] falls back to NT LAN Manager (NTLM)."},{"content":"However, you can configure <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> to use only the Kerberos protocol (and to throw an exception if Kerberos is not available).","pos":[1411,1585],"source":" However, you can configure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to use only the Kerberos protocol (and to throw an exception if Kerberos is not available)."},{"content":"You can also configure <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> to use restricted forms of the Kerberos protocol.","pos":[1586,1714],"source":" You can also configure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to use restricted forms of the Kerberos protocol."},{"pos":[1723,1744],"content":"Debugging Methodology","linkify":"Debugging Methodology","nodes":[{"content":"Debugging Methodology","pos":[0,21]}]},{"content":"The basic method is as follows:","pos":[1748,1779]},{"content":"Determine whether you are using Windows authentication.","pos":[1789,1844]},{"content":"If you are using any other scheme, this topic does not apply.","pos":[1845,1906]},{"pos":[1916,2097],"content":"If you are sure you are using Windows authentication, determine whether your <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> configuration uses Kerberos direct or Negotiate.","source":"If you are sure you are using Windows authentication, determine whether your [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] configuration uses Kerberos direct or Negotiate."},{"content":"Once you have determined whether your configuration is using the Kerberos protocol or NTLM, you can understand error messages in the correct context.","pos":[2107,2256]},{"pos":[2266,2312],"content":"Availability of the Kerberos Protocol and NTLM","linkify":"Availability of the Kerberos Protocol and NTLM","nodes":[{"content":"Availability of the Kerberos Protocol and NTLM","pos":[0,46]}]},{"content":"The Kerberos SSP requires a domain controller to act as the Kerberos Key Distribution Center (KDC).","pos":[2316,2415]},{"content":"The Kerberos protocol is available only when both the client and service are using domain identities.","pos":[2416,2517]},{"content":"In other account combinations, NTLM is used, as summarized in the following table.","pos":[2518,2600]},{"content":"The table headers show possible account types used by the server.","pos":[2607,2672]},{"content":"The left column shows possible account types used by the client.","pos":[2673,2737]},{"content":"Local User","pos":[2745,2755]},{"content":"Local System","pos":[2756,2768]},{"content":"Domain User","pos":[2769,2780]},{"content":"Domain Machine","pos":[2781,2795]},{"content":"Local User","pos":[2881,2891]},{"content":"NTLM","pos":[2892,2896]},{"content":"NTLM","pos":[2897,2901]},{"content":"NTLM","pos":[2902,2906]},{"content":"NTLM","pos":[2907,2911]},{"content":"Local System","pos":[2916,2928]},{"content":"Anonymous NTLM","pos":[2929,2943]},{"content":"Anonymous NTLM","pos":[2944,2958]},{"content":"Anonymous NTLM","pos":[2959,2973]},{"content":"Anonymous NTLM","pos":[2974,2988]},{"content":"Domain User","pos":[2993,3004]},{"content":"NTLM","pos":[3005,3009]},{"content":"NTLM","pos":[3010,3014]},{"content":"Kerberos","pos":[3015,3023]},{"content":"Kerberos","pos":[3024,3032]},{"content":"Domain Machine","pos":[3037,3051]},{"content":"NTLM","pos":[3052,3056]},{"content":"NTLM","pos":[3057,3061]},{"content":"Kerberos","pos":[3062,3070]},{"content":"Kerberos","pos":[3071,3079]},{"content":"Specifically, the four account types include:","pos":[3087,3132]},{"content":"Local User: Machine-only user profile.","pos":[3142,3180]},{"content":"For example: <ph id=\"ph1\">`MachineName\\Administrator`</ph> or <ph id=\"ph2\">`MachineName\\ProfileName`</ph>.","pos":[3181,3251],"source":" For example: `MachineName\\Administrator` or `MachineName\\ProfileName`."},{"content":"Local System: The built-in account SYSTEM on a machine that is not joined to a domain.","pos":[3261,3347]},{"content":"Domain User: A user account on a Windows domain.","pos":[3357,3405]},{"content":"For example: <ph id=\"ph1\">`DomainName\\ProfileName`</ph>.","pos":[3406,3444],"source":" For example: `DomainName\\ProfileName`."},{"content":"Domain Machine: A process with machine identity running on a machine joined to a Windows domain.","pos":[3454,3550]},{"content":"For example: <ph id=\"ph1\">`MachineName\\Network Service`</ph>.","pos":[3551,3594],"source":" For example: `MachineName\\Network Service`."},{"pos":[3602,3849],"content":"[!NOTE]\n The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called. The client credential is read whenever the client sends a message.","leadings":["","> "],"nodes":[{"content":"The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called. The client credential is read whenever the client sends a message.","pos":[9,245],"nodes":[{"content":"The service credential is captured when the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ICommunicationObject.Open%2A&gt;</ph> method of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> class is called.","pos":[0,169],"source":"The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called."},{"content":"The client credential is read whenever the client sends a message.","pos":[170,236]}]}]},{"pos":[3858,3896],"content":"Common Windows Authentication Problems","linkify":"Common Windows Authentication Problems","nodes":[{"content":"Common Windows Authentication Problems","pos":[0,38]}]},{"content":"This section discusses some common Windows authentication problems and possible remedies.","pos":[3900,3989]},{"pos":[3999,4016],"content":"Kerberos Protocol","linkify":"Kerberos Protocol","nodes":[{"content":"Kerberos Protocol","pos":[0,17]}]},{"pos":[4027,4070],"content":"SPN/UPN Problems with the Kerberos Protocol","linkify":"SPN/UPN Problems with the Kerberos Protocol","nodes":[{"content":"SPN/UPN Problems with the Kerberos Protocol","pos":[0,43]}]},{"content":"When using Windows authentication, and the Kerberos protocol is used or negotiated by SSPI, the URL the client endpoint uses must include the fully qualified domain name of the service's host inside the service URL.","pos":[4074,4289]},{"content":"This assumes that the account under which the service is running has access to the machine (default) service principal name (SPN) key that is created when the computer is added to the Active Directory domain, which is most commonly done by running the service under the Network Service account.","pos":[4290,4584]},{"content":"If the service does not have access to the machine SPN key, you must supply the correct SPN or user principal name (UPN) of the account under which the service is running in the client's endpoint identity.","pos":[4585,4790]},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> how <ph id=\"ph2\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> works with SPN and UPN, see <bpt id=\"p1\">[</bpt>Service Identity and Authentication<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)</ept>.","pos":[4791,5060],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] how [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] works with SPN and UPN, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)."},{"content":"In load-balancing scenarios, such as Web farms or Web gardens, a common practice is to define a unique account for each application, assign an SPN to that account, and ensure that all of the application's services run in that account.","pos":[5067,5301]},{"content":"To obtain an SPN for your service's account, you need to be an Active Directory domain administrator.","pos":[5308,5409]},{"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)]</ph><bpt id=\"p1\">[</bpt>Kerberos Technical Supplement for Windows<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkID=88330)</ept>.","pos":[5410,5559],"source":"[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Kerberos Technical Supplement for Windows](http://go.microsoft.com/fwlink/?LinkID=88330)."},{"pos":[5570,5653],"content":"Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account","linkify":"Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account","nodes":[{"content":"Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account","pos":[0,83]}]},{"pos":[5657,5878],"content":"This occurs when the <ph id=\"ph1\">`ClientCredentialType`</ph> property is set to <ph id=\"ph2\">`Windows`</ph> and the <ph id=\"ph3\">&lt;xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A&gt;</ph> property is set to <ph id=\"ph4\">`false`</ph>, as shown in the following code.","source":"This occurs when the `ClientCredentialType` property is set to `Windows` and the <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> property is set to `false`, as shown in the following code."},{"content":"To remedy, run the service using a Domain Machine account, such as Network Service, on a domain joined machine.","pos":[6157,6268]},{"pos":[6278,6320],"content":"Delegation Requires Credential Negotiation","linkify":"Delegation Requires Credential Negotiation","nodes":[{"content":"Delegation Requires Credential Negotiation","pos":[0,42]}]},{"content":"To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called \"multi-leg\" or \"multi-step\" Kerberos).","pos":[6324,6510]},{"content":"If you implement Kerberos authentication without credential negotiation (sometimes called \"one-shot\" or \"single-leg\" Kerberos), an exception will be thrown.","pos":[6511,6667]},{"content":"To implement Kerberos with credential negotiation, do the following steps:","pos":[6674,6748]},{"content":"Implement delegation by setting <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A&gt;</ph> to <ph id=\"ph2\">&lt;xref:System.Security.Principal.TokenImpersonationLevel&gt;</ph>.","pos":[6758,6939],"source":"Implement delegation by setting <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> to <xref:System.Security.Principal.TokenImpersonationLevel>."},{"content":"Require SSPI negotiation:","pos":[6949,6974]},{"pos":[6988,7080],"content":"If you are using standard bindings, set the <ph id=\"ph1\">`NegotiateServiceCredential`</ph> property to <ph id=\"ph2\">`true`</ph>.","source":"If you are using standard bindings, set the `NegotiateServiceCredential` property to `true`."},{"pos":[7094,7213],"content":"If you are using custom bindings, set the <ph id=\"ph1\">`AuthenticationMode`</ph> attribute of the <ph id=\"ph2\">`Security`</ph> element to <ph id=\"ph3\">`SspiNegotiated`</ph>.","source":"If you are using custom bindings, set the `AuthenticationMode` attribute of the `Security` element to `SspiNegotiated`."},{"content":"Require the SSPI negotiation to use Kerberos by disallowing the use of NTLM:","pos":[7223,7299]},{"pos":[7313,7414],"content":"Do this in code, with the following statement: <ph id=\"ph1\">`ChannelFactory.Credentials.Windows.AllowNtlm = false`</ph>","source":"Do this in code, with the following statement: `ChannelFactory.Credentials.Windows.AllowNtlm = false`"},{"content":"Or you can do this in the configuration file by setting the <ph id=\"ph1\">`allowNtlm`</ph> attribute to <ph id=\"ph2\">`false`</ph>.","pos":[7428,7521],"source":"Or you can do this in the configuration file by setting the `allowNtlm` attribute to `false`."},{"content":"This attribute is contained in the <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>windows&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md)</ept>.","pos":[7522,7669],"source":" This attribute is contained in the [\\<windows>](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md)."},{"pos":[7679,7692],"content":"NTLM Protocol","linkify":"NTLM Protocol","nodes":[{"content":"NTLM Protocol","pos":[0,13]}]},{"pos":[7703,7757],"content":"Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled","linkify":"Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled","nodes":[{"content":"Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled","pos":[0,54]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A&gt;</ph> property is set to <ph id=\"ph2\">`false`</ph>, which causes <ph id=\"ph3\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> to make a best-effort to throw an exception if NTLM is used.","pos":[7761,7995],"source":"The <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> property is set to `false`, which causes [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] to make a best-effort to throw an exception if NTLM is used."},{"content":"Note that setting this property to <ph id=\"ph1\">`false`</ph> may not prevent NTLM credentials from being sent over the wire.","pos":[7996,8102],"source":" Note that setting this property to `false` may not prevent NTLM credentials from being sent over the wire."},{"content":"The following shows how to disable fallback to NTLM.","pos":[8109,8161]},{"pos":[8444,8460],"content":"NTLM Logon Fails","linkify":"NTLM Logon Fails","nodes":[{"content":"NTLM Logon Fails","pos":[0,16]}]},{"content":"The client credentials are not valid on the service.","pos":[8464,8516]},{"content":"Check that the user name and password are correctly set and correspond to an account that is known to the computer where the service is running.","pos":[8517,8661]},{"content":"NTLM uses the specified credentials to log on to the service's computer.","pos":[8662,8734]},{"content":"While the credentials may be valid on the computer where the client is running, this logon will fail if the credentials are not valid on the service's computer.","pos":[8735,8895]},{"pos":[8906,8979],"content":"Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default","linkify":"Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default","nodes":[{"content":"Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default","pos":[0,73]}]},{"content":"When creating a client, the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A&gt;</ph> property is set to <ph id=\"ph2\">&lt;xref:System.Security.Principal.TokenImpersonationLevel&gt;</ph>, as shown in the following example, but by default the server disallows anonymous logons.","pos":[8983,9265],"source":"When creating a client, the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property is set to <xref:System.Security.Principal.TokenImpersonationLevel>, as shown in the following example, but by default the server disallows anonymous logons."},{"content":"This occurs because the default value of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Security.WindowsServiceCredential&gt;</ph> class is <ph id=\"ph3\">`false`</ph>.","pos":[9266,9490],"source":" This occurs because the default value of the <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> property of the <xref:System.ServiceModel.Security.WindowsServiceCredential> class is `false`."},{"pos":[9497,9612],"content":"The following client code attempts to enable anonymous logons (note that the default property is <ph id=\"ph1\">`Identification`</ph>).","source":"The following client code attempts to enable anonymous logons (note that the default property is `Identification`)."},{"content":"The following service code changes the default to enable anonymous logons by the server.","pos":[9891,9979]},{"pos":[10258,10453],"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> impersonation, see <bpt id=\"p1\">[</bpt>Delegation and Impersonation<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)</ept>.","source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] impersonation, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)."},{"content":"Alternatively, the client is running as a Windows service, using the built-in account SYSTEM.","pos":[10460,10553]},{"pos":[10563,10577],"content":"Other Problems","linkify":"Other Problems","nodes":[{"content":"Other Problems","pos":[0,14]}]},{"pos":[10588,10628],"content":"Client Credentials Are Not Set Correctly","linkify":"Client Credentials Are Not Set Correctly","nodes":[{"content":"Client Credentials Are Not Set Correctly","pos":[0,40]}]},{"content":"Windows authentication uses the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential&gt;</ph> instance returned by the <ph id=\"ph2\">&lt;xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A&gt;</ph> property of the <ph id=\"ph3\">&lt;xref:System.ServiceModel.ClientBase%601&gt;</ph> class, not the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Security.UserNamePasswordClientCredential&gt;</ph>.","pos":[10632,10954],"source":"Windows authentication uses the <xref:System.ServiceModel.Security.WindowsClientCredential> instance returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, not the <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>."},{"content":"The following shows an incorrect example.","pos":[10955,10996]},{"content":"The following shows the correct example.","pos":[11275,11315]},{"pos":[11598,11619],"content":"SSPI Is Not Available","linkify":"SSPI Is Not Available","nodes":[{"content":"SSPI Is Not Available","pos":[0,21]}]},{"pos":[11623,11911],"content":"The following operating systems do not support Windows authentication when used as a server: <ph id=\"ph1\">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]</ph> Home Edition, <ph id=\"ph2\">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]</ph> Media Center Edition, and <ph id=\"ph3\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph>Home editions.","source":"The following operating systems do not support Windows authentication when used as a server: [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Media Center Edition, and [!INCLUDE[wv](../../../../includes/wv-md.md)]Home editions."},{"pos":[11922,11972],"content":"Developing and Deploying with Different Identities","linkify":"Developing and Deploying with Different Identities","nodes":[{"content":"Developing and Deploying with Different Identities","pos":[0,50]}]},{"content":"If you develop your application on one machine, and deploy on another, and use different account types to authenticate on each machine, you may experience different behavior.","pos":[11976,12150]},{"content":"For example, suppose you develop your application on a Windows XP Pro machine using the <ph id=\"ph1\">`SSPI Negotiated`</ph> authentication mode.","pos":[12151,12277],"source":" For example, suppose you develop your application on a Windows XP Pro machine using the `SSPI Negotiated` authentication mode."},{"content":"If you use a local user account to authenticate with, then NTLM protocol will be used.","pos":[12278,12364]},{"content":"Once the application is developed, you deploy the service to a Windows Server 2003 machine where it runs under a domain account.","pos":[12365,12493]},{"content":"At this point the client will not be able to authenticate the service because it will be using Kerberos and a domain controller.","pos":[12494,12622]},{"pos":[12631,12639],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential&gt;</ph>","pos":[12643,12702],"source":"<xref:System.ServiceModel.Security.WindowsClientCredential> "},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsServiceCredential&gt;</ph>","pos":[12707,12767],"source":"<xref:System.ServiceModel.Security.WindowsServiceCredential> "},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential&gt;</ph>","pos":[12772,12831],"source":"<xref:System.ServiceModel.Security.WindowsClientCredential> "},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.ClientBase%601&gt;</ph>","pos":[12836,12877],"source":"<xref:System.ServiceModel.ClientBase%601> "},{"content":"<bpt id=\"p1\">[</bpt>Delegation and Impersonation<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)</ept><ph id=\"ph1\"> </ph>","pos":[12882,13002],"source":"[Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md) "},{"content":"<bpt id=\"p1\">[</bpt>Unsupported Scenarios<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)</ept>","pos":[13006,13102],"source":"[Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)"}]}