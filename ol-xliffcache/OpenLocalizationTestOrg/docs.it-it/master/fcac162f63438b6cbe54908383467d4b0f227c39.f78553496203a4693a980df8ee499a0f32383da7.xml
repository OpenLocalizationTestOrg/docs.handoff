{"content":"---\ntitle: \"Ref return values and ref locals (C# Guide)\"\ndescription: \"Learn how to define and use ref return and ref local values\"\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nms.date: \"04/04/2018\"\n---\n# Ref returns and ref locals\n\nStarting with C# 7.0, C# supports reference return values (ref returns). A reference return value allows a method to return a reference to a variable, rather than a value, back to a caller. The caller can then choose to treat the returned variable as if it were returned by value or by reference. The caller can create a new variable that is itself a reference to the returned value, called a ref local.\n\n## What is a reference return value?\n\nMost developers are familiar with passing an argument to a called method *by reference*. A called method's argument list includes a variable passed by reference. Any changes made to its value by the called method are observed by the caller. A *reference return value* means that a method returns a *reference* (or an alias) to some variable. That variable's scope must include the method. That variable's lifetime must extend beyond the return of the method. Modifications to the method's return value by the caller are made to the variable that is returned by the method.\n\nDeclaring that a method returns a *reference return value* indicates that the method returns an alias to a variable. The design intent is often that the calling code should have access to that variable through the alias, including to modify it. It follows that methods returning by reference can't have the return type `void`.\n\nThere are some restrictions on the expression that a method can return as a reference return value. Restrictions include:\n\n- The return value must have a lifetime that extends beyond the execution of the method. In other words, it cannot be a local variable in the method that returns it. It can be an instance or static field of a class, or it can be an argument passed to the method. Attempting to return a local variable generates compiler error CS8168, \"Cannot return local 'obj' by reference because it is not a ref local.\"\n\n- The return value cannot be the literal `null`. Returning `null` generates compiler error CS8156, \"An expression cannot be used in this context because it may not be returned by reference.\"\n\n   A method with a ref return can return an alias to a variable whose value is currently the null (uninstantiated) value or a [nullable type](../nullable-types/index.md) for a value type.\n \n- The return value cannot be a constant, an enumeration member, the by-value return value from a property, or a method of a `class` or `struct`. Violating this rule generates compiler error CS8156, \"An expression cannot be used in this context because it may not be returned by reference.\"\n\nIn addition, reference return values are not allowed on async methods. An asynchronous method may return before it has finished execution, while its return value is still unknown.\n \n## Defining a ref return value\n\nA method that returns a *reference return value* must satisfy the following two conditions:\n\n- The method signature includes the [ref](../../language-reference/keywords/ref.md) keyword in front of the return type.\n- Each [return](../../language-reference/keywords/return.md) statement in the method body includes the [ref](../../language-reference/keywords/ref.md) keyword in front of the name of the returned instance.\n\nThe following example shows a method that satisfies those conditions and returns a reference to a `Person` object named `p`:\n\n```csharp\npublic ref Person GetContactInformation(string fname, string lname)\n{\n    // ...method implementation...\n    return ref p;\n}\n```\n\n## Consuming a ref return value\n\nThe ref return value is an alias to another variable in the called method's scope. You can interpret any use of the ref return as using the variable it aliases:\n\n- When you assign its value, you are assigning a value to the variable it aliases.\n- When you read its value, you are reading the value of the variable it aliases.\n- If you return it *by reference*, you are returning an alias to that same variable.\n- If you pass it to another method *by reference*, you are passing a reference to the variable it aliases.\n- When you make a [ref local](#ref-locals) alias, you make a new alias to the same variable.\n\n## Ref locals\n\nAssume the `GetContactInformation` method is declared as a ref return:\n\n```csharp\npublic ref Person GetContactInformation(string fname, string lname)\n```\n\nA by-value assignment reads the value of a variable and assigns it to a new variable:\n\n```csharp\nPerson p = contacts.GetContactInformation(\"Brandie\", \"Best\");\n```\n\nThe preceding assignment declares `p` as a local variable. Its initial value is copied from reading the value returned by `GetContactInformation`. Any future assignments to `p` will not change the value of the variable returned by `GetContactInformation`. The variable `p` is no longer an alias to the variable returned.\n\nYou declare a *ref local* variable to copy the alias to the original value. In the following assignment, `p` is an alias to the variable returned from `GetContactInformation`.\n\n```csharp\nref Person p = ref contacts.GetContactInformation(\"Brandie\", \"Best\");\n```\n\nSubsequent usage of `p` is the same as using the variable returned by `GetContactInformation` because `p` is an alias for that variable. Changes to `p` also change the variable returned from `GetContactInformation`.\n\nThe `ref` keyword is used both before the local variable declaration *and* before the method call. \n\nYou can access a value by reference in the same way. In some cases, accessing a value by reference increases performance by avoiding a potentially expensive copy operation. For example, the following statement shows how one can define a ref local value that is used to reference a value.\n\n```csharp\nref VeryLargeStruct reflocal = ref veryLargeStruct;\n```\n\nThe `ref` keyword is used both before the local variable declaration *and* before the value in the second example. Failure to include both `ref` keywords in the variable declaration and assignment in both examples results in compiler error CS8172, \"Cannot initialize a by-reference variable with a value.\" \n\nPrior to C# 7.3, ref local variables couldn't be reassigned to refer to different storage after being initialized. That restriction has been removed. The following example shows a reassignment:\n\n```csharp\nref VeryLargeStruct reflocal = ref veryLargeStruct; // initialization\nrefLocal = ref anotherVeryLargeStruct; // reassigned, refLocal refers to different storage.\n```\n\n Ref local variables must still be initialized when they are declared.\n\n## Ref returns and ref locals: an example\n\nThe following example defines a `NumberStore` class that stores an array of integer values. The `FindNumber` method returns by reference the first number that is greater than or equal to the number passed as an argument. If no number is greater than or equal to the argument, the method returns the number in index 0. \n\n[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/NumberStore.cs#1)]\n\nThe following example calls the `NumberStore.FindNumber` method to retrieve the first value that is greater than or equal to 16. The caller then doubles the value returned by the method. The output from the example shows the change reflected in the value of the array elements of the `NumberStore` instance.\n\n[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/NumberStore.cs#2)]\n\nWithout support for reference return values, such an operation is performed by returning the index of the array element along with its value. The caller can then use this index to modify the value in a separate method call. However, the caller can also modify the index to access and possibly modify other array values.  \n\nThe following example shows how the `FindNumber` method could be rewritten after\nC# 7.3 to use ref local reassignment:\n\n[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/NumberStoreUpdated.cs#1)]\n\nThis second version is more efficient with longer sequences in scenarios where the number sought is\ncloser to the end of the array.\n\n## See also\n\n- [ref keyword](../../language-reference/keywords/ref.md)\n- [Write safe efficient code](../../write-safe-efficient-code.md)\n","nodes":[{"pos":[4,193],"embed":true,"restype":"x-metadata","content":"title: \"Ref return values and ref locals (C# Guide)\"\ndescription: \"Learn how to define and use ref return and ref local values\"\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nms.date: \"04/04/2018\"","nodes":[{"content":"Ref return values and ref locals (C# Guide)","nodes":[{"pos":[0,43],"content":"Ref return values and ref locals (C# Guide)","nodes":[{"content":"Ref return values and ref locals (C# Guide)","pos":[0,43]}]}],"path":["title"],"nosxs":false},{"content":"Learn how to define and use ref return and ref local values","nodes":[{"pos":[0,59],"content":"Learn how to define and use ref return and ref local values","nodes":[{"content":"Learn how to define and use ref return and ref local values","pos":[0,59]}]}],"path":["description"],"nosxs":false}],"yml":true},{"pos":[200,226],"content":"Ref returns and ref locals","linkify":"Ref returns and ref locals","nodes":[{"content":"Ref returns and ref locals","pos":[0,26]}]},{"content":"Starting with C# 7.0, C# supports reference return values (ref returns).","pos":[228,300]},{"content":"A reference return value allows a method to return a reference to a variable, rather than a value, back to a caller.","pos":[301,417]},{"content":"The caller can then choose to treat the returned variable as if it were returned by value or by reference.","pos":[418,524]},{"content":"The caller can create a new variable that is itself a reference to the returned value, called a ref local.","pos":[525,631]},{"pos":[636,669],"content":"What is a reference return value?","linkify":"What is a reference return value?","nodes":[{"content":"What is a reference return value?","pos":[0,33]}]},{"content":"Most developers are familiar with passing an argument to a called method <bpt id=\"p1\">*</bpt>by reference<ept id=\"p1\">*</ept>.","pos":[671,759],"source":"Most developers are familiar with passing an argument to a called method *by reference*."},{"content":"A called method's argument list includes a variable passed by reference.","pos":[760,832]},{"content":"Any changes made to its value by the called method are observed by the caller.","pos":[833,911]},{"content":"A <bpt id=\"p1\">*</bpt>reference return value<ept id=\"p1\">*</ept> means that a method returns a <bpt id=\"p2\">*</bpt>reference<ept id=\"p2\">*</ept> (or an alias) to some variable.","pos":[912,1012],"source":" A *reference return value* means that a method returns a *reference* (or an alias) to some variable."},{"content":"That variable's scope must include the method.","pos":[1013,1059]},{"content":"That variable's lifetime must extend beyond the return of the method.","pos":[1060,1129]},{"content":"Modifications to the method's return value by the caller are made to the variable that is returned by the method.","pos":[1130,1243]},{"content":"Declaring that a method returns a <bpt id=\"p1\">*</bpt>reference return value<ept id=\"p1\">*</ept> indicates that the method returns an alias to a variable.","pos":[1245,1361],"source":"Declaring that a method returns a *reference return value* indicates that the method returns an alias to a variable."},{"content":"The design intent is often that the calling code should have access to that variable through the alias, including to modify it.","pos":[1362,1489]},{"content":"It follows that methods returning by reference can't have the return type <ph id=\"ph1\">`void`</ph>.","pos":[1490,1571],"source":" It follows that methods returning by reference can't have the return type `void`."},{"content":"There are some restrictions on the expression that a method can return as a reference return value.","pos":[1573,1672]},{"content":"Restrictions include:","pos":[1673,1694]},{"content":"The return value must have a lifetime that extends beyond the execution of the method.","pos":[1698,1784]},{"content":"In other words, it cannot be a local variable in the method that returns it.","pos":[1785,1861]},{"content":"It can be an instance or static field of a class, or it can be an argument passed to the method.","pos":[1862,1958]},{"content":"Attempting to return a local variable generates compiler error CS8168, \"Cannot return local 'obj' by reference because it is not a ref local.\"","pos":[1959,2101]},{"content":"The return value cannot be the literal <ph id=\"ph1\">`null`</ph>.","pos":[2105,2151],"source":"The return value cannot be the literal `null`."},{"content":"Returning <ph id=\"ph1\">`null`</ph> generates compiler error CS8156, \"An expression cannot be used in this context because it may not be returned by reference.\"","pos":[2152,2293],"source":" Returning `null` generates compiler error CS8156, \"An expression cannot be used in this context because it may not be returned by reference.\""},{"pos":[2298,2482],"content":"A method with a ref return can return an alias to a variable whose value is currently the null (uninstantiated) value or a <bpt id=\"p1\">[</bpt>nullable type<ept id=\"p1\">](../nullable-types/index.md)</ept> for a value type.","source":"A method with a ref return can return an alias to a variable whose value is currently the null (uninstantiated) value or a [nullable type](../nullable-types/index.md) for a value type."},{"content":"The return value cannot be a constant, an enumeration member, the by-value return value from a property, or a method of a <ph id=\"ph1\">`class`</ph> or <ph id=\"ph2\">`struct`</ph>.","pos":[2487,2629],"source":"The return value cannot be a constant, an enumeration member, the by-value return value from a property, or a method of a `class` or `struct`."},{"content":"Violating this rule generates compiler error CS8156, \"An expression cannot be used in this context because it may not be returned by reference.\"","pos":[2630,2774]},{"content":"In addition, reference return values are not allowed on async methods.","pos":[2776,2846]},{"content":"An asynchronous method may return before it has finished execution, while its return value is still unknown.","pos":[2847,2955]},{"pos":[2961,2988],"content":"Defining a ref return value","linkify":"Defining a ref return value","nodes":[{"content":"Defining a ref return value","pos":[0,27]}]},{"pos":[2990,3081],"content":"A method that returns a <bpt id=\"p1\">*</bpt>reference return value<ept id=\"p1\">*</ept> must satisfy the following two conditions:","source":"A method that returns a *reference return value* must satisfy the following two conditions:"},{"pos":[3085,3203],"content":"The method signature includes the <bpt id=\"p1\">[</bpt>ref<ept id=\"p1\">](../../language-reference/keywords/ref.md)</ept> keyword in front of the return type.","source":"The method signature includes the [ref](../../language-reference/keywords/ref.md) keyword in front of the return type."},{"pos":[3206,3409],"content":"Each <bpt id=\"p1\">[</bpt>return<ept id=\"p1\">](../../language-reference/keywords/return.md)</ept> statement in the method body includes the <bpt id=\"p2\">[</bpt>ref<ept id=\"p2\">](../../language-reference/keywords/ref.md)</ept> keyword in front of the name of the returned instance.","source":"Each [return](../../language-reference/keywords/return.md) statement in the method body includes the [ref](../../language-reference/keywords/ref.md) keyword in front of the name of the returned instance."},{"pos":[3411,3535],"content":"The following example shows a method that satisfies those conditions and returns a reference to a <ph id=\"ph1\">`Person`</ph> object named <ph id=\"ph2\">`p`</ph>:","source":"The following example shows a method that satisfies those conditions and returns a reference to a `Person` object named `p`:"},{"pos":[3680,3708],"content":"Consuming a ref return value","linkify":"Consuming a ref return value","nodes":[{"content":"Consuming a ref return value","pos":[0,28]}]},{"content":"The ref return value is an alias to another variable in the called method's scope.","pos":[3710,3792]},{"content":"You can interpret any use of the ref return as using the variable it aliases:","pos":[3793,3870]},{"content":"When you assign its value, you are assigning a value to the variable it aliases.","pos":[3874,3954]},{"content":"When you read its value, you are reading the value of the variable it aliases.","pos":[3957,4035]},{"pos":[4038,4120],"content":"If you return it <bpt id=\"p1\">*</bpt>by reference<ept id=\"p1\">*</ept>, you are returning an alias to that same variable.","source":"If you return it *by reference*, you are returning an alias to that same variable."},{"pos":[4123,4227],"content":"If you pass it to another method <bpt id=\"p1\">*</bpt>by reference<ept id=\"p1\">*</ept>, you are passing a reference to the variable it aliases.","source":"If you pass it to another method *by reference*, you are passing a reference to the variable it aliases."},{"pos":[4230,4320],"content":"When you make a <bpt id=\"p1\">[</bpt>ref local<ept id=\"p1\">](#ref-locals)</ept> alias, you make a new alias to the same variable.","source":"When you make a [ref local](#ref-locals) alias, you make a new alias to the same variable."},{"pos":[4325,4335],"content":"Ref locals","linkify":"Ref locals","nodes":[{"content":"Ref locals","pos":[0,10]}]},{"pos":[4337,4407],"content":"Assume the <ph id=\"ph1\">`GetContactInformation`</ph> method is declared as a ref return:","source":"Assume the `GetContactInformation` method is declared as a ref return:"},{"content":"A by-value assignment reads the value of a variable and assigns it to a new variable:","pos":[4492,4577]},{"content":"The preceding assignment declares <ph id=\"ph1\">`p`</ph> as a local variable.","pos":[4656,4714],"source":"The preceding assignment declares `p` as a local variable."},{"content":"Its initial value is copied from reading the value returned by <ph id=\"ph1\">`GetContactInformation`</ph>.","pos":[4715,4802],"source":" Its initial value is copied from reading the value returned by `GetContactInformation`."},{"content":"Any future assignments to <ph id=\"ph1\">`p`</ph> will not change the value of the variable returned by <ph id=\"ph2\">`GetContactInformation`</ph>.","pos":[4803,4911],"source":" Any future assignments to `p` will not change the value of the variable returned by `GetContactInformation`."},{"content":"The variable <ph id=\"ph1\">`p`</ph> is no longer an alias to the variable returned.","pos":[4912,4976],"source":" The variable `p` is no longer an alias to the variable returned."},{"content":"You declare a <bpt id=\"p1\">*</bpt>ref local<ept id=\"p1\">*</ept> variable to copy the alias to the original value.","pos":[4978,5053],"source":"You declare a *ref local* variable to copy the alias to the original value."},{"content":"In the following assignment, <ph id=\"ph1\">`p`</ph> is an alias to the variable returned from <ph id=\"ph2\">`GetContactInformation`</ph>.","pos":[5054,5153],"source":" In the following assignment, `p` is an alias to the variable returned from `GetContactInformation`."},{"content":"Subsequent usage of <ph id=\"ph1\">`p`</ph> is the same as using the variable returned by <ph id=\"ph2\">`GetContactInformation`</ph> because <ph id=\"ph3\">`p`</ph> is an alias for that variable.","pos":[5240,5376],"source":"Subsequent usage of `p` is the same as using the variable returned by `GetContactInformation` because `p` is an alias for that variable."},{"content":"Changes to <ph id=\"ph1\">`p`</ph> also change the variable returned from <ph id=\"ph2\">`GetContactInformation`</ph>.","pos":[5377,5455],"source":" Changes to `p` also change the variable returned from `GetContactInformation`."},{"pos":[5457,5555],"content":"The <ph id=\"ph1\">`ref`</ph> keyword is used both before the local variable declaration <bpt id=\"p1\">*</bpt>and<ept id=\"p1\">*</ept> before the method call.","source":"The `ref` keyword is used both before the local variable declaration *and* before the method call."},{"content":"You can access a value by reference in the same way.","pos":[5558,5610]},{"content":"In some cases, accessing a value by reference increases performance by avoiding a potentially expensive copy operation.","pos":[5611,5730]},{"content":"For example, the following statement shows how one can define a ref local value that is used to reference a value.","pos":[5731,5845]},{"content":"The <ph id=\"ph1\">`ref`</ph> keyword is used both before the local variable declaration <bpt id=\"p1\">*</bpt>and<ept id=\"p1\">*</ept> before the value in the second example.","pos":[5914,6028],"source":"The `ref` keyword is used both before the local variable declaration *and* before the value in the second example."},{"content":"Failure to include both <ph id=\"ph1\">`ref`</ph> keywords in the variable declaration and assignment in both examples results in compiler error CS8172, \"Cannot initialize a by-reference variable with a value.\"","pos":[6029,6219],"source":" Failure to include both `ref` keywords in the variable declaration and assignment in both examples results in compiler error CS8172, \"Cannot initialize a by-reference variable with a value.\""},{"content":"Prior to C# 7.3, ref local variables couldn't be reassigned to refer to different storage after being initialized.","pos":[6222,6336]},{"content":"That restriction has been removed.","pos":[6337,6371]},{"content":"The following example shows a reassignment:","pos":[6372,6415]},{"content":"Ref local variables must still be initialized when they are declared.","pos":[6595,6664]},{"pos":[6669,6707],"content":"Ref returns and ref locals: an example","linkify":"Ref returns and ref locals: an example","nodes":[{"content":"Ref returns and ref locals: an example","pos":[0,38]}]},{"content":"The following example defines a <ph id=\"ph1\">`NumberStore`</ph> class that stores an array of integer values.","pos":[6709,6800],"source":"The following example defines a `NumberStore` class that stores an array of integer values."},{"content":"The <ph id=\"ph1\">`FindNumber`</ph> method returns by reference the first number that is greater than or equal to the number passed as an argument.","pos":[6801,6929],"source":" The `FindNumber` method returns by reference the first number that is greater than or equal to the number passed as an argument."},{"content":"If no number is greater than or equal to the argument, the method returns the number in index 0.","pos":[6930,7026]},{"content":"The following example calls the <ph id=\"ph1\">`NumberStore.FindNumber`</ph> method to retrieve the first value that is greater than or equal to 16.","pos":[7142,7270],"source":"The following example calls the `NumberStore.FindNumber` method to retrieve the first value that is greater than or equal to 16."},{"content":"The caller then doubles the value returned by the method.","pos":[7271,7328]},{"content":"The output from the example shows the change reflected in the value of the array elements of the <ph id=\"ph1\">`NumberStore`</ph> instance.","pos":[7329,7449],"source":" The output from the example shows the change reflected in the value of the array elements of the `NumberStore` instance."},{"content":"Without support for reference return values, such an operation is performed by returning the index of the array element along with its value.","pos":[7564,7705]},{"content":"The caller can then use this index to modify the value in a separate method call.","pos":[7706,7787]},{"content":"However, the caller can also modify the index to access and possibly modify other array values.","pos":[7788,7883]},{"pos":[7887,8005],"content":"The following example shows how the <ph id=\"ph1\">`FindNumber`</ph> method could be rewritten after C# 7.3 to use ref local reassignment:","source":"The following example shows how the `FindNumber` method could be rewritten after\nC# 7.3 to use ref local reassignment:"},{"pos":[8127,8258],"content":"This second version is more efficient with longer sequences in scenarios where the number sought is closer to the end of the array.","source":"This second version is more efficient with longer sequences in scenarios where the number sought is\ncloser to the end of the array."},{"pos":[8263,8271],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[8275,8330],"content":"<bpt id=\"p1\">[</bpt>ref keyword<ept id=\"p1\">](../../language-reference/keywords/ref.md)</ept>","source":"[ref keyword](../../language-reference/keywords/ref.md)"},{"pos":[8333,8396],"content":"<bpt id=\"p1\">[</bpt>Write safe efficient code<ept id=\"p1\">](../../write-safe-efficient-code.md)</ept>","source":"[Write safe efficient code](../../write-safe-efficient-code.md)"}]}