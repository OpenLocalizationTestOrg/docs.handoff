{"content":"---\ntitle: \"Asynchronous Programming\"\nms.date: \"10/18/2018\"\nms.assetid: 85da7447-7125-426e-aa5f-438a290d1f77\n---\n\n# Asynchronous Programming\n\nThis topic discusses support for asynchronous programming in the [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] Data Provider for SQL Server (SqlClient) including enhancements made to support asynchronous programming functionality that was introduced in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)].\n\n## Legacy Asynchronous Programming\n\nPrior to [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], asynchronous programming with SqlClient was done with the following methods and the `Asynchronous Processing=true` connection property:\n\n1. <xref:System.Data.SqlClient.SqlCommand.BeginExecuteNonQuery%2A?displayProperty=nameWithType>\n\n2. <xref:System.Data.SqlClient.SqlCommand.BeginExecuteReader%2A?displayProperty=nameWithType>\n\n3. <xref:System.Data.SqlClient.SqlCommand.BeginExecuteXmlReader%2A?displayProperty=nameWithType>\n\nThis functionality remains in SqlClient in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)].\n\n> [!TIP]\n> Beginning in the [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], these legacy methods no longer require `Asynchronous Processing=true` in the connection string.\n\n## Asynchronous Programming Features Added in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]\n\nThe new asynchronous programming feature provides a simple technique to make code asynchronous.\n\nFor more information about the asynchronous programming feature that was introduced in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], see:\n\n- [Asynchronous programming in C#](../../../csharp/async.md)\n\n- [Asynchronous Programming with Async and Await (Visual Basic)](../../../visual-basic/programming-guide/concepts/async/index.md)\n\n- [Using SqlDataReader’s new async methods in .NET 4.5 (Part 1)](https://blogs.msdn.microsoft.com/adonet/2012/04/20/using-sqldatareaders-new-async-methods-in-net-4-5/)\n\n- [Using SqlDataReader’s new async methods in .NET 4.5 (Part 2)](https://blogs.msdn.microsoft.com/adonet/2012/07/15/using-sqldatareaders-new-async-methods-in-net-4-5-part-2-examples/)\n\nWhen your user interface is unresponsive or your server does not scale, it is likely that you need your code to be more asynchronous. Writing asynchronous code has traditionally involved installing a callback (also called continuation) to express the logic that occurs after the asynchronous operation finishes. This complicates the structure of asynchronous code as compared with synchronous code.\n\nYou can now call into asynchronous methods without using callbacks, and without splitting your code across multiple methods or lambda expressions.\n\nThe `async` modifier specifies that a method is asynchronous. When calling an `async` method, a task is returned. When the `await` operator is applied to a task, the current method exits immediately. When the task finishes, execution resumes in the same method.\n\n> [!WARNING]\n> Asynchronous calls are not supported if an application also uses the `Context Connection` connection string keyword.\n\nCalling an `async` method does not allocate any additional threads. It may use the existing I/O completion thread briefly at the end.\n\nThe following methods were added in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)] to support asynchronous programming:\n\n- <xref:System.Data.Common.DbConnection.OpenAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.Common.DbCommand.ExecuteDbDataReaderAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.Common.DbCommand.ExecuteNonQueryAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.Common.DbCommand.ExecuteReaderAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.Common.DbCommand.ExecuteScalarAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.Common.DbDataReader.GetFieldValueAsync%2A>\n\n- <xref:System.Data.Common.DbDataReader.IsDBNullAsync%2A>\n\n- <xref:System.Data.Common.DbDataReader.NextResultAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.Common.DbDataReader.ReadAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlConnection.OpenAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlCommand.ExecuteNonQueryAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlCommand.ExecuteReaderAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlCommand.ExecuteScalarAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlCommand.ExecuteXmlReaderAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlDataReader.NextResultAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlDataReader.ReadAsync%2A?displayProperty=nameWithType>\n\n- <xref:System.Data.SqlClient.SqlBulkCopy.WriteToServerAsync%2A?displayProperty=nameWithType>\n\n Other asynchronous members were added to support [SqlClient Streaming Support](../../../../docs/framework/data/adonet/sqlclient-streaming-support.md).\n\n> [!TIP]\n> The new asynchronous methods don't require `Asynchronous Processing=true` in the connection string.\n\n### Synchronous to Asynchronous Connection Open\n\nYou can upgrade an existing application to use the new asynchronous feature. For example, assume an application has a synchronous connection algorithm and blocks the UI thread every time it connects to the database and, once connected, the application calls a stored procedure that signals other users of the one who just signed in.\n\n```csharp\nusing SqlConnection conn = new SqlConnection(\"…\");\n{\n   conn.Open();\n   using (SqlCommand cmd = new SqlCommand(\"StoredProcedure_Logon\", conn))\n   {\n      cmd.ExecuteNonQuery();\n   }\n}\n```\n\nWhen converted to use the new asynchronous functionality, the program would look like:\n\n```csharp\nusing System;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\n\nclass A {\n\n   static async Task<int> Method(SqlConnection conn, SqlCommand cmd) {\n      await conn.OpenAsync();\n      await cmd.ExecuteNonQueryAsync();\n      return 1;\n   }\n\n   public static void Main() {\n      using (SqlConnection conn = new SqlConnection(\"Data Source=(local); Initial Catalog=NorthWind; Integrated Security=SSPI\")) {\n         SqlCommand command = new SqlCommand(\"select top 2 * from orders\", conn);\n\n         int result = A.Method(conn, command).Result;\n\n         SqlDataReader reader = command.ExecuteReader();\n         while (reader.Read())\n            Console.WriteLine(reader[0]);\n      }\n   }\n}\n```\n\n### Adding the New Asynchronous Feature in an Existing Application (Mixing Old and New Patterns)\n\nIt is also possible to add new asynchronous capability (SqlConnection::OpenAsync) without changing the existing asynchronous logic. For example, if an application currently uses:\n\n```csharp\nAsyncCallback productList = new AsyncCallback(ProductList);\nSqlConnection conn = new SqlConnection(\"…\");\nconn.Open();\nSqlCommand cmd = new SqlCommand(\"SELECT * FROM [Current Product List]\", conn);\nIAsyncResult ia = cmd.BeginExecuteReader(productList, cmd);\n```\n\nYou can begin to use the new asynchronous pattern without substantially changing the existing algorithm.\n\n```csharp\nusing System;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\n\nclass A {\n   static void ProductList(IAsyncResult result) { }\n\n   public static void Main() {\n      // AsyncCallback productList = new AsyncCallback(ProductList);\n      // SqlConnection conn = new SqlConnection(\"Data Source=(local); Initial Catalog=NorthWind; Integrated Security=SSPI\");\n      // conn.Open();\n      // SqlCommand cmd = new SqlCommand(\"select top 2 * from orders\", conn);\n      // IAsyncResult ia = cmd.BeginExecuteReader(productList, cmd);\n\n      AsyncCallback productList = new AsyncCallback(ProductList);\n      SqlConnection conn = new SqlConnection(\"Data Source=(local); Initial Catalog=NorthWind; Integrated Security=SSPI\");\n      conn.OpenAsync().ContinueWith((task) => {\n         SqlCommand cmd = new SqlCommand(\"select top 2 * from orders\", conn);\n         IAsyncResult ia = cmd.BeginExecuteReader(productList, cmd);\n      }, TaskContinuationOptions.OnlyOnRanToCompletion);\n   }\n}\n```\n\n### Using the Base Provider Model and the New Asynchronous Feature\n\nYou may need to create a tool that is able to connect to different databases and execute queries. You can use the base provider model and the new asynchronous feature.\n\nThe Microsoft Distributed Transaction Controller (MSDTC) must be enabled on the server to use distributed transactions. For information on how to enable MSDTC, see [How to Enable MSDTC on a Web Server](https://docs.microsoft.com/previous-versions/commerce-server/dd327979(v=cs.90)).\n\n```csharp\nusing System;\nusing System.Data.Common;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\n\nclass A {\n   static async Task PerformDBOperationsUsingProviderModel(string connectionString, string providerName) {\n      DbProviderFactory factory = DbProviderFactories.GetFactory(providerName);\n      using (DbConnection connection = factory.CreateConnection()) {\n         connection.ConnectionString = connectionString;\n         await connection.OpenAsync();\n\n         DbCommand command = connection.CreateCommand();\n         command.CommandText = \"SELECT * FROM AUTHORS\";\n\n         using (DbDataReader reader = await command.ExecuteReaderAsync()) {\n            while (await reader.ReadAsync()) {\n               for (int i = 0; i < reader.FieldCount; i++) {\n                  // Process each column as appropriate\n                  object obj = await reader.GetFieldValueAsync<object>(i);\n                  Console.WriteLine(obj);\n               }\n            }\n         }\n      }\n   }\n\n   public static void Main()\n   {\n       SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder();\n       // replace these with your own values\n       builder.DataSource = \"your_server\";\n       builder.InitialCatalog = \"pubs\";\n       builder.IntegratedSecurity = true;\n       string provider = \"System.Data.SqlClient\";\n\n       Task task = PerformDBOperationsUsingProviderModel(builder.ConnectionString, provider);\n       task.Wait();\n   }\n}\n```\n\n### Using SQL Transactions and the New Asynchronous Feature\n\n```csharp\nusing System;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\n\nclass Program {\n   static void Main() {\n      string connectionString =\n          \"Persist Security Info=False;Integrated Security=SSPI;database=Northwind;server=(local)\";\n      Task task = ExecuteSqlTransaction(connectionString);\n      task.Wait();\n   }\n\n   static async Task ExecuteSqlTransaction(string connectionString) {\n      using (SqlConnection connection = new SqlConnection(connectionString)) {\n         await connection.OpenAsync();\n\n         SqlCommand command = connection.CreateCommand();\n         SqlTransaction transaction = null;\n\n         // Start a local transaction.\n         transaction = await Task.Run<SqlTransaction>(\n             () => connection.BeginTransaction(\"SampleTransaction\")\n             );\n\n         // Must assign both transaction object and connection\n         // to Command object for a pending local transaction\n         command.Connection = connection;\n         command.Transaction = transaction;\n\n         try {\n            command.CommandText =\n                \"Insert into Region (RegionID, RegionDescription) VALUES (555, 'Description')\";\n            await command.ExecuteNonQueryAsync();\n\n            command.CommandText =\n                \"Insert into Region (RegionID, RegionDescription) VALUES (556, 'Description')\";\n            await command.ExecuteNonQueryAsync();\n\n            // Attempt to commit the transaction.\n            await Task.Run(() => transaction.Commit());\n            Console.WriteLine(\"Both records are written to database.\");\n         }\n         catch (Exception ex) {\n            Console.WriteLine(\"Commit Exception Type: {0}\", ex.GetType());\n            Console.WriteLine(\"  Message: {0}\", ex.Message);\n\n            // Attempt to roll back the transaction.\n            try {\n               transaction.Rollback();\n            }\n            catch (Exception ex2) {\n               // This catch block will handle any errors that may have occurred\n               // on the server that would cause the rollback to fail, such as\n               // a closed connection.\n               Console.WriteLine(\"Rollback Exception Type: {0}\", ex2.GetType());\n               Console.WriteLine(\"  Message: {0}\", ex2.Message);\n            }\n         }\n      }\n   }\n}\n```\n\n### Using SQL Transactions and the New Asynchronous Feature\n\nIn an enterprise application, you may need to add distributed transactions in some scenarios, to enable transactions between multiple database servers. You can use the System.Transactions namespace and enlist a distributed transaction, as follows:\n\n```csharp\nusing System;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\nusing System.Transactions;\n\nclass Program {\n   public static void Main()\n   {\n       SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder();\n       // replace these with your own values\n       builder.DataSource = \"your_server\";\n       builder.InitialCatalog = \"your_data_source\";\n       builder.IntegratedSecurity = true;\n\n       Task task = ExecuteDistributedTransaction(builder.ConnectionString, builder.ConnectionString);\n       task.Wait();\n   }\n\n   static async Task ExecuteDistributedTransaction(string connectionString1, string connectionString2) {\n      using (SqlConnection connection1 = new SqlConnection(connectionString1))\n      using (SqlConnection connection2 = new SqlConnection(connectionString2)) {\n         using (CommittableTransaction transaction = new CommittableTransaction()) {\n            await connection1.OpenAsync();\n            connection1.EnlistTransaction(transaction);\n\n            await connection2.OpenAsync();\n            connection2.EnlistTransaction(transaction);\n\n            try {\n               SqlCommand command1 = connection1.CreateCommand();\n               command1.CommandText = \"Insert into RegionTable1 (RegionID, RegionDescription) VALUES (100, 'Description')\";\n               await command1.ExecuteNonQueryAsync();\n\n               SqlCommand command2 = connection2.CreateCommand();\n               command2.CommandText = \"Insert into RegionTable2 (RegionID, RegionDescription) VALUES (100, 'Description')\";\n               await command2.ExecuteNonQueryAsync();\n\n               transaction.Commit();\n            }\n            catch (Exception ex) {\n               Console.WriteLine(\"Exception Type: {0}\", ex.GetType());\n               Console.WriteLine(\"  Message: {0}\", ex.Message);\n\n               try {\n                  transaction.Rollback();\n               }\n               catch (Exception ex2) {\n                  Console.WriteLine(\"Rollback Exception Type: {0}\", ex2.GetType());\n                  Console.WriteLine(\"  Message: {0}\", ex2.Message);\n               }\n            }\n         }\n      }\n   }\n}\n```\n\n### Cancelling an Asynchronous Operation\n\nYou can cancel an asynchronous request by using the <xref:System.Threading.CancellationToken>.\n\n```csharp\nusing System;\nusing System.Data.SqlClient;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace Samples {\n   class CancellationSample {\n      public static void Main(string[] args) {\n         CancellationTokenSource source = new CancellationTokenSource();\n         source.CancelAfter(2000); // give up after 2 seconds\n         try {\n            Task result = CancellingAsynchronousOperations(source.Token);\n            result.Wait();\n         }\n         catch (AggregateException exception) {\n            if (exception.InnerException is SqlException) {\n               Console.WriteLine(\"Operation canceled\");\n            }\n            else {\n               throw;\n            }\n         }\n      }\n\n      static async Task CancellingAsynchronousOperations(CancellationToken cancellationToken) {\n         using (SqlConnection connection = new SqlConnection(\"Server=(local);Integrated Security=true\")) {\n            await connection.OpenAsync(cancellationToken);\n\n            SqlCommand command = new SqlCommand(\"WAITFOR DELAY '00:10:00'\", connection);\n            await command.ExecuteNonQueryAsync(cancellationToken);\n         }\n      }\n   }\n}\n```\n\n### Asynchronous Operations with SqlBulkCopy\n\nAsynchronous capabilities were also added to <xref:System.Data.SqlClient.SqlBulkCopy?displayProperty=nameWithType> with <xref:System.Data.SqlClient.SqlBulkCopy.WriteToServerAsync%2A?displayProperty=nameWithType>.\n\n```csharp\nusing System;\nusing System.Collections.Generic;\nusing System.Data;\nusing System.Data.Odbc;\nusing System.Data.SqlClient;\nusing System.Linq;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace SqlBulkCopyAsyncCodeSample {\n   class Program {\n      static string selectStatement = \"SELECT * FROM [pubs].[dbo].[titles]\";\n      static string createDestTableStatement =\n          @\"CREATE TABLE {0} (\n            [title_id] [varchar](6) NOT NULL,\n            [title] [varchar](80) NOT NULL,\n            [type] [char](12) NOT NULL,\n            [pub_id] [char](4) NULL,\n            [price] [money] NULL,\n            [advance] [money] NULL,\n            [royalty] [int] NULL,\n            [ytd_sales] [int] NULL,\n            [notes] [varchar](200) NULL,\n            [pubdate] [datetime] NOT NULL)\";\n\n      // Replace the connection string if needed, for instance to connect to SQL Express: @\"Server=(local)\\SQLEXPRESS;Database=Demo;Integrated Security=true\"\n      // static string connectionString = @\"Server=(localdb)\\V11.0;Database=Demo\";\n      static string connectionString = @\"Server=(local);Database=Demo;Integrated Security=true\";\n\n      // static string odbcConnectionString = @\"Driver={SQL Server};Server=(localdb)\\V11.0;UID=oledb;Pwd=1Password!;Database=Demo\";\n      static string odbcConnectionString = @\"Driver={SQL Server};Server=(local);Database=Demo;Integrated Security=true\";\n\n      // static string marsConnectionString = @\"Server=(localdb)\\V11.0;Database=Demo;MultipleActiveResultSets=true;\";\n      static string marsConnectionString = @\"Server=(local);Database=Demo;MultipleActiveResultSets=true;Integrated Security=true\";\n\n      // Replace the Server name with your actual sql azure server name and User ID/Password\n      static string azureConnectionString = @\"Server=SqlAzure;User ID=myUserID;Password=myPassword;Database=Demo\";\n\n      static void Main(string[] args) {\n         SynchronousSqlBulkCopy();\n         AsyncSqlBulkCopy().Wait();\n         MixSyncAsyncSqlBulkCopy().Wait();\n         AsyncSqlBulkCopyNotifyAfter().Wait();\n         AsyncSqlBulkCopyDataRows().Wait();\n         // AsyncSqlBulkCopySqlServerToSqlAzure().Wait();\n         // AsyncSqlBulkCopyCancel().Wait();\n         AsyncSqlBulkCopyMARS().Wait();\n      }\n\n      // 3.1.1 Synchronous bulk copy in .NET 4.5\n      private static void SynchronousSqlBulkCopy() {\n         using (SqlConnection conn = new SqlConnection(connectionString)) {\n            conn.Open();\n            DataTable dt = new DataTable();\n            using (SqlCommand cmd = new SqlCommand(selectStatement, conn)) {\n               SqlDataAdapter adapter = new SqlDataAdapter(cmd);\n               adapter.Fill(dt);\n\n               string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n               cmd.CommandText = string.Format(createDestTableStatement, temptable);\n               cmd.ExecuteNonQuery();\n\n               using (SqlBulkCopy bcp = new SqlBulkCopy(conn)) {\n                  bcp.DestinationTableName = temptable;\n                  bcp.WriteToServer(dt);\n               }\n            }\n         }\n\n      }\n\n      // 3.1.2 Asynchronous bulk copy in .NET 4.5\n      private static async Task AsyncSqlBulkCopy() {\n         using (SqlConnection conn = new SqlConnection(connectionString)) {\n            await conn.OpenAsync();\n            DataTable dt = new DataTable();\n            using (SqlCommand cmd = new SqlCommand(selectStatement, conn)) {\n               SqlDataAdapter adapter = new SqlDataAdapter(cmd);\n               adapter.Fill(dt);\n\n               string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n               cmd.CommandText = string.Format(createDestTableStatement, temptable);\n               await cmd.ExecuteNonQueryAsync();\n\n               using (SqlBulkCopy bcp = new SqlBulkCopy(conn)) {\n                  bcp.DestinationTableName = temptable;\n                  await bcp.WriteToServerAsync(dt);\n               }\n            }\n         }\n      }\n\n      // 3.2 Add new Async.NET capabilities in an existing application (Mixing synchronous and asynchornous calls)\n      private static async Task MixSyncAsyncSqlBulkCopy() {\n         using (OdbcConnection odbcconn = new OdbcConnection(odbcConnectionString)) {\n            odbcconn.Open();\n            using (OdbcCommand odbccmd = new OdbcCommand(selectStatement, odbcconn)) {\n               using (OdbcDataReader odbcreader = odbccmd.ExecuteReader()) {\n                  using (SqlConnection conn = new SqlConnection(connectionString)) {\n                     await conn.OpenAsync();\n                     string temptable = \"temptable\";//\"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n                     SqlCommand createCmd = new SqlCommand(string.Format(createDestTableStatement, temptable), conn);\n                     await createCmd.ExecuteNonQueryAsync();\n                     using (SqlBulkCopy bcp = new SqlBulkCopy(conn)) {\n                        bcp.DestinationTableName = temptable;\n                        await bcp.WriteToServerAsync(odbcreader);\n                     }\n                  }\n               }\n            }\n         }\n      }\n\n      // 3.3 Using the NotifyAfter property\n      private static async Task AsyncSqlBulkCopyNotifyAfter() {\n         using (SqlConnection conn = new SqlConnection(connectionString)) {\n            await conn.OpenAsync();\n            DataTable dt = new DataTable();\n            using (SqlCommand cmd = new SqlCommand(selectStatement, conn)) {\n               SqlDataAdapter adapter = new SqlDataAdapter(cmd);\n               adapter.Fill(dt);\n\n               string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n               cmd.CommandText = string.Format(createDestTableStatement, temptable);\n               await cmd.ExecuteNonQueryAsync();\n\n               using (SqlBulkCopy bcp = new SqlBulkCopy(conn)) {\n                  bcp.DestinationTableName = temptable;\n                  bcp.NotifyAfter = 5;\n                  bcp.SqlRowsCopied += new SqlRowsCopiedEventHandler(OnSqlRowsCopied);\n                  await bcp.WriteToServerAsync(dt);\n               }\n            }\n         }\n      }\n\n      private static void OnSqlRowsCopied(object sender, SqlRowsCopiedEventArgs e) {\n         Console.WriteLine(\"Copied {0} so far...\", e.RowsCopied);\n      }\n\n      // 3.4 Using the new SqlBulkCopy Async.NET capabilities with DataRow[]\n      private static async Task AsyncSqlBulkCopyDataRows() {\n         using (SqlConnection conn = new SqlConnection(connectionString)) {\n            await conn.OpenAsync();\n            DataTable dt = new DataTable();\n            using (SqlCommand cmd = new SqlCommand(selectStatement, conn)) {\n               SqlDataAdapter adapter = new SqlDataAdapter(cmd);\n               adapter.Fill(dt);\n               DataRow[] rows = dt.Select();\n\n               string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n               cmd.CommandText = string.Format(createDestTableStatement, temptable);\n               await cmd.ExecuteNonQueryAsync();\n\n               using (SqlBulkCopy bcp = new SqlBulkCopy(conn)) {\n                  bcp.DestinationTableName = temptable;\n                  await bcp.WriteToServerAsync(rows);\n               }\n            }\n         }\n      }\n\n      // 3.5 Copying data from SQL Server to SQL Azure in .NET 4.5\n      //private static async Task AsyncSqlBulkCopySqlServerToSqlAzure() {\n      //   using (SqlConnection srcConn = new SqlConnection(connectionString))\n      //   using (SqlConnection destConn = new SqlConnection(azureConnectionString)) {\n      //      await srcConn.OpenAsync();\n      //      await destConn.OpenAsync();\n      //      using (SqlCommand srcCmd = new SqlCommand(selectStatement, srcConn)) {\n      //         using (SqlDataReader reader = await srcCmd.ExecuteReaderAsync()) {\n      //            string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n      //            using (SqlCommand destCmd = new SqlCommand(string.Format(createDestTableStatement, temptable), destConn)) {\n      //               await destCmd.ExecuteNonQueryAsync();\n      //               using (SqlBulkCopy bcp = new SqlBulkCopy(destConn)) {\n      //                  bcp.DestinationTableName = temptable;\n      //                  await bcp.WriteToServerAsync(reader);\n      //               }\n      //            }\n      //         }\n      //      }\n      //   }\n      //}\n\n      // 3.6 Cancelling an Asynchronous Operation to SQL Azure\n      //private static async Task AsyncSqlBulkCopyCancel() {\n      //   CancellationTokenSource cts = new CancellationTokenSource();\n      //   using (SqlConnection srcConn = new SqlConnection(connectionString))\n      //   using (SqlConnection destConn = new SqlConnection(azureConnectionString)) {\n      //      await srcConn.OpenAsync(cts.Token);\n      //      await destConn.OpenAsync(cts.Token);\n      //      using (SqlCommand srcCmd = new SqlCommand(selectStatement, srcConn)) {\n      //         using (SqlDataReader reader = await srcCmd.ExecuteReaderAsync(cts.Token)) {\n      //            string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n      //            using (SqlCommand destCmd = new SqlCommand(string.Format(createDestTableStatement, temptable), destConn)) {\n      //               await destCmd.ExecuteNonQueryAsync(cts.Token);\n      //               using (SqlBulkCopy bcp = new SqlBulkCopy(destConn)) {\n      //                  bcp.DestinationTableName = temptable;\n      //                  await bcp.WriteToServerAsync(reader, cts.Token);\n      //                  //Cancel Async SqlBulCopy Operation after 200 ms\n      //                  cts.CancelAfter(200);\n      //               }\n      //            }\n      //         }\n      //      }\n      //   }\n      //}\n\n      // 3.7 Using Async.Net and MARS\n      private static async Task AsyncSqlBulkCopyMARS() {\n         using (SqlConnection marsConn = new SqlConnection(marsConnectionString)) {\n            await marsConn.OpenAsync();\n\n            SqlCommand titlesCmd = new SqlCommand(\"SELECT * FROM [pubs].[dbo].[titles]\", marsConn);\n            SqlCommand authorsCmd = new SqlCommand(\"SELECT * FROM [pubs].[dbo].[authors]\", marsConn);\n            //With MARS we can have multiple active results sets on the same connection\n            using (SqlDataReader titlesReader = await titlesCmd.ExecuteReaderAsync())\n            using (SqlDataReader authorsReader = await authorsCmd.ExecuteReaderAsync()) {\n               await authorsReader.ReadAsync();\n\n               string temptable = \"[#\" + Guid.NewGuid().ToString(\"N\") + \"]\";\n               using (SqlConnection destConn = new SqlConnection(connectionString)) {\n                  await destConn.OpenAsync();\n                  using (SqlCommand destCmd = new SqlCommand(string.Format(createDestTableStatement, temptable), destConn)) {\n                     await destCmd.ExecuteNonQueryAsync();\n                     using (SqlBulkCopy bcp = new SqlBulkCopy(destConn)) {\n                        bcp.DestinationTableName = temptable;\n                        await bcp.WriteToServerAsync(titlesReader);\n                     }\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n```\n\n## Asynchronously Using Multiple Commands with MARS\n\nThe example opens a single connection to the **AdventureWorks** database. Using a <xref:System.Data.SqlClient.SqlCommand> object, a <xref:System.Data.SqlClient.SqlDataReader> is created. As the reader is used, a second <xref:System.Data.SqlClient.SqlDataReader> is opened, using data from the first <xref:System.Data.SqlClient.SqlDataReader> as input to the WHERE clause for the second reader.\n\n> [!NOTE]\n> The following example uses the sample **AdventureWorks** database included with SQL Server. The connection string provided in the sample code assumes that the database is installed and available on the local computer. Modify the connection string as necessary for your environment.\n\n```csharp\nusing System;\nusing System.Data;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\n\nclass Class1 {\n   static void Main() {\n      Task task = MultipleCommands();\n      task.Wait();\n   }\n\n   static async Task MultipleCommands() {\n      // By default, MARS is disabled when connecting to a MARS-enabled.\n      // It must be enabled in the connection string.\n      string connectionString = GetConnectionString();\n\n      int vendorID;\n      SqlDataReader productReader = null;\n      string vendorSQL =\n        \"SELECT VendorId, Name FROM Purchasing.Vendor\";\n      string productSQL =\n        \"SELECT Production.Product.Name FROM Production.Product \" +\n        \"INNER JOIN Purchasing.ProductVendor \" +\n        \"ON Production.Product.ProductID = \" +\n        \"Purchasing.ProductVendor.ProductID \" +\n        \"WHERE Purchasing.ProductVendor.VendorID = @VendorId\";\n\n      using (SqlConnection awConnection =\n        new SqlConnection(connectionString)) {\n         SqlCommand vendorCmd = new SqlCommand(vendorSQL, awConnection);\n         SqlCommand productCmd =\n           new SqlCommand(productSQL, awConnection);\n\n         productCmd.Parameters.Add(\"@VendorId\", SqlDbType.Int);\n\n         await awConnection.OpenAsync();\n         using (SqlDataReader vendorReader = await vendorCmd.ExecuteReaderAsync()) {\n            while (await vendorReader.ReadAsync()) {\n               Console.WriteLine(vendorReader[\"Name\"]);\n\n               vendorID = (int)vendorReader[\"VendorId\"];\n\n               productCmd.Parameters[\"@VendorId\"].Value = vendorID;\n               // The following line of code requires a MARS-enabled connection.\n               productReader = await productCmd.ExecuteReaderAsync();\n               using (productReader) {\n                  while (await productReader.ReadAsync()) {\n                     Console.WriteLine(\"  \" +\n                       productReader[\"Name\"].ToString());\n                  }\n               }\n            }\n         }\n      }\n   }\n\n   private static string GetConnectionString() {\n      // To avoid storing the connection string in your code, you can retrive it from a configuration file.\n      return \"Data Source=(local);Integrated Security=SSPI;Initial Catalog=AdventureWorks;MultipleActiveResultSets=True\";\n   }\n}\n```\n\n## Asynchronously Reading and Updating Data with MARS\n\nMARS allows a connection to be used for both read operations and data manipulation language (DML) operations with more than one pending operation. This feature eliminates the need for an application to deal with connection-busy errors. In addition, MARS can replace the user of server-side cursors, which generally consume more resources. Finally, because multiple operations can operate on a single connection, they can share the same transaction context, eliminating the need to use **sp_getbindtoken** and **sp_bindsession** system stored procedures.\n\nThe following Console application demonstrates how to use two <xref:System.Data.SqlClient.SqlDataReader> objects with three <xref:System.Data.SqlClient.SqlCommand> objects and a single <xref:System.Data.SqlClient.SqlConnection> object with MARS enabled. The first command object retrieves a list of vendors whose credit rating is 5. The second command object uses the vendor ID provided from a <xref:System.Data.SqlClient.SqlDataReader> to load the second <xref:System.Data.SqlClient.SqlDataReader> with all of the products for the particular vendor. Each product record is visited by the second <xref:System.Data.SqlClient.SqlDataReader>. A calculation is performed to determine what the new **OnOrderQty** should be. The third command object is then used to update the **ProductVendor** table with the new value. This entire process takes place within a single transaction, which is rolled back at the end.\n\n> [!NOTE]\n> The following example uses the sample **AdventureWorks** database included with SQL Server. The connection string provided in the sample code assumes that the database is installed and available on the local computer. Modify the connection string as necessary for your environment.\n\n```csharp\nusing System;\nusing System.Collections.Generic;\nusing System.Text;\nusing System.Data;\nusing System.Data.SqlClient;\nusing System.Threading.Tasks;\n\nclass Program {\n   static void Main() {\n      Task task = ReadingAndUpdatingData();\n      task.Wait();\n   }\n\n   static async Task ReadingAndUpdatingData() {\n      // By default, MARS is disabled when connecting to a MARS-enabled host.\n      // It must be enabled in the connection string.\n      string connectionString = GetConnectionString();\n\n      SqlTransaction updateTx = null;\n      SqlCommand vendorCmd = null;\n      SqlCommand prodVendCmd = null;\n      SqlCommand updateCmd = null;\n\n      SqlDataReader prodVendReader = null;\n\n      int vendorID = 0;\n      int productID = 0;\n      int minOrderQty = 0;\n      int maxOrderQty = 0;\n      int onOrderQty = 0;\n      int recordsUpdated = 0;\n      int totalRecordsUpdated = 0;\n\n      string vendorSQL =\n          \"SELECT VendorID, Name FROM Purchasing.Vendor \" +\n          \"WHERE CreditRating = 5\";\n      string prodVendSQL =\n          \"SELECT ProductID, MaxOrderQty, MinOrderQty, OnOrderQty \" +\n          \"FROM Purchasing.ProductVendor \" +\n          \"WHERE VendorID = @VendorID\";\n      string updateSQL =\n          \"UPDATE Purchasing.ProductVendor \" +\n          \"SET OnOrderQty = @OrderQty \" +\n          \"WHERE ProductID = @ProductID AND VendorID = @VendorID\";\n\n      using (SqlConnection awConnection =\n        new SqlConnection(connectionString)) {\n         await awConnection.OpenAsync();\n         updateTx = await Task.Run(() => awConnection.BeginTransaction());\n\n         vendorCmd = new SqlCommand(vendorSQL, awConnection);\n         vendorCmd.Transaction = updateTx;\n\n         prodVendCmd = new SqlCommand(prodVendSQL, awConnection);\n         prodVendCmd.Transaction = updateTx;\n         prodVendCmd.Parameters.Add(\"@VendorId\", SqlDbType.Int);\n\n         updateCmd = new SqlCommand(updateSQL, awConnection);\n         updateCmd.Transaction = updateTx;\n         updateCmd.Parameters.Add(\"@OrderQty\", SqlDbType.Int);\n         updateCmd.Parameters.Add(\"@ProductID\", SqlDbType.Int);\n         updateCmd.Parameters.Add(\"@VendorID\", SqlDbType.Int);\n\n         using (SqlDataReader vendorReader = await vendorCmd.ExecuteReaderAsync()) {\n            while (await vendorReader.ReadAsync()) {\n               Console.WriteLine(vendorReader[\"Name\"]);\n\n               vendorID = (int)vendorReader[\"VendorID\"];\n               prodVendCmd.Parameters[\"@VendorID\"].Value = vendorID;\n               prodVendReader = await prodVendCmd.ExecuteReaderAsync();\n\n               using (prodVendReader) {\n                  while (await prodVendReader.ReadAsync()) {\n                     productID = (int)prodVendReader[\"ProductID\"];\n\n                     if (prodVendReader[\"OnOrderQty\"] == DBNull.Value) {\n                        minOrderQty = (int)prodVendReader[\"MinOrderQty\"];\n                        onOrderQty = minOrderQty;\n                     }\n                     else {\n                        maxOrderQty = (int)prodVendReader[\"MaxOrderQty\"];\n                        onOrderQty = (int)(maxOrderQty / 2);\n                     }\n\n                     updateCmd.Parameters[\"@OrderQty\"].Value = onOrderQty;\n                     updateCmd.Parameters[\"@ProductID\"].Value = productID;\n                     updateCmd.Parameters[\"@VendorID\"].Value = vendorID;\n\n                     recordsUpdated = await updateCmd.ExecuteNonQueryAsync();\n                     totalRecordsUpdated += recordsUpdated;\n                  }\n               }\n            }\n         }\n         Console.WriteLine(\"Total Records Updated: \", totalRecordsUpdated.ToString());\n         await Task.Run(() => updateTx.Rollback());\n         Console.WriteLine(\"Transaction Rolled Back\");\n      }\n   }\n\n   private static string GetConnectionString() {\n      // To avoid storing the connection string in your code, you can retrive it from a configuration file.\n      return \"Data Source=(local);Integrated Security=SSPI;Initial Catalog=AdventureWorks;MultipleActiveResultSets=True\";\n   }\n}\n```\n\n## See also\n\n- [Retrieving and Modifying Data in ADO.NET](../../../../docs/framework/data/adonet/retrieving-and-modifying-data.md)\n","nodes":[{"pos":[4,108],"embed":true,"restype":"x-metadata","content":"title: \"Asynchronous Programming\"\nms.date: \"10/18/2018\"\nms.assetid: 85da7447-7125-426e-aa5f-438a290d1f77","nodes":[{"content":"Asynchronous Programming","nodes":[{"pos":[0,24],"content":"Asynchronous Programming","nodes":[{"content":"Asynchronous Programming","pos":[0,24]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[116,140],"content":"Asynchronous Programming","linkify":"Asynchronous Programming","nodes":[{"content":"Asynchronous Programming","pos":[0,24]}]},{"pos":[142,469],"content":"This topic discusses support for asynchronous programming in the <ph id=\"ph1\">[!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)]</ph> Data Provider for SQL Server (SqlClient) including enhancements made to support asynchronous programming functionality that was introduced in <ph id=\"ph2\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph>.","source":"This topic discusses support for asynchronous programming in the [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] Data Provider for SQL Server (SqlClient) including enhancements made to support asynchronous programming functionality that was introduced in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]."},{"pos":[474,505],"content":"Legacy Asynchronous Programming","linkify":"Legacy Asynchronous Programming","nodes":[{"content":"Legacy Asynchronous Programming","pos":[0,31]}]},{"pos":[507,708],"content":"Prior to <ph id=\"ph1\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph>, asynchronous programming with SqlClient was done with the following methods and the <ph id=\"ph2\">`Asynchronous Processing=true`</ph> connection property:","source":"Prior to [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], asynchronous programming with SqlClient was done with the following methods and the `Asynchronous Processing=true` connection property:"},{"pos":[1000,1099],"content":"This functionality remains in SqlClient in <ph id=\"ph1\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph>.","source":"This functionality remains in SqlClient in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]."},{"pos":[1103,1281],"content":"[!TIP]\nBeginning in the [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], these legacy methods no longer require `Asynchronous Processing=true` in the connection string.","leadings":["","> "],"nodes":[{"content":"Beginning in the <ph id=\"ph1\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph>, these legacy methods no longer require <ph id=\"ph2\">`Asynchronous Processing=true`</ph> in the connection string.","pos":[7,176],"source":"Beginning in the [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], these legacy methods no longer require `Asynchronous Processing=true` in the connection string."}]},{"pos":[1286,1384],"content":"Asynchronous Programming Features Added in <ph id=\"ph1\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph>","linkify":"Asynchronous Programming Features Added in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]","source":"Asynchronous Programming Features Added in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]"},{"content":"The new asynchronous programming feature provides a simple technique to make code asynchronous.","pos":[1386,1481]},{"pos":[1483,1631],"content":"For more information about the asynchronous programming feature that was introduced in <ph id=\"ph1\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph>, see:","source":"For more information about the asynchronous programming feature that was introduced in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)], see:"},{"pos":[1635,1693],"content":"<bpt id=\"p1\">[</bpt>Asynchronous programming in C#<ept id=\"p1\">](../../../csharp/async.md)</ept>","source":"[Asynchronous programming in C#](../../../csharp/async.md)"},{"pos":[1697,1824],"content":"<bpt id=\"p1\">[</bpt>Asynchronous Programming with Async and Await (Visual Basic)<ept id=\"p1\">](../../../visual-basic/programming-guide/concepts/async/index.md)</ept>","source":"[Asynchronous Programming with Async and Await (Visual Basic)](../../../visual-basic/programming-guide/concepts/async/index.md)"},{"pos":[1828,1993],"content":"<bpt id=\"p1\">[</bpt>Using SqlDataReader’s new async methods in .NET 4.5 (Part 1)<ept id=\"p1\">](https://blogs.msdn.microsoft.com/adonet/2012/04/20/using-sqldatareaders-new-async-methods-in-net-4-5/)</ept>","source":"[Using SqlDataReader’s new async methods in .NET 4.5 (Part 1)](https://blogs.msdn.microsoft.com/adonet/2012/04/20/using-sqldatareaders-new-async-methods-in-net-4-5/)"},{"pos":[1997,2178],"content":"<bpt id=\"p1\">[</bpt>Using SqlDataReader’s new async methods in .NET 4.5 (Part 2)<ept id=\"p1\">](https://blogs.msdn.microsoft.com/adonet/2012/07/15/using-sqldatareaders-new-async-methods-in-net-4-5-part-2-examples/)</ept>","source":"[Using SqlDataReader’s new async methods in .NET 4.5 (Part 2)](https://blogs.msdn.microsoft.com/adonet/2012/07/15/using-sqldatareaders-new-async-methods-in-net-4-5-part-2-examples/)"},{"content":"When your user interface is unresponsive or your server does not scale, it is likely that you need your code to be more asynchronous.","pos":[2180,2313]},{"content":"Writing asynchronous code has traditionally involved installing a callback (also called continuation) to express the logic that occurs after the asynchronous operation finishes.","pos":[2314,2491]},{"content":"This complicates the structure of asynchronous code as compared with synchronous code.","pos":[2492,2578]},{"content":"You can now call into asynchronous methods without using callbacks, and without splitting your code across multiple methods or lambda expressions.","pos":[2580,2726]},{"content":"The <ph id=\"ph1\">`async`</ph> modifier specifies that a method is asynchronous.","pos":[2728,2789],"source":"The `async` modifier specifies that a method is asynchronous."},{"content":"When calling an <ph id=\"ph1\">`async`</ph> method, a task is returned.","pos":[2790,2841],"source":" When calling an `async` method, a task is returned."},{"content":"When the <ph id=\"ph1\">`await`</ph> operator is applied to a task, the current method exits immediately.","pos":[2842,2927],"source":" When the `await` operator is applied to a task, the current method exits immediately."},{"content":"When the task finishes, execution resumes in the same method.","pos":[2928,2989]},{"pos":[2993,3122],"content":"[!WARNING]\nAsynchronous calls are not supported if an application also uses the `Context Connection` connection string keyword.","leadings":["","> "],"nodes":[{"content":"Asynchronous calls are not supported if an application also uses the <ph id=\"ph1\">`Context Connection`</ph> connection string keyword.","pos":[11,127],"source":"Asynchronous calls are not supported if an application also uses the `Context Connection` connection string keyword."}]},{"content":"Calling an <ph id=\"ph1\">`async`</ph> method does not allocate any additional threads.","pos":[3124,3191],"source":"Calling an `async` method does not allocate any additional threads."},{"content":"It may use the existing I/O completion thread briefly at the end.","pos":[3192,3257]},{"pos":[3259,3387],"content":"The following methods were added in <ph id=\"ph1\">[!INCLUDE[net_v45](../../../../includes/net-v45-md.md)]</ph> to support asynchronous programming:","source":"The following methods were added in [!INCLUDE[net_v45](../../../../includes/net-v45-md.md)] to support asynchronous programming:"},{"pos":[4885,5035],"content":"Other asynchronous members were added to support <bpt id=\"p1\">[</bpt>SqlClient Streaming Support<ept id=\"p1\">](../../../../docs/framework/data/adonet/sqlclient-streaming-support.md)</ept>.","source":"Other asynchronous members were added to support [SqlClient Streaming Support](../../../../docs/framework/data/adonet/sqlclient-streaming-support.md)."},{"pos":[5039,5147],"content":"[!TIP]\nThe new asynchronous methods don't require `Asynchronous Processing=true` in the connection string.","leadings":["","> "],"nodes":[{"content":"The new asynchronous methods don't require <ph id=\"ph1\">`Asynchronous Processing=true`</ph> in the connection string.","pos":[7,106],"source":"The new asynchronous methods don't require `Asynchronous Processing=true` in the connection string."}]},{"pos":[5153,5196],"content":"Synchronous to Asynchronous Connection Open","linkify":"Synchronous to Asynchronous Connection Open","nodes":[{"content":"Synchronous to Asynchronous Connection Open","pos":[0,43]}]},{"content":"You can upgrade an existing application to use the new asynchronous feature.","pos":[5198,5274]},{"content":"For example, assume an application has a synchronous connection algorithm and blocks the UI thread every time it connects to the database and, once connected, the application calls a stored procedure that signals other users of the one who just signed in.","pos":[5275,5530]},{"content":"When converted to use the new asynchronous functionality, the program would look like:","pos":[5731,5817]},{"pos":[6531,6623],"content":"Adding the New Asynchronous Feature in an Existing Application (Mixing Old and New Patterns)","linkify":"Adding the New Asynchronous Feature in an Existing Application (Mixing Old and New Patterns)","nodes":[{"content":"Adding the New Asynchronous Feature in an Existing Application (Mixing Old and New Patterns)","pos":[0,92]}]},{"content":"It is also possible to add new asynchronous capability (SqlConnection::OpenAsync) without changing the existing asynchronous logic.","pos":[6625,6756]},{"content":"For example, if an application currently uses:","pos":[6757,6803]},{"content":"You can begin to use the new asynchronous pattern without substantially changing the existing algorithm.","pos":[7077,7181]},{"pos":[8181,8243],"content":"Using the Base Provider Model and the New Asynchronous Feature","linkify":"Using the Base Provider Model and the New Asynchronous Feature","nodes":[{"content":"Using the Base Provider Model and the New Asynchronous Feature","pos":[0,62]}]},{"content":"You may need to create a tool that is able to connect to different databases and execute queries.","pos":[8245,8342]},{"content":"You can use the base provider model and the new asynchronous feature.","pos":[8343,8412]},{"content":"The Microsoft Distributed Transaction Controller (MSDTC) must be enabled on the server to use distributed transactions.","pos":[8414,8533]},{"content":"For information on how to enable MSDTC, see <bpt id=\"p1\">[</bpt>How to Enable MSDTC on a Web Server<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/commerce-server/dd327979(v=cs.90))</ept>.","pos":[8534,8696],"source":" For information on how to enable MSDTC, see [How to Enable MSDTC on a Web Server](https://docs.microsoft.com/previous-versions/commerce-server/dd327979(v=cs.90))."},{"pos":[10161,10216],"content":"Using SQL Transactions and the New Asynchronous Feature","linkify":"Using SQL Transactions and the New Asynchronous Feature","nodes":[{"content":"Using SQL Transactions and the New Asynchronous Feature","pos":[0,55]}]},{"pos":[12530,12585],"content":"Using SQL Transactions and the New Asynchronous Feature","linkify":"Using SQL Transactions and the New Asynchronous Feature","nodes":[{"content":"Using SQL Transactions and the New Asynchronous Feature","pos":[0,55]}]},{"content":"In an enterprise application, you may need to add distributed transactions in some scenarios, to enable transactions between multiple database servers.","pos":[12587,12738]},{"content":"You can use the System.Transactions namespace and enlist a distributed transaction, as follows:","pos":[12739,12834]},{"pos":[15003,15039],"content":"Cancelling an Asynchronous Operation","linkify":"Cancelling an Asynchronous Operation","nodes":[{"content":"Cancelling an Asynchronous Operation","pos":[0,36]}]},{"pos":[15041,15135],"content":"You can cancel an asynchronous request by using the <ph id=\"ph1\">&lt;xref:System.Threading.CancellationToken&gt;</ph>.","source":"You can cancel an asynchronous request by using the <xref:System.Threading.CancellationToken>."},{"pos":[16311,16351],"content":"Asynchronous Operations with SqlBulkCopy","linkify":"Asynchronous Operations with SqlBulkCopy","nodes":[{"content":"Asynchronous Operations with SqlBulkCopy","pos":[0,40]}]},{"pos":[16353,16565],"content":"Asynchronous capabilities were also added to <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlBulkCopy?displayProperty=nameWithType&gt;</ph> with <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlBulkCopy.WriteToServerAsync%2A?displayProperty=nameWithType&gt;</ph>.","source":"Asynchronous capabilities were also added to <xref:System.Data.SqlClient.SqlBulkCopy?displayProperty=nameWithType> with <xref:System.Data.SqlClient.SqlBulkCopy.WriteToServerAsync%2A?displayProperty=nameWithType>."},{"pos":[27772,27820],"content":"Asynchronously Using Multiple Commands with MARS","linkify":"Asynchronously Using Multiple Commands with MARS","nodes":[{"content":"Asynchronously Using Multiple Commands with MARS","pos":[0,48]}]},{"content":"The example opens a single connection to the <bpt id=\"p1\">**</bpt>AdventureWorks<ept id=\"p1\">**</ept> database.","pos":[27822,27895],"source":"The example opens a single connection to the **AdventureWorks** database."},{"content":"Using a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlCommand&gt;</ph> object, a <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph> is created.","pos":[27896,28008],"source":" Using a <xref:System.Data.SqlClient.SqlCommand> object, a <xref:System.Data.SqlClient.SqlDataReader> is created."},{"content":"As the reader is used, a second <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph> is opened, using data from the first <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph> as input to the WHERE clause for the second reader.","pos":[28009,28215],"source":" As the reader is used, a second <xref:System.Data.SqlClient.SqlDataReader> is opened, using data from the first <xref:System.Data.SqlClient.SqlDataReader> as input to the WHERE clause for the second reader."},{"pos":[28219,28510],"content":"[!NOTE]\nThe following example uses the sample **AdventureWorks** database included with SQL Server. The connection string provided in the sample code assumes that the database is installed and available on the local computer. Modify the connection string as necessary for your environment.","leadings":["","> "],"nodes":[{"content":"The following example uses the sample **AdventureWorks** database included with SQL Server. The connection string provided in the sample code assumes that the database is installed and available on the local computer. Modify the connection string as necessary for your environment.","pos":[8,289],"nodes":[{"content":"The following example uses the sample <bpt id=\"p1\">**</bpt>AdventureWorks<ept id=\"p1\">**</ept> database included with SQL Server.","pos":[0,91],"source":"The following example uses the sample **AdventureWorks** database included with SQL Server."},{"content":"The connection string provided in the sample code assumes that the database is installed and available on the local computer.","pos":[92,217]},{"content":"Modify the connection string as necessary for your environment.","pos":[218,281]}]}]},{"pos":[30787,30837],"content":"Asynchronously Reading and Updating Data with MARS","linkify":"Asynchronously Reading and Updating Data with MARS","nodes":[{"content":"Asynchronously Reading and Updating Data with MARS","pos":[0,50]}]},{"content":"MARS allows a connection to be used for both read operations and data manipulation language (DML) operations with more than one pending operation.","pos":[30839,30985]},{"content":"This feature eliminates the need for an application to deal with connection-busy errors.","pos":[30986,31074]},{"content":"In addition, MARS can replace the user of server-side cursors, which generally consume more resources.","pos":[31075,31177]},{"content":"Finally, because multiple operations can operate on a single connection, they can share the same transaction context, eliminating the need to use <bpt id=\"p1\">**</bpt>sp_getbindtoken<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>sp_bindsession<ept id=\"p2\">**</ept> system stored procedures.","pos":[31178,31392],"source":" Finally, because multiple operations can operate on a single connection, they can share the same transaction context, eliminating the need to use **sp_getbindtoken** and **sp_bindsession** system stored procedures."},{"content":"The following Console application demonstrates how to use two <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph> objects with three <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlCommand&gt;</ph> objects and a single <ph id=\"ph3\">&lt;xref:System.Data.SqlClient.SqlConnection&gt;</ph> object with MARS enabled.","pos":[31394,31647],"source":"The following Console application demonstrates how to use two <xref:System.Data.SqlClient.SqlDataReader> objects with three <xref:System.Data.SqlClient.SqlCommand> objects and a single <xref:System.Data.SqlClient.SqlConnection> object with MARS enabled."},{"content":"The first command object retrieves a list of vendors whose credit rating is 5.","pos":[31648,31726]},{"content":"The second command object uses the vendor ID provided from a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph> to load the second <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph> with all of the products for the particular vendor.","pos":[31727,31944],"source":" The second command object uses the vendor ID provided from a <xref:System.Data.SqlClient.SqlDataReader> to load the second <xref:System.Data.SqlClient.SqlDataReader> with all of the products for the particular vendor."},{"content":"Each product record is visited by the second <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDataReader&gt;</ph>.","pos":[31945,32033],"source":" Each product record is visited by the second <xref:System.Data.SqlClient.SqlDataReader>."},{"content":"A calculation is performed to determine what the new <bpt id=\"p1\">**</bpt>OnOrderQty<ept id=\"p1\">**</ept> should be.","pos":[32034,32112],"source":" A calculation is performed to determine what the new **OnOrderQty** should be."},{"content":"The third command object is then used to update the <bpt id=\"p1\">**</bpt>ProductVendor<ept id=\"p1\">**</ept> table with the new value.","pos":[32113,32208],"source":" The third command object is then used to update the **ProductVendor** table with the new value."},{"content":"This entire process takes place within a single transaction, which is rolled back at the end.","pos":[32209,32302]},{"pos":[32306,32597],"content":"[!NOTE]\nThe following example uses the sample **AdventureWorks** database included with SQL Server. The connection string provided in the sample code assumes that the database is installed and available on the local computer. Modify the connection string as necessary for your environment.","leadings":["","> "],"nodes":[{"content":"The following example uses the sample **AdventureWorks** database included with SQL Server. The connection string provided in the sample code assumes that the database is installed and available on the local computer. Modify the connection string as necessary for your environment.","pos":[8,289],"nodes":[{"content":"The following example uses the sample <bpt id=\"p1\">**</bpt>AdventureWorks<ept id=\"p1\">**</ept> database included with SQL Server.","pos":[0,91],"source":"The following example uses the sample **AdventureWorks** database included with SQL Server."},{"content":"The connection string provided in the sample code assumes that the database is installed and available on the local computer.","pos":[92,217]},{"content":"Modify the connection string as necessary for your environment.","pos":[218,281]}]}]},{"pos":[36651,36659],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[36663,36778],"content":"<bpt id=\"p1\">[</bpt>Retrieving and Modifying Data in ADO.NET<ept id=\"p1\">](../../../../docs/framework/data/adonet/retrieving-and-modifying-data.md)</ept>","source":"[Retrieving and Modifying Data in ADO.NET](../../../../docs/framework/data/adonet/retrieving-and-modifying-data.md)"}]}