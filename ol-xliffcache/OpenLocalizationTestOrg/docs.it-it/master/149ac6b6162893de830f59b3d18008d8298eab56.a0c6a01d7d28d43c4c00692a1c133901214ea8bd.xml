{"content":"---\ntitle: \"Performing Recovery\"\nms.date: \"03/30/2017\"\nms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0\n---\n# Performing Recovery\nA resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.  \n  \n## The Recovery Process  \n To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method. In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure. For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery. Otherwise, <xref:System.Transactions.TransactionException> is thrown. For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md) .  \n  \n In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase. The record should contain all the information that is necessary to complete the transaction on commit. The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback. The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.  \n  \n The recovery process consists of the following two steps:  \n  \n### Step 1 - ReEnlist  \n The resource manager examines the prepare information record for each enlistment that is in-doubt. This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.  \n  \n For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager. This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array. A new <xref:System.Transactions.Enlistment> object is returned. If the reenlistment fails with an exception, the resource manager will need to retry at a later time.  \n  \n You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure. In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit. Any attempt to call this method at invalid times can produce erroneous results.  \n  \n When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.  \n  \n### Step 2 - Completing the recovery  \n When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method. This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions. By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.  \n  \n A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions. The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again. Step 2 can be repeated multiple times without affecting the outcome of transactions.\n","nodes":[{"pos":[4,103],"embed":true,"restype":"x-metadata","content":"title: \"Performing Recovery\"\nms.date: \"03/30/2017\"\nms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0","nodes":[{"content":"Performing Recovery","nodes":[{"pos":[0,19],"content":"Performing Recovery","nodes":[{"content":"Performing Recovery","pos":[0,19]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[110,129],"content":"Performing Recovery","linkify":"Performing Recovery","nodes":[{"content":"Performing Recovery","pos":[0,19]}]},{"content":"A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.","pos":[130,278]},{"pos":[287,307],"content":"The Recovery Process","linkify":"The Recovery Process","nodes":[{"content":"The Recovery Process","pos":[0,20]}]},{"content":"To durably enlist a resource (described by an implementation of the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification&gt;</ph> interface) that can later be eligible for recovery, you should call the <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction.EnlistDurable%2A&gt;</ph> method.","pos":[311,565],"source":"To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method."},{"content":"In addition, you must provide the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.EnlistDurable%2A&gt;</ph> method with a resource manager identifier (a <ph id=\"ph2\">&lt;xref:System.Guid&gt;</ph>) that is used to consistently label the participant of the transaction in the event of a resource failure.","pos":[566,826],"source":" In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure."},{"content":"For this reason, the <ph id=\"ph1\">&lt;xref:System.Guid&gt;</ph> that is provided to the initial Enlist call should be identical to the <bpt id=\"p1\">*</bpt>resourceManagerIdentifier<ept id=\"p1\">*</ept> parameter in the <ph id=\"ph2\">&lt;xref:System.Transactions.TransactionManager.Reenlist%2A&gt;</ph> call during recovery.","pos":[827,1062],"source":" For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery."},{"content":"Otherwise, <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionException&gt;</ph> is thrown.","pos":[1063,1132],"source":" Otherwise, <xref:System.Transactions.TransactionException> is thrown."},{"content":"For more information on durable enlistments, see <bpt id=\"p1\">[</bpt>Enlisting Resources as Participants in a Transaction<ept id=\"p1\">](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)</ept> .","pos":[1133,1340],"source":" For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md) ."},{"content":"In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification.Prepare%2A&gt;</ph> notification, it should log its prepare record during this phase.","pos":[1347,1594],"source":"In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase."},{"content":"The record should contain all the information that is necessary to complete the transaction on commit.","pos":[1595,1697]},{"content":"The prepare record can later be accessed during recovery by retrieving the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A&gt;</ph> property of the <bpt id=\"p1\">*</bpt>preparingEnlistment<ept id=\"p1\">*</ept> callback.","pos":[1698,1890],"source":" The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback."},{"content":"The record logging does not need to be performed within the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification.Prepare%2A&gt;</ph> method as the RM can do this on a worker thread.","pos":[1891,2061],"source":" The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread."},{"content":"The recovery process consists of the following two steps:","pos":[2068,2125]},{"pos":[2135,2152],"content":"Step 1 - ReEnlist","linkify":"Step 1 - ReEnlist","nodes":[{"content":"Step 1 - ReEnlist","pos":[0,17]}]},{"content":"The resource manager examines the prepare information record for each enlistment that is in-doubt.","pos":[2156,2254]},{"content":"This is done by examining the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.Transactions.PreparingEnlistment&gt;</ph> callback, which is passed to the resource manager in the <ph id=\"ph3\">&lt;xref:System.Transactions.IEnlistmentNotification.Prepare%2A&gt;</ph> notification during phase 1.","pos":[2255,2565],"source":" This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1."},{"content":"For each such enlistment it examines, it invokes <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionManager.Reenlist%2A&gt;</ph> on the transaction manager.","pos":[2572,2706],"source":"For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager."},{"content":"This method passes on a unique <ph id=\"ph1\">&lt;xref:System.Guid&gt;</ph> that identifies the resource manager, as well as the enlistment's information in a byte array.","pos":[2707,2851],"source":" This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array."},{"content":"A new <ph id=\"ph1\">&lt;xref:System.Transactions.Enlistment&gt;</ph> object is returned.","pos":[2852,2915],"source":" A new <xref:System.Transactions.Enlistment> object is returned."},{"content":"If the reenlistment fails with an exception, the resource manager will need to retry at a later time.","pos":[2916,3017]},{"content":"You should only call the <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionManager.Reenlist%2A&gt;</ph> method when a resource manager restarts from failure.","pos":[3024,3160],"source":"You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure."},{"content":"In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.","pos":[3161,3307]},{"content":"Any attempt to call this method at invalid times can produce erroneous results.","pos":[3308,3387]},{"pos":[3394,3794],"content":"When a participant is reenlisted using this method, the phase 2 methods of <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification&gt;</ph> that correspond to the transaction's outcome (that is, <ph id=\"ph2\">&lt;xref:System.Transactions.IEnlistmentNotification.Commit%2A&gt;</ph> , <ph id=\"ph3\">&lt;xref:System.Transactions.IEnlistmentNotification.Rollback%2A&gt;</ph> or <ph id=\"ph4\">&lt;xref:System.Transactions.IEnlistmentNotification.InDoubt%2A&gt;</ph> ) are called as appropriate.","source":"When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate."},{"pos":[3804,3836],"content":"Step 2 - Completing the recovery","linkify":"Step 2 - Completing the recovery","nodes":[{"content":"Step 2 - Completing the recovery","pos":[0,32]}]},{"content":"When all the reenlistments are finished, the resource manager calls the <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionManager.RecoveryComplete%2A&gt;</ph> method.","pos":[3840,3985],"source":"When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method."},{"content":"This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.","pos":[3986,4117]},{"content":"By doing so, the resource manager guarantees that it will not invoke the <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionManager.Reenlist%2A&gt;</ph> method again.","pos":[4118,4262],"source":" By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again."},{"content":"A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.","pos":[4269,4378]},{"content":"The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionManager.RecoveryComplete%2A&gt;</ph> has been invoked (step 2); step 1 cannot be performed again.","pos":[4379,4643],"source":" The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again."},{"content":"Step 2 can be repeated multiple times without affecting the outcome of transactions.","pos":[4644,4728]}]}