{"content":"---\ntitle: \"Certificate Selection and Validation\"\nms.date: \"03/30/2017\"\nms.assetid: c933aca2-4cd0-4ff1-9df9-267143f25a6f\n---\n# Certificate Selection and Validation\nThe <xref:System.Net> classes support several ways to select and validate <xref:System.Security.Cryptography.X509Certificates> for Secure Socket Layer (SSL) connections. A client can select one or more certificates to authenticate itself to a server. A server can require that a client certificate have one or more specific attributes for authentication.  \n  \n## Definition  \n A certificate is an ASCII byte stream that contains a public key, attributes (such as version number, serial number, and expiration date) and a digital signature from a Certificate Authority. Certificates are used to establish an encrypted connection or to authenticate a client to a server.  \n  \n## Client Certificate Selection and Validation  \n A client can select one or more certificates for a specific SSL connection. Client certificates can be associated with the SSL connection to a web server or an SMTP mail server. A client adds certificates to a collection of <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects. Using email as an example, the certificate collection is an instance of a <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection>) associated with the <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> property of the <xref:System.Net.Mail.SmtpClient> class. The <xref:System.Net.HttpWebRequest> class has a similar <xref:System.Net.HttpWebRequest.ClientCertificates%2A> property.  \n  \n The primary difference between the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class is that the private key must reside in the certificate store for the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> class.  \n  \n Even if certificates are added to a collection and associated with a specific SSL connection, no certificates will be sent to the server unless the server requests them. If multiple client certificates are set on a connection, the best one will be used based on an algorithm that considers the match between the list of certificate issuers provided by the server and the client certificate issuer name.  \n  \n The <xref:System.Net.Security.SslStream> class provides even more control over the SSL handshake. A client can specify a delegate to pick which client certificate to use.  \n  \n A remote server can verify that a client certificate is valid, current, and signed by the appropriate Certificate Authority. A delegate can be added to the <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> to enforce certificate validation.  \n  \n## Client Certificate Selection  \n The .NET Framework selects the client certificate to present to the server in the following manner:  \n  \n1.  If a client certificate was presented previously to the server, the certificate is cached when first presented and is reused for subsequent client certificate requests.  \n  \n2.  If a delegate is present, always use the result from the delegate as the client certificate to select. Try to use a cached certificate when possible, but do not use cached anonymous credentials if the delegate has returned null and the certificate collection is not empty.  \n  \n3.  If this is the first challenge for a client certificate, the Framework enumerates the certificates in <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects associated with the connection, looking for a match between the list of certificate issuers provided by the server and the client certificate issuer name. The first certificate that matches is sent to the server. If no certificate matches or the certificate collection is empty, then an anonymous credential is sent to the server.  \n  \n## Tools for Certificate Configuration  \n A number of tools are available for client and server certificate configuration.  \n  \n The *Winhttpcertcfg.exe* tool can be used to configure client certificates. The *Winhttpcertcfg.exe* tool is provided as one of the tools with the Windows Server 2003 Resource Kit. This tool is also available as a download as part of the Windows Server 2003 Resource Kit Tools at [www.microsoft.com](https://www.microsoft.com).  \n  \nThe *HttpCfg.exe* tool can be used to configure server certificates for the <xref:System.Net.HttpListener> class. The *HttpCfg.exe* tool is provided as one of the support tools for Windows Server 2003 and Windows XP Service Pack 2. *HttpCfg.exe* and the other support tools are not installed by default on either Windows Server 2003 or Windows XP. On Windows Server 2003. the support tools are installed separately from the following folder and file on the Windows Server 2003 CD-ROM:  \n  \n \\Support\\Tools\\Suptools.msi  \n  \n For use with Windows XP Service Pack 2, the Windows XP Support Tools are available as a download from [www.microsoft.com](https://www.microsoft.com).  \n  \n The source code to a version of the *HttpCfg.exe* tool is also provided as a sample with the Windows Server SDK. The source code to the *HttpCfg.exe* sample is installed by default with the networking samples as part of the Windows SDK under the following folder:  \n  \n *C:\\Program Files\\Microsoft SDKs\\Windows\\v1.0\\Samples\\NetDS\\http\\serviceconfig*  \n  \n In addition to these tools, the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> classes provides methods for loading a certificate from the file system.  \n  \n## See also\n\n- [Security in Network Programming](../../../docs/framework/network-programming/security-in-network-programming.md)\n- [Network Programming in the .NET Framework](../../../docs/framework/network-programming/index.md)\n","nodes":[{"pos":[4,120],"embed":true,"restype":"x-metadata","content":"title: \"Certificate Selection and Validation\"\nms.date: \"03/30/2017\"\nms.assetid: c933aca2-4cd0-4ff1-9df9-267143f25a6f","nodes":[{"content":"Certificate Selection and Validation","nodes":[{"pos":[0,36],"content":"Certificate Selection and Validation","nodes":[{"content":"Certificate Selection and Validation","pos":[0,36]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[127,163],"content":"Certificate Selection and Validation","linkify":"Certificate Selection and Validation","nodes":[{"content":"Certificate Selection and Validation","pos":[0,36]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net&gt;</ph> classes support several ways to select and validate <ph id=\"ph2\">&lt;xref:System.Security.Cryptography.X509Certificates&gt;</ph> for Secure Socket Layer (SSL) connections.","pos":[164,333],"source":"The <xref:System.Net> classes support several ways to select and validate <xref:System.Security.Cryptography.X509Certificates> for Secure Socket Layer (SSL) connections."},{"content":"A client can select one or more certificates to authenticate itself to a server.","pos":[334,414]},{"content":"A server can require that a client certificate have one or more specific attributes for authentication.","pos":[415,518]},{"pos":[527,537],"content":"Definition","linkify":"Definition","nodes":[{"content":"Definition","pos":[0,10]}]},{"content":"A certificate is an ASCII byte stream that contains a public key, attributes (such as version number, serial number, and expiration date) and a digital signature from a Certificate Authority.","pos":[541,732]},{"content":"Certificates are used to establish an encrypted connection or to authenticate a client to a server.","pos":[733,832]},{"pos":[841,884],"content":"Client Certificate Selection and Validation","linkify":"Client Certificate Selection and Validation","nodes":[{"content":"Client Certificate Selection and Validation","pos":[0,43]}]},{"content":"A client can select one or more certificates for a specific SSL connection.","pos":[888,963]},{"content":"Client certificates can be associated with the SSL connection to a web server or an SMTP mail server.","pos":[964,1065]},{"content":"A client adds certificates to a collection of <ph id=\"ph1\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate&gt;</ph> or <ph id=\"ph2\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate2&gt;</ph> class objects.","pos":[1066,1268],"source":" A client adds certificates to a collection of <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects."},{"content":"Using email as an example, the certificate collection is an instance of a <ph id=\"ph1\">&lt;xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection&gt;</ph>) associated with the <ph id=\"ph2\">&lt;xref:System.Net.Mail.SmtpClient.ClientCertificates%2A&gt;</ph> property of the <ph id=\"ph3\">&lt;xref:System.Net.Mail.SmtpClient&gt;</ph> class.","pos":[1269,1555],"source":" Using email as an example, the certificate collection is an instance of a <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection>) associated with the <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> property of the <xref:System.Net.Mail.SmtpClient> class."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net.HttpWebRequest&gt;</ph> class has a similar <ph id=\"ph2\">&lt;xref:System.Net.HttpWebRequest.ClientCertificates%2A&gt;</ph> property.","pos":[1556,1677],"source":" The <xref:System.Net.HttpWebRequest> class has a similar <xref:System.Net.HttpWebRequest.ClientCertificates%2A> property."},{"pos":[1684,2016],"content":"The primary difference between the <ph id=\"ph1\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate&gt;</ph> and the <ph id=\"ph2\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate2&gt;</ph> class is that the private key must reside in the certificate store for the <ph id=\"ph3\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate&gt;</ph> class.","source":"The primary difference between the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class is that the private key must reside in the certificate store for the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> class."},{"content":"Even if certificates are added to a collection and associated with a specific SSL connection, no certificates will be sent to the server unless the server requests them.","pos":[2023,2192]},{"content":"If multiple client certificates are set on a connection, the best one will be used based on an algorithm that considers the match between the list of certificate issuers provided by the server and the client certificate issuer name.","pos":[2193,2425]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net.Security.SslStream&gt;</ph> class provides even more control over the SSL handshake.","pos":[2432,2529],"source":"The <xref:System.Net.Security.SslStream> class provides even more control over the SSL handshake."},{"content":"A client can specify a delegate to pick which client certificate to use.","pos":[2530,2602]},{"content":"A remote server can verify that a client certificate is valid, current, and signed by the appropriate Certificate Authority.","pos":[2609,2733]},{"content":"A delegate can be added to the <ph id=\"ph1\">&lt;xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A&gt;</ph> to enforce certificate validation.","pos":[2734,2876],"source":" A delegate can be added to the <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> to enforce certificate validation."},{"pos":[2885,2913],"content":"Client Certificate Selection","linkify":"Client Certificate Selection","nodes":[{"content":"Client Certificate Selection","pos":[0,28]}]},{"content":"The .NET Framework selects the client certificate to present to the server in the following manner:","pos":[2917,3016]},{"content":"If a client certificate was presented previously to the server, the certificate is cached when first presented and is reused for subsequent client certificate requests.","pos":[3026,3194]},{"content":"If a delegate is present, always use the result from the delegate as the client certificate to select.","pos":[3204,3306]},{"content":"Try to use a cached certificate when possible, but do not use cached anonymous credentials if the delegate has returned null and the certificate collection is not empty.","pos":[3307,3476]},{"content":"If this is the first challenge for a client certificate, the Framework enumerates the certificates in <ph id=\"ph1\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate&gt;</ph> or the <ph id=\"ph2\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate2&gt;</ph> class objects associated with the connection, looking for a match between the list of certificate issuers provided by the server and the client certificate issuer name.","pos":[3486,3902],"source":"If this is the first challenge for a client certificate, the Framework enumerates the certificates in <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects associated with the connection, looking for a match between the list of certificate issuers provided by the server and the client certificate issuer name."},{"content":"The first certificate that matches is sent to the server.","pos":[3903,3960]},{"content":"If no certificate matches or the certificate collection is empty, then an anonymous credential is sent to the server.","pos":[3961,4078]},{"pos":[4087,4122],"content":"Tools for Certificate Configuration","linkify":"Tools for Certificate Configuration","nodes":[{"content":"Tools for Certificate Configuration","pos":[0,35]}]},{"content":"A number of tools are available for client and server certificate configuration.","pos":[4126,4206]},{"content":"The <bpt id=\"p1\">*</bpt>Winhttpcertcfg.exe<ept id=\"p1\">*</ept> tool can be used to configure client certificates.","pos":[4213,4288],"source":"The *Winhttpcertcfg.exe* tool can be used to configure client certificates."},{"content":"The <bpt id=\"p1\">*</bpt>Winhttpcertcfg.exe<ept id=\"p1\">*</ept> tool is provided as one of the tools with the Windows Server 2003 Resource Kit.","pos":[4289,4393],"source":" The *Winhttpcertcfg.exe* tool is provided as one of the tools with the Windows Server 2003 Resource Kit."},{"content":"This tool is also available as a download as part of the Windows Server 2003 Resource Kit Tools at <bpt id=\"p1\">[</bpt>www.microsoft.com<ept id=\"p1\">](https://www.microsoft.com)</ept>.","pos":[4394,4540],"source":" This tool is also available as a download as part of the Windows Server 2003 Resource Kit Tools at [www.microsoft.com](https://www.microsoft.com)."},{"content":"The <bpt id=\"p1\">*</bpt>HttpCfg.exe<ept id=\"p1\">*</ept> tool can be used to configure server certificates for the <ph id=\"ph1\">&lt;xref:System.Net.HttpListener&gt;</ph> class.","pos":[4546,4659],"source":"The *HttpCfg.exe* tool can be used to configure server certificates for the <xref:System.Net.HttpListener> class."},{"content":"The <bpt id=\"p1\">*</bpt>HttpCfg.exe<ept id=\"p1\">*</ept> tool is provided as one of the support tools for Windows Server 2003 and Windows XP Service Pack 2.","pos":[4660,4777],"source":" The *HttpCfg.exe* tool is provided as one of the support tools for Windows Server 2003 and Windows XP Service Pack 2."},{"content":"<bpt id=\"p1\">*</bpt>HttpCfg.exe<ept id=\"p1\">*</ept> and the other support tools are not installed by default on either Windows Server 2003 or Windows XP.","pos":[4778,4893],"source":"*HttpCfg.exe* and the other support tools are not installed by default on either Windows Server 2003 or Windows XP."},{"content":"On Windows Server 2003.","pos":[4894,4917]},{"content":"the support tools are installed separately from the following folder and file on the Windows Server 2003 CD-ROM:","pos":[4918,5030]},{"content":"\\Support\\Tools\\Suptools.msi","pos":[5037,5064]},{"pos":[5071,5220],"content":"For use with Windows XP Service Pack 2, the Windows XP Support Tools are available as a download from <bpt id=\"p1\">[</bpt>www.microsoft.com<ept id=\"p1\">](https://www.microsoft.com)</ept>.","source":"For use with Windows XP Service Pack 2, the Windows XP Support Tools are available as a download from [www.microsoft.com](https://www.microsoft.com)."},{"content":"The source code to a version of the <bpt id=\"p1\">*</bpt>HttpCfg.exe<ept id=\"p1\">*</ept> tool is also provided as a sample with the Windows Server SDK.","pos":[5227,5339],"source":"The source code to a version of the *HttpCfg.exe* tool is also provided as a sample with the Windows Server SDK."},{"content":"The source code to the <bpt id=\"p1\">*</bpt>HttpCfg.exe<ept id=\"p1\">*</ept> sample is installed by default with the networking samples as part of the Windows SDK under the following folder:","pos":[5340,5490],"source":" The source code to the *HttpCfg.exe* sample is installed by default with the networking samples as part of the Windows SDK under the following folder:"},{"pos":[5497,5576],"content":"<bpt id=\"p1\">*</bpt>C:\\Program Files\\Microsoft SDKs\\Windows\\v1.0\\Samples\\NetDS\\http\\serviceconfig<ept id=\"p1\">*</ept>","source":"*C:\\Program Files\\Microsoft SDKs\\Windows\\v1.0\\Samples\\NetDS\\http\\serviceconfig*"},{"pos":[5583,5830],"content":"In addition to these tools, the <ph id=\"ph1\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate2&gt;</ph> classes provides methods for loading a certificate from the file system.","source":"In addition to these tools, the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> classes provides methods for loading a certificate from the file system."},{"pos":[5839,5847],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[5851,5964],"content":"<bpt id=\"p1\">[</bpt>Security in Network Programming<ept id=\"p1\">](../../../docs/framework/network-programming/security-in-network-programming.md)</ept>","source":"[Security in Network Programming](../../../docs/framework/network-programming/security-in-network-programming.md)"},{"pos":[5967,6064],"content":"<bpt id=\"p1\">[</bpt>Network Programming in the .NET Framework<ept id=\"p1\">](../../../docs/framework/network-programming/index.md)</ept>","source":"[Network Programming in the .NET Framework](../../../docs/framework/network-programming/index.md)"}]}