{"content":"---\ntitle: \"Batching Messages in a Transaction\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"batching messages [WCF]\"\nms.assetid: 53305392-e82e-4e89-aedc-3efb6ebcd28c\n---\n# Batching Messages in a Transaction\nQueued applications use transactions to ensure correctness and reliable delivery of messages. Transactions, however, are expensive operations and can dramatically reduce message throughput. One way to improve message throughput is to have an application read and process multiple messages within a single transaction. The trade-off is between performance and recovery: as the number of messages in a batch increases, so does the amount of recovery work that required if transactions are rolled back. It is important to note the difference between batching messages in a transaction and sessions. A *session* is a grouping of related messages that are processed by a single application and committed as a single unit. Sessions are generally used when a group of related messages must be processed together. An example of this is an online shopping Web site. *Batches* are used to process multiple, unrelated messages in a way that increases message throughput. For more information about sessions, see [Grouping Queued Messages in a Session](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md). Messages in a batch are also processed by a single application and committed as a single unit, but there may be no relationship between the messages in the batch. Batching messages in a transaction is an optimization that does not change how the application runs.  \n  \n## Entering Batching Mode  \n The <xref:System.ServiceModel.Description.TransactedBatchingBehavior> endpoint behavior controls batching. Adding this endpoint behavior to a service endpoint tells Windows Communication Foundation (WCF) to batch messages in a transaction. Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true` are considered for a batch. If all operations on the service contract are marked with `TransactionScopeRequired` = `false` and `TransactionAutoComplete` = `false`, then batching mode is never entered.  \n  \n## Committing a Transaction  \n A batched transaction is committed based on the following:  \n  \n-   `MaxBatchSize`. A property of the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> behavior. This property determines the maximum number of messages that are placed into a batch. When this number is reached, the batch is committed. This is value is not a strict limit, it is possible to commit a batch before receiving this number of messages.  \n  \n-   `Transaction Timeout`. After 80 percent of the transaction's time-out has elapsed, the batch is committed and a new batch is created. This means that if 20 percent or less of the time given for a transaction to complete remains, the batch is committed.  \n  \n-   `TransactionScopeRequired`. When processing a batch of messages, if WCF finds one that has `TransactionScopeRequired` = `false`, it commits the batch and reopens a new batch on receipt of the first message with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true`.  \n  \n-   If no more messages exist in the queue, then the current batch is committed, even if the `MaxBatchSize` has not been reached or 80 percent of the transaction's time-out has not elapsed.  \n  \n## Leaving Batching Mode  \n If a message in a batch causes the transaction to abort, the following steps occur:  \n  \n1.  The entire batch of messages is rolled back.  \n  \n2.  Messages are read one at a time until the number of messages read exceeds twice the maximum batch size.  \n  \n3.  Batch mode is re-entered.  \n  \n## Choosing the Batch Size  \n The size of a batch is application-dependent. The empirical method is the best way to arrive at an optimal batch size for the application. It is important to remember when choosing a batch size to choose the size according to your application's actual deployment model. For example, when deploying the application, if you need an SQL server on a remote machine and a transaction that spans the queue and the SQL server, then the batch size is best determined by running this exact configuration.  \n  \n## Concurrency and Batching  \n To increase throughput, you can also have many batches run concurrently. By setting `ConcurrencyMode.Multiple` in `ServiceBehaviorAttribute`, you enable concurrent batching.  \n  \n *Service throttling* is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service. When used with batching, this is interpreted as how many concurrent batches can be run. If the service throttling is not set, WCF defaults the maximum concurrent calls to 16. Thus, if batching behavior were added by default, a maximum of 16 batches can be active at the same time. It is best to tune the service throttling and batching based on your capacity. For example, if the queue has 100 messages and a batch of 20 is desired, having the maximum concurrent calls set to 16 is not useful because, depending on throughput, 16 transactions could be active, similar to not having batching turned on. Therefore, when fine-tuning for performance, either do not have concurrent batching or have concurrent batching with the correct service throttle size.  \n  \n## Batching and Multiple Endpoints  \n An endpoint is composed of an address and a contract. There may be multiple endpoints that share the same binding. It is possible for two endpoints to share the same binding and listen Uniform Resource Identifier (URI), or queue address. If two endpoints are reading from the same queue, and transacted batching behavior is added to both endpoints, a conflict in the batch sizes specified could arise. This is resolved by implementing batching using the minimal batch size specified between the two transacted batching behaviors. In this scenario, if one of the endpoints does not specify transacted batching, then both endpoints would not use batching.  \n  \n## Example  \n The following example shows how to specify the `TransactedBatchingBehavior` in a configuration file.  \n  \n```xml  \n<behaviors>\n  <endpointBehaviors>\n    <behavior name=\"TransactedBatchingBehavior\"\n              maxBatchSize=\"100\" />\n  </endpointBehaviors>\n</behaviors>\n```  \n  \n The following example shows how to specify the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in code.  \n  \n```csharp\nusing (ServiceHost serviceHost = new ServiceHost(typeof(OrderProcessorService)))\n{\n     ServiceEndpoint sep = ServiceHost.AddServiceEndpoint(typeof(IOrderProcessor), new NetMsmqBinding(), \"net.msmq://localhost/private/ServiceModelSamplesTransacted\");\n     sep.Behaviors.Add(new TransactedBatchingBehavior(100));\n     \n     // Open the ServiceHost to create listeners and start listening for messages.\n    serviceHost.Open();\n  \n    // The service can now be accessed.\n    Console.WriteLine(\"The service is ready.\");\n    Console.WriteLine(\"Press <ENTER> to terminate service.\");\n    Console.WriteLine();\n    Console.ReadLine();\n  \n    // Close the ServiceHostB to shut down the service.\n    serviceHost.Close();\n}  \n```  \n  \n## See also\n\n- [Queues Overview](../../../../docs/framework/wcf/feature-details/queues-overview.md)\n- [Queuing in WCF](../../../../docs/framework/wcf/feature-details/queuing-in-wcf.md)\n","nodes":[{"pos":[4,170],"embed":true,"restype":"x-metadata","content":"title: \"Batching Messages in a Transaction\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"batching messages [WCF]\"\nms.assetid: 53305392-e82e-4e89-aedc-3efb6ebcd28c","nodes":[{"content":"Batching Messages in a Transaction","nodes":[{"pos":[0,34],"content":"Batching Messages in a Transaction","nodes":[{"content":"Batching Messages in a Transaction","pos":[0,34]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[177,211],"content":"Batching Messages in a Transaction","linkify":"Batching Messages in a Transaction","nodes":[{"content":"Batching Messages in a Transaction","pos":[0,34]}]},{"content":"Queued applications use transactions to ensure correctness and reliable delivery of messages.","pos":[212,305]},{"content":"Transactions, however, are expensive operations and can dramatically reduce message throughput.","pos":[306,401]},{"content":"One way to improve message throughput is to have an application read and process multiple messages within a single transaction.","pos":[402,529]},{"content":"The trade-off is between performance and recovery: as the number of messages in a batch increases, so does the amount of recovery work that required if transactions are rolled back.","pos":[530,711]},{"content":"It is important to note the difference between batching messages in a transaction and sessions.","pos":[712,807]},{"content":"A <bpt id=\"p1\">*</bpt>session<ept id=\"p1\">*</ept> is a grouping of related messages that are processed by a single application and committed as a single unit.","pos":[808,928],"source":" A *session* is a grouping of related messages that are processed by a single application and committed as a single unit."},{"content":"Sessions are generally used when a group of related messages must be processed together.","pos":[929,1017]},{"content":"An example of this is an online shopping Web site.","pos":[1018,1068]},{"content":"<bpt id=\"p1\">*</bpt>Batches<ept id=\"p1\">*</ept> are used to process multiple, unrelated messages in a way that increases message throughput.","pos":[1069,1171],"source":"*Batches* are used to process multiple, unrelated messages in a way that increases message throughput."},{"content":"For more information about sessions, see <bpt id=\"p1\">[</bpt>Grouping Queued Messages in a Session<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md)</ept>.","pos":[1172,1342],"source":" For more information about sessions, see [Grouping Queued Messages in a Session](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md)."},{"content":"Messages in a batch are also processed by a single application and committed as a single unit, but there may be no relationship between the messages in the batch.","pos":[1343,1505]},{"content":"Batching messages in a transaction is an optimization that does not change how the application runs.","pos":[1506,1606]},{"pos":[1615,1637],"content":"Entering Batching Mode","linkify":"Entering Batching Mode","nodes":[{"content":"Entering Batching Mode","pos":[0,22]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.TransactedBatchingBehavior&gt;</ph> endpoint behavior controls batching.","pos":[1641,1747],"source":"The <xref:System.ServiceModel.Description.TransactedBatchingBehavior> endpoint behavior controls batching."},{"content":"Adding this endpoint behavior to a service endpoint tells Windows Communication Foundation (WCF) to batch messages in a transaction.","pos":[1748,1880]},{"content":"Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with <ph id=\"ph1\">`TransactionScopeRequired`</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`true`</ph> and <ph id=\"ph4\">`TransactionAutoComplete`</ph><ph id=\"ph5\"> = </ph><ph id=\"ph6\">`true`</ph> are considered for a batch.","pos":[1881,2141],"source":" Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true` are considered for a batch."},{"content":"If all operations on the service contract are marked with <ph id=\"ph1\">`TransactionScopeRequired`</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`false`</ph> and <ph id=\"ph4\">`TransactionAutoComplete`</ph><ph id=\"ph5\"> = </ph><ph id=\"ph6\">`false`</ph>, then batching mode is never entered.","pos":[2142,2314],"source":" If all operations on the service contract are marked with `TransactionScopeRequired` = `false` and `TransactionAutoComplete` = `false`, then batching mode is never entered."},{"pos":[2323,2347],"content":"Committing a Transaction","linkify":"Committing a Transaction","nodes":[{"content":"Committing a Transaction","pos":[0,24]}]},{"content":"A batched transaction is committed based on the following:","pos":[2351,2409]},{"content":"<ph id=\"ph1\">`MaxBatchSize`</ph>.","pos":[2419,2434],"source":"`MaxBatchSize`."},{"content":"A property of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.TransactedBatchingBehavior&gt;</ph> behavior.","pos":[2435,2528],"source":" A property of the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> behavior."},{"content":"This property determines the maximum number of messages that are placed into a batch.","pos":[2529,2614]},{"content":"When this number is reached, the batch is committed.","pos":[2615,2667]},{"content":"This is value is not a strict limit, it is possible to commit a batch before receiving this number of messages.","pos":[2668,2779]},{"content":"<ph id=\"ph1\">`Transaction Timeout`</ph>.","pos":[2789,2811],"source":"`Transaction Timeout`."},{"content":"After 80 percent of the transaction's time-out has elapsed, the batch is committed and a new batch is created.","pos":[2812,2922]},{"content":"This means that if 20 percent or less of the time given for a transaction to complete remains, the batch is committed.","pos":[2923,3041]},{"content":"<ph id=\"ph1\">`TransactionScopeRequired`</ph>.","pos":[3051,3078],"source":"`TransactionScopeRequired`."},{"content":"When processing a batch of messages, if WCF finds one that has <ph id=\"ph1\">`TransactionScopeRequired`</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`false`</ph>, it commits the batch and reopens a new batch on receipt of the first message with <ph id=\"ph4\">`TransactionScopeRequired`</ph><ph id=\"ph5\"> = </ph><ph id=\"ph6\">`true`</ph> and <ph id=\"ph7\">`TransactionAutoComplete`</ph><ph id=\"ph8\"> = </ph><ph id=\"ph9\">`true`</ph>.","pos":[3079,3337],"source":" When processing a batch of messages, if WCF finds one that has `TransactionScopeRequired` = `false`, it commits the batch and reopens a new batch on receipt of the first message with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true`."},{"pos":[3347,3532],"content":"If no more messages exist in the queue, then the current batch is committed, even if the <ph id=\"ph1\">`MaxBatchSize`</ph> has not been reached or 80 percent of the transaction's time-out has not elapsed.","source":"If no more messages exist in the queue, then the current batch is committed, even if the `MaxBatchSize` has not been reached or 80 percent of the transaction's time-out has not elapsed."},{"pos":[3541,3562],"content":"Leaving Batching Mode","linkify":"Leaving Batching Mode","nodes":[{"content":"Leaving Batching Mode","pos":[0,21]}]},{"content":"If a message in a batch causes the transaction to abort, the following steps occur:","pos":[3566,3649]},{"content":"The entire batch of messages is rolled back.","pos":[3659,3703]},{"content":"Messages are read one at a time until the number of messages read exceeds twice the maximum batch size.","pos":[3713,3816]},{"content":"Batch mode is re-entered.","pos":[3826,3851]},{"pos":[3860,3883],"content":"Choosing the Batch Size","linkify":"Choosing the Batch Size","nodes":[{"content":"Choosing the Batch Size","pos":[0,23]}]},{"content":"The size of a batch is application-dependent.","pos":[3887,3932]},{"content":"The empirical method is the best way to arrive at an optimal batch size for the application.","pos":[3933,4025]},{"content":"It is important to remember when choosing a batch size to choose the size according to your application's actual deployment model.","pos":[4026,4156]},{"content":"For example, when deploying the application, if you need an SQL server on a remote machine and a transaction that spans the queue and the SQL server, then the batch size is best determined by running this exact configuration.","pos":[4157,4382]},{"pos":[4391,4415],"content":"Concurrency and Batching","linkify":"Concurrency and Batching","nodes":[{"content":"Concurrency and Batching","pos":[0,24]}]},{"content":"To increase throughput, you can also have many batches run concurrently.","pos":[4419,4491]},{"content":"By setting <ph id=\"ph1\">`ConcurrencyMode.Multiple`</ph> in <ph id=\"ph2\">`ServiceBehaviorAttribute`</ph>, you enable concurrent batching.","pos":[4492,4592],"source":" By setting `ConcurrencyMode.Multiple` in `ServiceBehaviorAttribute`, you enable concurrent batching."},{"content":"<bpt id=\"p1\">*</bpt>Service throttling<ept id=\"p1\">*</ept> is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service.","pos":[4599,4728],"source":"*Service throttling* is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service."},{"content":"When used with batching, this is interpreted as how many concurrent batches can be run.","pos":[4729,4816]},{"content":"If the service throttling is not set, WCF defaults the maximum concurrent calls to 16.","pos":[4817,4903]},{"content":"Thus, if batching behavior were added by default, a maximum of 16 batches can be active at the same time.","pos":[4904,5009]},{"content":"It is best to tune the service throttling and batching based on your capacity.","pos":[5010,5088]},{"content":"For example, if the queue has 100 messages and a batch of 20 is desired, having the maximum concurrent calls set to 16 is not useful because, depending on throughput, 16 transactions could be active, similar to not having batching turned on.","pos":[5089,5330]},{"content":"Therefore, when fine-tuning for performance, either do not have concurrent batching or have concurrent batching with the correct service throttle size.","pos":[5331,5482]},{"pos":[5491,5522],"content":"Batching and Multiple Endpoints","linkify":"Batching and Multiple Endpoints","nodes":[{"content":"Batching and Multiple Endpoints","pos":[0,31]}]},{"content":"An endpoint is composed of an address and a contract.","pos":[5526,5579]},{"content":"There may be multiple endpoints that share the same binding.","pos":[5580,5640]},{"content":"It is possible for two endpoints to share the same binding and listen Uniform Resource Identifier (URI), or queue address.","pos":[5641,5763]},{"content":"If two endpoints are reading from the same queue, and transacted batching behavior is added to both endpoints, a conflict in the batch sizes specified could arise.","pos":[5764,5927]},{"content":"This is resolved by implementing batching using the minimal batch size specified between the two transacted batching behaviors.","pos":[5928,6055]},{"content":"In this scenario, if one of the endpoints does not specify transacted batching, then both endpoints would not use batching.","pos":[6056,6179]},{"pos":[6188,6195],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[6199,6299],"content":"The following example shows how to specify the <ph id=\"ph1\">`TransactedBatchingBehavior`</ph> in a configuration file.","source":"The following example shows how to specify the `TransactedBatchingBehavior` in a configuration file."},{"pos":[6478,6599],"content":"The following example shows how to specify the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.TransactedBatchingBehavior&gt;</ph> in code.","source":"The following example shows how to specify the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in code."},{"pos":[7342,7350],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[7354,7438],"content":"<bpt id=\"p1\">[</bpt>Queues Overview<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/queues-overview.md)</ept>","source":"[Queues Overview](../../../../docs/framework/wcf/feature-details/queues-overview.md)"},{"pos":[7441,7523],"content":"<bpt id=\"p1\">[</bpt>Queuing in WCF<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/queuing-in-wcf.md)</ept>","source":"[Queuing in WCF](../../../../docs/framework/wcf/feature-details/queuing-in-wcf.md)"}]}