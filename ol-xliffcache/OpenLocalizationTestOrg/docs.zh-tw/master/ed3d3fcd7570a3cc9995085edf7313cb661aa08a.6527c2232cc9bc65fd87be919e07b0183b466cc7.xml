{"content":"---\ntitle: \"Using an Asynchronous Server Socket | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"VB\"\n  - \"CSharp\"\n  - \"C++\"\n  - \"jsharp\"\nhelpviewer_keywords: \n  - \"application protocols, sockets\"\n  - \"sending data, sockets\"\n  - \"Socket class, asynchronous server sockets\"\n  - \"data requests, sockets\"\n  - \"sockets, asynchronous server sockets\"\n  - \"requesting data from Internet, sockets\"\n  - \"server sockets\"\n  - \"receiving data, sockets\"\n  - \"asynchronous server sockets\"\n  - \"protocols, sockets\"\n  - \"Internet, sockets\"\nms.assetid: 813489a9-3efd-41b6-a33f-371d55397676\ncaps.latest.revision: 11\nauthor: \"mcleblanc\"\nms.author: \"markl\"\nmanager: \"markl\"\n---\n# Using an Asynchronous Server Socket\nAsynchronous server sockets use the .NET Framework asynchronous programming model to process network service requests. The <xref:System.Net.Sockets.Socket> class follows the standard .NET Framework asynchronous naming pattern; for example, the synchronous <xref:System.Net.Sockets.Socket.Accept%2A> method corresponds to the asynchronous <xref:System.Net.Sockets.Socket.BeginAccept%2A> and <xref:System.Net.Sockets.Socket.EndAccept%2A> methods.  \n  \n An asynchronous server socket requires a method to begin accepting connection requests from the network, a callback method to handle the connection requests and begin receiving data from the network, and a callback method to end receiving the data. All these methods are discussed further in this section.  \n  \n In the following example, to begin accepting connection requests from the network, the method `StartListening` initializes the **Socket** and then uses the **BeginAccept** method to start accepting new connections. The accept callback method is called when a new connection request is received on the socket. It is responsible for getting the **Socket** instance that will handle the connection and handing that **Socket** off to the thread that will process the request. The accept callback method implements the <xref:System.AsyncCallback> delegate; it returns a void and takes a single parameter of type <xref:System.IAsyncResult>. The following example is the shell of an accept callback method.  \n  \n```vb  \nSub acceptCallback(ar As IAsyncResult)  \n    ' Add the callback code here.  \nEnd Sub 'acceptCallback  \n```  \n  \n```csharp  \nvoid acceptCallback( IAsyncResult ar) {  \n    // Add the callback code here.  \n}  \n```  \n  \n The **BeginAccept** method takes two parameters, an **AsyncCallback** delegate that points to the accept callback method and an object that is used to pass state information to the callback method. In the following example, the listening **Socket** is passed to the callback method through the *state* parameter. This example creates an **AsyncCallback** delegate and starts accepting connections from the network.  \n  \n```vb  \nlistener.BeginAccept( _  \n    New AsyncCallback(SocketListener.acceptCallback),_  \n    listener)  \n```  \n  \n```csharp  \nlistener.BeginAccept(  \n    new AsyncCallback(SocketListener.acceptCallback),   \n    listener);  \n```  \n  \n Asynchronous sockets use threads from the system thread pool to process incoming connections. One thread is responsible for accepting connections, another thread is used to handle each incoming connection, and another thread is responsible for receiving data from the connection. These could be the same thread, depending on which thread is assigned by the thread pool. In the following example, the <xref:System.Threading.ManualResetEvent?displayProperty=fullName> class suspends execution of the main thread and signals when execution can continue.  \n  \n The following example shows an asynchronous method that creates an asynchronous TCP/IP socket on the local computer and begins accepting connections. It assumes that there is a global **ManualResetEvent** named `allDone`, that the method is a member of a class named `SocketListener`, and that a callback method named `acceptCallback` is defined.  \n  \n```vb  \nPublic Sub StartListening()  \n    Dim ipHostInfo As IPHostEntry = Dns.Resolve(Dns.GetHostName())  \n    Dim localEP = New IPEndPoint(ipHostInfo.AddressList(0), 11000)  \n  \n    Console.WriteLine(\"Local address and port : {0}\", localEP.ToString())  \n  \n    Dim listener As New Socket(localEP.Address.AddressFamily, _  \n       SocketType.Stream, ProtocolType.Tcp)  \n  \n    Try  \n        listener.Bind(localEP)  \n        listener.Listen(10)  \n  \n        While True  \n            allDone.Reset()  \n  \n            Console.WriteLine(\"Waiting for a connection...\")  \n            listener.BeginAccept(New _  \n                AsyncCallback(SocketListener.acceptCallback), _  \n                listener)  \n  \n            allDone.WaitOne()  \n        End While  \n    Catch e As Exception  \n        Console.WriteLine(e.ToString())  \n    End Try  \n    Console.WriteLine(\"Closing the listener...\")  \nEnd Sub 'StartListening  \n  \n```  \n  \n```csharp  \npublic void StartListening() {  \n    IPHostEntry ipHostInfo = Dns.Resolve(Dns.GetHostName());  \n    IPEndPoint localEP = new IPEndPoint(ipHostInfo.AddressList[0],11000);  \n  \n    Console.WriteLine(\"Local address and port : {0}\",localEP.ToString());  \n  \n    Socket listener = new Socket( localEP.Address.AddressFamily,  \n        SocketType.Stream, ProtocolType.Tcp );  \n  \n    try {  \n        listener.Bind(localEP);  \n        listener.Listen(10);  \n  \n        while (true) {  \n            allDone.Reset();  \n  \n            Console.WriteLine(\"Waiting for a connection...\");  \n            listener.BeginAccept(  \n                new AsyncCallback(SocketListener.acceptCallback),   \n                listener );  \n  \n            allDone.WaitOne();  \n        }  \n    } catch (Exception e) {  \n        Console.WriteLine(e.ToString());  \n    }  \n  \n    Console.WriteLine( \"Closing the listener...\");  \n}  \n```  \n  \n The accept callback method (`acceptCallback` in the preceding example) is responsible for signaling the main application thread to continue processing, establishing the connection with the client, and starting the asynchronous read of data from the client. The following example is the first part of an implementation of the `acceptCallback` method. This section of the method signals the main application thread to continue processing and establishes the connection to the client. It assumes a global **ManualResetEvent** named `allDone`.  \n  \n```vb  \nPublic Sub acceptCallback(ar As IAsyncResult)  \n    allDone.Set()  \n  \n    Dim listener As Socket = CType(ar.AsyncState, Socket)  \n    Dim handler As Socket = listener.EndAccept(ar)  \n  \n    ' Additional code to read data goes here.  \nEnd Sub 'acceptCallback  \n```  \n  \n```csharp  \npublic void acceptCallback(IAsyncResult ar) {  \n    allDone.Set();  \n  \n    Socket listener = (Socket) ar.AsyncState;  \n    Socket handler = listener.EndAccept(ar);  \n  \n    // Additional code to read data goes here.    \n}  \n```  \n  \n Reading data from a client socket requires a state object that passes values between asynchronous calls. The following example implements a state object for receiving a string from the remote client. It contains fields for the client socket, a data buffer for receiving data, and a <xref:System.Text.StringBuilder> for creating the data string sent by the client. Placing these fields in the state object allows their values to be preserved across multiple calls to read data from the client socket.  \n  \n```vb  \nPublic Class StateObject  \n    Public workSocket As Socket = Nothing  \n    Public BufferSize As Integer = 1024  \n    Public buffer(BufferSize) As Byte  \n    Public sb As New StringBuilder()  \nEnd Class 'StateObject  \n```  \n  \n```csharp  \npublic class StateObject {  \n    public Socket workSocket = null;  \n    public const int BufferSize = 1024;  \n    public byte[] buffer = new byte[BufferSize];  \n    public StringBuilder sb = new StringBuilder();  \n}  \n```  \n  \n The section of the `acceptCallback` method that starts receiving the data from the client socket first initializes an instance of the `StateObject` class and then calls the <xref:System.Net.Sockets.Socket.BeginReceive%2A> method to start reading the data from the client socket asynchronously.  \n  \n The following example shows the complete `acceptCallback` method. It assumes that there is a global **ManualResetEvent** named `allDone,` that the `StateObject` class is defined, and that the `readCallback` method is defined in a class named `SocketListener`.  \n  \n```vb  \nPublic Shared Sub acceptCallback(ar As IAsyncResult)  \n    ' Get the socket that handles the client request.  \n    Dim listener As Socket = CType(ar.AsyncState, Socket)  \n    Dim handler As Socket = listener.EndAccept(ar)  \n  \n    ' Signal the main thread to continue.  \n    allDone.Set()  \n  \n    ' Create the state object.  \n    Dim state As New StateObject()  \n    state.workSocket = handler  \n    handler.BeginReceive(state.buffer, 0, state.BufferSize, 0, _  \n        AddressOf AsynchronousSocketListener.readCallback, state)  \nEnd Sub 'acceptCallback  \n  \n```  \n  \n```csharp  \npublic static void acceptCallback(IAsyncResult ar) {  \n    // Get the socket that handles the client request.  \n    Socket listener = (Socket) ar.AsyncState;  \n    Socket handler = listener.EndAccept(ar);  \n  \n    // Signal the main thread to continue.  \n    allDone.Set();  \n  \n    // Create the state object.  \n    StateObject state = new StateObject();  \n    state.workSocket = handler;  \n    handler.BeginReceive( state.buffer, 0, StateObject.BufferSize, 0,  \n        new AsyncCallback(AsynchronousSocketListener.readCallback), state);  \n}  \n```  \n  \n The final method that needs to be implemented for the asynchronous socket server is the read callback method that returns the data sent by the client. Like the accept callback method, the read callback method is an **AsyncCallback** delegate. This method reads one or more bytes from the client socket into the data buffer and then calls the **BeginReceive** method again until the data sent by the client is complete. Once the entire message has been read from the client, the string is displayed on the console and the server socket handling the connection to the client is closed.  \n  \n The following sample implements the `readCallback` method. It assumes that the `StateObject` class is defined.  \n  \n```vb  \nPublic Shared Sub readCallback(ar As IAsyncResult)  \n    Dim state As StateObject = CType(ar.AsyncState, StateObject)  \n    Dim handler As Socket = state.workSocket  \n  \n    ' Read data from the client socket.   \n    Dim read As Integer = handler.EndReceive(ar)  \n  \n    ' Data was read from the client socket.  \n    If read > 0 Then  \n        state.sb.Append(Encoding.ASCII.GetString(state.buffer, 0, read))  \n        handler.BeginReceive(state.buffer, 0, state.BufferSize, 0, _  \n            AddressOf readCallback, state)  \n    Else  \n        If state.sb.Length > 1 Then  \n            ' All the data has been read from the client;  \n            ' display it on the console.  \n            Dim content As String = state.sb.ToString()  \n            Console.WriteLine(\"Read {0} bytes from socket.\" + _  \n                ControlChars.Cr + \" Data : {1}\", content.Length, content)  \n        End If  \n    End If  \nEnd Sub 'readCallback  \n  \n```  \n  \n```csharp  \npublic static void readCallback(IAsyncResult ar) {  \n    StateObject state = (StateObject) ar.AsyncState;  \n    Socket handler = state.WorkSocket;  \n  \n    // Read data from the client socket.  \n    int read = handler.EndReceive(ar);  \n  \n    // Data was read from the client socket.  \n    if (read > 0) {  \n        state.sb.Append(Encoding.ASCII.GetString(state.buffer,0,read));  \n        handler.BeginReceive(state.buffer,0,StateObject.BufferSize, 0,  \n            new AsyncCallback(readCallback), state);  \n    } else {  \n        if (state.sb.Length > 1) {  \n            // All the data has been read from the client;  \n            // display it on the console.  \n            string content = state.sb.ToString();  \n            Console.WriteLine(\"Read {0} bytes from socket.\\n Data : {1}\",  \n               content.Length, content);  \n        }  \n        handler.Close();  \n    }  \n}  \n```  \n  \n## See Also  \n [Using a Synchronous Server Socket](../../../docs/framework/network-programming/using-a-synchronous-server-socket.md)   \n [Asynchronous Server Socket Example](../../../docs/framework/network-programming/asynchronous-server-socket-example.md)   \n [Threading](../../../docs/standard/threading/index.md)   \n [Listening with Sockets](../../../docs/framework/network-programming/listening-with-sockets.md)","nodes":[{"pos":[12,64],"content":"Using an Asynchronous Server Socket | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Using an Asynchronous Server Socket | Microsoft Docs","pos":[0,52]}]},{"pos":[774,809],"content":"Using an Asynchronous Server Socket","linkify":"Using an Asynchronous Server Socket","nodes":[{"content":"Using an Asynchronous Server Socket","pos":[0,35]}]},{"content":"Asynchronous server sockets use the .NET Framework asynchronous programming model to process network service requests.","pos":[810,928]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net.Sockets.Socket&gt;</ph> class follows the standard .NET Framework asynchronous naming pattern; for example, the synchronous <ph id=\"ph2\">&lt;xref:System.Net.Sockets.Socket.Accept%2A&gt;</ph> method corresponds to the asynchronous <ph id=\"ph3\">&lt;xref:System.Net.Sockets.Socket.BeginAccept%2A&gt;</ph> and <ph id=\"ph4\">&lt;xref:System.Net.Sockets.Socket.EndAccept%2A&gt;</ph> methods.","pos":[929,1254],"source":" The <xref:System.Net.Sockets.Socket> class follows the standard .NET Framework asynchronous naming pattern; for example, the synchronous <xref:System.Net.Sockets.Socket.Accept%2A> method corresponds to the asynchronous <xref:System.Net.Sockets.Socket.BeginAccept%2A> and <xref:System.Net.Sockets.Socket.EndAccept%2A> methods."},{"content":"An asynchronous server socket requires a method to begin accepting connection requests from the network, a callback method to handle the connection requests and begin receiving data from the network, and a callback method to end receiving the data.","pos":[1261,1509]},{"content":"All these methods are discussed further in this section.","pos":[1510,1566]},{"content":"In the following example, to begin accepting connection requests from the network, the method <ph id=\"ph1\">`StartListening`</ph> initializes the <bpt id=\"p1\">**</bpt>Socket<ept id=\"p1\">**</ept> and then uses the <bpt id=\"p2\">**</bpt>BeginAccept<ept id=\"p2\">**</ept> method to start accepting new connections.","pos":[1573,1787],"source":"In the following example, to begin accepting connection requests from the network, the method `StartListening` initializes the **Socket** and then uses the **BeginAccept** method to start accepting new connections."},{"content":"The accept callback method is called when a new connection request is received on the socket.","pos":[1788,1881]},{"content":"It is responsible for getting the <bpt id=\"p1\">**</bpt>Socket<ept id=\"p1\">**</ept> instance that will handle the connection and handing that <bpt id=\"p2\">**</bpt>Socket<ept id=\"p2\">**</ept> off to the thread that will process the request.","pos":[1882,2044],"source":" It is responsible for getting the **Socket** instance that will handle the connection and handing that **Socket** off to the thread that will process the request."},{"content":"The accept callback method implements the <ph id=\"ph1\">&lt;xref:System.AsyncCallback&gt;</ph> delegate; it returns a void and takes a single parameter of type <ph id=\"ph2\">&lt;xref:System.IAsyncResult&gt;</ph>.","pos":[2045,2207],"source":" The accept callback method implements the <xref:System.AsyncCallback> delegate; it returns a void and takes a single parameter of type <xref:System.IAsyncResult>."},{"content":"The following example is the shell of an accept callback method.","pos":[2208,2272]},{"content":"The <bpt id=\"p1\">**</bpt>BeginAccept<ept id=\"p1\">**</ept> method takes two parameters, an <bpt id=\"p2\">**</bpt>AsyncCallback<ept id=\"p2\">**</ept> delegate that points to the accept callback method and an object that is used to pass state information to the callback method.","pos":[2503,2700],"source":"The **BeginAccept** method takes two parameters, an **AsyncCallback** delegate that points to the accept callback method and an object that is used to pass state information to the callback method."},{"content":"In the following example, the listening <bpt id=\"p1\">**</bpt>Socket<ept id=\"p1\">**</ept> is passed to the callback method through the <bpt id=\"p2\">*</bpt>state<ept id=\"p2\">*</ept> parameter.","pos":[2701,2815],"source":" In the following example, the listening **Socket** is passed to the callback method through the *state* parameter."},{"content":"This example creates an <bpt id=\"p1\">**</bpt>AsyncCallback<ept id=\"p1\">**</ept> delegate and starts accepting connections from the network.","pos":[2816,2917],"source":" This example creates an **AsyncCallback** delegate and starts accepting connections from the network."},{"content":"Asynchronous sockets use threads from the system thread pool to process incoming connections.","pos":[3159,3252]},{"content":"One thread is responsible for accepting connections, another thread is used to handle each incoming connection, and another thread is responsible for receiving data from the connection.","pos":[3253,3438]},{"content":"These could be the same thread, depending on which thread is assigned by the thread pool.","pos":[3439,3528]},{"content":"In the following example, the <ph id=\"ph1\">&lt;xref:System.Threading.ManualResetEvent?displayProperty=fullName&gt;</ph> class suspends execution of the main thread and signals when execution can continue.","pos":[3529,3709],"source":" In the following example, the <xref:System.Threading.ManualResetEvent?displayProperty=fullName> class suspends execution of the main thread and signals when execution can continue."},{"content":"The following example shows an asynchronous method that creates an asynchronous TCP/IP socket on the local computer and begins accepting connections.","pos":[3716,3865]},{"content":"It assumes that there is a global <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> named <ph id=\"ph1\">`allDone`</ph>, that the method is a member of a class named <ph id=\"ph2\">`SocketListener`</ph>, and that a callback method named <ph id=\"ph3\">`acceptCallback`</ph> is defined.","pos":[3866,4062],"source":" It assumes that there is a global **ManualResetEvent** named `allDone`, that the method is a member of a class named `SocketListener`, and that a callback method named `acceptCallback` is defined."},{"content":"The accept callback method (<ph id=\"ph1\">`acceptCallback`</ph> in the preceding example) is responsible for signaling the main application thread to continue processing, establishing the connection with the client, and starting the asynchronous read of data from the client.","pos":[5918,6174],"source":"The accept callback method (`acceptCallback` in the preceding example) is responsible for signaling the main application thread to continue processing, establishing the connection with the client, and starting the asynchronous read of data from the client."},{"content":"The following example is the first part of an implementation of the <ph id=\"ph1\">`acceptCallback`</ph> method.","pos":[6175,6267],"source":" The following example is the first part of an implementation of the `acceptCallback` method."},{"content":"This section of the method signals the main application thread to continue processing and establishes the connection to the client.","pos":[6268,6399]},{"content":"It assumes a global <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> named <ph id=\"ph1\">`allDone`</ph>.","pos":[6400,6457],"source":" It assumes a global **ManualResetEvent** named `allDone`."},{"content":"Reading data from a client socket requires a state object that passes values between asynchronous calls.","pos":[6988,7092]},{"content":"The following example implements a state object for receiving a string from the remote client.","pos":[7093,7187]},{"content":"It contains fields for the client socket, a data buffer for receiving data, and a <ph id=\"ph1\">&lt;xref:System.Text.StringBuilder&gt;</ph> for creating the data string sent by the client.","pos":[7188,7351],"source":" It contains fields for the client socket, a data buffer for receiving data, and a <xref:System.Text.StringBuilder> for creating the data string sent by the client."},{"content":"Placing these fields in the state object allows their values to be preserved across multiple calls to read data from the client socket.","pos":[7352,7487]},{"pos":[7967,8260],"content":"The section of the <ph id=\"ph1\">`acceptCallback`</ph> method that starts receiving the data from the client socket first initializes an instance of the <ph id=\"ph2\">`StateObject`</ph> class and then calls the <ph id=\"ph3\">&lt;xref:System.Net.Sockets.Socket.BeginReceive%2A&gt;</ph> method to start reading the data from the client socket asynchronously.","source":"The section of the `acceptCallback` method that starts receiving the data from the client socket first initializes an instance of the `StateObject` class and then calls the <xref:System.Net.Sockets.Socket.BeginReceive%2A> method to start reading the data from the client socket asynchronously."},{"content":"The following example shows the complete <ph id=\"ph1\">`acceptCallback`</ph> method.","pos":[8267,8332],"source":"The following example shows the complete `acceptCallback` method."},{"content":"It assumes that there is a global <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> named <ph id=\"ph1\">`allDone,`</ph> that the <ph id=\"ph2\">`StateObject`</ph> class is defined, and that the <ph id=\"ph3\">`readCallback`</ph> method is defined in a class named <ph id=\"ph4\">`SocketListener`</ph>.","pos":[8333,8526],"source":" It assumes that there is a global **ManualResetEvent** named `allDone,` that the `StateObject` class is defined, and that the `readCallback` method is defined in a class named `SocketListener`."},{"content":"The final method that needs to be implemented for the asynchronous socket server is the read callback method that returns the data sent by the client.","pos":[9678,9828]},{"content":"Like the accept callback method, the read callback method is an <bpt id=\"p1\">**</bpt>AsyncCallback<ept id=\"p1\">**</ept> delegate.","pos":[9829,9920],"source":" Like the accept callback method, the read callback method is an **AsyncCallback** delegate."},{"content":"This method reads one or more bytes from the client socket into the data buffer and then calls the <bpt id=\"p1\">**</bpt>BeginReceive<ept id=\"p1\">**</ept> method again until the data sent by the client is complete.","pos":[9921,10096],"source":" This method reads one or more bytes from the client socket into the data buffer and then calls the **BeginReceive** method again until the data sent by the client is complete."},{"content":"Once the entire message has been read from the client, the string is displayed on the console and the server socket handling the connection to the client is closed.","pos":[10097,10261]},{"content":"The following sample implements the <ph id=\"ph1\">`readCallback`</ph> method.","pos":[10268,10326],"source":"The following sample implements the `readCallback` method."},{"content":"It assumes that the <ph id=\"ph1\">`StateObject`</ph> class is defined.","pos":[10327,10378],"source":" It assumes that the `StateObject` class is defined."},{"pos":[12250,12258],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Using a Synchronous Server Socket<ept id=\"p1\">](../../../docs/framework/network-programming/using-a-synchronous-server-socket.md)</ept><ph id=\"ph1\"> </ph>","pos":[12262,12380],"source":"[Using a Synchronous Server Socket](../../../docs/framework/network-programming/using-a-synchronous-server-socket.md) "},{"content":"<bpt id=\"p1\"> [</bpt>Asynchronous Server Socket Example<ept id=\"p1\">](../../../docs/framework/network-programming/asynchronous-server-socket-example.md)</ept><ph id=\"ph1\"> </ph>","pos":[12383,12504],"source":" [Asynchronous Server Socket Example](../../../docs/framework/network-programming/asynchronous-server-socket-example.md) "},{"content":"<bpt id=\"p1\"> [</bpt>Threading<ept id=\"p1\">](../../../docs/standard/threading/index.md)</ept><ph id=\"ph1\"> </ph>","pos":[12507,12563],"source":" [Threading](../../../docs/standard/threading/index.md) "},{"content":"<bpt id=\"p1\"> [</bpt>Listening with Sockets<ept id=\"p1\">](../../../docs/framework/network-programming/listening-with-sockets.md)</ept>","pos":[12566,12662],"source":" [Listening with Sockets](../../../docs/framework/network-programming/listening-with-sockets.md)"}]}