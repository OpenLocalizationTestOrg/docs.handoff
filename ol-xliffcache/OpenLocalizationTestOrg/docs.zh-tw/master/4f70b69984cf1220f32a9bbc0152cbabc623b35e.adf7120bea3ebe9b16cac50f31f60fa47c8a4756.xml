{"content":"---\ntitle: \"Signing Stored Procedures in SQL Server | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-ado\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: eeed752c-0084-48e5-9dca-381353007a0d\ncaps.latest.revision: 6\nauthor: \"JennieHubbard\"\nms.author: \"jhubbard\"\nmanager: \"jhubbard\"\n---\n# Signing Stored Procedures in SQL Server\nYou can sign a stored procedure with a certificate or an asymmetric key. This is designed for scenarios when permissions cannot be inherited through ownership chaining or when the ownership chain is broken, such as dynamic SQL. You then create a user mapped to the certificate, granting the certificate user permissions on the objects the stored procedure needs to access.  \n  \n When the stored procedure is executed, SQL Server combines the permissions of the certificate user with those of the caller. Unlike the EXECUTE AS clause, it does not change the execution context of the procedure. Built-in functions that return login and user names return the name of the caller, not the certificate user name.  \n  \n A digital signature is a data digest encrypted with the private key of the signer. The private key ensures that the digital signature is unique to its bearer or owner. You can sign stored procedures, functions, or triggers.  \n  \n> [!NOTE]\n>  You can create a certificate in the master database to grant server-level permissions.  \n  \n## Creating Certificates  \n When you sign a stored procedure with a certificate, a data digest consisting of the encrypted hash of the stored procedure code is created using the private key. At run time, the data digest is decrypted with the public key and compared with the hash value of the stored procedure. Modifying the stored procedure invalidates the hash value so that the digital signature no longer matches. This prevents someone who does not have access to the private key from changing the stored procedure code. Therefore you must re-sign the procedure each time you modify it.  \n  \n There are four steps involved in signing a module:  \n  \n1.  Create a certificate using the Transact-SQL `CREATE CERTIFICATE [certificateName]` statement. This statement has several options for setting a start and end date and a password. The default expiration date is one year  \n  \n2.  Create a database user associated with that certificate using the Transact-SQL `CREATE USER [userName] FROM CERTIFICATE [certificateName]` statement. This user exists in the database only and is not associated with a login.  \n  \n3.  Grant the certificate user the required permissions on the database objects.  \n  \n> [!NOTE]\n>  A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement. DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.  \n  \n1.  Sign the procedure with the certificate using the Transact-SQL `ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]` statement.  \n  \n## External Resources  \n For more information, see the following resources.  \n  \n|Resource|Description|  \n|--------------|-----------------|  \n|[Module Signing](http://go.microsoft.com/fwlink/?LinkId=98590) in SQL Server Books Online|Describes module signing, providing a sample scenario and links to the relevant Transact-SQL topics.|  \n|[Signing Stored Procedures with a Certificate](http://msdn.microsoft.com/library/bb283630.aspx) in SQL Server Books Online|Provides a tutorial for signing a stored procedure with a certificate.|  \n  \n## See Also  \n [Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)   \n [Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)   \n [Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)   \n [Managing Permissions with Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)   \n [Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)   \n [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)   \n [Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)   \n [ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)","nodes":[{"pos":[4,370],"nodes":[{"content":"Signing Stored Procedures in SQL Server | Microsoft Docs","nodes":[{"pos":[0,56],"content":"Signing Stored Procedures in SQL Server | Microsoft Docs","nodes":[{"content":"Signing Stored Procedures in SQL Server | Microsoft Docs","pos":[0,56]}]}],"pos":[6,65],"yaml":true}],"content":"title: \"Signing Stored Procedures in SQL Server | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-ado\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: eeed752c-0084-48e5-9dca-381353007a0d\ncaps.latest.revision: 6\nauthor: \"JennieHubbard\"\nms.author: \"jhubbard\"\nmanager: \"jhubbard\"","yamlblock":true},{"pos":[377,416],"content":"Signing Stored Procedures in SQL Server","linkify":"Signing Stored Procedures in SQL Server","nodes":[{"content":"Signing Stored Procedures in SQL Server","pos":[0,39]}]},{"content":"You can sign a stored procedure with a certificate or an asymmetric key.","pos":[417,489]},{"content":"This is designed for scenarios when permissions cannot be inherited through ownership chaining or when the ownership chain is broken, such as dynamic SQL.","pos":[490,644]},{"content":"You then create a user mapped to the certificate, granting the certificate user permissions on the objects the stored procedure needs to access.","pos":[645,789]},{"content":"When the stored procedure is executed, SQL Server combines the permissions of the certificate user with those of the caller.","pos":[796,920]},{"content":"Unlike the EXECUTE AS clause, it does not change the execution context of the procedure.","pos":[921,1009]},{"content":"Built-in functions that return login and user names return the name of the caller, not the certificate user name.","pos":[1010,1123]},{"content":"A digital signature is a data digest encrypted with the private key of the signer.","pos":[1130,1212]},{"content":"The private key ensures that the digital signature is unique to its bearer or owner.","pos":[1213,1297]},{"content":"You can sign stored procedures, functions, or triggers.","pos":[1298,1353]},{"pos":[1361,1458],"content":"[!NOTE]\n You can create a certificate in the master database to grant server-level permissions.","leadings":["","> "],"nodes":[{"content":"You can create a certificate in the master database to grant server-level permissions.","pos":[9,95]}]},{"pos":[1467,1488],"content":"Creating Certificates","linkify":"Creating Certificates","nodes":[{"content":"Creating Certificates","pos":[0,21]}]},{"content":"When you sign a stored procedure with a certificate, a data digest consisting of the encrypted hash of the stored procedure code is created using the private key.","pos":[1492,1654]},{"content":"At run time, the data digest is decrypted with the public key and compared with the hash value of the stored procedure.","pos":[1655,1774]},{"content":"Modifying the stored procedure invalidates the hash value so that the digital signature no longer matches.","pos":[1775,1881]},{"content":"This prevents someone who does not have access to the private key from changing the stored procedure code.","pos":[1882,1988]},{"content":"Therefore you must re-sign the procedure each time you modify it.","pos":[1989,2054]},{"content":"There are four steps involved in signing a module:","pos":[2061,2111]},{"content":"Create a certificate using the Transact-SQL <ph id=\"ph1\">`CREATE CERTIFICATE [certificateName]`</ph> statement.","pos":[2121,2214],"source":"Create a certificate using the Transact-SQL `CREATE CERTIFICATE [certificateName]` statement."},{"content":"This statement has several options for setting a start and end date and a password.","pos":[2215,2298]},{"content":"The default expiration date is one year","pos":[2299,2338]},{"content":"Create a database user associated with that certificate using the Transact-SQL <ph id=\"ph1\">`CREATE USER [userName] FROM CERTIFICATE [certificateName]`</ph> statement.","pos":[2348,2497],"source":"Create a database user associated with that certificate using the Transact-SQL `CREATE USER [userName] FROM CERTIFICATE [certificateName]` statement."},{"content":"This user exists in the database only and is not associated with a login.","pos":[2498,2571]},{"content":"Grant the certificate user the required permissions on the database objects.","pos":[2581,2657]},{"pos":[2665,2907],"content":"[!NOTE]\n A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement. DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.","leadings":["","> "],"nodes":[{"content":"A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement. DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.","pos":[9,240],"nodes":[{"content":"A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement.","pos":[0,107]},{"content":"DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.","pos":[108,231]}]}]},{"pos":[2917,3058],"content":"Sign the procedure with the certificate using the Transact-SQL <ph id=\"ph1\">`ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]`</ph> statement.","source":"Sign the procedure with the certificate using the Transact-SQL `ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]` statement."},{"pos":[3067,3085],"content":"External Resources","linkify":"External Resources","nodes":[{"content":"External Resources","pos":[0,18]}]},{"content":"For more information, see the following resources.","pos":[3089,3139]},{"content":"Resource","pos":[3146,3154]},{"content":"Description","pos":[3155,3166]},{"pos":[3208,3297],"content":"<bpt id=\"p1\">[</bpt>Module Signing<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=98590)</ept> in SQL Server Books Online","source":"[Module Signing](http://go.microsoft.com/fwlink/?LinkId=98590) in SQL Server Books Online"},{"content":"Describes module signing, providing a sample scenario and links to the relevant Transact-SQL topics.","pos":[3298,3398]},{"pos":[3403,3525],"content":"<bpt id=\"p1\">[</bpt>Signing Stored Procedures with a Certificate<ept id=\"p1\">](http://msdn.microsoft.com/library/bb283630.aspx)</ept> in SQL Server Books Online","source":"[Signing Stored Procedures with a Certificate](http://msdn.microsoft.com/library/bb283630.aspx) in SQL Server Books Online"},{"content":"Provides a tutorial for signing a stored procedure with a certificate.","pos":[3526,3596]},{"pos":[3606,3614],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Securing ADO.NET Applications<ept id=\"p1\">](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</ept><ph id=\"ph1\"> </ph>","pos":[3618,3726],"source":"[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md) "},{"content":"<bpt id=\"p1\">[</bpt>Overview of SQL Server Security<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)</ept><ph id=\"ph1\"> </ph>","pos":[3730,3846],"source":"[Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md) "},{"content":"<bpt id=\"p1\">[</bpt>Application Security Scenarios in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)</ept><ph id=\"ph1\"> </ph>","pos":[3850,3992],"source":"[Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md) "},{"content":"<bpt id=\"p1\">[</bpt>Managing Permissions with Stored Procedures in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)</ept><ph id=\"ph1\"> </ph>","pos":[3996,4164],"source":"[Managing Permissions with Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md) "},{"content":"<bpt id=\"p1\">[</bpt>Writing Secure Dynamic SQL in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)</ept><ph id=\"ph1\"> </ph>","pos":[4168,4302],"source":"[Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md) "},{"content":"<bpt id=\"p1\">[</bpt>Customizing Permissions with Impersonation in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)</ept><ph id=\"ph1\"> </ph>","pos":[4306,4472],"source":"[Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md) "},{"content":"<bpt id=\"p1\">[</bpt>Modifying Data with Stored Procedures<ept id=\"p1\">](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)</ept><ph id=\"ph1\"> </ph>","pos":[4476,4600],"source":"[Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md) "},{"content":"<bpt id=\"p1\">[</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=217917)</ept>","pos":[4604,4707],"source":"[ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)"}]}