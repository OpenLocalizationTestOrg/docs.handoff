{"content":"---\ntitle: \"Troubleshooting Queued Messaging\"\nms.date: \"03/30/2017\"\nms.assetid: a5f2836f-018d-42f5-a571-1e97e64ea5b0\n---\n# Troubleshooting Queued Messaging\nThis section contains common questions and troubleshooting help for using queues in Windows Communication Foundation (WCF).  \n  \n## Common Questions  \n **Q:** I used WCF Beta 1 and I installed the MSMQ hotfix. Do I need to remove the hotfix?  \n  \n **A:** Yes. This hotfix is no longer supported. WCF now works on MSMQ without a hotfix requirement.  \n  \n **Q:** There are two bindings for MSMQ: <xref:System.ServiceModel.NetMsmqBinding> and <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>. What should I use and when?  \n  \n **A:** Use the <xref:System.ServiceModel.NetMsmqBinding> when you want to use MSMQ as a transport for queued communication between two WCF applications. Use the <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> when you want to use existing MSMQ applications to communicate with new WCF applications.  \n  \n **Q:** Do I have to upgrade MSMQ to use the <xref:System.ServiceModel.NetMsmqBinding> and `MsmqIntegration` bindings?  \n  \n **A:** No. Both bindings work with MSMQ 3.0 on [!INCLUDE[wxp](../../../../includes/wxp-md.md)] and [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)]. Certain features of the bindings become available when you upgrade to MSMQ 4.0 in [!INCLUDE[wv](../../../../includes/wv-md.md)].  \n  \n **Q:** What features of the <xref:System.ServiceModel.NetMsmqBinding> and <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> bindings are available in MSMQ 4.0 but not in MSMQ 3.0?  \n  \n **A:** The following features are available in MSMQ 4.0 but not in MSMQ 3.0:  \n  \n-   Custom dead-letter queue is supported only on MSMQ 4.0.  \n  \n-   MSMQ 3.0 and 4.0 handle poison messages differently.  \n  \n-   Only MSMQ 4.0 supports remote transacted read.  \n  \n For more information, see [Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md).  \n  \n **Q:** Can I use MSMQ 3.0 on one side of a queued communication and MSMQ 4.0 on the other side?  \n  \n **A:** Yes.  \n  \n **Q:** I want to integrate existing MSMQ applications with new WCF clients or servers. Do I need to upgrade both sides of my MSMQ infrastructure?  \n  \n **A:** No. You do not have to upgrade to MSMQ 4.0 on either side.  \n  \n## Troubleshooting  \n This section contains answers to most common troubleshooting issues. Some issues that are known limitations are also described in the release notes.  \n  \n **Q:** I am trying to use a private queue and I get the following exception: `System.InvalidOperationException`: The URL is invalid. The URL for the queue cannot contain the '$' character. Use the syntax in net.msmq://machine/private/queueName to address a private queue.  \n  \n **A:** Please check the queue Uniform Resource Identifier (URI) in your configuration and code. Do not use the \"$\" character in the URI. For example, to address a private queue named OrdersQueue, specify the URI as net.msmq://localhost/private/ordersQueue.  \n  \n **Q:** Calling `ServiceHost.Open()` on my queued application throws the following exception: `System.ArgumentException`: A base address cannot contain a URI query string. Why?  \n  \n **A:** Check the queue URI in your configuration file and in your code. While MSMQ queues support the use of the '?' character, URIs interpret this character as the beginning of a string query. To avoid this issue, use queue names that do not contain '?' characters.  \n  \n **Q:** My send succeeded but no service operation is invoked on the receiver. Why?  \n  \n **A:** To determine the answer, work through the following check list:  \n  \n-   Check that the transactional queue requirements are compatible with the assurances specified. Note the following principles:  \n  \n    -   You can send durable messages (datagrams and sessions) with \"exactly once\" assurances (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `true`) only to a transactional queue.  \n  \n    -   You can send sessions only with \"exactly once\" assurances.  \n  \n    -   A transaction is required to receive messages in a session from a transactional queue.  \n  \n    -   You can send or receive volatile or durable messages (datagrams only) with no assurances (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `false`) only to a non-transactional queue.  \n  \n-   Check the dead-letter queue. If you find the messages there, determine why they were not delivered.  \n  \n-   Check the outgoing queues for connectivity or addressing problems.  \n  \n **Q:** I have specified a custom dead-letter queue, but when I start the sender application, I get an exception that either the dead-letter queue is not found, or the sending application has no permission to the dead-letter queue. Why is this happening?  \n  \n **A:** The custom dead-letter queue URI must include a \"localhost\" or the computer name in the first segment, for example, net.msmq://localhost/private/myAppdead-letter queue.  \n  \n **Q:** Is it always necessary to define a custom dead-letter queue, or is there a default dead-letter queue?  \n  \n **A:** If assurances are \"exactly once\" (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `true`), and if you do not specify a custom dead-letter queue, the default is a system-wide transactional dead-letter queue.  \n  \n If assurances are none (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `false`), then the default is no dead-letter queue functionality.  \n  \n **Q:** My service throws on SvcHost.Open with a message \"EndpointListener requirements cannot be met by the ListenerFactory\". Why?  \n  \n A. Check your service contract. You may have forgotten to put \"IsOneWay=`true`\" on all the service operations. Queues support only one-way service operations.  \n  \n **Q:** There are messages in the queue but no service operation is invoked. What is the problem?  \n  \n **A:** Determine if your service host is faulted. You can check by looking at the trace or implementing `IErrorHandler`. Service host faults, by default, if a poison message is detected.  \n  \n **Q:** There are messages in the queue but my Web-hosted queued service is not getting activated. Why?  \n  \n **A:** The most common reason is permissions.  \n  \n1.  Ensure that the `NetMsmqActivator` process is running and the identity of the `NetMsmqActivator` process is given read and seek permission on the queue.  \n  \n2.  If the `NetMsmqActivator` is monitoring queues on a remote machine, ensure that `NetMsmqActivator` does not run under a restricted token. To run the `NetMsmqActivator` with an unrestricted token:  \n  \n    ```  \n    sc sidtype NetMsmqActivator unrestricted  \n    ```  \n  \n For non-security related Web host issues refer to: [Web Hosting a Queued Application](../../../../docs/framework/wcf/feature-details/web-hosting-a-queued-application.md).  \n  \n **Q:** What is the easiest way to access sessions?  \n  \n **A:** Set AutoComplete=`true` on the operation that corresponds to the last message in the session, and set AutoComplete=`false` on all remaining service operations.  \n  \n **Q:** Where can I find answers to common questions on MSMQ?  \n  \n **A:** For more information about MSMQ, see [Microsoft Message Queuing](https://go.microsoft.com/fwlink/?LinkId=87810).  \n  \n **Q:** Why does my service throw a `ProtocolException` when reading from a queue that contains both queued session messages and queued datagram messages?  \n  \n **A:** There is a fundamental difference in the way queued session messages and queued datagram messages are composed. Because of this, a service that is expecting to read a queued session message cannot receive a queued datagram message and a service expecting to read a queued datagram message cannot receive a session message. Attempting to read both types of messages from the same queue throws the following exception:  \n  \n```  \nSystem.ServiceModel.MsmqPoisonMessageException: The transport channel detected a poison message. This occurred because the message exceeded the maximum number of delivery attempts or because the channel detected a fundamental problem with the message. The inner exception may contain additional information.   \n---> System.ServiceModel.ProtocolException: An incoming MSMQ message contained invalid or unexpected .NET Message Framing information in its body. The message cannot be received. Ensure that the sender is using a compatible service contract with a matching SessionMode.  \n```  \n  \n The system dead-letter queue, as well as any custom dead-letter queue, is particularly susceptible to this issue if an application sends both queued session messages and queued datagram messages from the same computer. If a message cannot be sent successfully, it is moved to the dead-letter queue. Under these circumstances, it is possible to have both session and datagram messages in the dead-letter queue. There is no way to separate both types of messages at runtime when reading from a queue, therefore, applications should not send both queued session messages and queued datagram messages from the same computer.  \n  \n### MSMQ Integration: Specific Troubleshooting  \n **Q:** When I send a message, or when I open the service host, I get an error that indicates the scheme is wrong. Why?  \n  \n **A:** When you use the MSMQ integration binding, you must use the msmq.formatname scheme. For example, msmq.formatname:DIRECT=OS:.\\private$\\OrdersQueue. But when you specify the custom dead-letter queue, you must use the net.msmq scheme.  \n  \n **Q:** When I use a public or private format name and open the service host on [!INCLUDE[wv](../../../../includes/wv-md.md)], I get an error. Why?  \n  \n **A:** The WCF integration channel on [!INCLUDE[wv](../../../../includes/wv-md.md)] checks to see if a sub-queue can be opened for the main application queue for handling poison messages. The sub-queue name is derived from an msmq.formatname URI passed to the listener. The sub-queue name in MSMQ can only be a direct format name. So you see the error. Change the queue URI to a direct format name.  \n  \n **Q:** When receiving a message from an MSMQ application, the message sits in the queue and is not read by the receiving WCF application. Why?  \n  \n **A:** Check to see whether the message has a body. If the message has no body, the MSMQ integration channel ignores the message. Implement `IErrorHandler` to be notified of exceptions and check the traces.  \n  \n### Security-Related Troubleshooting  \n **Q:** When I run the sample that uses a default binding in workgroup mode, messages seem to get sent but are never received by the receiver.  \n  \n **A:** By default, messages are signed using an MSMQ internal certificate that requires the Active Directory directory service. In workgroup mode, because Active Directory is not available, signing the message fails. So the message lands in the dead-letter queue and failure cause, such as \"Bad signature\", is indicated.  \n  \n The workaround is to turn off security. This is done by setting <xref:System.ServiceModel.NetMsmqSecurity.Mode%2A> = <xref:System.ServiceModel.NetMsmqSecurityMode.None> to make it work in workgroup mode.  \n  \n Another workaround is to get the <xref:System.ServiceModel.MsmqTransportSecurity> from the <xref:System.ServiceModel.NetMsmqSecurity.Transport%2A> property and set it to <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>, and set the client certificate.  \n  \n Yet another workaround is to install MSMQ with Active Directory integration.  \n  \n **Q:** When I send a message with default binding (transport security turned on) in Active Directory to a queue, I get an \"internal certificate not found\" message. How do I fix this?  \n  \n **A:** This means that the certificate in Active Directory for the sender must be renewed. To do so, open **Control Panel**, **Administrative Tools**, **Computer Management**, right-click **MSMQ**, and select **Properties**. Select the **User Certificate** tab and click the **Renew** button.  \n  \n **Q:** When I send a message using <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate> and specify the certificate to use, I get an \"Invalid certificate\" message. How do I fix this?  \n  \n **A:** You cannot use a local machine certificate store with certificate mode. You have to copy the certificate from the machine certificate store to the current user store using the Certificate snap-in. To get the Certificate snap-in:  \n  \n1.  Click **Start**, select **Run**, type `mmc`, and click **OK**.  \n  \n2.  In the **Microsoft Management Console**, open the **File** menu and select **Add/Remove Snap-in**.  \n  \n3.  In the **Add/Remove Snap-in** dialog box, click the **Add** button.  \n  \n4.  In the **Add Standalone Snap-in** dialog box, select Certificates and click **Add**.  \n  \n5.  In the **Certificates** snap-in dialog box, select **My user account,** and click **Finish**.  \n  \n6.  Next, add a second Certificates snap-in using the previous steps, but this time select **Computer account** and click **Next**.  \n  \n7.  Select **Local Computer** and click **Finish**. You can now drag and drop certificates from the machine certificate store to the current user store.  \n  \n **Q:** When my service reads from a queue on another computer in workgroup mode, I get an \"access denied\" exception.  \n  \n **A:** In workgroup mode, for a remote application to gain access to the queue, the application must have permission to access the queue. Add \"Anonymous login\" to the queue's access control list (ACL) and give it read permission.  \n  \n **Q:** When a network service client (or any client that does not have a domain account) sends a queued message, the send fails with an invalid certificate. How do I fix this?  \n  \n **A:** Check the binding configuration. The default binding has MSMQ transport security turned on to sign the message. Turn it off.  \n  \n### Remote Transacted Receives  \n **Q:** When I have a queue on machine A, and a WCF service that reads messages from a queue on machine B (the remote transacted receive scenario), messages are not read from the queue. Tracing information indicates the receive failed with the message \"Transaction cannot be imported.\" What can I do to fix this?  \n  \n **A:** There are three possible reasons for this:  \n  \n-   If you are in domain mode, remote transacted receive requires Microsoft Distributed Transaction Coordinator (MSDTC) network access. You can enable this using **Add/Remove Components**.  \n  \n     ![Screenshot that shows enabling network DTC access.](./media/troubleshooting-queued-messaging/enable-distributed-transaction-coordinator-access.jpg)  \n  \n-   Check the authentication mode for communicating with the transaction manager. If you are in workgroup mode, \"No Authentication Required\" must be selected. If you are in domain mode, then \"Mutual Authentication Required\" must be selected.  \n  \n     ![Enabling XA transactions](../../../../docs/framework/wcf/feature-details/media/4f3695e0-fb0b-4c5b-afac-75f8860d2bb0.jpg \"4f3695e0-fb0b-4c5b-afac-75f8860d2bb0\")  \n  \n-   Make sure that MSDTC is in the list of exceptions in the **Internet Connection Firewall** settings.  \n  \n-   Ensure that you are using [!INCLUDE[wv](../../../../includes/wv-md.md)]. MSMQ on [!INCLUDE[wv](../../../../includes/wv-md.md)] supports remote transacted read. MSMQ on earlier Windows releases does not support remote transacted read.  \n  \n **Q:** When the service reading from the queue is a network service, for example, in a Web host, why do I get an access-denied exception is raised when reading from the queue?  \n  \n **A:** Network service read access must be added to the queue ACL to ensure that a network service can read from the queue.  \n  \n **Q:** Can I use the MSMQ activation service to activate applications based on messages in a queue on a remote machine?  \n  \n **A:** Yes. To do this, you must configure the MSMQ activation service to run as a network service, and add network service access to the queue on the remote machine.  \n  \n## Using Custom MSMQ Bindings with ReceiveContext Enabled  \n When using a custom MSMQ binding with <xref:System.ServiceModel.Channels.ReceiveContext> enabled processing an incoming message will use a thread pool thread because native MSMQ does not support I/O completion for asynchronous <xref:System.ServiceModel.Channels.ReceiveContext> receives. This is because processing such a message uses internal transactions for <xref:System.ServiceModel.Channels.ReceiveContext> and MSMQ does not support asynchronous processing. To work around this issue you can add a <xref:System.ServiceModel.Description.SynchronousReceiveBehavior> to the endpoint to force synchronous processing or set <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.MaxPendingReceives%2A> to 1.\n","nodes":[{"pos":[4,116],"embed":true,"restype":"x-metadata","content":"title: \"Troubleshooting Queued Messaging\"\nms.date: \"03/30/2017\"\nms.assetid: a5f2836f-018d-42f5-a571-1e97e64ea5b0","nodes":[{"content":"Troubleshooting Queued Messaging","nodes":[{"pos":[0,32],"content":"Troubleshooting Queued Messaging","nodes":[{"content":"Troubleshooting Queued Messaging","pos":[0,32]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[123,155],"content":"Troubleshooting Queued Messaging","linkify":"Troubleshooting Queued Messaging","nodes":[{"content":"Troubleshooting Queued Messaging","pos":[0,32]}]},{"content":"This section contains common questions and troubleshooting help for using queues in Windows Communication Foundation (WCF).","pos":[156,279]},{"pos":[288,304],"content":"Common Questions","linkify":"Common Questions","nodes":[{"content":"Common Questions","pos":[0,16]}]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> I used WCF Beta 1 and I installed the MSMQ hotfix.","pos":[308,365],"source":"**Q:** I used WCF Beta 1 and I installed the MSMQ hotfix."},{"content":"Do I need to remove the hotfix?","pos":[366,397]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Yes.","pos":[404,415],"source":"**A:** Yes."},{"content":"This hotfix is no longer supported.","pos":[416,451]},{"content":"WCF now works on MSMQ without a hotfix requirement.","pos":[452,503]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> There are two bindings for MSMQ: <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetMsmqBinding&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding&gt;</ph>.","pos":[510,662],"source":"**Q:** There are two bindings for MSMQ: <xref:System.ServiceModel.NetMsmqBinding> and <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>."},{"content":"What should I use and when?","pos":[663,690]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Use the <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetMsmqBinding&gt;</ph> when you want to use MSMQ as a transport for queued communication between two WCF applications.","pos":[697,849],"source":"**A:** Use the <xref:System.ServiceModel.NetMsmqBinding> when you want to use MSMQ as a transport for queued communication between two WCF applications."},{"content":"Use the <ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding&gt;</ph> when you want to use existing MSMQ applications to communicate with new WCF applications.","pos":[850,1013],"source":" Use the <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> when you want to use existing MSMQ applications to communicate with new WCF applications."},{"pos":[1020,1137],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Do I have to upgrade MSMQ to use the <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetMsmqBinding&gt;</ph> and <ph id=\"ph2\">`MsmqIntegration`</ph> bindings?","source":"**Q:** Do I have to upgrade MSMQ to use the <xref:System.ServiceModel.NetMsmqBinding> and `MsmqIntegration` bindings?"},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> No.","pos":[1144,1154],"source":"**A:** No."},{"content":"Both bindings work with MSMQ 3.0 on <ph id=\"ph1\">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[ws2003](../../../../includes/ws2003-md.md)]</ph>.","pos":[1155,1297],"source":" Both bindings work with MSMQ 3.0 on [!INCLUDE[wxp](../../../../includes/wxp-md.md)] and [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)]."},{"content":"Certain features of the bindings become available when you upgrade to MSMQ 4.0 in <ph id=\"ph1\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph>.","pos":[1298,1426],"source":" Certain features of the bindings become available when you upgrade to MSMQ 4.0 in [!INCLUDE[wv](../../../../includes/wv-md.md)]."},{"pos":[1433,1628],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> What features of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetMsmqBinding&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding&gt;</ph> bindings are available in MSMQ 4.0 but not in MSMQ 3.0?","source":"**Q:** What features of the <xref:System.ServiceModel.NetMsmqBinding> and <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> bindings are available in MSMQ 4.0 but not in MSMQ 3.0?"},{"pos":[1635,1711],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> The following features are available in MSMQ 4.0 but not in MSMQ 3.0:","source":"**A:** The following features are available in MSMQ 4.0 but not in MSMQ 3.0:"},{"content":"Custom dead-letter queue is supported only on MSMQ 4.0.","pos":[1721,1776]},{"content":"MSMQ 3.0 and 4.0 handle poison messages differently.","pos":[1786,1838]},{"content":"Only MSMQ 4.0 supports remote transacted read.","pos":[1848,1894]},{"pos":[1901,2112],"content":"For more information, see <bpt id=\"p1\">[</bpt>Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md)</ept>.","source":"For more information, see [Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md)."},{"pos":[2119,2214],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Can I use MSMQ 3.0 on one side of a queued communication and MSMQ 4.0 on the other side?","source":"**Q:** Can I use MSMQ 3.0 on one side of a queued communication and MSMQ 4.0 on the other side?"},{"pos":[2221,2232],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Yes.","source":"**A:** Yes."},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> I want to integrate existing MSMQ applications with new WCF clients or servers.","pos":[2239,2325],"source":"**Q:** I want to integrate existing MSMQ applications with new WCF clients or servers."},{"content":"Do I need to upgrade both sides of my MSMQ infrastructure?","pos":[2326,2384]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> No.","pos":[2391,2401],"source":"**A:** No."},{"content":"You do not have to upgrade to MSMQ 4.0 on either side.","pos":[2402,2456]},{"pos":[2465,2480],"content":"Troubleshooting","linkify":"Troubleshooting","nodes":[{"content":"Troubleshooting","pos":[0,15]}]},{"content":"This section contains answers to most common troubleshooting issues.","pos":[2484,2552]},{"content":"Some issues that are known limitations are also described in the release notes.","pos":[2553,2632]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> I am trying to use a private queue and I get the following exception: <ph id=\"ph1\">`System.InvalidOperationException`</ph>: The URL is invalid.","pos":[2639,2771],"source":"**Q:** I am trying to use a private queue and I get the following exception: `System.InvalidOperationException`: The URL is invalid."},{"content":"The URL for the queue cannot contain the '$' character.","pos":[2772,2827]},{"content":"Use the syntax in net.msmq://machine/private/queueName to address a private queue.","pos":[2828,2910]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Please check the queue Uniform Resource Identifier (URI) in your configuration and code.","pos":[2917,3012],"source":"**A:** Please check the queue Uniform Resource Identifier (URI) in your configuration and code."},{"content":"Do not use the \"$\" character in the URI.","pos":[3013,3053]},{"content":"For example, to address a private queue named OrdersQueue, specify the URI as net.msmq://localhost/private/ordersQueue.","pos":[3054,3173]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Calling <ph id=\"ph1\">`ServiceHost.Open()`</ph> on my queued application throws the following exception: <ph id=\"ph2\">`System.ArgumentException`</ph>: A base address cannot contain a URI query string.","pos":[3180,3350],"source":"**Q:** Calling `ServiceHost.Open()` on my queued application throws the following exception: `System.ArgumentException`: A base address cannot contain a URI query string."},{"content":"Why?","pos":[3351,3355]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Check the queue URI in your configuration file and in your code.","pos":[3362,3433],"source":"**A:** Check the queue URI in your configuration file and in your code."},{"content":"While MSMQ queues support the use of the '?' character, URIs interpret this character as the beginning of a string query.","pos":[3434,3555]},{"content":"To avoid this issue, use queue names that do not contain '?' characters.","pos":[3556,3628]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> My send succeeded but no service operation is invoked on the receiver.","pos":[3635,3712],"source":"**Q:** My send succeeded but no service operation is invoked on the receiver."},{"content":"Why?","pos":[3713,3717]},{"pos":[3724,3794],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> To determine the answer, work through the following check list:","source":"**A:** To determine the answer, work through the following check list:"},{"content":"Check that the transactional queue requirements are compatible with the assurances specified.","pos":[3804,3897]},{"content":"Note the following principles:","pos":[3898,3928]},{"pos":[3942,4127],"content":"You can send durable messages (datagrams and sessions) with \"exactly once\" assurances (<ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A&gt;</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`true`</ph>) only to a transactional queue.","source":"You can send durable messages (datagrams and sessions) with \"exactly once\" assurances (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `true`) only to a transactional queue."},{"content":"You can send sessions only with \"exactly once\" assurances.","pos":[4141,4199]},{"content":"A transaction is required to receive messages in a session from a transactional queue.","pos":[4213,4299]},{"pos":[4313,4506],"content":"You can send or receive volatile or durable messages (datagrams only) with no assurances (<ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A&gt;</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`false`</ph>) only to a non-transactional queue.","source":"You can send or receive volatile or durable messages (datagrams only) with no assurances (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `false`) only to a non-transactional queue."},{"content":"Check the dead-letter queue.","pos":[4516,4544]},{"content":"If you find the messages there, determine why they were not delivered.","pos":[4545,4615]},{"content":"Check the outgoing queues for connectivity or addressing problems.","pos":[4625,4691]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> I have specified a custom dead-letter queue, but when I start the sender application, I get an exception that either the dead-letter queue is not found, or the sending application has no permission to the dead-letter queue.","pos":[4698,4928],"source":"**Q:** I have specified a custom dead-letter queue, but when I start the sender application, I get an exception that either the dead-letter queue is not found, or the sending application has no permission to the dead-letter queue."},{"content":"Why is this happening?","pos":[4929,4951]},{"pos":[4958,5133],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> The custom dead-letter queue URI must include a \"localhost\" or the computer name in the first segment, for example, net.msmq://localhost/private/myAppdead-letter queue.","source":"**A:** The custom dead-letter queue URI must include a \"localhost\" or the computer name in the first segment, for example, net.msmq://localhost/private/myAppdead-letter queue."},{"pos":[5140,5248],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Is it always necessary to define a custom dead-letter queue, or is there a default dead-letter queue?","source":"**Q:** Is it always necessary to define a custom dead-letter queue, or is there a default dead-letter queue?"},{"pos":[5255,5480],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> If assurances are \"exactly once\" (<ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A&gt;</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`true`</ph>), and if you do not specify a custom dead-letter queue, the default is a system-wide transactional dead-letter queue.","source":"**A:** If assurances are \"exactly once\" (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `true`), and if you do not specify a custom dead-letter queue, the default is a system-wide transactional dead-letter queue."},{"pos":[5487,5636],"content":"If assurances are none (<ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A&gt;</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">`false`</ph>), then the default is no dead-letter queue functionality.","source":"If assurances are none (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `false`), then the default is no dead-letter queue functionality."},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> My service throws on SvcHost.Open with a message \"EndpointListener requirements cannot be met by the ListenerFactory\".","pos":[5643,5768],"source":"**Q:** My service throws on SvcHost.Open with a message \"EndpointListener requirements cannot be met by the ListenerFactory\"."},{"content":"Why?","pos":[5769,5773]},{"content":"A.","pos":[5780,5782]},{"content":"Check your service contract.","pos":[5783,5811]},{"content":"You may have forgotten to put \"IsOneWay=<ph id=\"ph1\">`true`</ph>\" on all the service operations.","pos":[5812,5890],"source":" You may have forgotten to put \"IsOneWay=`true`\" on all the service operations."},{"content":"Queues support only one-way service operations.","pos":[5891,5938]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> There are messages in the queue but no service operation is invoked.","pos":[5945,6020],"source":"**Q:** There are messages in the queue but no service operation is invoked."},{"content":"What is the problem?","pos":[6021,6041]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Determine if your service host is faulted.","pos":[6048,6097],"source":"**A:** Determine if your service host is faulted."},{"content":"You can check by looking at the trace or implementing <ph id=\"ph1\">`IErrorHandler`</ph>.","pos":[6098,6168],"source":" You can check by looking at the trace or implementing `IErrorHandler`."},{"content":"Service host faults, by default, if a poison message is detected.","pos":[6169,6234]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> There are messages in the queue but my Web-hosted queued service is not getting activated.","pos":[6241,6338],"source":"**Q:** There are messages in the queue but my Web-hosted queued service is not getting activated."},{"content":"Why?","pos":[6339,6343]},{"pos":[6350,6395],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> The most common reason is permissions.","source":"**A:** The most common reason is permissions."},{"pos":[6405,6557],"content":"Ensure that the <ph id=\"ph1\">`NetMsmqActivator`</ph> process is running and the identity of the <ph id=\"ph2\">`NetMsmqActivator`</ph> process is given read and seek permission on the queue.","source":"Ensure that the `NetMsmqActivator` process is running and the identity of the `NetMsmqActivator` process is given read and seek permission on the queue."},{"content":"If the <ph id=\"ph1\">`NetMsmqActivator`</ph> is monitoring queues on a remote machine, ensure that <ph id=\"ph2\">`NetMsmqActivator`</ph> does not run under a restricted token.","pos":[6567,6704],"source":"If the `NetMsmqActivator` is monitoring queues on a remote machine, ensure that `NetMsmqActivator` does not run under a restricted token."},{"content":"To run the <ph id=\"ph1\">`NetMsmqActivator`</ph> with an unrestricted token:","pos":[6705,6762],"source":" To run the `NetMsmqActivator` with an unrestricted token:"},{"pos":[6839,7009],"content":"For non-security related Web host issues refer to: <bpt id=\"p1\">[</bpt>Web Hosting a Queued Application<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/web-hosting-a-queued-application.md)</ept>.","source":"For non-security related Web host issues refer to: [Web Hosting a Queued Application](../../../../docs/framework/wcf/feature-details/web-hosting-a-queued-application.md)."},{"pos":[7016,7066],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> What is the easiest way to access sessions?","source":"**Q:** What is the easiest way to access sessions?"},{"pos":[7073,7239],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Set AutoComplete=<ph id=\"ph1\">`true`</ph> on the operation that corresponds to the last message in the session, and set AutoComplete=<ph id=\"ph2\">`false`</ph> on all remaining service operations.","source":"**A:** Set AutoComplete=`true` on the operation that corresponds to the last message in the session, and set AutoComplete=`false` on all remaining service operations."},{"pos":[7246,7306],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Where can I find answers to common questions on MSMQ?","source":"**Q:** Where can I find answers to common questions on MSMQ?"},{"pos":[7313,7432],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> For more information about MSMQ, see <bpt id=\"p2\">[</bpt>Microsoft Message Queuing<ept id=\"p2\">](https://go.microsoft.com/fwlink/?LinkId=87810)</ept>.","source":"**A:** For more information about MSMQ, see [Microsoft Message Queuing](https://go.microsoft.com/fwlink/?LinkId=87810)."},{"pos":[7439,7592],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Why does my service throw a <ph id=\"ph1\">`ProtocolException`</ph> when reading from a queue that contains both queued session messages and queued datagram messages?","source":"**Q:** Why does my service throw a `ProtocolException` when reading from a queue that contains both queued session messages and queued datagram messages?"},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> There is a fundamental difference in the way queued session messages and queued datagram messages are composed.","pos":[7599,7717],"source":"**A:** There is a fundamental difference in the way queued session messages and queued datagram messages are composed."},{"content":"Because of this, a service that is expecting to read a queued session message cannot receive a queued datagram message and a service expecting to read a queued datagram message cannot receive a session message.","pos":[7718,7928]},{"content":"Attempting to read both types of messages from the same queue throws the following exception:","pos":[7929,8022]},{"content":"The system dead-letter queue, as well as any custom dead-letter queue, is particularly susceptible to this issue if an application sends both queued session messages and queued datagram messages from the same computer.","pos":[8627,8845]},{"content":"If a message cannot be sent successfully, it is moved to the dead-letter queue.","pos":[8846,8925]},{"content":"Under these circumstances, it is possible to have both session and datagram messages in the dead-letter queue.","pos":[8926,9036]},{"content":"There is no way to separate both types of messages at runtime when reading from a queue, therefore, applications should not send both queued session messages and queued datagram messages from the same computer.","pos":[9037,9247]},{"pos":[9257,9299],"content":"MSMQ Integration: Specific Troubleshooting","linkify":"MSMQ Integration: Specific Troubleshooting","nodes":[{"content":"MSMQ Integration: Specific Troubleshooting","pos":[0,42]}]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When I send a message, or when I open the service host, I get an error that indicates the scheme is wrong.","pos":[9303,9416],"source":"**Q:** When I send a message, or when I open the service host, I get an error that indicates the scheme is wrong."},{"content":"Why?","pos":[9417,9421]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> When you use the MSMQ integration binding, you must use the msmq.formatname scheme.","pos":[9428,9518],"source":"**A:** When you use the MSMQ integration binding, you must use the msmq.formatname scheme."},{"content":"For example, msmq.formatname:DIRECT=OS:.\\private$\\OrdersQueue.","pos":[9519,9581]},{"content":"But when you specify the custom dead-letter queue, you must use the net.msmq scheme.","pos":[9582,9666]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When I use a public or private format name and open the service host on <ph id=\"ph1\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph>, I get an error.","pos":[9673,9814],"source":"**Q:** When I use a public or private format name and open the service host on [!INCLUDE[wv](../../../../includes/wv-md.md)], I get an error."},{"content":"Why?","pos":[9815,9819]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> The WCF integration channel on <ph id=\"ph1\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph> checks to see if a sub-queue can be opened for the main application queue for handling poison messages.","pos":[9826,10013],"source":"**A:** The WCF integration channel on [!INCLUDE[wv](../../../../includes/wv-md.md)] checks to see if a sub-queue can be opened for the main application queue for handling poison messages."},{"content":"The sub-queue name is derived from an msmq.formatname URI passed to the listener.","pos":[10014,10095]},{"content":"The sub-queue name in MSMQ can only be a direct format name.","pos":[10096,10156]},{"content":"So you see the error.","pos":[10157,10178]},{"content":"Change the queue URI to a direct format name.","pos":[10179,10224]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When receiving a message from an MSMQ application, the message sits in the queue and is not read by the receiving WCF application.","pos":[10231,10368],"source":"**Q:** When receiving a message from an MSMQ application, the message sits in the queue and is not read by the receiving WCF application."},{"content":"Why?","pos":[10369,10373]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Check to see whether the message has a body.","pos":[10380,10431],"source":"**A:** Check to see whether the message has a body."},{"content":"If the message has no body, the MSMQ integration channel ignores the message.","pos":[10432,10509]},{"content":"Implement <ph id=\"ph1\">`IErrorHandler`</ph> to be notified of exceptions and check the traces.","pos":[10510,10586],"source":" Implement `IErrorHandler` to be notified of exceptions and check the traces."},{"pos":[10596,10628],"content":"Security-Related Troubleshooting","linkify":"Security-Related Troubleshooting","nodes":[{"content":"Security-Related Troubleshooting","pos":[0,32]}]},{"pos":[10632,10773],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When I run the sample that uses a default binding in workgroup mode, messages seem to get sent but are never received by the receiver.","source":"**Q:** When I run the sample that uses a default binding in workgroup mode, messages seem to get sent but are never received by the receiver."},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> By default, messages are signed using an MSMQ internal certificate that requires the Active Directory directory service.","pos":[10780,10907],"source":"**A:** By default, messages are signed using an MSMQ internal certificate that requires the Active Directory directory service."},{"content":"In workgroup mode, because Active Directory is not available, signing the message fails.","pos":[10908,10996]},{"content":"So the message lands in the dead-letter queue and failure cause, such as \"Bad signature\", is indicated.","pos":[10997,11100]},{"content":"The workaround is to turn off security.","pos":[11107,11146]},{"content":"This is done by setting <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetMsmqSecurity.Mode%2A&gt;</ph><ph id=\"ph2\"> = </ph><ph id=\"ph3\">&lt;xref:System.ServiceModel.NetMsmqSecurityMode.None&gt;</ph> to make it work in workgroup mode.","pos":[11147,11310],"source":" This is done by setting <xref:System.ServiceModel.NetMsmqSecurity.Mode%2A> = <xref:System.ServiceModel.NetMsmqSecurityMode.None> to make it work in workgroup mode."},{"pos":[11317,11581],"content":"Another workaround is to get the <ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqTransportSecurity&gt;</ph> from the <ph id=\"ph2\">&lt;xref:System.ServiceModel.NetMsmqSecurity.Transport%2A&gt;</ph> property and set it to <ph id=\"ph3\">&lt;xref:System.ServiceModel.MsmqAuthenticationMode.Certificate&gt;</ph>, and set the client certificate.","source":"Another workaround is to get the <xref:System.ServiceModel.MsmqTransportSecurity> from the <xref:System.ServiceModel.NetMsmqSecurity.Transport%2A> property and set it to <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>, and set the client certificate."},{"content":"Yet another workaround is to install MSMQ with Active Directory integration.","pos":[11588,11664]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When I send a message with default binding (transport security turned on) in Active Directory to a queue, I get an \"internal certificate not found\" message.","pos":[11671,11834],"source":"**Q:** When I send a message with default binding (transport security turned on) in Active Directory to a queue, I get an \"internal certificate not found\" message."},{"content":"How do I fix this?","pos":[11835,11853]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> This means that the certificate in Active Directory for the sender must be renewed.","pos":[11860,11950],"source":"**A:** This means that the certificate in Active Directory for the sender must be renewed."},{"content":"To do so, open <bpt id=\"p1\">**</bpt>Control Panel<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Administrative Tools<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Computer Management<ept id=\"p3\">**</ept>, right-click <bpt id=\"p4\">**</bpt>MSMQ<ept id=\"p4\">**</ept>, and select <bpt id=\"p5\">**</bpt>Properties<ept id=\"p5\">**</ept>.","pos":[11951,12084],"source":" To do so, open **Control Panel**, **Administrative Tools**, **Computer Management**, right-click **MSMQ**, and select **Properties**."},{"content":"Select the <bpt id=\"p1\">**</bpt>User Certificate<ept id=\"p1\">**</ept> tab and click the <bpt id=\"p2\">**</bpt>Renew<ept id=\"p2\">**</ept> button.","pos":[12085,12152],"source":" Select the **User Certificate** tab and click the **Renew** button."},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When I send a message using <ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqAuthenticationMode.Certificate&gt;</ph> and specify the certificate to use, I get an \"Invalid certificate\" message.","pos":[12159,12331],"source":"**Q:** When I send a message using <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate> and specify the certificate to use, I get an \"Invalid certificate\" message."},{"content":"How do I fix this?","pos":[12332,12350]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> You cannot use a local machine certificate store with certificate mode.","pos":[12357,12435],"source":"**A:** You cannot use a local machine certificate store with certificate mode."},{"content":"You have to copy the certificate from the machine certificate store to the current user store using the Certificate snap-in.","pos":[12436,12560]},{"content":"To get the Certificate snap-in:","pos":[12561,12592]},{"pos":[12602,12664],"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>Run<ept id=\"p2\">**</ept>, type <ph id=\"ph1\">`mmc`</ph>, and click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>.","source":"Click **Start**, select **Run**, type `mmc`, and click **OK**."},{"pos":[12674,12772],"content":"In the <bpt id=\"p1\">**</bpt>Microsoft Management Console<ept id=\"p1\">**</ept>, open the <bpt id=\"p2\">**</bpt>File<ept id=\"p2\">**</ept> menu and select <bpt id=\"p3\">**</bpt>Add/Remove Snap-in<ept id=\"p3\">**</ept>.","source":"In the **Microsoft Management Console**, open the **File** menu and select **Add/Remove Snap-in**."},{"pos":[12782,12849],"content":"In the <bpt id=\"p1\">**</bpt>Add/Remove Snap-in<ept id=\"p1\">**</ept> dialog box, click the <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept> button.","source":"In the **Add/Remove Snap-in** dialog box, click the **Add** button."},{"pos":[12859,12943],"content":"In the <bpt id=\"p1\">**</bpt>Add Standalone Snap-in<ept id=\"p1\">**</ept> dialog box, select Certificates and click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept>.","source":"In the **Add Standalone Snap-in** dialog box, select Certificates and click **Add**."},{"pos":[12953,13046],"content":"In the <bpt id=\"p1\">**</bpt>Certificates<ept id=\"p1\">**</ept> snap-in dialog box, select <bpt id=\"p2\">**</bpt>My user account,<ept id=\"p2\">**</ept> and click <bpt id=\"p3\">**</bpt>Finish<ept id=\"p3\">**</ept>.","source":"In the **Certificates** snap-in dialog box, select **My user account,** and click **Finish**."},{"pos":[13056,13183],"content":"Next, add a second Certificates snap-in using the previous steps, but this time select <bpt id=\"p1\">**</bpt>Computer account<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.","source":"Next, add a second Certificates snap-in using the previous steps, but this time select **Computer account** and click **Next**."},{"content":"Select <bpt id=\"p1\">**</bpt>Local Computer<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>Finish<ept id=\"p2\">**</ept>.","pos":[13193,13240],"source":"Select **Local Computer** and click **Finish**."},{"content":"You can now drag and drop certificates from the machine certificate store to the current user store.","pos":[13241,13341]},{"pos":[13348,13464],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When my service reads from a queue on another computer in workgroup mode, I get an \"access denied\" exception.","source":"**Q:** When my service reads from a queue on another computer in workgroup mode, I get an \"access denied\" exception."},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> In workgroup mode, for a remote application to gain access to the queue, the application must have permission to access the queue.","pos":[13471,13608],"source":"**A:** In workgroup mode, for a remote application to gain access to the queue, the application must have permission to access the queue."},{"content":"Add \"Anonymous login\" to the queue's access control list (ACL) and give it read permission.","pos":[13609,13700]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When a network service client (or any client that does not have a domain account) sends a queued message, the send fails with an invalid certificate.","pos":[13707,13863],"source":"**Q:** When a network service client (or any client that does not have a domain account) sends a queued message, the send fails with an invalid certificate."},{"content":"How do I fix this?","pos":[13864,13882]},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Check the binding configuration.","pos":[13889,13928],"source":"**A:** Check the binding configuration."},{"content":"The default binding has MSMQ transport security turned on to sign the message.","pos":[13929,14007]},{"content":"Turn it off.","pos":[14008,14020]},{"pos":[14030,14056],"content":"Remote Transacted Receives","linkify":"Remote Transacted Receives","nodes":[{"content":"Remote Transacted Receives","pos":[0,26]}]},{"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When I have a queue on machine A, and a WCF service that reads messages from a queue on machine B (the remote transacted receive scenario), messages are not read from the queue.","pos":[14060,14244],"source":"**Q:** When I have a queue on machine A, and a WCF service that reads messages from a queue on machine B (the remote transacted receive scenario), messages are not read from the queue."},{"content":"Tracing information indicates the receive failed with the message \"Transaction cannot be imported.\"","pos":[14245,14344]},{"content":"What can I do to fix this?","pos":[14345,14371]},{"pos":[14378,14427],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> There are three possible reasons for this:","source":"**A:** There are three possible reasons for this:"},{"content":"If you are in domain mode, remote transacted receive requires Microsoft Distributed Transaction Coordinator (MSDTC) network access.","pos":[14437,14568]},{"content":"You can enable this using <bpt id=\"p1\">**</bpt>Add/Remove Components<ept id=\"p1\">**</ept>.","pos":[14569,14621],"source":" You can enable this using **Add/Remove Components**."},{"content":"Screenshot that shows enabling network DTC access.","pos":[14634,14684]},{"content":"Check the authentication mode for communicating with the transaction manager.","pos":[14791,14868]},{"content":"If you are in workgroup mode, \"No Authentication Required\" must be selected.","pos":[14869,14945]},{"content":"If you are in domain mode, then \"Mutual Authentication Required\" must be selected.","pos":[14946,15028]},{"pos":[15039,15200],"content":"<bpt id=\"p1\">![</bpt>Enabling XA transactions<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/4f3695e0-fb0b-4c5b-afac-75f8860d2bb0.jpg \"</bpt>4f3695e0-fb0b-4c5b-afac-75f8860d2bb0<ept id=\"p2\">\")</ept>","source":"![Enabling XA transactions](../../../../docs/framework/wcf/feature-details/media/4f3695e0-fb0b-4c5b-afac-75f8860d2bb0.jpg \"4f3695e0-fb0b-4c5b-afac-75f8860d2bb0\")"},{"pos":[15210,15309],"content":"Make sure that MSDTC is in the list of exceptions in the <bpt id=\"p1\">**</bpt>Internet Connection Firewall<ept id=\"p1\">**</ept> settings.","source":"Make sure that MSDTC is in the list of exceptions in the **Internet Connection Firewall** settings."},{"content":"Ensure that you are using <ph id=\"ph1\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph>.","pos":[15319,15391],"source":"Ensure that you are using [!INCLUDE[wv](../../../../includes/wv-md.md)]."},{"content":"MSMQ on <ph id=\"ph1\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph> supports remote transacted read.","pos":[15392,15478],"source":" MSMQ on [!INCLUDE[wv](../../../../includes/wv-md.md)] supports remote transacted read."},{"content":"MSMQ on earlier Windows releases does not support remote transacted read.","pos":[15479,15552]},{"pos":[15559,15734],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> When the service reading from the queue is a network service, for example, in a Web host, why do I get an access-denied exception is raised when reading from the queue?","source":"**Q:** When the service reading from the queue is a network service, for example, in a Web host, why do I get an access-denied exception is raised when reading from the queue?"},{"pos":[15741,15864],"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Network service read access must be added to the queue ACL to ensure that a network service can read from the queue.","source":"**A:** Network service read access must be added to the queue ACL to ensure that a network service can read from the queue."},{"pos":[15871,15990],"content":"<bpt id=\"p1\">**</bpt>Q:<ept id=\"p1\">**</ept> Can I use the MSMQ activation service to activate applications based on messages in a queue on a remote machine?","source":"**Q:** Can I use the MSMQ activation service to activate applications based on messages in a queue on a remote machine?"},{"content":"<bpt id=\"p1\">**</bpt>A:<ept id=\"p1\">**</ept> Yes.","pos":[15997,16008],"source":"**A:** Yes."},{"content":"To do this, you must configure the MSMQ activation service to run as a network service, and add network service access to the queue on the remote machine.","pos":[16009,16163]},{"pos":[16172,16226],"content":"Using Custom MSMQ Bindings with ReceiveContext Enabled","linkify":"Using Custom MSMQ Bindings with ReceiveContext Enabled","nodes":[{"content":"Using Custom MSMQ Bindings with ReceiveContext Enabled","pos":[0,54]}]},{"content":"When using a custom MSMQ binding with <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ReceiveContext&gt;</ph> enabled processing an incoming message will use a thread pool thread because native MSMQ does not support I/O completion for asynchronous <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.ReceiveContext&gt;</ph> receives.","pos":[16230,16517],"source":"When using a custom MSMQ binding with <xref:System.ServiceModel.Channels.ReceiveContext> enabled processing an incoming message will use a thread pool thread because native MSMQ does not support I/O completion for asynchronous <xref:System.ServiceModel.Channels.ReceiveContext> receives."},{"content":"This is because processing such a message uses internal transactions for <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ReceiveContext&gt;</ph> and MSMQ does not support asynchronous processing.","pos":[16518,16692],"source":" This is because processing such a message uses internal transactions for <xref:System.ServiceModel.Channels.ReceiveContext> and MSMQ does not support asynchronous processing."},{"content":"To work around this issue you can add a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.SynchronousReceiveBehavior&gt;</ph> to the endpoint to force synchronous processing or set <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.MaxPendingReceives%2A&gt;</ph> to 1.","pos":[16693,16954],"source":" To work around this issue you can add a <xref:System.ServiceModel.Description.SynchronousReceiveBehavior> to the endpoint to force synchronous processing or set <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.MaxPendingReceives%2A> to 1."}]}