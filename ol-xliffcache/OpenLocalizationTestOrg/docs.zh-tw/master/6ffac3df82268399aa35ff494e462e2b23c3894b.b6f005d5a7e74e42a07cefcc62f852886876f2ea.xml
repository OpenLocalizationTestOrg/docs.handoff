{"content":"---\ntitle: \"How to: Write a Parallel.For Loop with Thread-Local Variables\"\nms.date: \"03/30/2017\"\nms.technology: dotnet-standard\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"parallel for loops, how to use local state\"\nms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# How to: Write a Parallel.For Loop with Thread-Local Variables\nThis example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop. By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state. Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete. You can then write the final result once to the shared resource, or pass it to another method.  \n  \n## Example  \n The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements. The value of each element is equal to its index.  \n  \n [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]\n [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  \n  \n The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values. In this overload of the method, the third parameter is where you initialize your local state. In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.  \n  \n The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state. Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>. The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state. In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero. If the generic type argument is a reference type or user-defined value type, the expression would look like this:  \n  \n```csharp  \n() => new MyClass()  \n```  \n  \n```vb  \nFunction() new MyClass()  \n```  \n  \n The fourth parameter defines the loop logic. It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic. The first parameter is the value of the loop counter for that iteration of the loop. The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop. The third parameter is the thread-local variable. The last parameter is the return type. In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument. That variable is named `subtotal` and is returned by the lambda expression. The return value is used to initialize `subtotal` on each subsequent iteration of the loop. You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.  \n  \n The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed. The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression. In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method. By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.  \n  \n For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).  \n  \n## See also\n\n- [Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)\n- [Parallel Programming](../../../docs/standard/parallel-programming/index.md)\n- [Task Parallel Library (TPL)](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)\n- [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)\n","nodes":[{"pos":[4,321],"embed":true,"restype":"x-metadata","content":"title: \"How to: Write a Parallel.For Loop with Thread-Local Variables\"\nms.date: \"03/30/2017\"\nms.technology: dotnet-standard\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"parallel for loops, how to use local state\"\nms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"How to: Write a Parallel.For Loop with Thread-Local Variables","nodes":[{"pos":[0,61],"content":"How to: Write a Parallel.For Loop with Thread-Local Variables","nodes":[{"content":"How to: Write a Parallel.For Loop with Thread-Local Variables","pos":[0,61]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[328,389],"content":"How to: Write a Parallel.For Loop with Thread-Local Variables","linkify":"How to: Write a Parallel.For Loop with Thread-Local Variables","nodes":[{"content":"How to: Write a Parallel.For Loop with Thread-Local Variables","pos":[0,61]}]},{"content":"This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%2A&gt;</ph> loop.","pos":[390,565],"source":"This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop."},{"content":"By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.","pos":[566,681]},{"content":"Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.","pos":[682,820]},{"content":"You can then write the final result once to the shared resource, or pass it to another method.","pos":[821,915]},{"pos":[924,931],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following example calls the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29&gt;</ph> method to calculate the sum of the values in an array that contains one million elements.","pos":[935,1290],"source":"The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements."},{"content":"The value of each element is equal to its index.","pos":[1291,1339]},{"content":"The first two parameters of every <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%2A&gt;</ph> method specify the beginning and ending iteration values.","pos":[1604,1741],"source":"The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values."},{"content":"In this overload of the method, the third parameter is where you initialize your local state.","pos":[1742,1835]},{"content":"In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.","pos":[1836,2010]},{"content":"The type of the third parameter is a <ph id=\"ph1\">&lt;xref:System.Func%601&gt;</ph> where <ph id=\"ph2\">`TResult`</ph> is the type of the variable that will store the thread-local state.","pos":[2017,2160],"source":"The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state."},{"content":"Its type is defined by the generic type argument supplied when calling the generic <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29&gt;</ph> method, which in this case is <ph id=\"ph2\">&lt;xref:System.Int64&gt;</ph>.","pos":[2161,2528],"source":" Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>."},{"content":"The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.","pos":[2529,2651]},{"content":"In this example, the expression <ph id=\"ph1\">`() =&gt; 0`</ph> (or <ph id=\"ph2\">`Function() 0`</ph> in Visual Basic) initializes the thread-local variable to zero.","pos":[2652,2776],"source":" In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero."},{"content":"If the generic type argument is a reference type or user-defined value type, the expression would look like this:","pos":[2777,2890]},{"content":"The fourth parameter defines the loop logic.","pos":[2984,3028]},{"content":"It must be a delegate or lambda expression whose signature is <ph id=\"ph1\">`Func&lt;int, ParallelLoopState, long, long&gt;`</ph> in C# or <ph id=\"ph2\">`Func(Of Integer, ParallelLoopState, Long, Long)`</ph> in Visual Basic.","pos":[3029,3209],"source":" It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic."},{"content":"The first parameter is the value of the loop counter for that iteration of the loop.","pos":[3210,3294]},{"content":"The second is a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.ParallelLoopState&gt;</ph> object that can be used to break out of the loop; this object is provided by the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Parallel&gt;</ph> class to each occurrence of the loop.","pos":[3295,3516],"source":" The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop."},{"content":"The third parameter is the thread-local variable.","pos":[3517,3566]},{"content":"The last parameter is the return type.","pos":[3567,3605]},{"content":"In this case, the type is <ph id=\"ph1\">&lt;xref:System.Int64&gt;</ph> because that is the type we specified in the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Parallel.For%2A&gt;</ph> type argument.","pos":[3606,3757],"source":" In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument."},{"content":"That variable is named <ph id=\"ph1\">`subtotal`</ph> and is returned by the lambda expression.","pos":[3758,3833],"source":" That variable is named `subtotal` and is returned by the lambda expression."},{"content":"The return value is used to initialize <ph id=\"ph1\">`subtotal`</ph> on each subsequent iteration of the loop.","pos":[3834,3925],"source":" The return value is used to initialize `subtotal` on each subsequent iteration of the loop."},{"content":"You can also think of this last parameter as a value that is passed to each iteration, and then passed to the <ph id=\"ph1\">`localFinally`</ph> delegate when the last iteration is complete.","pos":[3926,4096],"source":" You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete."},{"content":"The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.","pos":[4103,4226]},{"content":"The type of the input argument again corresponds to the type argument of the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29&gt;</ph> method and the type returned by the body lambda expression.","pos":[4227,4597],"source":" The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression."},{"content":"In this example, the value is added to a variable at class scope in a thread safe way by calling the <ph id=\"ph1\">&lt;xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType&gt;</ph> method.","pos":[4598,4778],"source":" In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method."},{"content":"By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.","pos":[4779,4891]},{"pos":[4898,5082],"content":"For more information about how to use lambda expressions, see <bpt id=\"p1\">[</bpt>Lambda Expressions in PLINQ and TPL<ept id=\"p1\">](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)</ept>.","source":"For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)."},{"pos":[5091,5099],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[5103,5208],"content":"<bpt id=\"p1\">[</bpt>Data Parallelism<ept id=\"p1\">](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)</ept>","source":"[Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)"},{"pos":[5211,5287],"content":"<bpt id=\"p1\">[</bpt>Parallel Programming<ept id=\"p1\">](../../../docs/standard/parallel-programming/index.md)</ept>","source":"[Parallel Programming](../../../docs/standard/parallel-programming/index.md)"},{"pos":[5290,5393],"content":"<bpt id=\"p1\">[</bpt>Task Parallel Library (TPL)<ept id=\"p1\">](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)</ept>","source":"[Task Parallel Library (TPL)](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)"},{"pos":[5396,5517],"content":"<bpt id=\"p1\">[</bpt>Lambda Expressions in PLINQ and TPL<ept id=\"p1\">](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)</ept>","source":"[Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)"}]}