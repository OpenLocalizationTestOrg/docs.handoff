{"content":"---\ntitle: \"Transaction Rollback | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 7f377147-7529-4689-a588-608cee87fdf8\ncaps.latest.revision: 9\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Transaction Rollback\nThis sample shows how to create a custom <xref:System.Activities.NativeActivity> that accesses the ambient <xref:System.Activities.RuntimeTransactionHandle> to get the ambient transaction and explicitly roll it back.  \n  \n## Sample Details  \n In workflow, a transaction is automatically completed when the outermost <xref:System.Activities.Statements.TransactionScope> or <xref:System.ServiceModel.Activities.TransactedReceiveScope> completes.  A transaction implicitly rolls back when an unhandled exception propagates across the scope boundary. However, there may be times when it makes sense to explicitly roll back a transaction without having to throw an exception. In this case, you can use the custom rollback activity like the one in this sample to explicitly abort the ambient transaction and provide an optional exception reason.  \n  \n The `RollbackActivity` is a <xref:System.Activities.NativeActivity> as it requires access to the execution properties to get the ambient <xref:System.Activities.RuntimeTransactionHandle>. In the `Execute` method, it obtains the <xref:System.Activities.RuntimeTransactionHandle> and checks whether it is `null`, which indicates that the activity was used without an ambient run-time transaction. It then obtains the transaction, again checking whether `null` is present. It is possible to have an ambient <xref:System.Activities.RuntimeTransactionHandle> without ever initializing a run-time transaction. Finally it aborts the transaction by calling <xref:System.Transactions.Transaction.Rollback%2A> and specifying either a user-provided exception or a generic exception that states that the activity rolled back the transaction.  \n  \n The demonstration workflow consists of a <xref:System.Activities.Statements.TransactionScope> whose body prints the transaction status before and after the `RollbackActivity` executes. Note that even though the transaction has been rolled back, the <xref:System.Activities.Statements.TransactionScope> executes to completion and does not abort the workflow until the body completes. The workflow is aborted because the <xref:System.Activities.Statements.TransactionScope.AbortInstanceOnTransactionFailure%2A> property defaults to `true`.  \n  \n#### To use this sample  \n  \n1.  Load the TransactionRollback.sln solution in [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)].  \n  \n2.  Press CTRL+SHIFT+B to build the solution.  \n  \n3.  Press CTRL+F5 to run the application.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WF\\Scenario\\Transactions\\TransactionRollback`  \n  \n## See Also  \n [Transactions](../../../../docs/framework/windows-workflow-foundation/workflow-transactions.md)","nodes":[{"pos":[12,49],"content":"Transaction Rollback | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Transaction Rollback | Microsoft Docs","pos":[0,37]}]},{"pos":[314,334],"content":"Transaction Rollback","linkify":"Transaction Rollback","nodes":[{"content":"Transaction Rollback","pos":[0,20]}]},{"content":"This sample shows how to create a custom <ph id=\"ph1\">&lt;xref:System.Activities.NativeActivity&gt;</ph> that accesses the ambient <ph id=\"ph2\">&lt;xref:System.Activities.RuntimeTransactionHandle&gt;</ph> to get the ambient transaction and explicitly roll it back.","pos":[335,551],"source":"This sample shows how to create a custom <xref:System.Activities.NativeActivity> that accesses the ambient <xref:System.Activities.RuntimeTransactionHandle> to get the ambient transaction and explicitly roll it back."},{"pos":[560,574],"content":"Sample Details","linkify":"Sample Details","nodes":[{"content":"Sample Details","pos":[0,14]}]},{"content":"In workflow, a transaction is automatically completed when the outermost <ph id=\"ph1\">&lt;xref:System.Activities.Statements.TransactionScope&gt;</ph> or <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.TransactedReceiveScope&gt;</ph> completes.","pos":[578,778],"source":"In workflow, a transaction is automatically completed when the outermost <xref:System.Activities.Statements.TransactionScope> or <xref:System.ServiceModel.Activities.TransactedReceiveScope> completes."},{"content":"A transaction implicitly rolls back when an unhandled exception propagates across the scope boundary.","pos":[780,881]},{"content":"However, there may be times when it makes sense to explicitly roll back a transaction without having to throw an exception.","pos":[882,1005]},{"content":"In this case, you can use the custom rollback activity like the one in this sample to explicitly abort the ambient transaction and provide an optional exception reason.","pos":[1006,1174]},{"content":"The <ph id=\"ph1\">`RollbackActivity`</ph> is a <ph id=\"ph2\">&lt;xref:System.Activities.NativeActivity&gt;</ph> as it requires access to the execution properties to get the ambient <ph id=\"ph3\">&lt;xref:System.Activities.RuntimeTransactionHandle&gt;</ph>.","pos":[1181,1368],"source":"The `RollbackActivity` is a <xref:System.Activities.NativeActivity> as it requires access to the execution properties to get the ambient <xref:System.Activities.RuntimeTransactionHandle>."},{"content":"In the <ph id=\"ph1\">`Execute`</ph> method, it obtains the <ph id=\"ph2\">&lt;xref:System.Activities.RuntimeTransactionHandle&gt;</ph> and checks whether it is <ph id=\"ph3\">`null`</ph>, which indicates that the activity was used without an ambient run-time transaction.","pos":[1369,1575],"source":" In the `Execute` method, it obtains the <xref:System.Activities.RuntimeTransactionHandle> and checks whether it is `null`, which indicates that the activity was used without an ambient run-time transaction."},{"content":"It then obtains the transaction, again checking whether <ph id=\"ph1\">`null`</ph> is present.","pos":[1576,1650],"source":" It then obtains the transaction, again checking whether `null` is present."},{"content":"It is possible to have an ambient <ph id=\"ph1\">&lt;xref:System.Activities.RuntimeTransactionHandle&gt;</ph> without ever initializing a run-time transaction.","pos":[1651,1784],"source":" It is possible to have an ambient <xref:System.Activities.RuntimeTransactionHandle> without ever initializing a run-time transaction."},{"content":"Finally it aborts the transaction by calling <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.Rollback%2A&gt;</ph> and specifying either a user-provided exception or a generic exception that states that the activity rolled back the transaction.","pos":[1785,2010],"source":" Finally it aborts the transaction by calling <xref:System.Transactions.Transaction.Rollback%2A> and specifying either a user-provided exception or a generic exception that states that the activity rolled back the transaction."},{"content":"The demonstration workflow consists of a <ph id=\"ph1\">&lt;xref:System.Activities.Statements.TransactionScope&gt;</ph> whose body prints the transaction status before and after the <ph id=\"ph2\">`RollbackActivity`</ph> executes.","pos":[2017,2201],"source":"The demonstration workflow consists of a <xref:System.Activities.Statements.TransactionScope> whose body prints the transaction status before and after the `RollbackActivity` executes."},{"content":"Note that even though the transaction has been rolled back, the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.TransactionScope&gt;</ph> executes to completion and does not abort the workflow until the body completes.","pos":[2202,2399],"source":" Note that even though the transaction has been rolled back, the <xref:System.Activities.Statements.TransactionScope> executes to completion and does not abort the workflow until the body completes."},{"content":"The workflow is aborted because the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.TransactionScope.AbortInstanceOnTransactionFailure%2A&gt;</ph> property defaults to <ph id=\"ph2\">`true`</ph>.","pos":[2400,2554],"source":" The workflow is aborted because the <xref:System.Activities.Statements.TransactionScope.AbortInstanceOnTransactionFailure%2A> property defaults to `true`."},{"pos":[2565,2583],"content":"To use this sample","linkify":"To use this sample","nodes":[{"content":"To use this sample","pos":[0,18]}]},{"pos":[2593,2692],"content":"Load the TransactionRollback.sln solution in <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph>.","source":"Load the TransactionRollback.sln solution in [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]."},{"content":"Press CTRL+SHIFT+B to build the solution.","pos":[2702,2743]},{"content":"Press CTRL+F5 to run the application.","pos":[2753,2790]},{"pos":[2798,2930],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":" The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[13,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[1,54]},{"content":"Check for the following (default) directory before continuing.","pos":[55,117]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[2984,3310],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[3311,3361]},{"pos":[3458,3466],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[3470,3565],"content":"<bpt id=\"p1\">[</bpt>Transactions<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/workflow-transactions.md)</ept>","source":"[Transactions](../../../../docs/framework/windows-workflow-foundation/workflow-transactions.md)"}]}