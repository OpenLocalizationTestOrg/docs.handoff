{"content":"---\ntitle: \"Custom Message Filter\"\nms.date: \"03/30/2017\"\nms.assetid: 98dd0af8-fce6-4255-ac32-42eb547eea67\n---\n# Custom Message Filter\nThis sample demonstrates how to replace the message filters that Windows Communication Foundation (WCF) uses to dispatch messages to endpoints.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n When the first message on a channel arrives at the server, the server must determine which (if any) of the endpoints associated with that URI should receive the message. This process is controlled by the <xref:System.ServiceModel.Dispatcher.MessageFilter> objects attached to the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>.  \n  \n Each endpoint of a service has a single <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>. The <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> has both an <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> and a <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A>. The union of these two filters is the message filter used for that endpoint.  \n  \n By default, the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> for an endpoint matches any message that is addressed to an address that matches the service endpoint's <xref:System.ServiceModel.EndpointAddress>. By default, the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A> for an endpoint inspects the action of the incoming message and matches any message with an action that corresponds to one of the actions of the service endpoint contract's operations (only `IsInitiating`=`true` actions are considered). As a result, by default, the filter for an endpoint only matches if both the message's To header is the <xref:System.ServiceModel.EndpointAddress> of the endpoint and the message's action matches one of the endpoint operation's actions.  \n  \n These filters can be changed using a behavior. In the sample, the service creates an <xref:System.ServiceModel.Description.IEndpointBehavior> that replaces the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> and <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A> on the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>:  \n  \n```  \nclass FilteringEndpointBehavior : IEndpointBehavior …  \n```  \n  \n Two address filters are defined:  \n  \n```  \n// Matches any message whose To address contains the letter 'e'  \nclass MatchEAddressFilter : MessageFilter …  \n// Matches any message whose To address does not contain the letter 'e'  \nclass MatchNoEAddressFilter : MessageFilter  \n```  \n  \n The `FilteringEndpointBehavior` is made configurable and allows for two different variations.  \n  \n```  \npublic class FilteringEndpointBehaviorExtension : BehaviorExtensionElement  \n```  \n  \n Variation 1 matches only addresses that contain an 'e' (but that have any Action) whereas Variation 2 matches only addresses that lack an 'e':  \n  \n```  \nif (Variation == 1)  \n    return new FilteringEndpointBehavior(  \n        new MatchEAddressFilter(), new MatchAllMessageFilter());  \nelse  \n    return new FilteringEndpointBehavior(  \n        new MatchNoEAddressFilter(), new MatchAllMessageFilter());  \n```  \n  \n In the configuration file, the service registers the new behavior:  \n  \n```xml  \n<extensions>  \n    <behaviorExtensions>  \n        <add name=\"filteringEndpointBehavior\" type=\"Microsoft.ServiceModel.Samples.FilteringEndpointBehaviorExtension, service\" />  \n    </behaviorExtensions>  \n</extensions>      \n```  \n  \n Then the service creates `endpointBehavior` configurations for each variation:  \n  \n```xml  \n<endpointBehaviors>  \n    <behavior name=\"endpoint1\">  \n        <filteringEndpointBehavior variation=\"1\" />  \n    </behavior>  \n    <behavior name=\"endpoint2\">  \n        <filteringEndpointBehavior variation=\"2\" />  \n    </behavior>  \n</endpointBehaviors>  \n```  \n  \n Finally, the service's endpoint references one of the `behaviorConfigurations`:  \n  \n```xml  \n<endpoint address=\"\"  \n        bindingConfiguration=\"ws\"  \n        listenUri=\"\"   \n        binding=\"wsHttpBinding\"  \n        contract=\"Microsoft.ServiceModel.Samples.IHello\"   \n        behaviorConfiguration=\"endpoint2\" />  \n```  \n  \n The implementation of the client application is straightforward; it creates two channels to the service's URI (by passing in that value as the second (`via`) parameter to <xref:System.ServiceModel.Channels.IChannelFactory%601.CreateChannel%28System.ServiceModel.EndpointAddress%29> and sends a single message on each channel, but it uses different endpoint addresses for each. As a result, the outbound messages from the client have different To designations, and the server responds accordingly, as demonstrated by the client's output:  \n  \n```  \nSending message to urn:e...  \nException: The message with To 'urn:e' cannot be processed at the receiver, due to an AddressFilter mismatch at the EndpointDispatcher.  Check that the sender and receiver's EndpointAddresses agree.  \n  \nSending message to urn:a...  \nHello  \n```  \n  \n Switching the variation in the server's configuration file causes the filter to be swapped and the client sees the opposite behavior (the message to `urn:e` succeeds, whereas the message to `urn:a` fails).  \n  \n```xml  \n<endpoint address=\"\"  \n          bindingConfiguration=\"ws\"  \n          listenUri=\"\"   \n          binding=\"wsHttpBinding\"  \n          contract=\"Microsoft.ServiceModel.Samples.IHello\"   \n          behaviorConfiguration=\"endpoint1\" />  \n```  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Extensibility\\MessageFilter`  \n  \n### To set up, build, and run the sample  \n  \n1.  To build the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n2.  To run the sample in a single-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).  \n  \n3.  To run the sample in a cross-machine configuration, follow the instructions at [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md) and change the following line in Client.cs.  \n  \n    ```  \n    Uri serviceVia = new Uri(\"http://localhost/ServiceModelSamples/service.svc\");  \n    ```  \n  \n     Replace localhost with the name of server.  \n  \n    ```  \n    Uri serviceVia = new Uri(\"http://servermachinename/ServiceModelSamples/service.svc\");  \n    ```  \n","nodes":[{"pos":[4,105],"embed":true,"restype":"x-metadata","content":"title: \"Custom Message Filter\"\nms.date: \"03/30/2017\"\nms.assetid: 98dd0af8-fce6-4255-ac32-42eb547eea67","nodes":[{"content":"Custom Message Filter","nodes":[{"pos":[0,21],"content":"Custom Message Filter","nodes":[{"content":"Custom Message Filter","pos":[0,21]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[112,133],"content":"Custom Message Filter","linkify":"Custom Message Filter","nodes":[{"content":"Custom Message Filter","pos":[0,21]}]},{"content":"This sample demonstrates how to replace the message filters that Windows Communication Foundation (WCF) uses to dispatch messages to endpoints.","pos":[134,277]},{"pos":[285,392],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"content":"When the first message on a channel arrives at the server, the server must determine which (if any) of the endpoints associated with that URI should receive the message.","pos":[399,568]},{"content":"This process is controlled by the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.MessageFilter&gt;</ph> objects attached to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher&gt;</ph>.","pos":[569,736],"source":" This process is controlled by the <xref:System.ServiceModel.Dispatcher.MessageFilter> objects attached to the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>."},{"content":"Each endpoint of a service has a single <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher&gt;</ph>.","pos":[743,840],"source":"Each endpoint of a service has a single <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher&gt;</ph> has both an <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A&gt;</ph> and a <ph id=\"ph3\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A&gt;</ph>.","pos":[841,1069],"source":" The <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> has both an <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> and a <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A>."},{"content":"The union of these two filters is the message filter used for that endpoint.","pos":[1070,1146]},{"content":"By default, the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A&gt;</ph> for an endpoint matches any message that is addressed to an address that matches the service endpoint's <ph id=\"ph2\">&lt;xref:System.ServiceModel.EndpointAddress&gt;</ph>.","pos":[1153,1390],"source":"By default, the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> for an endpoint matches any message that is addressed to an address that matches the service endpoint's <xref:System.ServiceModel.EndpointAddress>."},{"content":"By default, the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A&gt;</ph> for an endpoint inspects the action of the incoming message and matches any message with an action that corresponds to one of the actions of the service endpoint contract's operations (only <ph id=\"ph2\">`IsInitiating`</ph><ph id=\"ph3\">=</ph><ph id=\"ph4\">`true`</ph> actions are considered).","pos":[1391,1718],"source":" By default, the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A> for an endpoint inspects the action of the incoming message and matches any message with an action that corresponds to one of the actions of the service endpoint contract's operations (only `IsInitiating`=`true` actions are considered)."},{"content":"As a result, by default, the filter for an endpoint only matches if both the message's To header is the <ph id=\"ph1\">&lt;xref:System.ServiceModel.EndpointAddress&gt;</ph> of the endpoint and the message's action matches one of the endpoint operation's actions.","pos":[1719,1955],"source":" As a result, by default, the filter for an endpoint only matches if both the message's To header is the <xref:System.ServiceModel.EndpointAddress> of the endpoint and the message's action matches one of the endpoint operation's actions."},{"content":"These filters can be changed using a behavior.","pos":[1962,2008]},{"content":"In the sample, the service creates an <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.IEndpointBehavior&gt;</ph> that replaces the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A&gt;</ph> on the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Dispatcher.EndpointDispatcher&gt;</ph>:","pos":[2009,2339],"source":" In the sample, the service creates an <xref:System.ServiceModel.Description.IEndpointBehavior> that replaces the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> and <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A> on the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>:"},{"content":"Two address filters are defined:","pos":[2417,2449]},{"pos":[2703,2796],"content":"The <ph id=\"ph1\">`FilteringEndpointBehavior`</ph> is made configurable and allows for two different variations.","source":"The `FilteringEndpointBehavior` is made configurable and allows for two different variations."},{"content":"Variation 1 matches only addresses that contain an 'e' (but that have any Action) whereas Variation 2 matches only addresses that lack an 'e':","pos":[2895,3037]},{"content":"In the configuration file, the service registers the new behavior:","pos":[3312,3378]},{"pos":[3626,3704],"content":"Then the service creates <ph id=\"ph1\">`endpointBehavior`</ph> configurations for each variation:","source":"Then the service creates `endpointBehavior` configurations for each variation:"},{"pos":[3986,4065],"content":"Finally, the service's endpoint references one of the <ph id=\"ph1\">`behaviorConfigurations`</ph>:","source":"Finally, the service's endpoint references one of the `behaviorConfigurations`:"},{"content":"The implementation of the client application is straightforward; it creates two channels to the service's URI (by passing in that value as the second (<ph id=\"ph1\">`via`</ph>) parameter to <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.IChannelFactory%601.CreateChannel%28System.ServiceModel.EndpointAddress%29&gt;</ph> and sends a single message on each channel, but it uses different endpoint addresses for each.","pos":[4314,4690],"source":"The implementation of the client application is straightforward; it creates two channels to the service's URI (by passing in that value as the second (`via`) parameter to <xref:System.ServiceModel.Channels.IChannelFactory%601.CreateChannel%28System.ServiceModel.EndpointAddress%29> and sends a single message on each channel, but it uses different endpoint addresses for each."},{"content":"As a result, the outbound messages from the client have different To designations, and the server responds accordingly, as demonstrated by the client's output:","pos":[4691,4850]},{"pos":[5144,5349],"content":"Switching the variation in the server's configuration file causes the filter to be swapped and the client sees the opposite behavior (the message to <ph id=\"ph1\">`urn:e`</ph> succeeds, whereas the message to <ph id=\"ph2\">`urn:a`</ph> fails).","source":"Switching the variation in the server's configuration file causes the filter to be swapped and the client sees the opposite behavior (the message to `urn:e` succeeds, whereas the message to `urn:a` fails)."},{"pos":[5609,5741],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[5795,6105],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[6106,6156]},{"pos":[6241,6277],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[6287,6457],"content":"To build the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[6467,6665],"content":"To run the sample in a single-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[6675,6915],"content":"To run the sample in a cross-machine configuration, follow the instructions at <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept> and change the following line in Client.cs.","source":"To run the sample in a cross-machine configuration, follow the instructions at [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md) and change the following line in Client.cs."},{"content":"Replace localhost with the name of server.","pos":[7033,7075]}]}