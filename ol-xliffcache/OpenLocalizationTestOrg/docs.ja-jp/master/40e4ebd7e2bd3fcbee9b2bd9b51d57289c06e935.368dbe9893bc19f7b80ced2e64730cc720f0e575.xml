{"content":"---\ntitle: \"Extending Hosting Using ServiceHostFactory | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: bcc5ae1b-21ce-4e0e-a184-17fad74a441e\ncaps.latest.revision: 12\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Extending Hosting Using ServiceHostFactory\nThe standard <xref:System.ServiceModel.ServiceHost> API for hosting services in [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] is an extensibility point in the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] architecture. Users can derive their own host classes from <xref:System.ServiceModel.ServiceHost>, usually to override <xref:System.ServiceModel.Channels.CommunicationObject.OnOpening>to use <xref:System.ServiceModel.Description.ServiceDescription> to add default endpoints imperatively or modify behaviors, prior to opening the service.  \n  \n In the self-host environment, you do not have to create a custom <xref:System.ServiceModel.ServiceHost> because you write the code that instantiates the host and then call <xref:System.ServiceModel.ICommunicationObject.Open> on it after you instantiate it. Between those two steps you can do whatever you want. You could, for example, add a new <xref:System.ServiceModel.Description.IServiceBehavior>:  \n  \n```  \npublic static void Main()  \n{  \n   ServiceHost host = new ServiceHost( typeof( MyService ) );  \n   host.Description.Add( new MyServiceBehavior() );  \n   host.Open();  \n  \n   ...  \n}  \n  \n```  \n  \n This approach is not reusable. The code that manipulates the description is coded into the host program (in this case, the Main() function), so it is difficult to reuse that logic in other contexts. There are also other ways of adding an <xref:System.ServiceModel.Description.IServiceBehavior> that do not require imperative code. You can derive an attribute from <xref:System.ServiceModel.ServiceBehaviorAttribute> and put that on your service implementation type or you can make a custom behavior configurable and compose it dynamically using configuration.  \n  \n However, a slight variation of the example can also be used to solve this problem. One approach is to move the code that adds the ServiceBehavior out of `Main()` and into the <xref:System.ServiceModel.Channels.CommunicationObject.OnOpening%2A> method of a custom derivative of <xref:System.ServiceModel.ServiceHost>:  \n  \n```  \npublic class DerivedHost : ServiceHost  \n{  \n   public DerivedHost( Type t, params Uri baseAddresses ) :  \n      base( t, baseAddresses ) {}  \n  \n   public override void OnOpening()  \n   {  \n  this.Description.Add( new MyServiceBehavior() );  \n   }  \n}  \n```  \n  \n Then, inside of `Main()` you can use:  \n  \n```  \npublic static void Main()  \n{  \n   ServiceHost host = new DerivedHost( typeof( MyService ) );  \n   host.Open();  \n  \n   ...  \n}  \n```  \n  \n Now you have encapsulated the custom logic into a clean abstraction that can be easily reused across many different host executables.  \n  \n It is not immediately obvious how to use this custom <xref:System.ServiceModel.ServiceHost> from inside of Internet Information Services (IIS) or Windows Process Activation Service (WAS). Those environments are different than the self-host environment, because the hosting environment is the one instantiating the <xref:System.ServiceModel.ServiceHost> on behalf of the application. The IIS and WAS hosting infrastructure does not know anything about your custom <xref:System.ServiceModel.ServiceHost>derivative.  \n  \n The <xref:System.ServiceModel.Activation.ServiceHostFactory> was designed to solve this problem of accessing your custom <xref:System.ServiceModel.ServiceHost> from within IIS or WAS. Because a custom host that is derived from <xref:System.ServiceModel.ServiceHost> is dynamically configured and potentially of various types, the hosting environment never instantiates it directly. Instead, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] uses a factory pattern to provide a layer of indirection between the hosting environment and the concrete type of the service. Unless you tell it otherwise, it uses a default implementation of <xref:System.ServiceModel.Activation.ServiceHostFactory> that returns an instance of <xref:System.ServiceModel.ServiceHost>. But you can also provide your own factory that returns your derived host by specifying the CLR type name of your factory implementation in the @ServiceHost directive.  \n  \n The intent is that for basic cases, implementing your own factory should be a straight forward exercise. For example, here is a custom <xref:System.ServiceModel.Activation.ServiceHostFactory> that returns a derived <xref:System.ServiceModel.ServiceHost>:  \n  \n```  \npublic class DerivedFactory : ServiceHostFactory  \n{  \n   public override ServiceHost CreateServiceHost( Type t, Uri[] baseAddresses )  \n   {  \n      return new DerivedHost( t, baseAddresses )  \n   }  \n}  \n  \n```  \n  \n To use this factory instead of the default factory, provide the type name in the @ServiceHost directive as follows:  \n  \n```  \n<% @ServiceHost Factory=\"DerivedFactory\" Service=\"MyService\" %>  \n```  \n  \n While there is no technical limit on doing what you want to the <xref:System.ServiceModel.ServiceHost> you return from <xref:System.ServiceModel.Activation.ServiceHostFactory.CreateServiceHost%2A>, we suggest that you keep your factory implementations as simple as possible. If you have lots of custom logic, it is better to put that logic inside of you host instead of inside the factory so that it can be reusable.  \n  \n There is one more layer to the hosting API that should be mentioned here. [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] also has <xref:System.ServiceModel.ServiceHostBase> and <xref:System.ServiceModel.Activation.ServiceHostFactoryBase>, from which <xref:System.ServiceModel.ServiceHost> and <xref:System.ServiceModel.Activation.ServiceHostFactory> respectively derive. Those exist for more advanced scenarios where you must swap out large parts of the metadata system with your own customized creations.","nodes":[{"pos":[12,71],"content":"Extending Hosting Using ServiceHostFactory | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Extending Hosting Using ServiceHostFactory | Microsoft Docs","pos":[0,59]}]},{"pos":[370,412],"content":"Extending Hosting Using ServiceHostFactory","linkify":"Extending Hosting Using ServiceHostFactory","nodes":[{"content":"Extending Hosting Using ServiceHostFactory","pos":[0,42]}]},{"content":"The standard <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> API for hosting services in <ph id=\"ph2\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> is an extensibility point in the <ph id=\"ph3\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> architecture.","pos":[413,651],"source":"The standard <xref:System.ServiceModel.ServiceHost> API for hosting services in [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] is an extensibility point in the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] architecture."},{"content":"Users can derive their own host classes from <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>, usually to override <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.CommunicationObject.OnOpening&gt;</ph>to use <ph id=\"ph3\">&lt;xref:System.ServiceModel.Description.ServiceDescription&gt;</ph> to add default endpoints imperatively or modify behaviors, prior to opening the service.","pos":[652,975],"source":" Users can derive their own host classes from <xref:System.ServiceModel.ServiceHost>, usually to override <xref:System.ServiceModel.Channels.CommunicationObject.OnOpening>to use <xref:System.ServiceModel.Description.ServiceDescription> to add default endpoints imperatively or modify behaviors, prior to opening the service."},{"content":"In the self-host environment, you do not have to create a custom <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> because you write the code that instantiates the host and then call <ph id=\"ph2\">&lt;xref:System.ServiceModel.ICommunicationObject.Open&gt;</ph> on it after you instantiate it.","pos":[982,1238],"source":"In the self-host environment, you do not have to create a custom <xref:System.ServiceModel.ServiceHost> because you write the code that instantiates the host and then call <xref:System.ServiceModel.ICommunicationObject.Open> on it after you instantiate it."},{"content":"Between those two steps you can do whatever you want.","pos":[1239,1292]},{"content":"You could, for example, add a new <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.IServiceBehavior&gt;</ph>:","pos":[1293,1383],"source":" You could, for example, add a new <xref:System.ServiceModel.Description.IServiceBehavior>:"},{"content":"This approach is not reusable.","pos":[1592,1622]},{"content":"The code that manipulates the description is coded into the host program (in this case, the Main() function), so it is difficult to reuse that logic in other contexts.","pos":[1623,1790]},{"content":"There are also other ways of adding an <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.IServiceBehavior&gt;</ph> that do not require imperative code.","pos":[1791,1922],"source":" There are also other ways of adding an <xref:System.ServiceModel.Description.IServiceBehavior> that do not require imperative code."},{"content":"You can derive an attribute from <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceBehaviorAttribute&gt;</ph> and put that on your service implementation type or you can make a custom behavior configurable and compose it dynamically using configuration.","pos":[1923,2151],"source":" You can derive an attribute from <xref:System.ServiceModel.ServiceBehaviorAttribute> and put that on your service implementation type or you can make a custom behavior configurable and compose it dynamically using configuration."},{"content":"However, a slight variation of the example can also be used to solve this problem.","pos":[2158,2240]},{"content":"One approach is to move the code that adds the ServiceBehavior out of <ph id=\"ph1\">`Main()`</ph> and into the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.CommunicationObject.OnOpening%2A&gt;</ph> method of a custom derivative of <ph id=\"ph3\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>:","pos":[2241,2474],"source":" One approach is to move the code that adds the ServiceBehavior out of `Main()` and into the <xref:System.ServiceModel.Channels.CommunicationObject.OnOpening%2A> method of a custom derivative of <xref:System.ServiceModel.ServiceHost>:"},{"pos":[2751,2788],"content":"Then, inside of <ph id=\"ph1\">`Main()`</ph> you can use:","source":"Then, inside of `Main()` you can use:"},{"content":"Now you have encapsulated the custom logic into a clean abstraction that can be easily reused across many different host executables.","pos":[2940,3073]},{"content":"It is not immediately obvious how to use this custom <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> from inside of Internet Information Services (IIS) or Windows Process Activation Service (WAS).","pos":[3080,3267],"source":"It is not immediately obvious how to use this custom <xref:System.ServiceModel.ServiceHost> from inside of Internet Information Services (IIS) or Windows Process Activation Service (WAS)."},{"content":"Those environments are different than the self-host environment, because the hosting environment is the one instantiating the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> on behalf of the application.","pos":[3268,3462],"source":" Those environments are different than the self-host environment, because the hosting environment is the one instantiating the <xref:System.ServiceModel.ServiceHost> on behalf of the application."},{"content":"The IIS and WAS hosting infrastructure does not know anything about your custom <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>derivative.","pos":[3463,3592],"source":" The IIS and WAS hosting infrastructure does not know anything about your custom <xref:System.ServiceModel.ServiceHost>derivative."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activation.ServiceHostFactory&gt;</ph> was designed to solve this problem of accessing your custom <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> from within IIS or WAS.","pos":[3599,3782],"source":"The <xref:System.ServiceModel.Activation.ServiceHostFactory> was designed to solve this problem of accessing your custom <xref:System.ServiceModel.ServiceHost> from within IIS or WAS."},{"content":"Because a custom host that is derived from <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> is dynamically configured and potentially of various types, the hosting environment never instantiates it directly.","pos":[3783,3980],"source":" Because a custom host that is derived from <xref:System.ServiceModel.ServiceHost> is dynamically configured and potentially of various types, the hosting environment never instantiates it directly."},{"content":"Instead, <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> uses a factory pattern to provide a layer of indirection between the hosting environment and the concrete type of the service.","pos":[3981,4172],"source":" Instead, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] uses a factory pattern to provide a layer of indirection between the hosting environment and the concrete type of the service."},{"content":"Unless you tell it otherwise, it uses a default implementation of <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activation.ServiceHostFactory&gt;</ph> that returns an instance of <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>.","pos":[4173,4363],"source":" Unless you tell it otherwise, it uses a default implementation of <xref:System.ServiceModel.Activation.ServiceHostFactory> that returns an instance of <xref:System.ServiceModel.ServiceHost>."},{"content":"But you can also provide your own factory that returns your derived host by specifying the CLR type name of your factory implementation in the <ph id=\"ph1\">@ServiceHost</ph> directive.","pos":[4364,4530],"source":" But you can also provide your own factory that returns your derived host by specifying the CLR type name of your factory implementation in the @ServiceHost directive."},{"content":"The intent is that for basic cases, implementing your own factory should be a straight forward exercise.","pos":[4537,4641]},{"content":"For example, here is a custom <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activation.ServiceHostFactory&gt;</ph> that returns a derived <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>:","pos":[4642,4791],"source":" For example, here is a custom <xref:System.ServiceModel.Activation.ServiceHostFactory> that returns a derived <xref:System.ServiceModel.ServiceHost>:"},{"content":"To use this factory instead of the default factory, provide the type name in the <ph id=\"ph1\">@ServiceHost</ph> directive as follows:","pos":[5022,5137],"source":"To use this factory instead of the default factory, provide the type name in the @ServiceHost directive as follows:"},{"content":"While there is no technical limit on doing what you want to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> you return from <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activation.ServiceHostFactory.CreateServiceHost%2A&gt;</ph>, we suggest that you keep your factory implementations as simple as possible.","pos":[5225,5499],"source":"While there is no technical limit on doing what you want to the <xref:System.ServiceModel.ServiceHost> you return from <xref:System.ServiceModel.Activation.ServiceHostFactory.CreateServiceHost%2A>, we suggest that you keep your factory implementations as simple as possible."},{"content":"If you have lots of custom logic, it is better to put that logic inside of you host instead of inside the factory so that it can be reusable.","pos":[5500,5641]},{"content":"There is one more layer to the hosting API that should be mentioned here.","pos":[5648,5721]},{"content":"<ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> also has <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHostBase&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.ServiceModel.Activation.ServiceHostFactoryBase&gt;</ph>, from which <ph id=\"ph4\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> and <ph id=\"ph5\">&lt;xref:System.ServiceModel.Activation.ServiceHostFactory&gt;</ph> respectively derive.","pos":[5722,6027],"source":"[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] also has <xref:System.ServiceModel.ServiceHostBase> and <xref:System.ServiceModel.Activation.ServiceHostFactoryBase>, from which <xref:System.ServiceModel.ServiceHost> and <xref:System.ServiceModel.Activation.ServiceHostFactory> respectively derive."},{"content":"Those exist for more advanced scenarios where you must swap out large parts of the metadata system with your own customized creations.","pos":[6028,6162]}]}