{"content":"---\ntitle: \"Discovery Security Sample | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65\ncaps.latest.revision: 13\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"\n---\n# Discovery Security Sample\nThe Discovery specification does not require that endpoints that participate in the discovery process to be secure. Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing). This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification). The sample supports both the [2005 Discovery specification](http://go.microsoft.com/fwlink/?LinkId=177912) and the [1.1 version](http://go.microsoft.com/fwlink/?LinkId=179677).  \n  \n The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints. This way, a signature header is applied for every message sent. The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped. To sign and verify messages, the sample uses certificates.  \n  \n## Discussion  \n WCF is very extensible and allows users the possibility to customize channels as desired. The sample implements a discovery secure binding element that builds secure channels. The secure channels apply and verify message signatures and are applied on top of the current stack.  \n  \n The secure binding element builds secure channel factories and channel listeners.  \n  \n## Secure Channel Factory  \n The secure channel factory creates output or duplex channels that add a compact signature to message headers. To keep messages as small as possible the compact signature format is used. The structure of a compact signature is shown in the following example.  \n  \n```  \n<d:Security ... >   \n  [<d:Sig Scheme=\"xs:anyURI\"   \n         [KeyId=\"xs:base64Binary\"]?  \n          Refs=\"...\"  \n         [PrefixList]=\"xs:NMTOKENS\"   \n          Sig=\"xs:base64Binary\"   \n          ... />]?  \n  ...   \n</d:Security>  \n  \n```  \n  \n> [!NOTE]\n>  The `PrefixList` was added in the 2008 Discovery version protocol.  \n  \n To compute the signature, the sample determines the expanded signature items. An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification. The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with. Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ). Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).  \n  \n The messages are signed with a client-specified certificate. The store location, name and the certificate subject name must be specified when the binding element is created. The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.  \n  \n## Secure Channel Listener  \n The secure channel listener creates input or duplex channels that verify the compact signature in received messages. To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store. If the message does not have a signature or the signature check fails, the messages are dropped. To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element. These secure endpoints can be used in discovery announcement listeners and discoverable services.  \n  \n## Sample Details  \n The sample includes a library and 4 console applications:  \n  \n-   **DiscoverySecurityChannels**: A library that exposes the secure binding. The library computes and verifies the compact signature for outgoing/incoming messages.  \n  \n-   **Service**: A service exposing ICalculatorService contract, self hosted. The service is marked as Discoverable. The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages). Based on these details, a UdpDiscoveryEndpoint with added security is built and used.  \n  \n-   **Client**: This class tries to discover an ICalculatorService and to call methods on the service. Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.  \n  \n-   **AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.  \n  \n> [!NOTE]\n>  If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates. In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created. Cleanup.bat also prompts you to choose a certificate to delete. Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.  \n  \n#### To use this sample  \n  \n1.  Execute the Setup.bat script from a Visual Studio command prompt. The sample uses certificates to sign and verify messages. The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe. The script must be run with administrator privileges.  \n  \n2.  To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**. Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels. Run the solution normally.  \n  \n3.  After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Scenario\\DiscoveryScenario`  \n  \n## See Also","nodes":[{"pos":[12,54],"content":"Discovery Security Sample | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Discovery Security Sample | Microsoft Docs","pos":[0,42]}]},{"pos":[364,389],"content":"Discovery Security Sample","linkify":"Discovery Security Sample","nodes":[{"content":"Discovery Security Sample","pos":[0,25]}]},{"content":"The Discovery specification does not require that endpoints that participate in the discovery process to be secure.","pos":[390,505]},{"content":"Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).","pos":[506,646]},{"content":"This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).","pos":[647,825]},{"content":"The sample supports both the <bpt id=\"p1\">[</bpt>2005 Discovery specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=177912)</ept> and the <bpt id=\"p2\">[</bpt>1.1 version<ept id=\"p2\">](http://go.microsoft.com/fwlink/?LinkId=179677)</ept>.","pos":[826,1002],"source":" The sample supports both the [2005 Discovery specification](http://go.microsoft.com/fwlink/?LinkId=177912) and the [1.1 version](http://go.microsoft.com/fwlink/?LinkId=179677)."},{"content":"The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.","pos":[1009,1117]},{"content":"This way, a signature header is applied for every message sent.","pos":[1118,1181]},{"content":"The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.","pos":[1182,1327]},{"content":"To sign and verify messages, the sample uses certificates.","pos":[1328,1386]},{"pos":[1395,1405],"content":"Discussion","linkify":"Discussion","nodes":[{"content":"Discussion","pos":[0,10]}]},{"content":"WCF is very extensible and allows users the possibility to customize channels as desired.","pos":[1409,1498]},{"content":"The sample implements a discovery secure binding element that builds secure channels.","pos":[1499,1584]},{"content":"The secure channels apply and verify message signatures and are applied on top of the current stack.","pos":[1585,1685]},{"content":"The secure binding element builds secure channel factories and channel listeners.","pos":[1692,1773]},{"pos":[1782,1804],"content":"Secure Channel Factory","linkify":"Secure Channel Factory","nodes":[{"content":"Secure Channel Factory","pos":[0,22]}]},{"content":"The secure channel factory creates output or duplex channels that add a compact signature to message headers.","pos":[1808,1917]},{"content":"To keep messages as small as possible the compact signature format is used.","pos":[1918,1993]},{"content":"The structure of a compact signature is shown in the following example.","pos":[1994,2065]},{"pos":[2325,2402],"content":"[!NOTE]\n The `PrefixList` was added in the 2008 Discovery version protocol.","leadings":["","> "],"nodes":[{"content":"The <ph id=\"ph1\">`PrefixList`</ph> was added in the 2008 Discovery version protocol.","pos":[9,75],"source":" The `PrefixList` was added in the 2008 Discovery version protocol."}]},{"content":"To compute the signature, the sample determines the expanded signature items.","pos":[2409,2486]},{"content":"An XML signature (<ph id=\"ph1\">`SignedInfo`</ph>) is created, using the <ph id=\"ph2\">`ds`</ph> namespace prefix, as required by the WS-Discovery specification.","pos":[2487,2610],"source":" An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification."},{"content":"The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.","pos":[2611,2744]},{"content":"Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).","pos":[2745,2950]},{"content":"Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).","pos":[2951,3111]},{"content":"The messages are signed with a client-specified certificate.","pos":[3118,3178]},{"content":"The store location, name and the certificate subject name must be specified when the binding element is created.","pos":[3179,3291]},{"content":"The <ph id=\"ph1\">`KeyId`</ph> in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.","pos":[3292,3524],"source":" The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token."},{"pos":[3533,3556],"content":"Secure Channel Listener","linkify":"Secure Channel Listener","nodes":[{"content":"Secure Channel Listener","pos":[0,23]}]},{"content":"The secure channel listener creates input or duplex channels that verify the compact signature in received messages.","pos":[3560,3676]},{"content":"To verify the signature, the <ph id=\"ph1\">`KeyId`</ph> specified in the compact signature attached to the message is used to select a certificate from the specified store.","pos":[3677,3830],"source":" To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store."},{"content":"If the message does not have a signature or the signature check fails, the messages are dropped.","pos":[3831,3927]},{"content":"To use the secure binding, the sample defines a factory that creates custom <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint&gt;</ph> with the added discovery secure binding element.","pos":[3928,4175],"source":" To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element."},{"content":"These secure endpoints can be used in discovery announcement listeners and discoverable services.","pos":[4176,4273]},{"pos":[4282,4296],"content":"Sample Details","linkify":"Sample Details","nodes":[{"content":"Sample Details","pos":[0,14]}]},{"content":"The sample includes a library and 4 console applications:","pos":[4300,4357]},{"content":"<bpt id=\"p1\">**</bpt>DiscoverySecurityChannels<ept id=\"p1\">**</ept>: A library that exposes the secure binding.","pos":[4367,4440],"source":"**DiscoverySecurityChannels**: A library that exposes the secure binding."},{"content":"The library computes and verifies the compact signature for outgoing/incoming messages.","pos":[4441,4528]},{"content":"<bpt id=\"p1\">**</bpt>Service<ept id=\"p1\">**</ept>: A service exposing ICalculatorService contract, self hosted.","pos":[4538,4611],"source":"**Service**: A service exposing ICalculatorService contract, self hosted."},{"content":"The service is marked as Discoverable.","pos":[4612,4650]},{"content":"The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).","pos":[4651,4955]},{"content":"Based on these details, a UdpDiscoveryEndpoint with added security is built and used.","pos":[4956,5041]},{"content":"<bpt id=\"p1\">**</bpt>Client<ept id=\"p1\">**</ept>: This class tries to discover an ICalculatorService and to call methods on the service.","pos":[5051,5149],"source":"**Client**: This class tries to discover an ICalculatorService and to call methods on the service."},{"content":"Again, a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint&gt;</ph> with added security is built and used to sign and verify the messages.","pos":[5150,5287],"source":" Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages."},{"pos":[5297,5437],"content":"<bpt id=\"p1\">**</bpt>AnnouncementListener<ept id=\"p1\">**</ept>: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.","source":"**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint."},{"pos":[5445,5896],"content":"[!NOTE]\n If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates. In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created. Cleanup.bat also prompts you to choose a certificate to delete. Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.","leadings":["","> "],"nodes":[{"content":" If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates. In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created. Cleanup.bat also prompts you to choose a certificate to delete. Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.","pos":[8,449],"nodes":[{"content":"If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.","pos":[1,144]},{"content":"In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.","pos":[145,270]},{"content":"Cleanup.bat also prompts you to choose a certificate to delete.","pos":[271,334]},{"content":"Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.","pos":[335,441]}]}]},{"pos":[5907,5925],"content":"To use this sample","linkify":"To use this sample","nodes":[{"content":"To use this sample","pos":[0,18]}]},{"content":"Execute the Setup.bat script from a Visual Studio command prompt.","pos":[5935,6000]},{"content":"The sample uses certificates to sign and verify messages.","pos":[6001,6058]},{"content":"The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.","pos":[6059,6155]},{"content":"The script must be run with administrator privileges.","pos":[6156,6209]},{"content":"To build and run the sample, open the Security.sln file in Visual Studio and choose <bpt id=\"p1\">**</bpt>Rebuild All<ept id=\"p1\">**</ept>.","pos":[6219,6319],"source":"To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**."},{"content":"Update the solution properties to start multiple projects: select <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> for all projects except DiscoverySecureChannels.","pos":[6320,6444],"source":" Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels."},{"content":"Run the solution normally.","pos":[6445,6471]},{"content":"After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.","pos":[6481,6602]},{"pos":[6610,6742],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":" The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[13,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[1,54]},{"content":"Check for the following (default) directory before continuing.","pos":[55,117]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[6796,7122],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[7123,7173]},{"pos":[7256,7264],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]}]}