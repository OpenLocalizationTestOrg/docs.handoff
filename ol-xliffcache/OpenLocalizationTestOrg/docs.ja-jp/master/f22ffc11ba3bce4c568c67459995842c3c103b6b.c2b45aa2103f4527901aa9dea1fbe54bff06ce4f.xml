{"content":"---\ntitle: \"Mitigation: Deserialization of Objects Across App Domains | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 30c2d66c-04a8-41a5-ad31-646b937f61b5\ncaps.latest.revision: 5\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"\n---\n# Mitigation: Deserialization of Objects Across App Domains\nIn some cases, when an app uses two or more app domains with different application bases, the attempt to deserialize objects in the logical call context across app domains throws an exception.  \n  \n## Diagnosing the issue  \n The issue arises under the following sequence of conditions:  \n  \n1.  An app uses two or more app domains with different application bases.  \n  \n2.  Some types are explicitly added to the <xref:System.Runtime.Remoting.Messaging.LogicalCallContext> by calling a method such as <xref:System.Runtime.Remoting.Messaging.LogicalCallContext.SetData%2A?displayProperty=fullName> or <xref:System.Runtime.Remoting.Messaging.CallContext.LogicalSetData%2A?displayProperty=fullName>. These types are not marked as serializable and are not stored in the global assembly cache.  \n  \n3.  Later, code running in the non-default app domain tries to read a value from a configuration file or use XML to deserialize an object.  \n  \n4.  In order to read from a configuration file or deserialize the object, an <xref:System.Xml.XmlReader> object tries to access the configuration system.  \n  \n5.  If the configuration system has not already been initialized, it must complete its initialization. This means, among other things, that the runtime has to create a stable path for a configuration system, which it does as follows:  \n  \n    1.  It looks for evidence for the non-default app domain.  \n  \n    2.  It tries to calculate the evidence for the non-default app domain based on the default app domain.  \n  \n    3.  The call to get evidence for the default app domain triggers a cross-app domain call from the non-default app domain to the default app domain.  \n  \n    4.  As part of the cross-app domain contract in the .NET Framework, the contents of the logical call context also have to be marshaled across app domain boundaries.  \n  \n6.  Because the types that are in the logical call context cannot be resolved in the default app domain, an exception is thrown.  \n  \n## Mitigation  \n To work around this issue, do the following  \n  \n1.  Look for the call to `get_Evidence` in the call stack when the exception is thrown. The exception can be any of a large subset of exceptions, including <xref:System.IO.FileNotFoundException> and <xref:System.Runtime.Serialization.SerializationException>.  \n  \n2.  Identify the place in the app where no objects are added to the logical call context and add the following code:  \n  \n    ```  \n    System.Configuration.ConfigurationManager.GetSection(\"system.xml/xmlReader\");  \n    ```  \n  \n## See Also  \n [Runtime Changes](../../../docs/framework/migration-guide/runtime-changes-in-the-net-framework-4-5-1.md)","nodes":[{"pos":[12,86],"content":"Mitigation: Deserialization of Objects Across App Domains | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Mitigation: Deserialization of Objects Across App Domains | Microsoft Docs","pos":[0,74]}]},{"pos":[389,446],"content":"Mitigation: Deserialization of Objects Across App Domains","linkify":"Mitigation: Deserialization of Objects Across App Domains","nodes":[{"content":"Mitigation: Deserialization of Objects Across App Domains","pos":[0,57]}]},{"content":"In some cases, when an app uses two or more app domains with different application bases, the attempt to deserialize objects in the logical call context across app domains throws an exception.","pos":[447,639]},{"pos":[648,668],"content":"Diagnosing the issue","linkify":"Diagnosing the issue","nodes":[{"content":"Diagnosing the issue","pos":[0,20]}]},{"content":"The issue arises under the following sequence of conditions:","pos":[672,732]},{"content":"An app uses two or more app domains with different application bases.","pos":[742,811]},{"content":"Some types are explicitly added to the <ph id=\"ph1\">&lt;xref:System.Runtime.Remoting.Messaging.LogicalCallContext&gt;</ph> by calling a method such as <ph id=\"ph2\">&lt;xref:System.Runtime.Remoting.Messaging.LogicalCallContext.SetData%2A?displayProperty=fullName&gt;</ph> or <ph id=\"ph3\">&lt;xref:System.Runtime.Remoting.Messaging.CallContext.LogicalSetData%2A?displayProperty=fullName&gt;</ph>.","pos":[821,1143],"source":"Some types are explicitly added to the <xref:System.Runtime.Remoting.Messaging.LogicalCallContext> by calling a method such as <xref:System.Runtime.Remoting.Messaging.LogicalCallContext.SetData%2A?displayProperty=fullName> or <xref:System.Runtime.Remoting.Messaging.CallContext.LogicalSetData%2A?displayProperty=fullName>."},{"content":"These types are not marked as serializable and are not stored in the global assembly cache.","pos":[1144,1235]},{"content":"Later, code running in the non-default app domain tries to read a value from a configuration file or use XML to deserialize an object.","pos":[1245,1379]},{"content":"In order to read from a configuration file or deserialize the object, an <ph id=\"ph1\">&lt;xref:System.Xml.XmlReader&gt;</ph> object tries to access the configuration system.","pos":[1389,1538],"source":"In order to read from a configuration file or deserialize the object, an <xref:System.Xml.XmlReader> object tries to access the configuration system."},{"content":"If the configuration system has not already been initialized, it must complete its initialization.","pos":[1548,1646]},{"content":"This means, among other things, that the runtime has to create a stable path for a configuration system, which it does as follows:","pos":[1647,1777]},{"content":"It looks for evidence for the non-default app domain.","pos":[1791,1844]},{"content":"It tries to calculate the evidence for the non-default app domain based on the default app domain.","pos":[1858,1956]},{"content":"The call to get evidence for the default app domain triggers a cross-app domain call from the non-default app domain to the default app domain.","pos":[1970,2113]},{"content":"As part of the cross-app domain contract in the .NET Framework, the contents of the logical call context also have to be marshaled across app domain boundaries.","pos":[2127,2287]},{"content":"Because the types that are in the logical call context cannot be resolved in the default app domain, an exception is thrown.","pos":[2297,2421]},{"pos":[2430,2440],"content":"Mitigation","linkify":"Mitigation","nodes":[{"content":"Mitigation","pos":[0,10]}]},{"content":"To work around this issue, do the following","pos":[2444,2487]},{"content":"Look for the call to <ph id=\"ph1\">`get_Evidence`</ph> in the call stack when the exception is thrown.","pos":[2497,2580],"source":"Look for the call to `get_Evidence` in the call stack when the exception is thrown."},{"content":"The exception can be any of a large subset of exceptions, including <ph id=\"ph1\">&lt;xref:System.IO.FileNotFoundException&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Runtime.Serialization.SerializationException&gt;</ph>.","pos":[2581,2751],"source":" The exception can be any of a large subset of exceptions, including <xref:System.IO.FileNotFoundException> and <xref:System.Runtime.Serialization.SerializationException>."},{"content":"Identify the place in the app where no objects are added to the logical call context and add the following code:","pos":[2761,2873]},{"pos":[2989,2997],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[3001,3105],"content":"<bpt id=\"p1\">[</bpt>Runtime Changes<ept id=\"p1\">](../../../docs/framework/migration-guide/runtime-changes-in-the-net-framework-4-5-1.md)</ept>","source":"[Runtime Changes](../../../docs/framework/migration-guide/runtime-changes-in-the-net-framework-4-5-1.md)"}]}