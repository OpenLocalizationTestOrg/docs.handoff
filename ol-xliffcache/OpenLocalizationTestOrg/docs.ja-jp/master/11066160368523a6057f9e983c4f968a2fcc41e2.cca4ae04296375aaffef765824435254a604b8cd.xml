{"content":"---\ntitle: \"Accessing Identity Information inside a Workflow Service | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 0b832127-b35b-468e-a45f-321381170cbc\ncaps.latest.revision: 9\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Accessing Identity Information inside a Workflow Service\nTo access identity information inside a workflow service, you must implement the <xref:System.ServiceModel.Activities.IReceiveMessageCallback> interface in a custom execution property. In the <xref:System.ServiceModel.Activities.IReceiveMessageCallback.OnReceiveMessage%2A> System.Activities.ExecutionProperties)?qualifyHint=False&autoUpgrade=True method you can access the <xref:System.ServiceModel.OperationContext.ServiceSecurityContext> to access identity information. This topic will walk you through implementing this execution property, as well as a custom activity that will surface this property to the <xref:System.ServiceModel.Activities.Receive> activity at runtime.  The custom activity will implement the same behavior as a <!--zz <xref:System.ServiceModel.Activities.Sequence>--> `System.ServiceModel.Activities.Sequence` activity, except that when a <xref:System.ServiceModel.Activities.Receive> is placed inside of it, the <xref:System.ServiceModel.Activities.IReceiveMessageCallback> will be called and the identity information will be retrieved.  \n  \n### Implement IReceiveMessageCallback  \n  \n1.  Create an empty [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] solution.  \n  \n2.  Add a new console application called `Service` to the solution.  \n  \n3.  Add references to the following assemblies:  \n  \n    1.  System.Runtime.Serialization  \n  \n    2.  System.ServiceModel  \n  \n    3.  System.ServiceModel.Activities  \n  \n4.  Add a new class called `AccessIdentityCallback` and implement <xref:System.ServiceModel.Activities.IReceiveMessageCallback> as shown in the following example.  \n  \n    ```csharp  \n    class AccessIdentityCallback : IReceiveMessageCallback  \n    {  \n       public void OnReceiveMessage(System.ServiceModel.OperationContext operationContext, System.Activities.ExecutionProperties activityExecutionProperties)  \n       {  \n          try  \n          {  \n             Console.WriteLine(\"Received a message from a workflow with the following identity\");  \n             Console.WriteLine(\"Windows Identity Name: {0}\", operationContext.ServiceSecurityContext.WindowsIdentity.Name);  \n             Console.WriteLine(\"Windows Identity User: {0}\", operationContext.ServiceSecurityContext.WindowsIdentity.User);  \n             Console.WriteLine(\"Windows Identity IsAuthenticated: {0}\", operationContext.ServiceSecurityContext.WindowsIdentity.IsAuthenticated);  \n          }            \n          catch (Exception ex)  \n          {  \n             Console.WriteLine(\"An exception occurred: \" + ex.Message);  \n          }  \n        }  \n    }  \n  \n    ```  \n  \n     This code uses the <xref:System.ServiceModel.OperationContext> passed into the method to access identity information.  \n  \n### Implement a Native activity to add the IReceiveMessageCallback implementation to the NativeActivityContext  \n  \n1.  Add a new class derived from <xref:System.Activities.NativeActivity> called `AccessIdentityScope`.  \n  \n2.  Add local variables to keep track of child activities, variables, current activity index, and a <xref:System.Activities.CompletionCallback> callback.  \n  \n    ```  \n    public sealed class AccessIdentityScope : NativeActivity  \n    {  \n        Collection<Activity> children;  \n        Collection<Variable> variables;  \n        Variable<int> currentIndex;  \n        CompletionCallback onChildComplete;  \n    }  \n  \n    ```  \n  \n3.  Implement the constructor  \n  \n    ```  \n    public AccessIdentityScope() : base()  \n    {  \n        this.children = new Collection<Activity>();  \n        this.variables = new Collection<Variable>();  \n        this.currentIndex = new Variable<int>();  \n    }  \n  \n    ```  \n  \n4.  Implement the `Activities` and `Variables` properties.  \n  \n    ```  \n    public Collection<Activity> Activities  \n    {  \n         get { return this.children; }  \n    }  \n  \n    public Collection<Variable> Variables  \n    {  \n        get { return this.variables; }  \n    }  \n  \n    ```  \n  \n5.  Override <xref:System.Activities.NativeActivity.CacheMetadata%2A>  \n  \n    ```  \n    protected override void CacheMetadata(NativeActivityMetadata metadata)  \n    {  \n        //call base.CacheMetadata to add the Activities and Variables to this activity's metadata  \n        base.CacheMetadata(metadata);  \n        //add the private implementation variable: currentIndex   \n        metadata.AddImplementationVariable(this.currentIndex);  \n    }  \n  \n    ```  \n  \n6.  Override <xref:System.Activities.NativeActivity.Execute%2A>  \n  \n    ```  \n    protected override void Execute(NativeActivityContext context)  \n    {  \n       // Add the IReceiveMessageCallback implementation as an Execution property   \n       context.Properties.Add(\"AccessIdentityCallback\", new AccessIdentityCallback());  \n       InternalExecute(context, null);  \n    }  \n  \n    void InternalExecute(NativeActivityContext context, ActivityInstance instance)  \n    {  \n       //grab the index of the current Activity  \n       int currentActivityIndex = this.currentIndex.Get(context);  \n       if (currentActivityIndex == Activities.Count)  \n       {  \n          //if the currentActivityIndex is equal to the count of MySequence's Activities  \n          //MySequence is complete  \n          return;  \n       }  \n  \n       if (this.onChildComplete == null)  \n       {  \n          //on completion of the current child, have the runtime call back on this method  \n          this.onChildComplete = new CompletionCallback(InternalExecute);  \n       }  \n  \n       //grab the next Activity in MySequence.Activities and schedule it  \n       Activity nextChild = Activities[currentActivityIndex];  \n       context.ScheduleActivity(nextChild, this.onChildComplete);  \n  \n       //increment the currentIndex  \n       this.currentIndex.Set(context, ++currentActivityIndex);  \n    }  \n  \n    ```  \n  \n### Implement the workflow service  \n  \n1.  Open the existing `Program` class.  \n  \n2.  Define the following constants:  \n  \n    ```  \n    class Program  \n    {  \n       const string addr = \"http://localhost:8080/Service\";  \n       static XName contract = XName.Get(\"IService\", \"http://tempuri.org\");  \n    }  \n  \n    ```  \n  \n3.  Add a static method called `GetWorkflowService` that creates the workflow service.  \n  \n    ```  \n    static Activity GetServiceWorkflow()  \n    {  \n       Variable<string> echoString = new Variable<string>();  \n  \n       // Create the Receive activity  \n       Receive echoRequest = new Receive  \n       {  \n          CanCreateInstance = true,  \n          ServiceContractName = contract,  \n          OperationName = \"Echo\",  \n          Content = new ReceiveParametersContent()  \n          {  \n             Parameters = { { \"echoString\", new OutArgument<string>(echoString) } }  \n          }  \n       };  \n  \n       return new AccessIdentityScope  \n       {  \n          Variables = { echoString },  \n          Activities =  \n          {  \n             echoRequest,  \n             new WriteLine { Text = new InArgument<string>( (e) => \"Received: \" + echoString.Get(e) ) },  \n             new SendReply  \n             {  \n                Request = echoRequest,  \n                Content = new SendParametersContent()  \n                {  \n                   Parameters = { { \"result\", new InArgument<string>(echoString) } }   \n                }  \n             }  \n          }  \n       };  \n     }  \n  \n    ```  \n  \n4.  In the existing `Main` method, host the workflow service.  \n  \n    ```  \n    static void Main(string[] args)  \n    {  \n       string addr = \"http://localhost:8080/Service\";  \n  \n       using (WorkflowServiceHost host = new WorkflowServiceHost(GetServiceWorkflow()))  \n       {  \n          WSHttpBinding binding = new WSHttpBinding(SecurityMode.Message);  \n          host.AddServiceEndpoint(contract, binding, addr);  \n  \n          host.Open();  \n          Console.WriteLine(\"Service waiting at: \" + addr);  \n          Console.WriteLine(\"Press [ENTER] to exit\");  \n          Console.ReadLine();  \n          host.Close();  \n       }  \n    }  \n  \n    ```  \n  \n### Implement a workflow client  \n  \n1.  Create a new console application project called `Client`.  \n  \n2.  Add references to the following assemblies:  \n  \n    1.  System.Activities  \n  \n    2.  System.ServiceModel  \n  \n    3.  System.ServiceModel.Activities  \n  \n3.  Open the generated Program.cs file and add a static method called `GetClientWorkflow` to create the client workflow.  \n  \n    ```  \n    static Activity GetClientWorkflow()  \n    {  \n       Variable<string> echoString = new Variable<string>();  \n  \n       Endpoint clientEndpoint = new Endpoint  \n       {  \n          Binding = new WSHttpBinding(SecurityMode.Message),  \n          AddressUri = new Uri(\"http://localhost:8080/Service\")  \n       };  \n  \n       Send echoRequest = new Send  \n       {  \n          Endpoint = clientEndpoint,  \n          ServiceContractName = XName.Get(\"IService\", \"http://tempuri.org\"),  \n          OperationName = \"Echo\",  \n          Content = new SendParametersContent()  \n          {  \n             Parameters = { { \"echoString\", new InArgument<string>(\"Hello, World\") } }   \n          }  \n       };  \n  \n       return new Sequence  \n       {  \n          Variables = { echoString },  \n          Activities =  \n          {                      \n             new CorrelationScope  \n             {  \n                Body = new Sequence  \n                {  \n                   Activities =   \n                   {  \n                      echoRequest,  \n                      new ReceiveReply  \n                      {  \n                         Request = echoRequest,  \n                         Content = new ReceiveParametersContent  \n                         {  \n                            Parameters = { { \"result\", new OutArgument<string>(echoString) } }  \n                         }  \n                      }  \n                   }  \n                }  \n             },                      \n             new WriteLine { Text = new InArgument<string>( (e) => \"Received Text: \" + echoString.Get(e) ) },                      \n             }  \n          };  \n       }  \n    }  \n  \n    ```  \n  \n4.  Add the following hosting code to the `Main()` method.  \n  \n    ```  \n    static void Main(string[] args)  \n    {  \n       Activity workflow = GetClientWorkflow();  \n       WorkflowInvoker.Invoke(workflow);  \n       WorkflowInvoker.Invoke(workflow);  \n       Console.WriteLine(\"Press [ENTER] to exit\");  \n       Console.ReadLine();  \n    }  \n  \n    ```  \n  \n## Example  \n Here is a complete listing of the source code used in this topic.  \n  \n```  \n  \n// AccessIdentityCallback.cs  \n//----------------------------------------------------------------  \n// Copyright (c) Microsoft Corporation.  All rights reserved.  \n//----------------------------------------------------------------  \n  \nusing System;  \nusing System.ServiceModel;  \nusing System.ServiceModel.Activities;  \n  \nnamespace Microsoft.Samples.AccessingOperationContext.Service  \n{  \n    class AccessIdentityCallback : IReceiveMessageCallback  \n    {  \n        public const string HeaderName = \"InstanceIdHeader\";  \n        public const string HeaderNS = \"http://Microsoft.Samples.AccessingOperationContext\";  \n  \n        public void OnReceiveMessage(System.ServiceModel.OperationContext operationContext, System.Activities.ExecutionProperties activityExecutionProperties)  \n        {  \n            try  \n            {  \n                // Guid instanceId = operationContext.IncomingMessageHeaders.GetHeader<Guid>(HeaderName, HeaderNS);  \n                Console.WriteLine(\"Received a message from a workflow with the following identity\" ); // with instanceId = {0}\", instanceId);  \n                Console.WriteLine(\"Windows Identity Name: {0}\", operationContext.ServiceSecurityContext.WindowsIdentity.Name);  \n                Console.WriteLine(\"Windows Identity User: {0}\", operationContext.ServiceSecurityContext.WindowsIdentity.User);  \n                Console.WriteLine(\"Windows Identity IsAuthenticated: {0}\", operationContext.ServiceSecurityContext.WindowsIdentity.IsAuthenticated);  \n            }  \n            catch (MessageHeaderException)  \n            {  \n                Console.WriteLine(\"This message must not be from a workflow.\");  \n            }  \n            catch (Exception ex)  \n            {  \n                Console.WriteLine(\"An exception occurred: \" + ex.Message);  \n            }  \n        }  \n    }  \n}  \n  \n```  \n  \n```  \n  \n// AccessIdentityScope.cs  \n//----------------------------------------------------------------  \n// Copyright (c) Microsoft Corporation.  All rights reserved.  \n//----------------------------------------------------------------  \n  \nusing System.Activities;  \nusing System.Collections.ObjectModel;  \n  \nnamespace Microsoft.Samples.AccessingOperationContext.Service  \n{  \n    public sealed class AccessIdentityScope : NativeActivity  \n    {  \n        Collection<Activity> children;  \n        Collection<Variable> variables;  \n        Variable<int> currentIndex;  \n        CompletionCallback onChildComplete;  \n  \n        public AccessIdentityScope()  \n            : base()  \n        {  \n            this.children = new Collection<Activity>();  \n            this.variables = new Collection<Variable>();  \n            this.currentIndex = new Variable<int>();  \n        }  \n  \n        public Collection<Activity> Activities  \n        {  \n            get  \n            {  \n                return this.children;  \n            }  \n        }  \n  \n        public Collection<Variable> Variables  \n        {  \n            get  \n            {  \n                return this.variables;  \n            }  \n        }  \n  \n        protected override void CacheMetadata(NativeActivityMetadata metadata)  \n        {  \n            //call base.CacheMetadata to add the Activities and Variables to this activity's metadata  \n            base.CacheMetadata(metadata);  \n            //add the private implementation variable: currentIndex   \n            metadata.AddImplementationVariable(this.currentIndex);  \n        }                     \n  \n        protected override void Execute(  \n            NativeActivityContext context)  \n        {  \n            context.Properties.Add(\"AccessIdentityCallback\", new AccessIdentityCallback());  \n            InternalExecute(context, null);  \n        }  \n  \n        void InternalExecute(NativeActivityContext context, ActivityInstance instance)  \n        {  \n            //grab the index of the current Activity  \n            int currentActivityIndex = this.currentIndex.Get(context);  \n            if (currentActivityIndex == Activities.Count)  \n            {  \n                //if the currentActivityIndex is equal to the count of MySequence's Activities  \n                //MySequence is complete  \n                return;  \n            }  \n  \n            if (this.onChildComplete == null)  \n            {  \n                //on completion of the current child, have the runtime call back on this method  \n                this.onChildComplete = new CompletionCallback(InternalExecute);  \n            }  \n  \n            //grab the next Activity in MySequence.Activities and schedule it  \n            Activity nextChild = Activities[currentActivityIndex];  \n            context.ScheduleActivity(nextChild, this.onChildComplete);  \n  \n            //increment the currentIndex  \n            this.currentIndex.Set(context, ++currentActivityIndex);  \n        }  \n    }  \n}  \n  \n```  \n  \n```  \n  \n// Service.cs  \n//----------------------------------------------------------------  \n// Copyright (c) Microsoft Corporation.  All rights reserved.  \n//----------------------------------------------------------------  \n  \nusing System;  \nusing System.Activities;  \nusing System.Activities.Statements;  \nusing System.ServiceModel;  \nusing System.ServiceModel.Activities;  \nusing System.Xml.Linq;  \n  \nnamespace Microsoft.Samples.AccessingOperationContext.Service  \n{      \n    class Program  \n    {  \n        const string addr = \"http://localhost:8080/Service\";  \n        static XName contract = XName.Get(\"IService\", \"http://tempuri.org\");  \n  \n        static void Main(string[] args)  \n        {  \n            string addr = \"http://localhost:8080/Service\";  \n  \n            using (WorkflowServiceHost host = new WorkflowServiceHost(GetServiceWorkflow()))  \n            {  \n                WSHttpBinding binding = new WSHttpBinding(SecurityMode.Message);  \n                host.AddServiceEndpoint(contract, binding, addr);  \n  \n                host.Open();  \n                Console.WriteLine(\"Service waiting at: \" + addr);  \n                Console.WriteLine(\"Press [ENTER] to exit\");  \n                Console.ReadLine();  \n                host.Close();  \n            }  \n  \n        }  \n  \n        static Activity GetServiceWorkflow()  \n        {  \n            Variable<string> echoString = new Variable<string>();  \n  \n            Receive echoRequest = new Receive  \n            {  \n                CanCreateInstance = true,  \n                ServiceContractName = contract,  \n                OperationName = \"Echo\",  \n                Content = new ReceiveParametersContent()  \n                {  \n                    Parameters = { { \"echoString\", new OutArgument<string>(echoString) } }  \n                }  \n            };  \n  \n            return new AccessIdentityScope  \n            {  \n                Variables = { echoString },  \n                Activities =  \n                {  \n                    echoRequest,  \n                    new WriteLine { Text = new InArgument<string>( (e) => \"Received: \" + echoString.Get(e) ) },  \n                    new SendReply  \n                    {  \n                        Request = echoRequest,  \n                        Content = new SendParametersContent()  \n                        {  \n                            Parameters = { { \"result\", new InArgument<string>(echoString) } }   \n                        }  \n                    }  \n                }  \n            };  \n        }  \n    }  \n}  \n  \n```  \n  \n```  \n  \n// client.cs   \n//----------------------------------------------------------------  \n// Copyright (c) Microsoft Corporation.  All rights reserved.  \n//----------------------------------------------------------------  \n  \nusing System;  \nusing System.Activities;  \nusing System.Activities.Statements;  \nusing System.ServiceModel;  \nusing System.ServiceModel.Activities;  \nusing System.Xml.Linq;  \n  \nnamespace Microsoft.Samples.AccessingOperationContext.Client  \n{  \n    class Program  \n    {  \n        static void Main(string[] args)  \n        {  \n            Activity workflow = GetClientWorkflow();  \n            WorkflowInvoker.Invoke(workflow);  \n            WorkflowInvoker.Invoke(workflow);  \n            Console.WriteLine(\"Press [ENTER] to exit\");  \n            Console.ReadLine();  \n        }  \n  \n        static Activity GetClientWorkflow()  \n        {  \n            Variable<string> echoString = new Variable<string>();  \n  \n            Endpoint clientEndpoint = new Endpoint  \n            {  \n                Binding = new WSHttpBinding(SecurityMode.Message),  \n                AddressUri = new Uri(\"http://localhost:8080/Service\")  \n            };  \n  \n            Send echoRequest = new Send  \n            {  \n                Endpoint = clientEndpoint,  \n                ServiceContractName = XName.Get(\"IService\", \"http://tempuri.org\"),  \n                OperationName = \"Echo\",  \n                Content = new SendParametersContent()  \n                {  \n                    Parameters = { { \"echoString\", new InArgument<string>(\"Hello, World\") } }   \n                }  \n            };  \n  \n            return new Sequence  \n            {  \n                Variables = { echoString },  \n                Activities =  \n                {                      \n                    new CorrelationScope  \n                    {  \n                        Body = new Sequence  \n                        {  \n                            Activities =   \n                            {  \n                                echoRequest,  \n                                new ReceiveReply  \n                                {  \n                                    Request = echoRequest,  \n                                    Content = new ReceiveParametersContent  \n                                    {  \n                                        Parameters = { { \"result\", new OutArgument<string>(echoString) } }  \n                                    }  \n                                }  \n                            }  \n                        }  \n                    },                      \n                    new WriteLine { Text = new InArgument<string>( (e) => \"Received Text: \" + echoString.Get(e) ) },                      \n                }  \n            };  \n        }  \n    }  \n}  \n  \n```  \n  \n## See Also  \n [Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)   \n [Accessing OperationContext](../../../../docs/framework/windows-workflow-foundation/samples/accessing-operationcontext.md)   \n [Authoring Workflows, Activities, and Expressions Using Imperative Code](../../../../docs/framework/windows-workflow-foundation/authoring-workflows-activities-and-expressions-using-imperative-code.md)","nodes":[{"pos":[4,376],"nodes":[{"content":"Accessing Identity Information inside a Workflow Service | Microsoft Docs","nodes":[{"pos":[0,73],"content":"Accessing Identity Information inside a Workflow Service | Microsoft Docs","nodes":[{"content":"Accessing Identity Information inside a Workflow Service | Microsoft Docs","pos":[0,73]}]}],"pos":[6,82],"yaml":true}],"content":"title: \"Accessing Identity Information inside a Workflow Service | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 0b832127-b35b-468e-a45f-321381170cbc\ncaps.latest.revision: 9\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","yamlblock":true},{"pos":[383,439],"content":"Accessing Identity Information inside a Workflow Service","linkify":"Accessing Identity Information inside a Workflow Service","nodes":[{"content":"Accessing Identity Information inside a Workflow Service","pos":[0,56]}]},{"content":"To access identity information inside a workflow service, you must implement the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.IReceiveMessageCallback&gt;</ph> interface in a custom execution property.","pos":[440,624],"source":"To access identity information inside a workflow service, you must implement the <xref:System.ServiceModel.Activities.IReceiveMessageCallback> interface in a custom execution property."},{"content":"In the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.IReceiveMessageCallback.OnReceiveMessage%2A&gt;</ph> System.Activities.ExecutionProperties)?qualifyHint=False&amp;autoUpgrade=True method you can access the <ph id=\"ph2\">&lt;xref:System.ServiceModel.OperationContext.ServiceSecurityContext&gt;</ph> to access identity information.","pos":[625,912],"source":" In the <xref:System.ServiceModel.Activities.IReceiveMessageCallback.OnReceiveMessage%2A> System.Activities.ExecutionProperties)?qualifyHint=False&autoUpgrade=True method you can access the <xref:System.ServiceModel.OperationContext.ServiceSecurityContext> to access identity information."},{"content":"This topic will walk you through implementing this execution property, as well as a custom activity that will surface this property to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity at runtime.","pos":[913,1118],"source":" This topic will walk you through implementing this execution property, as well as a custom activity that will surface this property to the <xref:System.ServiceModel.Activities.Receive> activity at runtime."},{"content":"The custom activity will implement the same behavior as a <ph id=\"ph1\">&lt;!--zz &lt;xref:System.ServiceModel.Activities.Sequence&gt;--&gt;</ph> <ph id=\"ph2\">`System.ServiceModel.Activities.Sequence`</ph> activity, except that when a <ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> is placed inside of it, the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Activities.IReceiveMessageCallback&gt;</ph> will be called and the identity information will be retrieved.","pos":[1120,1504],"source":"  The custom activity will implement the same behavior as a <!--zz <xref:System.ServiceModel.Activities.Sequence>--> `System.ServiceModel.Activities.Sequence` activity, except that when a <xref:System.ServiceModel.Activities.Receive> is placed inside of it, the <xref:System.ServiceModel.Activities.IReceiveMessageCallback> will be called and the identity information will be retrieved."},{"pos":[1514,1547],"content":"Implement IReceiveMessageCallback","linkify":"Implement IReceiveMessageCallback","nodes":[{"content":"Implement IReceiveMessageCallback","pos":[0,33]}]},{"pos":[1557,1654],"content":"Create an empty <ph id=\"ph1\">[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]</ph> solution.","source":"Create an empty [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] solution."},{"pos":[1664,1727],"content":"Add a new console application called <ph id=\"ph1\">`Service`</ph> to the solution.","source":"Add a new console application called `Service` to the solution."},{"content":"Add references to the following assemblies:","pos":[1737,1780]},{"content":"System.Runtime.Serialization","pos":[1794,1822]},{"content":"System.ServiceModel","pos":[1836,1855]},{"content":"System.ServiceModel.Activities","pos":[1869,1899]},{"pos":[1909,2067],"content":"Add a new class called <ph id=\"ph1\">`AccessIdentityCallback`</ph> and implement <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.IReceiveMessageCallback&gt;</ph> as shown in the following example.","source":"Add a new class called `AccessIdentityCallback` and implement <xref:System.ServiceModel.Activities.IReceiveMessageCallback> as shown in the following example."},{"content":"This code uses the <ph id=\"ph1\">&lt;xref:System.ServiceModel.OperationContext&gt;</ph> passed into the method to access identity information.","pos":[3059,3176],"source":"This code uses the <xref:System.ServiceModel.OperationContext> passed into the method to access identity information."},{"pos":[3186,3292],"content":"Implement a Native activity to add the IReceiveMessageCallback implementation to the NativeActivityContext","linkify":"Implement a Native activity to add the IReceiveMessageCallback implementation to the NativeActivityContext","nodes":[{"content":"Implement a Native activity to add the IReceiveMessageCallback implementation to the NativeActivityContext","pos":[0,106]}]},{"pos":[3302,3400],"content":"Add a new class derived from <ph id=\"ph1\">&lt;xref:System.Activities.NativeActivity&gt;</ph> called <ph id=\"ph2\">`AccessIdentityScope`</ph>.","source":"Add a new class derived from <xref:System.Activities.NativeActivity> called `AccessIdentityScope`."},{"content":"Add local variables to keep track of child activities, variables, current activity index, and a <ph id=\"ph1\">&lt;xref:System.Activities.CompletionCallback&gt;</ph> callback.","pos":[3410,3559],"source":"Add local variables to keep track of child activities, variables, current activity index, and a <xref:System.Activities.CompletionCallback> callback."},{"content":"Implement the constructor","pos":[3841,3866]},{"pos":[4122,4176],"content":"Implement the <ph id=\"ph1\">`Activities`</ph> and <ph id=\"ph2\">`Variables`</ph> properties.","source":"Implement the `Activities` and `Variables` properties."},{"content":"Override <ph id=\"ph1\">&lt;xref:System.Activities.NativeActivity.CacheMetadata%2A&gt;</ph>","pos":[4418,4483],"source":"Override <xref:System.Activities.NativeActivity.CacheMetadata%2A>"},{"content":"Override <ph id=\"ph1\">&lt;xref:System.Activities.NativeActivity.Execute%2A&gt;</ph>","pos":[4884,4943],"source":"Override <xref:System.Activities.NativeActivity.Execute%2A>"},{"pos":[6278,6308],"content":"Implement the workflow service","linkify":"Implement the workflow service","nodes":[{"content":"Implement the workflow service","pos":[0,30]}]},{"pos":[6318,6352],"content":"Open the existing <ph id=\"ph1\">`Program`</ph> class.","source":"Open the existing `Program` class."},{"content":"Define the following constants:","pos":[6362,6393]},{"pos":[6605,6687],"content":"Add a static method called <ph id=\"ph1\">`GetWorkflowService`</ph> that creates the workflow service.","source":"Add a static method called `GetWorkflowService` that creates the workflow service."},{"pos":[7822,7879],"content":"In the existing <ph id=\"ph1\">`Main`</ph> method, host the workflow service.","source":"In the existing `Main` method, host the workflow service."},{"pos":[8483,8510],"content":"Implement a workflow client","linkify":"Implement a workflow client","nodes":[{"content":"Implement a workflow client","pos":[0,27]}]},{"pos":[8520,8577],"content":"Create a new console application project called <ph id=\"ph1\">`Client`</ph>.","source":"Create a new console application project called `Client`."},{"content":"Add references to the following assemblies:","pos":[8587,8630]},{"content":"System.Activities","pos":[8644,8661]},{"content":"System.ServiceModel","pos":[8675,8694]},{"content":"System.ServiceModel.Activities","pos":[8708,8738]},{"pos":[8748,8864],"content":"Open the generated Program.cs file and add a static method called <ph id=\"ph1\">`GetClientWorkflow`</ph> to create the client workflow.","source":"Open the generated Program.cs file and add a static method called `GetClientWorkflow` to create the client workflow."},{"pos":[10577,10631],"content":"Add the following hosting code to the <ph id=\"ph1\">`Main()`</ph> method.","source":"Add the following hosting code to the `Main()` method."},{"pos":[10938,10945],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"Here is a complete listing of the source code used in this topic.","pos":[10949,11014]},{"pos":[21286,21294],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Workflow Services<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/workflow-services.md)</ept><ph id=\"ph1\"> </ph>","pos":[21298,21387],"source":"[Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md) "},{"content":"<bpt id=\"p1\">[</bpt>Accessing OperationContext<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/samples/accessing-operationcontext.md)</ept><ph id=\"ph1\"> </ph>","pos":[21391,21514],"source":"[Accessing OperationContext](../../../../docs/framework/windows-workflow-foundation/samples/accessing-operationcontext.md) "},{"content":"<bpt id=\"p1\">[</bpt>Authoring Workflows, Activities, and Expressions Using Imperative Code<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/authoring-workflows-activities-and-expressions-using-imperative-code.md)</ept>","pos":[21518,21718],"source":"[Authoring Workflows, Activities, and Expressions Using Imperative Code](../../../../docs/framework/windows-workflow-foundation/authoring-workflows-activities-and-expressions-using-imperative-code.md)"}]}