{"content":"---\ntitle: \"How to: Write a Parallel.ForEach Loop with Thread-Local Variables | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"parallel foreach loop, how to use local state\"\nms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d\ncaps.latest.revision: 18\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"\n---\n# How to: Write a Parallel.ForEach Loop with Thread-Local Variables\nThe following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables. When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions. Each partition will get its own copy of the \"thread-local\" variable. (The term \"thread-local\" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)  \n  \n The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method. For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).  \n  \n To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters. The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.  \n  \n## Example  \n The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=fullName> overload to compute the sum of an array of one million elements. This overload has four parameters:  \n  \n-   `source`, which is the data source. It must implement <xref:System.Collections.Generic.IEnumerable%601>. The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=fullName> method.  \n  \n-   `localInit`, or the function that initializes the thread-local variable. This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName> operation executes. Our example initializes the thread-local variable to zero.  \n  \n-   `body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop. Its signature is `Func\\<TSource, ParallelLoopState, TLocal, TLocal>`. You supply the code for the delegate, and the loop passes in the input parameters, which are:  \n  \n    -   The current element of the <xref:System.Collections.Generic.IEnumerable%601>.  \n  \n    -   A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.  \n  \n    -   The thread-local variable.  \n  \n     Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition. Each loop partition maintains a separate instance of this variable.  \n  \n     In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.  \n  \n-   `localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName> invokes when the looping operations in each partition have completed. The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions. This delegate can be invoked concurrently by multiple tasks. Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=fullName> method to synchronize access to the `total` variable. Because the delegate type is an <xref:System.Action%601>, there is no return value.  \n  \n [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]\n [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  \n  \n## See Also  \n [Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)   \n [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)   \n [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)","nodes":[{"pos":[12,94],"content":"How to: Write a Parallel.ForEach Loop with Thread-Local Variables | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"How to: Write a Parallel.ForEach Loop with Thread-Local Variables | Microsoft Docs","pos":[0,82]}]},{"pos":[460,525],"content":"How to: Write a Parallel.ForEach Loop with Thread-Local Variables","linkify":"How to: Write a Parallel.ForEach Loop with Thread-Local Variables","nodes":[{"content":"How to: Write a Parallel.ForEach Loop with Thread-Local Variables","pos":[0,65]}]},{"content":"The following example shows how to write a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A&gt;</ph> method that uses thread-local variables.","pos":[526,659],"source":"The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables."},{"content":"When a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A&gt;</ph> loop executes, it divides its source collection into multiple partitions.","pos":[660,790],"source":" When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions."},{"content":"Each partition will get its own copy of the \"thread-local\" variable.","pos":[791,859]},{"content":"(The term \"thread-local\" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)","pos":[860,979]},{"content":"The code and parameters in this example closely resemble the corresponding <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%2A&gt;</ph> method.","pos":[986,1114],"source":"The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>How to: Write a Parallel.For Loop with Thread-Local Variables<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)</ept>.","pos":[1115,1314],"source":" For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)."},{"content":"To use a thread-local variable in a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A&gt;</ph> loop, you must call one of the method overloads that takes two type parameters.","pos":[1321,1486],"source":"To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters."},{"content":"The first type parameter, <ph id=\"ph1\">`TSource`</ph>, specifies the type of the source element, and the second type parameter, <ph id=\"ph2\">`TLocal`</ph>, specifies the type of the thread-local variable.","pos":[1487,1655],"source":" The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable."},{"pos":[1664,1671],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following example calls <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=fullName&gt;</ph> overload to compute the sum of an array of one million elements.","pos":[1675,2049],"source":"The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=fullName> overload to compute the sum of an array of one million elements."},{"content":"This overload has four parameters:","pos":[2050,2084]},{"content":"<ph id=\"ph1\">`source`</ph>, which is the data source.","pos":[2094,2129],"source":"`source`, which is the data source."},{"content":"It must implement <ph id=\"ph1\">&lt;xref:System.Collections.Generic.IEnumerable%601&gt;</ph>.","pos":[2130,2198],"source":" It must implement <xref:System.Collections.Generic.IEnumerable%601>."},{"content":"The data source in our example is the one million member <ph id=\"ph1\">`IEnumerable&lt;Int32&gt;`</ph> object returned by the <ph id=\"ph2\">&lt;xref:System.Linq.Enumerable.Range%2A?displayProperty=fullName&gt;</ph> method.","pos":[2199,2371],"source":" The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=fullName> method."},{"content":"<ph id=\"ph1\">`localInit`</ph>, or the function that initializes the thread-local variable.","pos":[2381,2453],"source":"`localInit`, or the function that initializes the thread-local variable."},{"content":"This function is called once for each partition in which the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName&gt;</ph> operation executes.","pos":[2454,2609],"source":" This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName> operation executes."},{"content":"Our example initializes the thread-local variable to zero.","pos":[2610,2668]},{"content":"<ph id=\"ph1\">`body`</ph>, a <ph id=\"ph2\">&lt;xref:System.Func%604&gt;</ph> that is invoked by the parallel loop on each iteration of the loop.","pos":[2678,2778],"source":"`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop."},{"content":"Its signature is <ph id=\"ph1\">`Func\\&lt;TSource, ParallelLoopState, TLocal, TLocal&gt;`</ph>.","pos":[2779,2848],"source":" Its signature is `Func\\<TSource, ParallelLoopState, TLocal, TLocal>`."},{"content":"You supply the code for the delegate, and the loop passes in the input parameters, which are:","pos":[2849,2942]},{"content":"The current element of the <ph id=\"ph1\">&lt;xref:System.Collections.Generic.IEnumerable%601&gt;</ph>.","pos":[2956,3033],"source":"The current element of the <xref:System.Collections.Generic.IEnumerable%601>."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.ParallelLoopState&gt;</ph> variable that you can use in your delegate's code to examine the state of the loop.","pos":[3047,3180],"source":"A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop."},{"content":"The thread-local variable.","pos":[3194,3220]},{"content":"Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.","pos":[3231,3378]},{"content":"Each loop partition maintains a separate instance of this variable.","pos":[3379,3446]},{"content":"In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.","pos":[3457,3635]},{"content":"<ph id=\"ph1\">`localFinally`</ph>, an <ph id=\"ph2\">`Action&lt;TLocal&gt;`</ph> delegate that the <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName&gt;</ph> invokes when the looping operations in each partition have completed.","pos":[3645,3843],"source":"`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName> invokes when the looping operations in each partition have completed."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName&gt;</ph> method passes your <ph id=\"ph2\">`Action&lt;TLocal&gt;`</ph> delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.","pos":[3844,4197],"source":" The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=fullName> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions."},{"content":"This delegate can be invoked concurrently by multiple tasks.","pos":[4198,4258]},{"content":"Because of this, the example uses the <ph id=\"ph1\">&lt;xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=fullName&gt;</ph> method to synchronize access to the <ph id=\"ph2\">`total`</ph> variable.","pos":[4259,4451],"source":" Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=fullName> method to synchronize access to the `total` variable."},{"content":"Because the delegate type is an <ph id=\"ph1\">&lt;xref:System.Action%601&gt;</ph>, there is no return value.","pos":[4452,4535],"source":" Because the delegate type is an <xref:System.Action%601>, there is no return value."},{"pos":[4542,4791],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPL_Parallel#04<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)</ept><ept id=\"p1\">]</ept> <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPL_Parallel#04<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)</ept><ept id=\"p3\">]</ept>","leadings":[""," "],"source":"[!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]\n[!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]"},{"pos":[4800,4808],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Data Parallelism<ept id=\"p1\">](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)</ept><ph id=\"ph1\"> </ph>","pos":[4812,4918],"source":"[Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md) "},{"content":"<bpt id=\"p1\"> [</bpt>How to: Write a Parallel.For Loop with Thread-Local Variables<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)</ept><ph id=\"ph1\"> </ph>","pos":[4921,5095],"source":" [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md) "},{"content":"<bpt id=\"p1\"> [</bpt>Lambda Expressions in PLINQ and TPL<ept id=\"p1\">](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)</ept>","pos":[5098,5220],"source":" [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)"}]}