{"content":"---\ntitle: \"Activity ID Propagation\"\nms.date: \"03/30/2017\"\nms.assetid: cd1c1ae5-cc8a-4f51-90c9-f7b476bcfe70\n---\n# Activity ID Propagation\nPropagation happens when ServiceModel activity tracing is enabled (ServiceModel propagation) or disabled (User-to-User activity propagation).  \n  \n## ServiceModel Activity Tracing is Enabled  \n If ServiceModel ActivityTracing is enabled, propagation happens between ProcessAction activities.  \n  \n### Server  \n When the `propagateActivity` attribute is set to `true` on both the client and server, the ID of the `ProcessAction` activity in the server is identical to the ID in the propagated `ActivityId` message header.  \n  \n When no `ActivityId` header is present in the message (that is, `propagateActivity`=`false` on the client), or when `propagateActivity`=`false` on the server, the server generates a new activity ID.  \n  \n### Client  \n If the client is synchronously single threaded, the client disregards any settings of `propagateActivity` at the client or server. Instead, the response is handled in the request activity. If the client is asynchronous or synchronous multithreaded, `propagateActivity`=`true` in the client, and there is an activity ID header in the message sent by the server, the client retrieves the activity ID from the message, and transfers to the Process Action activity that contains the propagated activity ID. Otherwise, the client transfers from Process Message activity to a new Process Action activity. This extra transfer to a new Process Action activity is done for consistency. Inside this activity, the client retrieves the activity ID of the BeginCall activity from the local thread context, when the thread is allocated for response message processing. It then transfers to the initial Process Action activity.  \n  \n If the client is duplex, the client acts as server on receiving the message.  \n  \n### Propagation in Fault Messages  \n There is no difference in handling valid and fault messages. If `propagateActivity`=`true`, the activity ID added to the SOAP fault message headers is identical to the ambient activity.  \n  \n## ServiceModel Activity Tracing is Disabled  \n If ServiceModel ActivityTracing is disabled, propagation occurs between user code activities directly without going through ServiceModel activities. A user-defined activity ID is also propagated through the message activity ID header.  \n  \n If `propagateActivity`=`true` and `ActivityTracing`=`off` for a ServiceModel trace listener (regardless of whether tracing is enabled on ServiceModel), the following happen on either the client or server:  \n  \n-   On operation request or sending response, the activity ID in TLS is propagated out of user code until a message is formed. An activity ID header is also inserted into the message before it is sent.  \n  \n-   On receiving request or receiving response, the activity ID is retrieved from the message header as soon as the received message object is created. The activity ID in TLS is propagated as soon as the message disappears from scope until user code is reached.  \n  \n These actions guarantee that user traces will appear in the same activity if propagation is on. However, it makes no guarantee on ServiceModel traces. ServiceModel traces occur in a user code activity only if the processing of those traces is executed on the same thread where the user code activity was set.  \n  \n In general, ServiceModel traces can be observed in the following places:  \n  \n-   If ServiceModel tracing is disabled, all emitted traces appear in user activities. If propagation is enabled at both the server and client, these traces will be in the same activity.  \n  \n-   If ServiceModel tracing is enabled, but ActivityTracing is disabled, user traces appear in the same activity if propagation is enabled on both ends. ServiceModel traces appear in the default 0000 activity, unless they occur in the same thread as the user code processing where the activity is initially set.  \n  \n-   If both ServiceModel tracing and ActivityTracing are enabled, user traces appear in user-defined activities, and ServiceModel traces appear in ServiceModel-defined activities. Propagation happens at ServiceModel level.\n","nodes":[{"pos":[4,107],"embed":true,"restype":"x-metadata","content":"title: \"Activity ID Propagation\"\nms.date: \"03/30/2017\"\nms.assetid: cd1c1ae5-cc8a-4f51-90c9-f7b476bcfe70","nodes":[{"content":"Activity ID Propagation","nodes":[{"pos":[0,23],"content":"Activity ID Propagation","nodes":[{"content":"Activity ID Propagation","pos":[0,23]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[114,137],"content":"Activity ID Propagation","linkify":"Activity ID Propagation","nodes":[{"content":"Activity ID Propagation","pos":[0,23]}]},{"content":"Propagation happens when ServiceModel activity tracing is enabled (ServiceModel propagation) or disabled (User-to-User activity propagation).","pos":[138,279]},{"pos":[288,328],"content":"ServiceModel Activity Tracing is Enabled","linkify":"ServiceModel Activity Tracing is Enabled","nodes":[{"content":"ServiceModel Activity Tracing is Enabled","pos":[0,40]}]},{"content":"If ServiceModel ActivityTracing is enabled, propagation happens between ProcessAction activities.","pos":[332,429]},{"pos":[439,445],"content":"Server","linkify":"Server","nodes":[{"content":"Server","pos":[0,6]}]},{"pos":[449,658],"content":"When the <ph id=\"ph1\">`propagateActivity`</ph> attribute is set to <ph id=\"ph2\">`true`</ph> on both the client and server, the ID of the <ph id=\"ph3\">`ProcessAction`</ph> activity in the server is identical to the ID in the propagated <ph id=\"ph4\">`ActivityId`</ph> message header.","source":"When the `propagateActivity` attribute is set to `true` on both the client and server, the ID of the `ProcessAction` activity in the server is identical to the ID in the propagated `ActivityId` message header."},{"pos":[665,863],"content":"When no <ph id=\"ph1\">`ActivityId`</ph> header is present in the message (that is, <ph id=\"ph2\">`propagateActivity`</ph><ph id=\"ph3\">=</ph><ph id=\"ph4\">`false`</ph> on the client), or when <ph id=\"ph5\">`propagateActivity`</ph><ph id=\"ph6\">=</ph><ph id=\"ph7\">`false`</ph> on the server, the server generates a new activity ID.","source":"When no `ActivityId` header is present in the message (that is, `propagateActivity`=`false` on the client), or when `propagateActivity`=`false` on the server, the server generates a new activity ID."},{"pos":[873,879],"content":"Client","linkify":"Client","nodes":[{"content":"Client","pos":[0,6]}]},{"content":"If the client is synchronously single threaded, the client disregards any settings of <ph id=\"ph1\">`propagateActivity`</ph> at the client or server.","pos":[883,1013],"source":"If the client is synchronously single threaded, the client disregards any settings of `propagateActivity` at the client or server."},{"content":"Instead, the response is handled in the request activity.","pos":[1014,1071]},{"content":"If the client is asynchronous or synchronous multithreaded, <ph id=\"ph1\">`propagateActivity`</ph><ph id=\"ph2\">=</ph><ph id=\"ph3\">`true`</ph> in the client, and there is an activity ID header in the message sent by the server, the client retrieves the activity ID from the message, and transfers to the Process Action activity that contains the propagated activity ID.","pos":[1072,1385],"source":" If the client is asynchronous or synchronous multithreaded, `propagateActivity`=`true` in the client, and there is an activity ID header in the message sent by the server, the client retrieves the activity ID from the message, and transfers to the Process Action activity that contains the propagated activity ID."},{"content":"Otherwise, the client transfers from Process Message activity to a new Process Action activity.","pos":[1386,1481]},{"content":"This extra transfer to a new Process Action activity is done for consistency.","pos":[1482,1559]},{"content":"Inside this activity, the client retrieves the activity ID of the BeginCall activity from the local thread context, when the thread is allocated for response message processing.","pos":[1560,1737]},{"content":"It then transfers to the initial Process Action activity.","pos":[1738,1795]},{"content":"If the client is duplex, the client acts as server on receiving the message.","pos":[1802,1878]},{"pos":[1888,1917],"content":"Propagation in Fault Messages","linkify":"Propagation in Fault Messages","nodes":[{"content":"Propagation in Fault Messages","pos":[0,29]}]},{"content":"There is no difference in handling valid and fault messages.","pos":[1921,1981]},{"content":"If <ph id=\"ph1\">`propagateActivity`</ph><ph id=\"ph2\">=</ph><ph id=\"ph3\">`true`</ph>, the activity ID added to the SOAP fault message headers is identical to the ambient activity.","pos":[1982,2106],"source":" If `propagateActivity`=`true`, the activity ID added to the SOAP fault message headers is identical to the ambient activity."},{"pos":[2115,2156],"content":"ServiceModel Activity Tracing is Disabled","linkify":"ServiceModel Activity Tracing is Disabled","nodes":[{"content":"ServiceModel Activity Tracing is Disabled","pos":[0,41]}]},{"content":"If ServiceModel ActivityTracing is disabled, propagation occurs between user code activities directly without going through ServiceModel activities.","pos":[2160,2308]},{"content":"A user-defined activity ID is also propagated through the message activity ID header.","pos":[2309,2394]},{"pos":[2401,2605],"content":"If <ph id=\"ph1\">`propagateActivity`</ph><ph id=\"ph2\">=</ph><ph id=\"ph3\">`true`</ph> and <ph id=\"ph4\">`ActivityTracing`</ph><ph id=\"ph5\">=</ph><ph id=\"ph6\">`off`</ph> for a ServiceModel trace listener (regardless of whether tracing is enabled on ServiceModel), the following happen on either the client or server:","source":"If `propagateActivity`=`true` and `ActivityTracing`=`off` for a ServiceModel trace listener (regardless of whether tracing is enabled on ServiceModel), the following happen on either the client or server:"},{"content":"On operation request or sending response, the activity ID in TLS is propagated out of user code until a message is formed.","pos":[2615,2737]},{"content":"An activity ID header is also inserted into the message before it is sent.","pos":[2738,2812]},{"content":"On receiving request or receiving response, the activity ID is retrieved from the message header as soon as the received message object is created.","pos":[2822,2969]},{"content":"The activity ID in TLS is propagated as soon as the message disappears from scope until user code is reached.","pos":[2970,3079]},{"content":"These actions guarantee that user traces will appear in the same activity if propagation is on.","pos":[3086,3181]},{"content":"However, it makes no guarantee on ServiceModel traces.","pos":[3182,3236]},{"content":"ServiceModel traces occur in a user code activity only if the processing of those traces is executed on the same thread where the user code activity was set.","pos":[3237,3394]},{"content":"In general, ServiceModel traces can be observed in the following places:","pos":[3401,3473]},{"content":"If ServiceModel tracing is disabled, all emitted traces appear in user activities.","pos":[3483,3565]},{"content":"If propagation is enabled at both the server and client, these traces will be in the same activity.","pos":[3566,3665]},{"content":"If ServiceModel tracing is enabled, but ActivityTracing is disabled, user traces appear in the same activity if propagation is enabled on both ends.","pos":[3675,3823]},{"content":"ServiceModel traces appear in the default 0000 activity, unless they occur in the same thread as the user code processing where the activity is initially set.","pos":[3824,3982]},{"content":"If both ServiceModel tracing and ActivityTracing are enabled, user traces appear in user-defined activities, and ServiceModel traces appear in ServiceModel-defined activities.","pos":[3992,4167]},{"content":"Propagation happens at ServiceModel level.","pos":[4168,4210]}]}