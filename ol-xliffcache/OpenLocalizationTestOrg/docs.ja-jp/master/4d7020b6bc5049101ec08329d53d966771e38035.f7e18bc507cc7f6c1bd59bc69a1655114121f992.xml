{"content":"---\ntitle: \"Using an Asynchronous Client Socket\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"application protocols, sockets\"\n  - \"sending data, sockets\"\n  - \"data requests, sockets\"\n  - \"asynchronous client sockets\"\n  - \"Socket class, asynchronous client sockets\"\n  - \"requesting data from Internet, sockets\"\n  - \"sockets, asynchronous client sockets\"\n  - \"receiving data, sockets\"\n  - \"protocols, sockets\"\n  - \"Internet, sockets\"\n  - \"client sockets\"\nms.assetid: fd85bc88-e06c-467d-a30d-9fd7cffcfca1\n---\n# Using an Asynchronous Client Socket\nAn asynchronous client socket does not suspend the application while waiting for network operations to complete. Instead, it uses the standard .NET Framework asynchronous programming model to process the network connection on one thread while the application continues to run on the original thread. Asynchronous sockets are appropriate for applications that make heavy use of the network or that cannot wait for network operations to complete before continuing.  \n  \n The <xref:System.Net.Sockets.Socket> class follows the .NET Framework naming pattern for asynchronous methods; for example, the synchronous <xref:System.Net.Sockets.Socket.Receive%2A> method corresponds to the asynchronous <xref:System.Net.Sockets.Socket.BeginReceive%2A> and <xref:System.Net.Sockets.Socket.EndReceive%2A> methods.  \n  \n Asynchronous operations require a callback method to return the result of the operation. If your application does not need to know the result, then no callback method is required. The example code in this section demonstrates using a method to start connecting to a network device and a callback method to complete the connection, a method to start sending data and a callback method to complete the send, and a method to start receiving data and a callback method to end receiving data.  \n  \n Asynchronous sockets use multiple threads from the system thread pool to process network connections. One thread is responsible for initiating the sending or receiving of data; other threads complete the connection to the network device and send or receive the data. In the following examples, instances of the <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> class are used to suspend execution of the main thread and signal when execution can continue.  \n  \n In the following example, to connect an asynchronous socket to a network device, the `Connect` method initializes a **Socket** and then calls the <xref:System.Net.Sockets.Socket.Connect%2A?displayProperty=nameWithType> method, passing a remote endpoint that represents the network device, the connect callback method, and a state object (the client **Socket**), which is used to pass state information between asynchronous calls. The example implements the `Connect` method to connect the specified **Socket** to the specified endpoint. It assumes a global **ManualResetEvent** named `connectDone`.  \n  \n```vb  \nPublic Shared Sub Connect(remoteEP As EndPoint, client As Socket)  \n    client.BeginConnect(remoteEP, _  \n       AddressOf ConnectCallback, client)  \n  \n    connectDone.WaitOne()  \nEnd Sub 'Connect  \n```  \n  \n```csharp  \npublic static void Connect(EndPoint remoteEP, Socket client) {  \n    client.BeginConnect(remoteEP,   \n        new AsyncCallback(ConnectCallback), client );  \n  \n   connectDone.WaitOne();  \n}  \n```  \n  \n The connect callback method `ConnectCallback` implements the <xref:System.AsyncCallback> delegate. It connects to the remote device when the remote device is available and then signals the application thread that the connection is complete by setting the **ManualResetEvent** `connectDone`. The following code implements the `ConnectCallback` method.  \n  \n```vb  \nPrivate Shared Sub ConnectCallback(ar As IAsyncResult)  \n    Try  \n        ' Retrieve the socket from the state object.  \n        Dim client As Socket = CType(ar.AsyncState, Socket)  \n  \n        ' Complete the connection.  \n        client.EndConnect(ar)  \n  \n        Console.WriteLine(\"Socket connected to {0}\", _  \n            client.RemoteEndPoint.ToString())  \n  \n        ' Signal that the connection has been made.  \n        connectDone.Set()  \n    Catch e As Exception  \n        Console.WriteLine(e.ToString())  \n    End Try  \nEnd Sub 'ConnectCallback  \n```  \n  \n```csharp  \nprivate static void ConnectCallback(IAsyncResult ar) {  \n    try {  \n        // Retrieve the socket from the state object.  \n        Socket client = (Socket) ar.AsyncState;  \n  \n        // Complete the connection.  \n        client.EndConnect(ar);  \n  \n        Console.WriteLine(\"Socket connected to {0}\",  \n            client.RemoteEndPoint.ToString());  \n  \n        // Signal that the connection has been made.  \n        connectDone.Set();  \n    } catch (Exception e) {  \n        Console.WriteLine(e.ToString());  \n    }  \n}  \n```  \n  \n The example method `Send` encodes the specified string data in ASCII format and sends it asynchronously to the network device represented by the specified socket. The following example implements the `Send` method.  \n  \n```vb  \nPrivate Shared Sub Send(client As Socket, data As [String])  \n    ' Convert the string data to byte data using ASCII encoding.  \n    Dim byteData As Byte() = Encoding.ASCII.GetBytes(data)  \n  \n    ' Begin sending the data to the remote device.  \n    client.BeginSend(byteData, 0, byteData.Length, SocketFlags.None, _  \n        AddressOf SendCallback, client)  \nEnd Sub 'Send  \n```  \n  \n```csharp  \nprivate static void Send(Socket client, String data) {  \n    // Convert the string data to byte data using ASCII encoding.  \n    byte[] byteData = Encoding.ASCII.GetBytes(data);  \n  \n    // Begin sending the data to the remote device.  \n    client.BeginSend(byteData, 0, byteData.Length, SocketFlags.None,  \n        new AsyncCallback(SendCallback), client);  \n}  \n```  \n  \n The send callback method `SendCallback` implements the <xref:System.AsyncCallback> delegate. It sends the data when the network device is ready to receive. The following example shows the implementation of the `SendCallback` method. It assumes a global **ManualResetEvent** named `sendDone`.  \n  \n```vb  \nPrivate Shared Sub SendCallback(ar As IAsyncResult)  \n    Try  \n        ' Retrieve the socket from the state object.  \n        Dim client As Socket = CType(ar.AsyncState, Socket)  \n  \n        ' Complete sending the data to the remote device.  \n        Dim bytesSent As Integer = client.EndSend(ar)  \n        Console.WriteLine(\"Sent {0} bytes to server.\", bytesSent)  \n  \n        ' Signal that all bytes have been sent.  \n        sendDone.Set()  \n    Catch e As Exception  \n        Console.WriteLine(e.ToString())  \n    End Try  \nEnd Sub 'SendCallback  \n```  \n  \n```csharp  \nprivate static void SendCallback(IAsyncResult ar) {  \n    try {  \n        // Retrieve the socket from the state object.  \n        Socket client = (Socket) ar.AsyncState;  \n  \n        // Complete sending the data to the remote device.  \n        int bytesSent = client.EndSend(ar);  \n        Console.WriteLine(\"Sent {0} bytes to server.\", bytesSent);  \n  \n        // Signal that all bytes have been sent.  \n        sendDone.Set();  \n    } catch (Exception e) {  \n        Console.WriteLine(e.ToString());  \n    }  \n}  \n```  \n  \n Reading data from a client socket requires a state object that passes values between asynchronous calls. The following class is an example state object for receiving data from a client socket. It contains a field for the client socket, a buffer for the received data, and a <xref:System.Text.StringBuilder> to hold the incoming data string. Placing these fields in the state object allows their values to be preserved across multiple calls to read data from the client socket.  \n  \n```vb  \nPublic Class StateObject  \n    ' Client socket.  \n    Public workSocket As Socket = Nothing   \n    ' Size of receive buffer.  \n    Public BufferSize As Integer = 256  \n    ' Receive buffer.  \n    Public buffer(256) As Byte   \n    ' Received data string.  \n    Public sb As New StringBuilder()  \nEnd Class 'StateObject  \n```  \n  \n```csharp  \npublic class StateObject {  \n    // Client socket.  \n    public Socket workSocket = null;  \n    // Size of receive buffer.  \n    public const int BufferSize = 256;  \n    // Receive buffer.  \n    public byte[] buffer = new byte[BufferSize];  \n    // Received data string.  \n    public StringBuilder sb = new StringBuilder();  \n}  \n```  \n  \n The example `Receive` method sets up the state object and then calls the **BeginReceive** method to read the data from the client socket asynchronously. The following example implements the `Receive` method.  \n  \n```vb  \nPrivate Shared Sub Receive(client As Socket)  \n    Try  \n        ' Create the state object.  \n        Dim state As New StateObject()  \n        state.workSocket = client  \n  \n        ' Begin receiving the data from the remote device.  \n        client.BeginReceive(state.buffer, 0, state.BufferSize, 0, _  \n            AddressOf ReceiveCallback, state)  \n    Catch e As Exception  \n        Console.WriteLine(e.ToString())  \n    End Try  \nEnd Sub 'Receive  \n```  \n  \n```csharp  \nprivate static void Receive(Socket client) {  \n    try {  \n        // Create the state object.  \n        StateObject state = new StateObject();  \n        state.workSocket = client;  \n  \n        // Begin receiving the data from the remote device.  \n        client.BeginReceive( state.buffer, 0, StateObject.BufferSize, 0,  \n            new AsyncCallback(ReceiveCallback), state);  \n    } catch (Exception e) {  \n        Console.WriteLine(e.ToString());  \n    }  \n}  \n```  \n  \n The receive callback method `ReceiveCallback` implements the **AsyncCallback** delegate. It receives the data from the network device and builds a message string. It reads one or more bytes of data from the network into the data buffer and then calls the **BeginReceive** method again until the data sent by the client is complete. Once all the data is read from the client, `ReceiveCallback` signals the application thread that the data is complete by setting the **ManualResetEvent** `sendDone`.  \n  \n The following example code implements the `ReceiveCallback` method. It assumes a global string named `response` that holds the received string and a global **ManualResetEvent** named `receiveDone`. The server must shut down the client socket gracefully to end the network session.  \n  \n```vb  \nPrivate Shared Sub ReceiveCallback(ar As IAsyncResult)  \n    Try  \n        ' Retrieve the state object and the client socket   \n        ' from the asynchronous state object.  \n        Dim state As StateObject = CType(ar.AsyncState, StateObject)  \n        Dim client As Socket = state.workSocket  \n  \n        ' Read data from the remote device.  \n        Dim bytesRead As Integer = client.EndReceive(ar)  \n  \n        If bytesRead > 0 Then  \n            ' There might be more data, so store the data received so far.  \n            state.sb.Append(Encoding.ASCII.GetString(state.buffer, 0, _  \n                bytesRead))  \n  \n            '  Get the rest of the data.  \n            client.BeginReceive(state.buffer, 0, state.BufferSize, 0, _  \n                AddressOf ReceiveCallback, state)  \n        Else  \n            ' All the data has arrived; put it in response.  \n            If state.sb.Length > 1 Then  \n                response = state.sb.ToString()  \n            End If  \n            ' Signal that all bytes have been received.  \n            receiveDone.Set()  \n        End If  \n    Catch e As Exception  \n        Console.WriteLine(e.ToString())  \n    End Try  \nEnd Sub 'ReceiveCallback  \n```  \n  \n```csharp  \nprivate static void ReceiveCallback( IAsyncResult ar ) {  \n    try {  \n        // Retrieve the state object and the client socket   \n        // from the asynchronous state object.  \n        StateObject state = (StateObject) ar.AsyncState;  \n        Socket client = state.workSocket;  \n        // Read data from the remote device.  \n        int bytesRead = client.EndReceive(ar);  \n        if (bytesRead > 0) {  \n            // There might be more data, so store the data received so far.  \n            state.sb.Append(Encoding.ASCII.GetString(state.buffer,0,bytesRead));  \n                //  Get the rest of the data.  \n            client.BeginReceive(state.buffer,0,StateObject.BufferSize,0,  \n                new AsyncCallback(ReceiveCallback), state);  \n        } else {  \n            // All the data has arrived; put it in response.  \n            if (state.sb.Length > 1) {  \n                response = state.sb.ToString();  \n            }  \n            // Signal that all bytes have been received.  \n            receiveDone.Set();  \n        }  \n    } catch (Exception e) {  \n        Console.WriteLine(e.ToString());  \n    }  \n}  \n```  \n  \n## See also\n\n- [Using a Synchronous Client Socket](../../../docs/framework/network-programming/using-a-synchronous-client-socket.md)\n- [Listening with Sockets](../../../docs/framework/network-programming/listening-with-sockets.md)\n- [Asynchronous Client Socket Example](../../../docs/framework/network-programming/asynchronous-client-socket-example.md)\n","nodes":[{"pos":[4,539],"embed":true,"restype":"x-metadata","content":"title: \"Using an Asynchronous Client Socket\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"application protocols, sockets\"\n  - \"sending data, sockets\"\n  - \"data requests, sockets\"\n  - \"asynchronous client sockets\"\n  - \"Socket class, asynchronous client sockets\"\n  - \"requesting data from Internet, sockets\"\n  - \"sockets, asynchronous client sockets\"\n  - \"receiving data, sockets\"\n  - \"protocols, sockets\"\n  - \"Internet, sockets\"\n  - \"client sockets\"\nms.assetid: fd85bc88-e06c-467d-a30d-9fd7cffcfca1","nodes":[{"content":"Using an Asynchronous Client Socket","nodes":[{"pos":[0,35],"content":"Using an Asynchronous Client Socket","nodes":[{"content":"Using an Asynchronous Client Socket","pos":[0,35]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[546,581],"content":"Using an Asynchronous Client Socket","linkify":"Using an Asynchronous Client Socket","nodes":[{"content":"Using an Asynchronous Client Socket","pos":[0,35]}]},{"content":"An asynchronous client socket does not suspend the application while waiting for network operations to complete.","pos":[582,694]},{"content":"Instead, it uses the standard .NET Framework asynchronous programming model to process the network connection on one thread while the application continues to run on the original thread.","pos":[695,881]},{"content":"Asynchronous sockets are appropriate for applications that make heavy use of the network or that cannot wait for network operations to complete before continuing.","pos":[882,1044]},{"pos":[1051,1382],"content":"The <ph id=\"ph1\">&lt;xref:System.Net.Sockets.Socket&gt;</ph> class follows the .NET Framework naming pattern for asynchronous methods; for example, the synchronous <ph id=\"ph2\">&lt;xref:System.Net.Sockets.Socket.Receive%2A&gt;</ph> method corresponds to the asynchronous <ph id=\"ph3\">&lt;xref:System.Net.Sockets.Socket.BeginReceive%2A&gt;</ph> and <ph id=\"ph4\">&lt;xref:System.Net.Sockets.Socket.EndReceive%2A&gt;</ph> methods.","source":"The <xref:System.Net.Sockets.Socket> class follows the .NET Framework naming pattern for asynchronous methods; for example, the synchronous <xref:System.Net.Sockets.Socket.Receive%2A> method corresponds to the asynchronous <xref:System.Net.Sockets.Socket.BeginReceive%2A> and <xref:System.Net.Sockets.Socket.EndReceive%2A> methods."},{"content":"Asynchronous operations require a callback method to return the result of the operation.","pos":[1389,1477]},{"content":"If your application does not need to know the result, then no callback method is required.","pos":[1478,1568]},{"content":"The example code in this section demonstrates using a method to start connecting to a network device and a callback method to complete the connection, a method to start sending data and a callback method to complete the send, and a method to start receiving data and a callback method to end receiving data.","pos":[1569,1876]},{"content":"Asynchronous sockets use multiple threads from the system thread pool to process network connections.","pos":[1883,1984]},{"content":"One thread is responsible for initiating the sending or receiving of data; other threads complete the connection to the network device and send or receive the data.","pos":[1985,2149]},{"content":"In the following examples, instances of the <ph id=\"ph1\">&lt;xref:System.Threading.ManualResetEvent?displayProperty=nameWithType&gt;</ph> class are used to suspend execution of the main thread and signal when execution can continue.","pos":[2150,2358],"source":" In the following examples, instances of the <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> class are used to suspend execution of the main thread and signal when execution can continue."},{"content":"In the following example, to connect an asynchronous socket to a network device, the <ph id=\"ph1\">`Connect`</ph> method initializes a <bpt id=\"p1\">**</bpt>Socket<ept id=\"p1\">**</ept> and then calls the <ph id=\"ph2\">&lt;xref:System.Net.Sockets.Socket.Connect%2A?displayProperty=nameWithType&gt;</ph> method, passing a remote endpoint that represents the network device, the connect callback method, and a state object (the client <bpt id=\"p2\">**</bpt>Socket<ept id=\"p2\">**</ept>), which is used to pass state information between asynchronous calls.","pos":[2365,2794],"source":"In the following example, to connect an asynchronous socket to a network device, the `Connect` method initializes a **Socket** and then calls the <xref:System.Net.Sockets.Socket.Connect%2A?displayProperty=nameWithType> method, passing a remote endpoint that represents the network device, the connect callback method, and a state object (the client **Socket**), which is used to pass state information between asynchronous calls."},{"content":"The example implements the <ph id=\"ph1\">`Connect`</ph> method to connect the specified <bpt id=\"p1\">**</bpt>Socket<ept id=\"p1\">**</ept> to the specified endpoint.","pos":[2795,2901],"source":" The example implements the `Connect` method to connect the specified **Socket** to the specified endpoint."},{"content":"It assumes a global <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> named <ph id=\"ph1\">`connectDone`</ph>.","pos":[2902,2963],"source":" It assumes a global **ManualResetEvent** named `connectDone`."},{"content":"The connect callback method <ph id=\"ph1\">`ConnectCallback`</ph> implements the <ph id=\"ph2\">&lt;xref:System.AsyncCallback&gt;</ph> delegate.","pos":[3401,3499],"source":"The connect callback method `ConnectCallback` implements the <xref:System.AsyncCallback> delegate."},{"content":"It connects to the remote device when the remote device is available and then signals the application thread that the connection is complete by setting the <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> <ph id=\"ph1\">`connectDone`</ph>.","pos":[3500,3691],"source":" It connects to the remote device when the remote device is available and then signals the application thread that the connection is complete by setting the **ManualResetEvent** `connectDone`."},{"content":"The following code implements the <ph id=\"ph1\">`ConnectCallback`</ph> method.","pos":[3692,3751],"source":" The following code implements the `ConnectCallback` method."},{"content":"The example method <ph id=\"ph1\">`Send`</ph> encodes the specified string data in ASCII format and sends it asynchronously to the network device represented by the specified socket.","pos":[4883,5045],"source":"The example method `Send` encodes the specified string data in ASCII format and sends it asynchronously to the network device represented by the specified socket."},{"content":"The following example implements the <ph id=\"ph1\">`Send`</ph> method.","pos":[5046,5097],"source":" The following example implements the `Send` method."},{"content":"The send callback method <ph id=\"ph1\">`SendCallback`</ph> implements the <ph id=\"ph2\">&lt;xref:System.AsyncCallback&gt;</ph> delegate.","pos":[5883,5975],"source":"The send callback method `SendCallback` implements the <xref:System.AsyncCallback> delegate."},{"content":"It sends the data when the network device is ready to receive.","pos":[5976,6038]},{"content":"The following example shows the implementation of the <ph id=\"ph1\">`SendCallback`</ph> method.","pos":[6039,6115],"source":" The following example shows the implementation of the `SendCallback` method."},{"content":"It assumes a global <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> named <ph id=\"ph1\">`sendDone`</ph>.","pos":[6116,6174],"source":" It assumes a global **ManualResetEvent** named `sendDone`."},{"content":"Reading data from a client socket requires a state object that passes values between asynchronous calls.","pos":[7288,7392]},{"content":"The following class is an example state object for receiving data from a client socket.","pos":[7393,7480]},{"content":"It contains a field for the client socket, a buffer for the received data, and a <ph id=\"ph1\">&lt;xref:System.Text.StringBuilder&gt;</ph> to hold the incoming data string.","pos":[7481,7628],"source":" It contains a field for the client socket, a buffer for the received data, and a <xref:System.Text.StringBuilder> to hold the incoming data string."},{"content":"Placing these fields in the state object allows their values to be preserved across multiple calls to read data from the client socket.","pos":[7629,7764]},{"content":"The example <ph id=\"ph1\">`Receive`</ph> method sets up the state object and then calls the <bpt id=\"p1\">**</bpt>BeginReceive<ept id=\"p1\">**</ept> method to read the data from the client socket asynchronously.","pos":[8459,8611],"source":"The example `Receive` method sets up the state object and then calls the **BeginReceive** method to read the data from the client socket asynchronously."},{"content":"The following example implements the <ph id=\"ph1\">`Receive`</ph> method.","pos":[8612,8666],"source":" The following example implements the `Receive` method."},{"content":"The receive callback method <ph id=\"ph1\">`ReceiveCallback`</ph> implements the <bpt id=\"p1\">**</bpt>AsyncCallback<ept id=\"p1\">**</ept> delegate.","pos":[9632,9720],"source":"The receive callback method `ReceiveCallback` implements the **AsyncCallback** delegate."},{"content":"It receives the data from the network device and builds a message string.","pos":[9721,9794]},{"content":"It reads one or more bytes of data from the network into the data buffer and then calls the <bpt id=\"p1\">**</bpt>BeginReceive<ept id=\"p1\">**</ept> method again until the data sent by the client is complete.","pos":[9795,9963],"source":" It reads one or more bytes of data from the network into the data buffer and then calls the **BeginReceive** method again until the data sent by the client is complete."},{"content":"Once all the data is read from the client, <ph id=\"ph1\">`ReceiveCallback`</ph> signals the application thread that the data is complete by setting the <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> <ph id=\"ph2\">`sendDone`</ph>.","pos":[9964,10129],"source":" Once all the data is read from the client, `ReceiveCallback` signals the application thread that the data is complete by setting the **ManualResetEvent** `sendDone`."},{"content":"The following example code implements the <ph id=\"ph1\">`ReceiveCallback`</ph> method.","pos":[10136,10203],"source":"The following example code implements the `ReceiveCallback` method."},{"content":"It assumes a global string named <ph id=\"ph1\">`response`</ph> that holds the received string and a global <bpt id=\"p1\">**</bpt>ManualResetEvent<ept id=\"p1\">**</ept> named <ph id=\"ph2\">`receiveDone`</ph>.","pos":[10204,10333],"source":" It assumes a global string named `response` that holds the received string and a global **ManualResetEvent** named `receiveDone`."},{"content":"The server must shut down the client socket gracefully to end the network session.","pos":[10334,10416]},{"pos":[12798,12806],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[12810,12927],"content":"<bpt id=\"p1\">[</bpt>Using a Synchronous Client Socket<ept id=\"p1\">](../../../docs/framework/network-programming/using-a-synchronous-client-socket.md)</ept>","source":"[Using a Synchronous Client Socket](../../../docs/framework/network-programming/using-a-synchronous-client-socket.md)"},{"pos":[12930,13025],"content":"<bpt id=\"p1\">[</bpt>Listening with Sockets<ept id=\"p1\">](../../../docs/framework/network-programming/listening-with-sockets.md)</ept>","source":"[Listening with Sockets](../../../docs/framework/network-programming/listening-with-sockets.md)"},{"pos":[13028,13147],"content":"<bpt id=\"p1\">[</bpt>Asynchronous Client Socket Example<ept id=\"p1\">](../../../docs/framework/network-programming/asynchronous-client-socket-example.md)</ept>","source":"[Asynchronous Client Socket Example](../../../docs/framework/network-programming/asynchronous-client-socket-example.md)"}]}