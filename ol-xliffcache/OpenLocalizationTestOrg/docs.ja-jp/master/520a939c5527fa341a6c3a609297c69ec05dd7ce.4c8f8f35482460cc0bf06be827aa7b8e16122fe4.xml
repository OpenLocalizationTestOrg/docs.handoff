{"content":"---\ntitle: \"Extending Control Over Error Handling and Reporting\"\nms.date: \"03/30/2017\"\nms.assetid: 45f996a7-fa00-45cb-9d6f-b368f5778aaa\n---\n# Extending Control Over Error Handling and Reporting\nThis sample demonstrates how to extend control over error handling and error reporting in a Windows Communication Foundation (WCF) service using the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface. The sample is based on the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md) with some additional code added to the service to handle errors. The client forces several error conditions. The service intercepts the errors and logs them in a file.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n Services can intercept errors, perform processing, and affect how errors are reported using the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface. The interface has two methods that can be implemented: <xref:System.ServiceModel.Dispatcher.IErrorHandler.ProvideFault%28System.Exception%2CSystem.ServiceModel.Channels.MessageVersion%2CSystem.ServiceModel.Channels.Message%40%29> and <xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A>. The <xref:System.ServiceModel.Dispatcher.IErrorHandler.ProvideFault%28System.Exception%2CSystem.ServiceModel.Channels.MessageVersion%2CSystem.ServiceModel.Channels.Message%40%29> method allows you to add, modify, or suppress a fault message that is generated in response to an exception. The <xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A> method allows error processing to take place in the event of an error and controls whether additional error handling can run.  \n  \n In this sample, the `CalculatorErrorHandler` type implements the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface. In the  \n  \n <xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A> method, the `CalculatorErrorHandler` writes a log of the error to an Error.txt text file in c:\\logs. Note that the sample logs the fault and does not suppress it, allowing it to be reported back to the client.  \n  \n```  \npublic class CalculatorErrorHandler : IErrorHandler  \n{  \n        // Provide a fault. The Message fault parameter can be replaced, or set to  \n        // null to suppress reporting a fault.  \n  \n        public void ProvideFault(Exception error, MessageVersion version, ref Message fault)  \n        {  \n        }  \n  \n        // HandleError. Log an error, then allow the error to be handled as usual.  \n        // Return true if the error is considered as already handled  \n  \n        public bool HandleError(Exception error)  \n        {  \n            using (TextWriter tw = File.AppendText(@\"c:\\logs\\error.txt\"))  \n            {  \n                if (error != null)  \n                {  \n                    tw.WriteLine(\"Exception: \" + error.GetType().Name + \" - \" + error.Message);  \n                }  \n                tw.Close();  \n            }  \n            return true;  \n        }  \n    }  \n```  \n  \n The `ErrorBehaviorAttribute` exists as a mechanism to register an error handler with a service. This attribute takes a single type parameter. That type should implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface and should have a public, empty constructor. The attribute then instantiates an instance of that error handler type and installs it into the service. It does this by implementing the <xref:System.ServiceModel.Description.IServiceBehavior> interface and then using the <xref:System.ServiceModel.Description.IServiceBehavior.ApplyDispatchBehavior%2A> method to add instances of the error handler to the service.  \n  \n```  \n// This attribute can be used to install a custom error handler for a service.  \npublic class ErrorBehaviorAttribute : Attribute, IServiceBehavior  \n{  \n    Type errorHandlerType;  \n  \n    public ErrorBehaviorAttribute(Type errorHandlerType)  \n    {  \n        this.errorHandlerType = errorHandlerType;  \n    }  \n  \n    void IServiceBehavior.Validate(ServiceDescription description, ServiceHostBase serviceHostBase)  \n    {  \n    }  \n  \n    void IServiceBehavior.AddBindingParameters(ServiceDescription description, ServiceHostBase serviceHostBase, System.Collections.ObjectModel.Collection<ServiceEndpoint> endpoints, BindingParameterCollection parameters)  \n    {  \n    }  \n  \n    void IServiceBehavior.ApplyDispatchBehavior(ServiceDescription description, ServiceHostBase serviceHostBase)  \n    {  \n        IErrorHandler errorHandler;  \n  \n        try  \n        {  \n            errorHandler = (IErrorHandler)Activator.CreateInstance(errorHandlerType);  \n        }  \n        catch (MissingMethodException e)  \n        {  \n            throw new ArgumentException(\"The errorHandlerType specified in the ErrorBehaviorAttribute constructor must have a public empty constructor.\", e);  \n        }  \n        catch (InvalidCastException e)  \n        {  \n            throw new ArgumentException(\"The errorHandlerType specified in the ErrorBehaviorAttribute constructor must implement System.ServiceModel.Dispatcher.IErrorHandler.\", e);  \n        }  \n  \n        foreach (ChannelDispatcherBase channelDispatcherBase in serviceHostBase.ChannelDispatchers)  \n        {  \n            ChannelDispatcher channelDispatcher = channelDispatcherBase as ChannelDispatcher;  \n            channelDispatcher.ErrorHandlers.Add(errorHandler);  \n        }                                                  \n    }  \n}  \n```  \n  \n The sample implements a calculator service. The client deliberately causes two errors to occur on the service by providing parameters with illegal values. The `CalculatorErrorHandler` uses the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to log the errors to a local file and then allows them to be reported back to the client. The client forces a divide by zero and an argument-out-of-range condition.  \n  \n```  \ntry  \n{  \n    Console.WriteLine(\"Forcing an error in Divide\");  \n    // Call the Divide service operation - trigger a divide by 0 error.  \n    value1 = 22;  \n    value2 = 0;  \n    result = proxy.Divide(value1, value2);  \n    Console.WriteLine(\"Divide({0},{1}) = {2}\", value1, value2, result);  \n}  \ncatch (FaultException e)  \n{  \n    Console.WriteLine(\"FaultException: \" + e.GetType().Name + \" - \" + e.Message);  \n}  \ncatch (Exception e)  \n{  \n    Console.WriteLine(\"Exception: \" + e.GetType().Name + \" - \" + e.Message);  \n}  \n```  \n  \n When you run the sample, the operation requests and responses are displayed in the client console window. You see the division by zero and the argument-out-of-range conditions being reported as faults. Press ENTER in the client window to shut down the client.  \n  \n```  \nAdd(15,3) = 18  \nSubtract(145,76) = 69  \nMultiply(9,81) = 729  \nForcing an error in Divide  \nFaultException: FaultException - Invalid Argument: The second argument must not be zero.  \nForcing an error in Factorial  \nFaultException: FaultException - Invalid Argument: The argument must be greater than zero.  \n  \nPress <ENTER> to terminate client.  \n```  \n  \n The file c:\\logs\\errors.txt contains the information logged about the errors by the service. Note that for the service to write to the directory you must make sure that the process under which the service is running, (typically ASP.NET or Network Service), has the permission to write to the directory.  \n  \n```  \nFault: Reason = Invalid Argument: The second argument must not be zero.  \nFault: Reason = Invalid Argument: The argument must be greater than zero.  \n```  \n  \n### To set up, build, and run the sample  \n  \n1.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).  \n  \n2.  To build the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n3.  Ensure you have created the c:\\logs directory for the error.txt file. Or modify the file name used in `CalculatorErrorHandler.HandleError`.  \n  \n4.  To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Extensibility\\ErrorHandling`  \n","nodes":[{"pos":[4,135],"embed":true,"restype":"x-metadata","content":"title: \"Extending Control Over Error Handling and Reporting\"\nms.date: \"03/30/2017\"\nms.assetid: 45f996a7-fa00-45cb-9d6f-b368f5778aaa","nodes":[{"content":"Extending Control Over Error Handling and Reporting","nodes":[{"pos":[0,51],"content":"Extending Control Over Error Handling and Reporting","nodes":[{"content":"Extending Control Over Error Handling and Reporting","pos":[0,51]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[142,193],"content":"Extending Control Over Error Handling and Reporting","linkify":"Extending Control Over Error Handling and Reporting","nodes":[{"content":"Extending Control Over Error Handling and Reporting","pos":[0,51]}]},{"content":"This sample demonstrates how to extend control over error handling and error reporting in a Windows Communication Foundation (WCF) service using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler&gt;</ph> interface.","pos":[194,405],"source":"This sample demonstrates how to extend control over error handling and error reporting in a Windows Communication Foundation (WCF) service using the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface."},{"content":"The sample is based on the <bpt id=\"p1\">[</bpt>Getting Started<ept id=\"p1\">](../../../../docs/framework/wcf/samples/getting-started-sample.md)</ept> with some additional code added to the service to handle errors.","pos":[406,581],"source":" The sample is based on the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md) with some additional code added to the service to handle errors."},{"content":"The client forces several error conditions.","pos":[582,625]},{"content":"The service intercepts the errors and logs them in a file.","pos":[626,684]},{"pos":[692,799],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"content":"Services can intercept errors, perform processing, and affect how errors are reported using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler&gt;</ph> interface.","pos":[806,964],"source":"Services can intercept errors, perform processing, and affect how errors are reported using the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface."},{"content":"The interface has two methods that can be implemented: <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler.ProvideFault%28System.Exception%2CSystem.ServiceModel.Channels.MessageVersion%2CSystem.ServiceModel.Channels.Message%40%29&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A&gt;</ph>.","pos":[965,1266],"source":" The interface has two methods that can be implemented: <xref:System.ServiceModel.Dispatcher.IErrorHandler.ProvideFault%28System.Exception%2CSystem.ServiceModel.Channels.MessageVersion%2CSystem.ServiceModel.Channels.Message%40%29> and <xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A>."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler.ProvideFault%28System.Exception%2CSystem.ServiceModel.Channels.MessageVersion%2CSystem.ServiceModel.Channels.Message%40%29&gt;</ph> method allows you to add, modify, or suppress a fault message that is generated in response to an exception.","pos":[1267,1554],"source":" The <xref:System.ServiceModel.Dispatcher.IErrorHandler.ProvideFault%28System.Exception%2CSystem.ServiceModel.Channels.MessageVersion%2CSystem.ServiceModel.Channels.Message%40%29> method allows you to add, modify, or suppress a fault message that is generated in response to an exception."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A&gt;</ph> method allows error processing to take place in the event of an error and controls whether additional error handling can run.","pos":[1555,1751],"source":" The <xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A> method allows error processing to take place in the event of an error and controls whether additional error handling can run."},{"content":"In this sample, the <ph id=\"ph1\">`CalculatorErrorHandler`</ph> type implements the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler&gt;</ph> interface.","pos":[1758,1885],"source":"In this sample, the `CalculatorErrorHandler` type implements the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface."},{"content":"In the","pos":[1886,1892]},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A&gt;</ph> method, the <ph id=\"ph2\">`CalculatorErrorHandler`</ph> writes a log of the error to an Error.txt text file in c:\\logs.","pos":[1899,2066],"source":"<xref:System.ServiceModel.Dispatcher.IErrorHandler.HandleError%2A> method, the `CalculatorErrorHandler` writes a log of the error to an Error.txt text file in c:\\logs."},{"content":"Note that the sample logs the fault and does not suppress it, allowing it to be reported back to the client.","pos":[2067,2175]},{"content":"The <ph id=\"ph1\">`ErrorBehaviorAttribute`</ph> exists as a mechanism to register an error handler with a service.","pos":[3096,3191],"source":"The `ErrorBehaviorAttribute` exists as a mechanism to register an error handler with a service."},{"content":"This attribute takes a single type parameter.","pos":[3192,3237]},{"content":"That type should implement the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler&gt;</ph> interface and should have a public, empty constructor.","pos":[3238,3375],"source":" That type should implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface and should have a public, empty constructor."},{"content":"The attribute then instantiates an instance of that error handler type and installs it into the service.","pos":[3376,3480]},{"content":"It does this by implementing the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.IServiceBehavior&gt;</ph> interface and then using the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.IServiceBehavior.ApplyDispatchBehavior%2A&gt;</ph> method to add instances of the error handler to the service.","pos":[3481,3740],"source":" It does this by implementing the <xref:System.ServiceModel.Description.IServiceBehavior> interface and then using the <xref:System.ServiceModel.Description.IServiceBehavior.ApplyDispatchBehavior%2A> method to add instances of the error handler to the service."},{"content":"The sample implements a calculator service.","pos":[5555,5598]},{"content":"The client deliberately causes two errors to occur on the service by providing parameters with illegal values.","pos":[5599,5709]},{"content":"The <ph id=\"ph1\">`CalculatorErrorHandler`</ph> uses the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IErrorHandler&gt;</ph> interface to log the errors to a local file and then allows them to be reported back to the client.","pos":[5710,5899],"source":" The `CalculatorErrorHandler` uses the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to log the errors to a local file and then allows them to be reported back to the client."},{"content":"The client forces a divide by zero and an argument-out-of-range condition.","pos":[5900,5974]},{"content":"When you run the sample, the operation requests and responses are displayed in the client console window.","pos":[6523,6628]},{"content":"You see the division by zero and the argument-out-of-range conditions being reported as faults.","pos":[6629,6724]},{"content":"Press ENTER in the client window to shut down the client.","pos":[6725,6782]},{"content":"The file c:\\logs\\errors.txt contains the information logged about the errors by the service.","pos":[7153,7245]},{"content":"Note that for the service to write to the directory you must make sure that the process under which the service is running, (typically ASP.NET or Network Service), has the permission to write to the directory.","pos":[7246,7455]},{"pos":[7630,7666],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[7676,7875],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"pos":[7885,8055],"content":"To build the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"content":"Ensure you have created the c:\\logs directory for the error.txt file.","pos":[8065,8134]},{"content":"Or modify the file name used in <ph id=\"ph1\">`CalculatorErrorHandler.HandleError`</ph>.","pos":[8135,8204],"source":" Or modify the file name used in `CalculatorErrorHandler.HandleError`."},{"pos":[8214,8422],"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[8430,8562],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[8616,8926],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[8927,8977]}]}