{"content":"---\ntitle: \"Workflow Service Host Extensibility\"\nms.date: \"03/30/2017\"\nms.assetid: c0e8f7bb-cb13-49ec-852f-b85d7c23972f\n---\n# Workflow Service Host Extensibility\n[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] provides the <xref:System.ServiceModel.Activities.WorkflowServiceHost> class for hosting workflow services. This class is used when you are self-hosting a workflow service in a managed application or a Windows service. This class is also used when hosting a workflow service with Internet Information Services (IIS) or Windows Process Activation Service (WAS). The <xref:System.ServiceModel.Activities.WorkflowServiceHost> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities).  \n  \n## Workflow Service Host Extensions  \n The <xref:System.ServiceModel.Activities.WorkflowServiceHost> contains a <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> property of type <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> that provides methods to add extensions to the <xref:System.ServiceModel.Activities.WorkflowServiceHost>. Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service instance. The delegate specified is called to create a new extension when a workflow service instance is created or loaded from a persistence store. Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances.  \n  \n## React to Unhandled Exceptions  \n The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> enables you to specify the action to take if an unhandled exception occurs within a workflow service. The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> property specifies one of the <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> values:  \n  \n-   <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – Aborts the workflow service instance.  \n  \n-   <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – Rolls back to the last persisted state and suspends the workflow service instance. This only occurs if the workflow has already been persisted at least once. If not the workflow instance is aborted.  \n  \n-   <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – Cancels the instance.  \n  \n-   <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – Terminates the instance.  \n  \n This behavior can be configured in code as shown in the following example.  \n  \n```csharp  \nhost.Description.Behaviors.Add(new WorkflowUnhandledExceptionBehavior { Action = WorkflowUnhandledExceptionAction.Abandon });  \n```  \n  \n It can also be configured in a configuration file as shown in the following example.  \n  \n```xml\n<behaviors>  \n      <serviceBehaviors>  \n        <behavior>  \n          <serviceMetadata httpGetEnabled=\"True\"/>  \n          <serviceDebug includeExceptionDetailInFaults=\"False\" />  \n          <workflowUnhandledExceptionBehavior action=\"Abandon\" />        \n        </behavior>  \n      </serviceBehaviors>  \n```  \n  \n## Hosting Non-Service Workflows  \n <xref:System.ServiceModel.Activities.WorkflowServiceHost> can be used to host non-service workflows, or workflows that either do not begin with a <xref:System.ServiceModel.Activities.Receive> activity or workflows that do not use the messaging activities. Workflow services normally begin with a <xref:System.ServiceModel.Activities.Receive> activity. When the <xref:System.ServiceModel.Activities.WorkflowServiceHost> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created. If a workflow does not begin with a Receive activity, it cannot be started by sending a message because there is no activity to receive the message. To host a non-service workflow, derive a class from <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> and override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>, and <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>. Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> if you want to provide a preferred instance ID. Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> to create a custom workflow creation context or populate an instance of the existing <xref:System.ServiceModel.Activities.WorkflowCreationContext>. Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> to manually extract the bookmark from the incoming message. If you override this method, you must invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> in its body so as to respond to the message sent to the WorkflowHostingEndpoint. If you do not do so, a <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> limit may be eventually exceeded. In two-way contracts, you may be able to detect your   failure to invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> because of the client’s failure to receive a response. In one-way contracts, you may not recognize the mistake of failing to call <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> until it’s too late, after the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> throttle limit is exceeded. For more information, please see the [WorkflowHostingEndpoint Resume Bookmark](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance. The creation operation should take an IDictionary\\<string, object> to pass any required workflow parameters. This contract is implicitly implemented by the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class. When hosting the workflow, add an instance of the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class to the host by calling <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> and call <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>. To create an instance of the workflow, create a <xref:System.ServiceModel.ChannelFactory%601> of your service contract type and call <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>. You can then call the create operation defined in your service contract.  \n  \n## See also\n\n- [Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)\n- [Messaging Activities](../../../../docs/framework/wcf/feature-details/messaging-activities.md)\n","nodes":[{"pos":[4,119],"embed":true,"restype":"x-metadata","content":"title: \"Workflow Service Host Extensibility\"\nms.date: \"03/30/2017\"\nms.assetid: c0e8f7bb-cb13-49ec-852f-b85d7c23972f","nodes":[{"content":"Workflow Service Host Extensibility","nodes":[{"pos":[0,35],"content":"Workflow Service Host Extensibility","nodes":[{"content":"Workflow Service Host Extensibility","pos":[0,35]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[126,161],"content":"Workflow Service Host Extensibility","linkify":"Workflow Service Host Extensibility","nodes":[{"content":"Workflow Service Host Extensibility","pos":[0,35]}]},{"content":"<ph id=\"ph1\">[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</ph> provides the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> class for hosting workflow services.","pos":[162,347],"source":"[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] provides the <xref:System.ServiceModel.Activities.WorkflowServiceHost> class for hosting workflow services."},{"content":"This class is used when you are self-hosting a workflow service in a managed application or a Windows service.","pos":[348,458]},{"content":"This class is also used when hosting a workflow service with Internet Information Services (IIS) or Windows Process Activation Service (WAS).","pos":[459,600]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities).","pos":[601,842],"source":" The <xref:System.ServiceModel.Activities.WorkflowServiceHost> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities)."},{"pos":[851,883],"content":"Workflow Service Host Extensions","linkify":"Workflow Service Host Extensions","nodes":[{"content":"Workflow Service Host Extensions","pos":[0,32]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> contains a <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A&gt;</ph> property of type <ph id=\"ph3\">&lt;xref:System.Activities.Hosting.WorkflowInstanceExtensionManager&gt;</ph> that provides methods to add extensions to the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph>.","pos":[887,1228],"source":"The <xref:System.ServiceModel.Activities.WorkflowServiceHost> contains a <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> property of type <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> that provides methods to add extensions to the <xref:System.ServiceModel.Activities.WorkflowServiceHost>."},{"content":"Use the <ph id=\"ph1\">&lt;xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A&gt;</ph> method to add an extension for each workflow service instance.","pos":[1229,1372],"source":" Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service instance."},{"content":"The delegate specified is called to create a new extension when a workflow service instance is created or loaded from a persistence store.","pos":[1373,1511]},{"content":"Use the <ph id=\"ph1\">&lt;xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A&gt;</ph> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances.","pos":[1512,1727],"source":" Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances."},{"pos":[1736,1765],"content":"React to Unhandled Exceptions","linkify":"React to Unhandled Exceptions","nodes":[{"content":"React to Unhandled Exceptions","pos":[0,29]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior&gt;</ph> enables you to specify the action to take if an unhandled exception occurs within a workflow service.","pos":[1769,1959],"source":"The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> enables you to specify the action to take if an unhandled exception occurs within a workflow service."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A&gt;</ph> property specifies one of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction&gt;</ph> values:","pos":[1960,2179],"source":" The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> property specifies one of the <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> values:"},{"pos":[2189,2319],"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon&gt;</ph> – Aborts the workflow service instance.","source":"<xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – Aborts the workflow service instance."},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend&gt;</ph> – Rolls back to the last persisted state and suspends the workflow service instance.","pos":[2329,2514],"source":"<xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – Rolls back to the last persisted state and suspends the workflow service instance."},{"content":"This only occurs if the workflow has already been persisted at least once.","pos":[2515,2589]},{"content":"If not the workflow instance is aborted.","pos":[2590,2630]},{"pos":[2640,2753],"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel&gt;</ph> – Cancels the instance.","source":"<xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – Cancels the instance."},{"pos":[2763,2882],"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate&gt;</ph> – Terminates the instance.","source":"<xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – Terminates the instance."},{"content":"This behavior can be configured in code as shown in the following example.","pos":[2889,2963]},{"content":"It can also be configured in a configuration file as shown in the following example.","pos":[3119,3203]},{"pos":[3535,3564],"content":"Hosting Non-Service Workflows","linkify":"Hosting Non-Service Workflows","nodes":[{"content":"Hosting Non-Service Workflows","pos":[0,29]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> can be used to host non-service workflows, or workflows that either do not begin with a <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity or workflows that do not use the messaging activities.","pos":[3568,3823],"source":"<xref:System.ServiceModel.Activities.WorkflowServiceHost> can be used to host non-service workflows, or workflows that either do not begin with a <xref:System.ServiceModel.Activities.Receive> activity or workflows that do not use the messaging activities."},{"content":"Workflow services normally begin with a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity.","pos":[3824,3919],"source":" Workflow services normally begin with a <xref:System.ServiceModel.Activities.Receive> activity."},{"content":"When the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created.","pos":[3920,4117],"source":" When the <xref:System.ServiceModel.Activities.WorkflowServiceHost> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created."},{"content":"If a workflow does not begin with a Receive activity, it cannot be started by sending a message because there is no activity to receive the message.","pos":[4118,4266]},{"content":"To host a non-service workflow, derive a class from <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint&gt;</ph> and override <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A&gt;</ph>, <ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A&gt;</ph>, and <ph id=\"ph4\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A&gt;</ph>.","pos":[4267,4650],"source":" To host a non-service workflow, derive a class from <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> and override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>, and <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>."},{"content":"Override <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A&gt;</ph> if you want to provide a preferred instance ID.","pos":[4651,4788],"source":" Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> if you want to provide a preferred instance ID."},{"content":"Override <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A&gt;</ph> to create a custom workflow creation context or populate an instance of the existing <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowCreationContext&gt;</ph>.","pos":[4789,5031],"source":" Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> to create a custom workflow creation context or populate an instance of the existing <xref:System.ServiceModel.Activities.WorkflowCreationContext>."},{"content":"Override <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A&gt;</ph> to manually extract the bookmark from the incoming message.","pos":[5032,5183],"source":" Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> to manually extract the bookmark from the incoming message."},{"content":"If you override this method, you must invoke <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A&gt;</ph> in its body so as to respond to the message sent to the WorkflowHostingEndpoint.","pos":[5184,5394],"source":" If you override this method, you must invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> in its body so as to respond to the message sent to the WorkflowHostingEndpoint."},{"content":"If you do not do so, a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A&gt;</ph> limit may be eventually exceeded.","pos":[5395,5538],"source":" If you do not do so, a <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> limit may be eventually exceeded."},{"content":"In two-way contracts, you may be able to detect your   failure to invoke <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A&gt;</ph> because of the client’s failure to receive a response.","pos":[5539,5751],"source":" In two-way contracts, you may be able to detect your   failure to invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> because of the client’s failure to receive a response."},{"content":"In one-way contracts, you may not recognize the mistake of failing to call <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A&gt;</ph> until it’s too late, after the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A&gt;</ph> throttle limit is exceeded.","pos":[5752,6057],"source":" In one-way contracts, you may not recognize the mistake of failing to call <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> until it’s too late, after the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> throttle limit is exceeded."},{"content":"For more information, please see the <bpt id=\"p1\">[</bpt>WorkflowHostingEndpoint Resume Bookmark<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)</ept>To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance.","pos":[6058,6376],"source":" For more information, please see the [WorkflowHostingEndpoint Resume Bookmark](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance."},{"content":"The creation operation should take an IDictionary<ph id=\"ph1\">\\&lt;</ph>string, object&gt; to pass any required workflow parameters.","pos":[6377,6485],"source":" The creation operation should take an IDictionary\\<string, object> to pass any required workflow parameters."},{"content":"This contract is implicitly implemented by the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint&gt;</ph>-derived class.","pos":[6486,6609],"source":" This contract is implicitly implemented by the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class."},{"content":"When hosting the workflow, add an instance of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowHostingEndpoint&gt;</ph>-derived class to the host by calling <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A&gt;</ph> and call <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.CommunicationObject.Open%2A&gt;</ph>.","pos":[6610,6912],"source":" When hosting the workflow, add an instance of the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class to the host by calling <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> and call <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>."},{"content":"To create an instance of the workflow, create a <ph id=\"ph1\">&lt;xref:System.ServiceModel.ChannelFactory%601&gt;</ph> of your service contract type and call <ph id=\"ph2\">&lt;xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A&gt;</ph>.","pos":[6913,7109],"source":" To create an instance of the workflow, create a <xref:System.ServiceModel.ChannelFactory%601> of your service contract type and call <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>."},{"content":"You can then call the create operation defined in your service contract.","pos":[7110,7182]},{"pos":[7191,7199],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[7203,7291],"content":"<bpt id=\"p1\">[</bpt>Workflow Services<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/workflow-services.md)</ept>","source":"[Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)"},{"pos":[7294,7388],"content":"<bpt id=\"p1\">[</bpt>Messaging Activities<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/messaging-activities.md)</ept>","source":"[Messaging Activities](../../../../docs/framework/wcf/feature-details/messaging-activities.md)"}]}