{"content":"---\ntitle: \"How to: Create a Custom Authorization Policy\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: 05b0549b-882d-4660-b6f0-5678543e5475\n---\n# How to: Create a Custom Authorization Policy\nThe Identity Model infrastructure in Windows Communication Foundation (WCF) supports a claim-based authorization model. Claims are extracted from tokens, optionally processed by custom authorization policy, and then placed into an <xref:System.IdentityModel.Policy.AuthorizationContext> that can then be examined to make authorization decisions. A custom policy can be used to transform claims from incoming tokens into claims expected by the application. In this way, the application layer can be insulated from the details on the differing claims served up by the different token types that WCF supports. This topic shows how to implement a custom authorization policy and how to add that policy to the collection of policies used by a service.  \n  \n### To implement a custom authorization policy  \n  \n1.  Define a new class that derives from <xref:System.IdentityModel.Policy.IAuthorizationPolicy>.  \n  \n2.  Implement the read-only <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> property by generating a unique string in the constructor for the class and returning that string whenever the property is accessed.  \n  \n3.  Implement the read-only <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> property by returning a <xref:System.IdentityModel.Claims.ClaimSet> that represents the policy issuer. This could be a `ClaimSet` that represents the application or a built-in `ClaimSet` (for example, the `ClaimSet` returned by the static <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property.  \n  \n4.  Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29> method as described in the following procedure.  \n  \n### To implement the Evaluate method  \n  \n1.  Two parameters are passed to this method: an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class and an object reference.  \n  \n2.  If the custom authorization policy adds <xref:System.IdentityModel.Claims.ClaimSet> instances without regard to the current content of the <xref:System.IdentityModel.Policy.EvaluationContext>, then add each `ClaimSet` by calling the <xref:System.IdentityModel.Policy.EvaluationContext.AddClaimSet%28System.IdentityModel.Policy.IAuthorizationPolicy%2CSystem.IdentityModel.Claims.ClaimSet%29> method and return `true` from the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method. Returning `true` indicates to the authorization infrastructure that the authorization policy has performed its work and does not need to be called again.  \n  \n3.  If the custom authorization policy adds claim sets only if certain claims are already present in the `EvaluationContext`, then look for those claims by examining the `ClaimSet` instances returned by the <xref:System.IdentityModel.Policy.EvaluationContext.ClaimSets%2A> property. If the claims are present, then add the new claim sets by calling the <xref:System.IdentityModel.Policy.EvaluationContext.AddClaimSet%28System.IdentityModel.Policy.IAuthorizationPolicy%2CSystem.IdentityModel.Claims.ClaimSet%29> method and, if no more claim sets are to be added, return `true`, indicating to the authorization infrastructure that the authorization policy has completed its work. If the claims are not present, return `false`, indicating that the authorization policy should be called again if other authorization policies add more claim sets to the `EvaluationContext`.  \n  \n4.  In more complex processing scenarios, the second parameter of the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29> method is used to store a state variable that the authorization infrastructure will pass back during each subsequent call to the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29> method for a particular evaluation.  \n  \n### To specify a custom authorization policy through configuration  \n  \n1.  Specify the type of the custom authorization policy in the `policyType` attribute in the `add` element in the `authorizationPolicies` element in the `serviceAuthorization` element.  \n  \n    ```xml  \n    <configuration>  \n     <system.serviceModel>  \n      <behaviors>  \n        <serviceAuthorization serviceAuthorizationManagerType=  \n                  \"Samples.MyServiceAuthorizationManager\" >  \n          <authorizationPolicies>  \n            <add policyType=\"Samples.MyAuthorizationPolicy\" />  \n          </authorizationPolicies>  \n        </serviceAuthorization>  \n      </behaviors>  \n     </system.serviceModel>  \n    </configuration>  \n    ```  \n  \n### To specify a custom authorization policy through code  \n  \n1.  Create a <xref:System.Collections.Generic.List%601> of <xref:System.IdentityModel.Policy.IAuthorizationPolicy>.  \n  \n2.  Create an instance of the custom authorization policy.  \n  \n3.  Add the authorization policy instance to the list.  \n  \n4.  Repeat steps 2 and 3 for each custom authorization policy.  \n  \n5.  Assign a read-only version of the list to the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ExternalAuthorizationPolicies%2A> property.  \n  \n     [!code-csharp[c_CustomAuthPol#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customauthpol/cs/c_customauthpol.cs#8)]\n     [!code-vb[c_CustomAuthPol#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customauthpol/vb/source.vb#8)]  \n  \n## Example  \n The following example shows a complete <xref:System.IdentityModel.Policy.IAuthorizationPolicy> implementation.  \n  \n [!code-csharp[c_CustomAuthPol#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customauthpol/cs/c_customauthpol.cs#5)]\n [!code-vb[c_CustomAuthPol#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customauthpol/vb/source.vb#5)]  \n  \n## See also\n\n- <xref:System.ServiceModel.ServiceAuthorizationManager>\n- [How to: Compare Claims](../../../../docs/framework/wcf/extending/how-to-compare-claims.md)\n- [How to: Create a Custom Authorization Manager for a Service](../../../../docs/framework/wcf/extending/how-to-create-a-custom-authorization-manager-for-a-service.md)\n- [Authorization Policy](../../../../docs/framework/wcf/samples/authorization-policy.md)\n","nodes":[{"pos":[4,162],"embed":true,"restype":"x-metadata","content":"title: \"How to: Create a Custom Authorization Policy\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: 05b0549b-882d-4660-b6f0-5678543e5475","nodes":[{"content":"How to: Create a Custom Authorization Policy","nodes":[{"pos":[0,44],"content":"How to: Create a Custom Authorization Policy","nodes":[{"content":"How to: Create a Custom Authorization Policy","pos":[0,44]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[169,213],"content":"How to: Create a Custom Authorization Policy","linkify":"How to: Create a Custom Authorization Policy","nodes":[{"content":"How to: Create a Custom Authorization Policy","pos":[0,44]}]},{"content":"The Identity Model infrastructure in Windows Communication Foundation (WCF) supports a claim-based authorization model.","pos":[214,333]},{"content":"Claims are extracted from tokens, optionally processed by custom authorization policy, and then placed into an <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.AuthorizationContext&gt;</ph> that can then be examined to make authorization decisions.","pos":[334,559],"source":" Claims are extracted from tokens, optionally processed by custom authorization policy, and then placed into an <xref:System.IdentityModel.Policy.AuthorizationContext> that can then be examined to make authorization decisions."},{"content":"A custom policy can be used to transform claims from incoming tokens into claims expected by the application.","pos":[560,669]},{"content":"In this way, the application layer can be insulated from the details on the differing claims served up by the different token types that WCF supports.","pos":[670,820]},{"content":"This topic shows how to implement a custom authorization policy and how to add that policy to the collection of policies used by a service.","pos":[821,960]},{"pos":[970,1012],"content":"To implement a custom authorization policy","linkify":"To implement a custom authorization policy","nodes":[{"content":"To implement a custom authorization policy","pos":[0,42]}]},{"pos":[1022,1115],"content":"Define a new class that derives from <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy&gt;</ph>.","source":"Define a new class that derives from <xref:System.IdentityModel.Policy.IAuthorizationPolicy>."},{"pos":[1125,1346],"content":"Implement the read-only <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A&gt;</ph> property by generating a unique string in the constructor for the class and returning that string whenever the property is accessed.","source":"Implement the read-only <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> property by generating a unique string in the constructor for the class and returning that string whenever the property is accessed."},{"content":"Implement the read-only <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A&gt;</ph> property by returning a <ph id=\"ph2\">&lt;xref:System.IdentityModel.Claims.ClaimSet&gt;</ph> that represents the policy issuer.","pos":[1356,1548],"source":"Implement the read-only <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> property by returning a <xref:System.IdentityModel.Claims.ClaimSet> that represents the policy issuer."},{"content":"This could be a <ph id=\"ph1\">`ClaimSet`</ph> that represents the application or a built-in <ph id=\"ph2\">`ClaimSet`</ph> (for example, the <ph id=\"ph3\">`ClaimSet`</ph> returned by the static <ph id=\"ph4\">&lt;xref:System.IdentityModel.Claims.ClaimSet.System%2A&gt;</ph> property.","pos":[1549,1748],"source":" This could be a `ClaimSet` that represents the application or a built-in `ClaimSet` (for example, the `ClaimSet` returned by the static <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property."},{"pos":[1758,1954],"content":"Implement the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29&gt;</ph> method as described in the following procedure.","source":"Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29> method as described in the following procedure."},{"pos":[1964,1996],"content":"To implement the Evaluate method","linkify":"To implement the Evaluate method","nodes":[{"content":"To implement the Evaluate method","pos":[0,32]}]},{"pos":[2006,2150],"content":"Two parameters are passed to this method: an instance of the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.EvaluationContext&gt;</ph> class and an object reference.","source":"Two parameters are passed to this method: an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class and an object reference."},{"content":"If the custom authorization policy adds <ph id=\"ph1\">&lt;xref:System.IdentityModel.Claims.ClaimSet&gt;</ph> instances without regard to the current content of the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Policy.EvaluationContext&gt;</ph>, then add each <ph id=\"ph3\">`ClaimSet`</ph> by calling the <ph id=\"ph4\">&lt;xref:System.IdentityModel.Policy.EvaluationContext.AddClaimSet%28System.IdentityModel.Policy.IAuthorizationPolicy%2CSystem.IdentityModel.Claims.ClaimSet%29&gt;</ph> method and return <ph id=\"ph5\">`true`</ph> from the <ph id=\"ph6\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A&gt;</ph> method.","pos":[2160,2660],"source":"If the custom authorization policy adds <xref:System.IdentityModel.Claims.ClaimSet> instances without regard to the current content of the <xref:System.IdentityModel.Policy.EvaluationContext>, then add each `ClaimSet` by calling the <xref:System.IdentityModel.Policy.EvaluationContext.AddClaimSet%28System.IdentityModel.Policy.IAuthorizationPolicy%2CSystem.IdentityModel.Claims.ClaimSet%29> method and return `true` from the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method."},{"content":"Returning <ph id=\"ph1\">`true`</ph> indicates to the authorization infrastructure that the authorization policy has performed its work and does not need to be called again.","pos":[2661,2814],"source":" Returning `true` indicates to the authorization infrastructure that the authorization policy has performed its work and does not need to be called again."},{"content":"If the custom authorization policy adds claim sets only if certain claims are already present in the <ph id=\"ph1\">`EvaluationContext`</ph>, then look for those claims by examining the <ph id=\"ph2\">`ClaimSet`</ph> instances returned by the <ph id=\"ph3\">&lt;xref:System.IdentityModel.Policy.EvaluationContext.ClaimSets%2A&gt;</ph> property.","pos":[2824,3102],"source":"If the custom authorization policy adds claim sets only if certain claims are already present in the `EvaluationContext`, then look for those claims by examining the `ClaimSet` instances returned by the <xref:System.IdentityModel.Policy.EvaluationContext.ClaimSets%2A> property."},{"content":"If the claims are present, then add the new claim sets by calling the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.EvaluationContext.AddClaimSet%28System.IdentityModel.Policy.IAuthorizationPolicy%2CSystem.IdentityModel.Claims.ClaimSet%29&gt;</ph> method and, if no more claim sets are to be added, return <ph id=\"ph2\">`true`</ph>, indicating to the authorization infrastructure that the authorization policy has completed its work.","pos":[3103,3497],"source":" If the claims are present, then add the new claim sets by calling the <xref:System.IdentityModel.Policy.EvaluationContext.AddClaimSet%28System.IdentityModel.Policy.IAuthorizationPolicy%2CSystem.IdentityModel.Claims.ClaimSet%29> method and, if no more claim sets are to be added, return `true`, indicating to the authorization infrastructure that the authorization policy has completed its work."},{"content":"If the claims are not present, return <ph id=\"ph1\">`false`</ph>, indicating that the authorization policy should be called again if other authorization policies add more claim sets to the <ph id=\"ph2\">`EvaluationContext`</ph>.","pos":[3498,3688],"source":" If the claims are not present, return `false`, indicating that the authorization policy should be called again if other authorization policies add more claim sets to the `EvaluationContext`."},{"pos":[3698,4198],"content":"In more complex processing scenarios, the second parameter of the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29&gt;</ph> method is used to store a state variable that the authorization infrastructure will pass back during each subsequent call to the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29&gt;</ph> method for a particular evaluation.","source":"In more complex processing scenarios, the second parameter of the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29> method is used to store a state variable that the authorization infrastructure will pass back during each subsequent call to the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%28System.IdentityModel.Policy.EvaluationContext%2CSystem.Object%40%29> method for a particular evaluation."},{"pos":[4208,4270],"content":"To specify a custom authorization policy through configuration","linkify":"To specify a custom authorization policy through configuration","nodes":[{"content":"To specify a custom authorization policy through configuration","pos":[0,62]}]},{"pos":[4280,4460],"content":"Specify the type of the custom authorization policy in the <ph id=\"ph1\">`policyType`</ph> attribute in the <ph id=\"ph2\">`add`</ph> element in the <ph id=\"ph3\">`authorizationPolicies`</ph> element in the <ph id=\"ph4\">`serviceAuthorization`</ph> element.","source":"Specify the type of the custom authorization policy in the `policyType` attribute in the `add` element in the `authorizationPolicies` element in the `serviceAuthorization` element."},{"pos":[4940,4993],"content":"To specify a custom authorization policy through code","linkify":"To specify a custom authorization policy through code","nodes":[{"content":"To specify a custom authorization policy through code","pos":[0,53]}]},{"pos":[5003,5114],"content":"Create a <ph id=\"ph1\">&lt;xref:System.Collections.Generic.List%601&gt;</ph> of <ph id=\"ph2\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy&gt;</ph>.","source":"Create a <xref:System.Collections.Generic.List%601> of <xref:System.IdentityModel.Policy.IAuthorizationPolicy>."},{"content":"Create an instance of the custom authorization policy.","pos":[5124,5178]},{"content":"Add the authorization policy instance to the list.","pos":[5188,5238]},{"content":"Repeat steps 2 and 3 for each custom authorization policy.","pos":[5248,5306]},{"pos":[5316,5472],"content":"Assign a read-only version of the list to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ExternalAuthorizationPolicies%2A&gt;</ph> property.","source":"Assign a read-only version of the list to the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ExternalAuthorizationPolicies%2A> property."},{"pos":[5483,5733],"content":"[!code-csharp[c_CustomAuthPol#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customauthpol/cs/c_customauthpol.cs#8)]\n [!code-vb[c_CustomAuthPol#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customauthpol/vb/source.vb#8)]","leadings":["","    "],"nodes":[]},{"pos":[5742,5749],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[5753,5863],"content":"The following example shows a complete <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy&gt;</ph> implementation.","source":"The following example shows a complete <xref:System.IdentityModel.Policy.IAuthorizationPolicy> implementation."},{"pos":[6125,6133],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6194,6285],"content":"<bpt id=\"p1\">[</bpt>How to: Compare Claims<ept id=\"p1\">](../../../../docs/framework/wcf/extending/how-to-compare-claims.md)</ept>","source":"[How to: Compare Claims](../../../../docs/framework/wcf/extending/how-to-compare-claims.md)"},{"pos":[6288,6453],"content":"<bpt id=\"p1\">[</bpt>How to: Create a Custom Authorization Manager for a Service<ept id=\"p1\">](../../../../docs/framework/wcf/extending/how-to-create-a-custom-authorization-manager-for-a-service.md)</ept>","source":"[How to: Create a Custom Authorization Manager for a Service](../../../../docs/framework/wcf/extending/how-to-create-a-custom-authorization-manager-for-a-service.md)"},{"pos":[6456,6542],"content":"<bpt id=\"p1\">[</bpt>Authorization Policy<ept id=\"p1\">](../../../../docs/framework/wcf/samples/authorization-policy.md)</ept>","source":"[Authorization Policy](../../../../docs/framework/wcf/samples/authorization-policy.md)"}]}