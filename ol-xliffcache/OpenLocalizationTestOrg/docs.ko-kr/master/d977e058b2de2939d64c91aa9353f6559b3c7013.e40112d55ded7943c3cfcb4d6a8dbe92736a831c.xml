{"content":"---\ntitle: \"Suspended Instance Management\"\nms.date: \"03/30/2017\"\nms.assetid: f5ca3faa-ba1f-4857-b92c-d927e4b29598\n---\n# Suspended Instance Management\nThis sample demonstrates how to manage workflow instances that have been suspended.  The default action for <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> is `AbandonAndSuspend`. This means that by default, unhandled exceptions thrown from a workflow instance hosted in the <xref:System.ServiceModel.WorkflowServiceHost> will cause the instance to be disposed from memory (abandoned) and the durable/persisted version of the instance to be marked as suspended. A suspended workflow instance will not be able to run until it has been unsuspended.\n\n The sample shows how a command-line utility can be implemented to query for suspended instances, and how to give the user the option to resume or terminate the instance. In this sample, a workflow service intentionally throws an exception, causing it to become suspended. The command-line utility can then be used to query for the instance and subsequently resume or terminate the instance.\n\n## Demonstrates\n <xref:System.ServiceModel.WorkflowServiceHost> with <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> and <xref:System.ServiceModel.Activities.WorkflowControlEndpoint> in Windows Workflow Foundation (WF).\n\n## Discussion\n The command-line utility implemented in this sample is specific to the SQL instance store implementation that ships in [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]. If you have a custom implementation of the instance store, then you can adapt this utility by replacing the `WorkflowInstanceCommand` implementations in the sample with implementations that are specific to your instance store.\n\n The provided implementation runs SQL commands against the SQL instance store directly to list suspended instances, and it relies on a <xref:System.ServiceModel.Activities.WorkflowControlEndpoint> added to the <xref:System.ServiceModel.WorkflowServiceHost> in order to resume or terminate the instances.\n\n#### To set up, build, and run the sample\n\n1.  This sample requires that the following Windows components are enabled:\n\n    1.  Microsoft Message Queues (MSMQ) Server\n\n    2.  SQL Server Express\n\n2.  Set up the SQL Server database.\n\n    1.  From a Visual Studio 2010 command prompt, run \"setup.cmd\" from the SuspendedInstanceManagement sample directory, which does the following:\n\n        1.  Creates a persistence database using SQL Server Express. If the persistence database already exists, then it is dropped and re-created\n\n        2.  Sets up the database for persistence.\n\n        3.  Adds IIS APPPOOL\\DefaultAppPool and NT AUTHORITY\\Network Service to the InstanceStoreUsers role that was defined when setting up the database for persistence.\n\n3.  Set up the service queue.\n\n    1.  In Visual Studio 2010, right-click the **SampleWorkflowApp** project and click **Set as Startup Project**.\n\n    2.  Compile and run the SampleWorkflowApp by pressing **F5**. This will create the required queue.\n\n    3.  Press **Enter** to stop the SampleWorkflowApp.\n\n    4.  Open the Computer Management console by running Compmgmt.msc from a command prompt.\n\n    5.  Expand **Service and Applications**, **Message Queuing**, **Private Queues**.\n\n    6.  Right click the **ReceiveTx** queue and select **Properties**.\n\n    7.  Select the **Security** tab and allow **Everyone** to have permissions to **Receive Message**, **Peek Message**, and **Send Message**.\n\n4.  Now, run the sample.\n\n    1.  In Visual Studio 2010, run the SampleWorkflowApp project again without debugging by pressing **Ctrl+F5**. Two endpoint addresses will be printed in the console window: one for the application endpoint and then other from the <xref:System.ServiceModel.Activities.WorkflowControlEndpoint>. A workflow instance is then created, and tracking records for that instance will appear in the console window. The workflow instance will throw an exception causing the instance to be suspended and aborted.\n\n    2.  The command-line utility can then be used to take further action on any of these instances. The syntax for command line arguments is as follows::\n\n         `SuspendedInstanceManagement -Command:[CommandName] -Server:[ServerName] -Database:[DatabaseName] -InstanceId:[InstanceId]`\n\n         The supported commands are: `Query`, `Resume`, and `Terminate`.  The InstanceId switch is only required for `Resume` and `Terminate` operations.\n\n#### To cleanup (Optional)\n\n1.  Open the Computer Management console by running Compmgmt.msc from a `vs2010` command prompt.\n\n2.  Expand **Service and Applications**, **Message Queuing**, **Private Queues**.\n\n3.  Delete the **ReceiveTx** queue.\n\n4.  To remove the persistence database, run cleanup.cmd.\n\n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WF\\Application\\SuspendedInstanceManagement`\n","nodes":[{"pos":[4,113],"embed":true,"restype":"x-metadata","content":"title: \"Suspended Instance Management\"\nms.date: \"03/30/2017\"\nms.assetid: f5ca3faa-ba1f-4857-b92c-d927e4b29598","nodes":[{"content":"Suspended Instance Management","nodes":[{"pos":[0,29],"content":"Suspended Instance Management","nodes":[{"content":"Suspended Instance Management","pos":[0,29]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[120,149],"content":"Suspended Instance Management","linkify":"Suspended Instance Management","nodes":[{"content":"Suspended Instance Management","pos":[0,29]}]},{"content":"This sample demonstrates how to manage workflow instances that have been suspended.","pos":[150,233]},{"content":"The default action for <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior&gt;</ph> is <ph id=\"ph2\">`AbandonAndSuspend`</ph>.","pos":[235,366],"source":"  The default action for <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> is `AbandonAndSuspend`."},{"content":"This means that by default, unhandled exceptions thrown from a workflow instance hosted in the <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> will cause the instance to be disposed from memory (abandoned) and the durable/persisted version of the instance to be marked as suspended.","pos":[367,648],"source":" This means that by default, unhandled exceptions thrown from a workflow instance hosted in the <xref:System.ServiceModel.WorkflowServiceHost> will cause the instance to be disposed from memory (abandoned) and the durable/persisted version of the instance to be marked as suspended."},{"content":"A suspended workflow instance will not be able to run until it has been unsuspended.","pos":[649,733]},{"content":"The sample shows how a command-line utility can be implemented to query for suspended instances, and how to give the user the option to resume or terminate the instance.","pos":[736,905]},{"content":"In this sample, a workflow service intentionally throws an exception, causing it to become suspended.","pos":[906,1007]},{"content":"The command-line utility can then be used to query for the instance and subsequently resume or terminate the instance.","pos":[1008,1126]},{"pos":[1131,1143],"content":"Demonstrates","linkify":"Demonstrates","nodes":[{"content":"Demonstrates","pos":[0,12]}]},{"pos":[1145,1384],"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> with <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.WorkflowControlEndpoint&gt;</ph> in Windows Workflow Foundation (WF).","source":"<xref:System.ServiceModel.WorkflowServiceHost> with <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> and <xref:System.ServiceModel.Activities.WorkflowControlEndpoint> in Windows Workflow Foundation (WF)."},{"pos":[1389,1399],"content":"Discussion","linkify":"Discussion","nodes":[{"content":"Discussion","pos":[0,10]}]},{"content":"The command-line utility implemented in this sample is specific to the SQL instance store implementation that ships in <ph id=\"ph1\">[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</ph>.","pos":[1401,1598],"source":"The command-line utility implemented in this sample is specific to the SQL instance store implementation that ships in [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]."},{"content":"If you have a custom implementation of the instance store, then you can adapt this utility by replacing the <ph id=\"ph1\">`WorkflowInstanceCommand`</ph> implementations in the sample with implementations that are specific to your instance store.","pos":[1599,1825],"source":" If you have a custom implementation of the instance store, then you can adapt this utility by replacing the `WorkflowInstanceCommand` implementations in the sample with implementations that are specific to your instance store."},{"pos":[1828,2130],"content":"The provided implementation runs SQL commands against the SQL instance store directly to list suspended instances, and it relies on a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowControlEndpoint&gt;</ph> added to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> in order to resume or terminate the instances.","source":"The provided implementation runs SQL commands against the SQL instance store directly to list suspended instances, and it relies on a <xref:System.ServiceModel.Activities.WorkflowControlEndpoint> added to the <xref:System.ServiceModel.WorkflowServiceHost> in order to resume or terminate the instances."},{"pos":[2137,2173],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"content":"This sample requires that the following Windows components are enabled:","pos":[2179,2250]},{"content":"Microsoft Message Queues (MSMQ) Server","pos":[2260,2298]},{"content":"SQL Server Express","pos":[2308,2326]},{"content":"Set up the SQL Server database.","pos":[2332,2363]},{"content":"From a Visual Studio 2010 command prompt, run \"setup.cmd\" from the SuspendedInstanceManagement sample directory, which does the following:","pos":[2373,2511]},{"content":"Creates a persistence database using SQL Server Express.","pos":[2525,2581]},{"content":"If the persistence database already exists, then it is dropped and re-created","pos":[2582,2659]},{"content":"Sets up the database for persistence.","pos":[2673,2710]},{"content":"Adds IIS APPPOOL\\DefaultAppPool and NT AUTHORITY\\Network Service to the InstanceStoreUsers role that was defined when setting up the database for persistence.","pos":[2724,2882]},{"content":"Set up the service queue.","pos":[2888,2913]},{"pos":[2923,3029],"content":"In Visual Studio 2010, right-click the <bpt id=\"p1\">**</bpt>SampleWorkflowApp<ept id=\"p1\">**</ept> project and click <bpt id=\"p2\">**</bpt>Set as Startup Project<ept id=\"p2\">**</ept>.","source":"In Visual Studio 2010, right-click the **SampleWorkflowApp** project and click **Set as Startup Project**."},{"content":"Compile and run the SampleWorkflowApp by pressing <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept>.","pos":[3039,3096],"source":"Compile and run the SampleWorkflowApp by pressing **F5**."},{"content":"This will create the required queue.","pos":[3097,3133]},{"pos":[3143,3189],"content":"Press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept> to stop the SampleWorkflowApp.","source":"Press **Enter** to stop the SampleWorkflowApp."},{"content":"Open the Computer Management console by running Compmgmt.msc from a command prompt.","pos":[3199,3282]},{"pos":[3292,3369],"content":"Expand <bpt id=\"p1\">**</bpt>Service and Applications<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Message Queuing<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Private Queues<ept id=\"p3\">**</ept>.","source":"Expand **Service and Applications**, **Message Queuing**, **Private Queues**."},{"pos":[3379,3441],"content":"Right click the <bpt id=\"p1\">**</bpt>ReceiveTx<ept id=\"p1\">**</ept> queue and select <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept>.","source":"Right click the **ReceiveTx** queue and select **Properties**."},{"pos":[3451,3585],"content":"Select the <bpt id=\"p1\">**</bpt>Security<ept id=\"p1\">**</ept> tab and allow <bpt id=\"p2\">**</bpt>Everyone<ept id=\"p2\">**</ept> to have permissions to <bpt id=\"p3\">**</bpt>Receive Message<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>Peek Message<ept id=\"p4\">**</ept>, and <bpt id=\"p5\">**</bpt>Send Message<ept id=\"p5\">**</ept>.","source":"Select the **Security** tab and allow **Everyone** to have permissions to **Receive Message**, **Peek Message**, and **Send Message**."},{"content":"Now, run the sample.","pos":[3591,3611]},{"content":"In Visual Studio 2010, run the SampleWorkflowApp project again without debugging by pressing <bpt id=\"p1\">**</bpt>Ctrl+F5<ept id=\"p1\">**</ept>.","pos":[3621,3726],"source":"In Visual Studio 2010, run the SampleWorkflowApp project again without debugging by pressing **Ctrl+F5**."},{"content":"Two endpoint addresses will be printed in the console window: one for the application endpoint and then other from the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowControlEndpoint&gt;</ph>.","pos":[3727,3908],"source":" Two endpoint addresses will be printed in the console window: one for the application endpoint and then other from the <xref:System.ServiceModel.Activities.WorkflowControlEndpoint>."},{"content":"A workflow instance is then created, and tracking records for that instance will appear in the console window.","pos":[3909,4019]},{"content":"The workflow instance will throw an exception causing the instance to be suspended and aborted.","pos":[4020,4115]},{"content":"The command-line utility can then be used to take further action on any of these instances.","pos":[4125,4216]},{"content":"The syntax for command line arguments is as follows::","pos":[4217,4270]},{"content":"The supported commands are: <ph id=\"ph1\">`Query`</ph>, <ph id=\"ph2\">`Resume`</ph>, and <ph id=\"ph3\">`Terminate`</ph>.","pos":[4415,4478],"source":"The supported commands are: `Query`, `Resume`, and `Terminate`."},{"content":"The InstanceId switch is only required for <ph id=\"ph1\">`Resume`</ph> and <ph id=\"ph2\">`Terminate`</ph> operations.","pos":[4480,4559],"source":"  The InstanceId switch is only required for `Resume` and `Terminate` operations."},{"pos":[4566,4587],"content":"To cleanup (Optional)","linkify":"To cleanup (Optional)","nodes":[{"content":"To cleanup (Optional)","pos":[0,21]}]},{"pos":[4593,4685],"content":"Open the Computer Management console by running Compmgmt.msc from a <ph id=\"ph1\">`vs2010`</ph> command prompt.","source":"Open the Computer Management console by running Compmgmt.msc from a `vs2010` command prompt."},{"pos":[4691,4768],"content":"Expand <bpt id=\"p1\">**</bpt>Service and Applications<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Message Queuing<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Private Queues<ept id=\"p3\">**</ept>.","source":"Expand **Service and Applications**, **Message Queuing**, **Private Queues**."},{"pos":[4774,4805],"content":"Delete the <bpt id=\"p1\">**</bpt>ReceiveTx<ept id=\"p1\">**</ept> queue.","source":"Delete the **ReceiveTx** queue."},{"content":"To remove the persistence database, run cleanup.cmd.","pos":[4811,4863]},{"pos":[4867,4999],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[5053,5363],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[5364,5414]}]}