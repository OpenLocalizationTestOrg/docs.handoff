{"content":"---\ntitle: Process asynchronous tasks as they complete\nms.date: 09/12/2018\nms.assetid: 25331850-35a7-43b3-ab76-3908e4346b9d\n---\n# Start Multiple Async Tasks and Process Them As They Complete (C#)\n\nBy using <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType>, you can start multiple tasks at the same time and process them one by one as they’re completed rather than process them in the order in which they're started.\n\nThe following example uses a query to create a collection of tasks. Each task downloads the contents of a specified website. In each iteration of a while loop, an awaited call to `WhenAny` returns the task in the collection of tasks that finishes its download first. That task is removed from the collection and processed. The loop repeats until the collection contains no more tasks.\n\n> [!NOTE]\n> To run the examples, you must have Visual Studio (2012 or newer) and the .NET Framework 4.5 or newer installed on your computer.\n\n## Download an example solution\n\nYou can download the complete Windows Presentation Foundation (WPF) project from [Async Sample: Fine Tuning Your Application](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea) and then follow these steps.\n\n> [!TIP]\n> If you don't want to download the project, you can review the MainWindow.xaml.cs file at the end of this topic instead.\n\n1.  Extract the files that you downloaded from the .zip file, and then start Visual Studio.\n\n2.  On the menu bar, choose **File** > **Open** > **Project/Solution**.\n\n3.  In the **Open Project** dialog box, open the folder that holds the sample code you downloaded, and then open the solution (.sln) file for AsyncFineTuningCS.\n\n4.  In **Solution Explorer**, open the shortcut menu for the **ProcessTasksAsTheyFinish** project, and then choose **Set as StartUp Project**.\n\n5.  Choose the **F5** key to run the program (or, press **Ctrl**+**F5** keys to run the program without debugging it).\n\n6.  Run the project several times to verify that the downloaded lengths don't always appear in the same order.\n\n## Create the program yourself\n\nThis example adds to the code that’s developed in [Cancel Remaining Async Tasks after One Is Complete (C#)](../../../../csharp/programming-guide/concepts/async/cancel-remaining-async-tasks-after-one-is-complete.md), and it uses the same UI.\n\nTo build the example yourself, step by step, follow the instructions in the [Downloading the Example](../../../../csharp/programming-guide/concepts/async/cancel-remaining-async-tasks-after-one-is-complete.md#downloading-the-example) section, but set **CancelAfterOneTask** as the startup project. Add the changes in this topic to the `AccessTheWebAsync` method in that project. The changes are marked with asterisks.\n\nThe **CancelAfterOneTask** project already includes a query that, when executed, creates a collection of tasks. Each call to `ProcessURLAsync` in the following code returns a <xref:System.Threading.Tasks.Task%601>, where `TResult` is an integer:\n\n```csharp\nIEnumerable<Task<int>> downloadTasksQuery = from url in urlList select ProcessURL(url, client, ct);\n```\n\nIn the MainWindow.xaml.cs file of the project, make the following changes to the `AccessTheWebAsync` method.\n\n-   Execute the query by applying <xref:System.Linq.Enumerable.ToList%2A?displayProperty=nameWithType> instead of <xref:System.Linq.Enumerable.ToArray%2A>.\n\n    ```csharp\n    List<Task<int>> downloadTasks = downloadTasksQuery.ToList();\n    ```\n\n-   Add a `while` loop that performs the following steps for each task in the collection:\n\n    1.  Awaits a call to `WhenAny` to identify the first task in the collection to finish its download.\n\n        ```csharp\n        Task<int> firstFinishedTask = await Task.WhenAny(downloadTasks);\n        ```\n\n    2.  Removes that task from the collection.\n\n        ```csharp\n        downloadTasks.Remove(firstFinishedTask);\n        ```\n\n    3.  Awaits `firstFinishedTask`, which is returned by a call to `ProcessURLAsync`. The `firstFinishedTask` variable is a <xref:System.Threading.Tasks.Task%601> where `TReturn` is an integer. The task is already complete, but you await it to retrieve the length of the downloaded website, as the following example shows.\n\n        ```csharp\n        int length = await firstFinishedTask;\n        resultsTextBox.Text += $\"\\r\\nLength of the download:  {length}\";\n        ```\n\nRun the program several times to verify that the downloaded lengths don't always appear in the same order.\n\n> [!CAUTION]\n> You can use `WhenAny` in a loop, as described in the example, to solve problems that involve a small number of tasks. However, other approaches are more efficient if you have a large number of tasks to process. For more information and examples, see [Processing tasks as they complete](https://blogs.msdn.microsoft.com/pfxteam/2012/08/02/processing-tasks-as-they-complete/).\n\n## Complete example\n\nThe following code is the complete text of the MainWindow.xaml.cs file for the example. Asterisks mark the elements that were added for this example. Also, take note that you must add a reference for <xref:System.Net.Http>.\n\nYou can download the project from [Async Sample: Fine Tuning Your Application](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea).\n\n```csharp\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text;\nusing System.Threading.Tasks;\nusing System.Windows;\nusing System.Windows.Controls;\nusing System.Windows.Data;\nusing System.Windows.Documents;\nusing System.Windows.Input;\nusing System.Windows.Media;\nusing System.Windows.Media.Imaging;\nusing System.Windows.Navigation;\nusing System.Windows.Shapes;\n\n// Add a using directive and a reference for System.Net.Http.\nusing System.Net.Http;\n\n// Add the following using directive.\nusing System.Threading;\n\nnamespace ProcessTasksAsTheyFinish\n{\n    public partial class MainWindow : Window\n    {\n        // Declare a System.Threading.CancellationTokenSource.\n        CancellationTokenSource cts;\n\n        public MainWindow()\n        {\n            InitializeComponent();\n        }\n\n        private async void startButton_Click(object sender, RoutedEventArgs e)\n        {\n            resultsTextBox.Clear();\n\n            // Instantiate the CancellationTokenSource.\n            cts = new CancellationTokenSource();\n\n            try\n            {\n                await AccessTheWebAsync(cts.Token);\n                resultsTextBox.Text += \"\\r\\nDownloads complete.\";\n            }\n            catch (OperationCanceledException)\n            {\n                resultsTextBox.Text += \"\\r\\nDownloads canceled.\\r\\n\";\n            }\n            catch (Exception)\n            {\n                resultsTextBox.Text += \"\\r\\nDownloads failed.\\r\\n\";\n            }\n\n            cts = null;\n        }\n\n        private void cancelButton_Click(object sender, RoutedEventArgs e)\n        {\n            if (cts != null)\n            {\n                cts.Cancel();\n            }\n        }\n\n        async Task AccessTheWebAsync(CancellationToken ct)\n        {\n            HttpClient client = new HttpClient();\n\n            // Make a list of web addresses.\n            List<string> urlList = SetUpURLList();\n\n            // ***Create a query that, when executed, returns a collection of tasks.\n            IEnumerable<Task<int>> downloadTasksQuery =\n                from url in urlList select ProcessURL(url, client, ct);\n\n            // ***Use ToList to execute the query and start the tasks.\n            List<Task<int>> downloadTasks = downloadTasksQuery.ToList();\n\n            // ***Add a loop to process the tasks one at a time until none remain.\n            while (downloadTasks.Count > 0)\n            {\n                    // Identify the first task that completes.\n                    Task<int> firstFinishedTask = await Task.WhenAny(downloadTasks);\n\n                    // ***Remove the selected task from the list so that you don't\n                    // process it more than once.\n                    downloadTasks.Remove(firstFinishedTask);\n\n                    // Await the completed task.\n                    int length = await firstFinishedTask;\n                    resultsTextBox.Text += $\"\\r\\nLength of the download:  {length}\";\n            }\n        }\n\n        private List<string> SetUpURLList()\n        {\n            List<string> urls = new List<string>\n            {\n                \"https://msdn.microsoft.com\",\n                \"https://msdn.microsoft.com/library/windows/apps/br211380.aspx\",\n                \"https://msdn.microsoft.com/library/hh290136.aspx\",\n                \"https://msdn.microsoft.com/library/dd470362.aspx\",\n                \"https://msdn.microsoft.com/library/aa578028.aspx\",\n                \"https://msdn.microsoft.com/library/ms404677.aspx\",\n                \"https://msdn.microsoft.com/library/ff730837.aspx\"\n            };\n            return urls;\n        }\n\n        async Task<int> ProcessURL(string url, HttpClient client, CancellationToken ct)\n        {\n            // GetAsync returns a Task<HttpResponseMessage>.\n            HttpResponseMessage response = await client.GetAsync(url, ct);\n\n            // Retrieve the website contents from the HttpResponseMessage.\n            byte[] urlContents = await response.Content.ReadAsByteArrayAsync();\n\n            return urlContents.Length;\n        }\n    }\n}\n\n// Sample Output:\n\n// Length of the download:  226093\n// Length of the download:  412588\n// Length of the download:  175490\n// Length of the download:  204890\n// Length of the download:  158855\n// Length of the download:  145790\n// Length of the download:  44908\n// Downloads complete.\n```\n\n## See also\n\n- <xref:System.Threading.Tasks.Task.WhenAny%2A>\n- [Fine-Tuning Your Async Application (C#)](../../../../csharp/programming-guide/concepts/async/fine-tuning-your-async-application.md)\n- [Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)\n- [Async Sample: Fine Tuning Your Application](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea)","nodes":[{"pos":[4,123],"embed":true,"restype":"x-metadata","content":"title: Process asynchronous tasks as they complete\nms.date: 09/12/2018\nms.assetid: 25331850-35a7-43b3-ab76-3908e4346b9d","nodes":[{"content":"Process asynchronous tasks as they complete","nodes":[{"pos":[0,43],"content":"Process asynchronous tasks as they complete","nodes":[{"content":"Process asynchronous tasks as they complete","pos":[0,43]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[130,195],"content":"Start Multiple Async Tasks and Process Them As They Complete (C#)","linkify":"Start Multiple Async Tasks and Process Them As They Complete (C#)","nodes":[{"content":"Start Multiple Async Tasks and Process Them As They Complete (C#)","pos":[0,65]}]},{"pos":[197,440],"content":"By using <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType&gt;</ph>, you can start multiple tasks at the same time and process them one by one as they’re completed rather than process them in the order in which they're started.","source":"By using <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType>, you can start multiple tasks at the same time and process them one by one as they’re completed rather than process them in the order in which they're started."},{"content":"The following example uses a query to create a collection of tasks.","pos":[442,509]},{"content":"Each task downloads the contents of a specified website.","pos":[510,566]},{"content":"In each iteration of a while loop, an awaited call to <ph id=\"ph1\">`WhenAny`</ph> returns the task in the collection of tasks that finishes its download first.","pos":[567,708],"source":" In each iteration of a while loop, an awaited call to `WhenAny` returns the task in the collection of tasks that finishes its download first."},{"content":"That task is removed from the collection and processed.","pos":[709,764]},{"content":"The loop repeats until the collection contains no more tasks.","pos":[765,826]},{"pos":[830,968],"content":"[!NOTE]\nTo run the examples, you must have Visual Studio (2012 or newer) and the .NET Framework 4.5 or newer installed on your computer.","leadings":["","> "],"nodes":[{"content":"To run the examples, you must have Visual Studio (2012 or newer) and the .NET Framework 4.5 or newer installed on your computer.","pos":[8,136]}]},{"pos":[973,1001],"content":"Download an example solution","linkify":"Download an example solution","nodes":[{"content":"Download an example solution","pos":[0,28]}]},{"pos":[1003,1222],"content":"You can download the complete Windows Presentation Foundation (WPF) project from <bpt id=\"p1\">[</bpt>Async Sample: Fine Tuning Your Application<ept id=\"p1\">](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea)</ept> and then follow these steps.","source":"You can download the complete Windows Presentation Foundation (WPF) project from [Async Sample: Fine Tuning Your Application](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea) and then follow these steps."},{"pos":[1226,1354],"content":"[!TIP]\nIf you don't want to download the project, you can review the MainWindow.xaml.cs file at the end of this topic instead.","leadings":["","> "],"nodes":[{"content":"If you don't want to download the project, you can review the MainWindow.xaml.cs file at the end of this topic instead.","pos":[7,126]}]},{"content":"Extract the files that you downloaded from the .zip file, and then start Visual Studio.","pos":[1360,1447]},{"pos":[1453,1520],"content":"On the menu bar, choose <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Project/Solution<ept id=\"p3\">**</ept>.","source":"On the menu bar, choose **File** > **Open** > **Project/Solution**."},{"pos":[1526,1682],"content":"In the <bpt id=\"p1\">**</bpt>Open Project<ept id=\"p1\">**</ept> dialog box, open the folder that holds the sample code you downloaded, and then open the solution (.sln) file for AsyncFineTuningCS.","source":"In the **Open Project** dialog box, open the folder that holds the sample code you downloaded, and then open the solution (.sln) file for AsyncFineTuningCS."},{"pos":[1688,1826],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, open the shortcut menu for the <bpt id=\"p2\">**</bpt>ProcessTasksAsTheyFinish<ept id=\"p2\">**</ept> project, and then choose <bpt id=\"p3\">**</bpt>Set as StartUp Project<ept id=\"p3\">**</ept>.","source":"In **Solution Explorer**, open the shortcut menu for the **ProcessTasksAsTheyFinish** project, and then choose **Set as StartUp Project**."},{"pos":[1832,1946],"content":"Choose the <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept> key to run the program (or, press <bpt id=\"p2\">**</bpt>Ctrl<ept id=\"p2\">**</ept><ph id=\"ph1\">+</ph><bpt id=\"p3\">**</bpt>F5<ept id=\"p3\">**</ept> keys to run the program without debugging it).","source":"Choose the **F5** key to run the program (or, press **Ctrl**+**F5** keys to run the program without debugging it)."},{"content":"Run the project several times to verify that the downloaded lengths don't always appear in the same order.","pos":[1952,2058]},{"pos":[2063,2090],"content":"Create the program yourself","linkify":"Create the program yourself","nodes":[{"content":"Create the program yourself","pos":[0,27]}]},{"pos":[2092,2332],"content":"This example adds to the code that’s developed in <bpt id=\"p1\">[</bpt>Cancel Remaining Async Tasks after One Is Complete (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/cancel-remaining-async-tasks-after-one-is-complete.md)</ept>, and it uses the same UI.","source":"This example adds to the code that’s developed in [Cancel Remaining Async Tasks after One Is Complete (C#)](../../../../csharp/programming-guide/concepts/async/cancel-remaining-async-tasks-after-one-is-complete.md), and it uses the same UI."},{"content":"To build the example yourself, step by step, follow the instructions in the <bpt id=\"p1\">[</bpt>Downloading the Example<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/cancel-remaining-async-tasks-after-one-is-complete.md#downloading-the-example)</ept> section, but set <bpt id=\"p2\">**</bpt>CancelAfterOneTask<ept id=\"p2\">**</ept> as the startup project.","pos":[2334,2630],"source":"To build the example yourself, step by step, follow the instructions in the [Downloading the Example](../../../../csharp/programming-guide/concepts/async/cancel-remaining-async-tasks-after-one-is-complete.md#downloading-the-example) section, but set **CancelAfterOneTask** as the startup project."},{"content":"Add the changes in this topic to the <ph id=\"ph1\">`AccessTheWebAsync`</ph> method in that project.","pos":[2631,2711],"source":" Add the changes in this topic to the `AccessTheWebAsync` method in that project."},{"content":"The changes are marked with asterisks.","pos":[2712,2750]},{"content":"The <bpt id=\"p1\">**</bpt>CancelAfterOneTask<ept id=\"p1\">**</ept> project already includes a query that, when executed, creates a collection of tasks.","pos":[2752,2863],"source":"The **CancelAfterOneTask** project already includes a query that, when executed, creates a collection of tasks."},{"content":"Each call to <ph id=\"ph1\">`ProcessURLAsync`</ph> in the following code returns a <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Task%601&gt;</ph>, where <ph id=\"ph3\">`TResult`</ph> is an integer:","pos":[2864,2997],"source":" Each call to `ProcessURLAsync` in the following code returns a <xref:System.Threading.Tasks.Task%601>, where `TResult` is an integer:"},{"pos":[3114,3222],"content":"In the MainWindow.xaml.cs file of the project, make the following changes to the <ph id=\"ph1\">`AccessTheWebAsync`</ph> method.","source":"In the MainWindow.xaml.cs file of the project, make the following changes to the `AccessTheWebAsync` method."},{"pos":[3228,3379],"content":"Execute the query by applying <ph id=\"ph1\">&lt;xref:System.Linq.Enumerable.ToList%2A?displayProperty=nameWithType&gt;</ph> instead of <ph id=\"ph2\">&lt;xref:System.Linq.Enumerable.ToArray%2A&gt;</ph>.","source":"Execute the query by applying <xref:System.Linq.Enumerable.ToList%2A?displayProperty=nameWithType> instead of <xref:System.Linq.Enumerable.ToArray%2A>."},{"pos":[3473,3558],"content":"Add a <ph id=\"ph1\">`while`</ph> loop that performs the following steps for each task in the collection:","source":"Add a `while` loop that performs the following steps for each task in the collection:"},{"pos":[3568,3663],"content":"Awaits a call to <ph id=\"ph1\">`WhenAny`</ph> to identify the first task in the collection to finish its download.","source":"Awaits a call to `WhenAny` to identify the first task in the collection to finish its download."},{"content":"Removes that task from the collection.","pos":[3777,3815]},{"content":"Awaits <ph id=\"ph1\">`firstFinishedTask`</ph>, which is returned by a call to <ph id=\"ph2\">`ProcessURLAsync`</ph>.","pos":[3905,3982],"source":"Awaits `firstFinishedTask`, which is returned by a call to `ProcessURLAsync`."},{"content":"The <ph id=\"ph1\">`firstFinishedTask`</ph> variable is a <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Task%601&gt;</ph> where <ph id=\"ph3\">`TReturn`</ph> is an integer.","pos":[3983,4090],"source":" The `firstFinishedTask` variable is a <xref:System.Threading.Tasks.Task%601> where `TReturn` is an integer."},{"content":"The task is already complete, but you await it to retrieve the length of the downloaded website, as the following example shows.","pos":[4091,4219]},{"content":"Run the program several times to verify that the downloaded lengths don't always appear in the same order.","pos":[4371,4477]},{"pos":[4481,4868],"content":"[!CAUTION]\nYou can use `WhenAny` in a loop, as described in the example, to solve problems that involve a small number of tasks. However, other approaches are more efficient if you have a large number of tasks to process. For more information and examples, see [Processing tasks as they complete](https://blogs.msdn.microsoft.com/pfxteam/2012/08/02/processing-tasks-as-they-complete/).","leadings":["","> "],"nodes":[{"content":"You can use `WhenAny` in a loop, as described in the example, to solve problems that involve a small number of tasks. However, other approaches are more efficient if you have a large number of tasks to process. For more information and examples, see [Processing tasks as they complete](https://blogs.msdn.microsoft.com/pfxteam/2012/08/02/processing-tasks-as-they-complete/).","pos":[11,385],"nodes":[{"content":"You can use <ph id=\"ph1\">`WhenAny`</ph> in a loop, as described in the example, to solve problems that involve a small number of tasks.","pos":[0,117],"source":"You can use `WhenAny` in a loop, as described in the example, to solve problems that involve a small number of tasks."},{"content":"However, other approaches are more efficient if you have a large number of tasks to process.","pos":[118,210]},{"content":"For more information and examples, see <bpt id=\"p1\">[</bpt>Processing tasks as they complete<ept id=\"p1\">](https://blogs.msdn.microsoft.com/pfxteam/2012/08/02/processing-tasks-as-they-complete/)</ept>.","pos":[211,374],"source":" For more information and examples, see [Processing tasks as they complete](https://blogs.msdn.microsoft.com/pfxteam/2012/08/02/processing-tasks-as-they-complete/)."}]}]},{"pos":[4873,4889],"content":"Complete example","linkify":"Complete example","nodes":[{"content":"Complete example","pos":[0,16]}]},{"content":"The following code is the complete text of the MainWindow.xaml.cs file for the example.","pos":[4891,4978]},{"content":"Asterisks mark the elements that were added for this example.","pos":[4979,5040]},{"content":"Also, take note that you must add a reference for <ph id=\"ph1\">&lt;xref:System.Net.Http&gt;</ph>.","pos":[5041,5114],"source":" Also, take note that you must add a reference for <xref:System.Net.Http>."},{"pos":[5116,5260],"content":"You can download the project from <bpt id=\"p1\">[</bpt>Async Sample: Fine Tuning Your Application<ept id=\"p1\">](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea)</ept>.","source":"You can download the project from [Async Sample: Fine Tuning Your Application](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea)."},{"pos":[9615,9623],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[9675,9807],"content":"<bpt id=\"p1\">[</bpt>Fine-Tuning Your Async Application (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/fine-tuning-your-async-application.md)</ept>","source":"[Fine-Tuning Your Async Application (C#)](../../../../csharp/programming-guide/concepts/async/fine-tuning-your-async-application.md)"},{"pos":[9810,9924],"content":"<bpt id=\"p1\">[</bpt>Asynchronous Programming with async and await (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/index.md)</ept>","source":"[Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)"},{"pos":[9927,10036],"content":"<bpt id=\"p1\">[</bpt>Async Sample: Fine Tuning Your Application<ept id=\"p1\">](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea)</ept>","source":"[Async Sample: Fine Tuning Your Application](https://code.msdn.microsoft.com/Async-Fine-Tuning-Your-a676abea)"}]}