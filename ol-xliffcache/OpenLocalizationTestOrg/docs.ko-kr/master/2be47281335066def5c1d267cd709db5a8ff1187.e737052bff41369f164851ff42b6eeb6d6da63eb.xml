{"content":"---\ntitle: \"Creating custom flow control activities\"\nms.date: \"03/30/2017\"\nms.assetid: 27f409f6-2d1d-4cfb-9765-93eb2ad667d5\n---\n# Creating custom flow control activities\nThe .NET Framework contains a variety of flow-control activities that function similarly to abstract programming structures (such as <xref:System.Activities.Statements.Flowchart>)   or to standard programming statements (such as <xref:System.Activities.Statements.If>). This topic discusses the architecture of one of the sample projects, [Non-Generic ForEach](./samples/non-generic-foreach.md).  \n  \n## Creating the custom class  \n Since the Non-Generic ForEach class will need to schedule child activities, it will need to derive from <xref:System.Activities.NativeActivity>, since activities that derive from <xref:System.Workflow.Activities.CodeActivity> do not have this functionality.  \n  \n```  \npublic sealed class ForEach : NativeActivity  \n    {  \n```  \n  \n The custom class requires several members to store data being used by the activity, and to provide functionality to execute the activity’s child activities. These members include:  \n  \n-   `valueEnumerator`: The non-public <xref:System.Activities.Variable%601> of type <xref:System.Collections.IEnumerator> used to iterate over the collection of items. This member is of type <xref:System.Activities.Variable%601> because it is used internally in the activity, rather than an argument or public property, which would be used if this object were to have an origin outside the activity.  \n  \n-   `OnChildComplete`: The public <xref:System.Activities.CompletionCallback> property that executes when each child completes execution. This member is defined as a CLR property, since its value will not change for different instances of the activity.  \n  \n-   `Values`: The collection of inputs used for the iterations of the child activity. This member is of type <xref:System.Activities.InArgument%601>, since the origin of the data is outside the activity, but the contents of the collection is not expected to change during the execution of the activity. If the activity needed the functionality to change the contents of this collection while the activity was executing (to add or remove activities, for instance), this member would have been defined as an <xref:System.Activities.ActivityAction>, which then would have been evaluated every time it was accessed, so that changes would be available to the activity.  \n  \n-   `Body`: This member defines the activity to be executed for each item in the `Values` collection. This member is defined as an <xref:System.Activities.ActivityAction> so that it is evaluated every time it is accessed.  \n  \n-   `Execute`: This method uses the `InternalExecute`, `OnForEachComplete`, and `GetStateAndExecute` non-public members to schedule the execution and assign the completion handler of the child activity defined in the Body member.  \n  \n-   `CacheMetadata`: This member provides the runtime with the information it needs to execute the activity. By default, an activity’s `CacheMetadata` method will inform the runtime of all public members of the activity, but since this activity uses private members for some functionality, it needs to inform the runtime of their existence so that the runtime can be aware of them. In this case, the `CacheMetadata` function is overridden so that the private `valueEnumerator` member can be accessed. This member also creates an argument for the values for the activity so that they can be passed in to the activity during execution.\n","nodes":[{"pos":[4,123],"embed":true,"restype":"x-metadata","content":"title: \"Creating custom flow control activities\"\nms.date: \"03/30/2017\"\nms.assetid: 27f409f6-2d1d-4cfb-9765-93eb2ad667d5","nodes":[{"content":"Creating custom flow control activities","nodes":[{"pos":[0,39],"content":"Creating custom flow control activities","nodes":[{"content":"Creating custom flow control activities","pos":[0,39]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[130,169],"content":"Creating custom flow control activities","linkify":"Creating custom flow control activities","nodes":[{"content":"Creating custom flow control activities","pos":[0,39]}]},{"content":"The .NET Framework contains a variety of flow-control activities that function similarly to abstract programming structures (such as <ph id=\"ph1\">&lt;xref:System.Activities.Statements.Flowchart&gt;</ph>)   or to standard programming statements (such as <ph id=\"ph2\">&lt;xref:System.Activities.Statements.If&gt;</ph>).","pos":[170,439],"source":"The .NET Framework contains a variety of flow-control activities that function similarly to abstract programming structures (such as <xref:System.Activities.Statements.Flowchart>)   or to standard programming statements (such as <xref:System.Activities.Statements.If>)."},{"content":"This topic discusses the architecture of one of the sample projects, <bpt id=\"p1\">[</bpt>Non-Generic ForEach<ept id=\"p1\">](./samples/non-generic-foreach.md)</ept>.","pos":[440,565],"source":" This topic discusses the architecture of one of the sample projects, [Non-Generic ForEach](./samples/non-generic-foreach.md)."},{"pos":[574,599],"content":"Creating the custom class","linkify":"Creating the custom class","nodes":[{"content":"Creating the custom class","pos":[0,25]}]},{"pos":[603,860],"content":"Since the Non-Generic ForEach class will need to schedule child activities, it will need to derive from <ph id=\"ph1\">&lt;xref:System.Activities.NativeActivity&gt;</ph>, since activities that derive from <ph id=\"ph2\">&lt;xref:System.Workflow.Activities.CodeActivity&gt;</ph> do not have this functionality.","source":"Since the Non-Generic ForEach class will need to schedule child activities, it will need to derive from <xref:System.Activities.NativeActivity>, since activities that derive from <xref:System.Workflow.Activities.CodeActivity> do not have this functionality."},{"content":"The custom class requires several members to store data being used by the activity, and to provide functionality to execute the activity’s child activities.","pos":[937,1093]},{"content":"These members include:","pos":[1094,1116]},{"content":"<ph id=\"ph1\">`valueEnumerator`</ph>: The non-public <ph id=\"ph2\">&lt;xref:System.Activities.Variable%601&gt;</ph> of type <ph id=\"ph3\">&lt;xref:System.Collections.IEnumerator&gt;</ph> used to iterate over the collection of items.","pos":[1126,1289],"source":"`valueEnumerator`: The non-public <xref:System.Activities.Variable%601> of type <xref:System.Collections.IEnumerator> used to iterate over the collection of items."},{"content":"This member is of type <ph id=\"ph1\">&lt;xref:System.Activities.Variable%601&gt;</ph> because it is used internally in the activity, rather than an argument or public property, which would be used if this object were to have an origin outside the activity.","pos":[1290,1521],"source":" This member is of type <xref:System.Activities.Variable%601> because it is used internally in the activity, rather than an argument or public property, which would be used if this object were to have an origin outside the activity."},{"content":"<ph id=\"ph1\">`OnChildComplete`</ph>: The public <ph id=\"ph2\">&lt;xref:System.Activities.CompletionCallback&gt;</ph> property that executes when each child completes execution.","pos":[1531,1664],"source":"`OnChildComplete`: The public <xref:System.Activities.CompletionCallback> property that executes when each child completes execution."},{"content":"This member is defined as a CLR property, since its value will not change for different instances of the activity.","pos":[1665,1779]},{"content":"<ph id=\"ph1\">`Values`</ph>: The collection of inputs used for the iterations of the child activity.","pos":[1789,1870],"source":"`Values`: The collection of inputs used for the iterations of the child activity."},{"content":"This member is of type <ph id=\"ph1\">&lt;xref:System.Activities.InArgument%601&gt;</ph>, since the origin of the data is outside the activity, but the contents of the collection is not expected to change during the execution of the activity.","pos":[1871,2087],"source":" This member is of type <xref:System.Activities.InArgument%601>, since the origin of the data is outside the activity, but the contents of the collection is not expected to change during the execution of the activity."},{"content":"If the activity needed the functionality to change the contents of this collection while the activity was executing (to add or remove activities, for instance), this member would have been defined as an <ph id=\"ph1\">&lt;xref:System.Activities.ActivityAction&gt;</ph>, which then would have been evaluated every time it was accessed, so that changes would be available to the activity.","pos":[2088,2448],"source":" If the activity needed the functionality to change the contents of this collection while the activity was executing (to add or remove activities, for instance), this member would have been defined as an <xref:System.Activities.ActivityAction>, which then would have been evaluated every time it was accessed, so that changes would be available to the activity."},{"content":"<ph id=\"ph1\">`Body`</ph>: This member defines the activity to be executed for each item in the <ph id=\"ph2\">`Values`</ph> collection.","pos":[2458,2555],"source":"`Body`: This member defines the activity to be executed for each item in the `Values` collection."},{"content":"This member is defined as an <ph id=\"ph1\">&lt;xref:System.Activities.ActivityAction&gt;</ph> so that it is evaluated every time it is accessed.","pos":[2556,2675],"source":" This member is defined as an <xref:System.Activities.ActivityAction> so that it is evaluated every time it is accessed."},{"pos":[2685,2910],"content":"<ph id=\"ph1\">`Execute`</ph>: This method uses the <ph id=\"ph2\">`InternalExecute`</ph>, <ph id=\"ph3\">`OnForEachComplete`</ph>, and <ph id=\"ph4\">`GetStateAndExecute`</ph> non-public members to schedule the execution and assign the completion handler of the child activity defined in the Body member.","source":"`Execute`: This method uses the `InternalExecute`, `OnForEachComplete`, and `GetStateAndExecute` non-public members to schedule the execution and assign the completion handler of the child activity defined in the Body member."},{"content":"<ph id=\"ph1\">`CacheMetadata`</ph>: This member provides the runtime with the information it needs to execute the activity.","pos":[2920,3024],"source":"`CacheMetadata`: This member provides the runtime with the information it needs to execute the activity."},{"content":"By default, an activity’s <ph id=\"ph1\">`CacheMetadata`</ph> method will inform the runtime of all public members of the activity, but since this activity uses private members for some functionality, it needs to inform the runtime of their existence so that the runtime can be aware of them.","pos":[3025,3297],"source":" By default, an activity’s `CacheMetadata` method will inform the runtime of all public members of the activity, but since this activity uses private members for some functionality, it needs to inform the runtime of their existence so that the runtime can be aware of them."},{"content":"In this case, the <ph id=\"ph1\">`CacheMetadata`</ph> function is overridden so that the private <ph id=\"ph2\">`valueEnumerator`</ph> member can be accessed.","pos":[3298,3416],"source":" In this case, the `CacheMetadata` function is overridden so that the private `valueEnumerator` member can be accessed."},{"content":"This member also creates an argument for the values for the activity so that they can be passed in to the activity during execution.","pos":[3417,3549]}]}