{"content":"---\ntitle: \"Performance Considerations for Direct3D9 and WPF Interoperability\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"WPF [WPF], Direct3D9 interop performance\"\n  - \"Direct3D9 [WPF interoperability], performance\"\nms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd\n---\n# Performance Considerations for Direct3D9 and WPF Interoperability\nYou can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class. Hosting Direct3D9 content can affect the performance of your application. This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application. These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.  \n  \n> [!NOTE]\n>  For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).  \n  \n## Use D3DImage Sparingly  \n Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application. Copying the surface and flushing the command buffer can be costly operations. As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades. Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly.  \n  \n## Best Practices on Windows Vista  \n For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device. This enables surface sharing. The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista. Any other settings cause the surface to be copied through software, which reduces performance significantly.  \n  \n> [!NOTE]\n>  If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings. With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.  \n  \n## Best Practices on Windows XP  \n For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called. Internally, the `BitBlt` method transfers the surface across devices in hardware. The `GetDC` method always works on XRGB surfaces. However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces. The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability.  \n  \n A 16-bit desktop display depth can significantly reduce performance. A 32-bit desktop is recommended.  \n  \n If you are developing for Windows Vista and Windows XP, test the performance on Windows XP. Running out of video memory on Windows XP is a concern. In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy. Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.  \n  \n> [!NOTE]\n>  XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.  \n  \n## General Best Practices  \n When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag. This reduces performance, but the WPF rendering system calls methods on this device from another thread. Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.  \n  \n If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag. Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.  \n  \n Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>.  \n  \n## Best Practices for Multi-Monitor Displays  \n If you are using a computer that has multiple monitors, you should follow the previously described best practices. There are also some additional performance considerations for a multi-monitor configuration.  \n  \n When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter. Copying across adapters to update the front buffer can be very expensive. On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty. However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer. For more information, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).  \n  \n## Performance Summary  \n The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability. The front buffer and back buffer are assumed to be on the same adapter. Depending on the adapter configuration, hardware updates are generally much faster than software updates.  \n  \n|Surface pixel format|Windows Vista, WDDM and 9Ex|Other Windows Vista configurations|Windows XP SP3 or SP2 w/ hotfix|Windows XP SP2|  \n|--------------------------|---------------------------------|----------------------------------------|--------------------------------------|--------------------|  \n|D3DFMT_X8R8G8B8 (not lockable)|**Hardware Update**|Software Update|Software Update|Software Update|  \n|D3DFMT_X8R8G8B8 (lockable)|**Hardware Update**|Software Update|**Hardware Update**|**Hardware Update**|  \n|D3DFMT_A8R8G8B8 (not lockable)|**Hardware Update**|Software Update|Software Update|Software Update|  \n|D3DFMT_A8R8G8B8 (lockable)|**Hardware Update**|Software Update|**Hardware Update**|Software Update|  \n  \n## See also\n\n- <xref:System.Windows.Interop.D3DImage>\n- [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md)\n- [Walkthrough: Creating Direct3D9 Content for Hosting in WPF](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)\n- [Walkthrough: Hosting Direct3D9 Content in WPF](walkthrough-hosting-direct3d9-content-in-wpf.md)\n","nodes":[{"pos":[4,270],"embed":true,"restype":"x-metadata","content":"title: \"Performance Considerations for Direct3D9 and WPF Interoperability\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"WPF [WPF], Direct3D9 interop performance\"\n  - \"Direct3D9 [WPF interoperability], performance\"\nms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd","nodes":[{"content":"Performance Considerations for Direct3D9 and WPF Interoperability","nodes":[{"pos":[0,65],"content":"Performance Considerations for Direct3D9 and WPF Interoperability","nodes":[{"content":"Performance Considerations for Direct3D9 and WPF Interoperability","pos":[0,65]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[277,342],"content":"Performance Considerations for Direct3D9 and WPF Interoperability","linkify":"Performance Considerations for Direct3D9 and WPF Interoperability","nodes":[{"content":"Performance Considerations for Direct3D9 and WPF Interoperability","pos":[0,65]}]},{"content":"You can host Direct3D9 content by using the <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> class.","pos":[343,432],"source":"You can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class."},{"content":"Hosting Direct3D9 content can affect the performance of your application.","pos":[433,506]},{"content":"This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application.","pos":[507,653]},{"content":"These best practices include how to use <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.","pos":[654,825],"source":" These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays."},{"pos":[833,977],"content":"[!NOTE]\n For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).","leadings":["","> "],"nodes":[{"content":"For code examples that demonstrate these best practices, see <bpt id=\"p1\">[</bpt>WPF and Direct3D9 Interoperation<ept id=\"p1\">](wpf-and-direct3d9-interoperation.md)</ept>.","pos":[9,142],"source":"For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md)."}]},{"pos":[986,1008],"content":"Use D3DImage Sparingly","linkify":"Use D3DImage Sparingly","nodes":[{"content":"Use D3DImage Sparingly","pos":[0,22]}]},{"content":"Direct3D9 content hosted in a <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> instance does not render as fast as in a pure Direct3D application.","pos":[1012,1148],"source":"Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application."},{"content":"Copying the surface and flushing the command buffer can be costly operations.","pos":[1149,1226]},{"content":"As the number of <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> instances increases, more flushing occurs, and performance degrades.","pos":[1227,1351],"source":" As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades."},{"content":"Therefore, you should use <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> sparingly.","pos":[1352,1427],"source":" Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly."},{"pos":[1436,1467],"content":"Best Practices on Windows Vista","linkify":"Best Practices on Windows Vista","nodes":[{"content":"Best Practices on Windows Vista","pos":[0,31]}]},{"content":"For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an <ph id=\"ph1\">`IDirect3DDevice9Ex`</ph> device.","pos":[1471,1655],"source":"For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device."},{"content":"This enables surface sharing.","pos":[1656,1685]},{"content":"The video card must support the <ph id=\"ph1\">`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`</ph> and <ph id=\"ph2\">`D3DCAPS2_CANSHARERESOURCE`</ph> driver capabilities on Windows Vista.","pos":[1686,1831],"source":" The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista."},{"content":"Any other settings cause the surface to be copied through software, which reduces performance significantly.","pos":[1832,1940]},{"pos":[1948,2292],"content":"[!NOTE]\n If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings. With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.","leadings":["","> "],"nodes":[{"content":"If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings. With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.","pos":[9,342],"nodes":[{"content":"If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings.","pos":[0,171]},{"content":"With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.","pos":[172,333]}]}]},{"pos":[2301,2329],"content":"Best Practices on Windows XP","linkify":"Best Practices on Windows XP","nodes":[{"content":"Best Practices on Windows XP","pos":[0,28]}]},{"content":"For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the <ph id=\"ph1\">`IDirect3DSurface9::GetDC`</ph> method is called.","pos":[2333,2526],"source":"For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called."},{"content":"Internally, the <ph id=\"ph1\">`BitBlt`</ph> method transfers the surface across devices in hardware.","pos":[2527,2608],"source":" Internally, the `BitBlt` method transfers the surface across devices in hardware."},{"content":"The <ph id=\"ph1\">`GetDC`</ph> method always works on XRGB surfaces.","pos":[2609,2658],"source":" The `GetDC` method always works on XRGB surfaces."},{"content":"However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces.","pos":[2659,2840]},{"content":"The video card must support the <ph id=\"ph1\">`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`</ph> driver capability.","pos":[2841,2935],"source":" The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability."},{"content":"A 16-bit desktop display depth can significantly reduce performance.","pos":[2942,3010]},{"content":"A 32-bit desktop is recommended.","pos":[3011,3043]},{"content":"If you are developing for Windows Vista and Windows XP, test the performance on Windows XP.","pos":[3050,3141]},{"content":"Running out of video memory on Windows XP is a concern.","pos":[3142,3197]},{"content":"In addition, <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy.","pos":[3198,3369],"source":" In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy."},{"content":"Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.","pos":[3370,3484]},{"pos":[3492,3608],"content":"[!NOTE]\n XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.","leadings":["","> "],"nodes":[{"content":"XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.","pos":[9,114]}]},{"pos":[3617,3639],"content":"General Best Practices","linkify":"General Best Practices","nodes":[{"content":"General Best Practices","pos":[0,22]}]},{"content":"When you create the device, use the <ph id=\"ph1\">`D3DCREATE_MULTITHREADED`</ph> creation flag.","pos":[3643,3719],"source":"When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag."},{"content":"This reduces performance, but the WPF rendering system calls methods on this device from another thread.","pos":[3720,3824]},{"content":"Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.","pos":[3825,3933]},{"content":"If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the <ph id=\"ph1\">`D3DCREATE_FPU_PRESERVE`</ph> creation flag.","pos":[3940,4098],"source":"If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag."},{"content":"Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.","pos":[4099,4229]},{"pos":[4236,4510],"content":"Tiling a <ph id=\"ph1\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <ph id=\"ph2\">&lt;xref:System.Windows.Media.DrawingBrush&gt;</ph> or <ph id=\"ph3\">&lt;xref:System.Windows.Media.VisualBrush&gt;</ph> that contains a <ph id=\"ph4\">&lt;xref:System.Windows.Interop.D3DImage&gt;</ph>.","source":"Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>."},{"pos":[4519,4560],"content":"Best Practices for Multi-Monitor Displays","linkify":"Best Practices for Multi-Monitor Displays","nodes":[{"content":"Best Practices for Multi-Monitor Displays","pos":[0,41]}]},{"content":"If you are using a computer that has multiple monitors, you should follow the previously described best practices.","pos":[4564,4678]},{"content":"There are also some additional performance considerations for a multi-monitor configuration.","pos":[4679,4771]},{"content":"When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter.","pos":[4778,4911]},{"content":"Copying across adapters to update the front buffer can be very expensive.","pos":[4912,4985]},{"content":"On Windows Vista that is configured to use the WDDM with multiple video cards and with an <ph id=\"ph1\">`IDirect3DDevice9Ex`</ph> device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty.","pos":[4986,5214],"source":" On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty."},{"content":"However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer.","pos":[5215,5400]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>WPF and Direct3D9 Interoperation<ept id=\"p1\">](wpf-and-direct3d9-interoperation.md)</ept>.","pos":[5401,5499],"source":" For more information, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md)."},{"pos":[5508,5527],"content":"Performance Summary","linkify":"Performance Summary","nodes":[{"content":"Performance Summary","pos":[0,19]}]},{"content":"The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability.","pos":[5531,5669]},{"content":"The front buffer and back buffer are assumed to be on the same adapter.","pos":[5670,5741]},{"content":"Depending on the adapter configuration, hardware updates are generally much faster than software updates.","pos":[5742,5847]},{"content":"Surface pixel format","pos":[5854,5874]},{"content":"Windows Vista, WDDM and 9Ex","pos":[5875,5902]},{"content":"Other Windows Vista configurations","pos":[5903,5937]},{"content":"Windows XP SP3 or SP2 w/ hotfix","pos":[5938,5969]},{"content":"Windows XP SP2","pos":[5970,5984]},{"content":"D3DFMT_X8R8G8B8 (not lockable)","pos":[6155,6185]},{"pos":[6186,6205],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"content":"Software Update","pos":[6206,6221]},{"content":"Software Update","pos":[6222,6237]},{"content":"Software Update","pos":[6238,6253]},{"content":"D3DFMT_X8R8G8B8 (lockable)","pos":[6258,6284]},{"pos":[6285,6304],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"content":"Software Update","pos":[6305,6320]},{"pos":[6321,6340],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"pos":[6341,6360],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"content":"D3DFMT_A8R8G8B8 (not lockable)","pos":[6365,6395]},{"pos":[6396,6415],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"content":"Software Update","pos":[6416,6431]},{"content":"Software Update","pos":[6432,6447]},{"content":"Software Update","pos":[6448,6463]},{"content":"D3DFMT_A8R8G8B8 (lockable)","pos":[6468,6494]},{"pos":[6495,6514],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"content":"Software Update","pos":[6515,6530]},{"pos":[6531,6550],"content":"<bpt id=\"p1\">**</bpt>Hardware Update<ept id=\"p1\">**</ept>","source":"**Hardware Update**"},{"content":"Software Update","pos":[6551,6566]},{"pos":[6576,6584],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6629,6700],"content":"<bpt id=\"p1\">[</bpt>WPF and Direct3D9 Interoperation<ept id=\"p1\">](wpf-and-direct3d9-interoperation.md)</ept>","source":"[WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md)"},{"pos":[6703,6825],"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Creating Direct3D9 Content for Hosting in WPF<ept id=\"p1\">](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)</ept>","source":"[Walkthrough: Creating Direct3D9 Content for Hosting in WPF](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)"},{"pos":[6828,6924],"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Hosting Direct3D9 Content in WPF<ept id=\"p1\">](walkthrough-hosting-direct3d9-content-in-wpf.md)</ept>","source":"[Walkthrough: Hosting Direct3D9 Content in WPF](walkthrough-hosting-direct3d9-content-in-wpf.md)"}]}