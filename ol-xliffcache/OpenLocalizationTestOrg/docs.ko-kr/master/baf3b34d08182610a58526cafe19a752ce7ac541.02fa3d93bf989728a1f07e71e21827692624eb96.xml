{"content":"---\ntitle: \"Enabling Query Notifications | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-ado\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: a5333e19-8e55-4aa9-82dc-ca8745e516ed\ncaps.latest.revision: 6\nauthor: \"JennieHubbard\"\nms.author: \"jhubbard\"\nmanager: \"jhubbard\"\n---\n# Enabling Query Notifications\nApplications that consume query notifications have a common set of requirements. Your data source must be correctly configured to support SQL query notifications, and the user must have the correct client-side and server-side permissions.  \n  \n To use query notifications you must:  \n  \n-   Enable query notifications for your database.  \n  \n-   Ensure that the user ID used to connect to the database has the necessary permissions.  \n  \n-   Use a <xref:System.Data.SqlClient.SqlCommand> object to execute a valid SELECT statement with an associated notification object—either <xref:System.Data.SqlClient.SqlDependency> or <xref:System.Data.Sql.SqlNotificationRequest>.  \n  \n-   Provide code to process the notification if the data being monitored changes.  \n  \n## Query Notifications Requirements  \n Query notifications are supported only for SELECT statements that meet a list of specific requirements. The following table provides links to the Service Broker and Query Notifications documentation in SQL Server Books Online.  \n  \n **SQL Server Books Online**  \n  \n-   [Creating a Query for Notification](http://msdn.microsoft.com/library/ms181122.aspx)  \n  \n-   [Security Considerations for Service Broker](http://msdn.microsoft.com/library/ms166059.aspx)  \n  \n-   [Security and Protection (Service Broker)](http://msdn.microsoft.com/library/bb522911.aspx)  \n  \n-   [Security Considerations for Notifications Services](http://msdn.microsoft.com/library/ms172604.aspx)  \n  \n-   [Query Notification Permissions](http://msdn.microsoft.com/library/ms188311.aspx)  \n  \n-   [International Considerations for Service Broker](http://msdn.microsoft.com/library/ms166028.aspx)  \n  \n-   [Solution Design Considerations (Service Broker)](http://msdn.microsoft.com/library/bb522899.aspx)  \n  \n-   [Service Broker Developer InfoCenter](http://msdn.microsoft.com/library/ms166100.aspx)  \n  \n-   [Developer's Guide (Service Broker)](http://msdn.microsoft.com/library/bb522908.aspx)  \n  \n## Enabling Query Notifications to Run Sample Code  \n To enable Service Broker on the **AdventureWorks** database by using SQL Server Management Studio, execute the following Transact-SQL statement:  \n  \n `ALTER DATABASE AdventureWorks SET ENABLE_BROKER;`  \n  \n For the query notification samples to run correctly, the following Transact-SQL statements must be executed on the database server.  \n  \n```  \nCREATE QUEUE ContactChangeMessages;  \n  \nCREATE SERVICE ContactChangeNotifications  \n  ON QUEUE ContactChangeMessages  \n([http://schemas.microsoft.com/SQL/Notifications/PostQueryNotification]);  \n```  \n  \n## Query Notifications Permissions  \n Users who execute commands requesting notification must have SUBSCRIBE QUERY NOTIFICATIONS database permission on the server.  \n  \n Client-side code that runs in a partial trust situation requires the <xref:System.Data.SqlClient.SqlClientPermission>.  \n  \n The following code creates a <xref:System.Data.SqlClient.SqlClientPermission> object, setting the <xref:System.Security.Permissions.PermissionState> to <xref:System.Security.Permissions.PermissionState>. The <xref:System.Security.CodeAccessPermission.Demand%2A> will force a <xref:System.Security.SecurityException> at run time if all callers higher in the call stack have not been granted the permission.  \n  \n [!code-csharp[DataWorks SqlNotification.Perms#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlNotification.Perms/CS/source.cs#1)]\n [!code-vb[DataWorks SqlNotification.Perms#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlNotification.Perms/VB/source.vb#1)]  \n  \n## Choosing a Notification Object  \n The query notifications API provides two objects to process notifications: <xref:System.Data.SqlClient.SqlDependency> and <xref:System.Data.Sql.SqlNotificationRequest>. In general, most non-ASP.NET applications should use the <xref:System.Data.SqlClient.SqlDependency> object. ASP.NET applications should use the higher-level <xref:System.Web.Caching.SqlCacheDependency>, which wraps <xref:System.Data.SqlClient.SqlDependency> and provides a framework for administering the notification and cache objects.  \n  \n### Using SqlDependency  \n To use <xref:System.Data.SqlClient.SqlDependency>, Service Broker must be enabled for the SQL Server database being used, and users must have permissions to receive notifications. Service Broker objects, such as the notification queue, are predefined.  \n  \n In addition, <xref:System.Data.SqlClient.SqlDependency> automatically launches a worker thread to process notifications as they are posted to the queue; it also parses the Service Broker message, exposing the information as event argument data. <xref:System.Data.SqlClient.SqlDependency> must be initialized by calling the `Start` method to establish a dependency to the database. This is a static method that needs to be called only once during application initialization for each database connection required. The `Stop` method should be called at application termination for each dependency connection that was made.  \n  \n### Using SqlNotificationRequest  \n In contrast, <xref:System.Data.Sql.SqlNotificationRequest> requires you to implement the entire listening infrastructure yourself. In addition, all the supporting Service Broker objects such as the queue, service, and message types supported by the queue must be defined. This manual approach is useful if your application requires special notification messages or notification behaviors, or if your application is part of a larger Service Broker application.  \n  \n## See Also  \n [Query Notifications in SQL Server](../../../../../docs/framework/data/adonet/sql/query-notifications-in-sql-server.md)   \n [ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)","nodes":[{"pos":[12,57],"content":"Enabling Query Notifications | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Enabling Query Notifications | Microsoft Docs","pos":[0,45]}]},{"pos":[366,394],"content":"Enabling Query Notifications","linkify":"Enabling Query Notifications","nodes":[{"content":"Enabling Query Notifications","pos":[0,28]}]},{"content":"Applications that consume query notifications have a common set of requirements.","pos":[395,475]},{"content":"Your data source must be correctly configured to support SQL query notifications, and the user must have the correct client-side and server-side permissions.","pos":[476,633]},{"content":"To use query notifications you must:","pos":[640,676]},{"content":"Enable query notifications for your database.","pos":[686,731]},{"content":"Ensure that the user ID used to connect to the database has the necessary permissions.","pos":[741,827]},{"content":"Use a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlCommand&gt;</ph> object to execute a valid SELECT statement with an associated notification object—either <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph> or <ph id=\"ph3\">&lt;xref:System.Data.Sql.SqlNotificationRequest&gt;</ph>.","pos":[837,1064],"source":"Use a <xref:System.Data.SqlClient.SqlCommand> object to execute a valid SELECT statement with an associated notification object—either <xref:System.Data.SqlClient.SqlDependency> or <xref:System.Data.Sql.SqlNotificationRequest>."},{"content":"Provide code to process the notification if the data being monitored changes.","pos":[1074,1151]},{"pos":[1160,1192],"content":"Query Notifications Requirements","linkify":"Query Notifications Requirements","nodes":[{"content":"Query Notifications Requirements","pos":[0,32]}]},{"content":"Query notifications are supported only for SELECT statements that meet a list of specific requirements.","pos":[1196,1299]},{"content":"The following table provides links to the Service Broker and Query Notifications documentation in SQL Server Books Online.","pos":[1300,1422]},{"pos":[1429,1456],"content":"<bpt id=\"p1\">**</bpt>SQL Server Books Online<ept id=\"p1\">**</ept>","source":"**SQL Server Books Online**"},{"pos":[1466,1550],"content":"<bpt id=\"p1\">[</bpt>Creating a Query for Notification<ept id=\"p1\">](http://msdn.microsoft.com/library/ms181122.aspx)</ept>","source":"[Creating a Query for Notification](http://msdn.microsoft.com/library/ms181122.aspx)"},{"pos":[1560,1653],"content":"<bpt id=\"p1\">[</bpt>Security Considerations for Service Broker<ept id=\"p1\">](http://msdn.microsoft.com/library/ms166059.aspx)</ept>","source":"[Security Considerations for Service Broker](http://msdn.microsoft.com/library/ms166059.aspx)"},{"pos":[1663,1754],"content":"<bpt id=\"p1\">[</bpt>Security and Protection (Service Broker)<ept id=\"p1\">](http://msdn.microsoft.com/library/bb522911.aspx)</ept>","source":"[Security and Protection (Service Broker)](http://msdn.microsoft.com/library/bb522911.aspx)"},{"pos":[1764,1865],"content":"<bpt id=\"p1\">[</bpt>Security Considerations for Notifications Services<ept id=\"p1\">](http://msdn.microsoft.com/library/ms172604.aspx)</ept>","source":"[Security Considerations for Notifications Services](http://msdn.microsoft.com/library/ms172604.aspx)"},{"pos":[1875,1956],"content":"<bpt id=\"p1\">[</bpt>Query Notification Permissions<ept id=\"p1\">](http://msdn.microsoft.com/library/ms188311.aspx)</ept>","source":"[Query Notification Permissions](http://msdn.microsoft.com/library/ms188311.aspx)"},{"pos":[1966,2064],"content":"<bpt id=\"p1\">[</bpt>International Considerations for Service Broker<ept id=\"p1\">](http://msdn.microsoft.com/library/ms166028.aspx)</ept>","source":"[International Considerations for Service Broker](http://msdn.microsoft.com/library/ms166028.aspx)"},{"pos":[2074,2172],"content":"<bpt id=\"p1\">[</bpt>Solution Design Considerations (Service Broker)<ept id=\"p1\">](http://msdn.microsoft.com/library/bb522899.aspx)</ept>","source":"[Solution Design Considerations (Service Broker)](http://msdn.microsoft.com/library/bb522899.aspx)"},{"pos":[2182,2268],"content":"<bpt id=\"p1\">[</bpt>Service Broker Developer InfoCenter<ept id=\"p1\">](http://msdn.microsoft.com/library/ms166100.aspx)</ept>","source":"[Service Broker Developer InfoCenter](http://msdn.microsoft.com/library/ms166100.aspx)"},{"pos":[2278,2363],"content":"<bpt id=\"p1\">[</bpt>Developer's Guide (Service Broker)<ept id=\"p1\">](http://msdn.microsoft.com/library/bb522908.aspx)</ept>","source":"[Developer's Guide (Service Broker)](http://msdn.microsoft.com/library/bb522908.aspx)"},{"pos":[2372,2419],"content":"Enabling Query Notifications to Run Sample Code","linkify":"Enabling Query Notifications to Run Sample Code","nodes":[{"content":"Enabling Query Notifications to Run Sample Code","pos":[0,47]}]},{"pos":[2423,2567],"content":"To enable Service Broker on the <bpt id=\"p1\">**</bpt>AdventureWorks<ept id=\"p1\">**</ept> database by using SQL Server Management Studio, execute the following Transact-SQL statement:","source":"To enable Service Broker on the **AdventureWorks** database by using SQL Server Management Studio, execute the following Transact-SQL statement:"},{"content":"For the query notification samples to run correctly, the following Transact-SQL statements must be executed on the database server.","pos":[2631,2762]},{"pos":[2982,3013],"content":"Query Notifications Permissions","linkify":"Query Notifications Permissions","nodes":[{"content":"Query Notifications Permissions","pos":[0,31]}]},{"content":"Users who execute commands requesting notification must have SUBSCRIBE QUERY NOTIFICATIONS database permission on the server.","pos":[3017,3142]},{"content":"Client-side code that runs in a partial trust situation requires the <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlClientPermission&gt;</ph>.","pos":[3149,3267],"source":"Client-side code that runs in a partial trust situation requires the <xref:System.Data.SqlClient.SqlClientPermission>."},{"content":"The following code creates a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlClientPermission&gt;</ph> object, setting the <ph id=\"ph2\">&lt;xref:System.Security.Permissions.PermissionState&gt;</ph> to <ph id=\"ph3\">&lt;xref:System.Security.Permissions.PermissionState&gt;</ph>.","pos":[3274,3477],"source":"The following code creates a <xref:System.Data.SqlClient.SqlClientPermission> object, setting the <xref:System.Security.Permissions.PermissionState> to <xref:System.Security.Permissions.PermissionState>."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Security.CodeAccessPermission.Demand%2A&gt;</ph> will force a <ph id=\"ph2\">&lt;xref:System.Security.SecurityException&gt;</ph> at run time if all callers higher in the call stack have not been granted the permission.","pos":[3478,3679],"source":" The <xref:System.Security.CodeAccessPermission.Demand%2A> will force a <xref:System.Security.SecurityException> at run time if all callers higher in the call stack have not been granted the permission."},{"pos":[3686,4001],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>DataWorks SqlNotification.Perms#1<ept id=\"p2\">](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlNotification.Perms/CS/source.cs#1)</ept><ept id=\"p1\">]</ept> <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>DataWorks SqlNotification.Perms#1<ept id=\"p4\">](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlNotification.Perms/VB/source.vb#1)</ept><ept id=\"p3\">]</ept>","source":"[!code-csharp[DataWorks SqlNotification.Perms#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlNotification.Perms/CS/source.cs#1)]\n [!code-vb[DataWorks SqlNotification.Perms#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlNotification.Perms/VB/source.vb#1)]"},{"pos":[4010,4040],"content":"Choosing a Notification Object","linkify":"Choosing a Notification Object","nodes":[{"content":"Choosing a Notification Object","pos":[0,30]}]},{"content":"The query notifications API provides two objects to process notifications: <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Data.Sql.SqlNotificationRequest&gt;</ph>.","pos":[4044,4212],"source":"The query notifications API provides two objects to process notifications: <xref:System.Data.SqlClient.SqlDependency> and <xref:System.Data.Sql.SqlNotificationRequest>."},{"content":"In general, most non-ASP.NET applications should use the <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph> object.","pos":[4213,4320],"source":" In general, most non-ASP.NET applications should use the <xref:System.Data.SqlClient.SqlDependency> object."},{"content":"ASP.NET applications should use the higher-level <ph id=\"ph1\">&lt;xref:System.Web.Caching.SqlCacheDependency&gt;</ph>, which wraps <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph> and provides a framework for administering the notification and cache objects.","pos":[4321,4549],"source":" ASP.NET applications should use the higher-level <xref:System.Web.Caching.SqlCacheDependency>, which wraps <xref:System.Data.SqlClient.SqlDependency> and provides a framework for administering the notification and cache objects."},{"pos":[4559,4578],"content":"Using SqlDependency","linkify":"Using SqlDependency","nodes":[{"content":"Using SqlDependency","pos":[0,19]}]},{"content":"To use <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph>, Service Broker must be enabled for the SQL Server database being used, and users must have permissions to receive notifications.","pos":[4582,4761],"source":"To use <xref:System.Data.SqlClient.SqlDependency>, Service Broker must be enabled for the SQL Server database being used, and users must have permissions to receive notifications."},{"content":"Service Broker objects, such as the notification queue, are predefined.","pos":[4762,4833]},{"content":"In addition, <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph> automatically launches a worker thread to process notifications as they are posted to the queue; it also parses the Service Broker message, exposing the information as event argument data.","pos":[4840,5084],"source":"In addition, <xref:System.Data.SqlClient.SqlDependency> automatically launches a worker thread to process notifications as they are posted to the queue; it also parses the Service Broker message, exposing the information as event argument data."},{"content":"<ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlDependency&gt;</ph> must be initialized by calling the <ph id=\"ph2\">`Start`</ph> method to establish a dependency to the database.","pos":[5085,5220],"source":"<xref:System.Data.SqlClient.SqlDependency> must be initialized by calling the `Start` method to establish a dependency to the database."},{"content":"This is a static method that needs to be called only once during application initialization for each database connection required.","pos":[5221,5351]},{"content":"The <ph id=\"ph1\">`Stop`</ph> method should be called at application termination for each dependency connection that was made.","pos":[5352,5459],"source":" The `Stop` method should be called at application termination for each dependency connection that was made."},{"pos":[5469,5497],"content":"Using SqlNotificationRequest","linkify":"Using SqlNotificationRequest","nodes":[{"content":"Using SqlNotificationRequest","pos":[0,28]}]},{"content":"In contrast, <ph id=\"ph1\">&lt;xref:System.Data.Sql.SqlNotificationRequest&gt;</ph> requires you to implement the entire listening infrastructure yourself.","pos":[5501,5631],"source":"In contrast, <xref:System.Data.Sql.SqlNotificationRequest> requires you to implement the entire listening infrastructure yourself."},{"content":"In addition, all the supporting Service Broker objects such as the queue, service, and message types supported by the queue must be defined.","pos":[5632,5772]},{"content":"This manual approach is useful if your application requires special notification messages or notification behaviors, or if your application is part of a larger Service Broker application.","pos":[5773,5960]},{"pos":[5969,5977],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Query Notifications in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/query-notifications-in-sql-server.md)</ept><ph id=\"ph1\"> </ph>","pos":[5981,6101],"source":"[Query Notifications in SQL Server](../../../../../docs/framework/data/adonet/sql/query-notifications-in-sql-server.md) "},{"content":"<bpt id=\"p1\"> [</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=217917)</ept>","pos":[6104,6208],"source":" [ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)"}]}