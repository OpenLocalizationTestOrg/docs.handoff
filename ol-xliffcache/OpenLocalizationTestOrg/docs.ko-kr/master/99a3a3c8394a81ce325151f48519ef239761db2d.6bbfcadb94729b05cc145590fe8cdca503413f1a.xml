{"content":"---\ntitle: \"Walkthrough: Using Dataflow in a Windows Forms Application | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"TPL dataflow library, in Windows Forms\"\n  - \"Task Parallel Library, dataflows\"\n  - \"Windows Forms, and TPL\"\nms.assetid: 9c65cdf7-660c-409f-89ea-59d7ec8e127c\ncaps.latest.revision: 8\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"\n---\n# Walkthrough: Using Dataflow in a Windows Forms Application\nThis document demonstrates how to create a network of dataflow blocks that perform image processing in a Windows Forms application.  \n  \n This example loads image files from the specified folder, creates a composite image, and displays the result. The example uses the dataflow model to route images through the network. In the dataflow model, independent components of a program communicate with one another by sending messages. When a component receives a message, it performs some action and then passes the result to another component. Compare this with the control flow model, in which an application uses control structures, for example, conditional statements, loops, and so on, to control the order of operations in a program.  \n  \n## Prerequisites  \n Read [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md) before you start this walkthrough.  \n  \n> [!TIP]\n>  The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.  \n  \n> [!TIP]\n>  The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.  \n  \n## Sections  \n This walkthrough contains the following sections:  \n  \n-   [Creating the Windows Forms Application](#winforms)  \n  \n-   [Creating the Dataflow Network](#network)  \n  \n-   [Connecting the Dataflow Network to the User Interface](#ui)  \n  \n-   [The Complete Example](#complete)  \n  \n<a name=\"winforms\"></a>   \n## Creating the Windows Forms Application  \n This section describes how to create the basic Windows Forms application and add controls to the main form.  \n  \n#### To Create the Windows Forms Application  \n  \n1.  In [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)], create a [!INCLUDE[csprcs](../../../includes/csprcs-md.md)] or Visual Basic **Windows Forms Application** project. In this document, the project is named `CompositeImages`.  \n  \n2.  On the form designer for the main form, Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), add a <xref:System.Windows.Forms.ToolStrip> control.  \n  \n3.  Add a <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control. Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle> and the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Choose Folder**.  \n  \n4.  Add a second <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control. Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle>, the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Cancel**, and the <xref:System.Windows.Forms.ToolStripItem.Enabled%2A> property to `False`.  \n  \n5.  Add a <xref:System.Windows.Forms.PictureBox> object to the main form. Set the <xref:System.Windows.Forms.Control.Dock%2A> property to <xref:System.Windows.Forms.DockStyle>.  \n  \n<a name=\"network\"></a>   \n## Creating the Dataflow Network  \n This section describes how to create the dataflow network that performs image processing.  \n  \n#### To Create the Dataflow Network  \n  \n1.  Add a reference to System.Threading.Tasks.Dataflow.dll to your project.  \n  \n2.  Ensure that Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) contains the following `using` (`Using` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) statements:  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#1)]  \n  \n3.  Add the following data members to the `Form1` class:  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#2)]  \n  \n4.  Add the following method, `CreateImageProcessingNetwork`, to the `Form1` class. This method creates the image processing network.  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#3)]  \n  \n5.  Implement the `LoadBitmaps` method.  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#4)]  \n  \n6.  Implement the `CreateCompositeBitmap` method.  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#5](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#5)]  \n  \n    > [!NOTE]\n    >  The C# version of the `CreateCompositeBitmap` method uses pointers to enable efficient processing of the <xref:System.Drawing.Bitmap?displayProperty=fullName> objects. Therefore, you must enable the **Allow unsafe code** option in your project in order to use the [unsafe](~/docs/csharp/language-reference/keywords/unsafe.md) keyword. For more information about how to enable unsafe code in a [!INCLUDE[csprcs](../../../includes/csprcs-md.md)] project, see [Build Page, Project Designer (C#)]https://msdn.microsoft.com/library/kb4wyys2).  \n  \n The following table describes the members of the network.  \n  \n|Member|Type|Description|  \n|------------|----------|-----------------|  \n|`loadBitmaps`|<xref:System.Threading.Tasks.Dataflow.TransformBlock%602>|Takes a folder path as input and produces a collection of <xref:System.Drawing.Bitmap> objects as output.|  \n|`createCompositeBitmap`|<xref:System.Threading.Tasks.Dataflow.TransformBlock%602>|Takes a collection of <xref:System.Drawing.Bitmap> objects as input and produces a composite bitmap as output.|  \n|`displayCompositeBitmap`|<xref:System.Threading.Tasks.Dataflow.ActionBlock%601>|Displays the composite bitmap on the form.|  \n|`operationCancelled`|<xref:System.Threading.Tasks.Dataflow.ActionBlock%601>|Displays an image to indicate that the operation is canceled and enables the user to select another folder.|  \n  \n To connect the dataflow blocks to form a network, this example uses the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A> method. The <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A> method contains an overloaded version that takes a <xref:System.Predicate%601> object that determines whether the target block accepts or rejects a message. This filtering mechanism enables message blocks to receive only certain values. In this example, the network can branch in one of two ways. The main branch loads the images from disk, creates the composite image, and displays that image on the form. The alternate branch cancels the current operation. The <xref:System.Predicate%601> objects enable the dataflow blocks along the main branch to switch to the alternative branch by rejecting certain messages. For example, if the user cancels the operation, the dataflow block `createCompositeBitmap` produces `null` (`Nothing` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) as its output. The dataflow block `displayCompositeBitmap` rejects `null` input values, and therefore, the message is offered to `operationCancelled`. The dataflow block `operationCancelled` accepts all messages and therefore, displays an image to indicate that the operation is canceled.  \n  \n The following illustration shows the image processing network.  \n  \n ![The image processing network](../../../docs/standard/parallel-programming/media/dataflowwinforms.png \"DataflowWinForms\")  \n  \n Because the `displayCompositeBitmap` and `operationCancelled` dataflow blocks act on the user interface, it is important that these actions occur on the user-interface thread. To accomplish this, during construction, these objects each provide a <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions> object that has the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A> property set to <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName>. The <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName> method creates a <xref:System.Threading.Tasks.TaskScheduler> object that performs work on the current synchronization context. Because the `CreateImageProcessingNetwork` method is called from the handler of the **Choose Folder** button, which runs on the user-interface thread, the actions for the `displayCompositeBitmap` and `operationCancelled` dataflow blocks also run on the user-interface thread.  \n  \n This example uses a shared cancellation token instead of setting the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property because the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property permanently cancels dataflow block execution. A cancellation token enables this example to reuse the same dataflow network multiple times, even when the user cancels one or more operations. For an example that uses <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> to permanently cancel the execution of a dataflow block, see [How to: Cancel a Dataflow Block](../../../docs/standard/parallel-programming/how-to-cancel-a-dataflow-block.md).  \n  \n<a name=\"ui\"></a>   \n## Connecting the Dataflow Network to the User Interface  \n This section describes how to connect the dataflow network to the user interface. The creation of the composite image and cancellation of the operation are initiated from the **Choose Folder** and **Cancel** buttons. When the user chooses either of these buttons, the appropriate action is initiated in an asynchronous manner.  \n  \n#### To Connect the Dataflow Network to the User Interface  \n  \n1.  On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Choose Folder** button.  \n  \n2.  Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Choose Folder** button.  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#6](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#6)]  \n  \n3.  On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Cancel** button.  \n  \n4.  Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Cancel** button.  \n  \n     [!code-csharp[TPLDataflow_CompositeImages#7](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#7)]  \n  \n<a name=\"complete\"></a>   \n## The Complete Example  \n The following example shows the complete code for this walkthrough.  \n  \n [!code-csharp[TPLDataflow_CompositeImages#100](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_compositeimages/cs/compositeimages/form1.cs#100)]  \n  \n The following illustration shows typical output for the common \\Sample Pictures\\ folder.  \n  \n ![The Windows Forms Application](../../../docs/standard/parallel-programming/media/tpldataflow-compositeimages.gif \"TPLDataflow_CompositeImages\")  \n  \n## Next Steps  \n  \n## See Also  \n [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)","nodes":[{"pos":[4,506],"embed":true,"restype":"x-metadata","content":"title: \"Walkthrough: Using Dataflow in a Windows Forms Application | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"TPL dataflow library, in Windows Forms\"\n  - \"Task Parallel Library, dataflows\"\n  - \"Windows Forms, and TPL\"\nms.assetid: 9c65cdf7-660c-409f-89ea-59d7ec8e127c\ncaps.latest.revision: 8\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"","nodes":[{"content":"Walkthrough: Using Dataflow in a Windows Forms Application | Microsoft Docs","nodes":[{"pos":[0,75],"content":"Walkthrough: Using Dataflow in a Windows Forms Application | Microsoft Docs","nodes":[{"content":"Walkthrough: Using Dataflow in a Windows Forms Application | Microsoft Docs","pos":[0,75]}]}],"path":["title"]}],"yml":true},{"pos":[513,571],"content":"Walkthrough: Using Dataflow in a Windows Forms Application","linkify":"Walkthrough: Using Dataflow in a Windows Forms Application","nodes":[{"content":"Walkthrough: Using Dataflow in a Windows Forms Application","pos":[0,58]}]},{"content":"This document demonstrates how to create a network of dataflow blocks that perform image processing in a Windows Forms application.","pos":[572,703]},{"content":"This example loads image files from the specified folder, creates a composite image, and displays the result.","pos":[710,819]},{"content":"The example uses the dataflow model to route images through the network.","pos":[820,892]},{"content":"In the dataflow model, independent components of a program communicate with one another by sending messages.","pos":[893,1001]},{"content":"When a component receives a message, it performs some action and then passes the result to another component.","pos":[1002,1111]},{"content":"Compare this with the control flow model, in which an application uses control structures, for example, conditional statements, loops, and so on, to control the order of operations in a program.","pos":[1112,1306]},{"pos":[1315,1328],"content":"Prerequisites","linkify":"Prerequisites","nodes":[{"content":"Prerequisites","pos":[0,13]}]},{"pos":[1332,1461],"content":"Read <bpt id=\"p1\">[</bpt>Dataflow<ept id=\"p1\">](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)</ept> before you start this walkthrough.","source":"Read [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md) before you start this walkthrough."},{"pos":[1469,1929],"content":"[!TIP]\n The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","leadings":["","> "],"nodes":[{"content":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","pos":[8,458],"nodes":[{"content":"The TPL Dataflow Library (<ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow?displayProperty=fullName&gt;</ph> namespace) is not distributed with the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>.","pos":[0,182],"source":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]."},{"content":"To install the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow&gt;</ph> namespace, open your project in <ph id=\"ph2\">[!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)]</ph>, choose <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> from the Project menu, and search online for the <ph id=\"ph3\">`Microsoft.Tpl.Dataflow`</ph> package.","pos":[183,450],"source":" To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package."}]}]},{"pos":[1937,2397],"content":"[!TIP]\n The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","leadings":["","> "],"nodes":[{"content":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","pos":[8,458],"nodes":[{"content":"The TPL Dataflow Library (<ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow?displayProperty=fullName&gt;</ph> namespace) is not distributed with the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>.","pos":[0,182],"source":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]."},{"content":"To install the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow&gt;</ph> namespace, open your project in <ph id=\"ph2\">[!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)]</ph>, choose <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> from the Project menu, and search online for the <ph id=\"ph3\">`Microsoft.Tpl.Dataflow`</ph> package.","pos":[183,450],"source":" To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package."}]}]},{"pos":[2406,2414],"content":"Sections","linkify":"Sections","nodes":[{"content":"Sections","pos":[0,8]}]},{"content":"This walkthrough contains the following sections:","pos":[2418,2467]},{"pos":[2477,2528],"content":"<bpt id=\"p1\">[</bpt>Creating the Windows Forms Application<ept id=\"p1\">](#winforms)</ept>","source":"[Creating the Windows Forms Application](#winforms)"},{"pos":[2538,2579],"content":"<bpt id=\"p1\">[</bpt>Creating the Dataflow Network<ept id=\"p1\">](#network)</ept>","source":"[Creating the Dataflow Network](#network)"},{"pos":[2589,2649],"content":"<bpt id=\"p1\">[</bpt>Connecting the Dataflow Network to the User Interface<ept id=\"p1\">](#ui)</ept>","source":"[Connecting the Dataflow Network to the User Interface](#ui)"},{"pos":[2659,2692],"content":"<bpt id=\"p1\">[</bpt>The Complete Example<ept id=\"p1\">](#complete)</ept>","source":"[The Complete Example](#complete)"},{"pos":[2728,2766],"content":"Creating the Windows Forms Application","linkify":"Creating the Windows Forms Application","nodes":[{"content":"Creating the Windows Forms Application","pos":[0,38]}]},{"content":"This section describes how to create the basic Windows Forms application and add controls to the main form.","pos":[2770,2877]},{"pos":[2888,2927],"content":"To Create the Windows Forms Application","linkify":"To Create the Windows Forms Application","nodes":[{"content":"To Create the Windows Forms Application","pos":[0,39]}]},{"content":"In <ph id=\"ph1\">[!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)]</ph>, create a <ph id=\"ph2\">[!INCLUDE[csprcs](../../../includes/csprcs-md.md)]</ph> or Visual Basic <bpt id=\"p1\">**</bpt>Windows Forms Application<ept id=\"p1\">**</ept> project.","pos":[2937,3106],"source":"In [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)], create a [!INCLUDE[csprcs](../../../includes/csprcs-md.md)] or Visual Basic **Windows Forms Application** project."},{"content":"In this document, the project is named <ph id=\"ph1\">`CompositeImages`</ph>.","pos":[3107,3164],"source":" In this document, the project is named `CompositeImages`."},{"pos":[3174,3342],"content":"On the form designer for the main form, Form1.cs (Form1.vb for <ph id=\"ph1\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>), add a <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","source":"On the form designer for the main form, Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), add a <xref:System.Windows.Forms.ToolStrip> control."},{"content":"Add a <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripButton&gt;</ph> control to the <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","pos":[3352,3463],"source":"Add a <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control."},{"content":"Set the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A&gt;</ph> property to <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStripItemDisplayStyle&gt;</ph> and the <ph id=\"ph3\">&lt;xref:System.Windows.Forms.ToolStripItem.Text%2A&gt;</ph> property to <bpt id=\"p1\">**</bpt>Choose Folder<ept id=\"p1\">**</ept>.","pos":[3464,3684],"source":" Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle> and the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Choose Folder**."},{"content":"Add a second <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripButton&gt;</ph> control to the <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","pos":[3694,3812],"source":"Add a second <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control."},{"content":"Set the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A&gt;</ph> property to <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStripItemDisplayStyle&gt;</ph>, the <ph id=\"ph3\">&lt;xref:System.Windows.Forms.ToolStripItem.Text%2A&gt;</ph> property to <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept>, and the <ph id=\"ph4\">&lt;xref:System.Windows.Forms.ToolStripItem.Enabled%2A&gt;</ph> property to <ph id=\"ph5\">`False`</ph>.","pos":[3813,4105],"source":" Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle>, the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Cancel**, and the <xref:System.Windows.Forms.ToolStripItem.Enabled%2A> property to `False`."},{"content":"Add a <ph id=\"ph1\">&lt;xref:System.Windows.Forms.PictureBox&gt;</ph> object to the main form.","pos":[4115,4184],"source":"Add a <xref:System.Windows.Forms.PictureBox> object to the main form."},{"content":"Set the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.Control.Dock%2A&gt;</ph> property to <ph id=\"ph2\">&lt;xref:System.Windows.Forms.DockStyle&gt;</ph>.","pos":[4185,4287],"source":" Set the <xref:System.Windows.Forms.Control.Dock%2A> property to <xref:System.Windows.Forms.DockStyle>."},{"pos":[4322,4351],"content":"Creating the Dataflow Network","linkify":"Creating the Dataflow Network","nodes":[{"content":"Creating the Dataflow Network","pos":[0,29]}]},{"content":"This section describes how to create the dataflow network that performs image processing.","pos":[4355,4444]},{"pos":[4455,4485],"content":"To Create the Dataflow Network","linkify":"To Create the Dataflow Network","nodes":[{"content":"To Create the Dataflow Network","pos":[0,30]}]},{"content":"Add a reference to System.Threading.Tasks.Dataflow.dll to your project.","pos":[4495,4566]},{"pos":[4576,4769],"content":"Ensure that Form1.cs (Form1.vb for <ph id=\"ph1\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) contains the following <ph id=\"ph2\">`using`</ph> (<ph id=\"ph3\">`Using`</ph> in <ph id=\"ph4\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) statements:","source":"Ensure that Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) contains the following `using` (`Using` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) statements:"},{"pos":[4944,4996],"content":"Add the following data members to the <ph id=\"ph1\">`Form1`</ph> class:","source":"Add the following data members to the `Form1` class:"},{"content":"Add the following method, <ph id=\"ph1\">`CreateImageProcessingNetwork`</ph>, to the <ph id=\"ph2\">`Form1`</ph> class.","pos":[5171,5250],"source":"Add the following method, `CreateImageProcessingNetwork`, to the `Form1` class."},{"content":"This method creates the image processing network.","pos":[5251,5300]},{"pos":[5475,5510],"content":"Implement the <ph id=\"ph1\">`LoadBitmaps`</ph> method.","source":"Implement the `LoadBitmaps` method."},{"pos":[5685,5730],"content":"Implement the <ph id=\"ph1\">`CreateCompositeBitmap`</ph> method.","source":"Implement the `CreateCompositeBitmap` method."},{"pos":[5907,6459],"content":"[!NOTE]\nThe C# version of the `CreateCompositeBitmap` method uses pointers to enable efficient processing of the <xref:System.Drawing.Bitmap?displayProperty=fullName> objects. Therefore, you must enable the **Allow unsafe code** option in your project in order to use the [unsafe](~/docs/csharp/language-reference/keywords/unsafe.md) keyword. For more information about how to enable unsafe code in a [!INCLUDE[csprcs](../../../includes/csprcs-md.md)] project, see [Build Page, Project Designer (C#)]https://msdn.microsoft.com/library/kb4wyys2).","leadings":["","    >  "],"nodes":[{"content":"The C# version of the `CreateCompositeBitmap` method uses pointers to enable efficient processing of the <xref:System.Drawing.Bitmap?displayProperty=fullName> objects. Therefore, you must enable the **Allow unsafe code** option in your project in order to use the [unsafe](~/docs/csharp/language-reference/keywords/unsafe.md) keyword. For more information about how to enable unsafe code in a [!INCLUDE[csprcs](../../../includes/csprcs-md.md)] project, see [Build Page, Project Designer (C#)]https://msdn.microsoft.com/library/kb4wyys2).","pos":[8,545],"nodes":[{"content":"The C# version of the <ph id=\"ph1\">`CreateCompositeBitmap`</ph> method uses pointers to enable efficient processing of the <ph id=\"ph2\">&lt;xref:System.Drawing.Bitmap?displayProperty=fullName&gt;</ph> objects.","pos":[0,167],"source":"The C# version of the `CreateCompositeBitmap` method uses pointers to enable efficient processing of the <xref:System.Drawing.Bitmap?displayProperty=fullName> objects."},{"content":"Therefore, you must enable the <bpt id=\"p1\">**</bpt>Allow unsafe code<ept id=\"p1\">**</ept> option in your project in order to use the <bpt id=\"p2\">[</bpt>unsafe<ept id=\"p2\">](~/docs/csharp/language-reference/keywords/unsafe.md)</ept> keyword.","pos":[168,334],"source":" Therefore, you must enable the **Allow unsafe code** option in your project in order to use the [unsafe](~/docs/csharp/language-reference/keywords/unsafe.md) keyword."},{"content":"For more information about how to enable unsafe code in a <ph id=\"ph1\">[!INCLUDE[csprcs](../../../includes/csprcs-md.md)]</ph> project, see [Build Page, Project Designer (C#)]https://msdn.microsoft.com/library/kb4wyys2).","pos":[335,537],"source":" For more information about how to enable unsafe code in a [!INCLUDE[csprcs](../../../includes/csprcs-md.md)] project, see [Build Page, Project Designer (C#)]https://msdn.microsoft.com/library/kb4wyys2)."}]}]},{"content":"The following table describes the members of the network.","pos":[6466,6523]},{"content":"Member","pos":[6530,6536]},{"content":"Type","pos":[6537,6541]},{"content":"Description","pos":[6542,6553]},{"content":"Takes a folder path as input and produces a collection of <ph id=\"ph1\">&lt;xref:System.Drawing.Bitmap&gt;</ph> objects as output.","pos":[6676,6781],"source":"Takes a folder path as input and produces a collection of <xref:System.Drawing.Bitmap> objects as output."},{"content":"Takes a collection of <ph id=\"ph1\">&lt;xref:System.Drawing.Bitmap&gt;</ph> objects as input and produces a composite bitmap as output.","pos":[6868,6978],"source":"Takes a collection of <xref:System.Drawing.Bitmap> objects as input and produces a composite bitmap as output."},{"content":"Displays the composite bitmap on the form.","pos":[7063,7105]},{"content":"Displays an image to indicate that the operation is canceled and enables the user to select another folder.","pos":[7186,7293]},{"content":"To connect the dataflow blocks to form a network, this example uses the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A&gt;</ph> method.","pos":[7301,7446],"source":"To connect the dataflow blocks to form a network, this example uses the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A> method."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A&gt;</ph> method contains an overloaded version that takes a <ph id=\"ph2\">&lt;xref:System.Predicate%601&gt;</ph> object that determines whether the target block accepts or rejects a message.","pos":[7447,7673],"source":" The <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A> method contains an overloaded version that takes a <xref:System.Predicate%601> object that determines whether the target block accepts or rejects a message."},{"content":"This filtering mechanism enables message blocks to receive only certain values.","pos":[7674,7753]},{"content":"In this example, the network can branch in one of two ways.","pos":[7754,7813]},{"content":"The main branch loads the images from disk, creates the composite image, and displays that image on the form.","pos":[7814,7923]},{"content":"The alternate branch cancels the current operation.","pos":[7924,7975]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Predicate%601&gt;</ph> objects enable the dataflow blocks along the main branch to switch to the alternative branch by rejecting certain messages.","pos":[7976,8131],"source":" The <xref:System.Predicate%601> objects enable the dataflow blocks along the main branch to switch to the alternative branch by rejecting certain messages."},{"content":"For example, if the user cancels the operation, the dataflow block <ph id=\"ph1\">`createCompositeBitmap`</ph> produces <ph id=\"ph2\">`null`</ph> (<ph id=\"ph3\">`Nothing`</ph> in <ph id=\"ph4\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) as its output.","pos":[8132,8319],"source":" For example, if the user cancels the operation, the dataflow block `createCompositeBitmap` produces `null` (`Nothing` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) as its output."},{"content":"The dataflow block <ph id=\"ph1\">`displayCompositeBitmap`</ph> rejects <ph id=\"ph2\">`null`</ph> input values, and therefore, the message is offered to <ph id=\"ph3\">`operationCancelled`</ph>.","pos":[8320,8455],"source":" The dataflow block `displayCompositeBitmap` rejects `null` input values, and therefore, the message is offered to `operationCancelled`."},{"content":"The dataflow block <ph id=\"ph1\">`operationCancelled`</ph> accepts all messages and therefore, displays an image to indicate that the operation is canceled.","pos":[8456,8593],"source":" The dataflow block `operationCancelled` accepts all messages and therefore, displays an image to indicate that the operation is canceled."},{"content":"The following illustration shows the image processing network.","pos":[8600,8662]},{"pos":[8669,8791],"content":"<bpt id=\"p1\">![</bpt>The image processing network<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../docs/standard/parallel-programming/media/dataflowwinforms.png \"</bpt>DataflowWinForms<ept id=\"p2\">\")</ept>","source":"![The image processing network](../../../docs/standard/parallel-programming/media/dataflowwinforms.png \"DataflowWinForms\")"},{"content":"Because the <ph id=\"ph1\">`displayCompositeBitmap`</ph> and <ph id=\"ph2\">`operationCancelled`</ph> dataflow blocks act on the user interface, it is important that these actions occur on the user-interface thread.","pos":[8798,8973],"source":"Because the `displayCompositeBitmap` and `operationCancelled` dataflow blocks act on the user interface, it is important that these actions occur on the user-interface thread."},{"content":"To accomplish this, during construction, these objects each provide a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions&gt;</ph> object that has the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A&gt;</ph> property set to <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName&gt;</ph>.","pos":[8974,9332],"source":" To accomplish this, during construction, these objects each provide a <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions> object that has the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A> property set to <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName>."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName&gt;</ph> method creates a <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.TaskScheduler&gt;</ph> object that performs work on the current synchronization context.","pos":[9333,9569],"source":" The <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName> method creates a <xref:System.Threading.Tasks.TaskScheduler> object that performs work on the current synchronization context."},{"content":"Because the <ph id=\"ph1\">`CreateImageProcessingNetwork`</ph> method is called from the handler of the <bpt id=\"p1\">**</bpt>Choose Folder<ept id=\"p1\">**</ept> button, which runs on the user-interface thread, the actions for the <ph id=\"ph2\">`displayCompositeBitmap`</ph> and <ph id=\"ph3\">`operationCancelled`</ph> dataflow blocks also run on the user-interface thread.","pos":[9570,9845],"source":" Because the `CreateImageProcessingNetwork` method is called from the handler of the **Choose Folder** button, which runs on the user-interface thread, the actions for the `displayCompositeBitmap` and `operationCancelled` dataflow blocks also run on the user-interface thread."},{"content":"This example uses a shared cancellation token instead of setting the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A&gt;</ph> property because the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A&gt;</ph> property permanently cancels dataflow block execution.","pos":[9852,10158],"source":"This example uses a shared cancellation token instead of setting the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property because the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property permanently cancels dataflow block execution."},{"content":"A cancellation token enables this example to reuse the same dataflow network multiple times, even when the user cancels one or more operations.","pos":[10159,10302]},{"content":"For an example that uses <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A&gt;</ph> to permanently cancel the execution of a dataflow block, see <bpt id=\"p1\">[</bpt>How to: Cancel a Dataflow Block<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-cancel-a-dataflow-block.md)</ept>.","pos":[10303,10583],"source":" For an example that uses <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> to permanently cancel the execution of a dataflow block, see [How to: Cancel a Dataflow Block](../../../docs/standard/parallel-programming/how-to-cancel-a-dataflow-block.md)."},{"pos":[10613,10666],"content":"Connecting the Dataflow Network to the User Interface","linkify":"Connecting the Dataflow Network to the User Interface","nodes":[{"content":"Connecting the Dataflow Network to the User Interface","pos":[0,53]}]},{"content":"This section describes how to connect the dataflow network to the user interface.","pos":[10670,10751]},{"content":"The creation of the composite image and cancellation of the operation are initiated from the <bpt id=\"p1\">**</bpt>Choose Folder<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Cancel<ept id=\"p2\">**</ept> buttons.","pos":[10752,10886],"source":" The creation of the composite image and cancellation of the operation are initiated from the **Choose Folder** and **Cancel** buttons."},{"content":"When the user chooses either of these buttons, the appropriate action is initiated in an asynchronous manner.","pos":[10887,10996]},{"pos":[11007,11060],"content":"To Connect the Dataflow Network to the User Interface","linkify":"To Connect the Dataflow Network to the User Interface","nodes":[{"content":"To Connect the Dataflow Network to the User Interface","pos":[0,53]}]},{"pos":[11070,11229],"content":"On the form designer for the main form, create an event handler for the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event for the <bpt id=\"p1\">**</bpt>Choose Folder<ept id=\"p1\">**</ept> button.","source":"On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Choose Folder** button."},{"pos":[11239,11340],"content":"Implement the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event for the <bpt id=\"p1\">**</bpt>Choose Folder<ept id=\"p1\">**</ept> button.","source":"Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Choose Folder** button."},{"pos":[11515,11667],"content":"On the form designer for the main form, create an event handler for the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event for the <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept> button.","source":"On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Cancel** button."},{"pos":[11677,11771],"content":"Implement the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event for the <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept> button.","source":"Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Cancel** button."},{"pos":[11972,11992],"content":"The Complete Example","linkify":"The Complete Example","nodes":[{"content":"The Complete Example","pos":[0,20]}]},{"content":"The following example shows the complete code for this walkthrough.","pos":[11996,12063]},{"content":"The following illustration shows typical output for the common \\Sample Pictures\\ folder.","pos":[12235,12323]},{"pos":[12330,12475],"content":"<bpt id=\"p1\">![</bpt>The Windows Forms Application<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../docs/standard/parallel-programming/media/tpldataflow-compositeimages.gif \"</bpt>TPLDataflow_CompositeImages<ept id=\"p2\">\")</ept>","source":"![The Windows Forms Application](../../../docs/standard/parallel-programming/media/tpldataflow-compositeimages.gif \"TPLDataflow_CompositeImages\")"},{"pos":[12484,12494],"content":"Next Steps","linkify":"Next Steps","nodes":[{"content":"Next Steps","pos":[0,10]}]},{"pos":[12503,12511],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[12515,12604],"content":"<bpt id=\"p1\">[</bpt>Dataflow<ept id=\"p1\">](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)</ept>","source":"[Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)"}]}