{"content":"---\ntitle: \"UDP Activation\"\nms.date: \"03/30/2017\"\nms.assetid: 4b0ccd10-0dfb-4603-93f9-f0857c581cb7\n---\n# UDP Activation\nThis sample is based on the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample. It extends the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample to support process activation using the Windows Process Activation Service (WAS).  \n  \n The sample consists of three major pieces:  \n  \n-   A UDP Protocol Activator, a standalone process that receives UDP messages on behalf of applications that are to be activated.  \n  \n-   A client that uses the UDP custom transport to send messages.  \n  \n-   A service (hosted in a worker process activated by WAS) that receives messages over the UDP custom transport.  \n  \n## UDP Protocol Activator  \n The UDP Protocol Activator is a bridge between the WCF client and the WCF service. It provides data communication through the UDP protocol at the transport layer. It has two major functions:  \n  \n-   WAS Listener Adapter (LA), which collaborates with WAS to activate processes in response to incoming messages.  \n  \n-   UDP Protocol Listener, which accepts UDP messages on behalf of applications that are to be activated.  \n  \n The activator must be running as a standalone program on the server machine. Normally, WAS listener adapters (such as the NetTcpActivator and the NetPipeActivator) are implemented in long-running Windows services. However, for simplicity and clarity, this sample implements the protocol activator as a standalone application.  \n  \n### WAS Listener Adapter  \n The WAS Listener Adapter for UDP is implemented in the `UdpListenerAdapter` class. It is the module that interacts with WAS to perform application activation for the UDP protocol. This is achieved by calling the following Webhost APIs:  \n  \n-   `WebhostRegisterProtocol`  \n  \n-   `WebhostUnregisterProtocol`  \n  \n-   `WebhostOpenListenerChannelInstance`  \n  \n-   `WebhostCloseAllListenerChannelInstances`  \n  \n After initially calling `WebhostRegisterProtocol`, the listener adapter receives the callback `ApplicationCreated` from WAS for all of the applications registered in applicationHost.config (located in %windir%\\system32\\inetsrv). In this sample, we only handle the applications with the UDP protocol (with the protocol id as \"net.udp\") enabled. Other implementations may handle this differently if such implementations respond to dynamic configuration changes to the application (for example, an application transition from disabled to enabled).  \n  \n When the callback `ConfigManagerInitializationCompleted` is received, it indicates that WAS has finished all of the notifications for the initialization of the protocol. At this time, the listener adapter is ready to process activation requests.  \n  \n When a new request comes in the first time for an application, the listener adapter calls `WebhostOpenListenerChannelInstance` into WAS, which starts the worker process if it is not started yet. Then the protocol handlers are loaded and the communication between the listener adapter and the virtual application can start.  \n  \n The listener adapter is registered in the %SystemRoot%\\System32\\inetsrv\\ApplicationHost.config in the <`listenerAdapters`> section as following:  \n  \n```xml  \n<add name=\"net.udp\" identity=\"S-1-5-21-2127521184-1604012920-1887927527-387045\" />  \n```  \n  \n### Protocol Listener  \n The UDP protocol listener is a module inside the protocol activator that listens at a UDP endpoint on behalf of the virtual application. It is implemented in the class `UdpSocketListener`. The endpoint is represented as `IPEndpoint` for which the port number is extracted from the binding of the protocol for the site.  \n  \n### Control Service  \n In this sample, we use WCF to communicate between the activator and the WAS worker process. The service that resides in the activator is called the Control Service.  \n  \n## Protocol Handlers  \n After the listener adapter calls `WebhostOpenListenerChannelInstance`, the WAS process manager starts the worker process if it is not started. The application manager inside the worker process then loads the UDP Process Protocol Handler (PPH) with the request for that `ListenerChannelId`. The PPH in turns calls `IAdphManager`.`StartAppDomainProtocolListenerChannel` to start the UDP AppDomain Protocol Handler (ADPH).  \n  \n## HostedUDPTransportConfiguration  \n The information is registered in the Web.config as follows:  \n  \n```xml  \n<serviceHostingEnvironment>  \n<add name=\"net.udp\" transportConfigurationType=\"Microsoft.ServiceModel.Samples.Hosting.HostedUdpTransportConfiguration, UdpActivation, Version=1.0.0.0, Culture=neutral, PublicKeyToken=6fa904d2da1848d6\" />  \n</serviceHostingEnvironment>  \n```  \n  \n## Special Setup for This Sample  \n This sample can be only built and run on Windows Vista, Windows Server 2008, or Windows 7. To run the sample, you must first get all of the components set up correctly. Use the following steps to install the sample.  \n  \n#### To set up this sample  \n  \n1.  Install [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] 4.0 using the following command.  \n  \n    ```  \n    %windir%\\Microsoft.NET\\Framework\\v4.0.XXXXX\\aspnet_regiis.exe /i /enable  \n    ```  \n  \n2.  Build the project on Windows Vista. After compilation, it also performs the following operations in the post-build phase:  \n  \n    -   Installs the UDP binding to the site \"Default Web Site\".  \n  \n    -   Creates the virtual application \"ServiceModelSamples\" to point to the physical path: \"%SystemDrive%\\inetpub\\wwwroot\\servicemodelsamples\".  \n  \n    -   It also enables \"net.udp\" protocol for this virtual application.  \n  \n3.  Start the user interface application \"WasNetActivator.exe\". Click the **Setup** tab, check the following check boxes and then click **Install** to install them:  \n  \n    -   UDP Listener Adapter  \n  \n    -   UDP Protocol Handlers  \n  \n4.  Click the **Activation** tab of the user interface application \"WasNetActivator.exe\". Click the **Start** button to start the listener adapter. Now you are ready to run the program.  \n  \n    > [!NOTE]\n    >  When you are finished with this sample, you must run Cleanup.bat to remove the net.udp binding from the \"Default Web Site\".  \n  \n## Sample Usage  \n After compilation, there are four different binaries generated:  \n  \n-   Client.exe: The client code. The App.config is compiled into the client configuration file Client.exe.config.  \n  \n-   UDPActivation.dll: the library that contains all of the major UDP implementations.  \n  \n-   Service.dll: The service code. This is copied to the \\bin directory of the virtual application ServiceModelSamples. The service file is Service.svc and the configuration file is Web.config. After compilation, they are copied to the following location: %SystemDrive%\\Inetpub\\wwwroot\\ServiceModelSamples.  \n  \n-   WasNetActivator: The UDP activator program.  \n  \n-   Ensure that all of the required pieces are installed correctly. The following steps show how to run the sample:  \n  \n1.  Ensure that the following Windows services have been started:  \n  \n    -   Windows Process Activation Service (WAS).  \n  \n    -   Internet Information Services (IIS): W3SVC.  \n  \n2.  Then start the activator, WasNetActivator.exe. Under the **Activation** tab, the only protocol, **UDP**, is selected in the drop down list. Click the **Start** button to start the activator.  \n  \n3.  Once the activator is started, you can run the client code by running Client.exe from a command window. The following is the sample output:  \n  \n    ```  \n    Testing Udp Activation.  \n    Start the status service.  \n    Sending UDP datagrams.  \n    Type a word that you want to say to the server: Hello, world!  \n        Sending datagram: Hello, world![0]  \n        Sending datagram: Hello, world![1]  \n        Sending datagram: Hello, world![2]  \n        Sending datagram: Hello, world![3]  \n        Sending datagram: Hello, world![4]  \n    Calling UDP duplex contract (ICalculatorContract).  \n        0 + 0 = 0  \n        1 + 2 = 3  \n        2 + 4 = 6  \n        3 + 6 = 9  \n        4 + 8 = 12  \n    Getting status and dump server traces:  \n        Operation 'Hello' is called: Hello, world![0]  \n        Operation 'Hello' is called: Hello, world![1]  \n        Operation 'Hello' is called: Hello, world![2]  \n        Operation 'Hello' is called: Hello, world![3]  \n        Operation 'Hello' is called: Hello, world![4]  \n        Operation 'Add' is called: 0 + 0  \n        Operation 'Add' is called: 1 + 2  \n        Operation 'Add' is called: 2 + 4  \n        Operation 'Add' is called: 3 + 6  \n        Operation 'Add' is called: 4 + 8  \n    Press <ENTER> to complete test.  \n    ```  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Extensibility\\Transport\\UdpActivation`  \n","nodes":[{"pos":[4,98],"embed":true,"restype":"x-metadata","content":"title: \"UDP Activation\"\nms.date: \"03/30/2017\"\nms.assetid: 4b0ccd10-0dfb-4603-93f9-f0857c581cb7","nodes":[{"content":"UDP Activation","nodes":[{"pos":[0,14],"content":"UDP Activation","nodes":[{"content":"UDP Activation","pos":[0,14]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[105,119],"content":"UDP Activation","linkify":"UDP Activation","nodes":[{"content":"UDP Activation","pos":[0,14]}]},{"content":"This sample is based on the <bpt id=\"p1\">[</bpt>Transport: UDP<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-udp.md)</ept> sample.","pos":[120,229],"source":"This sample is based on the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample."},{"content":"It extends the <bpt id=\"p1\">[</bpt>Transport: UDP<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-udp.md)</ept> sample to support process activation using the Windows Process Activation Service (WAS).","pos":[230,407],"source":" It extends the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample to support process activation using the Windows Process Activation Service (WAS)."},{"content":"The sample consists of three major pieces:","pos":[414,456]},{"content":"A UDP Protocol Activator, a standalone process that receives UDP messages on behalf of applications that are to be activated.","pos":[466,591]},{"content":"A client that uses the UDP custom transport to send messages.","pos":[601,662]},{"content":"A service (hosted in a worker process activated by WAS) that receives messages over the UDP custom transport.","pos":[672,781]},{"pos":[790,812],"content":"UDP Protocol Activator","linkify":"UDP Protocol Activator","nodes":[{"content":"UDP Protocol Activator","pos":[0,22]}]},{"content":"The UDP Protocol Activator is a bridge between the WCF client and the WCF service.","pos":[816,898]},{"content":"It provides data communication through the UDP protocol at the transport layer.","pos":[899,978]},{"content":"It has two major functions:","pos":[979,1006]},{"content":"WAS Listener Adapter (LA), which collaborates with WAS to activate processes in response to incoming messages.","pos":[1016,1126]},{"content":"UDP Protocol Listener, which accepts UDP messages on behalf of applications that are to be activated.","pos":[1136,1237]},{"content":"The activator must be running as a standalone program on the server machine.","pos":[1244,1320]},{"content":"Normally, WAS listener adapters (such as the NetTcpActivator and the NetPipeActivator) are implemented in long-running Windows services.","pos":[1321,1457]},{"content":"However, for simplicity and clarity, this sample implements the protocol activator as a standalone application.","pos":[1458,1569]},{"pos":[1579,1599],"content":"WAS Listener Adapter","linkify":"WAS Listener Adapter","nodes":[{"content":"WAS Listener Adapter","pos":[0,20]}]},{"content":"The WAS Listener Adapter for UDP is implemented in the <ph id=\"ph1\">`UdpListenerAdapter`</ph> class.","pos":[1603,1685],"source":"The WAS Listener Adapter for UDP is implemented in the `UdpListenerAdapter` class."},{"content":"It is the module that interacts with WAS to perform application activation for the UDP protocol.","pos":[1686,1782]},{"content":"This is achieved by calling the following Webhost APIs:","pos":[1783,1838]},{"content":"After initially calling <ph id=\"ph1\">`WebhostRegisterProtocol`</ph>, the listener adapter receives the callback <ph id=\"ph2\">`ApplicationCreated`</ph> from WAS for all of the applications registered in applicationHost.config (located in %windir%\\system32\\inetsrv).","pos":[2014,2242],"source":"After initially calling `WebhostRegisterProtocol`, the listener adapter receives the callback `ApplicationCreated` from WAS for all of the applications registered in applicationHost.config (located in %windir%\\system32\\inetsrv)."},{"content":"In this sample, we only handle the applications with the UDP protocol (with the protocol id as \"net.udp\") enabled.","pos":[2243,2357]},{"content":"Other implementations may handle this differently if such implementations respond to dynamic configuration changes to the application (for example, an application transition from disabled to enabled).","pos":[2358,2558]},{"content":"When the callback <ph id=\"ph1\">`ConfigManagerInitializationCompleted`</ph> is received, it indicates that WAS has finished all of the notifications for the initialization of the protocol.","pos":[2565,2734],"source":"When the callback `ConfigManagerInitializationCompleted` is received, it indicates that WAS has finished all of the notifications for the initialization of the protocol."},{"content":"At this time, the listener adapter is ready to process activation requests.","pos":[2735,2810]},{"content":"When a new request comes in the first time for an application, the listener adapter calls <ph id=\"ph1\">`WebhostOpenListenerChannelInstance`</ph> into WAS, which starts the worker process if it is not started yet.","pos":[2817,3011],"source":"When a new request comes in the first time for an application, the listener adapter calls `WebhostOpenListenerChannelInstance` into WAS, which starts the worker process if it is not started yet."},{"content":"Then the protocol handlers are loaded and the communication between the listener adapter and the virtual application can start.","pos":[3012,3139]},{"pos":[3146,3290],"content":"The listener adapter is registered in the %SystemRoot%\\System32\\inetsrv\\ApplicationHost.config in the &lt;<ph id=\"ph1\">`listenerAdapters`</ph>&gt; section as following:","source":"The listener adapter is registered in the %SystemRoot%\\System32\\inetsrv\\ApplicationHost.config in the <`listenerAdapters`> section as following:"},{"pos":[3403,3420],"content":"Protocol Listener","linkify":"Protocol Listener","nodes":[{"content":"Protocol Listener","pos":[0,17]}]},{"content":"The UDP protocol listener is a module inside the protocol activator that listens at a UDP endpoint on behalf of the virtual application.","pos":[3424,3560]},{"content":"It is implemented in the class <ph id=\"ph1\">`UdpSocketListener`</ph>.","pos":[3561,3612],"source":" It is implemented in the class `UdpSocketListener`."},{"content":"The endpoint is represented as <ph id=\"ph1\">`IPEndpoint`</ph> for which the port number is extracted from the binding of the protocol for the site.","pos":[3613,3742],"source":" The endpoint is represented as `IPEndpoint` for which the port number is extracted from the binding of the protocol for the site."},{"pos":[3752,3767],"content":"Control Service","linkify":"Control Service","nodes":[{"content":"Control Service","pos":[0,15]}]},{"content":"In this sample, we use WCF to communicate between the activator and the WAS worker process.","pos":[3771,3862]},{"content":"The service that resides in the activator is called the Control Service.","pos":[3863,3935]},{"pos":[3944,3961],"content":"Protocol Handlers","linkify":"Protocol Handlers","nodes":[{"content":"Protocol Handlers","pos":[0,17]}]},{"content":"After the listener adapter calls <ph id=\"ph1\">`WebhostOpenListenerChannelInstance`</ph>, the WAS process manager starts the worker process if it is not started.","pos":[3965,4107],"source":"After the listener adapter calls `WebhostOpenListenerChannelInstance`, the WAS process manager starts the worker process if it is not started."},{"content":"The application manager inside the worker process then loads the UDP Process Protocol Handler (PPH) with the request for that <ph id=\"ph1\">`ListenerChannelId`</ph>.","pos":[4108,4254],"source":" The application manager inside the worker process then loads the UDP Process Protocol Handler (PPH) with the request for that `ListenerChannelId`."},{"content":"The PPH in turns calls <ph id=\"ph1\">`IAdphManager`</ph>.<ph id=\"ph2\">`StartAppDomainProtocolListenerChannel`</ph>","pos":[4255,4332],"source":" The PPH in turns calls `IAdphManager`.`StartAppDomainProtocolListenerChannel`"},{"content":"to start the UDP AppDomain Protocol Handler (ADPH).","pos":[4333,4384]},{"pos":[4393,4424],"content":"HostedUDPTransportConfiguration","linkify":"HostedUDPTransportConfiguration","nodes":[{"content":"HostedUDPTransportConfiguration","pos":[0,31]}]},{"content":"The information is registered in the Web.config as follows:","pos":[4428,4487]},{"pos":[4782,4811],"content":"Special Setup for This Sample","linkify":"Special Setup for This Sample","nodes":[{"content":"Special Setup for This Sample","pos":[0,29]}]},{"content":"This sample can be only built and run on Windows Vista, Windows Server 2008, or Windows 7.","pos":[4815,4905]},{"content":"To run the sample, you must first get all of the components set up correctly.","pos":[4906,4983]},{"content":"Use the following steps to install the sample.","pos":[4984,5030]},{"pos":[5041,5062],"content":"To set up this sample","linkify":"To set up this sample","nodes":[{"content":"To set up this sample","pos":[0,21]}]},{"pos":[5072,5170],"content":"Install <ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> 4.0 using the following command.","source":"Install [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] 4.0 using the following command."},{"content":"Build the project on Windows Vista.","pos":[5282,5317]},{"content":"After compilation, it also performs the following operations in the post-build phase:","pos":[5318,5403]},{"content":"Installs the UDP binding to the site \"Default Web Site\".","pos":[5417,5473]},{"content":"Creates the virtual application \"ServiceModelSamples\" to point to the physical path: \"%SystemDrive%\\inetpub\\wwwroot\\servicemodelsamples\".","pos":[5487,5624]},{"content":"It also enables \"net.udp\" protocol for this virtual application.","pos":[5638,5702]},{"content":"Start the user interface application \"WasNetActivator.exe\".","pos":[5712,5771]},{"content":"Click the <bpt id=\"p1\">**</bpt>Setup<ept id=\"p1\">**</ept> tab, check the following check boxes and then click <bpt id=\"p2\">**</bpt>Install<ept id=\"p2\">**</ept> to install them:","pos":[5772,5872],"source":" Click the **Setup** tab, check the following check boxes and then click **Install** to install them:"},{"content":"UDP Listener Adapter","pos":[5886,5906]},{"content":"UDP Protocol Handlers","pos":[5920,5941]},{"content":"Click the <bpt id=\"p1\">**</bpt>Activation<ept id=\"p1\">**</ept> tab of the user interface application \"WasNetActivator.exe\".","pos":[5951,6036],"source":"Click the **Activation** tab of the user interface application \"WasNetActivator.exe\"."},{"content":"Click the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button to start the listener adapter.","pos":[6037,6094],"source":" Click the **Start** button to start the listener adapter."},{"content":"Now you are ready to run the program.","pos":[6095,6132]},{"pos":[6144,6282],"content":"[!NOTE]\nWhen you are finished with this sample, you must run Cleanup.bat to remove the net.udp binding from the \"Default Web Site\".","leadings":["","    >  "],"nodes":[{"content":"When you are finished with this sample, you must run Cleanup.bat to remove the net.udp binding from the \"Default Web Site\".","pos":[8,131]}]},{"pos":[6291,6303],"content":"Sample Usage","linkify":"Sample Usage","nodes":[{"content":"Sample Usage","pos":[0,12]}]},{"content":"After compilation, there are four different binaries generated:","pos":[6307,6370]},{"content":"Client.exe: The client code.","pos":[6380,6408]},{"content":"The App.config is compiled into the client configuration file Client.exe.config.","pos":[6409,6489]},{"content":"UDPActivation.dll: the library that contains all of the major UDP implementations.","pos":[6499,6581]},{"content":"Service.dll: The service code.","pos":[6591,6621]},{"content":"This is copied to the \\bin directory of the virtual application ServiceModelSamples.","pos":[6622,6706]},{"content":"The service file is Service.svc and the configuration file is Web.config. After compilation, they are copied to the following location: %SystemDrive%\\Inetpub\\wwwroot\\ServiceModelSamples.","pos":[6707,6893]},{"content":"WasNetActivator: The UDP activator program.","pos":[6903,6946]},{"content":"Ensure that all of the required pieces are installed correctly.","pos":[6956,7019]},{"content":"The following steps show how to run the sample:","pos":[7020,7067]},{"content":"Ensure that the following Windows services have been started:","pos":[7077,7138]},{"content":"Windows Process Activation Service (WAS).","pos":[7152,7193]},{"content":"Internet Information Services (IIS): W3SVC.","pos":[7207,7250]},{"content":"Then start the activator, WasNetActivator.exe.","pos":[7260,7306]},{"content":"Under the <bpt id=\"p1\">**</bpt>Activation<ept id=\"p1\">**</ept> tab, the only protocol, <bpt id=\"p2\">**</bpt>UDP<ept id=\"p2\">**</ept>, is selected in the drop down list.","pos":[7307,7399],"source":" Under the **Activation** tab, the only protocol, **UDP**, is selected in the drop down list."},{"content":"Click the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button to start the activator.","pos":[7400,7450],"source":" Click the **Start** button to start the activator."},{"content":"Once the activator is started, you can run the client code by running Client.exe from a command window.","pos":[7460,7563]},{"content":"The following is the sample output:","pos":[7564,7599]},{"pos":[8750,8882],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[8936,9246],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[9247,9297]}]}