{"content":"---\ntitle: \"Using the InvokePowerShell Activity | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 956251a0-31ca-4183-bf76-d277c08585df\ncaps.latest.revision: 10\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Using the InvokePowerShell Activity\nThe InvokePowerShell sample demonstrates how to invoke Windows PowerShell commands using the `InvokePowerShell` activity.  \n  \n## Demonstrates  \n  \n-   Simple innovation of Windows PowerShell commands.  \n  \n-   Retrieve values from the Windows PowerShell output pipeline and store them in workflow variables.  \n  \n-   Pass data into windows PowerShell as input pipeline for an executing command.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WF\\Scenario\\ActivityLibrary\\PowerShell`  \n  \n## Discussion  \n This sample contains the following three projects.  \n  \n|Project Name|Description|Main Files|  \n|------------------|-----------------|----------------|  \n|CodedClient|A sample client application that uses the PowerShell activity.|-   **Program.cs**: Programmatically creates a sequence-based workflow that calls the InvokePowerShell activity.|  \n|DesignerClient|A set of custom activities that contain the `InvokePowerShell` custom activity and other miscellaneous custom activities, and a workflow that uses them.|<ul><li>Activities:<br /><br /> <ul><li>**PrintCollection.cs**: A helper activity that prints all the items in a collection to the console.</li><li>**ReadLine.cs**: A helper activity for reading input from the console.</li></ul></li><li>File System:<br /><br /> <ul><li>**Copy.xaml**: An activity that copies a file.</li><li>**CreateFile.xaml**: An activity that creates a file.</li><li>**DeleteFile.xaml**: An activity that deletes a file.</li><li>**MakeDir.xaml**: An activity that creates a directory.</li><li>**Move.xaml**: An activity that moves a file.</li><li>**ReadFile.xaml**: An activity that reads a file and returns its contents.</li><li>**TestPath.xaml**: An activity that tests for the existence of a path.</li></ul></li><li>Process:<br /><br /> <ul><li>**GetProcess.xaml**: An activity that gets a list of running processes.</li><li>**StopProcess.xaml**: An activity that stops a specific process.</li></ul></li><li>**Program.cs**: Calls the Sequence1 workflow.</li><li>**Sequence1.xaml**: A sequence-based workflow.</li></ul>|  \n|PowerShell|The `InvokePowerShell` activity and its associated designers.|Activity Files<br /><br /> -   **ExecutePowerShell.cs**: The main execution logic of the activity.<br />-   **InvokePowerShell.cs**: The wrapper around the main execution logic, which contains a generic (return value) version and a non-generic (non-return value) version. This is the public interface for the activity.<br />-   **NoPersistZone.cs**: This activity prevents any child activities from persisting. This class is used within the `InvokePowerShell` activity implementation to prevent the activity from being persisted mid-execution.<br /><br /> Designer files:<br /><br /> 1.  **ArgumentDictionaryEditor.cs**: A Windows dialog that allows the user to edit the arguments of the `InvokePowerShell` activity.<br />2.  **GenericInvokePowerShellDesigner.xaml** and **GenericInvokePowerShellDesigner.xaml.cs**: Defines the appearance of the generic `InvokePowerShell` activity in [!INCLUDE[wfd2](../../../../includes/wfd2-md.md)].<br />3.  **InvokePowerShellDesigner.xaml** and **InvokePowerShellDesigner.cs**: Defines the appearance of the non-generic `InvokePowerShell` activity in [!INCLUDE[wfd2](../../../../includes/wfd2-md.md)].|  \n  \n The client projects are discussed first, as it is easier to understand the internal functionality of the PowerShell activity once its use is understood.  \n  \n## Using This Sample  \n The following sections describe how to use the three projects in the sample.  \n  \n### Using the Coded Client Project  \n The sample client programmatically creates a sequence activity, which contains examples of several different methods of using the `InvokePowerShell` activity. The first invocation launches Notepad.  \n  \n```  \nnew InvokePowerShell()  \n{  \n    CommandText = \"notepad\"  \n},  \n  \n```  \n  \n The second invocation gets a list of the processes running on the local machine.  \n  \n```  \nnew InvokePowerShell<Process>()  \n{  \n    CommandText = \"Get-Process\",  \n    Output = processes1,  \n},  \n  \n```  \n  \n `Output` is the variable used to store the output of the command.  \n  \n The next call demonstrates how to run a post-processing step on each individual output of the PowerShell invocation. `InitializationAction` is set to the function that outputs a string representation for each process. The collection of these strings is returned in the `Output` variable by the `InvokePowerShell<string>` activity.  \n  \n The succeeding `InvokePowerShell` calls demonstrate passing data into the activity and getting outputs and errors out.  \n  \n### Using the Designer Client Project  \n The DesignerClient project consists of a set of custom activities, almost all of which are built containing the `InvokePowerShell` activity. Most of the activities call the non-generic version of the `InvokePowerShell` activity, and do not expect a return value. Other activities use the generic version of the `InvokePowerShell` activity, and use the `InitializationAction` argument to post-process the results.  \n  \n## Using the PowerShell Project  \n The main action of the activity takes place in the `ExecutePowerShell` class. Because the execution of PowerShell commands should not block the main workflow thread, the activity is created to be an asynchronous activity by inheriting from the <xref:System.Activities.AsyncCodeActivity> class.  \n  \n The <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> method is called by the workflow runtime to begin running the activity. It starts by calling PowerShell APIs to create a PowerShell pipeline.  \n  \n```  \nrunspace = RunspaceFactory.CreateRunspace();  \nrunspace.Open();  \npipeline = runspace.CreatePipeline();  \n  \n```  \n  \n It then creates a PowerShell command and populates it with parameters and variables.  \n  \n```  \nCommand cmd = new Command(this.CommandText, this.IsScript);   \n// loop over parameters and run: cmd.Parameters.Add(...)  \n// loop over variables and run: runspace.SessionStateProxy.SetVariable(...)  \npipeline.Commands.Add(cmd);  \n  \n```  \n  \n The inputs piped in are also sent to the pipeline at this point. Finally, the pipeline is wrapped in a `PipelineInvokerAsyncResult` object and returned. The `PipelineInvokerAsyncResult` object registers a listener and invokes the pipeline.  \n  \n```  \npipeline.InvokeAsync();  \n  \n```  \n  \n When execution finishes, output and errors are stored within the same `PipelineInvokerAsyncResult` object, and control is handed back to the workflow runtime by calling the callback method originally passed to <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.  \n  \n At the end of the method's execution, the workflow runtime calls the activity’s <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> method.  \n  \n The `InvokePowerShell` class wraps the `ExecutePowerShellCommand` class and creates two versions of the activity; a generic version and a non-generic version. The non-generic version returns the output of the PowerShell execution directly, whereas the generic version transforms the individual results to the generic type.  \n  \n The generic version of the activity is implemented as a sequential workflow that calls `ExecutePowerShellCommand` and post-processes its results. For each element in the result collection, the post-processing step calls `InitializationAction` if it is set. Otherwise, it does a simple cast.  \n  \n```  \nnew ForEach<PSObject>  \n{  \n    Values = psObjects,  \n    Body = new ActivityAction<PSObject>  \n    {  \n        Argument = psObject,  \n        Handler = new Sequence  \n        {  \n            Activities =  \n            {  \n                new If  \n                {  \n                    Condition = // Is InitializationAction set?  \n                    Then = new InvokeFunc<PSObject, TResult>  \n                    {  \n                        Argument = psObject,  \n                        Result = outputObject,  \n                        Func = this.InitializationAction  \n                    },  \n                    Else = new Assign<TResult>  \n                    {  \n                        To = outputObject,  \n                        Value = new InArgument<TResult>(ctx => (TResult) psObject.Get(ctx).BaseObject),  \n                    }  \n                },  \n                new AddToCollection<TResult>  \n                {  \n                    Collection = outputObjects,  \n                    Item = outputObject  \n                },  \n            }  \n        }  \n    }  \n},  \n  \n```  \n  \n For each of the two `InvokePowerShell` activities (generic, and non-generic), a designer was created. InvokePowerShellDesigner.xaml and its associated .cs file define the appearance in [!INCLUDE[wfd2](../../../../includes/wfd2-md.md)] for the non-generic version of the `InvokePowerShell` activity. Inside InvokePowerShellDesigner.xaml, a <xref:System.Windows.Controls.DockPanel> is used to represent the graphical interface.  \n  \n```  \n<DockPanel x:Uid=\"DockPanel_1\" LastChildFill=\"True\">  \n        <TextBlock x:Uid=\"TextBlock_1\" Text=\"CommandText\" />  \n        <TextBox x:Uid=\"TextBox_1\" Text=\"{Binding Path=ModelItem.CommandText, Mode=TwoWay}\"  \n                 TextWrapping=\"WrapWithOverflow\"  AcceptsReturn=\"True\" MinLines=\"4\" MaxLines=\"4\"  \n                 Background=\"{x:Null}\" Margin=\"3\" />  \n    </DockPanel>  \n  \n```  \n  \n Note that the `Text` property of the text box is a two-way binding that ensures that the value of the activity’s `CommandText` property is equivalent to the value input into the designer.  \n  \n GenericInvokePowerShellDesigner.xaml and its associated .cs file define the graphical interface for the generic `InvokePowerShell` activity. The designer is slightly more complicated because it allows users to set an `InitializationAction`. The key element is the usage of <xref:System.Activities.Presentation.WorkflowItemPresenter> to allow drag and drop of child activities onto the `InvokePowerShell` designer surface.  \n  \n```  \n<sap:WorkflowItemPresenter x:Uid=\"sap:WorkflowItemPresenter_1\" Margin=\"0,10,0,10\"  \n    HintText=\"Drop Activities Here\"  \n    AllowedItemType=\"{x:Type sa:Activity}\"  \n    Item=\"{Binding Path=ModelItem.InitializationAction.Handler, Mode=TwoWay}\"  \n    Grid.Row=\"1\" Grid.Column=\"1\" />  \n  \n```  \n  \n The designer customization does not stop with the .xaml files that define the appearance of the activity on the design canvas. The dialog boxes used to display the parameters of the activity can also be customized. These parameters and PowerShell variables affect the behavior of PowerShell commands. The activity exposes them as <!--zz <xref:System.Collections.Generic.Dictionary%601>--> `System.Collections.Generic.Dictionary` types. ArgumentDictionaryEditor.cs, PropertyEditorResources.xaml and PropertyEditorResources.cs define the dialog box that allows you to edit these types.  \n  \n## To set up, build, and run the sample  \n You must install Windows PowerShell to run this sample. Windows PowerShell can be installed from this location: [Windows PowerShell](http://go.microsoft.com/fwlink/?LinkId=150383).  \n  \n#### To run the coded client  \n  \n1.  Open PowerShell.sln using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)].  \n  \n2.  Right-click the solution and build it.  \n  \n3.  Right-click the **CodedClient** project and select **Set as Startup Project**.  \n  \n4.  Press CTRL+F5 to run the application.  \n  \n#### To run the designer client  \n  \n1.  Open PowerShell.sln using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)].  \n  \n2.  Right-click the solution and build it.  \n  \n3.  Right-click the **DesignerClient** project and select **Set as Startup Project**.  \n  \n4.  Press CTRL+F5 to run the application.  \n  \n## Known Issues  \n  \n1.  If referencing the `InvokePowerShell` activity assembly or project from another project results in a build error, you may need to manually add the `<SpecificVersion>True</SpecificVersion>` element to the .csproj file of the new project under the line that references `InvokePowerShell`.  \n  \n2.  If Windows PowerShell is not installed, the following error message is displayed in Visual Studio as soon as you add an `InvokePowerShell` activity onto a workflow: `Workflow Designer encountered problems with your document. Could not load file or assembly ‘System.Management.Automation’ ... or one of its dependencies. The system cannot find the file specified.`  \n  \n3.  In Windows PowerShell 2.0, programmatically calling `$input.MoveNext()` fails and scripts using `$input.MoveNext()` produce unintended errors and results. To work around this issue, consider using the PowerShell verb `foreach` instead of calling `MoveNext()` when iterating an array.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WF\\Scenario\\ActivityLibrary\\PowerShell`  \n  \n## See Also","nodes":[{"pos":[12,64],"content":"Using the InvokePowerShell Activity | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Using the InvokePowerShell Activity | Microsoft Docs","pos":[0,52]}]},{"pos":[330,365],"content":"Using the InvokePowerShell Activity","linkify":"Using the InvokePowerShell Activity","nodes":[{"content":"Using the InvokePowerShell Activity","pos":[0,35]}]},{"pos":[366,487],"content":"The InvokePowerShell sample demonstrates how to invoke Windows PowerShell commands using the <ph id=\"ph1\">`InvokePowerShell`</ph> activity.","source":"The InvokePowerShell sample demonstrates how to invoke Windows PowerShell commands using the `InvokePowerShell` activity."},{"pos":[496,508],"content":"Demonstrates","linkify":"Demonstrates","nodes":[{"content":"Demonstrates","pos":[0,12]}]},{"content":"Simple innovation of Windows PowerShell commands.","pos":[518,567]},{"content":"Retrieve values from the Windows PowerShell output pipeline and store them in workflow variables.","pos":[577,674]},{"content":"Pass data into windows PowerShell as input pipeline for an executing command.","pos":[684,761]},{"pos":[769,901],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":" The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[13,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[1,54]},{"content":"Check for the following (default) directory before continuing.","pos":[55,117]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[955,1281],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[1282,1332]},{"pos":[1423,1433],"content":"Discussion","linkify":"Discussion","nodes":[{"content":"Discussion","pos":[0,10]}]},{"content":"This sample contains the following three projects.","pos":[1437,1487]},{"content":"Project Name","pos":[1494,1506]},{"content":"Description","pos":[1507,1518]},{"content":"Main Files","pos":[1519,1529]},{"content":"CodedClient","pos":[1592,1603]},{"content":"A sample client application that uses the PowerShell activity.","pos":[1604,1666]},{"pos":[1667,1779],"content":"<ph id=\"ph1\">-   </ph><bpt id=\"p1\">**</bpt>Program.cs<ept id=\"p1\">**</ept>: Programmatically creates a sequence-based workflow that calls the InvokePowerShell activity.","source":"-   **Program.cs**: Programmatically creates a sequence-based workflow that calls the InvokePowerShell activity."},{"content":"DesignerClient","pos":[1784,1798]},{"pos":[1799,1951],"content":"A set of custom activities that contain the <ph id=\"ph1\">`InvokePowerShell`</ph> custom activity and other miscellaneous custom activities, and a workflow that uses them.","source":"A set of custom activities that contain the `InvokePowerShell` custom activity and other miscellaneous custom activities, and a workflow that uses them."},{"content":"Activities:","pos":[1960,1971]},{"content":"<bpt id=\"p1\">**</bpt>PrintCollection.cs<ept id=\"p1\">**</ept>: A helper activity that prints all the items in a collection to the console.","pos":[1992,2091],"source":"**PrintCollection.cs**: A helper activity that prints all the items in a collection to the console."},{"content":"<bpt id=\"p1\">**</bpt>ReadLine.cs<ept id=\"p1\">**</ept>: A helper activity for reading input from the console.","pos":[2100,2170],"source":"**ReadLine.cs**: A helper activity for reading input from the console."},{"content":"File System:","pos":[2189,2201]},{"content":"<bpt id=\"p1\">**</bpt>Copy.xaml<ept id=\"p1\">**</ept>: An activity that copies a file.","pos":[2222,2268],"source":"**Copy.xaml**: An activity that copies a file."},{"content":"<bpt id=\"p1\">**</bpt>CreateFile.xaml<ept id=\"p1\">**</ept>: An activity that creates a file.","pos":[2277,2330],"source":"**CreateFile.xaml**: An activity that creates a file."},{"content":"<bpt id=\"p1\">**</bpt>DeleteFile.xaml<ept id=\"p1\">**</ept>: An activity that deletes a file.","pos":[2339,2392],"source":"**DeleteFile.xaml**: An activity that deletes a file."},{"content":"<bpt id=\"p1\">**</bpt>MakeDir.xaml<ept id=\"p1\">**</ept>: An activity that creates a directory.","pos":[2401,2456],"source":"**MakeDir.xaml**: An activity that creates a directory."},{"content":"<bpt id=\"p1\">**</bpt>Move.xaml<ept id=\"p1\">**</ept>: An activity that moves a file.","pos":[2465,2510],"source":"**Move.xaml**: An activity that moves a file."},{"content":"<bpt id=\"p1\">**</bpt>ReadFile.xaml<ept id=\"p1\">**</ept>: An activity that reads a file and returns its contents.","pos":[2519,2593],"source":"**ReadFile.xaml**: An activity that reads a file and returns its contents."},{"content":"<bpt id=\"p1\">**</bpt>TestPath.xaml<ept id=\"p1\">**</ept>: An activity that tests for the existence of a path.","pos":[2602,2672],"source":"**TestPath.xaml**: An activity that tests for the existence of a path."},{"content":"Process:","pos":[2691,2699]},{"content":"<bpt id=\"p1\">**</bpt>GetProcess.xaml<ept id=\"p1\">**</ept>: An activity that gets a list of running processes.","pos":[2720,2791],"source":"**GetProcess.xaml**: An activity that gets a list of running processes."},{"content":"<bpt id=\"p1\">**</bpt>StopProcess.xaml<ept id=\"p1\">**</ept>: An activity that stops a specific process.","pos":[2800,2864],"source":"**StopProcess.xaml**: An activity that stops a specific process."},{"content":"<bpt id=\"p1\">**</bpt>Program.cs<ept id=\"p1\">**</ept>: Calls the Sequence1 workflow.","pos":[2883,2928],"source":"**Program.cs**: Calls the Sequence1 workflow."},{"content":"<bpt id=\"p1\">**</bpt>Sequence1.xaml<ept id=\"p1\">**</ept>: A sequence-based workflow.","pos":[2937,2983],"source":"**Sequence1.xaml**: A sequence-based workflow."},{"content":"PowerShell","pos":[2998,3008]},{"pos":[3009,3070],"content":"The <ph id=\"ph1\">`InvokePowerShell`</ph> activity and its associated designers.","source":"The `InvokePowerShell` activity and its associated designers."},{"content":"Activity Files","pos":[3071,3085]},{"content":"<ph id=\"ph1\"> -   </ph><bpt id=\"p1\">**</bpt>ExecutePowerShell.cs<ept id=\"p1\">**</ept>: The main execution logic of the activity.","pos":[3097,3169],"source":" -   **ExecutePowerShell.cs**: The main execution logic of the activity."},{"content":"<ph id=\"ph1\">-   </ph><bpt id=\"p1\">**</bpt>InvokePowerShell.cs<ept id=\"p1\">**</ept>: The wrapper around the main execution logic, which contains a generic (return value) version and a non-generic (non-return value) version.","pos":[3175,3342],"source":"-   **InvokePowerShell.cs**: The wrapper around the main execution logic, which contains a generic (return value) version and a non-generic (non-return value) version."},{"content":"This is the public interface for the activity.","pos":[3343,3389]},{"content":"<ph id=\"ph1\">-   </ph><bpt id=\"p1\">**</bpt>NoPersistZone.cs<ept id=\"p1\">**</ept>: This activity prevents any child activities from persisting.","pos":[3395,3481],"source":"-   **NoPersistZone.cs**: This activity prevents any child activities from persisting."},{"content":"This class is used within the <ph id=\"ph1\">`InvokePowerShell`</ph> activity implementation to prevent the activity from being persisted mid-execution.","pos":[3482,3614],"source":" This class is used within the `InvokePowerShell` activity implementation to prevent the activity from being persisted mid-execution."},{"content":"Designer files:","pos":[3627,3642]},{"content":"1.  <bpt id=\"p1\">**</bpt>ArgumentDictionaryEditor.cs<ept id=\"p1\">**</ept>: A Windows dialog that allows the user to edit the arguments of the <ph id=\"ph1\">`InvokePowerShell`</ph> activity.","pos":[3655,3787],"source":" 1.  **ArgumentDictionaryEditor.cs**: A Windows dialog that allows the user to edit the arguments of the `InvokePowerShell` activity."},{"content":"2.  <bpt id=\"p1\">**</bpt>GenericInvokePowerShellDesigner.xaml<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>GenericInvokePowerShellDesigner.xaml.cs<ept id=\"p2\">**</ept>: Defines the appearance of the generic <ph id=\"ph1\">`InvokePowerShell`</ph> activity in <ph id=\"ph2\">[!INCLUDE[wfd2](../../../../includes/wfd2-md.md)]</ph>.","pos":[3793,4006],"source":"2.  **GenericInvokePowerShellDesigner.xaml** and **GenericInvokePowerShellDesigner.xaml.cs**: Defines the appearance of the generic `InvokePowerShell` activity in [!INCLUDE[wfd2](../../../../includes/wfd2-md.md)]."},{"content":"3.  <bpt id=\"p1\">**</bpt>InvokePowerShellDesigner.xaml<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>InvokePowerShellDesigner.cs<ept id=\"p2\">**</ept>: Defines the appearance of the non-generic <ph id=\"ph1\">`InvokePowerShell`</ph> activity in <ph id=\"ph2\">[!INCLUDE[wfd2](../../../../includes/wfd2-md.md)]</ph>.","pos":[4012,4210],"source":"3.  **InvokePowerShellDesigner.xaml** and **InvokePowerShellDesigner.cs**: Defines the appearance of the non-generic `InvokePowerShell` activity in [!INCLUDE[wfd2](../../../../includes/wfd2-md.md)]."},{"content":"The client projects are discussed first, as it is easier to understand the internal functionality of the PowerShell activity once its use is understood.","pos":[4218,4370]},{"pos":[4379,4396],"content":"Using This Sample","linkify":"Using This Sample","nodes":[{"content":"Using This Sample","pos":[0,17]}]},{"content":"The following sections describe how to use the three projects in the sample.","pos":[4400,4476]},{"pos":[4486,4516],"content":"Using the Coded Client Project","linkify":"Using the Coded Client Project","nodes":[{"content":"Using the Coded Client Project","pos":[0,30]}]},{"content":"The sample client programmatically creates a sequence activity, which contains examples of several different methods of using the <ph id=\"ph1\">`InvokePowerShell`</ph> activity.","pos":[4520,4678],"source":"The sample client programmatically creates a sequence activity, which contains examples of several different methods of using the `InvokePowerShell` activity."},{"content":"The first invocation launches Notepad.","pos":[4679,4717]},{"content":"The second invocation gets a list of the processes running on the local machine.","pos":[4806,4886]},{"pos":[5016,5081],"content":"<ph id=\"ph1\">`Output`</ph> is the variable used to store the output of the command.","source":"`Output` is the variable used to store the output of the command."},{"content":"The next call demonstrates how to run a post-processing step on each individual output of the PowerShell invocation.","pos":[5088,5204]},{"content":"<ph id=\"ph1\">`InitializationAction`</ph> is set to the function that outputs a string representation for each process.","pos":[5205,5305],"source":"`InitializationAction` is set to the function that outputs a string representation for each process."},{"content":"The collection of these strings is returned in the <ph id=\"ph1\">`Output`</ph> variable by the <ph id=\"ph2\">`InvokePowerShell&lt;string&gt;`</ph> activity.","pos":[5306,5418],"source":" The collection of these strings is returned in the `Output` variable by the `InvokePowerShell<string>` activity."},{"pos":[5425,5543],"content":"The succeeding <ph id=\"ph1\">`InvokePowerShell`</ph> calls demonstrate passing data into the activity and getting outputs and errors out.","source":"The succeeding `InvokePowerShell` calls demonstrate passing data into the activity and getting outputs and errors out."},{"pos":[5553,5586],"content":"Using the Designer Client Project","linkify":"Using the Designer Client Project","nodes":[{"content":"Using the Designer Client Project","pos":[0,33]}]},{"content":"The DesignerClient project consists of a set of custom activities, almost all of which are built containing the <ph id=\"ph1\">`InvokePowerShell`</ph> activity.","pos":[5590,5730],"source":"The DesignerClient project consists of a set of custom activities, almost all of which are built containing the `InvokePowerShell` activity."},{"content":"Most of the activities call the non-generic version of the <ph id=\"ph1\">`InvokePowerShell`</ph> activity, and do not expect a return value.","pos":[5731,5852],"source":" Most of the activities call the non-generic version of the `InvokePowerShell` activity, and do not expect a return value."},{"content":"Other activities use the generic version of the <ph id=\"ph1\">`InvokePowerShell`</ph> activity, and use the <ph id=\"ph2\">`InitializationAction`</ph> argument to post-process the results.","pos":[5853,6002],"source":" Other activities use the generic version of the `InvokePowerShell` activity, and use the `InitializationAction` argument to post-process the results."},{"pos":[6011,6039],"content":"Using the PowerShell Project","linkify":"Using the PowerShell Project","nodes":[{"content":"Using the PowerShell Project","pos":[0,28]}]},{"content":"The main action of the activity takes place in the <ph id=\"ph1\">`ExecutePowerShell`</ph> class.","pos":[6043,6120],"source":"The main action of the activity takes place in the `ExecutePowerShell` class."},{"content":"Because the execution of PowerShell commands should not block the main workflow thread, the activity is created to be an asynchronous activity by inheriting from the <ph id=\"ph1\">&lt;xref:System.Activities.AsyncCodeActivity&gt;</ph> class.","pos":[6121,6336],"source":" Because the execution of PowerShell commands should not block the main workflow thread, the activity is created to be an asynchronous activity by inheriting from the <xref:System.Activities.AsyncCodeActivity> class."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.AsyncCodeActivity.BeginExecute%2A&gt;</ph> method is called by the workflow runtime to begin running the activity.","pos":[6343,6477],"source":"The <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> method is called by the workflow runtime to begin running the activity."},{"content":"It starts by calling PowerShell APIs to create a PowerShell pipeline.","pos":[6478,6547]},{"content":"It then creates a PowerShell command and populates it with parameters and variables.","pos":[6678,6762]},{"content":"The inputs piped in are also sent to the pipeline at this point.","pos":[7017,7081]},{"content":"Finally, the pipeline is wrapped in a <ph id=\"ph1\">`PipelineInvokerAsyncResult`</ph> object and returned.","pos":[7082,7169],"source":" Finally, the pipeline is wrapped in a `PipelineInvokerAsyncResult` object and returned."},{"content":"The <ph id=\"ph1\">`PipelineInvokerAsyncResult`</ph> object registers a listener and invokes the pipeline.","pos":[7170,7256],"source":" The `PipelineInvokerAsyncResult` object registers a listener and invokes the pipeline."},{"pos":[7307,7576],"content":"When execution finishes, output and errors are stored within the same <ph id=\"ph1\">`PipelineInvokerAsyncResult`</ph> object, and control is handed back to the workflow runtime by calling the callback method originally passed to <ph id=\"ph2\">&lt;xref:System.Activities.AsyncCodeActivity.BeginExecute%2A&gt;</ph>.","source":"When execution finishes, output and errors are stored within the same `PipelineInvokerAsyncResult` object, and control is handed back to the workflow runtime by calling the callback method originally passed to <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>."},{"content":"At the end of the method's execution, the workflow runtime calls the activity’s <ph id=\"ph1\">&lt;xref:System.Activities.AsyncCodeActivity.EndExecute%2A&gt;</ph> method.","pos":[7583,7727],"source":"At the end of the method's execution, the workflow runtime calls the activity’s <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> method."},{"content":"The <ph id=\"ph1\">`InvokePowerShell`</ph> class wraps the <ph id=\"ph2\">`ExecutePowerShellCommand`</ph> class and creates two versions of the activity; a generic version and a non-generic version.","pos":[7734,7892],"source":"The `InvokePowerShell` class wraps the `ExecutePowerShellCommand` class and creates two versions of the activity; a generic version and a non-generic version."},{"content":"The non-generic version returns the output of the PowerShell execution directly, whereas the generic version transforms the individual results to the generic type.","pos":[7893,8056]},{"content":"The generic version of the activity is implemented as a sequential workflow that calls <ph id=\"ph1\">`ExecutePowerShellCommand`</ph> and post-processes its results.","pos":[8063,8208],"source":"The generic version of the activity is implemented as a sequential workflow that calls `ExecutePowerShellCommand` and post-processes its results."},{"content":"For each element in the result collection, the post-processing step calls <ph id=\"ph1\">`InitializationAction`</ph> if it is set.","pos":[8209,8319],"source":" For each element in the result collection, the post-processing step calls `InitializationAction` if it is set."},{"content":"Otherwise, it does a simple cast.","pos":[8320,8353]},{"content":"For each of the two <ph id=\"ph1\">`InvokePowerShell`</ph> activities (generic, and non-generic), a designer was created.","pos":[9469,9570],"source":"For each of the two `InvokePowerShell` activities (generic, and non-generic), a designer was created."},{"content":"InvokePowerShellDesigner.xaml and its associated .cs file define the appearance in <ph id=\"ph1\">[!INCLUDE[wfd2](../../../../includes/wfd2-md.md)]</ph> for the non-generic version of the <ph id=\"ph2\">`InvokePowerShell`</ph> activity.","pos":[9571,9767],"source":" InvokePowerShellDesigner.xaml and its associated .cs file define the appearance in [!INCLUDE[wfd2](../../../../includes/wfd2-md.md)] for the non-generic version of the `InvokePowerShell` activity."},{"content":"Inside InvokePowerShellDesigner.xaml, a <ph id=\"ph1\">&lt;xref:System.Windows.Controls.DockPanel&gt;</ph> is used to represent the graphical interface.","pos":[9768,9894],"source":" Inside InvokePowerShellDesigner.xaml, a <xref:System.Windows.Controls.DockPanel> is used to represent the graphical interface."},{"pos":[10304,10491],"content":"Note that the <ph id=\"ph1\">`Text`</ph> property of the text box is a two-way binding that ensures that the value of the activity’s <ph id=\"ph2\">`CommandText`</ph> property is equivalent to the value input into the designer.","source":"Note that the `Text` property of the text box is a two-way binding that ensures that the value of the activity’s `CommandText` property is equivalent to the value input into the designer."},{"content":"GenericInvokePowerShellDesigner.xaml and its associated .cs file define the graphical interface for the generic <ph id=\"ph1\">`InvokePowerShell`</ph> activity.","pos":[10498,10638],"source":"GenericInvokePowerShellDesigner.xaml and its associated .cs file define the graphical interface for the generic `InvokePowerShell` activity."},{"content":"The designer is slightly more complicated because it allows users to set an <ph id=\"ph1\">`InitializationAction`</ph>.","pos":[10639,10738],"source":" The designer is slightly more complicated because it allows users to set an `InitializationAction`."},{"content":"The key element is the usage of <ph id=\"ph1\">&lt;xref:System.Activities.Presentation.WorkflowItemPresenter&gt;</ph> to allow drag and drop of child activities onto the <ph id=\"ph2\">`InvokePowerShell`</ph> designer surface.","pos":[10739,10919],"source":" The key element is the usage of <xref:System.Activities.Presentation.WorkflowItemPresenter> to allow drag and drop of child activities onto the `InvokePowerShell` designer surface."},{"content":"The designer customization does not stop with the .xaml files that define the appearance of the activity on the design canvas.","pos":[11229,11355]},{"content":"The dialog boxes used to display the parameters of the activity can also be customized.","pos":[11356,11443]},{"content":"These parameters and PowerShell variables affect the behavior of PowerShell commands.","pos":[11444,11529]},{"content":"The activity exposes them as <ph id=\"ph1\">&lt;!--zz &lt;xref:System.Collections.Generic.Dictionary%601&gt;--&gt;</ph> <ph id=\"ph2\">`System.Collections.Generic.Dictionary`</ph> types.","pos":[11530,11664],"source":" The activity exposes them as <!--zz <xref:System.Collections.Generic.Dictionary%601>--> `System.Collections.Generic.Dictionary` types."},{"content":"ArgumentDictionaryEditor.cs, PropertyEditorResources.xaml and PropertyEditorResources.cs define the dialog box that allows you to edit these types.","pos":[11665,11812]},{"pos":[11821,11857],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"content":"You must install Windows PowerShell to run this sample.","pos":[11861,11916]},{"content":"Windows PowerShell can be installed from this location: <bpt id=\"p1\">[</bpt>Windows PowerShell<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150383)</ept>.","pos":[11917,12041],"source":" Windows PowerShell can be installed from this location: [Windows PowerShell](http://go.microsoft.com/fwlink/?LinkId=150383)."},{"pos":[12052,12075],"content":"To run the coded client","linkify":"To run the coded client","nodes":[{"content":"To run the coded client","pos":[0,23]}]},{"pos":[12085,12165],"content":"Open PowerShell.sln using <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph>.","source":"Open PowerShell.sln using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]."},{"content":"Right-click the solution and build it.","pos":[12175,12213]},{"pos":[12223,12301],"content":"Right-click the <bpt id=\"p1\">**</bpt>CodedClient<ept id=\"p1\">**</ept> project and select <bpt id=\"p2\">**</bpt>Set as Startup Project<ept id=\"p2\">**</ept>.","source":"Right-click the **CodedClient** project and select **Set as Startup Project**."},{"content":"Press CTRL+F5 to run the application.","pos":[12311,12348]},{"pos":[12359,12385],"content":"To run the designer client","linkify":"To run the designer client","nodes":[{"content":"To run the designer client","pos":[0,26]}]},{"pos":[12395,12475],"content":"Open PowerShell.sln using <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph>.","source":"Open PowerShell.sln using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]."},{"content":"Right-click the solution and build it.","pos":[12485,12523]},{"pos":[12533,12614],"content":"Right-click the <bpt id=\"p1\">**</bpt>DesignerClient<ept id=\"p1\">**</ept> project and select <bpt id=\"p2\">**</bpt>Set as Startup Project<ept id=\"p2\">**</ept>.","source":"Right-click the **DesignerClient** project and select **Set as Startup Project**."},{"content":"Press CTRL+F5 to run the application.","pos":[12624,12661]},{"pos":[12670,12682],"content":"Known Issues","linkify":"Known Issues","nodes":[{"content":"Known Issues","pos":[0,12]}]},{"pos":[12692,12978],"content":"If referencing the <ph id=\"ph1\">`InvokePowerShell`</ph> activity assembly or project from another project results in a build error, you may need to manually add the <ph id=\"ph2\">`&lt;SpecificVersion&gt;True&lt;/SpecificVersion&gt;`</ph> element to the .csproj file of the new project under the line that references <ph id=\"ph3\">`InvokePowerShell`</ph>.","source":"If referencing the `InvokePowerShell` activity assembly or project from another project results in a build error, you may need to manually add the `<SpecificVersion>True</SpecificVersion>` element to the .csproj file of the new project under the line that references `InvokePowerShell`."},{"pos":[12988,13351],"content":"If Windows PowerShell is not installed, the following error message is displayed in Visual Studio as soon as you add an <ph id=\"ph1\">`InvokePowerShell`</ph> activity onto a workflow: <ph id=\"ph2\">`Workflow Designer encountered problems with your document. Could not load file or assembly ‘System.Management.Automation’ ... or one of its dependencies. The system cannot find the file specified.`</ph>","source":"If Windows PowerShell is not installed, the following error message is displayed in Visual Studio as soon as you add an `InvokePowerShell` activity onto a workflow: `Workflow Designer encountered problems with your document. Could not load file or assembly ‘System.Management.Automation’ ... or one of its dependencies. The system cannot find the file specified.`"},{"content":"In Windows PowerShell 2.0, programmatically calling <ph id=\"ph1\">`$input.MoveNext()`</ph> fails and scripts using <ph id=\"ph2\">`$input.MoveNext()`</ph> produce unintended errors and results.","pos":[13361,13515],"source":"In Windows PowerShell 2.0, programmatically calling `$input.MoveNext()` fails and scripts using `$input.MoveNext()` produce unintended errors and results."},{"content":"To work around this issue, consider using the PowerShell verb <ph id=\"ph1\">`foreach`</ph> instead of calling <ph id=\"ph2\">`MoveNext()`</ph> when iterating an array.","pos":[13516,13644],"source":" To work around this issue, consider using the PowerShell verb `foreach` instead of calling `MoveNext()` when iterating an array."},{"pos":[13652,13784],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":" The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[13,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[1,54]},{"content":"Check for the following (default) directory before continuing.","pos":[55,117]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[13838,14164],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[14165,14215]},{"pos":[14306,14314],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]}]}