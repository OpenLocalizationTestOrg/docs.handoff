{"content":"---\ntitle: \"Implementing an Explicit Transaction using CommittableTransaction | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 29efe5e5-897b-46c2-a35f-e599a273acc8\ncaps.latest.revision: 3\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Implementing an Explicit Transaction using CommittableTransaction\nThe <xref:System.Transactions.CommittableTransaction> class provides an explicit way for applications to use a transaction, as opposed to using the <xref:System.Transactions.TransactionScope> class implicitly. It is useful for applications that want to use the same transaction across multiple function calls or multiple thread calls. Unlike the <xref:System.Transactions.TransactionScope> class, the application writer needs to specifically call the <xref:System.Transactions.CommittableTransaction.Commit%2A> and <xref:System.Transactions.Transaction.Rollback%2A> methods in order to commit or abort the transaction.  \n  \n## Overview of the CommittableTransaction class  \n The <xref:System.Transactions.CommittableTransaction> class derives from the <xref:System.Transactions.Transaction> class, therefore providing all the functionality of the latter. Specifically useful is the <xref:System.Transactions.Transaction.Rollback%2A> method on the <xref:System.Transactions.Transaction> class that can also be used to rollback a <xref:System.Transactions.CommittableTransaction> object.  \n  \n The  <xref:System.Transactions.Transaction> class is similar to the <xref:System.Transactions.CommittableTransaction> class but does not offer a `Commit` method. This enables you to pass the transaction object (or clones of it) to other methods (potentially on other threads) while still controlling when the transaction is committed. The called code is able to enlist and vote on the transaction, but only the creator of the <xref:System.Transactions.CommittableTransaction> object has the ability to commit the transaction.  \n  \n You should note the followings when working with the <xref:System.Transactions.CommittableTransaction> class,  \n  \n-   Creating a <xref:System.Transactions.CommittableTransaction> transaction does not set the ambient transaction. You need to specifically set and reset the ambient transaction, to ensure that resource managers operate under the right transaction context when appropriate. The way to set the current ambient transaction is by setting the static <xref:System.Transactions.Transaction.Current%2A> property on the global <xref:System.Transactions.Transaction> object.  \n  \n-   A <xref:System.Transactions.CommittableTransaction> object cannot be reused. Once a <xref:System.Transactions.CommittableTransaction> object has been committed or rolled back, it cannot be used again in a transaction. That is, it cannot be set as the current ambient transaction context.  \n  \n## Creating a CommittableTransaction  \n The following sample creates a new <xref:System.Transactions.CommittableTransaction> and commits it.  \n  \n [!code-csharp[Tx_CommittableTx#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_committabletx/cs/committabletxwithsql.cs#1)]\n [!code-vb[Tx_CommittableTx#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_committabletx/vb/committabletxwithsql.vb#1)]  \n  \n Creating an instance of <xref:System.Transactions.CommittableTransaction> does not automatically set the ambient transaction context. Therefore, any operation on a resource manager is not part of that transaction. The static <xref:System.Transactions.Transaction.Current%2A> property on the global <xref:System.Transactions.Transaction> object is used to set or retrieve the ambient transaction and the application must manually set it to ensure that resource managers can participate in the transaction. It is also a good practice to save the old ambient transaction and restore it when you finish using the <xref:System.Transactions.CommittableTransaction> object.  \n  \n To commit the transaction, you need to explicitly call the <xref:System.Transactions.CommittableTransaction.Commit%2A> method. For rolling back a transaction, you should call the <xref:System.Transactions.Transaction.Rollback%2A> method. It is important to note that until a <xref:System.Transactions.CommittableTransaction> has been committed or rolled back, all the resources involved in that transaction are still locked.  \n  \n A <xref:System.Transactions.CommittableTransaction> object can be used across function calls and threads. However, it is up to the application developer to handle exceptions and specifically call the <xref:System.Transactions.Transaction.Rollback%28System.Exception%29> method in case of failures.  \n  \n## Asynchronous Commit  \n The <xref:System.Transactions.CommittableTransaction> class also provides a mechanism for committing a transaction asynchronously. A transaction commit can take substantial time, as it might involve multiple database access and possible network latency. When you want to avoid deadlocks in high throughput applications, you can use asynchronous commit to finish the transactional work as soon as possible, and run the commit operation as a background task. The <xref:System.Transactions.CommittableTransaction.BeginCommit%2A> and <xref:System.Transactions.CommittableTransaction.EndCommit%2A> methods of the <xref:System.Transactions.CommittableTransaction> class allow you to do so.  \n  \n You can call <xref:System.Transactions.CommittableTransaction.BeginCommit%2A> to dispatch the commit holdup to a thread from the thread pool. You can also call <xref:System.Transactions.CommittableTransaction.EndCommit%2A> to determine if the transaction has actually been committed. If the transaction failed to commit for whatever reason, <xref:System.Transactions.CommittableTransaction.EndCommit%2A> raises a transaction exception. If the transaction is not yet committed by the time <xref:System.Transactions.CommittableTransaction.EndCommit%2A> is called, the caller is blocked until the transaction is committed or aborted.  \n  \n The easiest way to do an asynchronous commit is by providing a callback method, to be called when committing is finished. However, you must call the <xref:System.Transactions.CommittableTransaction.EndCommit%2A> method on the original <xref:System.Transactions.CommittableTransaction> object used to invoke the call. To obtain that object, you can downcast the *IAsyncResult* parameter of the callback method, since the <xref:System.Transactions.CommittableTransaction> class implements <xref:System.IAsyncResult> class.  \n  \n The following example shows how an asynchronous commit can be done.  \n  \n```csharp  \npublic void DoTransactionalWork()  \n{  \n     Transaction oldAmbient = Transaction.Current;  \n     CommittableTransaction committableTransaction = new CommittableTransaction();  \n     Transaction.Current = committableTransaction;  \n  \n     try  \n     {  \n          /* Perform transactional work here */  \n          // No errors - commit transaction asynchronously  \n          committableTransaction.BeginCommit(OnCommitted,null);  \n     }  \n     finally  \n     {  \n          //Restore the ambient transaction   \n          Transaction.Current = oldAmbient;  \n     }  \n}  \nvoid OnCommitted(IAsyncResult asyncResult)  \n{  \n     CommittableTransaction committableTransaction;  \n     committableTransaction = asyncResult as CommittableTransaction;     \n     Debug.Assert(committableTransaction != null);  \n     try  \n     {  \n          using(committableTransaction)  \n          {  \n               committableTransaction.EndCommit(asyncResult);  \n          }  \n     }  \n     catch(TransactionException e)  \n     {  \n          //Handle the failure to commit  \n     }  \n}  \n```  \n  \n## See Also  \n [Implementing an Implicit Transaction using Transaction Scope](../../../../docs/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope.md)   \n [Transaction Processing](../../../../docs/framework/data/transactions/index.md)","nodes":[{"pos":[4,352],"nodes":[{"content":"Implementing an Explicit Transaction using CommittableTransaction | Microsoft Docs","nodes":[{"pos":[0,82],"content":"Implementing an Explicit Transaction using CommittableTransaction | Microsoft Docs","nodes":[{"content":"Implementing an Explicit Transaction using CommittableTransaction | Microsoft Docs","pos":[0,82]}]}],"pos":[6,91],"yaml":true}],"content":"title: \"Implementing an Explicit Transaction using CommittableTransaction | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 29efe5e5-897b-46c2-a35f-e599a273acc8\ncaps.latest.revision: 3\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","yamlblock":true},{"pos":[359,424],"content":"Implementing an Explicit Transaction using CommittableTransaction","linkify":"Implementing an Explicit Transaction using CommittableTransaction","nodes":[{"content":"Implementing an Explicit Transaction using CommittableTransaction","pos":[0,65]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class provides an explicit way for applications to use a transaction, as opposed to using the <ph id=\"ph2\">&lt;xref:System.Transactions.TransactionScope&gt;</ph> class implicitly.","pos":[425,634],"source":"The <xref:System.Transactions.CommittableTransaction> class provides an explicit way for applications to use a transaction, as opposed to using the <xref:System.Transactions.TransactionScope> class implicitly."},{"content":"It is useful for applications that want to use the same transaction across multiple function calls or multiple thread calls.","pos":[635,759]},{"content":"Unlike the <ph id=\"ph1\">&lt;xref:System.Transactions.TransactionScope&gt;</ph> class, the application writer needs to specifically call the <ph id=\"ph2\">&lt;xref:System.Transactions.CommittableTransaction.Commit%2A&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.Transactions.Transaction.Rollback%2A&gt;</ph> methods in order to commit or abort the transaction.","pos":[760,1043],"source":" Unlike the <xref:System.Transactions.TransactionScope> class, the application writer needs to specifically call the <xref:System.Transactions.CommittableTransaction.Commit%2A> and <xref:System.Transactions.Transaction.Rollback%2A> methods in order to commit or abort the transaction."},{"pos":[1052,1096],"content":"Overview of the CommittableTransaction class","linkify":"Overview of the CommittableTransaction class","nodes":[{"content":"Overview of the CommittableTransaction class","pos":[0,44]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class derives from the <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction&gt;</ph> class, therefore providing all the functionality of the latter.","pos":[1100,1279],"source":"The <xref:System.Transactions.CommittableTransaction> class derives from the <xref:System.Transactions.Transaction> class, therefore providing all the functionality of the latter."},{"content":"Specifically useful is the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.Rollback%2A&gt;</ph> method on the <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction&gt;</ph> class that can also be used to rollback a <ph id=\"ph3\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object.","pos":[1280,1510],"source":" Specifically useful is the <xref:System.Transactions.Transaction.Rollback%2A> method on the <xref:System.Transactions.Transaction> class that can also be used to rollback a <xref:System.Transactions.CommittableTransaction> object."},{"content":"The  <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction&gt;</ph> class is similar to the <ph id=\"ph2\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class but does not offer a <ph id=\"ph3\">`Commit`</ph> method.","pos":[1517,1678],"source":"The  <xref:System.Transactions.Transaction> class is similar to the <xref:System.Transactions.CommittableTransaction> class but does not offer a `Commit` method."},{"content":"This enables you to pass the transaction object (or clones of it) to other methods (potentially on other threads) while still controlling when the transaction is committed.","pos":[1679,1851]},{"content":"The called code is able to enlist and vote on the transaction, but only the creator of the <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object has the ability to commit the transaction.","pos":[1852,2042],"source":" The called code is able to enlist and vote on the transaction, but only the creator of the <xref:System.Transactions.CommittableTransaction> object has the ability to commit the transaction."},{"content":"You should note the followings when working with the <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class,","pos":[2049,2158],"source":"You should note the followings when working with the <xref:System.Transactions.CommittableTransaction> class,"},{"content":"Creating a <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> transaction does not set the ambient transaction.","pos":[2168,2278],"source":"Creating a <xref:System.Transactions.CommittableTransaction> transaction does not set the ambient transaction."},{"content":"You need to specifically set and reset the ambient transaction, to ensure that resource managers operate under the right transaction context when appropriate.","pos":[2279,2437]},{"content":"The way to set the current ambient transaction is by setting the static <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.Current%2A&gt;</ph> property on the global <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction&gt;</ph> object.","pos":[2438,2629],"source":" The way to set the current ambient transaction is by setting the static <xref:System.Transactions.Transaction.Current%2A> property on the global <xref:System.Transactions.Transaction> object."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object cannot be reused.","pos":[2639,2715],"source":"A <xref:System.Transactions.CommittableTransaction> object cannot be reused."},{"content":"Once a <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object has been committed or rolled back, it cannot be used again in a transaction.","pos":[2716,2856],"source":" Once a <xref:System.Transactions.CommittableTransaction> object has been committed or rolled back, it cannot be used again in a transaction."},{"content":"That is, it cannot be set as the current ambient transaction context.","pos":[2857,2926]},{"pos":[2935,2968],"content":"Creating a CommittableTransaction","linkify":"Creating a CommittableTransaction","nodes":[{"content":"Creating a CommittableTransaction","pos":[0,33]}]},{"content":"The following sample creates a new <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> and commits it.","pos":[2972,3072],"source":"The following sample creates a new <xref:System.Transactions.CommittableTransaction> and commits it."},{"pos":[3079,3348],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>Tx_CommittableTx#1<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_committabletx/cs/committabletxwithsql.cs#1)</ept><ept id=\"p1\">]</ept> <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>Tx_CommittableTx#1<ept id=\"p4\">](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_committabletx/vb/committabletxwithsql.vb#1)</ept><ept id=\"p3\">]</ept>","source":"[!code-csharp[Tx_CommittableTx#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_committabletx/cs/committabletxwithsql.cs#1)]\n [!code-vb[Tx_CommittableTx#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_committabletx/vb/committabletxwithsql.vb#1)]"},{"content":"Creating an instance of <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> does not automatically set the ambient transaction context.","pos":[3355,3488],"source":"Creating an instance of <xref:System.Transactions.CommittableTransaction> does not automatically set the ambient transaction context."},{"content":"Therefore, any operation on a resource manager is not part of that transaction.","pos":[3489,3568]},{"content":"The static <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.Current%2A&gt;</ph> property on the global <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction&gt;</ph> object is used to set or retrieve the ambient transaction and the application must manually set it to ensure that resource managers can participate in the transaction.","pos":[3569,3859],"source":" The static <xref:System.Transactions.Transaction.Current%2A> property on the global <xref:System.Transactions.Transaction> object is used to set or retrieve the ambient transaction and the application must manually set it to ensure that resource managers can participate in the transaction."},{"content":"It is also a good practice to save the old ambient transaction and restore it when you finish using the <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object.","pos":[3860,4021],"source":" It is also a good practice to save the old ambient transaction and restore it when you finish using the <xref:System.Transactions.CommittableTransaction> object."},{"content":"To commit the transaction, you need to explicitly call the <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.Commit%2A&gt;</ph> method.","pos":[4028,4154],"source":"To commit the transaction, you need to explicitly call the <xref:System.Transactions.CommittableTransaction.Commit%2A> method."},{"content":"For rolling back a transaction, you should call the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.Rollback%2A&gt;</ph> method.","pos":[4155,4265],"source":" For rolling back a transaction, you should call the <xref:System.Transactions.Transaction.Rollback%2A> method."},{"content":"It is important to note that until a <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> has been committed or rolled back, all the resources involved in that transaction are still locked.","pos":[4266,4452],"source":" It is important to note that until a <xref:System.Transactions.CommittableTransaction> has been committed or rolled back, all the resources involved in that transaction are still locked."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object can be used across function calls and threads.","pos":[4459,4564],"source":"A <xref:System.Transactions.CommittableTransaction> object can be used across function calls and threads."},{"content":"However, it is up to the application developer to handle exceptions and specifically call the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.Rollback%28System.Exception%29&gt;</ph> method in case of failures.","pos":[4565,4756],"source":" However, it is up to the application developer to handle exceptions and specifically call the <xref:System.Transactions.Transaction.Rollback%28System.Exception%29> method in case of failures."},{"pos":[4765,4784],"content":"Asynchronous Commit","linkify":"Asynchronous Commit","nodes":[{"content":"Asynchronous Commit","pos":[0,19]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class also provides a mechanism for committing a transaction asynchronously.","pos":[4788,4918],"source":"The <xref:System.Transactions.CommittableTransaction> class also provides a mechanism for committing a transaction asynchronously."},{"content":"A transaction commit can take substantial time, as it might involve multiple database access and possible network latency.","pos":[4919,5041]},{"content":"When you want to avoid deadlocks in high throughput applications, you can use asynchronous commit to finish the transactional work as soon as possible, and run the commit operation as a background task.","pos":[5042,5244]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.BeginCommit%2A&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Transactions.CommittableTransaction.EndCommit%2A&gt;</ph> methods of the <ph id=\"ph3\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class allow you to do so.","pos":[5245,5471],"source":" The <xref:System.Transactions.CommittableTransaction.BeginCommit%2A> and <xref:System.Transactions.CommittableTransaction.EndCommit%2A> methods of the <xref:System.Transactions.CommittableTransaction> class allow you to do so."},{"content":"You can call <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.BeginCommit%2A&gt;</ph> to dispatch the commit holdup to a thread from the thread pool.","pos":[5478,5619],"source":"You can call <xref:System.Transactions.CommittableTransaction.BeginCommit%2A> to dispatch the commit holdup to a thread from the thread pool."},{"content":"You can also call <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.EndCommit%2A&gt;</ph> to determine if the transaction has actually been committed.","pos":[5620,5761],"source":" You can also call <xref:System.Transactions.CommittableTransaction.EndCommit%2A> to determine if the transaction has actually been committed."},{"content":"If the transaction failed to commit for whatever reason, <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.EndCommit%2A&gt;</ph> raises a transaction exception.","pos":[5762,5913],"source":" If the transaction failed to commit for whatever reason, <xref:System.Transactions.CommittableTransaction.EndCommit%2A> raises a transaction exception."},{"content":"If the transaction is not yet committed by the time <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.EndCommit%2A&gt;</ph> is called, the caller is blocked until the transaction is committed or aborted.","pos":[5914,6108],"source":" If the transaction is not yet committed by the time <xref:System.Transactions.CommittableTransaction.EndCommit%2A> is called, the caller is blocked until the transaction is committed or aborted."},{"content":"The easiest way to do an asynchronous commit is by providing a callback method, to be called when committing is finished.","pos":[6115,6236]},{"content":"However, you must call the <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.EndCommit%2A&gt;</ph> method on the original <ph id=\"ph2\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> object used to invoke the call.","pos":[6237,6431],"source":" However, you must call the <xref:System.Transactions.CommittableTransaction.EndCommit%2A> method on the original <xref:System.Transactions.CommittableTransaction> object used to invoke the call."},{"content":"To obtain that object, you can downcast the <bpt id=\"p1\">*</bpt>IAsyncResult<ept id=\"p1\">*</ept> parameter of the callback method, since the <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction&gt;</ph> class implements <ph id=\"ph2\">&lt;xref:System.IAsyncResult&gt;</ph> class.","pos":[6432,6635],"source":" To obtain that object, you can downcast the *IAsyncResult* parameter of the callback method, since the <xref:System.Transactions.CommittableTransaction> class implements <xref:System.IAsyncResult> class."},{"content":"The following example shows how an asynchronous commit can be done.","pos":[6642,6709]},{"pos":[7804,7812],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Implementing an Implicit Transaction using Transaction Scope<ept id=\"p1\">](../../../../docs/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope.md)</ept><ph id=\"ph1\"> </ph>","pos":[7816,7989],"source":"[Implementing an Implicit Transaction using Transaction Scope](../../../../docs/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope.md) "},{"content":"<bpt id=\"p1\">[</bpt>Transaction Processing<ept id=\"p1\">](../../../../docs/framework/data/transactions/index.md)</ept>","pos":[7993,8072],"source":"[Transaction Processing](../../../../docs/framework/data/transactions/index.md)"}]}