{"content":"---\ntitle: \"How to: Create a Security Token Service\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"WCF, federation\"\n  - \"federation\"\nms.assetid: 98e82101-4cff-4bb8-a220-f7abed3556e5\n---\n# How to: Create a Security Token Service\nA security token service implements the protocol defined in the WS-Trust specification. This protocol defines message formats and message exchange patterns for issuing, renewing, canceling, and validating security tokens. A given security token service provides one or more of these capabilities. This topic looks at the most common scenario: implementing token issuance.  \n  \n## Issuing Tokens  \n WS-Trust defines message formats, based on the `RequestSecurityToken` XML Schema definition language (XSD) schema element, and `RequestSecurityTokenResponse` XSD schema element for performing token issuance. In addition, it defines the associated Action Uniform Resource Identifiers (URIs). The action URI associated with the `RequestSecurityToken` message is `http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue`. The action URI associated with the `RequestSecurityTokenResponse` message is   `http://schemas.xmlsoap.org/ws/2005/02/trust/RSTR/Issue`.  \n  \n### Request Message Structure  \n The issue request message structure typically consists of the following items:  \n  \n-   A request type URI with a value of `http://schemas.xmlsoap.org/ws/2005/02/trust/Issue`.\n  \n-   A token type URI. For Security Assertions Markup Language (SAML) 1.1 tokens, the value of this URI is `http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1`.  \n  \n-   A key size value that indicates the number of bits in the key to be associated with the issued token.  \n  \n-   A key type URI. For symmetric keys, the value of this URI is `http://schemas.xmlsoap.org/ws/2005/02/trust/SymmetricKey`.  \n  \n In addition, a couple of other items might be present:  \n  \n-   Key material provided by the client.  \n  \n-   Scope information that indicates the target service that the issued token will be used with.  \n  \n The security token service uses the information in the issue request message when it constructs the Issue Response message.  \n  \n## Response Message Structure  \n The issue response message structure typically consists of the following items;  \n  \n-   The issued security token, for example, a SAML 1.1 assertion.  \n  \n-   A proof token associated with the security token. For symmetric keys, this is often an encrypted form of the key material.  \n  \n-   References to the issued security token. Typically, the security token service returns a reference that can be used when the issued token appears in a subsequent message sent by the client and another that can be used when the token is not present in subsequent messages.  \n  \n In addition, a couple of other items might be present:  \n  \n-   Key material provided by the security token service.  \n  \n-   The algorithm needed to compute the shared key.  \n  \n-   Lifetime information for the issued token.  \n  \n## Processing Request Messages  \n The security token service processes the issue request by examining the various pieces of the request message and ensuring that it can issue a token that satisfies the request. The security token service must determine the following before it constructs the token to be issued:  \n  \n-   The request really is a request for a token to be issued.  \n  \n-   The security token service supports the requested token type.  \n  \n-   The requester is authorized to make the request.  \n  \n-   The security token service can meet the requester's expectations with respect to key material.  \n  \n Two vital parts of constructing a token are determining what key to sign the token with and what key to encrypt the shared key with. The token needs to be signed so that when the client presents the token to the target service, that service can determine that the token was issued by a security token service that it trusts. The key material needs to be encrypted in such a way that the target service can decrypt that key material.  \n  \n Signing a SAML assertion involves creating a <xref:System.IdentityModel.Tokens.SigningCredentials> instance. The constructor for this class takes the following:  \n  \n-   A <xref:System.IdentityModel.Tokens.SecurityKey> for the key to use to sign the SAML assertion.  \n  \n-   A string identifying the signature algorithm to use.  \n  \n-   A string identifying the digest algorithm to use.  \n  \n-   Optionally, a <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier> that identifies the key to use to sign the assertion.  \n  \n [!code-csharp[c_CreateSTS#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#1)]\n [!code-vb[c_CreateSTS#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#1)]  \n  \n Encrypting the shared key involves taking the key material and encrypting it with a key that the target service can use to decrypt the shared key. Typically, the public key of the target service is used.  \n  \n [!code-csharp[c_CreateSTS#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#2)]\n [!code-vb[c_CreateSTS#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#2)]  \n  \n In addition, a <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier> for the encrypted key is needed.  \n  \n [!code-csharp[c_CreateSTS#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#3)]\n [!code-vb[c_CreateSTS#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#3)]  \n  \n This <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier> is then used to create a `SamlSubject` as part of the `SamlToken`.  \n  \n [!code-csharp[c_CreateSTS#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#4)]\n [!code-vb[c_CreateSTS#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#4)]  \n  \n For more information, see [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md).  \n  \n## Creating Response Messages  \n Once the security token service processes the issue request and constructs the token to be issued along with the proof key, the response message needs to be constructed, including at least the requested token, the proof token, and the issued token references. The issued token is typically a <xref:System.IdentityModel.Tokens.SamlSecurityToken> created from the <xref:System.IdentityModel.Tokens.SamlAssertion>, as shown in the following example.  \n  \n [!code-csharp[c_CreateSTS#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#5)]\n [!code-vb[c_CreateSTS#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#5)]  \n  \n In the case where the security token service provides the shared key material, the proof token is constructed by creating a <xref:System.ServiceModel.Security.Tokens.BinarySecretSecurityToken>.  \n  \n [!code-csharp[c_CreateSTS#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#6)]\n [!code-vb[c_CreateSTS#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#6)]  \n  \n For more information about how to construct the proof token when the client and the security token service both provide key material for the shared key, see [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md).  \n  \n The issued token references are constructed by creating instances of the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> class.  \n  \n [!code-csharp[c_CreateSTS#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#7)]\n [!code-vb[c_CreateSTS#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#7)]  \n  \n These various values are then serialized into the response message returned to the client.  \n  \n## Example  \n For full code for a security token service, see [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md).  \n  \n## See also\n\n- <xref:System.IdentityModel.Tokens.SigningCredentials>\n- <xref:System.IdentityModel.Tokens.SecurityKey>\n- <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier>\n- <xref:System.IdentityModel.Tokens.SamlSecurityToken>\n- <xref:System.IdentityModel.Tokens.SamlAssertion>\n- <xref:System.ServiceModel.Security.Tokens.BinarySecretSecurityToken>\n- <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause>\n- [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md)\n","nodes":[{"pos":[4,218],"embed":true,"restype":"x-metadata","content":"title: \"How to: Create a Security Token Service\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"WCF, federation\"\n  - \"federation\"\nms.assetid: 98e82101-4cff-4bb8-a220-f7abed3556e5","nodes":[{"content":"How to: Create a Security Token Service","nodes":[{"pos":[0,39],"content":"How to: Create a Security Token Service","nodes":[{"content":"How to: Create a Security Token Service","pos":[0,39]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[225,264],"content":"How to: Create a Security Token Service","linkify":"How to: Create a Security Token Service","nodes":[{"content":"How to: Create a Security Token Service","pos":[0,39]}]},{"content":"A security token service implements the protocol defined in the WS-Trust specification.","pos":[265,352]},{"content":"This protocol defines message formats and message exchange patterns for issuing, renewing, canceling, and validating security tokens.","pos":[353,486]},{"content":"A given security token service provides one or more of these capabilities.","pos":[487,561]},{"content":"This topic looks at the most common scenario: implementing token issuance.","pos":[562,636]},{"pos":[645,659],"content":"Issuing Tokens","linkify":"Issuing Tokens","nodes":[{"content":"Issuing Tokens","pos":[0,14]}]},{"content":"WS-Trust defines message formats, based on the <ph id=\"ph1\">`RequestSecurityToken`</ph> XML Schema definition language (XSD) schema element, and <ph id=\"ph2\">`RequestSecurityTokenResponse`</ph> XSD schema element for performing token issuance.","pos":[663,870],"source":"WS-Trust defines message formats, based on the `RequestSecurityToken` XML Schema definition language (XSD) schema element, and `RequestSecurityTokenResponse` XSD schema element for performing token issuance."},{"content":"In addition, it defines the associated Action Uniform Resource Identifiers (URIs).","pos":[871,953]},{"content":"The action URI associated with the <ph id=\"ph1\">`RequestSecurityToken`</ph> message is <ph id=\"ph2\">`http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue`</ph>.","pos":[954,1079],"source":" The action URI associated with the `RequestSecurityToken` message is `http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue`."},{"content":"The action URI associated with the <ph id=\"ph1\">`RequestSecurityTokenResponse`</ph> message is   <ph id=\"ph2\">`http://schemas.xmlsoap.org/ws/2005/02/trust/RSTR/Issue`</ph>.","pos":[1080,1216],"source":" The action URI associated with the `RequestSecurityTokenResponse` message is   `http://schemas.xmlsoap.org/ws/2005/02/trust/RSTR/Issue`."},{"pos":[1226,1251],"content":"Request Message Structure","linkify":"Request Message Structure","nodes":[{"content":"Request Message Structure","pos":[0,25]}]},{"content":"The issue request message structure typically consists of the following items:","pos":[1255,1333]},{"pos":[1343,1430],"content":"A request type URI with a value of <ph id=\"ph1\">`http://schemas.xmlsoap.org/ws/2005/02/trust/Issue`</ph>.","source":"A request type URI with a value of `http://schemas.xmlsoap.org/ws/2005/02/trust/Issue`."},{"content":"A token type URI.","pos":[1438,1455]},{"content":"For Security Assertions Markup Language (SAML) 1.1 tokens, the value of this URI is <ph id=\"ph1\">`http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1`</ph>.","pos":[1456,1615],"source":" For Security Assertions Markup Language (SAML) 1.1 tokens, the value of this URI is `http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1`."},{"content":"A key size value that indicates the number of bits in the key to be associated with the issued token.","pos":[1625,1726]},{"content":"A key type URI.","pos":[1736,1751]},{"content":"For symmetric keys, the value of this URI is <ph id=\"ph1\">`http://schemas.xmlsoap.org/ws/2005/02/trust/SymmetricKey`</ph>.","pos":[1752,1856],"source":" For symmetric keys, the value of this URI is `http://schemas.xmlsoap.org/ws/2005/02/trust/SymmetricKey`."},{"content":"In addition, a couple of other items might be present:","pos":[1863,1917]},{"content":"Key material provided by the client.","pos":[1927,1963]},{"content":"Scope information that indicates the target service that the issued token will be used with.","pos":[1973,2065]},{"content":"The security token service uses the information in the issue request message when it constructs the Issue Response message.","pos":[2072,2195]},{"pos":[2204,2230],"content":"Response Message Structure","linkify":"Response Message Structure","nodes":[{"content":"Response Message Structure","pos":[0,26]}]},{"content":"The issue response message structure typically consists of the following items;","pos":[2234,2313]},{"content":"The issued security token, for example, a SAML 1.1 assertion.","pos":[2323,2384]},{"content":"A proof token associated with the security token.","pos":[2394,2443]},{"content":"For symmetric keys, this is often an encrypted form of the key material.","pos":[2444,2516]},{"content":"References to the issued security token.","pos":[2526,2566]},{"content":"Typically, the security token service returns a reference that can be used when the issued token appears in a subsequent message sent by the client and another that can be used when the token is not present in subsequent messages.","pos":[2567,2797]},{"content":"In addition, a couple of other items might be present:","pos":[2804,2858]},{"content":"Key material provided by the security token service.","pos":[2868,2920]},{"content":"The algorithm needed to compute the shared key.","pos":[2930,2977]},{"content":"Lifetime information for the issued token.","pos":[2987,3029]},{"pos":[3038,3065],"content":"Processing Request Messages","linkify":"Processing Request Messages","nodes":[{"content":"Processing Request Messages","pos":[0,27]}]},{"content":"The security token service processes the issue request by examining the various pieces of the request message and ensuring that it can issue a token that satisfies the request.","pos":[3069,3245]},{"content":"The security token service must determine the following before it constructs the token to be issued:","pos":[3246,3346]},{"content":"The request really is a request for a token to be issued.","pos":[3356,3413]},{"content":"The security token service supports the requested token type.","pos":[3423,3484]},{"content":"The requester is authorized to make the request.","pos":[3494,3542]},{"content":"The security token service can meet the requester's expectations with respect to key material.","pos":[3552,3646]},{"content":"Two vital parts of constructing a token are determining what key to sign the token with and what key to encrypt the shared key with.","pos":[3653,3785]},{"content":"The token needs to be signed so that when the client presents the token to the target service, that service can determine that the token was issued by a security token service that it trusts.","pos":[3786,3977]},{"content":"The key material needs to be encrypted in such a way that the target service can decrypt that key material.","pos":[3978,4085]},{"content":"Signing a SAML assertion involves creating a <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SigningCredentials&gt;</ph> instance.","pos":[4092,4200],"source":"Signing a SAML assertion involves creating a <xref:System.IdentityModel.Tokens.SigningCredentials> instance."},{"content":"The constructor for this class takes the following:","pos":[4201,4252]},{"pos":[4262,4357],"content":"A <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityKey&gt;</ph> for the key to use to sign the SAML assertion.","source":"A <xref:System.IdentityModel.Tokens.SecurityKey> for the key to use to sign the SAML assertion."},{"content":"A string identifying the signature algorithm to use.","pos":[4367,4419]},{"content":"A string identifying the digest algorithm to use.","pos":[4429,4478]},{"pos":[4488,4612],"content":"Optionally, a <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityKeyIdentifier&gt;</ph> that identifies the key to use to sign the assertion.","source":"Optionally, a <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier> that identifies the key to use to sign the assertion."},{"pos":[4619,4840],"content":"[!code-csharp[c_CreateSTS#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#1)]\n[!code-vb[c_CreateSTS#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#1)]","leadings":[""," "],"nodes":[]},{"content":"Encrypting the shared key involves taking the key material and encrypting it with a key that the target service can use to decrypt the shared key.","pos":[4847,4993]},{"content":"Typically, the public key of the target service is used.","pos":[4994,5050]},{"pos":[5057,5278],"content":"[!code-csharp[c_CreateSTS#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#2)]\n[!code-vb[c_CreateSTS#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#2)]","leadings":[""," "],"nodes":[]},{"pos":[5285,5389],"content":"In addition, a <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityKeyIdentifier&gt;</ph> for the encrypted key is needed.","source":"In addition, a <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier> for the encrypted key is needed."},{"pos":[5396,5617],"content":"[!code-csharp[c_CreateSTS#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#3)]\n[!code-vb[c_CreateSTS#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#3)]","leadings":[""," "],"nodes":[]},{"pos":[5624,5752],"content":"This <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityKeyIdentifier&gt;</ph> is then used to create a <ph id=\"ph2\">`SamlSubject`</ph> as part of the <ph id=\"ph3\">`SamlToken`</ph>.","source":"This <xref:System.IdentityModel.Tokens.SecurityKeyIdentifier> is then used to create a `SamlSubject` as part of the `SamlToken`."},{"pos":[5759,5980],"content":"[!code-csharp[c_CreateSTS#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#4)]\n[!code-vb[c_CreateSTS#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#4)]","leadings":[""," "],"nodes":[]},{"pos":[5987,6094],"content":"For more information, see <bpt id=\"p1\">[</bpt>Federation Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/federation-sample.md)</ept>.","source":"For more information, see [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md)."},{"pos":[6103,6129],"content":"Creating Response Messages","linkify":"Creating Response Messages","nodes":[{"content":"Creating Response Messages","pos":[0,26]}]},{"content":"Once the security token service processes the issue request and constructs the token to be issued along with the proof key, the response message needs to be constructed, including at least the requested token, the proof token, and the issued token references.","pos":[6133,6392]},{"content":"The issued token is typically a <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SamlSecurityToken&gt;</ph> created from the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Tokens.SamlAssertion&gt;</ph>, as shown in the following example.","pos":[6393,6579],"source":" The issued token is typically a <xref:System.IdentityModel.Tokens.SamlSecurityToken> created from the <xref:System.IdentityModel.Tokens.SamlAssertion>, as shown in the following example."},{"pos":[6814,7007],"content":"In the case where the security token service provides the shared key material, the proof token is constructed by creating a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.Tokens.BinarySecretSecurityToken&gt;</ph>.","source":"In the case where the security token service provides the shared key material, the proof token is constructed by creating a <xref:System.ServiceModel.Security.Tokens.BinarySecretSecurityToken>."},{"pos":[7242,7480],"content":"For more information about how to construct the proof token when the client and the security token service both provide key material for the shared key, see <bpt id=\"p1\">[</bpt>Federation Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/federation-sample.md)</ept>.","source":"For more information about how to construct the proof token when the client and the security token service both provide key material for the shared key, see [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md)."},{"pos":[7487,7629],"content":"The issued token references are constructed by creating instances of the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause&gt;</ph> class.","source":"The issued token references are constructed by creating instances of the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> class."},{"content":"These various values are then serialized into the response message returned to the client.","pos":[7864,7954]},{"pos":[7963,7970],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[7974,8103],"content":"For full code for a security token service, see <bpt id=\"p1\">[</bpt>Federation Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/federation-sample.md)</ept>.","source":"For full code for a security token service, see [Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md)."},{"pos":[8112,8120],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[8530,8610],"content":"<bpt id=\"p1\">[</bpt>Federation Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/federation-sample.md)</ept>","source":"[Federation Sample](../../../../docs/framework/wcf/samples/federation-sample.md)"}]}