{"content":"---\ntitle: \"Marshaling Classes, Structures, and Unions\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\n  - \"cpp\"\nhelpviewer_keywords: \n  - \"data marshaling, classes\"\n  - \"marshaling, unions\"\n  - \"marshaling, structures\"\n  - \"marshaling, samples\"\n  - \"data marshaling, structures\"\n  - \"platform invoke, marshaling data\"\n  - \"marshaling, classes\"\n  - \"data marshaling, unions\"\n  - \"data marshaling, samples\"\n  - \"data marshaling, platform invoke\"\n  - \"marshaling, platform invoke\"\nms.assetid: 027832a2-9b43-4fd9-9b45-7f4196261a4e\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# Marshaling Classes, Structures, and Unions\nClasses and structures are similar in the .NET Framework. Both can have fields, properties, and events. They can also have static and nonstatic methods. One notable difference is that structures are value types and classes are reference types.  \n  \n The following table lists marshaling options for classes, structures, and unions; describes their usage; and provides a link to the corresponding platform invoke sample.  \n  \n|Type|Description|Sample|  \n|----------|-----------------|------------|  \n|Class by value.|Passes a class with integer members as an In/Out parameter, like the managed case.|SysTime sample|  \n|Structure by value.|Passes structures as In parameters.|Structures sample|  \n|Structure by reference.|Passes structures as In/Out parameters.|OSInfo sample|  \n|Structure with nested structures (flattened).|Passes a class that represents a structure with nested structures in the unmanaged function. The structure is flattened to one big structure in the managed prototype.|FindFile sample|  \n|Structure with a pointer to another structure.|Passes a structure that contains a pointer to a second structure as a member.|Structures Sample|  \n|Array of structures with integers by value.|Passes an array of structures that contain only integers as an In/Out parameter. Members of the array can be changed.|Arrays Sample|  \n|Array of structures with integers and strings by reference.|Passes an array of structures that contain integers and strings as an Out parameter. The called function allocates memory for the array.|OutArrayOfStructs Sample|  \n|Unions with value types.|Passes unions with value types (integer and double).|Unions sample|  \n|Unions with mixed types.|Passes unions with mixed types (integer and string).|Unions sample|  \n|Null values in structure.|Passes a null reference (**Nothing** in Visual Basic) instead of a reference to a value type.|HandleRef sample|  \n  \n## Structures sample  \n This sample demonstrates how to pass a structure that points to a second structure, pass a structure with an embedded structure, and pass a structure with an embedded array.  \n  \n The Structs sample uses the following unmanaged functions, shown with their original function declaration:  \n  \n-   **TestStructInStruct** exported from PinvokeLib.dll.  \n  \n    ```  \n    int TestStructInStruct(MYPERSON2* pPerson2);  \n    ```  \n  \n-   **TestStructInStruct3** exported from PinvokeLib.dll.  \n  \n    ```  \n    void TestStructInStruct3(MYPERSON3 person3);  \n    ```  \n  \n-   **TestArrayInStruct** exported from PinvokeLib.dll.  \n  \n    ```  \n    void TestArrayInStruct( MYARRAYSTRUCT* pStruct );  \n    ```  \n  \n [PinvokeLib.dll](marshaling-data-with-platform-invoke.md#pinvokelibdll) is a custom unmanaged library that contains implementations for the previously listed functions and four structures: **MYPERSON**, **MYPERSON2**, **MYPERSON3**, and **MYARRAYSTRUCT**. These structures contain the following elements:  \n  \n```  \ntypedef struct _MYPERSON  \n{  \n   char* first;   \n   char* last;   \n} MYPERSON, *LP_MYPERSON;  \n  \ntypedef struct _MYPERSON2  \n{  \n   MYPERSON* person;  \n   int age;   \n} MYPERSON2, *LP_MYPERSON2;  \n  \ntypedef struct _MYPERSON3  \n{  \n   MYPERSON person;  \n   int age;   \n} MYPERSON3;  \n  \ntypedef struct _MYARRAYSTRUCT  \n{  \n   bool flag;  \n   int vals[ 3 ];   \n} MYARRAYSTRUCT;  \n```  \n  \n The managed `MyPerson`, `MyPerson2`, `MyPerson3`, and `MyArrayStruct` structures have the following characteristic:  \n  \n-   `MyPerson` contains only string members. The [CharSet](specifying-a-character-set.md) field sets the strings to ANSI format when passed to the unmanaged function.  \n  \n-   `MyPerson2` contains an **IntPtr** to the `MyPerson` structure. The **IntPtr** type replaces the original pointer to the unmanaged structure because .NET Framework applications do not use pointers unless the code is marked **unsafe**.  \n  \n-   `MyPerson3` contains `MyPerson` as an embedded structure. A structure embedded within another structure can be flattened by placing the elements of the embedded structure directly into the main structure, or it can be left as an embedded structure, as is done in this sample.  \n  \n-   `MyArrayStruct` contains an array of integers. The <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute sets the <xref:System.Runtime.InteropServices.UnmanagedType> enumeration value to **ByValArray**, which is used to indicate the number of elements in the array.  \n  \n For all structures in this sample, the <xref:System.Runtime.InteropServices.StructLayoutAttribute> attribute is applied to ensure that the members are arranged in memory sequentially, in the order in which they appear.  \n  \n The `LibWrap` class contains managed prototypes for the `TestStructInStruct`, `TestStructInStruct3`, and `TestArrayInStruct` methods called by the `App` class. Each prototype declares a single parameter, as follows:  \n  \n-   `TestStructInStruct` declares a reference to type `MyPerson2` as its parameter.  \n  \n-   `TestStructInStruct3` declares type `MyPerson3` as its parameter and passes the parameter by value.  \n  \n-   `TestArrayInStruct` declares a reference to type `MyArrayStruct` as its parameter.  \n  \n Structures as arguments to methods are passed by value unless the parameter contains the **ref** (**ByRef** in Visual Basic) keyword. For example, the `TestStructInStruct` method passes a reference (the value of an address) to an object of type `MyPerson2` to unmanaged code. To manipulate the structure that `MyPerson2` points to, the sample creates a buffer of a specified size and returns its address by combining the <xref:System.Runtime.InteropServices.Marshal.AllocCoTaskMem%2A?displayProperty=nameWithType> and <xref:System.Runtime.InteropServices.Marshal.SizeOf%2A?displayProperty=nameWithType> methods. Next, the sample copies the content of the managed structure to the unmanaged buffer. Finally, the sample uses the <xref:System.Runtime.InteropServices.Marshal.PtrToStructure%2A?displayProperty=nameWithType> method to marshal data from the unmanaged buffer to a managed object and the <xref:System.Runtime.InteropServices.Marshal.FreeCoTaskMem%2A?displayProperty=nameWithType> method to free the unmanaged block of memory.  \n  \n### Declaring Prototypes  \n [!code-cpp[Conceptual.Interop.Marshaling#23](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/structures.cpp#23)]\n [!code-csharp[Conceptual.Interop.Marshaling#23](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/structures.cs#23)]\n [!code-vb[Conceptual.Interop.Marshaling#23](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/structures.vb#23)]  \n  \n### Calling Functions  \n [!code-cpp[Conceptual.Interop.Marshaling#24](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/structures.cpp#24)]\n [!code-csharp[Conceptual.Interop.Marshaling#24](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/structures.cs#24)]\n [!code-vb[Conceptual.Interop.Marshaling#24](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/structures.vb#24)]  \n  \n## FindFile sample  \n This sample demonstrates how to pass a structure that contains a second, embedded structure to an unmanaged function. It also demonstrates how to use the <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute to declare a fixed-length array within the structure. In this sample, the embedded structure elements are added to the parent structure. For a sample of an embedded structure that is not flattened, see [Structures Sample](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/eadtsekz(v=vs.100)).  \n  \n The FindFile sample uses the following unmanaged function, shown with its original function declaration:  \n  \n-   **FindFirstFile** exported from Kernel32.dll.  \n  \n    ```  \n    HANDLE FindFirstFile(LPCTSTR lpFileName, LPWIN32_FIND_DATA lpFindFileData);  \n    ```  \n  \n The original structure passed to the function contains the following elements:  \n  \n```  \ntypedef struct _WIN32_FIND_DATA   \n{  \n  DWORD    dwFileAttributes;   \n  FILETIME ftCreationTime;   \n  FILETIME ftLastAccessTime;   \n  FILETIME ftLastWriteTime;   \n  DWORD    nFileSizeHigh;   \n  DWORD    nFileSizeLow;   \n  DWORD    dwReserved0;   \n  DWORD    dwReserved1;   \n  TCHAR    cFileName[ MAX_PATH ];   \n  TCHAR    cAlternateFileName[ 14 ];   \n} WIN32_FIND_DATA, *PWIN32_FIND_DATA;  \n```  \n  \n In this sample, the `FindData` class contains a corresponding data member for each element of the original structure and the embedded structure. In place of two original character buffers, the class substitutes strings. **MarshalAsAttribute** sets the <xref:System.Runtime.InteropServices.UnmanagedType> enumeration to **ByValTStr**, which is used to identify the inline, fixed-length character arrays that appear within the unmanaged structures.  \n  \n The `LibWrap` class contains a managed prototype of the `FindFirstFile` method, which passes the `FindData` class as a parameter. The parameter must be declared with the <xref:System.Runtime.InteropServices.InAttribute> and <xref:System.Runtime.InteropServices.OutAttribute> attributes because classes, which are reference types, are passed as In parameters by default.  \n  \n### Declaring Prototypes  \n [!code-cpp[Conceptual.Interop.Marshaling#17](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/findfile.cpp#17)]\n [!code-csharp[Conceptual.Interop.Marshaling#17](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/findfile.cs#17)]\n [!code-vb[Conceptual.Interop.Marshaling#17](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/findfile.vb#17)]  \n  \n### Calling Functions  \n [!code-cpp[Conceptual.Interop.Marshaling#18](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/findfile.cpp#18)]\n [!code-csharp[Conceptual.Interop.Marshaling#18](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/findfile.cs#18)]\n [!code-vb[Conceptual.Interop.Marshaling#18](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/findfile.vb#18)]  \n  \n## Unions sample  \n This sample demonstrates how to pass structures containing only value types, and structures containing a value type and a string as parameters to an unmanaged function expecting a union. A union represents a memory location that can be shared by two or more variables.  \n  \n The Unions sample uses the following unmanaged function, shown with its original function declaration:  \n  \n-   **TestUnion** exported from PinvokeLib.dll.  \n  \n    ```  \n    void TestUnion(MYUNION u, int type);  \n    ```  \n  \n [PinvokeLib.dll](marshaling-data-with-platform-invoke.md#pinvokelibdll) is a custom unmanaged library that contains an implementation for the previously listed function and two unions, **MYUNION** and **MYUNION2**. The unions contain the following elements:  \n  \n```  \nunion MYUNION  \n{  \n    int number;  \n    double d;  \n}  \n  \nunion MYUNION2  \n{  \n    int i;  \n    char str[128];  \n};  \n```  \n  \n In managed code, unions are defined as structures. The `MyUnion` structure contains two value types as its members: an integer and a double. The <xref:System.Runtime.InteropServices.StructLayoutAttribute> attribute is set to control the precise position of each data member. The <xref:System.Runtime.InteropServices.FieldOffsetAttribute> attribute provides the physical position of fields within the unmanaged representation of a union. Notice that both members have the same offset values, so the members can define the same piece of memory.  \n  \n `MyUnion2_1` and `MyUnion2_2` contain a value type (integer) and a string, respectively. In managed code, value types and reference types are not permitted to overlap. This sample uses method overloading to enable the caller to use both types when calling the same unmanaged function. The layout of `MyUnion2_1` is explicit and has a precise offset value. In contrast, `MyUnion2_2` has a sequential layout, because explicit layouts are not permitted with reference types. The <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute sets the <xref:System.Runtime.InteropServices.UnmanagedType> enumeration to **ByValTStr**, which is used to identify the inline, fixed-length character arrays that appear within the unmanaged representation of the union.  \n  \n The `LibWrap` class contains the prototypes for the `TestUnion` and `TestUnion2` methods. `TestUnion2` is overloaded to declare `MyUnion2_1` or `MyUnion2_2` as parameters.  \n  \n### Declaring Prototypes  \n [!code-cpp[Conceptual.Interop.Marshaling#28](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/unions.cpp#28)]\n [!code-csharp[Conceptual.Interop.Marshaling#28](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/unions.cs#28)]\n [!code-vb[Conceptual.Interop.Marshaling#28](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/unions.vb#28)]  \n  \n### Calling Functions  \n [!code-cpp[Conceptual.Interop.Marshaling#29](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/unions.cpp#29)]\n [!code-csharp[Conceptual.Interop.Marshaling#29](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/unions.cs#29)]\n [!code-vb[Conceptual.Interop.Marshaling#29](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/unions.vb#29)]  \n  \n## SysTime sample  \n This sample demonstrates how to pass a pointer to a class to an unmanaged function that expects a pointer to a structure.  \n  \n The SysTime sample uses the following unmanaged function, shown with its original function declaration:  \n  \n-   **GetSystemTime** exported from Kernel32.dll.  \n  \n    ```  \n    VOID GetSystemTime(LPSYSTEMTIME lpSystemTime);  \n    ```  \n  \n The original structure passed to the function contains the following elements:  \n  \n```  \ntypedef struct _SYSTEMTIME {   \n    WORD wYear;   \n    WORD wMonth;   \n    WORD wDayOfWeek;   \n    WORD wDay;   \n    WORD wHour;   \n    WORD wMinute;   \n    WORD wSecond;   \n    WORD wMilliseconds;   \n} SYSTEMTIME, *PSYSTEMTIME;  \n```  \n  \n In this sample, the `SystemTime` class contains the elements of the original structure represented as class members. The <xref:System.Runtime.InteropServices.StructLayoutAttribute> attribute is set to ensure that the members are arranged in memory sequentially, in the order in which they appear.  \n  \n The `LibWrap` class contains a managed prototype of the `GetSystemTime` method, which passes the `SystemTime` class as an In/Out parameter by default. The parameter must be declared with the <xref:System.Runtime.InteropServices.InAttribute> and <xref:System.Runtime.InteropServices.OutAttribute> attributes because classes, which are reference types, are passed as In parameters by default. For the caller to receive the results, these [directional attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100)) must be applied explicitly. The `App` class creates a new instance of the `SystemTime` class and accesses its data fields.  \n  \n### Code Samples  \n [!code-cpp[Conceptual.Interop.Marshaling#25](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/systime.cpp#25)]\n [!code-csharp[Conceptual.Interop.Marshaling#25](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/systime.cs#25)]\n [!code-vb[Conceptual.Interop.Marshaling#25](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/systime.vb#25)]  \n  \n## OutArrayOfStructs sample  \n This sample shows how to pass an array of structures that contains integers and strings as Out parameters to an unmanaged function.  \n  \n This sample demonstrates how to call a native function by using the <xref:System.Runtime.InteropServices.Marshal> class and by using unsafe code.  \n  \n This sample uses a wrapper functions and platform invokes defined in [PinvokeLib.dll](marshaling-data-with-platform-invoke.md#pinvokelibdll), also provided in the source files. It uses the `TestOutArrayOfStructs` function and the `MYSTRSTRUCT2` structure. The structure contains the following elements:  \n  \n```  \ntypedef struct _MYSTRSTRUCT2  \n{  \n   char* buffer;  \n   UINT size;   \n} MYSTRSTRUCT2;  \n```  \n  \n The `MyStruct` class contains a string object of ANSI characters. The <xref:System.Runtime.InteropServices.DllImportAttribute.CharSet> field specifies ANSI format. `MyUnsafeStruct`, is a structure containing an <xref:System.IntPtr> type instead of a string.  \n  \n The `LibWrap` class contains the overloaded `TestOutArrayOfStructs` prototype method. If a method declares a pointer as a parameter, the class should be marked with the `unsafe` keyword. Because [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] cannot use unsafe code, the overloaded method, unsafe modifier, and the `MyUnsafeStruct` structure are unnecessary.  \n  \n The `App` class implements the `UsingMarshaling` method, which performs all the tasks necessary to pass the array. The array is marked with the `out` (`ByRef` in Visual Basic) keyword to indicate that data passes from callee to caller. The implementation uses the following <xref:System.Runtime.InteropServices.Marshal> class methods:  \n  \n-   <xref:System.Runtime.InteropServices.Marshal.PtrToStructure%2A> to marshal data from the unmanaged buffer to a managed object.  \n  \n-   <xref:System.Runtime.InteropServices.Marshal.DestroyStructure%2A> to release the memory reserved for strings in the structure.  \n  \n-   <xref:System.Runtime.InteropServices.Marshal.FreeCoTaskMem%2A> to release the memory reserved for the array.  \n  \n As previously mentioned, C# allows unsafe code and [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] does not. In the C# sample, `UsingUnsafePointer` is an alternative method implementation that uses pointers instead of the <xref:System.Runtime.InteropServices.Marshal> class to pass back the array containing the `MyUnsafeStruct` structure.  \n  \n### Declaring Prototypes  \n [!code-cpp[Conceptual.Interop.Marshaling#20](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/outarrayofstructs.cpp#20)]\n [!code-csharp[Conceptual.Interop.Marshaling#20](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/outarrayofstructs.cs#20)]\n [!code-vb[Conceptual.Interop.Marshaling#20](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/outarrayofstructs.vb#20)]  \n  \n### Calling Functions  \n [!code-cpp[Conceptual.Interop.Marshaling#21](../../../samples/snippets/cpp/VS_Snippets_CLR/conceptual.interop.marshaling/cpp/outarrayofstructs.cpp#21)]\n [!code-csharp[Conceptual.Interop.Marshaling#21](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.interop.marshaling/cs/outarrayofstructs.cs#21)]\n [!code-vb[Conceptual.Interop.Marshaling#21](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.interop.marshaling/vb/outarrayofstructs.vb#21)]  \n  \n## See also\n\n- [Marshaling Data with Platform Invoke](marshaling-data-with-platform-invoke.md)\n- [Marshaling Strings](marshaling-strings.md)\n- [Marshaling Different Types of Arrays](marshaling-different-types-of-arrays.md)\n","nodes":[{"pos":[4,576],"embed":true,"restype":"x-metadata","content":"title: \"Marshaling Classes, Structures, and Unions\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\n  - \"cpp\"\nhelpviewer_keywords: \n  - \"data marshaling, classes\"\n  - \"marshaling, unions\"\n  - \"marshaling, structures\"\n  - \"marshaling, samples\"\n  - \"data marshaling, structures\"\n  - \"platform invoke, marshaling data\"\n  - \"marshaling, classes\"\n  - \"data marshaling, unions\"\n  - \"data marshaling, samples\"\n  - \"data marshaling, platform invoke\"\n  - \"marshaling, platform invoke\"\nms.assetid: 027832a2-9b43-4fd9-9b45-7f4196261a4e\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"Marshaling Classes, Structures, and Unions","nodes":[{"pos":[0,42],"content":"Marshaling Classes, Structures, and Unions","nodes":[{"content":"Marshaling Classes, Structures, and Unions","pos":[0,42]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[583,625],"content":"Marshaling Classes, Structures, and Unions","linkify":"Marshaling Classes, Structures, and Unions","nodes":[{"content":"Marshaling Classes, Structures, and Unions","pos":[0,42]}]},{"content":"Classes and structures are similar in the .NET Framework.","pos":[626,683]},{"content":"Both can have fields, properties, and events.","pos":[684,729]},{"content":"They can also have static and nonstatic methods.","pos":[730,778]},{"content":"One notable difference is that structures are value types and classes are reference types.","pos":[779,869]},{"content":"The following table lists marshaling options for classes, structures, and unions; describes their usage; and provides a link to the corresponding platform invoke sample.","pos":[876,1045]},{"content":"Type","pos":[1052,1056]},{"content":"Description","pos":[1057,1068]},{"content":"Sample","pos":[1069,1075]},{"content":"Class by value.","pos":[1126,1141]},{"content":"Passes a class with integer members as an In/Out parameter, like the managed case.","pos":[1142,1224]},{"content":"SysTime sample","pos":[1225,1239]},{"content":"Structure by value.","pos":[1244,1263]},{"content":"Passes structures as In parameters.","pos":[1264,1299]},{"content":"Structures sample","pos":[1300,1317]},{"content":"Structure by reference.","pos":[1322,1345]},{"content":"Passes structures as In/Out parameters.","pos":[1346,1385]},{"content":"OSInfo sample","pos":[1386,1399]},{"content":"Structure with nested structures (flattened).","pos":[1404,1449]},{"content":"Passes a class that represents a structure with nested structures in the unmanaged function.","pos":[1450,1542]},{"content":"The structure is flattened to one big structure in the managed prototype.","pos":[1543,1616]},{"content":"FindFile sample","pos":[1617,1632]},{"content":"Structure with a pointer to another structure.","pos":[1637,1683]},{"content":"Passes a structure that contains a pointer to a second structure as a member.","pos":[1684,1761]},{"content":"Structures Sample","pos":[1762,1779]},{"content":"Array of structures with integers by value.","pos":[1784,1827]},{"content":"Passes an array of structures that contain only integers as an In/Out parameter.","pos":[1828,1908]},{"content":"Members of the array can be changed.","pos":[1909,1945]},{"content":"Arrays Sample","pos":[1946,1959]},{"content":"Array of structures with integers and strings by reference.","pos":[1964,2023]},{"content":"Passes an array of structures that contain integers and strings as an Out parameter.","pos":[2024,2108]},{"content":"The called function allocates memory for the array.","pos":[2109,2160]},{"content":"OutArrayOfStructs Sample","pos":[2161,2185]},{"content":"Unions with value types.","pos":[2190,2214]},{"content":"Passes unions with value types (integer and double).","pos":[2215,2267]},{"content":"Unions sample","pos":[2268,2281]},{"content":"Unions with mixed types.","pos":[2286,2310]},{"content":"Passes unions with mixed types (integer and string).","pos":[2311,2363]},{"content":"Unions sample","pos":[2364,2377]},{"content":"Null values in structure.","pos":[2382,2407]},{"pos":[2408,2501],"content":"Passes a null reference (<bpt id=\"p1\">**</bpt>Nothing<ept id=\"p1\">**</ept> in Visual Basic) instead of a reference to a value type.","source":"Passes a null reference (**Nothing** in Visual Basic) instead of a reference to a value type."},{"content":"HandleRef sample","pos":[2502,2518]},{"pos":[2528,2545],"content":"Structures sample","linkify":"Structures sample","nodes":[{"content":"Structures sample","pos":[0,17]}]},{"content":"This sample demonstrates how to pass a structure that points to a second structure, pass a structure with an embedded structure, and pass a structure with an embedded array.","pos":[2549,2722]},{"content":"The Structs sample uses the following unmanaged functions, shown with their original function declaration:","pos":[2729,2835]},{"pos":[2845,2897],"content":"<bpt id=\"p1\">**</bpt>TestStructInStruct<ept id=\"p1\">**</ept> exported from PinvokeLib.dll.","source":"**TestStructInStruct** exported from PinvokeLib.dll."},{"pos":[2981,3034],"content":"<bpt id=\"p1\">**</bpt>TestStructInStruct3<ept id=\"p1\">**</ept> exported from PinvokeLib.dll.","source":"**TestStructInStruct3** exported from PinvokeLib.dll."},{"pos":[3118,3169],"content":"<bpt id=\"p1\">**</bpt>TestArrayInStruct<ept id=\"p1\">**</ept> exported from PinvokeLib.dll.","source":"**TestArrayInStruct** exported from PinvokeLib.dll."},{"content":"<bpt id=\"p1\">[</bpt>PinvokeLib.dll<ept id=\"p1\">](marshaling-data-with-platform-invoke.md#pinvokelibdll)</ept> is a custom unmanaged library that contains implementations for the previously listed functions and four structures: <bpt id=\"p2\">**</bpt>MYPERSON<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>MYPERSON2<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>MYPERSON3<ept id=\"p4\">**</ept>, and <bpt id=\"p5\">**</bpt>MYARRAYSTRUCT<ept id=\"p5\">**</ept>.","pos":[3255,3510],"source":"[PinvokeLib.dll](marshaling-data-with-platform-invoke.md#pinvokelibdll) is a custom unmanaged library that contains implementations for the previously listed functions and four structures: **MYPERSON**, **MYPERSON2**, **MYPERSON3**, and **MYARRAYSTRUCT**."},{"content":"These structures contain the following elements:","pos":[3511,3559]},{"pos":[3962,4077],"content":"The managed <ph id=\"ph1\">`MyPerson`</ph>, <ph id=\"ph2\">`MyPerson2`</ph>, <ph id=\"ph3\">`MyPerson3`</ph>, and <ph id=\"ph4\">`MyArrayStruct`</ph> structures have the following characteristic:","source":"The managed `MyPerson`, `MyPerson2`, `MyPerson3`, and `MyArrayStruct` structures have the following characteristic:"},{"content":"<ph id=\"ph1\">`MyPerson`</ph> contains only string members.","pos":[4087,4127],"source":"`MyPerson` contains only string members."},{"content":"The <bpt id=\"p1\">[</bpt>CharSet<ept id=\"p1\">](specifying-a-character-set.md)</ept> field sets the strings to ANSI format when passed to the unmanaged function.","pos":[4128,4249],"source":" The [CharSet](specifying-a-character-set.md) field sets the strings to ANSI format when passed to the unmanaged function."},{"content":"<ph id=\"ph1\">`MyPerson2`</ph> contains an <bpt id=\"p1\">**</bpt>IntPtr<ept id=\"p1\">**</ept> to the <ph id=\"ph2\">`MyPerson`</ph> structure.","pos":[4259,4322],"source":"`MyPerson2` contains an **IntPtr** to the `MyPerson` structure."},{"content":"The <bpt id=\"p1\">**</bpt>IntPtr<ept id=\"p1\">**</ept> type replaces the original pointer to the unmanaged structure because .NET Framework applications do not use pointers unless the code is marked <bpt id=\"p2\">**</bpt>unsafe<ept id=\"p2\">**</ept>.","pos":[4323,4493],"source":" The **IntPtr** type replaces the original pointer to the unmanaged structure because .NET Framework applications do not use pointers unless the code is marked **unsafe**."},{"content":"<ph id=\"ph1\">`MyPerson3`</ph> contains <ph id=\"ph2\">`MyPerson`</ph> as an embedded structure.","pos":[4503,4560],"source":"`MyPerson3` contains `MyPerson` as an embedded structure."},{"content":"A structure embedded within another structure can be flattened by placing the elements of the embedded structure directly into the main structure, or it can be left as an embedded structure, as is done in this sample.","pos":[4561,4778]},{"content":"<ph id=\"ph1\">`MyArrayStruct`</ph> contains an array of integers.","pos":[4788,4834],"source":"`MyArrayStruct` contains an array of integers."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.MarshalAsAttribute&gt;</ph> attribute sets the <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.UnmanagedType&gt;</ph> enumeration value to <bpt id=\"p1\">**</bpt>ByValArray<ept id=\"p1\">**</ept>, which is used to indicate the number of elements in the array.","pos":[4835,5066],"source":" The <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute sets the <xref:System.Runtime.InteropServices.UnmanagedType> enumeration value to **ByValArray**, which is used to indicate the number of elements in the array."},{"pos":[5073,5291],"content":"For all structures in this sample, the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.StructLayoutAttribute&gt;</ph> attribute is applied to ensure that the members are arranged in memory sequentially, in the order in which they appear.","source":"For all structures in this sample, the <xref:System.Runtime.InteropServices.StructLayoutAttribute> attribute is applied to ensure that the members are arranged in memory sequentially, in the order in which they appear."},{"content":"The <ph id=\"ph1\">`LibWrap`</ph> class contains managed prototypes for the <ph id=\"ph2\">`TestStructInStruct`</ph>, <ph id=\"ph3\">`TestStructInStruct3`</ph>, and <ph id=\"ph4\">`TestArrayInStruct`</ph> methods called by the <ph id=\"ph5\">`App`</ph> class.","pos":[5298,5457],"source":"The `LibWrap` class contains managed prototypes for the `TestStructInStruct`, `TestStructInStruct3`, and `TestArrayInStruct` methods called by the `App` class."},{"content":"Each prototype declares a single parameter, as follows:","pos":[5458,5513]},{"pos":[5523,5602],"content":"<ph id=\"ph1\">`TestStructInStruct`</ph> declares a reference to type <ph id=\"ph2\">`MyPerson2`</ph> as its parameter.","source":"`TestStructInStruct` declares a reference to type `MyPerson2` as its parameter."},{"pos":[5612,5711],"content":"<ph id=\"ph1\">`TestStructInStruct3`</ph> declares type <ph id=\"ph2\">`MyPerson3`</ph> as its parameter and passes the parameter by value.","source":"`TestStructInStruct3` declares type `MyPerson3` as its parameter and passes the parameter by value."},{"pos":[5721,5803],"content":"<ph id=\"ph1\">`TestArrayInStruct`</ph> declares a reference to type <ph id=\"ph2\">`MyArrayStruct`</ph> as its parameter.","source":"`TestArrayInStruct` declares a reference to type `MyArrayStruct` as its parameter."},{"content":"Structures as arguments to methods are passed by value unless the parameter contains the <bpt id=\"p1\">**</bpt>ref<ept id=\"p1\">**</ept> (<bpt id=\"p2\">**</bpt>ByRef<ept id=\"p2\">**</ept> in Visual Basic) keyword.","pos":[5810,5943],"source":"Structures as arguments to methods are passed by value unless the parameter contains the **ref** (**ByRef** in Visual Basic) keyword."},{"content":"For example, the <ph id=\"ph1\">`TestStructInStruct`</ph> method passes a reference (the value of an address) to an object of type <ph id=\"ph2\">`MyPerson2`</ph> to unmanaged code.","pos":[5944,6085],"source":" For example, the `TestStructInStruct` method passes a reference (the value of an address) to an object of type `MyPerson2` to unmanaged code."},{"content":"To manipulate the structure that <ph id=\"ph1\">`MyPerson2`</ph> points to, the sample creates a buffer of a specified size and returns its address by combining the <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.Marshal.AllocCoTaskMem%2A?displayProperty=nameWithType&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.Runtime.InteropServices.Marshal.SizeOf%2A?displayProperty=nameWithType&gt;</ph> methods.","pos":[6086,6421],"source":" To manipulate the structure that `MyPerson2` points to, the sample creates a buffer of a specified size and returns its address by combining the <xref:System.Runtime.InteropServices.Marshal.AllocCoTaskMem%2A?displayProperty=nameWithType> and <xref:System.Runtime.InteropServices.Marshal.SizeOf%2A?displayProperty=nameWithType> methods."},{"content":"Next, the sample copies the content of the managed structure to the unmanaged buffer.","pos":[6422,6507]},{"content":"Finally, the sample uses the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.Marshal.PtrToStructure%2A?displayProperty=nameWithType&gt;</ph> method to marshal data from the unmanaged buffer to a managed object and the <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.Marshal.FreeCoTaskMem%2A?displayProperty=nameWithType&gt;</ph> method to free the unmanaged block of memory.","pos":[6508,6844],"source":" Finally, the sample uses the <xref:System.Runtime.InteropServices.Marshal.PtrToStructure%2A?displayProperty=nameWithType> method to marshal data from the unmanaged buffer to a managed object and the <xref:System.Runtime.InteropServices.Marshal.FreeCoTaskMem%2A?displayProperty=nameWithType> method to free the unmanaged block of memory."},{"pos":[6854,6874],"content":"Declaring Prototypes","linkify":"Declaring Prototypes","nodes":[{"content":"Declaring Prototypes","pos":[0,20]}]},{"pos":[7333,7350],"content":"Calling Functions","linkify":"Calling Functions","nodes":[{"content":"Calling Functions","pos":[0,17]}]},{"pos":[7808,7823],"content":"FindFile sample","linkify":"FindFile sample","nodes":[{"content":"FindFile sample","pos":[0,15]}]},{"content":"This sample demonstrates how to pass a structure that contains a second, embedded structure to an unmanaged function.","pos":[7827,7944]},{"content":"It also demonstrates how to use the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.MarshalAsAttribute&gt;</ph> attribute to declare a fixed-length array within the structure.","pos":[7945,8101],"source":" It also demonstrates how to use the <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute to declare a fixed-length array within the structure."},{"content":"In this sample, the embedded structure elements are added to the parent structure.","pos":[8102,8184]},{"content":"For a sample of an embedded structure that is not flattened, see <bpt id=\"p1\">[</bpt>Structures Sample<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/eadtsekz(v=vs.100))</ept>.","pos":[8185,8359],"source":" For a sample of an embedded structure that is not flattened, see [Structures Sample](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/eadtsekz(v=vs.100))."},{"content":"The FindFile sample uses the following unmanaged function, shown with its original function declaration:","pos":[8366,8470]},{"pos":[8480,8525],"content":"<bpt id=\"p1\">**</bpt>FindFirstFile<ept id=\"p1\">**</ept> exported from Kernel32.dll.","source":"**FindFirstFile** exported from Kernel32.dll."},{"content":"The original structure passed to the function contains the following elements:","pos":[8637,8715]},{"content":"In this sample, the <ph id=\"ph1\">`FindData`</ph> class contains a corresponding data member for each element of the original structure and the embedded structure.","pos":[9129,9273],"source":"In this sample, the `FindData` class contains a corresponding data member for each element of the original structure and the embedded structure."},{"content":"In place of two original character buffers, the class substitutes strings.","pos":[9274,9348]},{"content":"<bpt id=\"p1\">**</bpt>MarshalAsAttribute<ept id=\"p1\">**</ept> sets the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.UnmanagedType&gt;</ph> enumeration to <bpt id=\"p2\">**</bpt>ByValTStr<ept id=\"p2\">**</ept>, which is used to identify the inline, fixed-length character arrays that appear within the unmanaged structures.","pos":[9349,9575],"source":"**MarshalAsAttribute** sets the <xref:System.Runtime.InteropServices.UnmanagedType> enumeration to **ByValTStr**, which is used to identify the inline, fixed-length character arrays that appear within the unmanaged structures."},{"content":"The <ph id=\"ph1\">`LibWrap`</ph> class contains a managed prototype of the <ph id=\"ph2\">`FindFirstFile`</ph> method, which passes the <ph id=\"ph3\">`FindData`</ph> class as a parameter.","pos":[9582,9711],"source":"The `LibWrap` class contains a managed prototype of the `FindFirstFile` method, which passes the `FindData` class as a parameter."},{"content":"The parameter must be declared with the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.InAttribute&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.OutAttribute&gt;</ph> attributes because classes, which are reference types, are passed as In parameters by default.","pos":[9712,9951],"source":" The parameter must be declared with the <xref:System.Runtime.InteropServices.InAttribute> and <xref:System.Runtime.InteropServices.OutAttribute> attributes because classes, which are reference types, are passed as In parameters by default."},{"pos":[9961,9981],"content":"Declaring Prototypes","linkify":"Declaring Prototypes","nodes":[{"content":"Declaring Prototypes","pos":[0,20]}]},{"pos":[10434,10451],"content":"Calling Functions","linkify":"Calling Functions","nodes":[{"content":"Calling Functions","pos":[0,17]}]},{"pos":[10903,10916],"content":"Unions sample","linkify":"Unions sample","nodes":[{"content":"Unions sample","pos":[0,13]}]},{"content":"This sample demonstrates how to pass structures containing only value types, and structures containing a value type and a string as parameters to an unmanaged function expecting a union.","pos":[10920,11106]},{"content":"A union represents a memory location that can be shared by two or more variables.","pos":[11107,11188]},{"content":"The Unions sample uses the following unmanaged function, shown with its original function declaration:","pos":[11195,11297]},{"pos":[11307,11350],"content":"<bpt id=\"p1\">**</bpt>TestUnion<ept id=\"p1\">**</ept> exported from PinvokeLib.dll.","source":"**TestUnion** exported from PinvokeLib.dll."},{"content":"<bpt id=\"p1\">[</bpt>PinvokeLib.dll<ept id=\"p1\">](marshaling-data-with-platform-invoke.md#pinvokelibdll)</ept> is a custom unmanaged library that contains an implementation for the previously listed function and two unions, <bpt id=\"p2\">**</bpt>MYUNION<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>MYUNION2<ept id=\"p3\">**</ept>.","pos":[11423,11637],"source":"[PinvokeLib.dll](marshaling-data-with-platform-invoke.md#pinvokelibdll) is a custom unmanaged library that contains an implementation for the previously listed function and two unions, **MYUNION** and **MYUNION2**."},{"content":"The unions contain the following elements:","pos":[11638,11680]},{"content":"In managed code, unions are defined as structures.","pos":[11823,11873]},{"content":"The <ph id=\"ph1\">`MyUnion`</ph> structure contains two value types as its members: an integer and a double.","pos":[11874,11963],"source":" The `MyUnion` structure contains two value types as its members: an integer and a double."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.StructLayoutAttribute&gt;</ph> attribute is set to control the precise position of each data member.","pos":[11964,12097],"source":" The <xref:System.Runtime.InteropServices.StructLayoutAttribute> attribute is set to control the precise position of each data member."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.FieldOffsetAttribute&gt;</ph> attribute provides the physical position of fields within the unmanaged representation of a union.","pos":[12098,12259],"source":" The <xref:System.Runtime.InteropServices.FieldOffsetAttribute> attribute provides the physical position of fields within the unmanaged representation of a union."},{"content":"Notice that both members have the same offset values, so the members can define the same piece of memory.","pos":[12260,12365]},{"content":"<ph id=\"ph1\">`MyUnion2_1`</ph> and <ph id=\"ph2\">`MyUnion2_2`</ph> contain a value type (integer) and a string, respectively.","pos":[12372,12460],"source":"`MyUnion2_1` and `MyUnion2_2` contain a value type (integer) and a string, respectively."},{"content":"In managed code, value types and reference types are not permitted to overlap.","pos":[12461,12539]},{"content":"This sample uses method overloading to enable the caller to use both types when calling the same unmanaged function.","pos":[12540,12656]},{"content":"The layout of <ph id=\"ph1\">`MyUnion2_1`</ph> is explicit and has a precise offset value.","pos":[12657,12727],"source":" The layout of `MyUnion2_1` is explicit and has a precise offset value."},{"content":"In contrast, <ph id=\"ph1\">`MyUnion2_2`</ph> has a sequential layout, because explicit layouts are not permitted with reference types.","pos":[12728,12843],"source":" In contrast, `MyUnion2_2` has a sequential layout, because explicit layouts are not permitted with reference types."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.MarshalAsAttribute&gt;</ph> attribute sets the <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.UnmanagedType&gt;</ph> enumeration to <bpt id=\"p1\">**</bpt>ByValTStr<ept id=\"p1\">**</ept>, which is used to identify the inline, fixed-length character arrays that appear within the unmanaged representation of the union.","pos":[12844,13135],"source":" The <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute sets the <xref:System.Runtime.InteropServices.UnmanagedType> enumeration to **ByValTStr**, which is used to identify the inline, fixed-length character arrays that appear within the unmanaged representation of the union."},{"content":"The <ph id=\"ph1\">`LibWrap`</ph> class contains the prototypes for the <ph id=\"ph2\">`TestUnion`</ph> and <ph id=\"ph3\">`TestUnion2`</ph> methods.","pos":[13142,13231],"source":"The `LibWrap` class contains the prototypes for the `TestUnion` and `TestUnion2` methods."},{"content":"<ph id=\"ph1\">`TestUnion2`</ph> is overloaded to declare <ph id=\"ph2\">`MyUnion2_1`</ph> or <ph id=\"ph3\">`MyUnion2_2`</ph> as parameters.","pos":[13232,13313],"source":"`TestUnion2` is overloaded to declare `MyUnion2_1` or `MyUnion2_2` as parameters."},{"pos":[13323,13343],"content":"Declaring Prototypes","linkify":"Declaring Prototypes","nodes":[{"content":"Declaring Prototypes","pos":[0,20]}]},{"pos":[13790,13807],"content":"Calling Functions","linkify":"Calling Functions","nodes":[{"content":"Calling Functions","pos":[0,17]}]},{"pos":[14253,14267],"content":"SysTime sample","linkify":"SysTime sample","nodes":[{"content":"SysTime sample","pos":[0,14]}]},{"content":"This sample demonstrates how to pass a pointer to a class to an unmanaged function that expects a pointer to a structure.","pos":[14271,14392]},{"content":"The SysTime sample uses the following unmanaged function, shown with its original function declaration:","pos":[14399,14502]},{"pos":[14512,14557],"content":"<bpt id=\"p1\">**</bpt>GetSystemTime<ept id=\"p1\">**</ept> exported from Kernel32.dll.","source":"**GetSystemTime** exported from Kernel32.dll."},{"content":"The original structure passed to the function contains the following elements:","pos":[14640,14718]},{"content":"In this sample, the <ph id=\"ph1\">`SystemTime`</ph> class contains the elements of the original structure represented as class members.","pos":[14971,15087],"source":"In this sample, the `SystemTime` class contains the elements of the original structure represented as class members."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.StructLayoutAttribute&gt;</ph> attribute is set to ensure that the members are arranged in memory sequentially, in the order in which they appear.","pos":[15088,15267],"source":" The <xref:System.Runtime.InteropServices.StructLayoutAttribute> attribute is set to ensure that the members are arranged in memory sequentially, in the order in which they appear."},{"content":"The <ph id=\"ph1\">`LibWrap`</ph> class contains a managed prototype of the <ph id=\"ph2\">`GetSystemTime`</ph> method, which passes the <ph id=\"ph3\">`SystemTime`</ph> class as an In/Out parameter by default.","pos":[15274,15424],"source":"The `LibWrap` class contains a managed prototype of the `GetSystemTime` method, which passes the `SystemTime` class as an In/Out parameter by default."},{"content":"The parameter must be declared with the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.InAttribute&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.OutAttribute&gt;</ph> attributes because classes, which are reference types, are passed as In parameters by default.","pos":[15425,15664],"source":" The parameter must be declared with the <xref:System.Runtime.InteropServices.InAttribute> and <xref:System.Runtime.InteropServices.OutAttribute> attributes because classes, which are reference types, are passed as In parameters by default."},{"content":"For the caller to receive the results, these <bpt id=\"p1\">[</bpt>directional attributes<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</ept> must be applied explicitly.","pos":[15665,15851],"source":" For the caller to receive the results, these [directional attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100)) must be applied explicitly."},{"content":"The <ph id=\"ph1\">`App`</ph> class creates a new instance of the <ph id=\"ph2\">`SystemTime`</ph> class and accesses its data fields.","pos":[15852,15946],"source":" The `App` class creates a new instance of the `SystemTime` class and accesses its data fields."},{"pos":[15956,15968],"content":"Code Samples","linkify":"Code Samples","nodes":[{"content":"Code Samples","pos":[0,12]}]},{"pos":[16417,16441],"content":"OutArrayOfStructs sample","linkify":"OutArrayOfStructs sample","nodes":[{"content":"OutArrayOfStructs sample","pos":[0,24]}]},{"content":"This sample shows how to pass an array of structures that contains integers and strings as Out parameters to an unmanaged function.","pos":[16445,16576]},{"pos":[16583,16728],"content":"This sample demonstrates how to call a native function by using the <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.Marshal&gt;</ph> class and by using unsafe code.","source":"This sample demonstrates how to call a native function by using the <xref:System.Runtime.InteropServices.Marshal> class and by using unsafe code."},{"content":"This sample uses a wrapper functions and platform invokes defined in <bpt id=\"p1\">[</bpt>PinvokeLib.dll<ept id=\"p1\">](marshaling-data-with-platform-invoke.md#pinvokelibdll)</ept>, also provided in the source files.","pos":[16735,16911],"source":"This sample uses a wrapper functions and platform invokes defined in [PinvokeLib.dll](marshaling-data-with-platform-invoke.md#pinvokelibdll), also provided in the source files."},{"content":"It uses the <ph id=\"ph1\">`TestOutArrayOfStructs`</ph> function and the <ph id=\"ph2\">`MYSTRSTRUCT2`</ph> structure.","pos":[16912,16990],"source":" It uses the `TestOutArrayOfStructs` function and the `MYSTRSTRUCT2` structure."},{"content":"The structure contains the following elements:","pos":[16991,17037]},{"content":"The <ph id=\"ph1\">`MyStruct`</ph> class contains a string object of ANSI characters.","pos":[17148,17213],"source":"The `MyStruct` class contains a string object of ANSI characters."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.DllImportAttribute.CharSet&gt;</ph> field specifies ANSI format.","pos":[17214,17311],"source":" The <xref:System.Runtime.InteropServices.DllImportAttribute.CharSet> field specifies ANSI format."},{"content":"<ph id=\"ph1\">`MyUnsafeStruct`</ph>, is a structure containing an <ph id=\"ph2\">&lt;xref:System.IntPtr&gt;</ph> type instead of a string.","pos":[17312,17405],"source":"`MyUnsafeStruct`, is a structure containing an <xref:System.IntPtr> type instead of a string."},{"content":"The <ph id=\"ph1\">`LibWrap`</ph> class contains the overloaded <ph id=\"ph2\">`TestOutArrayOfStructs`</ph> prototype method.","pos":[17412,17497],"source":"The `LibWrap` class contains the overloaded `TestOutArrayOfStructs` prototype method."},{"content":"If a method declares a pointer as a parameter, the class should be marked with the <ph id=\"ph1\">`unsafe`</ph> keyword.","pos":[17498,17598],"source":" If a method declares a pointer as a parameter, the class should be marked with the `unsafe` keyword."},{"content":"Because <ph id=\"ph1\">[!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)]</ph> cannot use unsafe code, the overloaded method, unsafe modifier, and the <ph id=\"ph2\">`MyUnsafeStruct`</ph> structure are unnecessary.","pos":[17599,17781],"source":" Because [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] cannot use unsafe code, the overloaded method, unsafe modifier, and the `MyUnsafeStruct` structure are unnecessary."},{"content":"The <ph id=\"ph1\">`App`</ph> class implements the <ph id=\"ph2\">`UsingMarshaling`</ph> method, which performs all the tasks necessary to pass the array.","pos":[17788,17902],"source":"The `App` class implements the `UsingMarshaling` method, which performs all the tasks necessary to pass the array."},{"content":"The array is marked with the <ph id=\"ph1\">`out`</ph> (<ph id=\"ph2\">`ByRef`</ph> in Visual Basic) keyword to indicate that data passes from callee to caller.","pos":[17903,18023],"source":" The array is marked with the `out` (`ByRef` in Visual Basic) keyword to indicate that data passes from callee to caller."},{"content":"The implementation uses the following <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.Marshal&gt;</ph> class methods:","pos":[18024,18122],"source":" The implementation uses the following <xref:System.Runtime.InteropServices.Marshal> class methods:"},{"pos":[18132,18258],"content":"<ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.Marshal.PtrToStructure%2A&gt;</ph> to marshal data from the unmanaged buffer to a managed object.","source":"<xref:System.Runtime.InteropServices.Marshal.PtrToStructure%2A> to marshal data from the unmanaged buffer to a managed object."},{"pos":[18268,18394],"content":"<ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.Marshal.DestroyStructure%2A&gt;</ph> to release the memory reserved for strings in the structure.","source":"<xref:System.Runtime.InteropServices.Marshal.DestroyStructure%2A> to release the memory reserved for strings in the structure."},{"pos":[18404,18512],"content":"<ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.Marshal.FreeCoTaskMem%2A&gt;</ph> to release the memory reserved for the array.","source":"<xref:System.Runtime.InteropServices.Marshal.FreeCoTaskMem%2A> to release the memory reserved for the array."},{"content":"As previously mentioned, C# allows unsafe code and <ph id=\"ph1\">[!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)]</ph> does not.","pos":[18519,18638],"source":"As previously mentioned, C# allows unsafe code and [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] does not."},{"content":"In the C# sample, <ph id=\"ph1\">`UsingUnsafePointer`</ph> is an alternative method implementation that uses pointers instead of the <ph id=\"ph2\">&lt;xref:System.Runtime.InteropServices.Marshal&gt;</ph> class to pass back the array containing the <ph id=\"ph3\">`MyUnsafeStruct`</ph> structure.","pos":[18639,18869],"source":" In the C# sample, `UsingUnsafePointer` is an alternative method implementation that uses pointers instead of the <xref:System.Runtime.InteropServices.Marshal> class to pass back the array containing the `MyUnsafeStruct` structure."},{"pos":[18879,18899],"content":"Declaring Prototypes","linkify":"Declaring Prototypes","nodes":[{"content":"Declaring Prototypes","pos":[0,20]}]},{"pos":[19379,19396],"content":"Calling Functions","linkify":"Calling Functions","nodes":[{"content":"Calling Functions","pos":[0,17]}]},{"pos":[19875,19883],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[19887,19966],"content":"<bpt id=\"p1\">[</bpt>Marshaling Data with Platform Invoke<ept id=\"p1\">](marshaling-data-with-platform-invoke.md)</ept>","source":"[Marshaling Data with Platform Invoke](marshaling-data-with-platform-invoke.md)"},{"pos":[19969,20012],"content":"<bpt id=\"p1\">[</bpt>Marshaling Strings<ept id=\"p1\">](marshaling-strings.md)</ept>","source":"[Marshaling Strings](marshaling-strings.md)"},{"pos":[20015,20094],"content":"<bpt id=\"p1\">[</bpt>Marshaling Different Types of Arrays<ept id=\"p1\">](marshaling-different-types-of-arrays.md)</ept>","source":"[Marshaling Different Types of Arrays](marshaling-different-types-of-arrays.md)"}]}