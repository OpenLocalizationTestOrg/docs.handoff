{"content":"---\ntitle: \"Signing Stored Procedures in SQL Server\"\nms.date: \"01/05/2018\"\nms.assetid: eeed752c-0084-48e5-9dca-381353007a0d\n---\n# Signing Stored Procedures in SQL Server\n A digital signature is a data digest encrypted with the private key of the signer. The private key ensures that the digital signature is unique to its bearer or owner. You can sign stored procedures, functions (except for inline table-valued functions), triggers, and assemblies.  \n  \n You can sign a stored procedure with a certificate or an asymmetric key. This is designed for scenarios when permissions cannot be inherited through ownership chaining or when the ownership chain is broken, such as dynamic SQL. You can then create a user mapped to the certificate, granting the certificate user permissions on the objects the stored procedure needs to access.  \n\n You can also create a login mapped to the same certificate, and then grant any necessary server-level permissions to that login, or add the login to one or more of the fixed server roles. This is designed to avoid enabling the `TRUSTWORTHY` database setting for scenarios in which higher level permissions are needed.  \n  \n When the stored procedure is executed, SQL Server combines the permissions of the certificate user and/or login with those of the caller. Unlike the `EXECUTE AS` clause, it does not change the execution context of the procedure. Built-in functions that return login and user names return the name of the caller, not the certificate user name.  \n  \n## Creating Certificates  \n When you sign a stored procedure with a certificate or asymmetric key, a data digest consisting of the encrypted hash of the stored procedure code, along with the execute-as user, is created using the private key. At run time, the data digest is decrypted with the public key and compared with the hash value of the stored procedure. Changing the execute-as user invalidates the hash value so that the digital signature no longer matches. Modifying the stored procedure drops the signature entirely, which prevents someone who does not have access to the private key from changing the stored procedure code. In either case, you must re-sign the procedure each time you change the code or the execute-as user.  \n  \n There are two required steps involved in signing a module:  \n  \n1.  Create a certificate using the Transact-SQL `CREATE CERTIFICATE [certificateName]` statement. This statement has several options for setting a start and end date and a password. The default expiration date is one year.  \n  \n1.  Sign the procedure with the certificate using the Transact-SQL `ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]` statement.  \n\nOnce the module has been signed, one or more principals needs to be created in order to hold the additional permissions that should be associated with the certificate.  \n\nIf the module needs additional database-level permissions:  \n  \n1.  Create a database user associated with that certificate using the Transact-SQL `CREATE USER [userName] FROM CERTIFICATE [certificateName]` statement. This user exists in the database only and is not associated with a login unless a login has also been created from that same certificate.  \n  \n1.  Grant the certificate user the required database-level permissions.  \n  \nIf the module needs additional server-level permissions:  \n  \n1.  Copy the certificate to the `master` database.  \n \n1.  Create a login associated with that certificate using the Transact-SQL `CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]` statement.  \n  \n1.  Grant the certificate login the required server-level permissions.  \n  \n> [!NOTE]  \n>  A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement. DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.  \n  \n## External Resources  \n For more information, see the following resources.  \n  \n|Resource|Description|  \n|--------------|-----------------|  \n|[Module Signing](https://go.microsoft.com/fwlink/?LinkId=98590) in SQL Server Books Online|Describes module signing, providing a sample scenario and links to the relevant Transact-SQL topics.|  \n|[Signing Stored Procedures with a Certificate](/sql/relational-databases/tutorial-signing-stored-procedures-with-a-certificate) in SQL Server Books Online|Provides a tutorial for signing a stored procedure with a certificate.|  \n  \n## See also\n\n- [Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)\n- [Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)\n- [Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)\n- [Managing Permissions with Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)\n- [Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)\n- [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)\n- [Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)\n- [ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)\n","nodes":[{"pos":[4,123],"embed":true,"restype":"x-metadata","content":"title: \"Signing Stored Procedures in SQL Server\"\nms.date: \"01/05/2018\"\nms.assetid: eeed752c-0084-48e5-9dca-381353007a0d","nodes":[{"content":"Signing Stored Procedures in SQL Server","nodes":[{"pos":[0,39],"content":"Signing Stored Procedures in SQL Server","nodes":[{"content":"Signing Stored Procedures in SQL Server","pos":[0,39]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[130,169],"content":"Signing Stored Procedures in SQL Server","linkify":"Signing Stored Procedures in SQL Server","nodes":[{"content":"Signing Stored Procedures in SQL Server","pos":[0,39]}]},{"content":"A digital signature is a data digest encrypted with the private key of the signer.","pos":[171,253]},{"content":"The private key ensures that the digital signature is unique to its bearer or owner.","pos":[254,338]},{"content":"You can sign stored procedures, functions (except for inline table-valued functions), triggers, and assemblies.","pos":[339,450]},{"content":"You can sign a stored procedure with a certificate or an asymmetric key.","pos":[457,529]},{"content":"This is designed for scenarios when permissions cannot be inherited through ownership chaining or when the ownership chain is broken, such as dynamic SQL.","pos":[530,684]},{"content":"You can then create a user mapped to the certificate, granting the certificate user permissions on the objects the stored procedure needs to access.","pos":[685,833]},{"content":"You can also create a login mapped to the same certificate, and then grant any necessary server-level permissions to that login, or add the login to one or more of the fixed server roles.","pos":[838,1025]},{"content":"This is designed to avoid enabling the <ph id=\"ph1\">`TRUSTWORTHY`</ph> database setting for scenarios in which higher level permissions are needed.","pos":[1026,1155],"source":" This is designed to avoid enabling the `TRUSTWORTHY` database setting for scenarios in which higher level permissions are needed."},{"content":"When the stored procedure is executed, SQL Server combines the permissions of the certificate user and/or login with those of the caller.","pos":[1162,1299]},{"content":"Unlike the <ph id=\"ph1\">`EXECUTE AS`</ph> clause, it does not change the execution context of the procedure.","pos":[1300,1390],"source":" Unlike the `EXECUTE AS` clause, it does not change the execution context of the procedure."},{"content":"Built-in functions that return login and user names return the name of the caller, not the certificate user name.","pos":[1391,1504]},{"pos":[1513,1534],"content":"Creating Certificates","linkify":"Creating Certificates","nodes":[{"content":"Creating Certificates","pos":[0,21]}]},{"content":"When you sign a stored procedure with a certificate or asymmetric key, a data digest consisting of the encrypted hash of the stored procedure code, along with the execute-as user, is created using the private key.","pos":[1538,1751]},{"content":"At run time, the data digest is decrypted with the public key and compared with the hash value of the stored procedure.","pos":[1752,1871]},{"content":"Changing the execute-as user invalidates the hash value so that the digital signature no longer matches.","pos":[1872,1976]},{"content":"Modifying the stored procedure drops the signature entirely, which prevents someone who does not have access to the private key from changing the stored procedure code.","pos":[1977,2145]},{"content":"In either case, you must re-sign the procedure each time you change the code or the execute-as user.","pos":[2146,2246]},{"content":"There are two required steps involved in signing a module:","pos":[2253,2311]},{"content":"Create a certificate using the Transact-SQL <ph id=\"ph1\">`CREATE CERTIFICATE [certificateName]`</ph> statement.","pos":[2321,2414],"source":"Create a certificate using the Transact-SQL `CREATE CERTIFICATE [certificateName]` statement."},{"content":"This statement has several options for setting a start and end date and a password.","pos":[2415,2498]},{"content":"The default expiration date is one year.","pos":[2499,2539]},{"pos":[2549,2690],"content":"Sign the procedure with the certificate using the Transact-SQL <ph id=\"ph1\">`ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]`</ph> statement.","source":"Sign the procedure with the certificate using the Transact-SQL `ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]` statement."},{"content":"Once the module has been signed, one or more principals needs to be created in order to hold the additional permissions that should be associated with the certificate.","pos":[2694,2861]},{"content":"If the module needs additional database-level permissions:","pos":[2865,2923]},{"content":"Create a database user associated with that certificate using the Transact-SQL <ph id=\"ph1\">`CREATE USER [userName] FROM CERTIFICATE [certificateName]`</ph> statement.","pos":[2933,3082],"source":"Create a database user associated with that certificate using the Transact-SQL `CREATE USER [userName] FROM CERTIFICATE [certificateName]` statement."},{"content":"This user exists in the database only and is not associated with a login unless a login has also been created from that same certificate.","pos":[3083,3220]},{"content":"Grant the certificate user the required database-level permissions.","pos":[3230,3297]},{"content":"If the module needs additional server-level permissions:","pos":[3303,3359]},{"pos":[3369,3415],"content":"Copy the certificate to the <ph id=\"ph1\">`master`</ph> database.","source":"Copy the certificate to the `master` database."},{"pos":[3424,3566],"content":"Create a login associated with that certificate using the Transact-SQL <ph id=\"ph1\">`CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]`</ph> statement.","source":"Create a login associated with that certificate using the Transact-SQL `CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]` statement."},{"content":"Grant the certificate login the required server-level permissions.","pos":[3576,3642]},{"pos":[3650,3894],"content":"[!NOTE]  \n A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement. DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.","leadings":["","> "],"nodes":[{"content":"A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement. DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.","pos":[11,242],"nodes":[{"content":"A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement.","pos":[0,107]},{"content":"DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.","pos":[108,231]}]}]},{"pos":[3903,3921],"content":"External Resources","linkify":"External Resources","nodes":[{"content":"External Resources","pos":[0,18]}]},{"content":"For more information, see the following resources.","pos":[3925,3975]},{"content":"Resource","pos":[3982,3990]},{"content":"Description","pos":[3991,4002]},{"pos":[4044,4134],"content":"<bpt id=\"p1\">[</bpt>Module Signing<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=98590)</ept> in SQL Server Books Online","source":"[Module Signing](https://go.microsoft.com/fwlink/?LinkId=98590) in SQL Server Books Online"},{"content":"Describes module signing, providing a sample scenario and links to the relevant Transact-SQL topics.","pos":[4135,4235]},{"pos":[4240,4394],"content":"<bpt id=\"p1\">[</bpt>Signing Stored Procedures with a Certificate<ept id=\"p1\">](/sql/relational-databases/tutorial-signing-stored-procedures-with-a-certificate)</ept> in SQL Server Books Online","source":"[Signing Stored Procedures with a Certificate](/sql/relational-databases/tutorial-signing-stored-procedures-with-a-certificate) in SQL Server Books Online"},{"content":"Provides a tutorial for signing a stored procedure with a certificate.","pos":[4395,4465]},{"pos":[4475,4483],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[4487,4594],"content":"<bpt id=\"p1\">[</bpt>Securing ADO.NET Applications<ept id=\"p1\">](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</ept>","source":"[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)"},{"pos":[4597,4712],"content":"<bpt id=\"p1\">[</bpt>Overview of SQL Server Security<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)</ept>","source":"[Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)"},{"pos":[4715,4856],"content":"<bpt id=\"p1\">[</bpt>Application Security Scenarios in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)</ept>","source":"[Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)"},{"pos":[4859,5026],"content":"<bpt id=\"p1\">[</bpt>Managing Permissions with Stored Procedures in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)</ept>","source":"[Managing Permissions with Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)"},{"pos":[5029,5162],"content":"<bpt id=\"p1\">[</bpt>Writing Secure Dynamic SQL in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)</ept>","source":"[Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)"},{"pos":[5165,5330],"content":"<bpt id=\"p1\">[</bpt>Customizing Permissions with Impersonation in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)</ept>","source":"[Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)"},{"pos":[5333,5456],"content":"<bpt id=\"p1\">[</bpt>Modifying Data with Stored Procedures<ept id=\"p1\">](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)</ept>","source":"[Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)"},{"pos":[5459,5563],"content":"<bpt id=\"p1\">[</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=217917)</ept>","source":"[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)"}]}