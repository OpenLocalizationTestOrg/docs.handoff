{"content":"---\ntitle: \"Persistence Participants\"\nms.date: \"03/30/2017\"\nms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3\n---\n# Persistence Participants\nA persistence participant can participate in a persistence operation (Save or Load) triggered by an application host. The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant. A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> . The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.  \n  \n The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation. The persistence participants are used in the third and fourth stages. If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.  \n  \n1.  Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.  \n  \n2.  Gathers all persistence participants that were added to the extension collection associated with the workflow instance.  \n  \n3.  Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants.  \n  \n4.  Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants.  \n  \n5.  Persist or save the workflow into the persistence store.  \n  \n6.  Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants. If the participant is not an I/O participant, this task is skipped. If the persistence episode is transactional, the transaction is provided in Transaction.Current property.  \n  \n7.  Waits for all persistence participants to complete. If all the participants succeed in persisting instance data, commits the transaction.  \n  \n A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods. A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods.  \n  \n Each stage is completed before the next stage begins. For example, values are collected from **all** persistence participants in the first stage. Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping. Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.  \n  \n The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation. The persistence participants are used in the fourth stage. The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.  \n  \n1.  Gathers all persistence participants that were added to the extension collection associated with the workflow instance.  \n  \n2.  Loads the workflow from the persistence store.  \n  \n3.  Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete. If the persistence episode is transactional, the transaction is provided in Transaction.Current.  \n  \n4.  Loads the workflow instance in memory based on the data retrieved from the persistence store.  \n  \n5.  Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant.  \n  \n A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method. A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method.  \n  \n When loading a workflow instance the persistence provider creates a lock on that instance. This prevents the instance from being loaded by more than one host in a multi-node scenario. If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception \" System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired\". This error is caused when one of the following occurs:  \n  \n-   In a multi-node scenario the instance is loaded by another host.  There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.  \n  \n-   In a single-node scenario and the host crashed.  When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.  \n  \n-   In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.  \n  \n The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.  \n  \n## In This Section  \n  \n-   [How to: Create a Custom Persistence Participant](how-to-create-a-custom-persistence-participant.md)  \n  \n## See also\n\n- [Store Extensibility](store-extensibility.md)\n","nodes":[{"pos":[4,108],"embed":true,"restype":"x-metadata","content":"title: \"Persistence Participants\"\nms.date: \"03/30/2017\"\nms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3","nodes":[{"content":"Persistence Participants","nodes":[{"pos":[0,24],"content":"Persistence Participants","nodes":[{"content":"Persistence Participants","pos":[0,24]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[115,139],"content":"Persistence Participants","linkify":"Persistence Participants","nodes":[{"content":"Persistence Participants","pos":[0,24]}]},{"content":"A persistence participant can participate in a persistence operation (Save or Load) triggered by an application host.","pos":[140,257]},{"content":"The <ph id=\"ph1\">[!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)]</ph> ships with two abstract classes, <bpt id=\"p1\">**</bpt>PersistenceParticipant<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>PersistenceIOParticipant<ept id=\"p2\">**</ept>, which you can use to create a persistence participant.","pos":[258,485],"source":" The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant."},{"content":"A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A&gt;</ph> collection on the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> .","pos":[486,786],"source":" A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> ."},{"content":"The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.","pos":[787,966]},{"content":"The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation.","pos":[973,1103]},{"content":"The persistence participants are used in the third and fourth stages.","pos":[1104,1173]},{"content":"If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.","pos":[1174,1333]},{"content":"Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.","pos":[1343,1437]},{"content":"Gathers all persistence participants that were added to the extension collection associated with the workflow instance.","pos":[1447,1566]},{"pos":[1576,1716],"content":"Invokes the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A&gt;</ph> method implemented by all persistence participants.","source":"Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants."},{"pos":[1726,1862],"content":"Invokes the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A&gt;</ph> method implemented by all persistence participants.","source":"Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants."},{"content":"Persist or save the workflow into the persistence store.","pos":[1872,1928]},{"content":"Invokes the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A&gt;</ph> method on all of the persistence I/O participants.","pos":[1938,2077],"source":"Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants."},{"content":"If the participant is not an I/O participant, this task is skipped.","pos":[2078,2145]},{"content":"If the persistence episode is transactional, the transaction is provided in Transaction.Current property.","pos":[2146,2251]},{"content":"Waits for all persistence participants to complete.","pos":[2261,2312]},{"content":"If all the participants succeed in persisting instance data, commits the transaction.","pos":[2313,2398]},{"content":"A persistence participant derives from the <bpt id=\"p1\">**</bpt>PersistenceParticipant<ept id=\"p1\">**</ept> class and may implement the <bpt id=\"p2\">**</bpt>CollectValues<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>MapValues<ept id=\"p3\">**</ept> methods.","pos":[2405,2547],"source":"A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods."},{"content":"A persistence I/O participant derives from the <bpt id=\"p1\">**</bpt>PersistenceIOParticipant<ept id=\"p1\">**</ept> class and may implement the <bpt id=\"p2\">**</bpt>BeginOnSave<ept id=\"p2\">**</ept> method in addition to implementing the <bpt id=\"p3\">**</bpt>CollectValues<ept id=\"p3\">**</ept> and <bpt id=\"p4\">**</bpt>MapValues<ept id=\"p4\">**</ept> methods.","pos":[2548,2751],"source":" A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods."},{"content":"Each stage is completed before the next stage begins.","pos":[2758,2811]},{"content":"For example, values are collected from <bpt id=\"p1\">**</bpt>all<ept id=\"p1\">**</ept> persistence participants in the first stage.","pos":[2812,2903],"source":" For example, values are collected from **all** persistence participants in the first stage."},{"content":"Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping.","pos":[2904,3030]},{"content":"Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.","pos":[3031,3174]},{"content":"The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation.","pos":[3181,3301]},{"content":"The persistence participants are used in the fourth stage.","pos":[3302,3360]},{"content":"The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.","pos":[3361,3494]},{"content":"Gathers all persistence participants that were added to the extension collection associated with the workflow instance.","pos":[3504,3623]},{"content":"Loads the workflow from the persistence store.","pos":[3633,3679]},{"content":"Invokes the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A&gt;</ph> on all persistence I/O participants and waits for all the persistence participants to complete.","pos":[3689,3873],"source":"Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete."},{"content":"If the persistence episode is transactional, the transaction is provided in Transaction.Current.","pos":[3874,3970]},{"content":"Loads the workflow instance in memory based on the data retrieved from the persistence store.","pos":[3980,4073]},{"pos":[4083,4200],"content":"Invokes <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A&gt;</ph> on each persistence participant.","source":"Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant."},{"content":"A persistence participant derives from the <bpt id=\"p1\">**</bpt>PersistenceParticipant<ept id=\"p1\">**</ept> class and may implement the <bpt id=\"p2\">**</bpt>PublishValues<ept id=\"p2\">**</ept> method.","pos":[4207,4330],"source":"A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method."},{"content":"A persistence I/O participant derives from the <bpt id=\"p1\">**</bpt>PersistenceIOParticipant<ept id=\"p1\">**</ept> class and may implement the <bpt id=\"p2\">**</bpt>BeginOnLoad<ept id=\"p2\">**</ept> method in addition to implementing the <bpt id=\"p3\">**</bpt>PublishValues<ept id=\"p3\">**</ept> method.","pos":[4331,4515],"source":" A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method."},{"content":"When loading a workflow instance the persistence provider creates a lock on that instance.","pos":[4522,4612]},{"content":"This prevents the instance from being loaded by more than one host in a multi-node scenario.","pos":[4613,4705]},{"content":"If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception \" System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired\".","pos":[4706,5022]},{"content":"This error is caused when one of the following occurs:","pos":[5023,5077]},{"content":"In a multi-node scenario the instance is loaded by another host.","pos":[5087,5151]},{"content":"There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.","pos":[5153,5369]},{"content":"In a single-node scenario and the host crashed.","pos":[5379,5426]},{"content":"When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.","pos":[5428,5641]},{"content":"In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.","pos":[5651,5813]},{"pos":[5820,5999],"content":"The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <ph id=\"ph1\">&lt;xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A&gt;</ph>.","source":"The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>."},{"pos":[6008,6023],"content":"In This Section","linkify":"In This Section","nodes":[{"content":"In This Section","pos":[0,15]}]},{"pos":[6033,6133],"content":"<bpt id=\"p1\">[</bpt>How to: Create a Custom Persistence Participant<ept id=\"p1\">](how-to-create-a-custom-persistence-participant.md)</ept>","source":"[How to: Create a Custom Persistence Participant](how-to-create-a-custom-persistence-participant.md)"},{"pos":[6142,6150],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6154,6199],"content":"<bpt id=\"p1\">[</bpt>Store Extensibility<ept id=\"p1\">](store-extensibility.md)</ept>","source":"[Store Extensibility](store-extensibility.md)"}]}