{"content":"---\ntitle: \"Expression Trees (Visual Basic)\"\nms.date: 07/20/2015\nms.assetid: 8bbbb02d-7ffc-476b-8c25-118d82bf5d46\n---\n# Expression Trees (Visual Basic)\nExpression trees represent code in a tree-like data structure, where each node is an expression, for example, a method call or a binary operation such as `x < y`.  \n  \n You can compile and run code represented by expression trees. This enables dynamic modification of executable code, the execution of LINQ queries in various databases, and the creation of dynamic queries. For more information about expression trees in LINQ, see [How to: Use Expression Trees to Build Dynamic Queries (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-use-expression-trees-to-build-dynamic-queries.md).  \n  \n Expression trees are also used in the dynamic language runtime (DLR) to provide interoperability between dynamic languages and the .NET Framework and to enable compiler writers to emit expression trees instead of Microsoft intermediate language (MSIL). For more information about the DLR, see [Dynamic Language Runtime Overview](../../../../framework/reflection-and-codedom/dynamic-language-runtime-overview.md).  \n  \n You can have the C# or Visual Basic compiler create an expression tree for you based on an anonymous lambda expression, or you can create expression trees manually by using the <xref:System.Linq.Expressions> namespace.  \n  \n## Creating Expression Trees from Lambda Expressions  \n When a lambda expression is assigned to a variable of type <xref:System.Linq.Expressions.Expression%601>, the compiler emits code to build an expression tree that represents the lambda expression.  \n  \n The Visual Basic compiler can generate expression trees only from expression lambdas (or single-line lambdas). It cannot parse statement lambdas (or multi-line lambdas). For more information about lambda expressions in Visual Basic, see [Lambda Expressions](../../../../visual-basic/programming-guide/language-features/procedures/lambda-expressions.md).  \n  \n The following code examples demonstrate how to have the Visual Basic compiler create an expression tree that represents the lambda expression `Function(num) num < 5`.  \n  \n```vb  \nDim lambda As Expression(Of Func(Of Integer, Boolean)) =  \n    Function(num) num < 5  \n```  \n  \n## Creating Expression Trees by Using the API  \n To create expression trees by using the API, use the <xref:System.Linq.Expressions.Expression> class. This class contains static factory methods that create expression tree nodes of specific types, for example, <xref:System.Linq.Expressions.ParameterExpression>, which represents a variable or parameter, or <xref:System.Linq.Expressions.MethodCallExpression>, which represents a method call. <xref:System.Linq.Expressions.ParameterExpression>, <xref:System.Linq.Expressions.MethodCallExpression>, and the other expression-specific types are also defined in the <xref:System.Linq.Expressions> namespace. These types derive from the abstract type <xref:System.Linq.Expressions.Expression>.  \n  \n The following code example demonstrates how to create an expression tree that represents the lambda expression `Function(num) num < 5` by using the API.  \n  \n```vb  \n' Import the following namespace to your project: System.Linq.Expressions  \n  \n' Manually build the expression tree for the lambda expression num => num < 5.  \nDim numParam As ParameterExpression = Expression.Parameter(GetType(Integer), \"num\")  \nDim five As ConstantExpression = Expression.Constant(5, GetType(Integer))  \nDim numLessThanFive As BinaryExpression = Expression.LessThan(numParam, five)  \nDim lambda1 As Expression(Of Func(Of Integer, Boolean)) =  \n  Expression.Lambda(Of Func(Of Integer, Boolean))(  \n        numLessThanFive,  \n        New ParameterExpression() {numParam})  \n```  \n  \n In .NET Framework 4 or later, the expression trees API also supports assignments and control flow expressions such as loops, conditional blocks, and `try-catch` blocks. By using the API, you can create expression trees that are more complex than those that can be created from lambda expressions by the Visual Basic compiler. The following example demonstrates how to create an expression tree that calculates the factorial of a number.  \n  \n```vb  \n' Creating a parameter expression.  \nDim value As ParameterExpression =  \n    Expression.Parameter(GetType(Integer), \"value\")  \n  \n' Creating an expression to hold a local variable.   \nDim result As ParameterExpression =  \n    Expression.Parameter(GetType(Integer), \"result\")  \n  \n' Creating a label to jump to from a loop.  \nDim label As LabelTarget = Expression.Label(GetType(Integer))  \n  \n' Creating a method body.  \nDim block As BlockExpression = Expression.Block(  \n    New ParameterExpression() {result},  \n    Expression.Assign(result, Expression.Constant(1)),  \n    Expression.Loop(  \n        Expression.IfThenElse(  \n            Expression.GreaterThan(value, Expression.Constant(1)),  \n            Expression.MultiplyAssign(result,  \n                Expression.PostDecrementAssign(value)),  \n            Expression.Break(label, result)  \n        ),  \n        label  \n    )  \n)  \n  \n' Compile an expression tree and return a delegate.  \nDim factorial As Integer =  \n    Expression.Lambda(Of Func(Of Integer, Integer))(block, value).Compile()(5)  \n  \nConsole.WriteLine(factorial)  \n' Prints 120.  \n```\n\nFor more information, see [Generating Dynamic Methods with Expression Trees in Visual Studio 2010](https://devblogs.microsoft.com/csharpfaq/generating-dynamic-methods-with-expression-trees-in-visual-studio-2010/), which also applies to later versions of Visual Studio.\n  \n## Parsing Expression Trees  \n The following code example demonstrates how the expression tree that represents the lambda expression `Function(num) num < 5` can be decomposed into its parts.  \n  \n```vb  \n' Import the following namespace to your project: System.Linq.Expressions  \n  \n' Create an expression tree.  \nDim exprTree As Expression(Of Func(Of Integer, Boolean)) = Function(num) num < 5  \n  \n' Decompose the expression tree.  \nDim param As ParameterExpression = exprTree.Parameters(0)  \nDim operation As BinaryExpression = exprTree.Body  \nDim left As ParameterExpression = operation.Left  \nDim right As ConstantExpression = operation.Right  \n  \nConsole.WriteLine(String.Format(\"Decomposed expression: {0} => {1} {2} {3}\",  \n                  param.Name, left.Name, operation.NodeType, right.Value))  \n  \n' This code produces the following output:  \n'  \n' Decomposed expression: num => num LessThan 5  \n```  \n  \n## Immutability of Expression Trees  \n Expression trees should be immutable. This means that if you want to modify an expression tree, you must construct a new expression tree by copying the existing one and replacing nodes in it. You can use an expression tree visitor to traverse the existing expression tree. For more information, see [How to: Modify Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-modify-expression-trees.md).  \n  \n## Compiling Expression Trees  \n The <xref:System.Linq.Expressions.Expression%601> type provides the <xref:System.Linq.Expressions.Expression%601.Compile%2A> method that compiles the code represented by an expression tree into an executable delegate.  \n  \n The following code example demonstrates how to compile an expression tree and run the resulting code.  \n  \n```vb  \n' Creating an expression tree.  \nDim expr As Expression(Of Func(Of Integer, Boolean)) =  \n    Function(num) num < 5  \n  \n' Compiling the expression tree into a delegate.  \nDim result As Func(Of Integer, Boolean) = expr.Compile()  \n  \n' Invoking the delegate and writing the result to the console.  \nConsole.WriteLine(result(4))  \n  \n' Prints True.  \n  \n' You can also use simplified syntax  \n' to compile and run an expression tree.  \n' The following line can replace two previous statements.  \nConsole.WriteLine(expr.Compile()(4))  \n  \n' Also prints True.  \n```  \n  \n For more information, see [How to: Execute Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-execute-expression-trees.md).  \n  \n## See also\n\n- <xref:System.Linq.Expressions>\n- [How to: Execute Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-execute-expression-trees.md)\n- [How to: Modify Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-modify-expression-trees.md)\n- [Lambda Expressions](../../../../visual-basic/programming-guide/language-features/procedures/lambda-expressions.md)\n- [Dynamic Language Runtime Overview](../../../../framework/reflection-and-codedom/dynamic-language-runtime-overview.md)\n- [Programming Concepts (Visual Basic)](../../../../visual-basic/programming-guide/concepts/index.md)\n","nodes":[{"pos":[4,113],"embed":true,"restype":"x-metadata","content":"title: \"Expression Trees (Visual Basic)\"\nms.date: 07/20/2015\nms.assetid: 8bbbb02d-7ffc-476b-8c25-118d82bf5d46","nodes":[{"content":"Expression Trees (Visual Basic)","nodes":[{"pos":[0,31],"content":"Expression Trees (Visual Basic)","nodes":[{"content":"Expression Trees (Visual Basic)","pos":[0,31]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[120,151],"content":"Expression Trees (Visual Basic)","linkify":"Expression Trees (Visual Basic)","nodes":[{"content":"Expression Trees (Visual Basic)","pos":[0,31]}]},{"pos":[152,314],"content":"Expression trees represent code in a tree-like data structure, where each node is an expression, for example, a method call or a binary operation such as <ph id=\"ph1\">`x &lt; y`</ph>.","source":"Expression trees represent code in a tree-like data structure, where each node is an expression, for example, a method call or a binary operation such as `x < y`."},{"content":"You can compile and run code represented by expression trees.","pos":[321,382]},{"content":"This enables dynamic modification of executable code, the execution of LINQ queries in various databases, and the creation of dynamic queries.","pos":[383,525]},{"content":"For more information about expression trees in LINQ, see <bpt id=\"p1\">[</bpt>How to: Use Expression Trees to Build Dynamic Queries (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-use-expression-trees-to-build-dynamic-queries.md)</ept>.","pos":[526,780],"source":" For more information about expression trees in LINQ, see [How to: Use Expression Trees to Build Dynamic Queries (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-use-expression-trees-to-build-dynamic-queries.md)."},{"content":"Expression trees are also used in the dynamic language runtime (DLR) to provide interoperability between dynamic languages and the .NET Framework and to enable compiler writers to emit expression trees instead of Microsoft intermediate language (MSIL).","pos":[787,1039]},{"content":"For more information about the DLR, see <bpt id=\"p1\">[</bpt>Dynamic Language Runtime Overview<ept id=\"p1\">](../../../../framework/reflection-and-codedom/dynamic-language-runtime-overview.md)</ept>.","pos":[1040,1199],"source":" For more information about the DLR, see [Dynamic Language Runtime Overview](../../../../framework/reflection-and-codedom/dynamic-language-runtime-overview.md)."},{"pos":[1206,1424],"content":"You can have the C# or Visual Basic compiler create an expression tree for you based on an anonymous lambda expression, or you can create expression trees manually by using the <ph id=\"ph1\">&lt;xref:System.Linq.Expressions&gt;</ph> namespace.","source":"You can have the C# or Visual Basic compiler create an expression tree for you based on an anonymous lambda expression, or you can create expression trees manually by using the <xref:System.Linq.Expressions> namespace."},{"pos":[1433,1482],"content":"Creating Expression Trees from Lambda Expressions","linkify":"Creating Expression Trees from Lambda Expressions","nodes":[{"content":"Creating Expression Trees from Lambda Expressions","pos":[0,49]}]},{"pos":[1486,1682],"content":"When a lambda expression is assigned to a variable of type <ph id=\"ph1\">&lt;xref:System.Linq.Expressions.Expression%601&gt;</ph>, the compiler emits code to build an expression tree that represents the lambda expression.","source":"When a lambda expression is assigned to a variable of type <xref:System.Linq.Expressions.Expression%601>, the compiler emits code to build an expression tree that represents the lambda expression."},{"content":"The Visual Basic compiler can generate expression trees only from expression lambdas (or single-line lambdas).","pos":[1689,1799]},{"content":"It cannot parse statement lambdas (or multi-line lambdas).","pos":[1800,1858]},{"content":"For more information about lambda expressions in Visual Basic, see <bpt id=\"p1\">[</bpt>Lambda Expressions<ept id=\"p1\">](../../../../visual-basic/programming-guide/language-features/procedures/lambda-expressions.md)</ept>.","pos":[1859,2042],"source":" For more information about lambda expressions in Visual Basic, see [Lambda Expressions](../../../../visual-basic/programming-guide/language-features/procedures/lambda-expressions.md)."},{"pos":[2049,2215],"content":"The following code examples demonstrate how to have the Visual Basic compiler create an expression tree that represents the lambda expression <ph id=\"ph1\">`Function(num) num &lt; 5`</ph>.","source":"The following code examples demonstrate how to have the Visual Basic compiler create an expression tree that represents the lambda expression `Function(num) num < 5`."},{"pos":[2328,2370],"content":"Creating Expression Trees by Using the API","linkify":"Creating Expression Trees by Using the API","nodes":[{"content":"Creating Expression Trees by Using the API","pos":[0,42]}]},{"content":"To create expression trees by using the API, use the <ph id=\"ph1\">&lt;xref:System.Linq.Expressions.Expression&gt;</ph> class.","pos":[2374,2475],"source":"To create expression trees by using the API, use the <xref:System.Linq.Expressions.Expression> class."},{"content":"This class contains static factory methods that create expression tree nodes of specific types, for example, <ph id=\"ph1\">&lt;xref:System.Linq.Expressions.ParameterExpression&gt;</ph>, which represents a variable or parameter, or <ph id=\"ph2\">&lt;xref:System.Linq.Expressions.MethodCallExpression&gt;</ph>, which represents a method call.","pos":[2476,2766],"source":" This class contains static factory methods that create expression tree nodes of specific types, for example, <xref:System.Linq.Expressions.ParameterExpression>, which represents a variable or parameter, or <xref:System.Linq.Expressions.MethodCallExpression>, which represents a method call."},{"content":"<ph id=\"ph1\">&lt;xref:System.Linq.Expressions.ParameterExpression&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.Linq.Expressions.MethodCallExpression&gt;</ph>, and the other expression-specific types are also defined in the <ph id=\"ph3\">&lt;xref:System.Linq.Expressions&gt;</ph> namespace.","pos":[2767,2977],"source":"<xref:System.Linq.Expressions.ParameterExpression>, <xref:System.Linq.Expressions.MethodCallExpression>, and the other expression-specific types are also defined in the <xref:System.Linq.Expressions> namespace."},{"content":"These types derive from the abstract type <ph id=\"ph1\">&lt;xref:System.Linq.Expressions.Expression&gt;</ph>.","pos":[2978,3062],"source":" These types derive from the abstract type <xref:System.Linq.Expressions.Expression>."},{"pos":[3069,3221],"content":"The following code example demonstrates how to create an expression tree that represents the lambda expression <ph id=\"ph1\">`Function(num) num &lt; 5`</ph> by using the API.","source":"The following code example demonstrates how to create an expression tree that represents the lambda expression `Function(num) num < 5` by using the API."},{"content":"In .NET Framework 4 or later, the expression trees API also supports assignments and control flow expressions such as loops, conditional blocks, and <ph id=\"ph1\">`try-catch`</ph> blocks.","pos":[3835,4003],"source":"In .NET Framework 4 or later, the expression trees API also supports assignments and control flow expressions such as loops, conditional blocks, and `try-catch` blocks."},{"content":"By using the API, you can create expression trees that are more complex than those that can be created from lambda expressions by the Visual Basic compiler.","pos":[4004,4160]},{"content":"The following example demonstrates how to create an expression tree that calculates the factorial of a number.","pos":[4161,4271]},{"pos":[5396,5664],"content":"For more information, see <bpt id=\"p1\">[</bpt>Generating Dynamic Methods with Expression Trees in Visual Studio 2010<ept id=\"p1\">](https://devblogs.microsoft.com/csharpfaq/generating-dynamic-methods-with-expression-trees-in-visual-studio-2010/)</ept>, which also applies to later versions of Visual Studio.","source":"For more information, see [Generating Dynamic Methods with Expression Trees in Visual Studio 2010](https://devblogs.microsoft.com/csharpfaq/generating-dynamic-methods-with-expression-trees-in-visual-studio-2010/), which also applies to later versions of Visual Studio."},{"pos":[5671,5695],"content":"Parsing Expression Trees","linkify":"Parsing Expression Trees","nodes":[{"content":"Parsing Expression Trees","pos":[0,24]}]},{"pos":[5699,5858],"content":"The following code example demonstrates how the expression tree that represents the lambda expression <ph id=\"ph1\">`Function(num) num &lt; 5`</ph> can be decomposed into its parts.","source":"The following code example demonstrates how the expression tree that represents the lambda expression `Function(num) num < 5` can be decomposed into its parts."},{"pos":[6590,6622],"content":"Immutability of Expression Trees","linkify":"Immutability of Expression Trees","nodes":[{"content":"Immutability of Expression Trees","pos":[0,32]}]},{"content":"Expression trees should be immutable.","pos":[6626,6663]},{"content":"This means that if you want to modify an expression tree, you must construct a new expression tree by copying the existing one and replacing nodes in it.","pos":[6664,6817]},{"content":"You can use an expression tree visitor to traverse the existing expression tree.","pos":[6818,6898]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>How to: Modify Expression Trees (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-modify-expression-trees.md)</ept>.","pos":[6899,7078],"source":" For more information, see [How to: Modify Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-modify-expression-trees.md)."},{"pos":[7087,7113],"content":"Compiling Expression Trees","linkify":"Compiling Expression Trees","nodes":[{"content":"Compiling Expression Trees","pos":[0,26]}]},{"pos":[7117,7334],"content":"The <ph id=\"ph1\">&lt;xref:System.Linq.Expressions.Expression%601&gt;</ph> type provides the <ph id=\"ph2\">&lt;xref:System.Linq.Expressions.Expression%601.Compile%2A&gt;</ph> method that compiles the code represented by an expression tree into an executable delegate.","source":"The <xref:System.Linq.Expressions.Expression%601> type provides the <xref:System.Linq.Expressions.Expression%601.Compile%2A> method that compiles the code represented by an expression tree into an executable delegate."},{"content":"The following code example demonstrates how to compile an expression tree and run the resulting code.","pos":[7341,7442]},{"pos":[8025,8206],"content":"For more information, see <bpt id=\"p1\">[</bpt>How to: Execute Expression Trees (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-execute-expression-trees.md)</ept>.","source":"For more information, see [How to: Execute Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-execute-expression-trees.md)."},{"pos":[8215,8223],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[8260,8414],"content":"<bpt id=\"p1\">[</bpt>How to: Execute Expression Trees (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-execute-expression-trees.md)</ept>","source":"[How to: Execute Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-execute-expression-trees.md)"},{"pos":[8417,8569],"content":"<bpt id=\"p1\">[</bpt>How to: Modify Expression Trees (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-modify-expression-trees.md)</ept>","source":"[How to: Modify Expression Trees (Visual Basic)](../../../../visual-basic/programming-guide/concepts/expression-trees/how-to-modify-expression-trees.md)"},{"pos":[8572,8687],"content":"<bpt id=\"p1\">[</bpt>Lambda Expressions<ept id=\"p1\">](../../../../visual-basic/programming-guide/language-features/procedures/lambda-expressions.md)</ept>","source":"[Lambda Expressions](../../../../visual-basic/programming-guide/language-features/procedures/lambda-expressions.md)"},{"pos":[8690,8808],"content":"<bpt id=\"p1\">[</bpt>Dynamic Language Runtime Overview<ept id=\"p1\">](../../../../framework/reflection-and-codedom/dynamic-language-runtime-overview.md)</ept>","source":"[Dynamic Language Runtime Overview](../../../../framework/reflection-and-codedom/dynamic-language-runtime-overview.md)"},{"pos":[8811,8910],"content":"<bpt id=\"p1\">[</bpt>Programming Concepts (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/index.md)</ept>","source":"[Programming Concepts (Visual Basic)](../../../../visual-basic/programming-guide/concepts/index.md)"}]}