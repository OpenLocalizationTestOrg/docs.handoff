{"content":"---\ntitle: \"FindPrivateKey sample - WCF\"\nms.date: \"12/04/2017\"\nhelpviewer_keywords: \n  - \"FindPrivateKey\"\nms.assetid: 16b54116-0ceb-4413-af0c-753bb2a785a6\n---\n# FindPrivateKey sample\n\nIt can be difficult to find the location and name of the private key file associated with a specific X.509 certificate in the certificate store. The FindPrivateKey.exe tool facilitates this process.\n\n> [!IMPORTANT]\n> FindPrivateKey is a sample that needs to be compiled prior to use. See the [To build the FindPrivateKey project](#to-build-the-findprivatekey-project) section for instructions on how to build the FindPrivateKey tool.\n\nX.509 certificates are installed by an Administrator or any user in the machine. However, the certificate may be accessed by a service running under a different account. For example, the NETWORK SERVICE account.\n\nThis account may not have access to the private key file because the certificate was not installed by it originally. The FindPrivateKey tool gives you the location of a given X.509 Certificate's private key file. You can add permissions or remove permissions to this file once you know the location of the particular X.509 certificates' private key file.\n\nThe samples that use certificates for security use the FindPrivateKey tool in the *Setup.bat* file. Once the private key file has been found, you can use other tools such as *Cacls.exe* to set the appropriate access rights onto the file.\n\nWhen running a Windows Communication Foundation (WCF) service under a user account, such as a self-hosted executable, ensure that the user account has read-only access to the file. When running a WCF service under Internet Information Services (IIS) the default accounts that the service runs under are the NETWORK SERVICE on IIS 7 and earlier versions, or Application Pool Identity on IIS 7.5 and later versions. For more information, see [Application Pool Identities](/iis/manage/configuring-security/application-pool-identities).\n\n## Examples\n\nWhen accessing a certificate for which the process doesn't have read privilege, you see an exception message similar to the following example:\n\n```\nSystem.ArgumentException was unhandled\nMessage=\"The certificate 'CN=localhost' must have a private key that is capable of key exchange.  The process must have access rights for the private key.\"\nSource=\"System.ServiceModel\"\n```\n\nWhen this occurs, use the FindPrivateKey tool to find the private key file, and then set the access right for the process that the service is running under. For example, this can be done with the Cacls.exe tool as shown in the following example:\n\n```\ncacls.exe \"C:\\Documents and Settings\\All Users\\Application Data\\Microsoft\\Crypto\\RSA\\MachineKeys\\8aeda5eb81555f14f8f9960745b5a40d_38f7de48-5ee9-452d-8a5a-92789d7110b1\" /E /G \"NETWORK SERVICE\":R\n```\n\n#### To build the FindPrivateKey project\n\nTo download the project, visit [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459).\n\n1. Open [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)] and navigate to the *WF_WCF_Samples\\WCF\\Setup\\FindPrivateKey\\CS* folder under the directory location where you installed the sample.\n\n2. Double-click the .sln file icon to open the file in Visual Studio.\n\n3. In the **Build** menu, select **Rebuild Solution**.\n\n4. Building the solution generates the file: FindPrivateKey.exe.\n\n## Conventions—Command-Line entries\n\n \"[*option*]\" represents an optional set of parameters.\n\n \"{*option*}\" represents a mandatory set of parameters.\n\n \"*option1* &#124; *option2*\" represents a choice between sets of options.\n\n \"\\<*value*>\" represents a parameter value to be entered.\n\n## Usage\n\n```\nFindPrivateKey <storeName> <storeLocation> [{ {-n <subjectName>} | {-t <thumbprint>} } [-f | -d | -a]]\n```\n\nWhere:\n\n```\n       <subjectName> The subject name of the certificate\n       <thumbprint>  The thumbprint of the certificate (You can use the Certmgr.exe tool to find this)\n       -f            output file name only\n       -d            output directory only\n       -a            output absolute file name\n```\n\nIf no parameters are specified at the command prompt, then this help text is displayed.\n\n## Examples\n\nThis example finds the filename of the certificate with a subject name of \"CN=localhost\", in the Personal store of the Current User.\n\n```\nFindPrivateKey My CurrentUser -n \"CN=localhost\"\n```\n\nThis example finds the filename of the certificate with a subject name of \"CN=localhost\", in the Personal store of the Current User and output the full directory path.\n\n```\nFindPrivateKey My CurrentUser -n \"CN=localhost\" -a\n```\n\nThis example finds the filename of the certificate with a thumbprint of \"03 33 98 63 d0 47 e7 48 71 33 62 64 76 5c 4c 9d 42 1d 6b 52\", in the Personal store of the Local Computer.\n\n```\nFindPrivateKey My LocalMachine -t \"03 33 98 63 d0 47 e7 48 71 33 62 64 76 5c 4c 9d 42 1d 6b 52\"\n```\n","nodes":[{"pos":[4,154],"embed":true,"restype":"x-metadata","content":"title: \"FindPrivateKey sample - WCF\"\nms.date: \"12/04/2017\"\nhelpviewer_keywords: \n  - \"FindPrivateKey\"\nms.assetid: 16b54116-0ceb-4413-af0c-753bb2a785a6","nodes":[{"content":"FindPrivateKey sample - WCF","nodes":[{"pos":[0,27],"content":"FindPrivateKey sample - WCF","nodes":[{"content":"FindPrivateKey sample - WCF","pos":[0,27]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[161,182],"content":"FindPrivateKey sample","linkify":"FindPrivateKey sample","nodes":[{"content":"FindPrivateKey sample","pos":[0,21]}]},{"content":"It can be difficult to find the location and name of the private key file associated with a specific X.509 certificate in the certificate store.","pos":[184,328]},{"content":"The FindPrivateKey.exe tool facilitates this process.","pos":[329,382]},{"pos":[386,617],"content":"[!IMPORTANT]\nFindPrivateKey is a sample that needs to be compiled prior to use. See the [To build the FindPrivateKey project](#to-build-the-findprivatekey-project) section for instructions on how to build the FindPrivateKey tool.","leadings":["","> "],"nodes":[{"content":"FindPrivateKey is a sample that needs to be compiled prior to use. See the [To build the FindPrivateKey project](#to-build-the-findprivatekey-project) section for instructions on how to build the FindPrivateKey tool.","pos":[13,229],"nodes":[{"content":"FindPrivateKey is a sample that needs to be compiled prior to use.","pos":[0,66]},{"content":"See the <bpt id=\"p1\">[</bpt>To build the FindPrivateKey project<ept id=\"p1\">](#to-build-the-findprivatekey-project)</ept> section for instructions on how to build the FindPrivateKey tool.","pos":[67,216],"source":" See the [To build the FindPrivateKey project](#to-build-the-findprivatekey-project) section for instructions on how to build the FindPrivateKey tool."}]}]},{"content":"X.509 certificates are installed by an Administrator or any user in the machine.","pos":[619,699]},{"content":"However, the certificate may be accessed by a service running under a different account.","pos":[700,788]},{"content":"For example, the NETWORK SERVICE account.","pos":[789,830]},{"content":"This account may not have access to the private key file because the certificate was not installed by it originally.","pos":[832,948]},{"content":"The FindPrivateKey tool gives you the location of a given X.509 Certificate's private key file.","pos":[949,1044]},{"content":"You can add permissions or remove permissions to this file once you know the location of the particular X.509 certificates' private key file.","pos":[1045,1186]},{"content":"The samples that use certificates for security use the FindPrivateKey tool in the <bpt id=\"p1\">*</bpt>Setup.bat<ept id=\"p1\">*</ept> file.","pos":[1188,1287],"source":"The samples that use certificates for security use the FindPrivateKey tool in the *Setup.bat* file."},{"content":"Once the private key file has been found, you can use other tools such as <bpt id=\"p1\">*</bpt>Cacls.exe<ept id=\"p1\">*</ept> to set the appropriate access rights onto the file.","pos":[1288,1425],"source":" Once the private key file has been found, you can use other tools such as *Cacls.exe* to set the appropriate access rights onto the file."},{"content":"When running a Windows Communication Foundation (WCF) service under a user account, such as a self-hosted executable, ensure that the user account has read-only access to the file.","pos":[1427,1607]},{"content":"When running a WCF service under Internet Information Services (IIS) the default accounts that the service runs under are the NETWORK SERVICE on IIS 7 and earlier versions, or Application Pool Identity on IIS 7.5 and later versions.","pos":[1608,1840]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Application Pool Identities<ept id=\"p1\">](/iis/manage/configuring-security/application-pool-identities)</ept>.","pos":[1841,1959],"source":" For more information, see [Application Pool Identities](/iis/manage/configuring-security/application-pool-identities)."},{"pos":[1964,1972],"content":"Examples","linkify":"Examples","nodes":[{"content":"Examples","pos":[0,8]}]},{"content":"When accessing a certificate for which the process doesn't have read privilege, you see an exception message similar to the following example:","pos":[1974,2116]},{"content":"When this occurs, use the FindPrivateKey tool to find the private key file, and then set the access right for the process that the service is running under.","pos":[2351,2507]},{"content":"For example, this can be done with the Cacls.exe tool as shown in the following example:","pos":[2508,2596]},{"pos":[2806,2841],"content":"To build the FindPrivateKey project","linkify":"To build the FindPrivateKey project","nodes":[{"content":"To build the FindPrivateKey project","pos":[0,35]}]},{"pos":[2843,3039],"content":"To download the project, visit <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=21459)</ept>.","source":"To download the project, visit [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459)."},{"pos":[3044,3247],"content":"Open <ph id=\"ph1\">[!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)]</ph> and navigate to the <bpt id=\"p1\">*</bpt>WF_WCF_Samples\\WCF\\Setup\\FindPrivateKey\\CS<ept id=\"p1\">*</ept> folder under the directory location where you installed the sample.","source":"Open [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)] and navigate to the *WF_WCF_Samples\\WCF\\Setup\\FindPrivateKey\\CS* folder under the directory location where you installed the sample."},{"content":"Double-click the .sln file icon to open the file in Visual Studio.","pos":[3252,3318]},{"pos":[3323,3374],"content":"In the <bpt id=\"p1\">**</bpt>Build<ept id=\"p1\">**</ept> menu, select <bpt id=\"p2\">**</bpt>Rebuild Solution<ept id=\"p2\">**</ept>.","source":"In the **Build** menu, select **Rebuild Solution**."},{"content":"Building the solution generates the file: FindPrivateKey.exe.","pos":[3379,3440]},{"pos":[3445,3477],"content":"Conventions—Command-Line entries","linkify":"Conventions—Command-Line entries","nodes":[{"content":"Conventions—Command-Line entries","pos":[0,32]}]},{"pos":[3480,3534],"content":"\"[<bpt id=\"p1\">*</bpt>option<ept id=\"p1\">*</ept>]\" represents an optional set of parameters.","source":"\"[*option*]\" represents an optional set of parameters."},{"pos":[3537,3591],"content":"\"{<bpt id=\"p1\">*</bpt>option<ept id=\"p1\">*</ept>}\" represents a mandatory set of parameters.","source":"\"{*option*}\" represents a mandatory set of parameters."},{"pos":[3594,3667],"content":"\"<bpt id=\"p1\">*</bpt>option1<ept id=\"p1\">*</ept> &amp;#124; <bpt id=\"p2\">*</bpt>option2<ept id=\"p2\">*</ept>\" represents a choice between sets of options.","source":"\"*option1* &#124; *option2*\" represents a choice between sets of options."},{"pos":[3670,3726],"content":"\"<ph id=\"ph1\">\\&lt;</ph><bpt id=\"p1\">*</bpt>value<ept id=\"p1\">*</ept>&gt;\" represents a parameter value to be entered.","source":"\"\\<*value*>\" represents a parameter value to be entered."},{"pos":[3731,3736],"content":"Usage","linkify":"Usage","nodes":[{"content":"Usage","pos":[0,5]}]},{"content":"Where:","pos":[3850,3856]},{"content":"If no parameters are specified at the command prompt, then this help text is displayed.","pos":[4160,4247]},{"pos":[4252,4260],"content":"Examples","linkify":"Examples","nodes":[{"content":"Examples","pos":[0,8]}]},{"content":"This example finds the filename of the certificate with a subject name of \"CN=localhost\", in the Personal store of the Current User.","pos":[4262,4394]},{"content":"This example finds the filename of the certificate with a subject name of \"CN=localhost\", in the Personal store of the Current User and output the full directory path.","pos":[4453,4620]},{"content":"This example finds the filename of the certificate with a thumbprint of \"03 33 98 63 d0 47 e7 48 71 33 62 64 76 5c 4c 9d 42 1d 6b 52\", in the Personal store of the Local Computer.","pos":[4682,4861]}]}