{"content":"---\ntitle: \"Use Close and Abort to release WCF client resources\"\ndescription: \"Dispose can fail and throw exceptions when the network fails. That can cause unwanted behavior. Instead, use Close and Abort to release client resources when the network has failed.\"\nms.date: \"11/12/2018\"\nms.assetid: aff82a8d-933d-4bdc-b0c2-c2f7527204fb\n---\n\n# Close and Abort release resources safely when network connections have dropped\n\nThis sample demonstrates using the `Close` and `Abort` methods to clean up resources when using a typed client. The `using` statement causes exceptions when the network connection is not robust. This sample is based on the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md) that implements a calculator service. In this sample, the client is a console application (.exe) and the service is hosted by Internet Information Services (IIS).\n\n> [!NOTE]\n> The setup procedure and build instructions for this sample are located at the end of this topic.\n\nThis sample shows two of the common problems that occur when using the C# \"using\" statement with typed clients, as well as code that correctly cleans up after exceptions.\n\nThe C# \"using\" statement results in a call to `Dispose`(). This is the same as `Close`(), which may throw exceptions when a network error occurs. Because the call to `Dispose`() happens implicitly at the closing brace of the \"using\" block, this source of exceptions is likely to go unnoticed both by people writing the code and reading the code. This represents a potential source of application errors.\n\nThe first problem, illustrated in the `DemonstrateProblemUsingCanThrow` method, is that the closing brace throws an exception and the code after the closing brace does not execute:\n\n```csharp\nusing (CalculatorClient client = new CalculatorClient())\n{\n    ...\n} // <-- this line might throw\nConsole.WriteLine(\"Hope this code wasn't important, because it might not happen.\");\n```\n\nEven if nothing inside the using block throws an exception or all exceptions inside the using block are caught, the `Console.WriteLine` might not happen because the implicit `Dispose`() call at the closing brace might throw an exception.\n\nThe second problem, illustrated in the `DemonstrateProblemUsingCanThrowAndMask` method, is another implication of the closing brace throwing an exception:\n\n```csharp\nusing (CalculatorClient client = new CalculatorClient())\n{\n    ...\n    throw new ApplicationException(\"Hope this exception was not important, because \"+\n                                   \"it might be masked by the Close exception.\");\n} // <-- this line might throw an exception.\n```\n\nBecause the `Dispose`() occurs inside a \"finally\" block, the `ApplicationException` is never seen outside the using block if the `Dispose`() fails. If the code outside must know about when the `ApplicationException` occurs, the \"using\" construct may cause problems by masking this exception.\n\nFinally, the sample demonstrates how to clean up correctly when exceptions occur in `DemonstrateCleanupWithExceptions`. This uses a try/catch block to report errors and call `Abort`. See the [Expected Exceptions](../../../../docs/framework/wcf/samples/expected-exceptions.md) sample for more details about catching exceptions from client calls.\n\n```csharp\ntry\n{\n    ...\n    client.Close();\n}\ncatch (CommunicationException e)\n{\n    ...\n    client.Abort();\n}\ncatch (TimeoutException e)\n{\n    ...\n    client.Abort();\n}\ncatch (Exception e)\n{\n    ...\n    client.Abort();\n    throw;\n}\n```\n\n> [!NOTE]\n> The using statement and ServiceHost: Many self-hosting applications do little more than host a service, and ServiceHost.Close rarely throws an exception, so such applications can safely use the using statement with ServiceHost. However, be aware that ServiceHost.Close can throw a `CommunicationException`, so if your application continues after closing the ServiceHost, you should avoid the using statement and follow the pattern previously given.\n\nWhen you run the sample, the operation responses and exceptions are displayed in the client console window.\n\nThe client process runs three scenarios, each of which attempts to call `Divide`. The first scenario demonstrates code being skipped because of an exception from `Dispose`(). The second scenario demonstrates an important exception being masked because of an exception from `Dispose`(). The third scenario demonstrates correct clean up.\n\nThe expected output from the client process is:\n\n```\n=\n= Demonstrating problem:  closing brace of using statement can throw.\n=\nGot System.ServiceModel.CommunicationException from Divide.\nGot System.ServiceModel.Security.MessageSecurityException\n=\n= Demonstrating problem:  closing brace of using statement can mask other Exceptions.\n=\nGot System.ServiceModel.CommunicationException from Divide.\nGot System.ServiceModel.Security.MessageSecurityException\n=\n= Demonstrating cleanup with Exceptions.\n=\nCalling client.Add(0.0, 0.0);\n        client.Add(0.0, 0.0); returned 0\nCalling client.Divide(0.0, 0.0);\nGot System.ServiceModel.CommunicationException from Divide.\n\nPress <ENTER> to terminate client.\n```\n\n### To set up, build, and run the sample\n\n1. Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).\n\n2. To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).\n\n3. To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).\n\n> [!IMPORTANT]\n> The samples may already be installed on your machine. Check for the following (default) directory before continuing.\n>\n> `<InstallDrive>:\\WF_WCF_Samples`\n>\n> If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.\n>\n> `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Client\\UsingUsing`\n","nodes":[{"pos":[4,332],"embed":true,"restype":"x-metadata","content":"title: \"Use Close and Abort to release WCF client resources\"\ndescription: \"Dispose can fail and throw exceptions when the network fails. That can cause unwanted behavior. Instead, use Close and Abort to release client resources when the network has failed.\"\nms.date: \"11/12/2018\"\nms.assetid: aff82a8d-933d-4bdc-b0c2-c2f7527204fb","nodes":[{"content":"Use Close and Abort to release WCF client resources","nodes":[{"pos":[0,51],"content":"Use Close and Abort to release WCF client resources","nodes":[{"content":"Use Close and Abort to release WCF client resources","pos":[0,51]}]}],"path":["title"],"nosxs":false},{"content":"Dispose can fail and throw exceptions when the network fails. That can cause unwanted behavior. Instead, use Close and Abort to release client resources when the network has failed.","nodes":[{"pos":[0,181],"content":"Dispose can fail and throw exceptions when the network fails. That can cause unwanted behavior. Instead, use Close and Abort to release client resources when the network has failed.","nodes":[{"content":"Dispose can fail and throw exceptions when the network fails. That can cause unwanted behavior. Instead, use Close and Abort to release client resources when the network has failed.","pos":[0,181],"nodes":[{"content":"Dispose can fail and throw exceptions when the network fails.","pos":[0,61]},{"content":"That can cause unwanted behavior.","pos":[62,95]},{"content":"Instead, use Close and Abort to release client resources when the network has failed.","pos":[96,181]}]}]}],"path":["description"],"nosxs":false}],"yml":true},{"pos":[340,418],"content":"Close and Abort release resources safely when network connections have dropped","linkify":"Close and Abort release resources safely when network connections have dropped","nodes":[{"content":"Close and Abort release resources safely when network connections have dropped","pos":[0,78]}]},{"content":"This sample demonstrates using the <ph id=\"ph1\">`Close`</ph> and <ph id=\"ph2\">`Abort`</ph> methods to clean up resources when using a typed client.","pos":[420,531],"source":"This sample demonstrates using the `Close` and `Abort` methods to clean up resources when using a typed client."},{"content":"The <ph id=\"ph1\">`using`</ph> statement causes exceptions when the network connection is not robust.","pos":[532,614],"source":" The `using` statement causes exceptions when the network connection is not robust."},{"content":"This sample is based on the <bpt id=\"p1\">[</bpt>Getting Started<ept id=\"p1\">](../../../../docs/framework/wcf/samples/getting-started-sample.md)</ept> that implements a calculator service.","pos":[615,764],"source":" This sample is based on the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md) that implements a calculator service."},{"content":"In this sample, the client is a console application (.exe) and the service is hosted by Internet Information Services (IIS).","pos":[765,889]},{"pos":[893,999],"content":"[!NOTE]\nThe setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[8,104]}]},{"content":"This sample shows two of the common problems that occur when using the C# \"using\" statement with typed clients, as well as code that correctly cleans up after exceptions.","pos":[1001,1171]},{"content":"The C# \"using\" statement results in a call to <ph id=\"ph1\">`Dispose`</ph>().","pos":[1173,1231],"source":"The C# \"using\" statement results in a call to `Dispose`()."},{"content":"This is the same as <ph id=\"ph1\">`Close`</ph>(), which may throw exceptions when a network error occurs.","pos":[1232,1318],"source":" This is the same as `Close`(), which may throw exceptions when a network error occurs."},{"content":"Because the call to <ph id=\"ph1\">`Dispose`</ph>() happens implicitly at the closing brace of the \"using\" block, this source of exceptions is likely to go unnoticed both by people writing the code and reading the code.","pos":[1319,1518],"source":" Because the call to `Dispose`() happens implicitly at the closing brace of the \"using\" block, this source of exceptions is likely to go unnoticed both by people writing the code and reading the code."},{"content":"This represents a potential source of application errors.","pos":[1519,1576]},{"pos":[1578,1758],"content":"The first problem, illustrated in the <ph id=\"ph1\">`DemonstrateProblemUsingCanThrow`</ph> method, is that the closing brace throws an exception and the code after the closing brace does not execute:","source":"The first problem, illustrated in the `DemonstrateProblemUsingCanThrow` method, is that the closing brace throws an exception and the code after the closing brace does not execute:"},{"pos":[1957,2194],"content":"Even if nothing inside the using block throws an exception or all exceptions inside the using block are caught, the <ph id=\"ph1\">`Console.WriteLine`</ph> might not happen because the implicit <ph id=\"ph2\">`Dispose`</ph>() call at the closing brace might throw an exception.","source":"Even if nothing inside the using block throws an exception or all exceptions inside the using block are caught, the `Console.WriteLine` might not happen because the implicit `Dispose`() call at the closing brace might throw an exception."},{"pos":[2196,2350],"content":"The second problem, illustrated in the <ph id=\"ph1\">`DemonstrateProblemUsingCanThrowAndMask`</ph> method, is another implication of the closing brace throwing an exception:","source":"The second problem, illustrated in the `DemonstrateProblemUsingCanThrowAndMask` method, is another implication of the closing brace throwing an exception:"},{"content":"Because the <ph id=\"ph1\">`Dispose`</ph>() occurs inside a \"finally\" block, the <ph id=\"ph2\">`ApplicationException`</ph> is never seen outside the using block if the <ph id=\"ph3\">`Dispose`</ph>() fails.","pos":[2647,2794],"source":"Because the `Dispose`() occurs inside a \"finally\" block, the `ApplicationException` is never seen outside the using block if the `Dispose`() fails."},{"content":"If the code outside must know about when the <ph id=\"ph1\">`ApplicationException`</ph> occurs, the \"using\" construct may cause problems by masking this exception.","pos":[2795,2938],"source":" If the code outside must know about when the `ApplicationException` occurs, the \"using\" construct may cause problems by masking this exception."},{"content":"Finally, the sample demonstrates how to clean up correctly when exceptions occur in <ph id=\"ph1\">`DemonstrateCleanupWithExceptions`</ph>.","pos":[2940,3059],"source":"Finally, the sample demonstrates how to clean up correctly when exceptions occur in `DemonstrateCleanupWithExceptions`."},{"content":"This uses a try/catch block to report errors and call <ph id=\"ph1\">`Abort`</ph>.","pos":[3060,3122],"source":" This uses a try/catch block to report errors and call `Abort`."},{"content":"See the <bpt id=\"p1\">[</bpt>Expected Exceptions<ept id=\"p1\">](../../../../docs/framework/wcf/samples/expected-exceptions.md)</ept> sample for more details about catching exceptions from client calls.","pos":[3123,3284],"source":" See the [Expected Exceptions](../../../../docs/framework/wcf/samples/expected-exceptions.md) sample for more details about catching exceptions from client calls."},{"pos":[3526,3984],"content":"[!NOTE]\nThe using statement and ServiceHost: Many self-hosting applications do little more than host a service, and ServiceHost.Close rarely throws an exception, so such applications can safely use the using statement with ServiceHost. However, be aware that ServiceHost.Close can throw a `CommunicationException`, so if your application continues after closing the ServiceHost, you should avoid the using statement and follow the pattern previously given.","leadings":["","> "],"nodes":[{"content":"The using statement and ServiceHost: Many self-hosting applications do little more than host a service, and ServiceHost.Close rarely throws an exception, so such applications can safely use the using statement with ServiceHost. However, be aware that ServiceHost.Close can throw a `CommunicationException`, so if your application continues after closing the ServiceHost, you should avoid the using statement and follow the pattern previously given.","pos":[8,456],"nodes":[{"content":"The using statement and ServiceHost: Many self-hosting applications do little more than host a service, and ServiceHost.Close rarely throws an exception, so such applications can safely use the using statement with ServiceHost.","pos":[0,227]},{"content":"However, be aware that ServiceHost.Close can throw a <ph id=\"ph1\">`CommunicationException`</ph>, so if your application continues after closing the ServiceHost, you should avoid the using statement and follow the pattern previously given.","pos":[228,448],"source":" However, be aware that ServiceHost.Close can throw a `CommunicationException`, so if your application continues after closing the ServiceHost, you should avoid the using statement and follow the pattern previously given."}]}]},{"content":"When you run the sample, the operation responses and exceptions are displayed in the client console window.","pos":[3986,4093]},{"content":"The client process runs three scenarios, each of which attempts to call <ph id=\"ph1\">`Divide`</ph>.","pos":[4095,4176],"source":"The client process runs three scenarios, each of which attempts to call `Divide`."},{"content":"The first scenario demonstrates code being skipped because of an exception from <ph id=\"ph1\">`Dispose`</ph>().","pos":[4177,4269],"source":" The first scenario demonstrates code being skipped because of an exception from `Dispose`()."},{"content":"The second scenario demonstrates an important exception being masked because of an exception from <ph id=\"ph1\">`Dispose`</ph>().","pos":[4270,4380],"source":" The second scenario demonstrates an important exception being masked because of an exception from `Dispose`()."},{"content":"The third scenario demonstrates correct clean up.","pos":[4381,4430]},{"content":"The expected output from the client process is:","pos":[4432,4479]},{"pos":[5139,5175],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[5180,5379],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"pos":[5384,5593],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[5598,5806],"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[5810,5941],"content":"[!IMPORTANT]\nThe samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[13,129],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[5983,6293],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[6294,6344]}]}