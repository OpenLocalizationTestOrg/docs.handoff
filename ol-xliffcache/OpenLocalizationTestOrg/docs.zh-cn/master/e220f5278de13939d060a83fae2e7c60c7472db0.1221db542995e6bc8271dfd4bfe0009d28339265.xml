{"content":"---\ntitle: \"Troubleshooting Correlation | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 98003875-233d-4512-a688-4b2a1b0b5371\ncaps.latest.revision: 11\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Troubleshooting Correlation\nCorrelation is used to relate workflow service messages to each other and to the correct workflow instance, but if it is not configured correctly, messages will not be received and applications will not work correctly. This topic provides an overview of several methods for troubleshooting correlation issues, and also lists some common issues that can occur when you use correlation.  \n  \n## Handle the UnknownMessageReceived Event  \n The <xref:System.ServiceModel.ServiceHostBase.UnknownMessageReceived> event occurs when an unknown message is received by a service, including messages that cannot be correlated to an existing instance. For self-hosted services, this event can be handled in the host application.  \n  \n```csharp  \nhost.UnknownMessageReceived += delegate(object sender, UnknownMessageReceivedEventArgs e)  \n{  \n    Console.WriteLine(\"Unknown Message Received:\");  \n    Console.WriteLine(e.Message);  \n};  \n```  \n  \n For Web-hosted services, this event can be handled by deriving a class from <xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory> and overriding <xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory.CreateWorkflowServiceHost%2A>.  \n  \n```csharp  \nclass CustomFactory : WorkflowServiceHostFactory  \n{  \n    protected override WorkflowServiceHost CreateWorkflowServiceHost(Activity activity, Uri[] baseAddresses)  \n    {  \n        // Create the WorkflowServiceHost.  \n        WorkflowServiceHost host = new WorkflowServiceHost(activity, baseAddresses);  \n  \n        // Handle the UnknownMessageReceived event.  \n        host.UnknownMessageReceived += delegate(object sender, UnknownMessageReceivedEventArgs e)  \n        {  \n            Console.WriteLine(\"Unknown Message Received:\");  \n            Console.WriteLine(e.Message);  \n        };  \n  \n        return host;  \n    }  \n}  \n```  \n  \n This custom <xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory> can then be specified in the `svc` file for the service.  \n  \n```  \n<% @ServiceHost Language=\"C#\" Service=\"OrderServiceWorkflow\" Factory=\"CustomFactory\" %>  \n```  \n  \n When this handler is invoked, the message can be retrieved by using the <xref:System.ServiceModel.UnknownMessageReceivedEventArgs.Message%2A> property of the <xref:System.ServiceModel.UnknownMessageReceivedEventArgs>, and will resemble the following message.  \n  \n```Output  \n<s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\">  \n  <s:Header>  \n    <To s:mustUnderstand=\"1\" xmlns=\"http://schemas.microsoft.com/ws/2005/05/addressing/none\">http://localhost:8080/OrderService</To>  \n    <Action s:mustUnderstand=\"1\" xmlns=\"http://schemas.microsoft.com/ws/2005/05/addressing/none\">http://tempuri.org/IService/AddItem</Action>  \n  </s:Header>  \n  <s:Body>  \n    <AddItem xmlns=\"http://tempuri.org/\">  \n      <Item>Books</Item>  \n    </AddItem>  \n  </s:Body>  \n</s:Envelope>  \n  \n```  \n  \n Inspecting messages dispatched to the <xref:System.ServiceModel.ServiceHostBase.UnknownMessageReceived> handler may provide clues about why the message did not correlate to an instance of the workflow service.  \n  \n## Use Tracking to Monitor the Progress of the Workflow  \n Tracking provides a way to monitor the progress of a workflow. By default, tracking records are emitted for workflow life-cycle events, activity life-cycle events, fault propagation, and bookmark resumption. Additionally, custom tracking records can be emitted by custom activities. When troubleshooting correlation, the activity tracking records, the bookmark resumption records, and the fault propagation records are the most useful. The activity tracking records can be used to determine the current progress of the workflow and can help identify which messaging activity is currently waiting for messages. Bookmark resumption records are useful because they indicate that a message was received by the workflow, and fault propagation records provide a record of any faults in the workflow. To enable tracking, specify the desired <xref:System.Activities.Tracking.TrackingParticipant> in the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> of the <xref:System.ServiceModel.Activities.WorkflowServiceHost>. In the following example, the `ConsoleTrackingParticipant` (from the [Custom Tracking](../../../../docs/framework/windows-workflow-foundation/samples/custom-tracking.md) sample) is configured by using the default tracking profile.  \n  \n```csharp  \nhost.WorkflowExtensions.Add(new ConsoleTrackingParticipant());  \n```  \n  \n A tracking participant such as the ConsoleTrackingParticipant is useful for self-hosted workflow services that have a console window. For a Web-hosted service, a tracking participant that logs the tracking information to a durable store should be used, such as the built-in <xref:System.Activities.Tracking.EtwTrackingParticipant>, or a custom tracking participant that logs the information to a file, such as the `TextWriterTrackingParticpant` from the [Tracking Using a Text File](../../../../docs/framework/windows-workflow-foundation/samples/tracking-using-a-text-file.md) sample.  \n  \n [!INCLUDE[crabout](../../../../includes/crabout-md.md)] tracking and configuring tracking for a Web-hosted workflow service, see [Workflow Tracking and Tracing](../../../../docs/framework/windows-workflow-foundation/workflow-tracking-and-tracing.md), [Configuring Tracking for a Workflow](../../../../docs/framework/windows-workflow-foundation/configuring-tracking-for-a-workflow.md), and the [Tracking &#91;WF Samples&#93;](../../../../docs/framework/windows-workflow-foundation/samples/tracking.md) samples.  \n  \n## Use WCF Tracing  \n WCF tracing provides tracing of the flow of messages to and from a workflow service. This tracing information is useful when troubleshooting correlation issues, especially for content-based correlation. To enable tracing, specify the desired trace listeners in the `system.diagnostics` section of the `web.config` file if the workflow service is Web-hosted, or the `app.config` file if the workflow service is self-hosted. To include the contents of the messages in the trace file, specify `true` for `logEntireMessage` in the `messageLogging` element in the `diagnostics` section of `system.serviceModel`. In the following example, tracing information, including the content of the messages, is configured to be written to a file that is named `service.svclog`.  \n  \n```  \n<?xml version=\"1.0\" encoding=\"utf-8\" ?>  \n<configuration>  \n  <system.diagnostics>  \n    <sources>  \n      <source name=\"System.ServiceModel\" switchValue=\"Information\" propagateActivity=\"true\">  \n        <listeners>  \n          <add name=\"corr\"/>  \n        </listeners>  \n      </source>  \n      <source name=\"System.ServiceModel.MessageLogging\">  \n        <listeners>  \n          <add name=\"corr\"/>  \n        </listeners>  \n      </source>  \n    </sources>  \n  \n    <sharedListeners>  \n      <add name=\"corr\" type=\"System.Diagnostics.XmlWriterTraceListener\" initializeData=\"c:\\logs\\service.svclog\">  \n      </add>  \n    </sharedListeners>  \n  </system.diagnostics>  \n  \n  <system.serviceModel>  \n    <diagnostics>  \n      <messageLogging logEntireMessage=\"true\" logMalformedMessages=\"false\"  \n         logMessagesAtServiceLevel=\"false\" logMessagesAtTransportLevel=\"true\" maxSizeOfMessageToLog=\"2147483647\">  \n      </messageLogging>  \n    </diagnostics>  \n  </system.serviceModel>  \n</configuration>  \n```  \n  \n To view the trace information that is contained in `service.svclog`, the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md) is used. This is especially useful when troubleshooting content-based correlation issues because you can view the message contents and see exactly what is being passed, and whether it matches the <xref:System.ServiceModel.CorrelationQuery> for the content-based correlation. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] WCF tracing, see [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md), [Configuring Tracing](../../../../docs/framework/wcf/diagnostics/tracing/configuring-tracing.md), and [Using Tracing to Troubleshoot Your Application](../../../../docs/framework/wcf/diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md).  \n  \n## Common Context Exchange Correlation Issues  \n Certain types of correlation require that a specific type of binding is used for the correlation to work correctly. Examples include request-reply correlation, which requires a two-way binding such as <xref:System.ServiceModel.BasicHttpBinding>, and context exchange correlation, which requires a context-based binding such as <xref:System.ServiceModel.BasicHttpContextBinding>. Most bindings support two-way operations so this is not a common issue for request-reply correlation, but there are only a handful of context-based bindings including <xref:System.ServiceModel.BasicHttpContextBinding>, <xref:System.ServiceModel.WSHttpContextBinding>, and <xref:System.ServiceModel.NetTcpContextBinding>. If one of these bindings is not used, the initial call to a workflow service will succeed, but subsequent calls will fail with the following <xref:System.ServiceModel.FaultException>.  \n  \n```Output  \nThere is no context attached to the incoming message for the service   \nand the current operation is not marked with \"CanCreateInstance = true\".   \nIn order to communicate with this service check whether the incoming binding   \nsupports the context protocol and has a valid context initialized.  \n```  \n  \n The context information that is used for context correlation can be returned by the <xref:System.ServiceModel.Activities.SendReply> to the <xref:System.ServiceModel.Activities.Receive> activity that initializes the context correlation when using a two-way operation, or it can be specified by the caller if the operation is one-way. If the context is not sent by the caller or returned by the workflow service, then the same <xref:System.ServiceModel.FaultException> described previously will be returned when a subsequent operation is invoked.  \n  \n [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Context Exchange](../../../../docs/framework/wcf/feature-details/context-exchange-correlation.md).  \n  \n## Common Request-Reply Correlation Issues  \n Request-reply correlation is used with a <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> pair to implement a two-way operation in a workflow service and with a <xref:System.ServiceModel.Activities.Send>/<xref:System.ServiceModel.Activities.ReceiveReply> pair that invokes a two-way operation in another Web service. When invoking a two-way operation in a WCF service, the service can be either a traditional imperative code-based [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service or it can be a workflow service. To use request-reply correlation a two-way binding must be used, such as <xref:System.ServiceModel.BasicHttpBinding>, and the operations must be two-way.  \n  \n If the workflow service has two-way operations in parallel, or overlapping <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> or <xref:System.ServiceModel.Activities.Send>/<xref:System.ServiceModel.Activities.ReceiveReply> pairs, then the implicit correlation handle management provided by <xref:System.ServiceModel.Activities.WorkflowServiceHost> may not be sufficient, especially in high-stress scenarios, and messages may not be correctly routed. To prevent this issue from occurring, we recommend that you always explicitly specify a <xref:System.ServiceModel.Activities.CorrelationHandle> when using request-reply correlation. When using the **SendAndReceiveReply** and **ReceiveAndSendReply** templates from the Messaging section of the **Toolbox** in the workflow designer, a <xref:System.ServiceModel.Activities.CorrelationHandle> is explicitly configured by default. When building a workflow by using code, the <xref:System.ServiceModel.Activities.CorrelationHandle> is specified in the <xref:System.ServiceModel.Activities.Receive.CorrelationInitializers%2A> of the first activity in the pair. In the following example, a <xref:System.ServiceModel.Activities.Receive> activity is configured with an explicit <xref:System.ServiceModel.Activities.CorrelationInitializer.CorrelationHandle%2A> specified in the <xref:System.ServiceModel.Activities.RequestReplyCorrelationInitializer>.  \n  \n```csharp  \nVariable<CorrelationHandle> RRHandle = new Variable<CorrelationHandle>();  \n  \nReceive StartOrder = new Receive  \n{  \n    CanCreateInstance = true,  \n    ServiceContractName = OrderContractName,  \n    OperationName = \"StartOrder\",  \n    CorrelationInitializers =  \n    {  \n        new RequestReplyCorrelationInitializer  \n        {  \n            CorrelationHandle = RRHandle  \n        }  \n    }  \n};  \n  \nSendReply ReplyToStartOrder = new SendReply  \n{  \n    Request = StartOrder,  \n    Content = ... // Contains the return value, if any.  \n};  \n  \n// Construct a workflow using StartOrder and ReplyToStartOrder.  \n```  \n  \n Persistence is not permitted between a <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> pair or a <xref:System.ServiceModel.Activities.Send>/<xref:System.ServiceModel.Activities.ReceiveReply> pair. A no-persist zone is created that lasts until both activities have completed. If an activity, such as a delay activity, is in this no-persist zone and causes the workflow to become idle, the workflow will not persist even if it the host is configured to persist workflows when they become idle. If an activity, such as a persist activity, attempts to explicitly persist in the no-persist zone, a fatal exception is thrown, the workflow aborts, and a <xref:System.ServiceModel.FaultException> is returned to the caller. The fatal exception message is \"System.InvalidOperationException: Persist activities cannot be contained within no persistence blocks.\". This exception is not returned to the caller but can be observed if tracking is enabled. The message for the <xref:System.ServiceModel.FaultException> returned to the caller is \"The operation could not be performed because WorkflowInstance '5836145b-7da2-49d0-a052-a49162adeab6' has completed\".  \n  \n [!INCLUDE[crabout](../../../../includes/crabout-md.md)] request-reply correlation, see [Request-Reply](../../../../docs/framework/wcf/feature-details/request-reply-correlation.md).  \n  \n## Common Content Correlation Issues  \n Content-based correlation is used when a workflow service receives multiple messages and a piece of data in the exchanged messages identifies the desired instance. Content-based correlation uses this data in the message, such as a customer number or order ID, to route messages to the correct workflow instance. This section describes several common issues that may occur when using content-based correlation.  \n  \n### Ensure the Identifying Data Is Unique  \n The data that is used to identify the instance is hashed into a correlation key. Care must be taken to guarantee that the data that is used for correlation is unique or else collisions in the hashed key might occur and cause messages to be misrouted. For example, a correlation based only on a customer name may cause a collision because there may be multiple customers who have the same name. The colon (:) should not be used as part of the data that is used to correlate the message because it is already used to delimit the message query’s key and value to form the string that is subsequently hashed. If persistence is being used, make sure that the current identifying data has not been used by a previously persisted instance. Temporarily disabling persistence can help identify this issue. WCF tracing can be used to view the calculated correlation key and is useful for debugging this kind of issue.  \n  \n### Race Conditions  \n There is a small gap in time between the service receiving a message and the correlation actually being initialized, during which follow-up messages will be ignored. If a workflow service initializes the content-based correlation by using data passed from the client over a one-way operation, and the caller sends immediate follow-up messages, these messages will be ignored during this interval. This can be avoided by using a two-way operation to initialize the correlation, or by using a <xref:System.ServiceModel.Activities.TransactedReceiveScope>.  \n  \n### Correlation Query Issues  \n Correlation queries are used to specify what data in a message is used to correlate the message. This data is specified by using an XPath query. If messages to a service are not being dispatched even though everything appears to be correct, one strategy for troubleshooting is to specify a literal value that matches the value of the message data instead of an XPath query. To specify a literal value, use the `string` function. In the following example, a <xref:System.ServiceModel.MessageQuerySet> is configured to use a literal value of `11445` for the `OrderId` and the XPath query is commented out.  \n  \n```csharp  \nMessageQuerySet = new MessageQuerySet  \n{  \n    {  \n        \"OrderId\",   \n        //new XPathMessageQuery(\"sm:body()/tempuri:StartOrderResponse/tempuri:OrderId\")  \n        new XPathMessageQuery(\"string('11445')\")  \n    }  \n}  \n```  \n  \n If an XPath query is configured incorrectly such that no correlation data is retrieved, a fault is returned with the following message: \"A correlation query yielded an empty result set. Please ensure correlation queries for the endpoint are correctly configured.\" One quick way to troubleshoot this is to replace the XPath query with a literal value as described in the previous section. This issue can occur if you use the XPath query builder in the **Add Correlation Initializers** or **CorrelatesOn Definition** dialog boxes and your workflow service uses message contracts. In the following example, a message contract class is defined.  \n  \n```csharp  \n[MessageContract]  \npublic class AddItemMessage  \n{  \n    [MessageHeader]  \n    public string CartId;  \n  \n    [MessageBodyMember]  \n    public string Item;  \n}  \n  \n```  \n  \n This message contract is used by a <xref:System.ServiceModel.Activities.Receive> activity in a workflow. The `CartId` in the header of the message is used to correlate the message to the correct instance. If the XPath query that retrieves the `CartId` is created using the correlation dialogs in the workflow designer, the following incorrect XPath query is generated.  \n  \n```  \nsm:body()/xg0:AddItemMessage/xg0:CartId  \n```  \n  \n This XPath query would be correct if the <xref:System.ServiceModel.Activities.Receive> activity used parameters for the data, but since it is using a message contract it is incorrect. The following XPath query is the correct XPath query to retrieve the `CartId` from the header.  \n  \n```  \nsm:header()/tempuri:CartId  \n```  \n  \n This can be confirmed by examining the body of the message.  \n  \n```xml  \n<s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\">  \n  <s:Header>  \n    <Action s:mustUnderstand=\"1\" xmlns=\"http://schemas.microsoft.com/ws/2005/05/addressing/none\">http://tempuri.org/IService/AddItem</Action>  \n    <h:CartId xmlns:h=\"http://tempuri.org/\">80c95b41-c98d-4660-a6c1-99412206e54c</h:CartId>  \n  </s:Header>  \n  <s:Body>  \n    <AddItemMessage xmlns=\"http://tempuri.org/\">  \n      <Item>Books</Item>  \n    </AddItemMessage>  \n  </s:Body>  \n</s:Envelope>  \n```  \n  \n The following example shows a <xref:System.ServiceModel.Activities.Receive> activity configured for an `AddItem` operation that uses the previous message contract to receive data. The XPath query is correctly configured.  \n  \n```xaml  \n<Receive CorrelatesWith=\"[CCHandle] OperationName=\"AddItem\" ServiceContractName=\"p:IService\">  \n  <Receive.CorrelatesOn>  \n    <XPathMessageQuery x:Key=\"key1\">  \n      <XPathMessageQuery.Namespaces>  \n        <ssx:XPathMessageContextMarkup>  \n          <x:String x:Key=\"xg0\">http://schemas.datacontract.org/2004/07/MessageContractWFService</x:String>  \n        </ssx:XPathMessageContextMarkup>  \n      </XPathMessageQuery.Namespaces>sm:header()/tempuri:CartId</XPathMessageQuery>  \n  </Receive.CorrelatesOn>  \n  <ReceiveMessageContent DeclaredMessageType=\"m:AddItemMessage\">  \n    <p1:OutArgument x:TypeArguments=\"m:AddItemMessage\">[AddItemMessage]</p1:OutArgument>  \n  </ReceiveMessageContent>  \n</Receive>  \n  \n```  \n  \n [!INCLUDE[crabout](../../../../includes/crabout-md.md)] content-based correlation, see [Content Based](../../../../docs/framework/wcf/feature-details/content-based-correlation.md) and the [Correlated Calculator](../../../../docs/framework/windows-workflow-foundation/samples/correlated-calculator.md) sample.\n","nodes":[{"pos":[4,348],"embed":true,"restype":"x-metadata","content":"title: \"Troubleshooting Correlation | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 98003875-233d-4512-a688-4b2a1b0b5371\ncaps.latest.revision: 11\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","nodes":[{"content":"Troubleshooting Correlation | Microsoft Docs","nodes":[{"pos":[0,44],"content":"Troubleshooting Correlation | Microsoft Docs","nodes":[{"content":"Troubleshooting Correlation | Microsoft Docs","pos":[0,44]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[355,382],"content":"Troubleshooting Correlation","linkify":"Troubleshooting Correlation","nodes":[{"content":"Troubleshooting Correlation","pos":[0,27]}]},{"content":"Correlation is used to relate workflow service messages to each other and to the correct workflow instance, but if it is not configured correctly, messages will not be received and applications will not work correctly.","pos":[383,601]},{"content":"This topic provides an overview of several methods for troubleshooting correlation issues, and also lists some common issues that can occur when you use correlation.","pos":[602,767]},{"pos":[776,815],"content":"Handle the UnknownMessageReceived Event","linkify":"Handle the UnknownMessageReceived Event","nodes":[{"content":"Handle the UnknownMessageReceived Event","pos":[0,39]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHostBase.UnknownMessageReceived&gt;</ph> event occurs when an unknown message is received by a service, including messages that cannot be correlated to an existing instance.","pos":[819,1021],"source":"The <xref:System.ServiceModel.ServiceHostBase.UnknownMessageReceived> event occurs when an unknown message is received by a service, including messages that cannot be correlated to an existing instance."},{"content":"For self-hosted services, this event can be handled in the host application.","pos":[1022,1098]},{"content":"For Web-hosted services, this event can be handled by deriving a class from <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory&gt;</ph> and overriding <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory.CreateWorkflowServiceHost%2A&gt;</ph>.","pos":[1317,1589],"source":"For Web-hosted services, this event can be handled by deriving a class from <xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory> and overriding <xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory.CreateWorkflowServiceHost%2A>."},{"pos":[2249,2393],"content":"This custom <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory&gt;</ph> can then be specified in the <ph id=\"ph2\">`svc`</ph> file for the service.","source":"This custom <xref:System.ServiceModel.Activities.Activation.WorkflowServiceHostFactory> can then be specified in the `svc` file for the service."},{"content":"When this handler is invoked, the message can be retrieved by using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.UnknownMessageReceivedEventArgs.Message%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.UnknownMessageReceivedEventArgs&gt;</ph>, and will resemble the following message.","pos":[2505,2763],"source":"When this handler is invoked, the message can be retrieved by using the <xref:System.ServiceModel.UnknownMessageReceivedEventArgs.Message%2A> property of the <xref:System.ServiceModel.UnknownMessageReceivedEventArgs>, and will resemble the following message."},{"content":"Inspecting messages dispatched to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHostBase.UnknownMessageReceived&gt;</ph> handler may provide clues about why the message did not correlate to an instance of the workflow service.","pos":[3302,3511],"source":"Inspecting messages dispatched to the <xref:System.ServiceModel.ServiceHostBase.UnknownMessageReceived> handler may provide clues about why the message did not correlate to an instance of the workflow service."},{"pos":[3520,3572],"content":"Use Tracking to Monitor the Progress of the Workflow","linkify":"Use Tracking to Monitor the Progress of the Workflow","nodes":[{"content":"Use Tracking to Monitor the Progress of the Workflow","pos":[0,52]}]},{"content":"Tracking provides a way to monitor the progress of a workflow.","pos":[3576,3638]},{"content":"By default, tracking records are emitted for workflow life-cycle events, activity life-cycle events, fault propagation, and bookmark resumption.","pos":[3639,3783]},{"content":"Additionally, custom tracking records can be emitted by custom activities.","pos":[3784,3858]},{"content":"When troubleshooting correlation, the activity tracking records, the bookmark resumption records, and the fault propagation records are the most useful.","pos":[3859,4011]},{"content":"The activity tracking records can be used to determine the current progress of the workflow and can help identify which messaging activity is currently waiting for messages.","pos":[4012,4185]},{"content":"Bookmark resumption records are useful because they indicate that a message was received by the workflow, and fault propagation records provide a record of any faults in the workflow.","pos":[4186,4369]},{"content":"To enable tracking, specify the desired <ph id=\"ph1\">&lt;xref:System.Activities.Tracking.TrackingParticipant&gt;</ph> in the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A&gt;</ph> of the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph>.","pos":[4370,4616],"source":" To enable tracking, specify the desired <xref:System.Activities.Tracking.TrackingParticipant> in the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> of the <xref:System.ServiceModel.Activities.WorkflowServiceHost>."},{"content":"In the following example, the <ph id=\"ph1\">`ConsoleTrackingParticipant`</ph> (from the <bpt id=\"p1\">[</bpt>Custom Tracking<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/samples/custom-tracking.md)</ept> sample) is configured by using the default tracking profile.","pos":[4617,4847],"source":" In the following example, the `ConsoleTrackingParticipant` (from the [Custom Tracking](../../../../docs/framework/windows-workflow-foundation/samples/custom-tracking.md) sample) is configured by using the default tracking profile."},{"content":"A tracking participant such as the ConsoleTrackingParticipant is useful for self-hosted workflow services that have a console window.","pos":[4940,5073]},{"content":"For a Web-hosted service, a tracking participant that logs the tracking information to a durable store should be used, such as the built-in <ph id=\"ph1\">&lt;xref:System.Activities.Tracking.EtwTrackingParticipant&gt;</ph>, or a custom tracking participant that logs the information to a file, such as the <ph id=\"ph2\">`TextWriterTrackingParticpant`</ph> from the <bpt id=\"p1\">[</bpt>Tracking Using a Text File<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/samples/tracking-using-a-text-file.md)</ept> sample.","pos":[5074,5524],"source":" For a Web-hosted service, a tracking participant that logs the tracking information to a durable store should be used, such as the built-in <xref:System.Activities.Tracking.EtwTrackingParticipant>, or a custom tracking participant that logs the information to a file, such as the `TextWriterTrackingParticpant` from the [Tracking Using a Text File](../../../../docs/framework/windows-workflow-foundation/samples/tracking-using-a-text-file.md) sample."},{"pos":[5531,6040],"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> tracking and configuring tracking for a Web-hosted workflow service, see <bpt id=\"p1\">[</bpt>Workflow Tracking and Tracing<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/workflow-tracking-and-tracing.md)</ept>, <bpt id=\"p2\">[</bpt>Configuring Tracking for a Workflow<ept id=\"p2\">](../../../../docs/framework/windows-workflow-foundation/configuring-tracking-for-a-workflow.md)</ept>, and the <bpt id=\"p3\">[</bpt>Tracking &amp;#91;WF Samples&amp;#93;<ept id=\"p3\">](../../../../docs/framework/windows-workflow-foundation/samples/tracking.md)</ept> samples.","source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] tracking and configuring tracking for a Web-hosted workflow service, see [Workflow Tracking and Tracing](../../../../docs/framework/windows-workflow-foundation/workflow-tracking-and-tracing.md), [Configuring Tracking for a Workflow](../../../../docs/framework/windows-workflow-foundation/configuring-tracking-for-a-workflow.md), and the [Tracking &#91;WF Samples&#93;](../../../../docs/framework/windows-workflow-foundation/samples/tracking.md) samples."},{"pos":[6049,6064],"content":"Use WCF Tracing","linkify":"Use WCF Tracing","nodes":[{"content":"Use WCF Tracing","pos":[0,15]}]},{"content":"WCF tracing provides tracing of the flow of messages to and from a workflow service.","pos":[6068,6152]},{"content":"This tracing information is useful when troubleshooting correlation issues, especially for content-based correlation.","pos":[6153,6270]},{"content":"To enable tracing, specify the desired trace listeners in the <ph id=\"ph1\">`system.diagnostics`</ph> section of the <ph id=\"ph2\">`web.config`</ph> file if the workflow service is Web-hosted, or the <ph id=\"ph3\">`app.config`</ph> file if the workflow service is self-hosted.","pos":[6271,6490],"source":" To enable tracing, specify the desired trace listeners in the `system.diagnostics` section of the `web.config` file if the workflow service is Web-hosted, or the `app.config` file if the workflow service is self-hosted."},{"content":"To include the contents of the messages in the trace file, specify <ph id=\"ph1\">`true`</ph> for <ph id=\"ph2\">`logEntireMessage`</ph> in the <ph id=\"ph3\">`messageLogging`</ph> element in the <ph id=\"ph4\">`diagnostics`</ph> section of <ph id=\"ph5\">`system.serviceModel`</ph>.","pos":[6491,6674],"source":" To include the contents of the messages in the trace file, specify `true` for `logEntireMessage` in the `messageLogging` element in the `diagnostics` section of `system.serviceModel`."},{"content":"In the following example, tracing information, including the content of the messages, is configured to be written to a file that is named <ph id=\"ph1\">`service.svclog`</ph>.","pos":[6675,6830],"source":" In the following example, tracing information, including the content of the messages, is configured to be written to a file that is named `service.svclog`."},{"content":"To view the trace information that is contained in <ph id=\"ph1\">`service.svclog`</ph>, the <bpt id=\"p1\">[</bpt>Service Trace Viewer Tool (SvcTraceViewer.exe)<ept id=\"p1\">](../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md)</ept> is used.","pos":[7855,8065],"source":"To view the trace information that is contained in `service.svclog`, the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md) is used."},{"content":"This is especially useful when troubleshooting content-based correlation issues because you can view the message contents and see exactly what is being passed, and whether it matches the <ph id=\"ph1\">&lt;xref:System.ServiceModel.CorrelationQuery&gt;</ph> for the content-based correlation.","pos":[8066,8331],"source":" This is especially useful when troubleshooting content-based correlation issues because you can view the message contents and see exactly what is being passed, and whether it matches the <xref:System.ServiceModel.CorrelationQuery> for the content-based correlation."},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> WCF tracing, see <bpt id=\"p1\">[</bpt>Service Trace Viewer Tool (SvcTraceViewer.exe)<ept id=\"p1\">](../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md)</ept>, <bpt id=\"p2\">[</bpt>Configuring Tracing<ept id=\"p2\">](../../../../docs/framework/wcf/diagnostics/tracing/configuring-tracing.md)</ept>, and <bpt id=\"p3\">[</bpt>Using Tracing to Troubleshoot Your Application<ept id=\"p3\">](../../../../docs/framework/wcf/diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md)</ept>.","pos":[8332,8788],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] WCF tracing, see [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md), [Configuring Tracing](../../../../docs/framework/wcf/diagnostics/tracing/configuring-tracing.md), and [Using Tracing to Troubleshoot Your Application](../../../../docs/framework/wcf/diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md)."},{"pos":[8797,8839],"content":"Common Context Exchange Correlation Issues","linkify":"Common Context Exchange Correlation Issues","nodes":[{"content":"Common Context Exchange Correlation Issues","pos":[0,42]}]},{"content":"Certain types of correlation require that a specific type of binding is used for the correlation to work correctly.","pos":[8843,8958]},{"content":"Examples include request-reply correlation, which requires a two-way binding such as <ph id=\"ph1\">&lt;xref:System.ServiceModel.BasicHttpBinding&gt;</ph>, and context exchange correlation, which requires a context-based binding such as <ph id=\"ph2\">&lt;xref:System.ServiceModel.BasicHttpContextBinding&gt;</ph>.","pos":[8959,9221],"source":" Examples include request-reply correlation, which requires a two-way binding such as <xref:System.ServiceModel.BasicHttpBinding>, and context exchange correlation, which requires a context-based binding such as <xref:System.ServiceModel.BasicHttpContextBinding>."},{"content":"Most bindings support two-way operations so this is not a common issue for request-reply correlation, but there are only a handful of context-based bindings including <ph id=\"ph1\">&lt;xref:System.ServiceModel.BasicHttpContextBinding&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.ServiceModel.WSHttpContextBinding&gt;</ph>, and <ph id=\"ph3\">&lt;xref:System.ServiceModel.NetTcpContextBinding&gt;</ph>.","pos":[9222,9542],"source":" Most bindings support two-way operations so this is not a common issue for request-reply correlation, but there are only a handful of context-based bindings including <xref:System.ServiceModel.BasicHttpContextBinding>, <xref:System.ServiceModel.WSHttpContextBinding>, and <xref:System.ServiceModel.NetTcpContextBinding>."},{"content":"If one of these bindings is not used, the initial call to a workflow service will succeed, but subsequent calls will fail with the following <ph id=\"ph1\">&lt;xref:System.ServiceModel.FaultException&gt;</ph>.","pos":[9543,9726],"source":" If one of these bindings is not used, the initial call to a workflow service will succeed, but subsequent calls will fail with the following <xref:System.ServiceModel.FaultException>."},{"content":"The context information that is used for context correlation can be returned by the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.SendReply&gt;</ph> to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity that initializes the context correlation when using a two-way operation, or it can be specified by the caller if the operation is one-way.","pos":[10051,10383],"source":"The context information that is used for context correlation can be returned by the <xref:System.ServiceModel.Activities.SendReply> to the <xref:System.ServiceModel.Activities.Receive> activity that initializes the context correlation when using a two-way operation, or it can be specified by the caller if the operation is one-way."},{"content":"If the context is not sent by the caller or returned by the workflow service, then the same <ph id=\"ph1\">&lt;xref:System.ServiceModel.FaultException&gt;</ph> described previously will be returned when a subsequent operation is invoked.","pos":[10384,10595],"source":" If the context is not sent by the caller or returned by the workflow service, then the same <xref:System.ServiceModel.FaultException> described previously will be returned when a subsequent operation is invoked."},{"pos":[10602,10761],"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)]</ph> <bpt id=\"p1\">[</bpt>Context Exchange<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/context-exchange-correlation.md)</ept>.","source":"[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Context Exchange](../../../../docs/framework/wcf/feature-details/context-exchange-correlation.md)."},{"pos":[10770,10809],"content":"Common Request-Reply Correlation Issues","linkify":"Common Request-Reply Correlation Issues","nodes":[{"content":"Common Request-Reply Correlation Issues","pos":[0,39]}]},{"content":"Request-reply correlation is used with a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph><ph id=\"ph2\">/</ph><ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.SendReply&gt;</ph> pair to implement a two-way operation in a workflow service and with a <ph id=\"ph4\">&lt;xref:System.ServiceModel.Activities.Send&gt;</ph><ph id=\"ph5\">/</ph><ph id=\"ph6\">&lt;xref:System.ServiceModel.Activities.ReceiveReply&gt;</ph> pair that invokes a two-way operation in another Web service.","pos":[10813,11174],"source":"Request-reply correlation is used with a <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> pair to implement a two-way operation in a workflow service and with a <xref:System.ServiceModel.Activities.Send>/<xref:System.ServiceModel.Activities.ReceiveReply> pair that invokes a two-way operation in another Web service."},{"content":"When invoking a two-way operation in a WCF service, the service can be either a traditional imperative code-based <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> service or it can be a workflow service.","pos":[11175,11385],"source":" When invoking a two-way operation in a WCF service, the service can be either a traditional imperative code-based [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service or it can be a workflow service."},{"content":"To use request-reply correlation a two-way binding must be used, such as <ph id=\"ph1\">&lt;xref:System.ServiceModel.BasicHttpBinding&gt;</ph>, and the operations must be two-way.","pos":[11386,11539],"source":" To use request-reply correlation a two-way binding must be used, such as <xref:System.ServiceModel.BasicHttpBinding>, and the operations must be two-way."},{"content":"If the workflow service has two-way operations in parallel, or overlapping <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph><ph id=\"ph2\">/</ph><ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.SendReply&gt;</ph> or <ph id=\"ph4\">&lt;xref:System.ServiceModel.Activities.Send&gt;</ph><ph id=\"ph5\">/</ph><ph id=\"ph6\">&lt;xref:System.ServiceModel.Activities.ReceiveReply&gt;</ph> pairs, then the implicit correlation handle management provided by <ph id=\"ph7\">&lt;xref:System.ServiceModel.Activities.WorkflowServiceHost&gt;</ph> may not be sufficient, especially in high-stress scenarios, and messages may not be correctly routed.","pos":[11546,12038],"source":"If the workflow service has two-way operations in parallel, or overlapping <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> or <xref:System.ServiceModel.Activities.Send>/<xref:System.ServiceModel.Activities.ReceiveReply> pairs, then the implicit correlation handle management provided by <xref:System.ServiceModel.Activities.WorkflowServiceHost> may not be sufficient, especially in high-stress scenarios, and messages may not be correctly routed."},{"content":"To prevent this issue from occurring, we recommend that you always explicitly specify a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.CorrelationHandle&gt;</ph> when using request-reply correlation.","pos":[12039,12220],"source":" To prevent this issue from occurring, we recommend that you always explicitly specify a <xref:System.ServiceModel.Activities.CorrelationHandle> when using request-reply correlation."},{"content":"When using the <bpt id=\"p1\">**</bpt>SendAndReceiveReply<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>ReceiveAndSendReply<ept id=\"p2\">**</ept> templates from the Messaging section of the <bpt id=\"p3\">**</bpt>Toolbox<ept id=\"p3\">**</ept> in the workflow designer, a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.CorrelationHandle&gt;</ph> is explicitly configured by default.","pos":[12221,12464],"source":" When using the **SendAndReceiveReply** and **ReceiveAndSendReply** templates from the Messaging section of the **Toolbox** in the workflow designer, a <xref:System.ServiceModel.Activities.CorrelationHandle> is explicitly configured by default."},{"content":"When building a workflow by using code, the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.CorrelationHandle&gt;</ph> is specified in the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.Receive.CorrelationInitializers%2A&gt;</ph> of the first activity in the pair.","pos":[12465,12692],"source":" When building a workflow by using code, the <xref:System.ServiceModel.Activities.CorrelationHandle> is specified in the <xref:System.ServiceModel.Activities.Receive.CorrelationInitializers%2A> of the first activity in the pair."},{"content":"In the following example, a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity is configured with an explicit <ph id=\"ph2\">&lt;xref:System.ServiceModel.Activities.CorrelationInitializer.CorrelationHandle%2A&gt;</ph> specified in the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.RequestReplyCorrelationInitializer&gt;</ph>.","pos":[12693,12979],"source":" In the following example, a <xref:System.ServiceModel.Activities.Receive> activity is configured with an explicit <xref:System.ServiceModel.Activities.CorrelationInitializer.CorrelationHandle%2A> specified in the <xref:System.ServiceModel.Activities.RequestReplyCorrelationInitializer>."},{"content":"Persistence is not permitted between a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph><ph id=\"ph2\">/</ph><ph id=\"ph3\">&lt;xref:System.ServiceModel.Activities.SendReply&gt;</ph> pair or a <ph id=\"ph4\">&lt;xref:System.ServiceModel.Activities.Send&gt;</ph><ph id=\"ph5\">/</ph><ph id=\"ph6\">&lt;xref:System.ServiceModel.Activities.ReceiveReply&gt;</ph> pair.","pos":[13622,13864],"source":"Persistence is not permitted between a <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> pair or a <xref:System.ServiceModel.Activities.Send>/<xref:System.ServiceModel.Activities.ReceiveReply> pair."},{"content":"A no-persist zone is created that lasts until both activities have completed.","pos":[13865,13942]},{"content":"If an activity, such as a delay activity, is in this no-persist zone and causes the workflow to become idle, the workflow will not persist even if it the host is configured to persist workflows when they become idle.","pos":[13943,14159]},{"content":"If an activity, such as a persist activity, attempts to explicitly persist in the no-persist zone, a fatal exception is thrown, the workflow aborts, and a <ph id=\"ph1\">&lt;xref:System.ServiceModel.FaultException&gt;</ph> is returned to the caller.","pos":[14160,14383],"source":" If an activity, such as a persist activity, attempts to explicitly persist in the no-persist zone, a fatal exception is thrown, the workflow aborts, and a <xref:System.ServiceModel.FaultException> is returned to the caller."},{"content":"The fatal exception message is \"System.InvalidOperationException: Persist activities cannot be contained within no persistence blocks.\".","pos":[14384,14520]},{"content":"This exception is not returned to the caller but can be observed if tracking is enabled.","pos":[14521,14609]},{"content":"The message for the <ph id=\"ph1\">&lt;xref:System.ServiceModel.FaultException&gt;</ph> returned to the caller is \"The operation could not be performed because WorkflowInstance '5836145b-7da2-49d0-a052-a49162adeab6' has completed\".","pos":[14610,14815],"source":" The message for the <xref:System.ServiceModel.FaultException> returned to the caller is \"The operation could not be performed because WorkflowInstance '5836145b-7da2-49d0-a052-a49162adeab6' has completed\"."},{"pos":[14822,15002],"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> request-reply correlation, see <bpt id=\"p1\">[</bpt>Request-Reply<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/request-reply-correlation.md)</ept>.","source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] request-reply correlation, see [Request-Reply](../../../../docs/framework/wcf/feature-details/request-reply-correlation.md)."},{"pos":[15011,15044],"content":"Common Content Correlation Issues","linkify":"Common Content Correlation Issues","nodes":[{"content":"Common Content Correlation Issues","pos":[0,33]}]},{"content":"Content-based correlation is used when a workflow service receives multiple messages and a piece of data in the exchanged messages identifies the desired instance.","pos":[15048,15211]},{"content":"Content-based correlation uses this data in the message, such as a customer number or order ID, to route messages to the correct workflow instance.","pos":[15212,15359]},{"content":"This section describes several common issues that may occur when using content-based correlation.","pos":[15360,15457]},{"pos":[15467,15504],"content":"Ensure the Identifying Data Is Unique","linkify":"Ensure the Identifying Data Is Unique","nodes":[{"content":"Ensure the Identifying Data Is Unique","pos":[0,37]}]},{"content":"The data that is used to identify the instance is hashed into a correlation key.","pos":[15508,15588]},{"content":"Care must be taken to guarantee that the data that is used for correlation is unique or else collisions in the hashed key might occur and cause messages to be misrouted.","pos":[15589,15758]},{"content":"For example, a correlation based only on a customer name may cause a collision because there may be multiple customers who have the same name.","pos":[15759,15901]},{"content":"The colon (:) should not be used as part of the data that is used to correlate the message because it is already used to delimit the message query’s key and value to form the string that is subsequently hashed.","pos":[15902,16112]},{"content":"If persistence is being used, make sure that the current identifying data has not been used by a previously persisted instance.","pos":[16113,16240]},{"content":"Temporarily disabling persistence can help identify this issue.","pos":[16241,16304]},{"content":"WCF tracing can be used to view the calculated correlation key and is useful for debugging this kind of issue.","pos":[16305,16415]},{"pos":[16425,16440],"content":"Race Conditions","linkify":"Race Conditions","nodes":[{"content":"Race Conditions","pos":[0,15]}]},{"content":"There is a small gap in time between the service receiving a message and the correlation actually being initialized, during which follow-up messages will be ignored.","pos":[16444,16609]},{"content":"If a workflow service initializes the content-based correlation by using data passed from the client over a one-way operation, and the caller sends immediate follow-up messages, these messages will be ignored during this interval.","pos":[16610,16840]},{"content":"This can be avoided by using a two-way operation to initialize the correlation, or by using a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.TransactedReceiveScope&gt;</ph>.","pos":[16841,16996],"source":" This can be avoided by using a two-way operation to initialize the correlation, or by using a <xref:System.ServiceModel.Activities.TransactedReceiveScope>."},{"pos":[17006,17030],"content":"Correlation Query Issues","linkify":"Correlation Query Issues","nodes":[{"content":"Correlation Query Issues","pos":[0,24]}]},{"content":"Correlation queries are used to specify what data in a message is used to correlate the message.","pos":[17034,17130]},{"content":"This data is specified by using an XPath query.","pos":[17131,17178]},{"content":"If messages to a service are not being dispatched even though everything appears to be correct, one strategy for troubleshooting is to specify a literal value that matches the value of the message data instead of an XPath query.","pos":[17179,17407]},{"content":"To specify a literal value, use the <ph id=\"ph1\">`string`</ph> function.","pos":[17408,17462],"source":" To specify a literal value, use the `string` function."},{"content":"In the following example, a <ph id=\"ph1\">&lt;xref:System.ServiceModel.MessageQuerySet&gt;</ph> is configured to use a literal value of <ph id=\"ph2\">`11445`</ph> for the <ph id=\"ph3\">`OrderId`</ph> and the XPath query is commented out.","pos":[17463,17637],"source":" In the following example, a <xref:System.ServiceModel.MessageQuerySet> is configured to use a literal value of `11445` for the `OrderId` and the XPath query is commented out."},{"content":"If an XPath query is configured incorrectly such that no correlation data is retrieved, a fault is returned with the following message: \"A correlation query yielded an empty result set.","pos":[17892,18077]},{"content":"Please ensure correlation queries for the endpoint are correctly configured.\"","pos":[18078,18155]},{"content":"One quick way to troubleshoot this is to replace the XPath query with a literal value as described in the previous section.","pos":[18156,18279]},{"content":"This issue can occur if you use the XPath query builder in the <bpt id=\"p1\">**</bpt>Add Correlation Initializers<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>CorrelatesOn Definition<ept id=\"p2\">**</ept> dialog boxes and your workflow service uses message contracts.","pos":[18280,18469],"source":" This issue can occur if you use the XPath query builder in the **Add Correlation Initializers** or **CorrelatesOn Definition** dialog boxes and your workflow service uses message contracts."},{"content":"In the following example, a message contract class is defined.","pos":[18470,18532]},{"content":"This message contract is used by a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity in a workflow.","pos":[18726,18830],"source":"This message contract is used by a <xref:System.ServiceModel.Activities.Receive> activity in a workflow."},{"content":"The <ph id=\"ph1\">`CartId`</ph> in the header of the message is used to correlate the message to the correct instance.","pos":[18831,18930],"source":" The `CartId` in the header of the message is used to correlate the message to the correct instance."},{"content":"If the XPath query that retrieves the <ph id=\"ph1\">`CartId`</ph> is created using the correlation dialogs in the workflow designer, the following incorrect XPath query is generated.","pos":[18931,19094],"source":" If the XPath query that retrieves the `CartId` is created using the correlation dialogs in the workflow designer, the following incorrect XPath query is generated."},{"content":"This XPath query would be correct if the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity used parameters for the data, but since it is using a message contract it is incorrect.","pos":[19158,19341],"source":"This XPath query would be correct if the <xref:System.ServiceModel.Activities.Receive> activity used parameters for the data, but since it is using a message contract it is incorrect."},{"content":"The following XPath query is the correct XPath query to retrieve the <ph id=\"ph1\">`CartId`</ph> from the header.","pos":[19342,19436],"source":" The following XPath query is the correct XPath query to retrieve the `CartId` from the header."},{"content":"This can be confirmed by examining the body of the message.","pos":[19487,19546]},{"content":"The following example shows a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activities.Receive&gt;</ph> activity configured for an <ph id=\"ph2\">`AddItem`</ph> operation that uses the previous message contract to receive data.","pos":[20052,20231],"source":"The following example shows a <xref:System.ServiceModel.Activities.Receive> activity configured for an `AddItem` operation that uses the previous message contract to receive data."},{"content":"The XPath query is correctly configured.","pos":[20232,20272]},{"pos":[21011,21319],"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> content-based correlation, see <bpt id=\"p1\">[</bpt>Content Based<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/content-based-correlation.md)</ept> and the <bpt id=\"p2\">[</bpt>Correlated Calculator<ept id=\"p2\">](../../../../docs/framework/windows-workflow-foundation/samples/correlated-calculator.md)</ept> sample.","source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] content-based correlation, see [Content Based](../../../../docs/framework/wcf/feature-details/content-based-correlation.md) and the [Correlated Calculator](../../../../docs/framework/windows-workflow-foundation/samples/correlated-calculator.md) sample."}]}