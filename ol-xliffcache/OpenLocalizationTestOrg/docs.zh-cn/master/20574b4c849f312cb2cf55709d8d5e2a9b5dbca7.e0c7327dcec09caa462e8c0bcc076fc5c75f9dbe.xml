{"content":"---\ntitle: \"Custom Channel Dispatcher\"\nms.date: \"03/30/2017\"\nms.assetid: 813acf03-9661-4d57-a3c7-eeab497321c6\n---\n# Custom Channel Dispatcher\nThis sample demonstrates how to build the channel stack in a custom way by implementing <xref:System.ServiceModel.ServiceHostBase> directly and how to create a custom channel dispatcher in Web host environment. The channel dispatcher interacts with <xref:System.ServiceModel.Channels.IChannelListener> to accept channels and retrieves messages from the channel stack. This sample also provides a basic sample to show how to build a channel stack in a Web host environment by using <xref:System.ServiceModel.Activation.VirtualPathExtension>.  \n  \n## Custom ServiceHostBase  \n This sample implements the base type <xref:System.ServiceModel.ServiceHostBase> instead of <xref:System.ServiceModel.ServiceHost> to demonstrate how to replace the Windows Communication Foundation (WCF) stack implementation with a custom message handling layer on top of the channel stack. You override the virtual method <xref:System.ServiceModel.ServiceHostBase.InitializeRuntime%2A> to build channel listeners and the channel dispatcher.  \n  \n To implement a Web-hosted service, get the service extension <xref:System.ServiceModel.Activation.VirtualPathExtension> from the <xref:System.ServiceModel.ServiceHostBase.Extensions%2A> collection and add it to the <xref:System.ServiceModel.Channels.BindingParameterCollection> so that the transport layer knows how to configure the channel listener based on the hosting environment settings, that is, the Internet Information Services (IIS)/Windows Process Activation Service (WAS) settings.  \n  \n## Custom Channel Dispatcher  \n The custom channel dispatcher extends the type <xref:System.ServiceModel.Dispatcher.ChannelDispatcherBase>. This type implements the channel-layer programming logic. In this sample, only <xref:System.ServiceModel.Channels.IReplyChannel> is supported for request-reply message exchange pattern, but the custom channel dispatcher can be easily extended to other channel types.  \n  \n The dispatcher first opens the channel listener and then accepts the singleton reply channel. With the channel, it starts to send messages (requests) in an infinite loop. For each request, it creates a reply message and sends it back to the client.  \n  \n## Creating a Response Message  \n The message processing is implemented in the type `MyServiceManager`. In the `HandleRequest` method, the `Action` header of the message is first checked to see whether the request is supported. A predefined SOAP action \"http://tempuri.org/HelloWorld/Hello\" is defined to provide message filtering. This is similar to the service contract concept in the WCF implementation of <xref:System.ServiceModel.ServiceHost>.  \n  \n For the correct SOAP action case, the sample retrieves the requested message data and generates a corresponding response to the request similar to what is seen in the <xref:System.ServiceModel.ServiceHost> case.  \n  \n You specially handled the HTTP-GET verb by returning a custom HTML message, in this, case so that you can browse the service from a browser to see that it is compiled correctly. If the SOAP action does not match, send a fault message back to indicate that the request is not supported.  \n  \n The client of this sample is a normal WCF client that does not assume anything from the service. So, the service is specially designed to match what you get from a normal WCF<xref:System.ServiceModel.ServiceHost> implementation. As a result, only a service contract is required on the client.  \n  \n## Using the sample  \n Running the client application directly produces the following output.  \n  \n```Output  \nClient is talking to a request/reply WCF service.   \nType what you want to say to the server: Howdy  \nServer replied: You said: Howdy. Message id: 1  \nServer replied: You said: Howdy. Message id: 2  \nServer replied: You said: Howdy. Message id: 3  \nServer replied: You said: Howdy. Message id: 4  \nServer replied: You said: Howdy. Message id: 5  \n```  \n  \n You can also browse the service from a browser so that an HTTP-GET message gets processed on the server. This gets you well-formatted HTML text back.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Extensibility\\Channels\\CustomChannelDispatcher`\n","nodes":[{"pos":[4,109],"embed":true,"restype":"x-metadata","content":"title: \"Custom Channel Dispatcher\"\nms.date: \"03/30/2017\"\nms.assetid: 813acf03-9661-4d57-a3c7-eeab497321c6","nodes":[{"content":"Custom Channel Dispatcher","nodes":[{"pos":[0,25],"content":"Custom Channel Dispatcher","nodes":[{"content":"Custom Channel Dispatcher","pos":[0,25]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[116,141],"content":"Custom Channel Dispatcher","linkify":"Custom Channel Dispatcher","nodes":[{"content":"Custom Channel Dispatcher","pos":[0,25]}]},{"content":"This sample demonstrates how to build the channel stack in a custom way by implementing <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHostBase&gt;</ph> directly and how to create a custom channel dispatcher in Web host environment.","pos":[142,352],"source":"This sample demonstrates how to build the channel stack in a custom way by implementing <xref:System.ServiceModel.ServiceHostBase> directly and how to create a custom channel dispatcher in Web host environment."},{"content":"The channel dispatcher interacts with <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IChannelListener&gt;</ph> to accept channels and retrieves messages from the channel stack.","pos":[353,509],"source":" The channel dispatcher interacts with <xref:System.ServiceModel.Channels.IChannelListener> to accept channels and retrieves messages from the channel stack."},{"content":"This sample also provides a basic sample to show how to build a channel stack in a Web host environment by using <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activation.VirtualPathExtension&gt;</ph>.","pos":[510,682],"source":" This sample also provides a basic sample to show how to build a channel stack in a Web host environment by using <xref:System.ServiceModel.Activation.VirtualPathExtension>."},{"pos":[691,713],"content":"Custom ServiceHostBase","linkify":"Custom ServiceHostBase","nodes":[{"content":"Custom ServiceHostBase","pos":[0,22]}]},{"content":"This sample implements the base type <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHostBase&gt;</ph> instead of <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> to demonstrate how to replace the Windows Communication Foundation (WCF) stack implementation with a custom message handling layer on top of the channel stack.","pos":[717,1006],"source":"This sample implements the base type <xref:System.ServiceModel.ServiceHostBase> instead of <xref:System.ServiceModel.ServiceHost> to demonstrate how to replace the Windows Communication Foundation (WCF) stack implementation with a custom message handling layer on top of the channel stack."},{"content":"You override the virtual method <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHostBase.InitializeRuntime%2A&gt;</ph> to build channel listeners and the channel dispatcher.","pos":[1007,1157],"source":" You override the virtual method <xref:System.ServiceModel.ServiceHostBase.InitializeRuntime%2A> to build channel listeners and the channel dispatcher."},{"pos":[1164,1656],"content":"To implement a Web-hosted service, get the service extension <ph id=\"ph1\">&lt;xref:System.ServiceModel.Activation.VirtualPathExtension&gt;</ph> from the <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceHostBase.Extensions%2A&gt;</ph> collection and add it to the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.BindingParameterCollection&gt;</ph> so that the transport layer knows how to configure the channel listener based on the hosting environment settings, that is, the Internet Information Services (IIS)/Windows Process Activation Service (WAS) settings.","source":"To implement a Web-hosted service, get the service extension <xref:System.ServiceModel.Activation.VirtualPathExtension> from the <xref:System.ServiceModel.ServiceHostBase.Extensions%2A> collection and add it to the <xref:System.ServiceModel.Channels.BindingParameterCollection> so that the transport layer knows how to configure the channel listener based on the hosting environment settings, that is, the Internet Information Services (IIS)/Windows Process Activation Service (WAS) settings."},{"pos":[1665,1690],"content":"Custom Channel Dispatcher","linkify":"Custom Channel Dispatcher","nodes":[{"content":"Custom Channel Dispatcher","pos":[0,25]}]},{"content":"The custom channel dispatcher extends the type <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.ChannelDispatcherBase&gt;</ph>.","pos":[1694,1801],"source":"The custom channel dispatcher extends the type <xref:System.ServiceModel.Dispatcher.ChannelDispatcherBase>."},{"content":"This type implements the channel-layer programming logic.","pos":[1802,1859]},{"content":"In this sample, only <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IReplyChannel&gt;</ph> is supported for request-reply message exchange pattern, but the custom channel dispatcher can be easily extended to other channel types.","pos":[1860,2068],"source":" In this sample, only <xref:System.ServiceModel.Channels.IReplyChannel> is supported for request-reply message exchange pattern, but the custom channel dispatcher can be easily extended to other channel types."},{"content":"The dispatcher first opens the channel listener and then accepts the singleton reply channel.","pos":[2075,2168]},{"content":"With the channel, it starts to send messages (requests) in an infinite loop.","pos":[2169,2245]},{"content":"For each request, it creates a reply message and sends it back to the client.","pos":[2246,2323]},{"pos":[2332,2359],"content":"Creating a Response Message","linkify":"Creating a Response Message","nodes":[{"content":"Creating a Response Message","pos":[0,27]}]},{"content":"The message processing is implemented in the type <ph id=\"ph1\">`MyServiceManager`</ph>.","pos":[2363,2432],"source":"The message processing is implemented in the type `MyServiceManager`."},{"content":"In the <ph id=\"ph1\">`HandleRequest`</ph> method, the <ph id=\"ph2\">`Action`</ph> header of the message is first checked to see whether the request is supported.","pos":[2433,2556],"source":" In the `HandleRequest` method, the `Action` header of the message is first checked to see whether the request is supported."},{"content":"A predefined SOAP action \"<ph id=\"ph1\">http://tempuri.org/HelloWorld/Hello</ph>\" is defined to provide message filtering.","pos":[2557,2660],"source":" A predefined SOAP action \"http://tempuri.org/HelloWorld/Hello\" is defined to provide message filtering."},{"content":"This is similar to the service contract concept in the WCF implementation of <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>.","pos":[2661,2777],"source":" This is similar to the service contract concept in the WCF implementation of <xref:System.ServiceModel.ServiceHost>."},{"pos":[2784,2995],"content":"For the correct SOAP action case, the sample retrieves the requested message data and generates a corresponding response to the request similar to what is seen in the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> case.","source":"For the correct SOAP action case, the sample retrieves the requested message data and generates a corresponding response to the request similar to what is seen in the <xref:System.ServiceModel.ServiceHost> case."},{"content":"You specially handled the HTTP-GET verb by returning a custom HTML message, in this, case so that you can browse the service from a browser to see that it is compiled correctly.","pos":[3002,3179]},{"content":"If the SOAP action does not match, send a fault message back to indicate that the request is not supported.","pos":[3180,3287]},{"content":"The client of this sample is a normal WCF client that does not assume anything from the service.","pos":[3294,3390]},{"content":"So, the service is specially designed to match what you get from a normal WCF<ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> implementation.","pos":[3391,3522],"source":" So, the service is specially designed to match what you get from a normal WCF<xref:System.ServiceModel.ServiceHost> implementation."},{"content":"As a result, only a service contract is required on the client.","pos":[3523,3586]},{"pos":[3595,3611],"content":"Using the sample","linkify":"Using the sample","nodes":[{"content":"Using the sample","pos":[0,16]}]},{"content":"Running the client application directly produces the following output.","pos":[3615,3685]},{"content":"You can also browse the service from a browser so that an HTTP-GET message gets processed on the server.","pos":[4060,4164]},{"content":"This gets you well-formatted HTML text back.","pos":[4165,4209]},{"pos":[4217,4349],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[4403,4713],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[4714,4764]}]}