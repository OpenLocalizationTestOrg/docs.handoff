{"content":"---\ntitle: \"MSMQ Activation\"\nms.date: \"03/30/2017\"\nms.assetid: e3834149-7b8c-4a54-806b-b4296720f31d\n---\n# MSMQ Activation\nThis sample demonstrates how to host applications in Windows Process Activation Service (WAS) that are read from a message queue. This sample uses the `netMsmqBinding` and is based on the [Two-Way Communication](../../../../docs/framework/wcf/samples/two-way-communication.md) sample. The service in this case is a Web-hosted application and the client is self-hosted and outputs to the console to observe the status of purchase orders submitted.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n> [!NOTE]\n>  The samples may already be installed on your computer. Check for the following (default) directory before continuing.  \n>   \n>  \\<InstallDrive>:\\WF_WCF_Samples  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all WCF and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  \\<InstallDrive>:\\Samples\\WCFWFCardSpace\\WCF\\Basic\\Services\\Hosting\\WASHost\\MsmqActivation.  \n  \n Windows Process Activation Service (WAS), the new process activation mechanism for [!INCLUDE[lserver](../../../../includes/lserver-md.md)], provides IIS-like features that were previously only available to HTTP-based applications to applications that use non-HTTP protocols. Windows Communication Foundation (WCF) uses the Listener Adapter interface to communicate activation requests that are received over the non-HTTP protocols supported by WCF, such as TCP, Named Pipes, and MSMQ. The functionality for receiving requests over non-HTTP protocols is hosted by managed Windows services running in SMSvcHost.exe.  \n  \n The Net.Msmq Listener Adapter service (NetMsmqActivator) activates queued applications based on messages in the queue.  \n  \n The client sends purchase orders to the service from within the scope of a transaction. The service receives the orders in a transaction and processes them. The service then calls back the client with the status of the order. To facilitate two-way communication the client and service both use queues to enqueue purchase orders and order status.  \n  \n The service contract `IOrderProcessor` defines the one-way service operations that work with queuing. The service operation uses the reply endpoint to send order statuses to the client. The reply endpoint's address is the URI of the queue used to send the order status back to the client. The order processing application implements this contract.  \n  \n```csharp  \n[ServiceContract(Namespace=\"http://Microsoft.ServiceModel.Samples\")]  \npublic interface IOrderProcessor  \n{  \n    [OperationContract(IsOneWay = true)]  \n    void SubmitPurchaseOrder(PurchaseOrder po,   \n                                           string reportOrderStatusTo);  \n}  \n```  \n  \n The reply contract to send order status to is specified by the client. The client implements the order status contract. The service uses the generated client of this contract to send order status back to the client.  \n  \n```csharp  \n[ServiceContract]  \npublic interface IOrderStatus  \n{  \n    [OperationContract(IsOneWay = true)]  \n    void OrderStatus(string poNumber, string status);  \n}  \n```  \n  \n The service operation processes the submitted purchase order. The <xref:System.ServiceModel.OperationBehaviorAttribute> is applied to the service operation to specify automatic enlistment in the transaction that is used to receive the message from the queue and automatic completion of the transaction on completion of the service operation. The `Orders` class encapsulates order processing functionality. In this case, it adds the purchase order to a dictionary. The transaction that the service operation enlisted in is available to the operations in the `Orders` class.  \n  \n The service operation, in addition to processing the submitted purchase order, replies back to the client about the status of the order.  \n  \n```csharp  \npublic class OrderProcessorService : IOrderProcessor  \n{  \n    [OperationBehavior(TransactionScopeRequired = true, TransactionAutoComplete = true)]  \n    public void SubmitPurchaseOrder(PurchaseOrder po, string reportOrderStatusTo)  \n    {  \n        Orders.Add(po);  \n        Console.WriteLine(\"Processing {0} \", po);  \n        Console.WriteLine(\"Sending back order status information\");  \n        NetMsmqBinding msmqCallbackBinding = new NetMsmqBinding();  \n        msmqCallbackBinding.Security.Mode = NetMsmqSecurityMode.None;  \n        OrderStatusClient client = new OrderStatusClient(msmqCallbackBinding, new EndpointAddress(reportOrderStatusTo));  \n        // please note that the same transaction that is used to dequeue purchase order is used  \n        // to send back order status  \n        using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))  \n        {  \n            client.OrderStatus(po.PONumber, po.Status);  \n            scope.Complete();  \n        }  \n    }\n}\n```  \n  \n The client binding to use is specified using a configuration file.  \n  \n The MSMQ queue name is specified in an appSettings section of the configuration file. The endpoint for the service is defined in the System.serviceModel section of the configuration file.  \n  \n> [!NOTE]\n>  The MSMQ queue name and endpoint address use slightly different addressing conventions. The MSMQ queue name uses a dot (.) for the local computer and backslash separators in its path. The WCF endpoint address specifies a net.msmq: scheme, uses \"localhost\" for the local computer, and uses forward slashes in its path. To read from a queue that is hosted on the remote computer, replace the \".\" and \"localhost\" to the remote computer name.  \n  \n A .svc file with the name of the class is used to host the service code in WAS.  \n  \n The Service.svc file itself contains a directive to create the `OrderProcessorService`.  \n  \n```svc\n<%@ServiceHost language=\"c#\" Debug=\"true\" Service=\"Microsoft.ServiceModel.Samples.OrderProcessorService\"%>  \n```  \n  \n The Service.svc file also contains an assembly directive to ensure that System.Transactions.dll is loaded.  \n  \n```svc  \n<%@Assembly name=\"System.Transactions, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\"%>  \n```  \n  \n The client creates a transaction scope. Communication with the service takes place within the scope of the transaction, causing it to be treated as an atomic unit where all messages succeed or fail. The transaction is committed by calling `Complete` on the transaction scope.  \n  \n```csharp  \nusing (ServiceHost serviceHost = new ServiceHost(typeof(OrderStatusService)))  \n{  \n    // Open the ServiceHostBase to create listeners and start listening   \n    // for order status messages.  \n    serviceHost.Open();  \n  \n    // Create a proxy with given client endpoint configuration  \n    OrderProcessorClient client = new OrderProcessorClient();  \n  \n    // Create the purchase order  \n    PurchaseOrder po = new PurchaseOrder();  \n    po.CustomerId = \"somecustomer.com\";  \n    po.PONumber = Guid.NewGuid().ToString();  \n  \n    PurchaseOrderLineItem lineItem1 = new PurchaseOrderLineItem();  \n    lineItem1.ProductId = \"Blue Widget\";  \n    lineItem1.Quantity = 54;  \n    lineItem1.UnitCost = 29.99F;  \n  \n    PurchaseOrderLineItem lineItem2 = new PurchaseOrderLineItem();  \n    lineItem2.ProductId = \"Red Widget\";  \n    lineItem2.Quantity = 890;  \n    lineItem2.UnitCost = 45.89F;  \n  \n    po.orderLineItems = new PurchaseOrderLineItem[2];  \n    po.orderLineItems[0] = lineItem1;  \n    po.orderLineItems[1] = lineItem2;  \n  \n    //Create a transaction scope.  \n    using (TransactionScope scope = new   \n        TransactionScope(TransactionScopeOption.Required))  \n    {  \n        // Make a queued call to submit the purchase order  \n        client.SubmitPurchaseOrder(po,   \n       \"net.msmq://localhost/private/ServiceModelSamplesOrder/OrderStatus\");  \n        // Complete the transaction.  \n        scope.Complete();  \n    }  \n  \n    //Closing the client gracefully closes the connection and cleans up   \n    //resources  \n    client.Close();  \n  \n    Console.WriteLine();  \n    Console.WriteLine(\"Press <ENTER> to terminate client.\");  \n    Console.ReadLine();  \n  \n    // Close the ServiceHostBase to shutdown the service.  \n    serviceHost.Close();  \n    }  \n```  \n  \n The client code implements the `IOrderStatus` contract to receive order status from the service. In this case, it prints out the order status.  \n  \n```csharp  \n[ServiceBehavior]  \npublic class OrderStatusService : IOrderStatus  \n{  \n    [OperationBehavior(TransactionAutoComplete = true,   \n                        TransactionScopeRequired = true)]  \n    public void OrderStatus(string poNumber, string status)  \n    {  \n        Console.WriteLine(\"Status of order {0}:{1} \",   \n                                         poNumber , status);  \n    }  \n}  \n```  \n  \n The order status queue is created in the `Main` method. The client configuration includes the order status service configuration to host the order status service, as shown in the following sample configuration.  \n  \n```xml  \n<appSettings>  \n    <!-- use appSetting to configure MSMQ queue name -->  \n    <add key=\"targetQueueName\" value=\".\\private$\\ServiceModelSamples/service.svc\" />  \n    <add key=\"responseQueueName\" value=\".\\private$\\ServiceModelSamples/OrderStatus\" />  \n  </appSettings>  \n  \n<system.serviceModel>  \n  \n    <services>  \n      <service   \n         name=\"Microsoft.ServiceModel.Samples.OrderStatusService\">  \n        <!-- Define NetMsmqEndpoint -->  \n        <endpoint address=\"net.msmq://localhost/private/ServiceModelSamples/OrderStatus\"  \n                  binding=\"netMsmqBinding\"  \n                  contract=\"Microsoft.ServiceModel.Samples.IOrderStatus\" />  \n      </service>  \n    </services>  \n  \n    <client>  \n      <!-- Define NetMsmqEndpoint -->  \n      <endpoint name=\"OrderProcessorEndpoint\"  \n                address=\"net.msmq://localhost/private/ServiceModelSamples/service.svc\"   \n                binding=\"netMsmqBinding\"   \n                contract=\"Microsoft.ServiceModel.Samples.IOrderProcessor\" />  \n    </client>  \n  \n  </system.serviceModel>  \n```  \n  \n When you run the sample, the client and service activities are displayed in both the server and client console windows. You can see the server receive messages from the client. Press ENTER in each console window to shut down the server and client.  \n  \n The client displays the order status information sent by the server:  \n  \n```console  \nPress <ENTER> to terminate client.  \nStatus of order 70cf9d63-3dfa-4e69-81c2-23aa4478ebed :Pending  \n```  \n  \n### To set up, build, and run the sample  \n  \n1.  Ensure that [!INCLUDE[iisver](../../../../includes/iisver-md.md)] is installed, as it is required for WAS activation.  \n  \n2.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md). In addition, you must install the WCF non-HTTP activation components:  \n  \n    1.  From the **Start** menu, choose **Control Panel**.  \n  \n    2.  Select **Programs and Features**.  \n  \n    3.  Click **Turn Windows Features on or off**.  \n  \n    4.  Under **Features Summary**, click **Add Features**.  \n  \n    5.  Expand the **Microsoft .NET Framework 3.0** node and check the **Windows Communication Foundation Non-HTTP Activation** feature.  \n  \n3.  To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n4.  Run the client by executing client.exe from a command window. This creates the queue and sends a message to it. Leave the client running to see the result of the service reading the message  \n  \n5.  The MSMQ activation service runs as Network Service by default. Therefore, the queue that is used to activate the application must have receive and peek permissions for Network Service. This can be added by using the Message Queuing MMC:  \n  \n    1.  From the **Start** menu, click **Run**, then type `Compmgmt.msc` and press ENTER.  \n  \n    2.  Under **Services and Applications**, expand **Message Queuing**.  \n  \n    3.  Click **Private Queues**.  \n  \n    4.  Right-click the queue (servicemodelsamples/Service.svc) and choose **Properties**.  \n  \n    5.  On the **Security** tab, click **Add** and give peek and receive permissions to Network Service.  \n  \n6.  Configure the Windows Process Activation Service (WAS) to support MSMQ activation.  \n  \n     As a convenience, the following steps are implemented in a batch file called AddMsmqSiteBinding.cmd located in the sample directory.  \n  \n    1.  To support net.msmq activation, the default Web site must first be bound to the net.msmq protocol. This can be done using appcmd.exe, which is installed with the [!INCLUDE[iisver](../../../../includes/iisver-md.md)] management toolset. From an elevated (administrator) command prompt, run the following command.  \n  \n        ```console  \n        %windir%\\system32\\inetsrv\\appcmd.exe set site \"Default Web Site\"   \n        -+bindings.[protocol='net.msmq',bindingInformation='localhost']  \n        ```  \n  \n        > [!NOTE]\n        >  This command is a single line of text.  \n  \n         This command adds a net.msmq site binding to the default Web site.  \n  \n    2.  Although all applications within a site share a common net.msmq binding, each application can enable net.msmq support individually. To enable net.msmq for the /servicemodelsamples application, run the following command from an elevated command prompt.  \n  \n        ```console  \n        %windir%\\system32\\inetsrv\\appcmd.exe set app \"Default Web Site/servicemodelsamples\" /enabledProtocols:http,net.msmq  \n        ```  \n  \n        > [!NOTE]\n        >  This command is a single line of text.  \n  \n         This command enables the /servicemodelsamples application to be accessed using `http://localhost/servicemodelsamples` and `net.msmq://localhost/servicemodelsamples`.\n  \n7.  If you have not done so previously, ensure that the MSMQ activation service is enabled. From the **Start** menu, click **Run**, and type `Services.msc`. Search the list of services for the **Net.Msmq Listener Adapter**. Right-click and select **Properties**. Set the **Startup Type** to **Automatic**, click **Apply** and click the **Start** button. This step must only be done once prior to the first usage of the Net.Msmq Listener Adapter service.  \n  \n8.  To run the sample in a single- or cross-computer configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md). Additionally, change the code on the client that submits the purchase order to reflect the computer name in the URI of the queue when submitting the purchase order. Use the following code:  \n  \n    ```csharp  \n    client.SubmitPurchaseOrder(po, \"net.msmq://localhost/private/ServiceModelSamples/OrderStatus\");  \n    ```  \n  \n9. Remove the net.msmq site binding you added for this sample.  \n  \n     As a convenience, the following steps are implemented in a batch file called RemoveMsmqSiteBinding.cmd located in the sample directory:  \n  \n    1.  Remove net.msmq from the list of enabled protocols by running the following command from an elevated command prompt.  \n  \n        ```console  \n        %windir%\\system32\\inetsrv\\appcmd.exe set app \"Default Web Site/servicemodelsamples\" /enabledProtocols:http  \n        ```  \n  \n        > [!NOTE]\n        >  This command is a single line of text.  \n  \n    2.  Remove the net.msmq site binding by running the following command from an elevated command prompt.  \n  \n        ```console  \n        %windir%\\system32\\inetsrv\\appcmd.exe set site \"Default Web Site\" --bindings.[protocol='net.msmq',bindingInformation='localhost']  \n        ```  \n  \n        > [!NOTE]\n        >  This command is a single line of text.  \n  \n    > [!WARNING]\n    >  Running the batch file will reset the DefaultAppPool to run using .NET Framework version 2.0.  \n  \n By default with the `netMsmqBinding` binding transport, security is enabled. Two properties, `MsmqAuthenticationMode` and `MsmqProtectionLevel`, together determine the type of transport security. By default the authentication mode is set to `Windows` and the protection level is set to `Sign`. For MSMQ to provide the authentication and signing feature, it must be part of a domain. If you run this sample on a computer that is not part of a domain, the following error is received: \"User's internal message queuing certificate does not exist\".  \n  \n### To run the sample on a computer joined to a workgroup  \n  \n1.  If your computer is not part of a domain, turn off transport security by setting the authentication mode and protection level to none as shown in the following sample configuration.  \n  \n    ```xml  \n    <bindings>  \n        <netMsmqBinding>  \n            <binding configurationName=\"TransactedBinding\">  \n                <security mode=\"None\"/>  \n            </binding>  \n        </netMsmqBinding>  \n    </bindings>  \n    ```  \n  \n2.  Change the configuration on both the server and the client before you run the sample.  \n  \n    > [!NOTE]\n    >  Setting `security mode` to `None` is equivalent to setting `MsmqAuthenticationMode`, `MsmqProtectionLevel` and `Message` security to `None`.  \n  \n3.  To enable activation in a computer joined to a workgroup, both the activation service and the worker process must be run with a specific user account (must be same for both) and the queue must have ACLs for the specific user account.  \n  \n     To change the identity that the worker process runs under:  \n  \n    1.  Run Inetmgr.exe.  \n  \n    2.  Under **Application Pools**, right-click the **AppPool** (typically **DefaultAppPool**) and choose **Set Application Pool Defaults…**.  \n  \n    3.  Change the Identity properties to use the specific user account.  \n  \n     To change the identity that the Activation Service runs under:  \n  \n    1.  Run Services.msc.  \n  \n    2.  Right-click the **Net.MsmqListener Adapter**, and choose **Properties**.  \n  \n4.  Change the account in the **LogOn** tab.  \n  \n5.  In workgroup, the service must also run using an unrestricted token. To do this, run the following in a command window:  \n  \n    ```console  \n    sc sidtype netmsmqactivator unrestricted  \n    ```  \n  \n## See also\n\n- [AppFabric Hosting and Persistence Samples](https://go.microsoft.com/fwlink/?LinkId=193961)\n","nodes":[{"pos":[4,99],"embed":true,"restype":"x-metadata","content":"title: \"MSMQ Activation\"\nms.date: \"03/30/2017\"\nms.assetid: e3834149-7b8c-4a54-806b-b4296720f31d","nodes":[{"content":"MSMQ Activation","nodes":[{"pos":[0,15],"content":"MSMQ Activation","nodes":[{"content":"MSMQ Activation","pos":[0,15]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[106,121],"content":"MSMQ Activation","linkify":"MSMQ Activation","nodes":[{"content":"MSMQ Activation","pos":[0,15]}]},{"content":"This sample demonstrates how to host applications in Windows Process Activation Service (WAS) that are read from a message queue.","pos":[122,251]},{"content":"This sample uses the <ph id=\"ph1\">`netMsmqBinding`</ph> and is based on the <bpt id=\"p1\">[</bpt>Two-Way Communication<ept id=\"p1\">](../../../../docs/framework/wcf/samples/two-way-communication.md)</ept> sample.","pos":[252,406],"source":" This sample uses the `netMsmqBinding` and is based on the [Two-Way Communication](../../../../docs/framework/wcf/samples/two-way-communication.md) sample."},{"content":"The service in this case is a Web-hosted application and the client is self-hosted and outputs to the console to observe the status of purchase orders submitted.","pos":[407,568]},{"pos":[576,683],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"pos":[691,819],"content":"[!NOTE]\n The samples may already be installed on your computer. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your computer. Check for the following (default) directory before continuing.","pos":[9,126],"nodes":[{"content":"The samples may already be installed on your computer.","pos":[0,54]},{"content":"Check for the following (default) directory before continuing.","pos":[55,117]}]}]},{"content":"<ph id=\"ph1\">\\&lt;</ph>InstallDrive&gt;:\\WF_WCF_Samples","pos":[830,861],"source":"\\<InstallDrive>:\\WF_WCF_Samples"},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all WCF and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[872,1147],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all WCF and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[1148,1198]},{"content":"<ph id=\"ph1\">\\&lt;</ph>InstallDrive&gt;:\\Samples\\WCFWFCardSpace\\WCF\\Basic\\Services\\Hosting\\WASHost\\MsmqActivation.","pos":[1209,1299],"source":"\\<InstallDrive>:\\Samples\\WCFWFCardSpace\\WCF\\Basic\\Services\\Hosting\\WASHost\\MsmqActivation."},{"content":"Windows Process Activation Service (WAS), the new process activation mechanism for <ph id=\"ph1\">[!INCLUDE[lserver](../../../../includes/lserver-md.md)]</ph>, provides IIS-like features that were previously only available to HTTP-based applications to applications that use non-HTTP protocols.","pos":[1306,1580],"source":"Windows Process Activation Service (WAS), the new process activation mechanism for [!INCLUDE[lserver](../../../../includes/lserver-md.md)], provides IIS-like features that were previously only available to HTTP-based applications to applications that use non-HTTP protocols."},{"content":"Windows Communication Foundation (WCF) uses the Listener Adapter interface to communicate activation requests that are received over the non-HTTP protocols supported by WCF, such as TCP, Named Pipes, and MSMQ.","pos":[1581,1790]},{"content":"The functionality for receiving requests over non-HTTP protocols is hosted by managed Windows services running in SMSvcHost.exe.","pos":[1791,1919]},{"content":"The Net.Msmq Listener Adapter service (NetMsmqActivator) activates queued applications based on messages in the queue.","pos":[1926,2044]},{"content":"The client sends purchase orders to the service from within the scope of a transaction.","pos":[2051,2138]},{"content":"The service receives the orders in a transaction and processes them.","pos":[2139,2207]},{"content":"The service then calls back the client with the status of the order.","pos":[2208,2276]},{"content":"To facilitate two-way communication the client and service both use queues to enqueue purchase orders and order status.","pos":[2277,2396]},{"content":"The service contract <ph id=\"ph1\">`IOrderProcessor`</ph> defines the one-way service operations that work with queuing.","pos":[2403,2504],"source":"The service contract `IOrderProcessor` defines the one-way service operations that work with queuing."},{"content":"The service operation uses the reply endpoint to send order statuses to the client.","pos":[2505,2588]},{"content":"The reply endpoint's address is the URI of the queue used to send the order status back to the client.","pos":[2589,2691]},{"content":"The order processing application implements this contract.","pos":[2692,2750]},{"content":"The reply contract to send order status to is specified by the client.","pos":[3059,3129]},{"content":"The client implements the order status contract.","pos":[3130,3178]},{"content":"The service uses the generated client of this contract to send order status back to the client.","pos":[3179,3274]},{"content":"The service operation processes the submitted purchase order.","pos":[3461,3522]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute&gt;</ph> is applied to the service operation to specify automatic enlistment in the transaction that is used to receive the message from the queue and automatic completion of the transaction on completion of the service operation.","pos":[3523,3802],"source":" The <xref:System.ServiceModel.OperationBehaviorAttribute> is applied to the service operation to specify automatic enlistment in the transaction that is used to receive the message from the queue and automatic completion of the transaction on completion of the service operation."},{"content":"The <ph id=\"ph1\">`Orders`</ph> class encapsulates order processing functionality.","pos":[3803,3866],"source":" The `Orders` class encapsulates order processing functionality."},{"content":"In this case, it adds the purchase order to a dictionary.","pos":[3867,3924]},{"content":"The transaction that the service operation enlisted in is available to the operations in the <ph id=\"ph1\">`Orders`</ph> class.","pos":[3925,4033],"source":" The transaction that the service operation enlisted in is available to the operations in the `Orders` class."},{"content":"The service operation, in addition to processing the submitted purchase order, replies back to the client about the status of the order.","pos":[4040,4176]},{"content":"The client binding to use is specified using a configuration file.","pos":[5214,5280]},{"content":"The MSMQ queue name is specified in an appSettings section of the configuration file.","pos":[5287,5372]},{"content":"The endpoint for the service is defined in the System.serviceModel section of the configuration file.","pos":[5373,5474]},{"pos":[5482,5931],"content":"[!NOTE]\n The MSMQ queue name and endpoint address use slightly different addressing conventions. The MSMQ queue name uses a dot (.) for the local computer and backslash separators in its path. The WCF endpoint address specifies a net.msmq: scheme, uses \"localhost\" for the local computer, and uses forward slashes in its path. To read from a queue that is hosted on the remote computer, replace the \".\" and \"localhost\" to the remote computer name.","leadings":["","> "],"nodes":[{"content":"The MSMQ queue name and endpoint address use slightly different addressing conventions. The MSMQ queue name uses a dot (.) for the local computer and backslash separators in its path. The WCF endpoint address specifies a net.msmq: scheme, uses \"localhost\" for the local computer, and uses forward slashes in its path. To read from a queue that is hosted on the remote computer, replace the \".\" and \"localhost\" to the remote computer name.","pos":[9,447],"nodes":[{"content":"The MSMQ queue name and endpoint address use slightly different addressing conventions.","pos":[0,87]},{"content":"The MSMQ queue name uses a dot (.) for the local computer and backslash separators in its path.","pos":[88,183]},{"content":"The WCF endpoint address specifies a net.msmq: scheme, uses \"localhost\" for the local computer, and uses forward slashes in its path.","pos":[184,317]},{"content":"To read from a queue that is hosted on the remote computer, replace the \".\" and \"localhost\" to the remote computer name.","pos":[318,438]}]}]},{"content":"A .svc file with the name of the class is used to host the service code in WAS.","pos":[5938,6017]},{"pos":[6024,6111],"content":"The Service.svc file itself contains a directive to create the <ph id=\"ph1\">`OrderProcessorService`</ph>.","source":"The Service.svc file itself contains a directive to create the `OrderProcessorService`."},{"content":"The Service.svc file also contains an assembly directive to ensure that System.Transactions.dll is loaded.","pos":[6243,6349]},{"content":"The client creates a transaction scope.","pos":[6484,6523]},{"content":"Communication with the service takes place within the scope of the transaction, causing it to be treated as an atomic unit where all messages succeed or fail.","pos":[6524,6682]},{"content":"The transaction is committed by calling <ph id=\"ph1\">`Complete`</ph> on the transaction scope.","pos":[6683,6759],"source":" The transaction is committed by calling `Complete` on the transaction scope."},{"content":"The client code implements the <ph id=\"ph1\">`IOrderStatus`</ph> contract to receive order status from the service.","pos":[8557,8653],"source":"The client code implements the `IOrderStatus` contract to receive order status from the service."},{"content":"In this case, it prints out the order status.","pos":[8654,8699]},{"content":"The order status queue is created in the <ph id=\"ph1\">`Main`</ph> method.","pos":[9120,9175],"source":"The order status queue is created in the `Main` method."},{"content":"The client configuration includes the order status service configuration to host the order status service, as shown in the following sample configuration.","pos":[9176,9330]},{"content":"When you run the sample, the client and service activities are displayed in both the server and client console windows.","pos":[10417,10536]},{"content":"You can see the server receive messages from the client.","pos":[10537,10593]},{"content":"Press ENTER in each console window to shut down the server and client.","pos":[10594,10664]},{"content":"The client displays the order status information sent by the server:","pos":[10671,10739]},{"pos":[10872,10908],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[10918,11035],"content":"Ensure that <ph id=\"ph1\">[!INCLUDE[iisver](../../../../includes/iisver-md.md)]</ph> is installed, as it is required for WAS activation.","source":"Ensure that [!INCLUDE[iisver](../../../../includes/iisver-md.md)] is installed, as it is required for WAS activation."},{"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","pos":[11045,11244],"source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"content":"In addition, you must install the WCF non-HTTP activation components:","pos":[11245,11314]},{"pos":[11328,11378],"content":"From the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> menu, choose <bpt id=\"p2\">**</bpt>Control Panel<ept id=\"p2\">**</ept>.","source":"From the **Start** menu, choose **Control Panel**."},{"pos":[11392,11425],"content":"Select <bpt id=\"p1\">**</bpt>Programs and Features<ept id=\"p1\">**</ept>.","source":"Select **Programs and Features**."},{"pos":[11439,11481],"content":"Click <bpt id=\"p1\">**</bpt>Turn Windows Features on or off<ept id=\"p1\">**</ept>.","source":"Click **Turn Windows Features on or off**."},{"pos":[11495,11546],"content":"Under <bpt id=\"p1\">**</bpt>Features Summary<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Add Features<ept id=\"p2\">**</ept>.","source":"Under **Features Summary**, click **Add Features**."},{"pos":[11560,11688],"content":"Expand the <bpt id=\"p1\">**</bpt>Microsoft .NET Framework 3.0<ept id=\"p1\">**</ept> node and check the <bpt id=\"p2\">**</bpt>Windows Communication Foundation Non-HTTP Activation<ept id=\"p2\">**</ept> feature.","source":"Expand the **Microsoft .NET Framework 3.0** node and check the **Windows Communication Foundation Non-HTTP Activation** feature."},{"pos":[11698,11907],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"content":"Run the client by executing client.exe from a command window.","pos":[11917,11978]},{"content":"This creates the queue and sends a message to it.","pos":[11979,12028]},{"content":"Leave the client running to see the result of the service reading the message","pos":[12029,12106]},{"content":"The MSMQ activation service runs as Network Service by default.","pos":[12116,12179]},{"content":"Therefore, the queue that is used to activate the application must have receive and peek permissions for Network Service.","pos":[12180,12301]},{"content":"This can be added by using the Message Queuing MMC:","pos":[12302,12353]},{"pos":[12367,12448],"content":"From the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> menu, click <bpt id=\"p2\">**</bpt>Run<ept id=\"p2\">**</ept>, then type <ph id=\"ph1\">`Compmgmt.msc`</ph> and press ENTER.","source":"From the **Start** menu, click **Run**, then type `Compmgmt.msc` and press ENTER."},{"pos":[12462,12526],"content":"Under <bpt id=\"p1\">**</bpt>Services and Applications<ept id=\"p1\">**</ept>, expand <bpt id=\"p2\">**</bpt>Message Queuing<ept id=\"p2\">**</ept>.","source":"Under **Services and Applications**, expand **Message Queuing**."},{"pos":[12540,12565],"content":"Click <bpt id=\"p1\">**</bpt>Private Queues<ept id=\"p1\">**</ept>.","source":"Click **Private Queues**."},{"pos":[12579,12661],"content":"Right-click the queue (servicemodelsamples/Service.svc) and choose <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.","source":"Right-click the queue (servicemodelsamples/Service.svc) and choose **Properties**."},{"pos":[12675,12771],"content":"On the <bpt id=\"p1\">**</bpt>Security<ept id=\"p1\">**</ept> tab, click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept> and give peek and receive permissions to Network Service.","source":"On the **Security** tab, click **Add** and give peek and receive permissions to Network Service."},{"content":"Configure the Windows Process Activation Service (WAS) to support MSMQ activation.","pos":[12781,12863]},{"content":"As a convenience, the following steps are implemented in a batch file called AddMsmqSiteBinding.cmd located in the sample directory.","pos":[12874,13006]},{"content":"To support net.msmq activation, the default Web site must first be bound to the net.msmq protocol.","pos":[13020,13118]},{"content":"This can be done using appcmd.exe, which is installed with the <ph id=\"ph1\">[!INCLUDE[iisver](../../../../includes/iisver-md.md)]</ph> management toolset.","pos":[13119,13255],"source":" This can be done using appcmd.exe, which is installed with the [!INCLUDE[iisver](../../../../includes/iisver-md.md)] management toolset."},{"content":"From an elevated (administrator) command prompt, run the following command.","pos":[13256,13331]},{"pos":[13535,13592],"content":"[!NOTE]\nThis command is a single line of text.","leadings":["","        >  "],"nodes":[{"content":"This command is a single line of text.","pos":[8,46]}]},{"content":"This command adds a net.msmq site binding to the default Web site.","pos":[13607,13673]},{"content":"Although all applications within a site share a common net.msmq binding, each application can enable net.msmq support individually.","pos":[13687,13818]},{"content":"To enable net.msmq for the /servicemodelsamples application, run the following command from an elevated command prompt.","pos":[13819,13938]},{"pos":[14118,14175],"content":"[!NOTE]\nThis command is a single line of text.","leadings":["","        >  "],"nodes":[{"content":"This command is a single line of text.","pos":[8,46]}]},{"pos":[14190,14355],"content":"This command enables the /servicemodelsamples application to be accessed using <ph id=\"ph1\">`http://localhost/servicemodelsamples`</ph> and <ph id=\"ph2\">`net.msmq://localhost/servicemodelsamples`</ph>.","source":"This command enables the /servicemodelsamples application to be accessed using `http://localhost/servicemodelsamples` and `net.msmq://localhost/servicemodelsamples`."},{"content":"If you have not done so previously, ensure that the MSMQ activation service is enabled.","pos":[14363,14450]},{"content":"From the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> menu, click <bpt id=\"p2\">**</bpt>Run<ept id=\"p2\">**</ept>, and type <ph id=\"ph1\">`Services.msc`</ph>.","pos":[14451,14515],"source":" From the **Start** menu, click **Run**, and type `Services.msc`."},{"content":"Search the list of services for the <bpt id=\"p1\">**</bpt>Net.Msmq Listener Adapter<ept id=\"p1\">**</ept>.","pos":[14516,14582],"source":" Search the list of services for the **Net.Msmq Listener Adapter**."},{"content":"Right-click and select <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.","pos":[14583,14621],"source":" Right-click and select **Properties**."},{"content":"Set the <bpt id=\"p1\">**</bpt>Startup Type<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Automatic<ept id=\"p2\">**</ept>, click <bpt id=\"p3\">**</bpt>Apply<ept id=\"p3\">**</ept> and click the <bpt id=\"p4\">**</bpt>Start<ept id=\"p4\">**</ept> button.","pos":[14622,14712],"source":" Set the **Startup Type** to **Automatic**, click **Apply** and click the **Start** button."},{"content":"This step must only be done once prior to the first usage of the Net.Msmq Listener Adapter service.","pos":[14713,14812]},{"content":"To run the sample in a single- or cross-computer configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","pos":[14822,15031],"source":"To run the sample in a single- or cross-computer configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"content":"Additionally, change the code on the client that submits the purchase order to reflect the computer name in the URI of the queue when submitting the purchase order.","pos":[15032,15196]},{"content":"Use the following code:","pos":[15197,15220]},{"content":"Remove the net.msmq site binding you added for this sample.","pos":[15360,15419]},{"content":"As a convenience, the following steps are implemented in a batch file called RemoveMsmqSiteBinding.cmd located in the sample directory:","pos":[15430,15565]},{"content":"Remove net.msmq from the list of enabled protocols by running the following command from an elevated command prompt.","pos":[15579,15695]},{"pos":[15866,15923],"content":"[!NOTE]\nThis command is a single line of text.","leadings":["","        >  "],"nodes":[{"content":"This command is a single line of text.","pos":[8,46]}]},{"content":"Remove the net.msmq site binding by running the following command from an elevated command prompt.","pos":[15937,16035]},{"pos":[16228,16285],"content":"[!NOTE]\nThis command is a single line of text.","leadings":["","        >  "],"nodes":[{"content":"This command is a single line of text.","pos":[8,46]}]},{"pos":[16297,16408],"content":"[!WARNING]\nRunning the batch file will reset the DefaultAppPool to run using .NET Framework version 2.0.","leadings":["","    >  "],"nodes":[{"content":"Running the batch file will reset the DefaultAppPool to run using .NET Framework version 2.0.","pos":[11,104]}]},{"content":"By default with the <ph id=\"ph1\">`netMsmqBinding`</ph> binding transport, security is enabled.","pos":[16415,16491],"source":"By default with the `netMsmqBinding` binding transport, security is enabled."},{"content":"Two properties, <ph id=\"ph1\">`MsmqAuthenticationMode`</ph> and <ph id=\"ph2\">`MsmqProtectionLevel`</ph>, together determine the type of transport security.","pos":[16492,16610],"source":" Two properties, `MsmqAuthenticationMode` and `MsmqProtectionLevel`, together determine the type of transport security."},{"content":"By default the authentication mode is set to <ph id=\"ph1\">`Windows`</ph> and the protection level is set to <ph id=\"ph2\">`Sign`</ph>.","pos":[16611,16708],"source":" By default the authentication mode is set to `Windows` and the protection level is set to `Sign`."},{"content":"For MSMQ to provide the authentication and signing feature, it must be part of a domain.","pos":[16709,16797]},{"content":"If you run this sample on a computer that is not part of a domain, the following error is received: \"User's internal message queuing certificate does not exist\".","pos":[16798,16959]},{"pos":[16969,17022],"content":"To run the sample on a computer joined to a workgroup","linkify":"To run the sample on a computer joined to a workgroup","nodes":[{"content":"To run the sample on a computer joined to a workgroup","pos":[0,53]}]},{"content":"If your computer is not part of a domain, turn off transport security by setting the authentication mode and protection level to none as shown in the following sample configuration.","pos":[17032,17213]},{"content":"Change the configuration on both the server and the client before you run the sample.","pos":[17468,17553]},{"pos":[17565,17720],"content":"[!NOTE]\nSetting `security mode` to `None` is equivalent to setting `MsmqAuthenticationMode`, `MsmqProtectionLevel` and `Message` security to `None`.","leadings":["","    >  "],"nodes":[{"content":"Setting <ph id=\"ph1\">`security mode`</ph> to <ph id=\"ph2\">`None`</ph> is equivalent to setting <ph id=\"ph3\">`MsmqAuthenticationMode`</ph>, <ph id=\"ph4\">`MsmqProtectionLevel`</ph> and <ph id=\"ph5\">`Message`</ph> security to <ph id=\"ph6\">`None`</ph>.","pos":[8,148],"source":"Setting `security mode` to `None` is equivalent to setting `MsmqAuthenticationMode`, `MsmqProtectionLevel` and `Message` security to `None`."}]},{"content":"To enable activation in a computer joined to a workgroup, both the activation service and the worker process must be run with a specific user account (must be same for both) and the queue must have ACLs for the specific user account.","pos":[17730,17963]},{"content":"To change the identity that the worker process runs under:","pos":[17974,18032]},{"content":"Run Inetmgr.exe.","pos":[18046,18062]},{"pos":[18076,18210],"content":"Under <bpt id=\"p1\">**</bpt>Application Pools<ept id=\"p1\">**</ept>, right-click the <bpt id=\"p2\">**</bpt>AppPool<ept id=\"p2\">**</ept> (typically <bpt id=\"p3\">**</bpt>DefaultAppPool<ept id=\"p3\">**</ept>) and choose <bpt id=\"p4\">**</bpt>Set Application Pool Defaults…<ept id=\"p4\">**</ept>.","source":"Under **Application Pools**, right-click the **AppPool** (typically **DefaultAppPool**) and choose **Set Application Pool Defaults…**."},{"content":"Change the Identity properties to use the specific user account.","pos":[18224,18288]},{"content":"To change the identity that the Activation Service runs under:","pos":[18299,18361]},{"content":"Run Services.msc.","pos":[18375,18392]},{"pos":[18406,18478],"content":"Right-click the <bpt id=\"p1\">**</bpt>Net.MsmqListener Adapter<ept id=\"p1\">**</ept>, and choose <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept>.","source":"Right-click the **Net.MsmqListener Adapter**, and choose **Properties**."},{"pos":[18488,18528],"content":"Change the account in the <bpt id=\"p1\">**</bpt>LogOn<ept id=\"p1\">**</ept> tab.","source":"Change the account in the **LogOn** tab."},{"content":"In workgroup, the service must also run using an unrestricted token.","pos":[18538,18606]},{"content":"To do this, run the following in a command window:","pos":[18607,18657]},{"pos":[18743,18751],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[18755,18846],"content":"<bpt id=\"p1\">[</bpt>AppFabric Hosting and Persistence Samples<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=193961)</ept>","source":"[AppFabric Hosting and Persistence Samples](https://go.microsoft.com/fwlink/?LinkId=193961)"}]}