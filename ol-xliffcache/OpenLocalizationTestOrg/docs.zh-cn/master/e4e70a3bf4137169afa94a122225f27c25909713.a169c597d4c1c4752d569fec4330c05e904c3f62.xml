{"content":"---\ntitle: \"Stream\"\nms.date: \"03/30/2017\"\nms.assetid: 58a3db81-20ab-4627-bf31-39d30b70b4fe\n---\n# Stream\nThe Stream sample demonstrates the use of streaming transfer mode communication. The service exposes several operations that send and receive streams. This sample is self-hosted. Both the client and service are console programs.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n Windows Communication Foundation (WCF) can communicate in two transfer modesâ€”buffered or streaming. In the default buffered transfer mode, a message must be completely delivered before a receiver can read it. In the streaming transfer mode, the receiver can begin to process the message before it is completely delivered. The streaming mode is useful when the information that is passed is lengthy and can be processed serially. Streaming mode is also useful when the message is too large to be entirely buffered.  \n  \n## Streaming and Service Contracts  \n Streaming is something to be considered when designing a service contract. If an operation receives or returns large amounts of data, you should consider streaming this data to avoid high memory utilization due to buffering of input or output messages. To stream data, the parameter that holds that data must be the only parameter in the message. For example, if the input message is the one to be streamed, the operation must have exactly one input parameter. Similarly, if the output message is to be streamed, the operation must have either exactly one output parameter or a return value. In either case, the parameter or return value type must be either `Stream`, `Message`, or `IXmlSerializable`. The following is the service contract used in this streaming sample.  \n  \n```csharp\n[ServiceContract(Namespace=\"http://Microsoft.ServiceModel.Samples\")]  \npublic interface IStreamingSample  \n{  \n    [OperationContract]  \n    Stream GetStream(string data);  \n    [OperationContract]  \n    bool UploadStream(Stream stream);  \n    [OperationContract]  \n    Stream EchoStream(Stream stream);  \n    [OperationContract]  \n    Stream GetReversedStream();  \n  \n}  \n```  \n  \n The `GetStream` operation receives some input data as a string, which is buffered, and returns a `Stream`, which is streamed. Conversely, `UploadStream` takes in a `Stream` (streamed) and returns a `bool` (buffered). `EchoStream` takes and returns `Stream` and is an example of an operation whose input and output messages are both streamed. Finally, `GetReversedStream` takes no inputs and returns a `Stream` (streamed).  \n  \n## Enabling Streamed Transfers  \n Defining operation contracts as previously described provides streaming at the programming model level. If you stop there, the transport still buffers the entire message content. To enable transport streaming, select a transfer mode on the binding element of the transport. The binding element has a `TransferMode` property that can be set to `Buffered`, `Streamed`, `StreamedRequest`, or `StreamedResponse`. Setting the transfer mode to `Streamed` enables streaming communication in both directions. Setting the transfer mode to `StreamedRequest` or `StreamedResponse` enables streaming communication in only the request or response, respectively.  \n  \n The `basicHttpBinding` exposes the `TransferMode` property on the binding as does `NetTcpBinding` and `NetNamedPipeBinding`. For other transports, you must create a custom binding to set the transfer mode.  \n  \n The following configuration code from the sample shows setting the `TransferMode` property to streaming on the `basicHttpBinding` and a custom HTTP binding:  \n  \n```xml  \n<!-- An example basicHttpBinding using streaming. -->  \n<basicHttpBinding>  \n  <binding name=\"HttpStreaming\" maxReceivedMessageSize=\"67108864\"  \n           transferMode=\"Streamed\"/>  \n</basicHttpBinding>  \n<!-- An example customBinding using HTTP and streaming.-->  \n<customBinding>  \n  <binding name=\"Soap12\">  \n    <textMessageEncoding messageVersion=\"Soap12WSAddressing10\" />  \n    <httpTransport transferMode=\"Streamed\"  \n                   maxReceivedMessageSize=\"67108864\"/>  \n  </binding>  \n</customBinding>  \n```  \n  \n In addition to setting the `transferMode` to `Streamed`, the previous configuration code sets the `maxReceivedMessageSize` to 64MB. As a defense mechanism, `maxReceivedMessageSize` places a cap on the maximum allowable size of messages on receive. The default `maxReceivedMessageSize` is 64 KB, which is usually too low for streaming scenarios.  \n  \n## Processing Data As It Is Streamed  \n The operations `GetStream`, `UploadStream` and `EchoStream` all deal with sending data directly from a file or saving received data directly to a file. However in some cases, there is a requirement to send or receive large amounts of data and perform some processing on chunks of the data as it is being sent or received. One way to address such scenarios is to write a custom stream (a class that derives from <xref:System.IO.Stream>) that processes data as it is read or written. The `GetReversedStream` operation and `ReverseStream` class are an example of this.  \n  \n `GetReversedStream` creates and returns a new instance of `ReverseStream`. The actual processing happens as the system reads from that `ReverseStream` object. The `ReverseStream.Read` implementation reads a chunk of bytes from the underlying file, reverses them, then returns the reversed bytes. This does not reverse the entire file content; it reverses one chunk of bytes at a time. This is an example to show how you can perform stream processing as the content is being read or written from and to the stream.  \n  \n```csharp\nclass ReverseStream : Stream  \n{  \n  \n    FileStream inStream;  \n    internal ReverseStream(string filePath)  \n    {  \n        //Opens the file and places a StreamReader around it.  \n        inStream = File.OpenRead(filePath);  \n    }  \n  \n    // Other methods removed for brevity.  \n  \n    public override int Read(byte[] buffer, int offset, int count)  \n    {  \n        int countRead=inStream.Read(buffer, offset,count);  \n        ReverseBuffer(buffer, offset, countRead);  \n        return countRead;  \n    }  \n  \n    public override void Close()  \n    {  \n        inStream.Close();  \n        base.Close();  \n    }  \n    protected override void Dispose(bool disposing)  \n    {  \n        inStream.Dispose();  \n        base.Dispose(disposing);  \n    }  \n    void ReverseBuffer(byte[] buffer, int offset, int count)  \n    {  \n        int i, j;  \n        for (i = offset, j = offset + count - 1; i < j; i++, j--)  \n        {  \n            byte currenti = buffer[i];  \n            buffer[i] = buffer[j];  \n            buffer[j] = currenti;  \n        }  \n  \n    }  \n}  \n```  \n  \n## Running the Sample  \n To run the sample, first build both the service and the client by following the directions at the end of this document. Then start the service and the client in two different console windows. When the client starts, it waits for you to press ENTER when the service is ready. The client then calls the methods `GetStream()`, `UploadStream()` and `GetReversedStream()` first over HTTP and then over TCP. Here is an example output from the service followed by example output from the client:  \n  \n Service Output:  \n  \n```console  \nThe streaming service is ready.  \nPress <ENTER> to terminate service.  \n  \nSaving to file D:\\...\\uploadedfile  \n......................  \nFile D:\\...\\uploadedfile saved  \nSaving to file D:\\...\\uploadedfile  \n...............  \nFile D:\\...\\uploadedfile saved  \n```  \n  \n Client Output:  \n  \n```console  \nPress <ENTER> when service is ready  \n------ Using HTTP ------   \nCalling GetStream()  \nSaving to file D:\\...\\clientfile  \n......................  \nWrote 33405 bytes to stream  \n  \nFile D:\\...\\clientfile saved  \nCalling UploadStream()  \nCalling GetReversedStream()  \nSaving to file D:\\...\\clientfile  \n......................  \nWrote 33405 bytes to stream  \n  \nFile D:\\...\\clientfile saved  \n------ Using Custom HTTP ------  \nCalling GetStream()  \nSaving to file D:\\...\\clientfile  \n...............  \nWrote 33405 bytes to stream  \n  \nFile D:\\...\\clientfile saved  \nCalling UploadStream()  \nCalling GetReversedStream()  \nSaving to file D:\\...\\clientfile  \n...............  \nWrote 33405 bytes to stream  \n  \nFile D:\\...\\clientfile saved  \n  \nPress <ENTER> to terminate client.  \n```  \n  \n#### To set up, build, and run the sample  \n  \n1.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).  \n  \n2.  To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n3.  To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).  \n  \n> [!NOTE]\n>  If you use Svcutil.exe to regenerate the configuration for this sample, be sure to modify the endpoint name in the client configuration to match the client code.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Contract\\Service\\Stream`  \n","nodes":[{"pos":[4,90],"embed":true,"restype":"x-metadata","content":"title: \"Stream\"\nms.date: \"03/30/2017\"\nms.assetid: 58a3db81-20ab-4627-bf31-39d30b70b4fe","nodes":[{"content":"Stream","nodes":[{"pos":[0,6],"content":"Stream","nodes":[{"content":"Stream","pos":[0,6]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[97,103],"content":"Stream","linkify":"Stream","nodes":[{"content":"Stream","pos":[0,6]}]},{"content":"The Stream sample demonstrates the use of streaming transfer mode communication.","pos":[104,184]},{"content":"The service exposes several operations that send and receive streams.","pos":[185,254]},{"content":"This sample is self-hosted.","pos":[255,282]},{"content":"Both the client and service are console programs.","pos":[283,332]},{"pos":[340,447],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"content":"Windows Communication Foundation (WCF) can communicate in two transfer modesâ€”buffered or streaming.","pos":[454,553]},{"content":"In the default buffered transfer mode, a message must be completely delivered before a receiver can read it.","pos":[554,662]},{"content":"In the streaming transfer mode, the receiver can begin to process the message before it is completely delivered.","pos":[663,775]},{"content":"The streaming mode is useful when the information that is passed is lengthy and can be processed serially.","pos":[776,882]},{"content":"Streaming mode is also useful when the message is too large to be entirely buffered.","pos":[883,967]},{"pos":[976,1007],"content":"Streaming and Service Contracts","linkify":"Streaming and Service Contracts","nodes":[{"content":"Streaming and Service Contracts","pos":[0,31]}]},{"content":"Streaming is something to be considered when designing a service contract.","pos":[1011,1085]},{"content":"If an operation receives or returns large amounts of data, you should consider streaming this data to avoid high memory utilization due to buffering of input or output messages.","pos":[1086,1263]},{"content":"To stream data, the parameter that holds that data must be the only parameter in the message.","pos":[1264,1357]},{"content":"For example, if the input message is the one to be streamed, the operation must have exactly one input parameter.","pos":[1358,1471]},{"content":"Similarly, if the output message is to be streamed, the operation must have either exactly one output parameter or a return value.","pos":[1472,1602]},{"content":"In either case, the parameter or return value type must be either <ph id=\"ph1\">`Stream`</ph>, <ph id=\"ph2\">`Message`</ph>, or <ph id=\"ph3\">`IXmlSerializable`</ph>.","pos":[1603,1712],"source":" In either case, the parameter or return value type must be either `Stream`, `Message`, or `IXmlSerializable`."},{"content":"The following is the service contract used in this streaming sample.","pos":[1713,1781]},{"content":"The <ph id=\"ph1\">`GetStream`</ph> operation receives some input data as a string, which is buffered, and returns a <ph id=\"ph2\">`Stream`</ph>, which is streamed.","pos":[2180,2305],"source":"The `GetStream` operation receives some input data as a string, which is buffered, and returns a `Stream`, which is streamed."},{"content":"Conversely, <ph id=\"ph1\">`UploadStream`</ph> takes in a <ph id=\"ph2\">`Stream`</ph> (streamed) and returns a <ph id=\"ph3\">`bool`</ph> (buffered).","pos":[2306,2396],"source":" Conversely, `UploadStream` takes in a `Stream` (streamed) and returns a `bool` (buffered)."},{"content":"<ph id=\"ph1\">`EchoStream`</ph> takes and returns <ph id=\"ph2\">`Stream`</ph> and is an example of an operation whose input and output messages are both streamed.","pos":[2397,2521],"source":"`EchoStream` takes and returns `Stream` and is an example of an operation whose input and output messages are both streamed."},{"content":"Finally, <ph id=\"ph1\">`GetReversedStream`</ph> takes no inputs and returns a <ph id=\"ph2\">`Stream`</ph> (streamed).","pos":[2522,2601],"source":" Finally, `GetReversedStream` takes no inputs and returns a `Stream` (streamed)."},{"pos":[2610,2637],"content":"Enabling Streamed Transfers","linkify":"Enabling Streamed Transfers","nodes":[{"content":"Enabling Streamed Transfers","pos":[0,27]}]},{"content":"Defining operation contracts as previously described provides streaming at the programming model level.","pos":[2641,2744]},{"content":"If you stop there, the transport still buffers the entire message content.","pos":[2745,2819]},{"content":"To enable transport streaming, select a transfer mode on the binding element of the transport.","pos":[2820,2914]},{"content":"The binding element has a <ph id=\"ph1\">`TransferMode`</ph> property that can be set to <ph id=\"ph2\">`Buffered`</ph>, <ph id=\"ph3\">`Streamed`</ph>, <ph id=\"ph4\">`StreamedRequest`</ph>, or <ph id=\"ph5\">`StreamedResponse`</ph>.","pos":[2915,3049],"source":" The binding element has a `TransferMode` property that can be set to `Buffered`, `Streamed`, `StreamedRequest`, or `StreamedResponse`."},{"content":"Setting the transfer mode to <ph id=\"ph1\">`Streamed`</ph> enables streaming communication in both directions.","pos":[3050,3141],"source":" Setting the transfer mode to `Streamed` enables streaming communication in both directions."},{"content":"Setting the transfer mode to <ph id=\"ph1\">`StreamedRequest`</ph> or <ph id=\"ph2\">`StreamedResponse`</ph> enables streaming communication in only the request or response, respectively.","pos":[3142,3289],"source":" Setting the transfer mode to `StreamedRequest` or `StreamedResponse` enables streaming communication in only the request or response, respectively."},{"content":"The <ph id=\"ph1\">`basicHttpBinding`</ph> exposes the <ph id=\"ph2\">`TransferMode`</ph> property on the binding as does <ph id=\"ph3\">`NetTcpBinding`</ph> and <ph id=\"ph4\">`NetNamedPipeBinding`</ph>.","pos":[3296,3420],"source":"The `basicHttpBinding` exposes the `TransferMode` property on the binding as does `NetTcpBinding` and `NetNamedPipeBinding`."},{"content":"For other transports, you must create a custom binding to set the transfer mode.","pos":[3421,3501]},{"pos":[3508,3664],"content":"The following configuration code from the sample shows setting the <ph id=\"ph1\">`TransferMode`</ph> property to streaming on the <ph id=\"ph2\">`basicHttpBinding`</ph> and a custom HTTP binding:","source":"The following configuration code from the sample shows setting the `TransferMode` property to streaming on the `basicHttpBinding` and a custom HTTP binding:"},{"content":"In addition to setting the <ph id=\"ph1\">`transferMode`</ph> to <ph id=\"ph2\">`Streamed`</ph>, the previous configuration code sets the <ph id=\"ph3\">`maxReceivedMessageSize`</ph> to 64MB.","pos":[4206,4337],"source":"In addition to setting the `transferMode` to `Streamed`, the previous configuration code sets the `maxReceivedMessageSize` to 64MB."},{"content":"As a defense mechanism, <ph id=\"ph1\">`maxReceivedMessageSize`</ph> places a cap on the maximum allowable size of messages on receive.","pos":[4338,4453],"source":" As a defense mechanism, `maxReceivedMessageSize` places a cap on the maximum allowable size of messages on receive."},{"content":"The default <ph id=\"ph1\">`maxReceivedMessageSize`</ph> is 64 KB, which is usually too low for streaming scenarios.","pos":[4454,4550],"source":" The default `maxReceivedMessageSize` is 64 KB, which is usually too low for streaming scenarios."},{"pos":[4559,4592],"content":"Processing Data As It Is Streamed","linkify":"Processing Data As It Is Streamed","nodes":[{"content":"Processing Data As It Is Streamed","pos":[0,33]}]},{"content":"The operations <ph id=\"ph1\">`GetStream`</ph>, <ph id=\"ph2\">`UploadStream`</ph> and <ph id=\"ph3\">`EchoStream`</ph> all deal with sending data directly from a file or saving received data directly to a file.","pos":[4596,4747],"source":"The operations `GetStream`, `UploadStream` and `EchoStream` all deal with sending data directly from a file or saving received data directly to a file."},{"content":"However in some cases, there is a requirement to send or receive large amounts of data and perform some processing on chunks of the data as it is being sent or received.","pos":[4748,4917]},{"content":"One way to address such scenarios is to write a custom stream (a class that derives from <ph id=\"ph1\">&lt;xref:System.IO.Stream&gt;</ph>) that processes data as it is read or written.","pos":[4918,5077],"source":" One way to address such scenarios is to write a custom stream (a class that derives from <xref:System.IO.Stream>) that processes data as it is read or written."},{"content":"The <ph id=\"ph1\">`GetReversedStream`</ph> operation and <ph id=\"ph2\">`ReverseStream`</ph> class are an example of this.","pos":[5078,5161],"source":" The `GetReversedStream` operation and `ReverseStream` class are an example of this."},{"content":"<ph id=\"ph1\">`GetReversedStream`</ph> creates and returns a new instance of <ph id=\"ph2\">`ReverseStream`</ph>.","pos":[5168,5242],"source":"`GetReversedStream` creates and returns a new instance of `ReverseStream`."},{"content":"The actual processing happens as the system reads from that <ph id=\"ph1\">`ReverseStream`</ph> object.","pos":[5243,5326],"source":" The actual processing happens as the system reads from that `ReverseStream` object."},{"content":"The <ph id=\"ph1\">`ReverseStream.Read`</ph> implementation reads a chunk of bytes from the underlying file, reverses them, then returns the reversed bytes.","pos":[5327,5463],"source":" The `ReverseStream.Read` implementation reads a chunk of bytes from the underlying file, reverses them, then returns the reversed bytes."},{"content":"This does not reverse the entire file content; it reverses one chunk of bytes at a time.","pos":[5464,5552]},{"content":"This is an example to show how you can perform stream processing as the content is being read or written from and to the stream.","pos":[5553,5681]},{"pos":[6775,6793],"content":"Running the Sample","linkify":"Running the Sample","nodes":[{"content":"Running the Sample","pos":[0,18]}]},{"content":"To run the sample, first build both the service and the client by following the directions at the end of this document.","pos":[6797,6916]},{"content":"Then start the service and the client in two different console windows.","pos":[6917,6988]},{"content":"When the client starts, it waits for you to press ENTER when the service is ready.","pos":[6989,7071]},{"content":"The client then calls the methods <ph id=\"ph1\">`GetStream()`</ph>, <ph id=\"ph2\">`UploadStream()`</ph> and <ph id=\"ph3\">`GetReversedStream()`</ph> first over HTTP and then over TCP.","pos":[7072,7198],"source":" The client then calls the methods `GetStream()`, `UploadStream()` and `GetReversedStream()` first over HTTP and then over TCP."},{"content":"Here is an example output from the service followed by example output from the client:","pos":[7199,7285]},{"content":"Service Output:","pos":[7292,7307]},{"content":"Client Output:","pos":[7594,7608]},{"pos":[8417,8453],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[8463,8662],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"pos":[8672,8881],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[8891,9099],"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[9107,9279],"content":"[!NOTE]\n If you use Svcutil.exe to regenerate the configuration for this sample, be sure to modify the endpoint name in the client configuration to match the client code.","leadings":["","> "],"nodes":[{"content":"If you use Svcutil.exe to regenerate the configuration for this sample, be sure to modify the endpoint name in the client configuration to match the client code.","pos":[9,170]}]},{"pos":[9287,9419],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[9473,9783],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[9784,9834]}]}