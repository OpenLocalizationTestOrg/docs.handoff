{"content":"---\ntitle: \"Control Flow in Async Programs (C#)\"\nms.date: 07/20/2015\nms.assetid: fc92b08b-fe1d-4d07-84ab-5192fafe06bb\n---\n# Control flow in async programs (C#)\n\nYou can write and maintain asynchronous programs more easily by using the `async` and `await` keywords. However, the results might surprise you if you don't understand how your program operates. This topic traces the flow of control through a simple async program to show you when control moves from one method to another and what information is transferred each time.\n\nIn general, you mark methods that contain asynchronous code with the [async (C#)](../../../../csharp/language-reference/keywords/async.md) modifier. In a method that's marked with an async modifier, you can use an [await (C#)](../../../../csharp/language-reference/keywords/await.md) operator to specify where the method pauses to wait for a called asynchronous process to complete. For more information, see [Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md).\n\nThe following example uses async methods to download the contents of a specified website as a string and to display the length of the string. The example contains the following two methods.\n\n-   `startButton_Click`, which calls `AccessTheWebAsync` and displays the result.\n\n-   `AccessTheWebAsync`, which downloads the contents of a website as a string and returns the length of the string. `AccessTheWebAsync` uses an asynchronous <xref:System.Net.Http.HttpClient> method, <xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29>, to download the contents.\n\nNumbered display lines appear at strategic points throughout the program to help you understand how the program runs and to explain what happens at each point that is marked. The display lines are labeled \"ONE\" through \"SIX.\" The labels represent the order in which the program reaches these lines of code.\n\nThe following code shows an outline of the program.\n\n```csharp\npublic partial class MainWindow : Window\n{\n    // . . .\n    private async void startButton_Click(object sender, RoutedEventArgs e)\n    {\n        // ONE\n        Task<int> getLengthTask = AccessTheWebAsync();\n\n        // FOUR\n        int contentLength = await getLengthTask;\n\n        // SIX\n        resultsTextBox.Text +=\n            $\"\\r\\nLength of the downloaded string: {contentLength}.\\r\\n\";\n    }\n\n    async Task<int> AccessTheWebAsync()\n    {\n        // TWO\n        HttpClient client = new HttpClient();\n        Task<string> getStringTask =\n            client.GetStringAsync(\"https://msdn.microsoft.com\");\n\n        // THREE\n        string urlContents = await getStringTask;\n\n        // FIVE\n        return urlContents.Length;\n    }\n}\n```\n\nEach of the labeled locations, \"ONE\" through \"SIX,\" displays information about the current state of the program. The following output is produced:\n\n```text\nONE:   Entering startButton_Click.\n           Calling AccessTheWebAsync.\n\nTWO:   Entering AccessTheWebAsync.\n           Calling HttpClient.GetStringAsync.\n\nTHREE: Back in AccessTheWebAsync.\n           Task getStringTask is started.\n           About to await getStringTask & return a Task<int> to startButton_Click.\n\nFOUR:  Back in startButton_Click.\n           Task getLengthTask is started.\n           About to await getLengthTask -- no caller to return to.\n\nFIVE:  Back in AccessTheWebAsync.\n           Task getStringTask is complete.\n           Processing the return statement.\n           Exiting from AccessTheWebAsync.\n\nSIX:   Back in startButton_Click.\n           Task getLengthTask is finished.\n           Result from AccessTheWebAsync is stored in contentLength.\n           About to display contentLength and exit.\n\nLength of the downloaded string: 33946.\n```\n\n## Set up the program\n\nYou can download the code that this topic uses from MSDN, or you can build it yourself.\n\n> [!NOTE]\n> To run the example, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.\n\n### Download the program\n\nYou can download the application for this topic from [Async Sample: Control Flow in Async Programs](https://code.msdn.microsoft.com/Async-Sample-Control-Flow-5c804fc0). The following steps open and run the program.\n\n1.  Unzip the downloaded file, and then start Visual Studio.\n\n2.  On the menu bar, choose **File** > **Open** > **Project/Solution**.\n\n3.  Navigate to the folder that holds the unzipped sample code, open the solution (.sln) file, and then choose the **F5** key to build and run the project.\n\n### Create the program Yourself\n\nThe following Windows Presentation Foundation (WPF) project contains the code example for this topic.\n\nTo run the project, perform the following steps:\n\n1.  Start Visual Studio.\n\n2.  On the menu bar, choose **File** > **New** > **Project**.\n\n     The **New Project** dialog box opens.\n\n3.  Choose the **Installed** > **Visual C#** > **Windows Desktop** category, and then choose **WPF App** from the list of project templates.\n\n4.  Enter `AsyncTracer` as the name of the project, and then choose the **OK** button.\n\n     The new project appears in **Solution Explorer**.\n\n5.  In the Visual Studio Code Editor, choose the **MainWindow.xaml** tab.\n\n     If the tab isn’t visible, open the shortcut menu for MainWindow.xaml in **Solution Explorer**, and then choose **View Code**.\n\n6.  In the **XAML** view of MainWindow.xaml, replace the code with the following code.\n\n    ```csharp\n    <Window\n            xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"\n            xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\"\n            xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\" xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\" mc:Ignorable=\"d\" x:Class=\"AsyncTracer.MainWindow\"\n            Title=\"Control Flow Trace\" Height=\"350\" Width=\"592\">\n        <Grid>\n            <Button x:Name=\"startButton\" Content=\"Start\n    \" HorizontalAlignment=\"Left\" Margin=\"250,10,0,0\" VerticalAlignment=\"Top\" Width=\"75\" Height=\"24\"  Click=\"startButton_Click\" d:LayoutOverrides=\"GridBox\"/>\n            <TextBox x:Name=\"resultsTextBox\" HorizontalAlignment=\"Left\" TextWrapping=\"Wrap\" VerticalAlignment=\"Bottom\" Width=\"576\" Height=\"265\" FontFamily=\"Lucida Console\" FontSize=\"10\" VerticalScrollBarVisibility=\"Visible\" Grid.ColumnSpan=\"3\"/>\n        </Grid>\n    </Window>\n    ```\n\n     A simple window that contains a text box and a button appears in the **Design** view of MainWindow.xaml.\n\n7.  Add a reference for <xref:System.Net.Http>.\n\n8.  In **Solution Explorer**, open the shortcut menu for MainWindow.xaml.cs, and then choose **View Code**.\n\n9. In MainWindow.xaml.cs, replace the code with the following code.\n\n    ```csharp\n    using System;\n    using System.Collections.Generic;\n    using System.Linq;\n    using System.Text;\n    using System.Threading.Tasks;\n    using System.Windows;\n    using System.Windows.Controls;\n    using System.Windows.Data;\n    using System.Windows.Documents;\n    using System.Windows.Input;\n    using System.Windows.Media;\n    using System.Windows.Media.Imaging;\n    using System.Windows.Navigation;\n    using System.Windows.Shapes;\n\n    // Add a using directive and a reference for System.Net.Http;\n    using System.Net.Http;\n\n    namespace AsyncTracer\n    {\n        public partial class MainWindow : Window\n        {\n            public MainWindow()\n            {\n                InitializeComponent();\n            }\n\n            private async void startButton_Click(object sender, RoutedEventArgs e)\n            {\n                // The display lines in the example lead you through the control shifts.\n                resultsTextBox.Text += \"ONE:   Entering startButton_Click.\\r\\n\" +\n                    \"           Calling AccessTheWebAsync.\\r\\n\";\n\n                Task<int> getLengthTask = AccessTheWebAsync();\n\n                resultsTextBox.Text += \"\\r\\nFOUR:  Back in startButton_Click.\\r\\n\" +\n                    \"           Task getLengthTask is started.\\r\\n\" +\n                    \"           About to await getLengthTask -- no caller to return to.\\r\\n\";\n\n                int contentLength = await getLengthTask;\n\n                resultsTextBox.Text += \"\\r\\nSIX:   Back in startButton_Click.\\r\\n\" +\n                    \"           Task getLengthTask is finished.\\r\\n\" +\n                    \"           Result from AccessTheWebAsync is stored in contentLength.\\r\\n\" +\n                    \"           About to display contentLength and exit.\\r\\n\";\n\n                resultsTextBox.Text +=\n                    $\"\\r\\nLength of the downloaded string: {contentLength}.\\r\\n\";\n            }\n\n            async Task<int> AccessTheWebAsync()\n            {\n                resultsTextBox.Text += \"\\r\\nTWO:   Entering AccessTheWebAsync.\";\n\n                // Declare an HttpClient object.\n                HttpClient client = new HttpClient();\n\n                resultsTextBox.Text += \"\\r\\n           Calling HttpClient.GetStringAsync.\\r\\n\";\n\n                // GetStringAsync returns a Task<string>.\n                Task<string> getStringTask = client.GetStringAsync(\"https://msdn.microsoft.com\");\n\n                resultsTextBox.Text += \"\\r\\nTHREE: Back in AccessTheWebAsync.\\r\\n\" +\n                    \"           Task getStringTask is started.\";\n\n                // AccessTheWebAsync can continue to work until getStringTask is awaited.\n\n                resultsTextBox.Text +=\n                    \"\\r\\n           About to await getStringTask and return a Task<int> to startButton_Click.\\r\\n\";\n\n                // Retrieve the website contents when task is complete.\n                string urlContents = await getStringTask;\n\n                resultsTextBox.Text += \"\\r\\nFIVE:  Back in AccessTheWebAsync.\" +\n                    \"\\r\\n           Task getStringTask is complete.\" +\n                    \"\\r\\n           Processing the return statement.\" +\n                    \"\\r\\n           Exiting from AccessTheWebAsync.\\r\\n\";\n\n                return urlContents.Length;\n            }\n        }\n    }\n    ```\n\n10. Choose the **F5** key to run the program, and then choose the **Start** button.\n\n    The following output appears:\n\n    ```text\n    ONE:   Entering startButton_Click.\n               Calling AccessTheWebAsync.\n\n    TWO:   Entering AccessTheWebAsync.\n               Calling HttpClient.GetStringAsync.\n\n    THREE: Back in AccessTheWebAsync.\n               Task getStringTask is started.\n               About to await getStringTask & return a Task<int> to startButton_Click.\n\n    FOUR:  Back in startButton_Click.\n               Task getLengthTask is started.\n               About to await getLengthTask -- no caller to return to.\n\n    FIVE:  Back in AccessTheWebAsync.\n               Task getStringTask is complete.\n               Processing the return statement.\n               Exiting from AccessTheWebAsync.\n\n    SIX:   Back in startButton_Click.\n               Task getLengthTask is finished.\n               Result from AccessTheWebAsync is stored in contentLength.\n               About to display contentLength and exit.\n\n    Length of the downloaded string: 33946.\n    ```\n\n## Trace the program\n\n### Steps ONE and TWO\n\nThe first two display lines trace the path as `startButton_Click` calls `AccessTheWebAsync`, and `AccessTheWebAsync` calls the asynchronous <xref:System.Net.Http.HttpClient> method <xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29>. The following image outlines the calls from method to method.\n\n![Steps ONE and TWO](../../../../csharp/programming-guide/concepts/async/media/asynctrace-onetwo.png \"AsyncTrace-ONETWO\")\n\nThe return type of both `AccessTheWebAsync` and `client.GetStringAsync` is <xref:System.Threading.Tasks.Task%601>. For `AccessTheWebAsync`, TResult is an integer. For `GetStringAsync`, TResult is a string. For more information about async method return types, see [Async Return Types (C#)](../../../../csharp/programming-guide/concepts/async/async-return-types.md).\n\nA task-returning async method returns a task instance when control shifts back to the caller. Control returns from an async method to its caller either when an `await` operator is encountered in the called method or when the called method ends. The display lines that are labeled \"THREE\" through \"SIX\" trace this part of the process.\n\n### Step THREE\n\nIn `AccessTheWebAsync`, the asynchronous method <xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29> is called to download the contents of the target webpage. Control returns from `client.GetStringAsync` to `AccessTheWebAsync` when `client.GetStringAsync` returns.\n\n The `client.GetStringAsync` method returns a task of string that’s assigned to the `getStringTask` variable in `AccessTheWebAsync`. The following line in the example program shows the call to `client.GetStringAsync` and the assignment.\n\n```csharp\nTask<string> getStringTask = client.GetStringAsync(\"https://msdn.microsoft.com\");\n```\n\n You can think of the task as a promise by `client.GetStringAsync` to produce an actual string eventually. In the meantime, if `AccessTheWebAsync` has work to do that doesn't depend on the promised string from `client.GetStringAsync`, that work can continue while  `client.GetStringAsync` waits. In the example, the following lines of output, which are labeled \"THREE,\" represent the opportunity to do independent work\n\n```\nTHREE: Back in AccessTheWebAsync.\n           Task getStringTask is started.\n           About to await getStringTask & return a Task<int> to startButton_Click.\n```\n\n The following statement suspends progress in `AccessTheWebAsync` when `getStringTask` is awaited.\n\n```csharp\nstring urlContents = await getStringTask;\n```\n\n The following image shows the flow of control from `client.GetStringAsync` to the assignment to `getStringTask` and from the creation of `getStringTask` to the application of an await operator.\n\n ![Step THREE](../../../../csharp/programming-guide/concepts/async/media/asynctrace-three.png \"AsyncTrace-Three\")\n\n The await expression suspends `AccessTheWebAsync` until `client.GetStringAsync` returns. In the meantime, control returns to the caller of `AccessTheWebAsync`, `startButton_Click`.\n\n> [!NOTE]\n> Typically, you await the call to an asynchronous method immediately. For example, the following assignment could replace the previous code that creates and then awaits `getStringTask`: `string urlContents = await client.GetStringAsync(\"https://msdn.microsoft.com\");`\n>\n> In this topic, the await operator is applied later to accommodate the output lines that mark the flow of control through the program.\n\n### Step FOUR\n\nThe declared return type of `AccessTheWebAsync` is `Task<int>`. Therefore, when `AccessTheWebAsync` is suspended, it returns a task of integer to `startButton_Click`. You should understand that the returned task isn’t `getStringTask`. The returned task is a new task of integer that represents what remains to be done in the suspended method, `AccessTheWebAsync`. The task is a promise from `AccessTheWebAsync` to produce an integer when the task is complete.\n\nThe following statement assigns this task to the `getLengthTask` variable.\n\n```csharp\nTask<int> getLengthTask = AccessTheWebAsync();\n```\n\n As in `AccessTheWebAsync`, `startButton_Click` can continue with work that doesn’t depend on the results of the asynchronous task (`getLengthTask`) until the task is awaited. The following output lines represent that work.\n\n```\nFOUR:  Back in startButton_Click.\n           Task getLengthTask is started.\n           About to await getLengthTask -- no caller to return to.\n```\n\n Progress in `startButton_Click` is suspended when `getLengthTask` is awaited. The following assignment statement suspends `startButton_Click` until `AccessTheWebAsync` is complete.\n\n```csharp\nint contentLength = await getLengthTask;\n```\n\n In the following illustration, the arrows show the flow of control from the await expression in `AccessTheWebAsync` to the assignment of a value to `getLengthTask`, followed by normal processing in `startButton_Click` until `getLengthTask` is awaited.\n\n ![Step FOUR](../../../../csharp/programming-guide/concepts/async/media/asynctrace-four.png \"AsyncTrace-FOUR\")\n\n### Step FIVE\n\nWhen `client.GetStringAsync` signals that it’s complete, processing in `AccessTheWebAsync` is released from suspension and can continue past the await statement. The following lines of output represent the resumption of processing.\n\n```\nFIVE:  Back in AccessTheWebAsync.\n           Task getStringTask is complete.\n           Processing the return statement.\n           Exiting from AccessTheWebAsync.\n```\n\n The operand of the return statement, `urlContents.Length`, is stored in the task that  `AccessTheWebAsync` returns. The await expression retrieves that value from `getLengthTask` in `startButton_Click`.\n\n The following image shows the transfer of control after `client.GetStringAsync` (and `getStringTask`) are complete.\n\n ![Step FIVE](../../../../csharp/programming-guide/concepts/async/media/asynctrace-five.png \"AsyncTrace-FIVE\")\n\n `AccessTheWebAsync` runs to completion, and control returns to `startButton_Click`, which is awaiting the completion.\n\n### Step SIX\n\nWhen `AccessTheWebAsync` signals that it’s complete, processing can continue past the await statement in `startButton_Async`. In fact, the program has nothing more to do.\n\nThe following lines of output represent the resumption of processing in `startButton_Async`:\n\n```\nSIX:   Back in startButton_Click.\n           Task getLengthTask is finished.\n           Result from AccessTheWebAsync is stored in contentLength.\n           About to display contentLength and exit.\n```\n\n The await expression retrieves from `getLengthTask` the integer value that’s the operand of the return statement in `AccessTheWebAsync`. The following statement assigns that value to the `contentLength` variable.\n\n```csharp\nint contentLength = await getLengthTask;\n```\n\n The following image shows the return of control from `AccessTheWebAsync` to `startButton_Click`.\n\n ![Step SIX](../../../../csharp/programming-guide/concepts/async/media/asynctrace-six.png \"AsyncTrace-SIX\")\n\n## See also\n\n- [Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)\n- [Async Return Types (C#)](../../../../csharp/programming-guide/concepts/async/async-return-types.md)\n- [Walkthrough: Accessing the Web by Using async and await (C#)](../../../../csharp/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)\n- [Async Sample: Control Flow in Async Programs (C# and Visual Basic)](https://code.msdn.microsoft.com/Async-Sample-Control-Flow-5c804fc0)\n","nodes":[{"pos":[4,117],"embed":true,"restype":"x-metadata","content":"title: \"Control Flow in Async Programs (C#)\"\nms.date: 07/20/2015\nms.assetid: fc92b08b-fe1d-4d07-84ab-5192fafe06bb","nodes":[{"content":"Control Flow in Async Programs (C#)","nodes":[{"pos":[0,35],"content":"Control Flow in Async Programs (C#)","nodes":[{"content":"Control Flow in Async Programs (C#)","pos":[0,35]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[124,159],"content":"Control flow in async programs (C#)","linkify":"Control flow in async programs (C#)","nodes":[{"content":"Control flow in async programs (C#)","pos":[0,35]}]},{"content":"You can write and maintain asynchronous programs more easily by using the <ph id=\"ph1\">`async`</ph> and <ph id=\"ph2\">`await`</ph> keywords.","pos":[161,264],"source":"You can write and maintain asynchronous programs more easily by using the `async` and `await` keywords."},{"content":"However, the results might surprise you if you don't understand how your program operates.","pos":[265,355]},{"content":"This topic traces the flow of control through a simple async program to show you when control moves from one method to another and what information is transferred each time.","pos":[356,529]},{"content":"In general, you mark methods that contain asynchronous code with the <bpt id=\"p1\">[</bpt>async (C#)<ept id=\"p1\">](../../../../csharp/language-reference/keywords/async.md)</ept> modifier.","pos":[531,679],"source":"In general, you mark methods that contain asynchronous code with the [async (C#)](../../../../csharp/language-reference/keywords/async.md) modifier."},{"content":"In a method that's marked with an async modifier, you can use an <bpt id=\"p1\">[</bpt>await (C#)<ept id=\"p1\">](../../../../csharp/language-reference/keywords/await.md)</ept> operator to specify where the method pauses to wait for a called asynchronous process to complete.","pos":[680,913],"source":" In a method that's marked with an async modifier, you can use an [await (C#)](../../../../csharp/language-reference/keywords/await.md) operator to specify where the method pauses to wait for a called asynchronous process to complete."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Asynchronous Programming with async and await (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/index.md)</ept>.","pos":[914,1055],"source":" For more information, see [Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)."},{"content":"The following example uses async methods to download the contents of a specified website as a string and to display the length of the string.","pos":[1057,1198]},{"content":"The example contains the following two methods.","pos":[1199,1246]},{"pos":[1252,1329],"content":"<ph id=\"ph1\">`startButton_Click`</ph>, which calls <ph id=\"ph2\">`AccessTheWebAsync`</ph> and displays the result.","source":"`startButton_Click`, which calls `AccessTheWebAsync` and displays the result."},{"content":"<ph id=\"ph1\">`AccessTheWebAsync`</ph>, which downloads the contents of a website as a string and returns the length of the string.","pos":[1335,1447],"source":"`AccessTheWebAsync`, which downloads the contents of a website as a string and returns the length of the string."},{"content":"<ph id=\"ph1\">`AccessTheWebAsync`</ph> uses an asynchronous <ph id=\"ph2\">&lt;xref:System.Net.Http.HttpClient&gt;</ph> method, <ph id=\"ph3\">&lt;xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29&gt;</ph>, to download the contents.","pos":[1448,1625],"source":"`AccessTheWebAsync` uses an asynchronous <xref:System.Net.Http.HttpClient> method, <xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29>, to download the contents."},{"content":"Numbered display lines appear at strategic points throughout the program to help you understand how the program runs and to explain what happens at each point that is marked.","pos":[1627,1801]},{"content":"The display lines are labeled \"ONE\" through \"SIX.\"","pos":[1802,1852]},{"content":"The labels represent the order in which the program reaches these lines of code.","pos":[1853,1933]},{"content":"The following code shows an outline of the program.","pos":[1935,1986]},{"content":"Each of the labeled locations, \"ONE\" through \"SIX,\" displays information about the current state of the program.","pos":[2741,2853]},{"content":"The following output is produced:","pos":[2854,2887]},{"pos":[3769,3787],"content":"Set up the program","linkify":"Set up the program","nodes":[{"content":"Set up the program","pos":[0,18]}]},{"content":"You can download the code that this topic uses from MSDN, or you can build it yourself.","pos":[3789,3876]},{"pos":[3880,4015],"content":"[!NOTE]\nTo run the example, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.","leadings":["","> "],"nodes":[{"content":"To run the example, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.","pos":[8,133]}]},{"pos":[4021,4041],"content":"Download the program","linkify":"Download the program","nodes":[{"content":"Download the program","pos":[0,20]}]},{"content":"You can download the application for this topic from <bpt id=\"p1\">[</bpt>Async Sample: Control Flow in Async Programs<ept id=\"p1\">](https://code.msdn.microsoft.com/Async-Sample-Control-Flow-5c804fc0)</ept>.","pos":[4043,4211],"source":"You can download the application for this topic from [Async Sample: Control Flow in Async Programs](https://code.msdn.microsoft.com/Async-Sample-Control-Flow-5c804fc0)."},{"content":"The following steps open and run the program.","pos":[4212,4257]},{"content":"Unzip the downloaded file, and then start Visual Studio.","pos":[4263,4319]},{"pos":[4325,4392],"content":"On the menu bar, choose <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Project/Solution<ept id=\"p3\">**</ept>.","source":"On the menu bar, choose **File** > **Open** > **Project/Solution**."},{"pos":[4398,4549],"content":"Navigate to the folder that holds the unzipped sample code, open the solution (.sln) file, and then choose the <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept> key to build and run the project.","source":"Navigate to the folder that holds the unzipped sample code, open the solution (.sln) file, and then choose the **F5** key to build and run the project."},{"pos":[4555,4582],"content":"Create the program Yourself","linkify":"Create the program Yourself","nodes":[{"content":"Create the program Yourself","pos":[0,27]}]},{"content":"The following Windows Presentation Foundation (WPF) project contains the code example for this topic.","pos":[4584,4685]},{"content":"To run the project, perform the following steps:","pos":[4687,4735]},{"content":"Start Visual Studio.","pos":[4741,4761]},{"pos":[4767,4824],"content":"On the menu bar, choose <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>New<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Project<ept id=\"p3\">**</ept>.","source":"On the menu bar, choose **File** > **New** > **Project**."},{"pos":[4831,4868],"content":"The <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> dialog box opens.","source":"The **New Project** dialog box opens."},{"pos":[4874,5010],"content":"Choose the <bpt id=\"p1\">**</bpt>Installed<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>Visual C#<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Windows Desktop<ept id=\"p3\">**</ept> category, and then choose <bpt id=\"p4\">**</bpt>WPF App<ept id=\"p4\">**</ept> from the list of project templates.","source":"Choose the **Installed** > **Visual C#** > **Windows Desktop** category, and then choose **WPF App** from the list of project templates."},{"pos":[5016,5098],"content":"Enter <ph id=\"ph1\">`AsyncTracer`</ph> as the name of the project, and then choose the <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> button.","source":"Enter `AsyncTracer` as the name of the project, and then choose the **OK** button."},{"pos":[5105,5154],"content":"The new project appears in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>.","source":"The new project appears in **Solution Explorer**."},{"pos":[5160,5229],"content":"In the Visual Studio Code Editor, choose the <bpt id=\"p1\">**</bpt>MainWindow.xaml<ept id=\"p1\">**</ept> tab.","source":"In the Visual Studio Code Editor, choose the **MainWindow.xaml** tab."},{"pos":[5236,5361],"content":"If the tab isn’t visible, open the shortcut menu for MainWindow.xaml in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, and then choose <bpt id=\"p2\">**</bpt>View Code<ept id=\"p2\">**</ept>.","source":"If the tab isn’t visible, open the shortcut menu for MainWindow.xaml in **Solution Explorer**, and then choose **View Code**."},{"pos":[5367,5449],"content":"In the <bpt id=\"p1\">**</bpt>XAML<ept id=\"p1\">**</ept> view of MainWindow.xaml, replace the code with the following code.","source":"In the **XAML** view of MainWindow.xaml, replace the code with the following code."},{"pos":[6399,6503],"content":"A simple window that contains a text box and a button appears in the <bpt id=\"p1\">**</bpt>Design<ept id=\"p1\">**</ept> view of MainWindow.xaml.","source":"A simple window that contains a text box and a button appears in the **Design** view of MainWindow.xaml."},{"pos":[6509,6552],"content":"Add a reference for <ph id=\"ph1\">&lt;xref:System.Net.Http&gt;</ph>.","source":"Add a reference for <xref:System.Net.Http>."},{"pos":[6558,6661],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, open the shortcut menu for MainWindow.xaml.cs, and then choose <bpt id=\"p2\">**</bpt>View Code<ept id=\"p2\">**</ept>.","source":"In **Solution Explorer**, open the shortcut menu for MainWindow.xaml.cs, and then choose **View Code**."},{"content":"In MainWindow.xaml.cs, replace the code with the following code.","pos":[6666,6730]},{"pos":[10061,10140],"content":"Choose the <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept> key to run the program, and then choose the <bpt id=\"p2\">**</bpt>Start<ept id=\"p2\">**</ept> button.","source":"Choose the **F5** key to run the program, and then choose the **Start** button."},{"content":"The following output appears:","pos":[10146,10175]},{"pos":[11141,11158],"content":"Trace the program","linkify":"Trace the program","nodes":[{"content":"Trace the program","pos":[0,17]}]},{"pos":[11164,11181],"content":"Steps ONE and TWO","linkify":"Steps ONE and TWO","nodes":[{"content":"Steps ONE and TWO","pos":[0,17]}]},{"content":"The first two display lines trace the path as <ph id=\"ph1\">`startButton_Click`</ph> calls <ph id=\"ph2\">`AccessTheWebAsync`</ph>, and <ph id=\"ph3\">`AccessTheWebAsync`</ph> calls the asynchronous <ph id=\"ph4\">&lt;xref:System.Net.Http.HttpClient&gt;</ph> method <ph id=\"ph5\">&lt;xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29&gt;</ph>.","pos":[11183,11432],"source":"The first two display lines trace the path as `startButton_Click` calls `AccessTheWebAsync`, and `AccessTheWebAsync` calls the asynchronous <xref:System.Net.Http.HttpClient> method <xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29>."},{"content":"The following image outlines the calls from method to method.","pos":[11433,11494]},{"pos":[11496,11617],"content":"<bpt id=\"p1\">![</bpt>Steps ONE and TWO<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../csharp/programming-guide/concepts/async/media/asynctrace-onetwo.png \"</bpt>AsyncTrace-ONETWO<ept id=\"p2\">\")</ept>","source":"![Steps ONE and TWO](../../../../csharp/programming-guide/concepts/async/media/asynctrace-onetwo.png \"AsyncTrace-ONETWO\")"},{"content":"The return type of both <ph id=\"ph1\">`AccessTheWebAsync`</ph> and <ph id=\"ph2\">`client.GetStringAsync`</ph> is <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.Task%601&gt;</ph>.","pos":[11619,11733],"source":"The return type of both `AccessTheWebAsync` and `client.GetStringAsync` is <xref:System.Threading.Tasks.Task%601>."},{"content":"For <ph id=\"ph1\">`AccessTheWebAsync`</ph>, TResult is an integer.","pos":[11734,11781],"source":" For `AccessTheWebAsync`, TResult is an integer."},{"content":"For <ph id=\"ph1\">`GetStringAsync`</ph>, TResult is a string.","pos":[11782,11824],"source":" For `GetStringAsync`, TResult is a string."},{"content":"For more information about async method return types, see <bpt id=\"p1\">[</bpt>Async Return Types (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/async-return-types.md)</ept>.","pos":[11825,11984],"source":" For more information about async method return types, see [Async Return Types (C#)](../../../../csharp/programming-guide/concepts/async/async-return-types.md)."},{"content":"A task-returning async method returns a task instance when control shifts back to the caller.","pos":[11986,12079]},{"content":"Control returns from an async method to its caller either when an <ph id=\"ph1\">`await`</ph> operator is encountered in the called method or when the called method ends.","pos":[12080,12230],"source":" Control returns from an async method to its caller either when an `await` operator is encountered in the called method or when the called method ends."},{"content":"The display lines that are labeled \"THREE\" through \"SIX\" trace this part of the process.","pos":[12231,12319]},{"pos":[12325,12335],"content":"Step THREE","linkify":"Step THREE","nodes":[{"content":"Step THREE","pos":[0,10]}]},{"content":"In <ph id=\"ph1\">`AccessTheWebAsync`</ph>, the asynchronous method <ph id=\"ph2\">&lt;xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29&gt;</ph> is called to download the contents of the target webpage.","pos":[12337,12510],"source":"In `AccessTheWebAsync`, the asynchronous method <xref:System.Net.Http.HttpClient.GetStringAsync%28System.String%29> is called to download the contents of the target webpage."},{"content":"Control returns from <ph id=\"ph1\">`client.GetStringAsync`</ph> to <ph id=\"ph2\">`AccessTheWebAsync`</ph> when <ph id=\"ph3\">`client.GetStringAsync`</ph> returns.","pos":[12511,12616],"source":" Control returns from `client.GetStringAsync` to `AccessTheWebAsync` when `client.GetStringAsync` returns."},{"content":"The <ph id=\"ph1\">`client.GetStringAsync`</ph> method returns a task of string that’s assigned to the <ph id=\"ph2\">`getStringTask`</ph> variable in <ph id=\"ph3\">`AccessTheWebAsync`</ph>.","pos":[12619,12750],"source":"The `client.GetStringAsync` method returns a task of string that’s assigned to the `getStringTask` variable in `AccessTheWebAsync`."},{"content":"The following line in the example program shows the call to <ph id=\"ph1\">`client.GetStringAsync`</ph> and the assignment.","pos":[12751,12854],"source":" The following line in the example program shows the call to `client.GetStringAsync` and the assignment."},{"content":"You can think of the task as a promise by <ph id=\"ph1\">`client.GetStringAsync`</ph> to produce an actual string eventually.","pos":[12954,13059],"source":"You can think of the task as a promise by `client.GetStringAsync` to produce an actual string eventually."},{"content":"In the meantime, if <ph id=\"ph1\">`AccessTheWebAsync`</ph> has work to do that doesn't depend on the promised string from <ph id=\"ph2\">`client.GetStringAsync`</ph>, that work can continue while  <ph id=\"ph3\">`client.GetStringAsync`</ph> waits.","pos":[13060,13248],"source":" In the meantime, if `AccessTheWebAsync` has work to do that doesn't depend on the promised string from `client.GetStringAsync`, that work can continue while  `client.GetStringAsync` waits."},{"content":"In the example, the following lines of output, which are labeled \"THREE,\" represent the opportunity to do independent work","pos":[13249,13371]},{"pos":[13542,13639],"content":"The following statement suspends progress in <ph id=\"ph1\">`AccessTheWebAsync`</ph> when <ph id=\"ph2\">`getStringTask`</ph> is awaited.","source":"The following statement suspends progress in `AccessTheWebAsync` when `getStringTask` is awaited."},{"pos":[13699,13892],"content":"The following image shows the flow of control from <ph id=\"ph1\">`client.GetStringAsync`</ph> to the assignment to <ph id=\"ph2\">`getStringTask`</ph> and from the creation of <ph id=\"ph3\">`getStringTask`</ph> to the application of an await operator.","source":"The following image shows the flow of control from `client.GetStringAsync` to the assignment to `getStringTask` and from the creation of `getStringTask` to the application of an await operator."},{"pos":[13895,14007],"content":"<bpt id=\"p1\">![</bpt>Step THREE<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../csharp/programming-guide/concepts/async/media/asynctrace-three.png \"</bpt>AsyncTrace-Three<ept id=\"p2\">\")</ept>","source":"![Step THREE](../../../../csharp/programming-guide/concepts/async/media/asynctrace-three.png \"AsyncTrace-Three\")"},{"content":"The await expression suspends <ph id=\"ph1\">`AccessTheWebAsync`</ph> until <ph id=\"ph2\">`client.GetStringAsync`</ph> returns.","pos":[14010,14098],"source":"The await expression suspends `AccessTheWebAsync` until `client.GetStringAsync` returns."},{"content":"In the meantime, control returns to the caller of <ph id=\"ph1\">`AccessTheWebAsync`</ph>, <ph id=\"ph2\">`startButton_Click`</ph>.","pos":[14099,14190],"source":" In the meantime, control returns to the caller of `AccessTheWebAsync`, `startButton_Click`."},{"pos":[14194,14470],"content":"[!NOTE]\nTypically, you await the call to an asynchronous method immediately. For example, the following assignment could replace the previous code that creates and then awaits `getStringTask`: `string urlContents = await client.GetStringAsync(\"https://msdn.microsoft.com\");`","leadings":["","> "],"nodes":[{"content":"Typically, you await the call to an asynchronous method immediately. For example, the following assignment could replace the previous code that creates and then awaits `getStringTask`: `string urlContents = await client.GetStringAsync(\"https://msdn.microsoft.com\");`","pos":[8,274],"nodes":[{"content":"Typically, you await the call to an asynchronous method immediately.","pos":[0,68]},{"content":"For example, the following assignment could replace the previous code that creates and then awaits <ph id=\"ph1\">`getStringTask`</ph>: <ph id=\"ph2\">`string urlContents = await client.GetStringAsync(\"https://msdn.microsoft.com\");`</ph>","pos":[69,266],"source":" For example, the following assignment could replace the previous code that creates and then awaits `getStringTask`: `string urlContents = await client.GetStringAsync(\"https://msdn.microsoft.com\");`"}]}]},{"content":"In this topic, the await operator is applied later to accommodate the output lines that mark the flow of control through the program.","pos":[14475,14608]},{"pos":[14614,14623],"content":"Step FOUR","linkify":"Step FOUR","nodes":[{"content":"Step FOUR","pos":[0,9]}]},{"content":"The declared return type of <ph id=\"ph1\">`AccessTheWebAsync`</ph> is <ph id=\"ph2\">`Task&lt;int&gt;`</ph>.","pos":[14625,14688],"source":"The declared return type of `AccessTheWebAsync` is `Task<int>`."},{"content":"Therefore, when <ph id=\"ph1\">`AccessTheWebAsync`</ph> is suspended, it returns a task of integer to <ph id=\"ph2\">`startButton_Click`</ph>.","pos":[14689,14791],"source":" Therefore, when `AccessTheWebAsync` is suspended, it returns a task of integer to `startButton_Click`."},{"content":"You should understand that the returned task isn’t <ph id=\"ph1\">`getStringTask`</ph>.","pos":[14792,14859],"source":" You should understand that the returned task isn’t `getStringTask`."},{"content":"The returned task is a new task of integer that represents what remains to be done in the suspended method, <ph id=\"ph1\">`AccessTheWebAsync`</ph>.","pos":[14860,14988],"source":" The returned task is a new task of integer that represents what remains to be done in the suspended method, `AccessTheWebAsync`."},{"content":"The task is a promise from <ph id=\"ph1\">`AccessTheWebAsync`</ph> to produce an integer when the task is complete.","pos":[14989,15084],"source":" The task is a promise from `AccessTheWebAsync` to produce an integer when the task is complete."},{"pos":[15086,15160],"content":"The following statement assigns this task to the <ph id=\"ph1\">`getLengthTask`</ph> variable.","source":"The following statement assigns this task to the `getLengthTask` variable."},{"content":"As in <ph id=\"ph1\">`AccessTheWebAsync`</ph>, <ph id=\"ph2\">`startButton_Click`</ph> can continue with work that doesn’t depend on the results of the asynchronous task (<ph id=\"ph3\">`getLengthTask`</ph>) until the task is awaited.","pos":[15225,15399],"source":"As in `AccessTheWebAsync`, `startButton_Click` can continue with work that doesn’t depend on the results of the asynchronous task (`getLengthTask`) until the task is awaited."},{"content":"The following output lines represent that work.","pos":[15400,15447]},{"content":"Progress in <ph id=\"ph1\">`startButton_Click`</ph> is suspended when <ph id=\"ph2\">`getLengthTask`</ph> is awaited.","pos":[15602,15679],"source":"Progress in `startButton_Click` is suspended when `getLengthTask` is awaited."},{"content":"The following assignment statement suspends <ph id=\"ph1\">`startButton_Click`</ph> until <ph id=\"ph2\">`AccessTheWebAsync`</ph> is complete.","pos":[15680,15782],"source":" The following assignment statement suspends `startButton_Click` until `AccessTheWebAsync` is complete."},{"pos":[15841,16092],"content":"In the following illustration, the arrows show the flow of control from the await expression in <ph id=\"ph1\">`AccessTheWebAsync`</ph> to the assignment of a value to <ph id=\"ph2\">`getLengthTask`</ph>, followed by normal processing in <ph id=\"ph3\">`startButton_Click`</ph> until <ph id=\"ph4\">`getLengthTask`</ph> is awaited.","source":"In the following illustration, the arrows show the flow of control from the await expression in `AccessTheWebAsync` to the assignment of a value to `getLengthTask`, followed by normal processing in `startButton_Click` until `getLengthTask` is awaited."},{"pos":[16095,16204],"content":"<bpt id=\"p1\">![</bpt>Step FOUR<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../csharp/programming-guide/concepts/async/media/asynctrace-four.png \"</bpt>AsyncTrace-FOUR<ept id=\"p2\">\")</ept>","source":"![Step FOUR](../../../../csharp/programming-guide/concepts/async/media/asynctrace-four.png \"AsyncTrace-FOUR\")"},{"pos":[16210,16219],"content":"Step FIVE","linkify":"Step FIVE","nodes":[{"content":"Step FIVE","pos":[0,9]}]},{"content":"When <ph id=\"ph1\">`client.GetStringAsync`</ph> signals that it’s complete, processing in <ph id=\"ph2\">`AccessTheWebAsync`</ph> is released from suspension and can continue past the await statement.","pos":[16221,16382],"source":"When `client.GetStringAsync` signals that it’s complete, processing in `AccessTheWebAsync` is released from suspension and can continue past the await statement."},{"content":"The following lines of output represent the resumption of processing.","pos":[16383,16452]},{"content":"The operand of the return statement, <ph id=\"ph1\">`urlContents.Length`</ph>, is stored in the task that  <ph id=\"ph2\">`AccessTheWebAsync`</ph> returns.","pos":[16628,16743],"source":"The operand of the return statement, `urlContents.Length`, is stored in the task that  `AccessTheWebAsync` returns."},{"content":"The await expression retrieves that value from <ph id=\"ph1\">`getLengthTask`</ph> in <ph id=\"ph2\">`startButton_Click`</ph>.","pos":[16744,16830],"source":" The await expression retrieves that value from `getLengthTask` in `startButton_Click`."},{"pos":[16833,16948],"content":"The following image shows the transfer of control after <ph id=\"ph1\">`client.GetStringAsync`</ph> (and <ph id=\"ph2\">`getStringTask`</ph>) are complete.","source":"The following image shows the transfer of control after `client.GetStringAsync` (and `getStringTask`) are complete."},{"pos":[16951,17060],"content":"<bpt id=\"p1\">![</bpt>Step FIVE<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../csharp/programming-guide/concepts/async/media/asynctrace-five.png \"</bpt>AsyncTrace-FIVE<ept id=\"p2\">\")</ept>","source":"![Step FIVE](../../../../csharp/programming-guide/concepts/async/media/asynctrace-five.png \"AsyncTrace-FIVE\")"},{"pos":[17063,17180],"content":"<ph id=\"ph1\">`AccessTheWebAsync`</ph> runs to completion, and control returns to <ph id=\"ph2\">`startButton_Click`</ph>, which is awaiting the completion.","source":"`AccessTheWebAsync` runs to completion, and control returns to `startButton_Click`, which is awaiting the completion."},{"pos":[17186,17194],"content":"Step SIX","linkify":"Step SIX","nodes":[{"content":"Step SIX","pos":[0,8]}]},{"content":"When <ph id=\"ph1\">`AccessTheWebAsync`</ph> signals that it’s complete, processing can continue past the await statement in <ph id=\"ph2\">`startButton_Async`</ph>.","pos":[17196,17321],"source":"When `AccessTheWebAsync` signals that it’s complete, processing can continue past the await statement in `startButton_Async`."},{"content":"In fact, the program has nothing more to do.","pos":[17322,17366]},{"pos":[17368,17460],"content":"The following lines of output represent the resumption of processing in <ph id=\"ph1\">`startButton_Async`</ph>:","source":"The following lines of output represent the resumption of processing in `startButton_Async`:"},{"content":"The await expression retrieves from <ph id=\"ph1\">`getLengthTask`</ph> the integer value that’s the operand of the return statement in <ph id=\"ph2\">`AccessTheWebAsync`</ph>.","pos":[17670,17806],"source":"The await expression retrieves from `getLengthTask` the integer value that’s the operand of the return statement in `AccessTheWebAsync`."},{"content":"The following statement assigns that value to the <ph id=\"ph1\">`contentLength`</ph> variable.","pos":[17807,17882],"source":" The following statement assigns that value to the `contentLength` variable."},{"pos":[17941,18037],"content":"The following image shows the return of control from <ph id=\"ph1\">`AccessTheWebAsync`</ph> to <ph id=\"ph2\">`startButton_Click`</ph>.","source":"The following image shows the return of control from `AccessTheWebAsync` to `startButton_Click`."},{"pos":[18040,18146],"content":"<bpt id=\"p1\">![</bpt>Step SIX<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../csharp/programming-guide/concepts/async/media/asynctrace-six.png \"</bpt>AsyncTrace-SIX<ept id=\"p2\">\")</ept>","source":"![Step SIX](../../../../csharp/programming-guide/concepts/async/media/asynctrace-six.png \"AsyncTrace-SIX\")"},{"pos":[18151,18159],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[18163,18277],"content":"<bpt id=\"p1\">[</bpt>Asynchronous Programming with async and await (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/index.md)</ept>","source":"[Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)"},{"pos":[18280,18380],"content":"<bpt id=\"p1\">[</bpt>Async Return Types (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/async-return-types.md)</ept>","source":"[Async Return Types (C#)](../../../../csharp/programming-guide/concepts/async/async-return-types.md)"},{"pos":[18383,18556],"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using async and await (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept>","source":"[Walkthrough: Accessing the Web by Using async and await (C#)](../../../../csharp/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)"},{"pos":[18559,18695],"content":"<bpt id=\"p1\">[</bpt>Async Sample: Control Flow in Async Programs (C# and Visual Basic)<ept id=\"p1\">](https://code.msdn.microsoft.com/Async-Sample-Control-Flow-5c804fc0)</ept>","source":"[Async Sample: Control Flow in Async Programs (C# and Visual Basic)](https://code.msdn.microsoft.com/Async-Sample-Control-Flow-5c804fc0)"}]}