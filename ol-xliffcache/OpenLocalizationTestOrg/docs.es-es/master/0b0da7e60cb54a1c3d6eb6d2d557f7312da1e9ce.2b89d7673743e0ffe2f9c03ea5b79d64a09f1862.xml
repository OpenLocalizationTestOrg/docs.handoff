{"content":"---\ntitle: \"How to: Create a Security Context Token for a Secure Session\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: 640676b6-c75a-4ff7-aea4-b1a1524d71b2\n---\n# How to: Create a Security Context Token for a Secure Session\nBy using a stateful security context token (SCT) in a secure session, the session can withstand the service being recycled. For instance, when a stateless SCT is used in a secure session and Internet Information Services (IIS) is reset, then the session data that is associated with the service is lost. This session data includes an SCT token cache. So, the next time a client sends the service a stateless SCT, an error is returned, because the key that is associated with the SCT cannot be retrieved. If, however, a stateful SCT is used, then the key that is associated with the SCT is contained within the SCT. Because the key is contained within the SCT and thus contained within the message, the secure session is not affected by the service being recycled. By default, Windows Communication Foundation (WCF) uses stateless SCTs in a secure session. This topic details how to use stateful SCTs in a secure session.  \n  \n> [!NOTE]\n>  Stateful SCTs cannot be used in a secure session that involves a contract that derives from <xref:System.ServiceModel.Channels.IDuplexChannel>.  \n  \n> [!NOTE]\n>  For applications that use stateful SCTs in a secure session, the thread identity for the service must be a user account that has an associated user profile. When the service is run under an account that does not have a user profile, such as `Local Service`, an exception may be thrown.  \n  \n> [!NOTE]\n>  When impersonation is required on Windows XP, use a secure session without a stateful SCT. When stateful SCTs are used with impersonation, an <xref:System.InvalidOperationException> is thrown. For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).  \n  \n### To use stateful SCTs in a secure session  \n  \n-   Create a custom binding that specifies that SOAP messages are protected by a secure session that uses a stateful SCT.  \n  \n    1.  Define a custom binding, by adding a [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md) to the configuration file for the service.  \n  \n        ```xml  \n        <customBinding>  \n        ```  \n  \n    2.  Add a [\\<binding>](../../../../docs/framework/misc/binding.md) child element to the [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md).  \n  \n         Specify a binding name by setting the `name` attribute to a unique name within the configuration file.  \n  \n        ```xml  \n        <binding name=\"StatefulSCTSecureSession\">  \n        ```  \n  \n    3.  Specify the authentication mode for messages sent to and from this service by adding a [\\<security>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-custombinding.md) child element to the [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md).  \n  \n         Specify that a secure session is used by setting the `authenticationMode` attribute to `SecureConversation`. Specify that stateful SCTs are used by setting the `requireSecurityContextCancellation` attribute to `false`.  \n  \n        ```xml  \n        <security authenticationMode=\"SecureConversation\"  \n                  requireSecurityContextCancellation=\"false\">  \n        ```  \n  \n    4.  Specify how the client is authenticated while the secure session is established by adding a [\\<secureConversationBootstrap>](../../../../docs/framework/configure-apps/file-schema/wcf/secureconversationbootstrap.md) child element to the [\\<security>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-custombinding.md).  \n  \n         Specify how the client is authenticated by setting the `authenticationMode` attribute.  \n  \n        ```xml  \n        <secureConversationBootstrap authenticationMode=\"UserNameForCertificate\" />  \n        ```  \n  \n    5.  Specify the message encoding by adding an encoding element, such as [\\<textMessageEncoding>](../../../../docs/framework/configure-apps/file-schema/wcf/textmessageencoding.md).  \n  \n        ```xml  \n        <textMessageEncoding />  \n        ```  \n  \n    6.  Specify the transport by adding a transport element, such as the [\\<httpTransport>](../../../../docs/framework/configure-apps/file-schema/wcf/httptransport.md).  \n  \n        ```xml  \n        <httpTransport />  \n        ```  \n  \n     The following code example uses configuration to specify a custom binding that messages can use with stateful SCTs in a secure session.  \n  \n    ```xml  \n    <customBinding>  \n      <binding name=\"StatefulSCTSecureSession\">  \n        <security authenticationMode=\"SecureConversation\"  \n                  requireSecurityContextCancellation=\"false\">  \n          <secureConversationBootstrap authenticationMode=\"UserNameForCertificate\" />  \n        </security>  \n        <textMessageEncoding />  \n        <httpTransport />  \n      </binding>  \n    </customBinding>  \n    ```  \n  \n## Example  \n The following code example creates a custom binding that uses the <xref:System.ServiceModel.Configuration.AuthenticationMode.MutualCertificate> authentication mode to bootstrap a secure session.  \n  \n [!code-csharp[c_CreateStatefulSCT#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_createstatefulsct/cs/secureservice.cs#2)]\n [!code-vb[c_CreateStatefulSCT#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_createstatefulsct/vb/secureservice.vb#2)]  \n  \n When Windows authentication is used in combination with a stateful SCT, WCF does not populate the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property with the actual caller's identity but instead sets the property to anonymous. Because WCF security must re-create the content of the service security context for every request from the incoming SCT, the server does not keep track of the security session in the memory. Because it is impossible to serialize the <xref:System.Security.Principal.WindowsIdentity> instance into the SCT, the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property returns an anonymous identity.  \n  \n The following configuration exhibits this behavior.  \n  \n```xml  \n<customBinding>  \n  <binding name=\"Cancellation\">  \n       <textMessageEncoding />  \n        <security   \n            requireSecurityContextCancellation=\"false\">  \n              <secureConversationBootstrap />  \n      </security>  \n    <httpTransport />  \n  </binding>  \n</customBinding>  \n```  \n  \n## See also\n\n- [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)\n","nodes":[{"pos":[4,178],"embed":true,"restype":"x-metadata","content":"title: \"How to: Create a Security Context Token for a Secure Session\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: 640676b6-c75a-4ff7-aea4-b1a1524d71b2","nodes":[{"content":"How to: Create a Security Context Token for a Secure Session","nodes":[{"pos":[0,60],"content":"How to: Create a Security Context Token for a Secure Session","nodes":[{"content":"How to: Create a Security Context Token for a Secure Session","pos":[0,60]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[185,245],"content":"How to: Create a Security Context Token for a Secure Session","linkify":"How to: Create a Security Context Token for a Secure Session","nodes":[{"content":"How to: Create a Security Context Token for a Secure Session","pos":[0,60]}]},{"content":"By using a stateful security context token (SCT) in a secure session, the session can withstand the service being recycled.","pos":[246,369]},{"content":"For instance, when a stateless SCT is used in a secure session and Internet Information Services (IIS) is reset, then the session data that is associated with the service is lost.","pos":[370,549]},{"content":"This session data includes an SCT token cache.","pos":[550,596]},{"content":"So, the next time a client sends the service a stateless SCT, an error is returned, because the key that is associated with the SCT cannot be retrieved.","pos":[597,749]},{"content":"If, however, a stateful SCT is used, then the key that is associated with the SCT is contained within the SCT.","pos":[750,860]},{"content":"Because the key is contained within the SCT and thus contained within the message, the secure session is not affected by the service being recycled.","pos":[861,1009]},{"content":"By default, Windows Communication Foundation (WCF) uses stateless SCTs in a secure session.","pos":[1010,1101]},{"content":"This topic details how to use stateful SCTs in a secure session.","pos":[1102,1166]},{"pos":[1174,1328],"content":"[!NOTE]\n Stateful SCTs cannot be used in a secure session that involves a contract that derives from <xref:System.ServiceModel.Channels.IDuplexChannel>.","leadings":["","> "],"nodes":[{"content":"Stateful SCTs cannot be used in a secure session that involves a contract that derives from <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IDuplexChannel&gt;</ph>.","pos":[9,152],"source":"Stateful SCTs cannot be used in a secure session that involves a contract that derives from <xref:System.ServiceModel.Channels.IDuplexChannel>."}]},{"pos":[1336,1632],"content":"[!NOTE]\n For applications that use stateful SCTs in a secure session, the thread identity for the service must be a user account that has an associated user profile. When the service is run under an account that does not have a user profile, such as `Local Service`, an exception may be thrown.","leadings":["","> "],"nodes":[{"content":"For applications that use stateful SCTs in a secure session, the thread identity for the service must be a user account that has an associated user profile. When the service is run under an account that does not have a user profile, such as `Local Service`, an exception may be thrown.","pos":[9,294],"nodes":[{"content":"For applications that use stateful SCTs in a secure session, the thread identity for the service must be a user account that has an associated user profile.","pos":[0,156]},{"content":"When the service is run under an account that does not have a user profile, such as <ph id=\"ph1\">`Local Service`</ph>, an exception may be thrown.","pos":[157,285],"source":" When the service is run under an account that does not have a user profile, such as `Local Service`, an exception may be thrown."}]}]},{"pos":[1640,1967],"content":"[!NOTE]\n When impersonation is required on Windows XP, use a secure session without a stateful SCT. When stateful SCTs are used with impersonation, an <xref:System.InvalidOperationException> is thrown. For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).","leadings":["","> "],"nodes":[{"content":"When impersonation is required on Windows XP, use a secure session without a stateful SCT. When stateful SCTs are used with impersonation, an <xref:System.InvalidOperationException> is thrown. For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).","pos":[9,325],"nodes":[{"content":"When impersonation is required on Windows XP, use a secure session without a stateful SCT.","pos":[0,90]},{"content":"When stateful SCTs are used with impersonation, an <ph id=\"ph1\">&lt;xref:System.InvalidOperationException&gt;</ph> is thrown.","pos":[91,192],"source":" When stateful SCTs are used with impersonation, an <xref:System.InvalidOperationException> is thrown."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Unsupported Scenarios<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)</ept>.","pos":[193,316],"source":" For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)."}]}]},{"pos":[1977,2017],"content":"To use stateful SCTs in a secure session","linkify":"To use stateful SCTs in a secure session","nodes":[{"content":"To use stateful SCTs in a secure session","pos":[0,40]}]},{"content":"Create a custom binding that specifies that SOAP messages are protected by a secure session that uses a stateful SCT.","pos":[2027,2144]},{"pos":[2158,2332],"content":"Define a custom binding, by adding a <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>customBinding&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)</ept> to the configuration file for the service.","source":"Define a custom binding, by adding a [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md) to the configuration file for the service."},{"pos":[2406,2585],"content":"Add a <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>binding&gt;<ept id=\"p1\">](../../../../docs/framework/misc/binding.md)</ept> child element to the <bpt id=\"p2\">[</bpt><ph id=\"ph2\">\\&lt;</ph>customBinding&gt;<ept id=\"p2\">](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)</ept>.","source":"Add a [\\<binding>](../../../../docs/framework/misc/binding.md) child element to the [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)."},{"pos":[2600,2702],"content":"Specify a binding name by setting the <ph id=\"ph1\">`name`</ph> attribute to a unique name within the configuration file.","source":"Specify a binding name by setting the `name` attribute to a unique name within the configuration file."},{"pos":[2802,3107],"content":"Specify the authentication mode for messages sent to and from this service by adding a <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>security&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-custombinding.md)</ept> child element to the <bpt id=\"p2\">[</bpt><ph id=\"ph2\">\\&lt;</ph>customBinding&gt;<ept id=\"p2\">](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)</ept>.","source":"Specify the authentication mode for messages sent to and from this service by adding a [\\<security>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-custombinding.md) child element to the [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)."},{"content":"Specify that a secure session is used by setting the <ph id=\"ph1\">`authenticationMode`</ph> attribute to <ph id=\"ph2\">`SecureConversation`</ph>.","pos":[3122,3230],"source":"Specify that a secure session is used by setting the `authenticationMode` attribute to `SecureConversation`."},{"content":"Specify that stateful SCTs are used by setting the <ph id=\"ph1\">`requireSecurityContextCancellation`</ph> attribute to <ph id=\"ph2\">`false`</ph>.","pos":[3231,3340],"source":" Specify that stateful SCTs are used by setting the `requireSecurityContextCancellation` attribute to `false`."},{"pos":[3512,3850],"content":"Specify how the client is authenticated while the secure session is established by adding a <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>secureConversationBootstrap&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/secureconversationbootstrap.md)</ept> child element to the <bpt id=\"p2\">[</bpt><ph id=\"ph2\">\\&lt;</ph>security&gt;<ept id=\"p2\">](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-custombinding.md)</ept>.","source":"Specify how the client is authenticated while the secure session is established by adding a [\\<secureConversationBootstrap>](../../../../docs/framework/configure-apps/file-schema/wcf/secureconversationbootstrap.md) child element to the [\\<security>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-custombinding.md)."},{"pos":[3865,3951],"content":"Specify how the client is authenticated by setting the <ph id=\"ph1\">`authenticationMode`</ph> attribute.","source":"Specify how the client is authenticated by setting the `authenticationMode` attribute."},{"pos":[4085,4260],"content":"Specify the message encoding by adding an encoding element, such as <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>textMessageEncoding&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/textmessageencoding.md)</ept>.","source":"Specify the message encoding by adding an encoding element, such as [\\<textMessageEncoding>](../../../../docs/framework/configure-apps/file-schema/wcf/textmessageencoding.md)."},{"pos":[4342,4502],"content":"Specify the transport by adding a transport element, such as the <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>httpTransport&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/httptransport.md)</ept>.","source":"Specify the transport by adding a transport element, such as the [\\<httpTransport>](../../../../docs/framework/configure-apps/file-schema/wcf/httptransport.md)."},{"content":"The following code example uses configuration to specify a custom binding that messages can use with stateful SCTs in a secure session.","pos":[4575,4710]},{"pos":[5155,5162],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[5166,5360],"content":"The following code example creates a custom binding that uses the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Configuration.AuthenticationMode.MutualCertificate&gt;</ph> authentication mode to bootstrap a secure session.","source":"The following code example creates a custom binding that uses the <xref:System.ServiceModel.Configuration.AuthenticationMode.MutualCertificate> authentication mode to bootstrap a secure session."},{"content":"When Windows authentication is used in combination with a stateful SCT, WCF does not populate the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A&gt;</ph> property with the actual caller's identity but instead sets the property to anonymous.","pos":[5641,5894],"source":"When Windows authentication is used in combination with a stateful SCT, WCF does not populate the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property with the actual caller's identity but instead sets the property to anonymous."},{"content":"Because WCF security must re-create the content of the service security context for every request from the incoming SCT, the server does not keep track of the security session in the memory.","pos":[5895,6085]},{"content":"Because it is impossible to serialize the <ph id=\"ph1\">&lt;xref:System.Security.Principal.WindowsIdentity&gt;</ph> instance into the SCT, the <ph id=\"ph2\">&lt;xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A&gt;</ph> property returns an anonymous identity.","pos":[6086,6312],"source":" Because it is impossible to serialize the <xref:System.Security.Principal.WindowsIdentity> instance into the SCT, the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property returns an anonymous identity."},{"content":"The following configuration exhibits this behavior.","pos":[6319,6370]},{"pos":[6687,6695],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6699,6793],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>customBinding&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)</ept>","source":"[\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)"}]}