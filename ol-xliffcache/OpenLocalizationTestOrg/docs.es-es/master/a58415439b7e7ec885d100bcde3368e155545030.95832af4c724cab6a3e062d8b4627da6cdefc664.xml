{"content":"---\ntitle: \"Context Exchange Protocol | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 3dfd38e0-ae52-491c-94f4-7a862b9843d4\ncaps.latest.revision: 6\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Context Exchange Protocol\nThis section describes the context exchange protocol introduced in [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)][!INCLUDE[netfx35_long](../../../../includes/netfx35-long-md.md)] release. This protocol allows the client channel to accept a context supplied by a service and apply it to all subsequent requests to that service sent over the same client channel instance. The implementation of the context exchange protocol can use one of the following two mechanisms to propagate the context between the server and the client: HTTP cookies or a SOAP header.  \n  \n The context exchange protocol is implemented in a custom channel layer. The channel communicates the context to and from the application layer using a <xref:System.ServiceModel.Channels.ContextMessageProperty> property. For transmission between endpoints, the value of the context is either serialized as a SOAP header at the channel layer, or converted to or from the message properties that represent a HTTP request and response. In the latter case, it is expected that one of the underlying channel layers converts the HTTP request and response message properties to and from HTTP cookies, respectively. The choice of the mechanism used to exchange the context is done using the <xref:System.ServiceModel.Channels.ContextExchangeMechanism> property on the <xref:System.ServiceModel.Channels.ContextBindingElement>. Valid values are `HttpCookie` or `SoapHeader`.  \n  \n On the client, an instance of a channel can operate in two modes based on the settings on the channel property, <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>.  \n  \n## Mode 1: Channel Context Management  \n This is the default mode where <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `true`. In this mode the context channel manages the context and caches the context during its lifetime. Context can be retrieved from the channel through channel property `IContextManager` by calling the `GetContext` method. The channel can also be pre-initialized with specific context before being opened by calling the `SetContext` method on the channel property. Once the channel is initialized with context it cannot be reset.  \n  \n The following is a list of invariants in this mode:  \n  \n-   Any attempt to reset the context using `SetContext` after the channel has been opened throws an <xref:System.InvalidOperationException>.  \n  \n-   Any attempt to send context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty> in an outgoing message throws an <xref:System.InvalidOperationException>.  \n  \n-   If a message is received from server with a specific context, when the channel has already been initialized with a specific context, this results in a <xref:System.ServiceModel.ProtocolException>.  \n  \n    > [!NOTE]\n    >  It is appropriate to receive an initial context from the server only if the channel is opened without any context set explicitly.  \n  \n-   The <xref:System.ServiceModel.Channels.ContextMessageProperty> on incoming message is always null.  \n  \n## Mode 2: Application Context Management  \n This is the mode when <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `false`. In this mode the context channel does not manage context. It is the application's responsibility to retrieve, manage and apply context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty>. Any attempt to call `GetContext` or `SetContext` results in an <xref:System.InvalidOperationException>.  \n  \n No matter which mode is chosen the client channel factory supports <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel>, and <xref:System.ServiceModel.Channels.IDuplexSessionChannel> message exchange patterns.  \n  \n On the service, an instance of the channel is responsible for converting the context supplied by the client on incoming messages to the <xref:System.ServiceModel.Channels.ContextMessageProperty>. The message property can then be accessed by the application layer or other channels further up in the call stack. The service channels also allow the application layer to specify a new context value to be propagated back to the client by attaching a <xref:System.ServiceModel.Channels.ContextMessageProperty> to the response message. This property is converted to the SOAP header or HTTP cookie that contains the context, which depends on the configuration of the binding. The service channel listener supports <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel>, and <xref:System.ServiceModel.Channels.IReplySessionChannel> message exchange patterns.  \n  \n The context exchange protocol introduces a new `wsc:Context` SOAP header to represent the context information when HTTP cookies are not used to propagate the context. The context header schema allows for any number of child elements, each with a string key and string content. The following is an example of a context header.  \n  \n `<Context xmlns=\"http://schemas.microsoft.com/ws/2006/05/context\">`  \n  \n `<property name=\"myContext\">context-2</property>`  \n  \n `</Context>`  \n  \n When in `HttpCookie` mode, cookies are set using the `SetCookie` header. The cookie name is `WscContext`. The value of the cookie is the Base64 encoding of the `wsc:Context` header. This value is enclosed in quotes.  \n  \n The value of the context must be protected from modification while in transit for the same reason WS-Addressing headers are protected – the header is used to determine where to dispatch the request to on the service. The `wsc:Context` header is therefore required to be digitally signed or signed and encrypted at either the SOAP or transport level when the binding offers message protection capability. When HTTP cookies are used to propagate context, they should be protected using transport security.  \n  \n Service endpoints that require support for the context exchange protocol can make it explicit in the published policy. Two new policy assertions have been introduced to represent the requirement for the client to support the context exchange protocol at the SOAP level or to enable HTTP cookie support. Generation of these assertions into the policy on the service is controlled by the value of the <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> property as follows:  \n  \n-   For <xref:System.ServiceModel.Channels.ContextExchangeMechanism>, the following assertion is generated:  \n  \n    ```  \n    <IncludeContext   \n    xmlns=\"http://schemas.microsoft.com/ws/2006/05/context\"  \n    protectionLevel=\"Sign\" />  \n    ```  \n  \n-   For <xref:System.ServiceModel.Channels.ContextExchangeMechanism>, the following assertion is generated:  \n  \n    ```  \n    <HttpUseCookie xmlns=\"http://schemas.xmlsoap.org/soap/http\"/>  \n    ```  \n  \n## See Also  \n [Web Services Protocols Interoperability Guide](../../../../docs/framework/wcf/feature-details/web-services-protocols-interoperability-guide.md)","nodes":[{"pos":[12,54],"content":"Context Exchange Protocol | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Context Exchange Protocol | Microsoft Docs","pos":[0,42]}]},{"pos":[352,377],"content":"Context Exchange Protocol","linkify":"Context Exchange Protocol","nodes":[{"content":"Context Exchange Protocol","pos":[0,25]}]},{"content":"This section describes the context exchange protocol introduced in <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph><ph id=\"ph2\">[!INCLUDE[netfx35_long](../../../../includes/netfx35-long-md.md)]</ph> release.","pos":[378,574],"source":"This section describes the context exchange protocol introduced in [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)][!INCLUDE[netfx35_long](../../../../includes/netfx35-long-md.md)] release."},{"content":"This protocol allows the client channel to accept a context supplied by a service and apply it to all subsequent requests to that service sent over the same client channel instance.","pos":[575,756]},{"content":"The implementation of the context exchange protocol can use one of the following two mechanisms to propagate the context between the server and the client: HTTP cookies or a SOAP header.","pos":[757,943]},{"content":"The context exchange protocol is implemented in a custom channel layer.","pos":[950,1021]},{"content":"The channel communicates the context to and from the application layer using a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextMessageProperty&gt;</ph> property.","pos":[1022,1169],"source":" The channel communicates the context to and from the application layer using a <xref:System.ServiceModel.Channels.ContextMessageProperty> property."},{"content":"For transmission between endpoints, the value of the context is either serialized as a SOAP header at the channel layer, or converted to or from the message properties that represent a HTTP request and response.","pos":[1170,1381]},{"content":"In the latter case, it is expected that one of the underlying channel layers converts the HTTP request and response message properties to and from HTTP cookies, respectively.","pos":[1382,1556]},{"content":"The choice of the mechanism used to exchange the context is done using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextExchangeMechanism&gt;</ph> property on the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.ContextBindingElement&gt;</ph>.","pos":[1557,1767],"source":" The choice of the mechanism used to exchange the context is done using the <xref:System.ServiceModel.Channels.ContextExchangeMechanism> property on the <xref:System.ServiceModel.Channels.ContextBindingElement>."},{"content":"Valid values are <ph id=\"ph1\">`HttpCookie`</ph> or <ph id=\"ph2\">`SoapHeader`</ph>.","pos":[1768,1814],"source":" Valid values are `HttpCookie` or `SoapHeader`."},{"content":"On the client, an instance of a channel can operate in two modes based on the settings on the channel property, <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IContextManager.Enabled%2A&gt;</ph>.","pos":[1821,1996],"source":"On the client, an instance of a channel can operate in two modes based on the settings on the channel property, <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>."},{"pos":[2005,2039],"content":"Mode 1: Channel Context Management","linkify":"Mode 1: Channel Context Management","nodes":[{"content":"Mode 1: Channel Context Management","pos":[0,34]}]},{"content":"This is the default mode where <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IContextManager.Enabled%2A&gt;</ph> is set to <ph id=\"ph2\">`true`</ph>.","pos":[2043,2154],"source":"This is the default mode where <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `true`."},{"content":"In this mode the context channel manages the context and caches the context during its lifetime.","pos":[2155,2251]},{"content":"Context can be retrieved from the channel through channel property <ph id=\"ph1\">`IContextManager`</ph> by calling the <ph id=\"ph2\">`GetContext`</ph> method.","pos":[2252,2372],"source":" Context can be retrieved from the channel through channel property `IContextManager` by calling the `GetContext` method."},{"content":"The channel can also be pre-initialized with specific context before being opened by calling the <ph id=\"ph1\">`SetContext`</ph> method on the channel property.","pos":[2373,2514],"source":" The channel can also be pre-initialized with specific context before being opened by calling the `SetContext` method on the channel property."},{"content":"Once the channel is initialized with context it cannot be reset.","pos":[2515,2579]},{"content":"The following is a list of invariants in this mode:","pos":[2586,2637]},{"pos":[2647,2783],"content":"Any attempt to reset the context using <ph id=\"ph1\">`SetContext`</ph> after the channel has been opened throws an <ph id=\"ph2\">&lt;xref:System.InvalidOperationException&gt;</ph>.","source":"Any attempt to reset the context using `SetContext` after the channel has been opened throws an <xref:System.InvalidOperationException>."},{"content":"Any attempt to send context by using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextMessageProperty&gt;</ph> in an outgoing message throws an <ph id=\"ph2\">&lt;xref:System.InvalidOperationException&gt;</ph>.","pos":[2793,2966],"source":"Any attempt to send context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty> in an outgoing message throws an <xref:System.InvalidOperationException>."},{"content":"If a message is received from server with a specific context, when the channel has already been initialized with a specific context, this results in a <ph id=\"ph1\">&lt;xref:System.ServiceModel.ProtocolException&gt;</ph>.","pos":[2976,3172],"source":"If a message is received from server with a specific context, when the channel has already been initialized with a specific context, this results in a <xref:System.ServiceModel.ProtocolException>."},{"pos":[3184,3328],"content":"[!NOTE]\nIt is appropriate to receive an initial context from the server only if the channel is opened without any context set explicitly.","leadings":["","    >  "],"nodes":[{"content":"It is appropriate to receive an initial context from the server only if the channel is opened without any context set explicitly.","pos":[8,137]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextMessageProperty&gt;</ph> on incoming message is always null.","pos":[3338,3436],"source":"The <xref:System.ServiceModel.Channels.ContextMessageProperty> on incoming message is always null."},{"pos":[3445,3483],"content":"Mode 2: Application Context Management","linkify":"Mode 2: Application Context Management","nodes":[{"content":"Mode 2: Application Context Management","pos":[0,38]}]},{"content":"This is the mode when <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IContextManager.Enabled%2A&gt;</ph> is set to <ph id=\"ph2\">`false`</ph>.","pos":[3487,3590],"source":"This is the mode when <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `false`."},{"content":"In this mode the context channel does not manage context.","pos":[3591,3648]},{"content":"It is the application's responsibility to retrieve, manage and apply context by using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextMessageProperty&gt;</ph>.","pos":[3649,3798],"source":" It is the application's responsibility to retrieve, manage and apply context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty>."},{"content":"Any attempt to call <ph id=\"ph1\">`GetContext`</ph> or <ph id=\"ph2\">`SetContext`</ph> results in an <ph id=\"ph3\">&lt;xref:System.InvalidOperationException&gt;</ph>.","pos":[3799,3902],"source":" Any attempt to call `GetContext` or `SetContext` results in an <xref:System.InvalidOperationException>."},{"content":"No matter which mode is chosen the client channel factory supports <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IRequestChannel&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.IRequestSessionChannel&gt;</ph>, and <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.IDuplexSessionChannel&gt;</ph> message exchange patterns.","pos":[3909,4177],"source":"No matter which mode is chosen the client channel factory supports <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel>, and <xref:System.ServiceModel.Channels.IDuplexSessionChannel> message exchange patterns."},{"content":"On the service, an instance of the channel is responsible for converting the context supplied by the client on incoming messages to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextMessageProperty&gt;</ph>.","pos":[4184,4379],"source":"On the service, an instance of the channel is responsible for converting the context supplied by the client on incoming messages to the <xref:System.ServiceModel.Channels.ContextMessageProperty>."},{"content":"The message property can then be accessed by the application layer or other channels further up in the call stack.","pos":[4380,4494]},{"content":"The service channels also allow the application layer to specify a new context value to be propagated back to the client by attaching a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextMessageProperty&gt;</ph> to the response message.","pos":[4495,4714],"source":" The service channels also allow the application layer to specify a new context value to be propagated back to the client by attaching a <xref:System.ServiceModel.Channels.ContextMessageProperty> to the response message."},{"content":"This property is converted to the SOAP header or HTTP cookie that contains the context, which depends on the configuration of the binding.","pos":[4715,4853]},{"content":"The service channel listener supports <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.IReplyChannel&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.IReplySessionChannel&gt;</ph>, and <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.IReplySessionChannel&gt;</ph> message exchange patterns.","pos":[4854,5088],"source":" The service channel listener supports <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel>, and <xref:System.ServiceModel.Channels.IReplySessionChannel> message exchange patterns."},{"content":"The context exchange protocol introduces a new <ph id=\"ph1\">`wsc:Context`</ph> SOAP header to represent the context information when HTTP cookies are not used to propagate the context.","pos":[5095,5261],"source":"The context exchange protocol introduces a new `wsc:Context` SOAP header to represent the context information when HTTP cookies are not used to propagate the context."},{"content":"The context header schema allows for any number of child elements, each with a string key and string content.","pos":[5262,5371]},{"content":"The following is an example of a context header.","pos":[5372,5420]},{"content":"When in <ph id=\"ph1\">`HttpCookie`</ph> mode, cookies are set using the <ph id=\"ph2\">`SetCookie`</ph> header.","pos":[5576,5648],"source":"When in `HttpCookie` mode, cookies are set using the `SetCookie` header."},{"content":"The cookie name is <ph id=\"ph1\">`WscContext`</ph>.","pos":[5649,5681],"source":" The cookie name is `WscContext`."},{"content":"The value of the cookie is the Base64 encoding of the <ph id=\"ph1\">`wsc:Context`</ph> header.","pos":[5682,5757],"source":" The value of the cookie is the Base64 encoding of the `wsc:Context` header."},{"content":"This value is enclosed in quotes.","pos":[5758,5791]},{"content":"The value of the context must be protected from modification while in transit for the same reason WS-Addressing headers are protected – the header is used to determine where to dispatch the request to on the service.","pos":[5798,6014]},{"content":"The <ph id=\"ph1\">`wsc:Context`</ph> header is therefore required to be digitally signed or signed and encrypted at either the SOAP or transport level when the binding offers message protection capability.","pos":[6015,6201],"source":" The `wsc:Context` header is therefore required to be digitally signed or signed and encrypted at either the SOAP or transport level when the binding offers message protection capability."},{"content":"When HTTP cookies are used to propagate context, they should be protected using transport security.","pos":[6202,6301]},{"content":"Service endpoints that require support for the context exchange protocol can make it explicit in the published policy.","pos":[6308,6426]},{"content":"Two new policy assertions have been introduced to represent the requirement for the client to support the context exchange protocol at the SOAP level or to enable HTTP cookie support.","pos":[6427,6610]},{"content":"Generation of these assertions into the policy on the service is controlled by the value of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A&gt;</ph> property as follows:","pos":[6611,6813],"source":" Generation of these assertions into the policy on the service is controlled by the value of the <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> property as follows:"},{"content":"For <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextExchangeMechanism&gt;</ph>, the following assertion is generated:","pos":[6823,6926],"source":"For <xref:System.ServiceModel.Channels.ContextExchangeMechanism>, the following assertion is generated:"},{"content":"For <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.ContextExchangeMechanism&gt;</ph>, the following assertion is generated:","pos":[7076,7179],"source":"For <xref:System.ServiceModel.Channels.ContextExchangeMechanism>, the following assertion is generated:"},{"pos":[7279,7287],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[7291,7435],"content":"<bpt id=\"p1\">[</bpt>Web Services Protocols Interoperability Guide<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/web-services-protocols-interoperability-guide.md)</ept>","source":"[Web Services Protocols Interoperability Guide](../../../../docs/framework/wcf/feature-details/web-services-protocols-interoperability-guide.md)"}]}