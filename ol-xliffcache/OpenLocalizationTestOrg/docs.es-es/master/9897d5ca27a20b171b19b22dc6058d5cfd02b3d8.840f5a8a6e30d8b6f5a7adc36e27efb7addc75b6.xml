{"content":"---\ntitle: \"How to: Lock Down Endpoints in the Enterprise | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 1b7eaab7-da60-4cf7-9d6a-ec02709cf75d\ncaps.latest.revision: 21\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# How to: Lock Down Endpoints in the Enterprise\nLarge enterprises often require that applications are developed in compliance with enterprise security policies. The following topic discusses how to develop and install a client endpoint validator that can be used to validate all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] client applications installed on computers.  \n  \n In this case, the validator is a client validator because this endpoint behavior is added to the client [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section in the machine.config file. [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] loads common endpoint behaviors only for client applications and loads common service behaviors only for service applications. To install this same validator for service applications, the validator must be a service behavior. [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section.  \n  \n> [!IMPORTANT]\n>  Service or endpoint behaviors not marked with the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute (APTCA) that are added to the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section of a configuration file are not run when the application runs in a partial trust environment, and no exception is thrown when this occurs. To enforce the running of common behaviors such as validators, you must either:  \n>   \n>  -- Mark your common behavior with the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute so that it can run when deployed as a Partial Trust application. Note that a registry entry can be set on the computer to prevent APTCA-marked assemblies from running..  \n>   \n>  -- Ensure that if the application is deployed as a fully-trusted application that users cannot modify the code-access security settings to run the application in a Partial Trust environment. If they can do so, the custom validator does not run and no exception is thrown. For one way to ensure this, see the `levelfinal` option using [Code Access Security Policy Tool (Caspol.exe)](http://go.microsoft.com/fwlink/?LinkId=248222).  \n>   \n>  For more information, see [Partial Trust Best Practices](../../../../docs/framework/wcf/feature-details/partial-trust-best-practices.md) and [Supported Deployment Scenarios](../../../../docs/framework/wcf/feature-details/supported-deployment-scenarios.md).  \n  \n### To create the endpoint validator  \n  \n1.  Create an <xref:System.ServiceModel.Description.IEndpointBehavior> with the desired validation steps in the <xref:System.ServiceModel.Description.IEndpointBehavior.Validate%2A> method. The following code provides an example. (The `InternetClientValidatorBehavior` is taken from the [Security Validation](../../../../docs/framework/wcf/samples/security-validation.md) sample.)  \n  \n     [!code-csharp[LockdownValidation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/internetclientvalidatorbehavior.cs#2)]  \n  \n2.  Create new <xref:System.ServiceModel.Configuration.BehaviorExtensionElement> that registers the endpoint validator created in step 1. The following code example shows this. (The original code for this example is in the [Security Validation](../../../../docs/framework/wcf/samples/security-validation.md) sample.)  \n  \n     [!code-csharp[LockdownValidation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/internetclientvalidatorelement.cs#3)]  \n  \n3.  Make sure the compiled assembly is signed with a strong name. For details, see the [Strong Name Tool (SN.EXE)](http://go.microsoft.com/fwlink/?LinkId=248217) and the compiler commands for your language.  \n  \n### To install the validator into the target computer  \n  \n1.  Install the endpoint validator using the appropriate mechanism. In an enterprise, this can be using Group Policy and Systems Management Server (SMS).  \n  \n2.  Install the strongly-named assembly into the global assembly cache using the [Gacutil.exe (Global Assembly Cache Tool)](http://msdn.microsoft.com/library/ex0ss12c\\(v=vs.110\\).aspx).  \n  \n3.  Use the <xref:System.Configuration?displayProperty=fullName> namespace types to:  \n  \n    1.  Add the extension to the [\\<behaviorExtensions>](../../../../docs/framework/configure-apps/file-schema/wcf/behaviorextensions.md) section using a fully-qualified type name and lock the element.  \n  \n         [!code-csharp[LockdownValidation#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#5)]  \n  \n    2.  Add the behavior element to the `EndpointBehaviors` property of the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section and lock the element. (To install the validator on the service, the validator must be an <xref:System.ServiceModel.Description.IServiceBehavior> and added to the `ServiceBehaviors` property.) The following code example shows the proper configuration after steps a. and b., with the sole exception that there is no strong name.  \n  \n         [!code-csharp[LockdownValidation#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#6)]  \n  \n    3.  Save the machine.config file. The following code example performs all the tasks in step 3 but saves a copy of the modified machine.config file locally.  \n  \n         [!code-csharp[LockdownValidation#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#7)]  \n  \n## Example  \n The following code example shows how to add a common behavior to the machine.config file and save a copy to the disk. The `InternetClientValidatorBehavior` is taken from the [Security Validation](../../../../docs/framework/wcf/samples/security-validation.md) sample.  \n  \n [!code-csharp[LockdownValidation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#1)]  \n  \n## .NET Framework Security  \n You may also want to encrypt the configuration file elements. For more information, see the See Also section.  \n  \n## See Also  \n [Encrypting configuration file elements using DPAPI](http://go.microsoft.com/fwlink/?LinkId=94954)   \n [Encrypting configuration file elements using RSA](http://go.microsoft.com/fwlink/?LinkId=94955)","nodes":[{"pos":[12,74],"content":"How to: Lock Down Endpoints in the Enterprise | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"How to: Lock Down Endpoints in the Enterprise | Microsoft Docs","pos":[0,62]}]},{"pos":[373,418],"content":"How to: Lock Down Endpoints in the Enterprise","linkify":"How to: Lock Down Endpoints in the Enterprise","nodes":[{"content":"How to: Lock Down Endpoints in the Enterprise","pos":[0,45]}]},{"content":"Large enterprises often require that applications are developed in compliance with enterprise security policies.","pos":[419,531]},{"content":"The following topic discusses how to develop and install a client endpoint validator that can be used to validate all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> client applications installed on computers.","pos":[532,749],"source":" The following topic discusses how to develop and install a client endpoint validator that can be used to validate all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] client applications installed on computers."},{"content":"In this case, the validator is a client validator because this endpoint behavior is added to the client <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>commonBehaviors&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md)</ept> section in the machine.config file.","pos":[756,994],"source":"In this case, the validator is a client validator because this endpoint behavior is added to the client [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section in the machine.config file."},{"content":"<ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> loads common endpoint behaviors only for client applications and loads common service behaviors only for service applications.","pos":[995,1177],"source":"[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] loads common endpoint behaviors only for client applications and loads common service behaviors only for service applications."},{"content":"To install this same validator for service applications, the validator must be a service behavior.","pos":[1178,1276]},{"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)]</ph> the <bpt id=\"p1\">[</bpt><ph id=\"ph2\">\\&lt;</ph>commonBehaviors&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md)</ept> section.","pos":[1277,1448],"source":"[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section."},{"pos":[1456,1948],"content":"[!IMPORTANT]\n Service or endpoint behaviors not marked with the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute (APTCA) that are added to the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section of a configuration file are not run when the application runs in a partial trust environment, and no exception is thrown when this occurs. To enforce the running of common behaviors such as validators, you must either:","leadings":["","> "],"nodes":[{"content":" Service or endpoint behaviors not marked with the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute (APTCA) that are added to the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section of a configuration file are not run when the application runs in a partial trust environment, and no exception is thrown when this occurs. To enforce the running of common behaviors such as validators, you must either:","pos":[13,490],"nodes":[{"content":"Service or endpoint behaviors not marked with the <ph id=\"ph1\">&lt;xref:System.Security.AllowPartiallyTrustedCallersAttribute&gt;</ph> attribute (APTCA) that are added to the <bpt id=\"p1\">[</bpt><ph id=\"ph2\">\\&lt;</ph>commonBehaviors&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md)</ept> section of a configuration file are not run when the application runs in a partial trust environment, and no exception is thrown when this occurs.","pos":[1,397],"source":" Service or endpoint behaviors not marked with the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute (APTCA) that are added to the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section of a configuration file are not run when the application runs in a partial trust environment, and no exception is thrown when this occurs."},{"content":"To enforce the running of common behaviors such as validators, you must either:","pos":[398,477]}]}]},{"content":"-- Mark your common behavior with the <ph id=\"ph1\">&lt;xref:System.Security.AllowPartiallyTrustedCallersAttribute&gt;</ph> attribute so that it can run when deployed as a Partial Trust application.","pos":[1959,2132],"source":"-- Mark your common behavior with the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute so that it can run when deployed as a Partial Trust application."},{"content":"Note that a registry entry can be set on the computer to prevent APTCA-marked assemblies from running..","pos":[2133,2236]},{"content":"-- Ensure that if the application is deployed as a fully-trusted application that users cannot modify the code-access security settings to run the application in a Partial Trust environment.","pos":[2247,2437]},{"content":"If they can do so, the custom validator does not run and no exception is thrown.","pos":[2438,2518]},{"content":"For one way to ensure this, see the <ph id=\"ph1\">`levelfinal`</ph> option using <bpt id=\"p1\">[</bpt>Code Access Security Policy Tool (Caspol.exe)<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=248222)</ept>.","pos":[2519,2676],"source":" For one way to ensure this, see the `levelfinal` option using [Code Access Security Policy Tool (Caspol.exe)](http://go.microsoft.com/fwlink/?LinkId=248222)."},{"pos":[2687,2943],"content":"For more information, see <bpt id=\"p1\">[</bpt>Partial Trust Best Practices<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/partial-trust-best-practices.md)</ept> and <bpt id=\"p2\">[</bpt>Supported Deployment Scenarios<ept id=\"p2\">](../../../../docs/framework/wcf/feature-details/supported-deployment-scenarios.md)</ept>.","source":"For more information, see [Partial Trust Best Practices](../../../../docs/framework/wcf/feature-details/partial-trust-best-practices.md) and [Supported Deployment Scenarios](../../../../docs/framework/wcf/feature-details/supported-deployment-scenarios.md)."},{"pos":[2953,2985],"content":"To create the endpoint validator","linkify":"To create the endpoint validator","nodes":[{"content":"To create the endpoint validator","pos":[0,32]}]},{"content":"Create an <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.IEndpointBehavior&gt;</ph> with the desired validation steps in the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.IEndpointBehavior.Validate%2A&gt;</ph> method.","pos":[2995,3179],"source":"Create an <xref:System.ServiceModel.Description.IEndpointBehavior> with the desired validation steps in the <xref:System.ServiceModel.Description.IEndpointBehavior.Validate%2A> method."},{"content":"The following code provides an example.","pos":[3180,3219]},{"content":"(The <ph id=\"ph1\">`InternetClientValidatorBehavior`</ph> is taken from the <bpt id=\"p1\">[</bpt>Security Validation<ept id=\"p1\">](../../../../docs/framework/wcf/samples/security-validation.md)</ept> sample.)","pos":[3220,3370],"source":" (The `InternetClientValidatorBehavior` is taken from the [Security Validation](../../../../docs/framework/wcf/samples/security-validation.md) sample.)"},{"pos":[3381,3529],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>LockdownValidation#2<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/internetclientvalidatorbehavior.cs#2)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[LockdownValidation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/internetclientvalidatorbehavior.cs#2)]"},{"content":"Create new <ph id=\"ph1\">&lt;xref:System.ServiceModel.Configuration.BehaviorExtensionElement&gt;</ph> that registers the endpoint validator created in step 1.","pos":[3539,3672],"source":"Create new <xref:System.ServiceModel.Configuration.BehaviorExtensionElement> that registers the endpoint validator created in step 1."},{"content":"The following code example shows this.","pos":[3673,3711]},{"content":"(The original code for this example is in the <bpt id=\"p1\">[</bpt>Security Validation<ept id=\"p1\">](../../../../docs/framework/wcf/samples/security-validation.md)</ept> sample.)","pos":[3712,3851],"source":" (The original code for this example is in the [Security Validation](../../../../docs/framework/wcf/samples/security-validation.md) sample.)"},{"pos":[3862,4009],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>LockdownValidation#3<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/internetclientvalidatorelement.cs#3)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[LockdownValidation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/internetclientvalidatorelement.cs#3)]"},{"content":"Make sure the compiled assembly is signed with a strong name.","pos":[4019,4080]},{"content":"For details, see the <bpt id=\"p1\">[</bpt>Strong Name Tool (SN.EXE)<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=248217)</ept> and the compiler commands for your language.","pos":[4081,4221],"source":" For details, see the [Strong Name Tool (SN.EXE)](http://go.microsoft.com/fwlink/?LinkId=248217) and the compiler commands for your language."},{"pos":[4231,4280],"content":"To install the validator into the target computer","linkify":"To install the validator into the target computer","nodes":[{"content":"To install the validator into the target computer","pos":[0,49]}]},{"content":"Install the endpoint validator using the appropriate mechanism.","pos":[4290,4353]},{"content":"In an enterprise, this can be using Group Policy and Systems Management Server (SMS).","pos":[4354,4439]},{"pos":[4449,4630],"content":"Install the strongly-named assembly into the global assembly cache using the <bpt id=\"p1\">[</bpt>Gacutil.exe (Global Assembly Cache Tool)<ept id=\"p1\">](http://msdn.microsoft.com/library/ex0ss12c\\(v=vs.110\\).aspx)</ept>.","source":"Install the strongly-named assembly into the global assembly cache using the [Gacutil.exe (Global Assembly Cache Tool)](http://msdn.microsoft.com/library/ex0ss12c\\(v=vs.110\\).aspx)."},{"content":"Use the <ph id=\"ph1\">&lt;xref:System.Configuration?displayProperty=fullName&gt;</ph> namespace types to:","pos":[4640,4720],"source":"Use the <xref:System.Configuration?displayProperty=fullName> namespace types to:"},{"pos":[4734,4927],"content":"Add the extension to the <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>behaviorExtensions&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/behaviorextensions.md)</ept> section using a fully-qualified type name and lock the element.","source":"Add the extension to the [\\<behaviorExtensions>](../../../../docs/framework/configure-apps/file-schema/wcf/behaviorextensions.md) section using a fully-qualified type name and lock the element."},{"pos":[4942,5074],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>LockdownValidation#5<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#5)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[LockdownValidation#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#5)]"},{"content":"Add the behavior element to the <ph id=\"ph1\">`EndpointBehaviors`</ph> property of the <bpt id=\"p1\">[</bpt><ph id=\"ph2\">\\&lt;</ph>commonBehaviors&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md)</ept> section and lock the element.","pos":[5088,5284],"source":"Add the behavior element to the `EndpointBehaviors` property of the [\\<commonBehaviors>](../../../../docs/framework/configure-apps/file-schema/wcf/commonbehaviors.md) section and lock the element."},{"content":"(To install the validator on the service, the validator must be an <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.IServiceBehavior&gt;</ph> and added to the <ph id=\"ph2\">`ServiceBehaviors`</ph> property.) The following code example shows the proper configuration after steps a.","pos":[5285,5527],"source":" (To install the validator on the service, the validator must be an <xref:System.ServiceModel.Description.IServiceBehavior> and added to the `ServiceBehaviors` property.) The following code example shows the proper configuration after steps a."},{"content":"and b., with the sole exception that there is no strong name.","pos":[5528,5589]},{"pos":[5604,5736],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>LockdownValidation#6<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#6)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[LockdownValidation#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#6)]"},{"content":"Save the machine.config file.","pos":[5750,5779]},{"content":"The following code example performs all the tasks in step 3 but saves a copy of the modified machine.config file locally.","pos":[5780,5901]},{"pos":[5916,6048],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>LockdownValidation#7<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#7)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[LockdownValidation#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#7)]"},{"pos":[6057,6064],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following code example shows how to add a common behavior to the machine.config file and save a copy to the disk.","pos":[6068,6185]},{"content":"The <ph id=\"ph1\">`InternetClientValidatorBehavior`</ph> is taken from the <bpt id=\"p1\">[</bpt>Security Validation<ept id=\"p1\">](../../../../docs/framework/wcf/samples/security-validation.md)</ept> sample.","pos":[6186,6334],"source":" The `InternetClientValidatorBehavior` is taken from the [Security Validation](../../../../docs/framework/wcf/samples/security-validation.md) sample."},{"pos":[6341,6473],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>LockdownValidation#1<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#1)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[LockdownValidation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/lockdownvalidation/cs/hostapplication.cs#1)]"},{"pos":[6482,6505],"content":".NET Framework Security","linkify":".NET Framework Security","nodes":[{"content":".NET Framework Security","pos":[0,23]}]},{"content":"You may also want to encrypt the configuration file elements.","pos":[6509,6570]},{"content":"For more information, see the See Also section.","pos":[6571,6618]},{"pos":[6627,6635],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Encrypting configuration file elements using DPAPI<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=94954)</ept><ph id=\"ph1\"> </ph>","pos":[6639,6738],"source":"[Encrypting configuration file elements using DPAPI](http://go.microsoft.com/fwlink/?LinkId=94954) "},{"content":"<bpt id=\"p1\"> [</bpt>Encrypting configuration file elements using RSA<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=94955)</ept>","pos":[6741,6838],"source":" [Encrypting configuration file elements using RSA](http://go.microsoft.com/fwlink/?LinkId=94955)"}]}