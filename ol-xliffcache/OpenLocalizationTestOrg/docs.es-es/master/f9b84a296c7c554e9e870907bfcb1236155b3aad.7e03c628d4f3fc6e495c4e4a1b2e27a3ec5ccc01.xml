{"content":"---\ntitle: \"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"Task Parallel Library, dataflows\"\n  - \"TPL dataflow library, improving efficiency\"\nms.assetid: 5beb4983-80c2-4f60-8c51-a07f9fd94cb3\ncaps.latest.revision: 8\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"\n---\n# Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency\nThe TPL Dataflow Library provides the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601?displayProperty=fullName> and <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602?displayProperty=fullName> classes so that you can receive and buffer data from one or more sources and then propagate out that buffered data as one collection. This batching mechanism is useful when you collect data from one or more sources and then process multiple data elements as a batch. For example, consider an application that uses dataflow to insert records into a database. This operation can be more efficient if multiple items are inserted at the same time instead of one at a time sequentially. This document describes how to use the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class to improve the efficiency of such database insert operations. It also describes how to use the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> class to capture both the results and any exceptions that occur when the program reads from a database.  \n  \n> [!TIP]\n>  The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.  \n  \n## Prerequisites  \n  \n1.  Read the Join Blocks section in the [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md) document before you start this walkthrough.  \n  \n2.  Ensure that you have a copy of the Northwind database, Northwind.sdf, available on your computer. This file is typically located in the folder %Program Files%\\Microsoft SQL Server Compact Edition\\v3.5\\Samples\\\\.  \n  \n    > [!IMPORTANT]\n    >  In some versions of Windows, you cannot connect to Northwind.sdf if [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] is running in a non-administrator mode. To connect to Northwind.sdf, start [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] or a [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] command prompt in the **Run as administrator** mode.  \n  \n This walkthrough contains the following sections:  \n  \n-   [Creating the Console Application](#creating)  \n  \n-   [Defining the Employee Class](#employeeClass)  \n  \n-   [Defining Employee Database Operations](#operations)  \n  \n-   [Adding Employee Data to the Database without Using Buffering](#nonBuffering)  \n  \n-   [Using Buffering to Add Employee Data to the Database](#buffering)  \n  \n-   [Using Buffered Join to Read Employee Data from the Database](#bufferedJoin)  \n  \n-   [The Complete Example](#complete)  \n  \n<a name=\"creating\"></a>   \n## Creating the Console Application  \n  \n<a name=\"consoleApp\"></a>   \n1.  In [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)], create a Visual C# or Visual Basic **Console Application** project. In this document, the project is named `DataflowBatchDatabase`.  \n  \n2.  In your project, add a reference to System.Data.SqlServerCe.dll and a reference to System.Threading.Tasks.Dataflow.dll.  \n  \n3.  Ensure that Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) contains the following `using` (`Imports` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) statements.  \n  \n     [!code-csharp[TPLDataflow_BatchDatabase#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#1)]\n     [!code-vb[TPLDataflow_BatchDatabase#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#1)]  \n  \n4.  Add the following data members to the `Program` class.  \n  \n     [!code-csharp[TPLDataflow_BatchDatabase#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#2)]\n     [!code-vb[TPLDataflow_BatchDatabase#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#2)]  \n  \n<a name=\"employeeClass\"></a>   \n## Defining the Employee Class  \n Add to the `Program` class the `Employee` class.  \n  \n [!code-csharp[TPLDataflow_BatchDatabase#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#3)]\n [!code-vb[TPLDataflow_BatchDatabase#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#3)]  \n  \n The `Employee` class contains three properties, `EmployeeID`, `LastName`, and `FirstName`. These properties correspond to the `Employee ID`, `Last Name`, and `First Name` columns in the `Employees` table in the Northwind database. For this demonstration, the `Employee` class also defines the `Random` method, which creates an `Employee` object that has random values for its properties.  \n  \n<a name=\"operations\"></a>   \n## Defining Employee Database Operations  \n Add to the `Program` class the `InsertEmployees`, `GetEmployeeCount`, and `GetEmployeeID` methods.  \n  \n [!code-csharp[TPLDataflow_BatchDatabase#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#4)]\n [!code-vb[TPLDataflow_BatchDatabase#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#4)]  \n  \n The `InsertEmployees` method adds new employee records to the database. The `GetEmployeeCount` method retrieves the number of entries in the `Employees` table. The `GetEmployeeID` method retrieves the identifier of the first employee that has the provided name. Each of these methods takes a connection string to the Northwind database and uses functionality in the `System.Data.SqlServerCe` namespace to communicate with the database.  \n  \n<a name=\"nonBuffering\"></a>   \n## Adding Employee Data to the Database Without Using Buffering  \n Add to the `Program` class the `AddEmployees` and `PostRandomEmployees` methods.  \n  \n [!code-csharp[TPLDataflow_BatchDatabase#5](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#5)]\n [!code-vb[TPLDataflow_BatchDatabase#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#5)]  \n  \n The `AddEmployees` method adds random employee data to the database by using dataflow. It creates an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object that calls the `InsertEmployees` method to add an employee entry to the database. The `AddEmployees` method then calls the `PostRandomEmployees` method to post multiple `Employee` objects to the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object. The `AddEmployees` method then waits for all insert operations to finish.  \n  \n<a name=\"buffering\"></a>   \n## Using Buffering to Add Employee Data to the Database  \n Add to the `Program` class the `AddEmployeesBatched` method.  \n  \n [!code-csharp[TPLDataflow_BatchDatabase#6](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#6)]\n [!code-vb[TPLDataflow_BatchDatabase#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#6)]  \n  \n This method resembles `AddEmployees`, except that it also uses the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class to buffer multiple `Employee` objects before it sends those objects to the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object. Because the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class propagates out multiple elements as a collection, the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object is modified to act on an array of `Employee` objects. As in the `AddEmployees` method, `AddEmployeesBatched` calls the `PostRandomEmployees` method to post multiple `Employee` objects; however, `AddEmployeesBatched` posts these objects to the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object. The `AddEmployeesBatched`  method also waits for all insert operations to finish.  \n  \n<a name=\"bufferedJoin\"></a>   \n## Using Buffered Join to Read Employee Data from the Database  \n Add to the `Program` class the `GetRandomEmployees` method.  \n  \n [!code-csharp[TPLDataflow_BatchDatabase#7](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#7)]\n [!code-vb[TPLDataflow_BatchDatabase#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#7)]  \n  \n This method prints information about random employees to the console. It creates several random `Employee` objects and calls the `GetEmployeeID` method to retrieve the unique identifier for each object. Because the `GetEmployeeID` method throws an exception if there is no matching employee with the given first and last names, the `GetRandomEmployees` method uses the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> class to store `Employee` objects for successful calls to `GetEmployeeID` and <xref:System.Exception?displayProperty=fullName> objects for calls that fail. The <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object in this example acts on a <xref:System.Tuple%602> object that holds a list of `Employee` objects and a list of <xref:System.Exception> objects. The <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> object propagates out this data when the sum of the received `Employee` and <xref:System.Exception> object counts equals the batch size.  \n  \n<a name=\"complete\"></a>   \n## The Complete Example  \n The following example shows the complete code. The `Main` method compares the time that is required to perform batched database insertions versus the time to perform non-batched database insertions. It also demonstrates the use of buffered join to read employee data from the database and also report errors.  \n  \n [!code-csharp[TPLDataflow_BatchDatabase#100](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#100)]\n [!code-vb[TPLDataflow_BatchDatabase#100](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#100)]  \n  \n## See Also  \n [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)","nodes":[{"pos":[4,495],"embed":true,"restype":"x-metadata","content":"title: \"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"Task Parallel Library, dataflows\"\n  - \"TPL dataflow library, improving efficiency\"\nms.assetid: 5beb4983-80c2-4f60-8c51-a07f9fd94cb3\ncaps.latest.revision: 8\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"","nodes":[{"content":"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency | Microsoft Docs","nodes":[{"pos":[0,89],"content":"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency | Microsoft Docs","nodes":[{"content":"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency | Microsoft Docs","pos":[0,89]}]}],"path":["title"]}],"yml":true},{"pos":[502,574],"content":"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency","linkify":"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency","nodes":[{"content":"Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency","pos":[0,72]}]},{"content":"The TPL Dataflow Library provides the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BatchBlock%601?displayProperty=fullName&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602?displayProperty=fullName&gt;</ph> classes so that you can receive and buffer data from one or more sources and then propagate out that buffered data as one collection.","pos":[575,914],"source":"The TPL Dataflow Library provides the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601?displayProperty=fullName> and <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602?displayProperty=fullName> classes so that you can receive and buffer data from one or more sources and then propagate out that buffered data as one collection."},{"content":"This batching mechanism is useful when you collect data from one or more sources and then process multiple data elements as a batch.","pos":[915,1047]},{"content":"For example, consider an application that uses dataflow to insert records into a database.","pos":[1048,1138]},{"content":"This operation can be more efficient if multiple items are inserted at the same time instead of one at a time sequentially.","pos":[1139,1262]},{"content":"This document describes how to use the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BatchBlock%601&gt;</ph> class to improve the efficiency of such database insert operations.","pos":[1263,1423],"source":" This document describes how to use the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class to improve the efficiency of such database insert operations."},{"content":"It also describes how to use the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602&gt;</ph> class to capture both the results and any exceptions that occur when the program reads from a database.","pos":[1424,1620],"source":" It also describes how to use the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> class to capture both the results and any exceptions that occur when the program reads from a database."},{"pos":[1628,2088],"content":"[!TIP]\n The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","leadings":["","> "],"nodes":[{"content":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","pos":[8,458],"nodes":[{"content":"The TPL Dataflow Library (<ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow?displayProperty=fullName&gt;</ph> namespace) is not distributed with the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>.","pos":[0,182],"source":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]."},{"content":"To install the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow&gt;</ph> namespace, open your project in <ph id=\"ph2\">[!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)]</ph>, choose <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> from the Project menu, and search online for the <ph id=\"ph3\">`Microsoft.Tpl.Dataflow`</ph> package.","pos":[183,450],"source":" To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package."}]}]},{"pos":[2097,2110],"content":"Prerequisites","linkify":"Prerequisites","nodes":[{"content":"Prerequisites","pos":[0,13]}]},{"pos":[2120,2289],"content":"Read the Join Blocks section in the <bpt id=\"p1\">[</bpt>Dataflow<ept id=\"p1\">](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)</ept> document before you start this walkthrough.","source":"Read the Join Blocks section in the [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md) document before you start this walkthrough."},{"content":"Ensure that you have a copy of the Northwind database, Northwind.sdf, available on your computer.","pos":[2299,2396]},{"content":"This file is typically located in the folder %Program Files%\\Microsoft SQL Server Compact Edition\\v3.5\\Samples<ph id=\"ph1\">\\\\</ph>.","pos":[2397,2510],"source":" This file is typically located in the folder %Program Files%\\Microsoft SQL Server Compact Edition\\v3.5\\Samples\\\\."},{"pos":[2522,2895],"content":"[!IMPORTANT]\nIn some versions of Windows, you cannot connect to Northwind.sdf if [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] is running in a non-administrator mode. To connect to Northwind.sdf, start [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] or a [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] command prompt in the **Run as administrator** mode.","leadings":["","    >  "],"nodes":[{"content":"In some versions of Windows, you cannot connect to Northwind.sdf if [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] is running in a non-administrator mode. To connect to Northwind.sdf, start [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] or a [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] command prompt in the **Run as administrator** mode.","pos":[13,366],"nodes":[{"content":"In some versions of Windows, you cannot connect to Northwind.sdf if <ph id=\"ph1\">[!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)]</ph> is running in a non-administrator mode.","pos":[0,158],"source":"In some versions of Windows, you cannot connect to Northwind.sdf if [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] is running in a non-administrator mode."},{"content":"To connect to Northwind.sdf, start <ph id=\"ph1\">[!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)]</ph> or a <ph id=\"ph2\">[!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)]</ph> command prompt in the <bpt id=\"p1\">**</bpt>Run as administrator<ept id=\"p1\">**</ept> mode.","pos":[159,353],"source":" To connect to Northwind.sdf, start [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] or a [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)] command prompt in the **Run as administrator** mode."}]}]},{"content":"This walkthrough contains the following sections:","pos":[2902,2951]},{"pos":[2961,3006],"content":"<bpt id=\"p1\">[</bpt>Creating the Console Application<ept id=\"p1\">](#creating)</ept>","source":"[Creating the Console Application](#creating)"},{"pos":[3016,3061],"content":"<bpt id=\"p1\">[</bpt>Defining the Employee Class<ept id=\"p1\">](#employeeClass)</ept>","source":"[Defining the Employee Class](#employeeClass)"},{"pos":[3071,3123],"content":"<bpt id=\"p1\">[</bpt>Defining Employee Database Operations<ept id=\"p1\">](#operations)</ept>","source":"[Defining Employee Database Operations](#operations)"},{"pos":[3133,3210],"content":"<bpt id=\"p1\">[</bpt>Adding Employee Data to the Database without Using Buffering<ept id=\"p1\">](#nonBuffering)</ept>","source":"[Adding Employee Data to the Database without Using Buffering](#nonBuffering)"},{"pos":[3220,3286],"content":"<bpt id=\"p1\">[</bpt>Using Buffering to Add Employee Data to the Database<ept id=\"p1\">](#buffering)</ept>","source":"[Using Buffering to Add Employee Data to the Database](#buffering)"},{"pos":[3296,3372],"content":"<bpt id=\"p1\">[</bpt>Using Buffered Join to Read Employee Data from the Database<ept id=\"p1\">](#bufferedJoin)</ept>","source":"[Using Buffered Join to Read Employee Data from the Database](#bufferedJoin)"},{"pos":[3382,3415],"content":"<bpt id=\"p1\">[</bpt>The Complete Example<ept id=\"p1\">](#complete)</ept>","source":"[The Complete Example](#complete)"},{"pos":[3451,3483],"content":"Creating the Console Application","linkify":"Creating the Console Application","nodes":[{"content":"Creating the Console Application","pos":[0,32]}]},{"content":"In <ph id=\"ph1\">[!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)]</ph>, create a Visual C# or Visual Basic <bpt id=\"p1\">**</bpt>Console Application<ept id=\"p1\">**</ept> project.","pos":[3522,3644],"source":"In [!INCLUDE[vsprvs](../../../includes/vsprvs-md.md)], create a Visual C# or Visual Basic **Console Application** project."},{"content":"In this document, the project is named <ph id=\"ph1\">`DataflowBatchDatabase`</ph>.","pos":[3645,3708],"source":" In this document, the project is named `DataflowBatchDatabase`."},{"content":"In your project, add a reference to System.Data.SqlServerCe.dll and a reference to System.Threading.Tasks.Dataflow.dll.","pos":[3718,3837]},{"pos":[3847,4042],"content":"Ensure that Form1.cs (Form1.vb for <ph id=\"ph1\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) contains the following <ph id=\"ph2\">`using`</ph> (<ph id=\"ph3\">`Imports`</ph> in <ph id=\"ph4\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) statements.","source":"Ensure that Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) contains the following `using` (`Imports` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) statements."},{"pos":[4053,4360],"content":"[!code-csharp[TPLDataflow_BatchDatabase#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#1)]\n [!code-vb[TPLDataflow_BatchDatabase#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#1)]","leadings":["","    "],"nodes":[]},{"pos":[4370,4424],"content":"Add the following data members to the <ph id=\"ph1\">`Program`</ph> class.","source":"Add the following data members to the `Program` class."},{"pos":[4435,4742],"content":"[!code-csharp[TPLDataflow_BatchDatabase#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_batchdatabase/cs/dataflowbatchdatabase.cs#2)]\n [!code-vb[TPLDataflow_BatchDatabase#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_batchdatabase/vb/dataflowbatchdatabase.vb#2)]","leadings":["","    "],"nodes":[]},{"pos":[4783,4810],"content":"Defining the Employee Class","linkify":"Defining the Employee Class","nodes":[{"content":"Defining the Employee Class","pos":[0,27]}]},{"pos":[4814,4862],"content":"Add to the <ph id=\"ph1\">`Program`</ph> class the <ph id=\"ph2\">`Employee`</ph> class.","source":"Add to the `Program` class the `Employee` class."},{"content":"The <ph id=\"ph1\">`Employee`</ph> class contains three properties, <ph id=\"ph2\">`EmployeeID`</ph>, <ph id=\"ph3\">`LastName`</ph>, and <ph id=\"ph4\">`FirstName`</ph>.","pos":[5179,5269],"source":"The `Employee` class contains three properties, `EmployeeID`, `LastName`, and `FirstName`."},{"content":"These properties correspond to the <ph id=\"ph1\">`Employee ID`</ph>, <ph id=\"ph2\">`Last Name`</ph>, and <ph id=\"ph3\">`First Name`</ph> columns in the <ph id=\"ph4\">`Employees`</ph> table in the Northwind database.","pos":[5270,5409],"source":" These properties correspond to the `Employee ID`, `Last Name`, and `First Name` columns in the `Employees` table in the Northwind database."},{"content":"For this demonstration, the <ph id=\"ph1\">`Employee`</ph> class also defines the <ph id=\"ph2\">`Random`</ph> method, which creates an <ph id=\"ph3\">`Employee`</ph> object that has random values for its properties.","pos":[5410,5566],"source":" For this demonstration, the `Employee` class also defines the `Random` method, which creates an `Employee` object that has random values for its properties."},{"pos":[5604,5641],"content":"Defining Employee Database Operations","linkify":"Defining Employee Database Operations","nodes":[{"content":"Defining Employee Database Operations","pos":[0,37]}]},{"pos":[5645,5743],"content":"Add to the <ph id=\"ph1\">`Program`</ph> class the <ph id=\"ph2\">`InsertEmployees`</ph>, <ph id=\"ph3\">`GetEmployeeCount`</ph>, and <ph id=\"ph4\">`GetEmployeeID`</ph> methods.","source":"Add to the `Program` class the `InsertEmployees`, `GetEmployeeCount`, and `GetEmployeeID` methods."},{"content":"The <ph id=\"ph1\">`InsertEmployees`</ph> method adds new employee records to the database.","pos":[6060,6131],"source":"The `InsertEmployees` method adds new employee records to the database."},{"content":"The <ph id=\"ph1\">`GetEmployeeCount`</ph> method retrieves the number of entries in the <ph id=\"ph2\">`Employees`</ph> table.","pos":[6132,6219],"source":" The `GetEmployeeCount` method retrieves the number of entries in the `Employees` table."},{"content":"The <ph id=\"ph1\">`GetEmployeeID`</ph> method retrieves the identifier of the first employee that has the provided name.","pos":[6220,6321],"source":" The `GetEmployeeID` method retrieves the identifier of the first employee that has the provided name."},{"content":"Each of these methods takes a connection string to the Northwind database and uses functionality in the <ph id=\"ph1\">`System.Data.SqlServerCe`</ph> namespace to communicate with the database.","pos":[6322,6495],"source":" Each of these methods takes a connection string to the Northwind database and uses functionality in the `System.Data.SqlServerCe` namespace to communicate with the database."},{"pos":[6535,6595],"content":"Adding Employee Data to the Database Without Using Buffering","linkify":"Adding Employee Data to the Database Without Using Buffering","nodes":[{"content":"Adding Employee Data to the Database Without Using Buffering","pos":[0,60]}]},{"pos":[6599,6679],"content":"Add to the <ph id=\"ph1\">`Program`</ph> class the <ph id=\"ph2\">`AddEmployees`</ph> and <ph id=\"ph3\">`PostRandomEmployees`</ph> methods.","source":"Add to the `Program` class the `AddEmployees` and `PostRandomEmployees` methods."},{"content":"The <ph id=\"ph1\">`AddEmployees`</ph> method adds random employee data to the database by using dataflow.","pos":[6996,7082],"source":"The `AddEmployees` method adds random employee data to the database by using dataflow."},{"content":"It creates an <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ActionBlock%601&gt;</ph> object that calls the <ph id=\"ph2\">`InsertEmployees`</ph> method to add an employee entry to the database.","pos":[7083,7240],"source":" It creates an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object that calls the `InsertEmployees` method to add an employee entry to the database."},{"content":"The <ph id=\"ph1\">`AddEmployees`</ph> method then calls the <ph id=\"ph2\">`PostRandomEmployees`</ph> method to post multiple <ph id=\"ph3\">`Employee`</ph> objects to the <ph id=\"ph4\">&lt;xref:System.Threading.Tasks.Dataflow.ActionBlock%601&gt;</ph> object.","pos":[7241,7416],"source":" The `AddEmployees` method then calls the `PostRandomEmployees` method to post multiple `Employee` objects to the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object."},{"content":"The <ph id=\"ph1\">`AddEmployees`</ph> method then waits for all insert operations to finish.","pos":[7417,7490],"source":" The `AddEmployees` method then waits for all insert operations to finish."},{"pos":[7527,7579],"content":"Using Buffering to Add Employee Data to the Database","linkify":"Using Buffering to Add Employee Data to the Database","nodes":[{"content":"Using Buffering to Add Employee Data to the Database","pos":[0,52]}]},{"pos":[7583,7643],"content":"Add to the <ph id=\"ph1\">`Program`</ph> class the <ph id=\"ph2\">`AddEmployeesBatched`</ph> method.","source":"Add to the `Program` class the `AddEmployeesBatched` method."},{"content":"This method resembles <ph id=\"ph1\">`AddEmployees`</ph>, except that it also uses the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.BatchBlock%601&gt;</ph> class to buffer multiple <ph id=\"ph3\">`Employee`</ph> objects before it sends those objects to the <ph id=\"ph4\">&lt;xref:System.Threading.Tasks.Dataflow.ActionBlock%601&gt;</ph> object.","pos":[7960,8224],"source":"This method resembles `AddEmployees`, except that it also uses the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class to buffer multiple `Employee` objects before it sends those objects to the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object."},{"content":"Because the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BatchBlock%601&gt;</ph> class propagates out multiple elements as a collection, the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.ActionBlock%601&gt;</ph> object is modified to act on an array of <ph id=\"ph3\">`Employee`</ph> objects.","pos":[8225,8466],"source":" Because the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class propagates out multiple elements as a collection, the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object is modified to act on an array of `Employee` objects."},{"content":"As in the <ph id=\"ph1\">`AddEmployees`</ph> method, <ph id=\"ph2\">`AddEmployeesBatched`</ph> calls the <ph id=\"ph3\">`PostRandomEmployees`</ph> method to post multiple <ph id=\"ph4\">`Employee`</ph> objects; however, <ph id=\"ph5\">`AddEmployeesBatched`</ph> posts these objects to the <ph id=\"ph6\">&lt;xref:System.Threading.Tasks.Dataflow.BatchBlock%601&gt;</ph> object.","pos":[8467,8717],"source":" As in the `AddEmployees` method, `AddEmployeesBatched` calls the `PostRandomEmployees` method to post multiple `Employee` objects; however, `AddEmployeesBatched` posts these objects to the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object."},{"content":"The <ph id=\"ph1\">`AddEmployeesBatched`</ph>  method also waits for all insert operations to finish.","pos":[8718,8799],"source":" The `AddEmployeesBatched`  method also waits for all insert operations to finish."},{"pos":[8839,8898],"content":"Using Buffered Join to Read Employee Data from the Database","linkify":"Using Buffered Join to Read Employee Data from the Database","nodes":[{"content":"Using Buffered Join to Read Employee Data from the Database","pos":[0,59]}]},{"pos":[8902,8961],"content":"Add to the <ph id=\"ph1\">`Program`</ph> class the <ph id=\"ph2\">`GetRandomEmployees`</ph> method.","source":"Add to the `Program` class the `GetRandomEmployees` method."},{"content":"This method prints information about random employees to the console.","pos":[9278,9347]},{"content":"It creates several random <ph id=\"ph1\">`Employee`</ph> objects and calls the <ph id=\"ph2\">`GetEmployeeID`</ph> method to retrieve the unique identifier for each object.","pos":[9348,9480],"source":" It creates several random `Employee` objects and calls the `GetEmployeeID` method to retrieve the unique identifier for each object."},{"content":"Because the <ph id=\"ph1\">`GetEmployeeID`</ph> method throws an exception if there is no matching employee with the given first and last names, the <ph id=\"ph2\">`GetRandomEmployees`</ph> method uses the <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602&gt;</ph> class to store <ph id=\"ph4\">`Employee`</ph> objects for successful calls to <ph id=\"ph5\">`GetEmployeeID`</ph> and <ph id=\"ph6\">&lt;xref:System.Exception?displayProperty=fullName&gt;</ph> objects for calls that fail.","pos":[9481,9862],"source":" Because the `GetEmployeeID` method throws an exception if there is no matching employee with the given first and last names, the `GetRandomEmployees` method uses the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> class to store `Employee` objects for successful calls to `GetEmployeeID` and <xref:System.Exception?displayProperty=fullName> objects for calls that fail."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ActionBlock%601&gt;</ph> object in this example acts on a <ph id=\"ph2\">&lt;xref:System.Tuple%602&gt;</ph> object that holds a list of <ph id=\"ph3\">`Employee`</ph> objects and a list of <ph id=\"ph4\">&lt;xref:System.Exception&gt;</ph> objects.","pos":[9863,10072],"source":" The <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object in this example acts on a <xref:System.Tuple%602> object that holds a list of `Employee` objects and a list of <xref:System.Exception> objects."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602&gt;</ph> object propagates out this data when the sum of the received <ph id=\"ph2\">`Employee`</ph> and <ph id=\"ph3\">&lt;xref:System.Exception&gt;</ph> object counts equals the batch size.","pos":[10073,10273],"source":" The <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> object propagates out this data when the sum of the received `Employee` and <xref:System.Exception> object counts equals the batch size."},{"pos":[10309,10329],"content":"The Complete Example","linkify":"The Complete Example","nodes":[{"content":"The Complete Example","pos":[0,20]}]},{"content":"The following example shows the complete code.","pos":[10333,10379]},{"content":"The <ph id=\"ph1\">`Main`</ph> method compares the time that is required to perform batched database insertions versus the time to perform non-batched database insertions.","pos":[10380,10531],"source":" The `Main` method compares the time that is required to perform batched database insertions versus the time to perform non-batched database insertions."},{"content":"It also demonstrates the use of buffered join to read employee data from the database and also report errors.","pos":[10532,10641]},{"pos":[10968,10976],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[10980,11069],"content":"<bpt id=\"p1\">[</bpt>Dataflow<ept id=\"p1\">](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)</ept>","source":"[Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)"}]}