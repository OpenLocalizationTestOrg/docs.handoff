{"content":"---\ntitle: \"Measuring Startup Improvement with .NET Native\"\nms.date: \"03/30/2017\"\nms.assetid: c4d25b24-9c1a-4b3e-9705-97ba0d6c0289\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# Measuring Startup Improvement with .NET Native\n[!INCLUDE[net_native](../../../includes/net-native-md.md)] significantly improves the launch time of apps. This improvement is particularly noticeable on portable, low-powered devices and with complex apps. This topic helps you get started with the basic instrumentation needed to measure this startup improvement.  \n  \n To facilitate performance investigations, the .NET Framework and Windows use an event framework called Event Tracing for Windows (ETW) that allows your app to notify tooling when events happen. You can then use a tool called PerfView to easily view and analyze of ETW events. This topic explains how to:  \n  \n-   Use the <xref:System.Diagnostics.Tracing.EventSource> class to emit events.  \n  \n-   Use PerfView to gather those events.  \n  \n-   Use PerfView to display those events.  \n  \n## Using EventSource to emit events  \n <xref:System.Diagnostics.Tracing.EventSource> provides a base class from which to create a custom event provider. Generally, you create a subclass of <xref:System.Diagnostics.Tracing.EventSource> and wrap the `Write*` methods with your own event methods. A singleton pattern is generally used for each <xref:System.Diagnostics.Tracing.EventSource>.  \n  \n For example, the class in the following example can be used to measure two performance characteristics:  \n  \n-   The time until the `App` class constructor was called.  \n  \n-   The time until the `MainPage` constructor was called.  \n  \n [!code-csharp[ProjectN_ETW#1](../../../samples/snippets/csharp/VS_Snippets_CLR/projectn_etw/cs/etw1.cs#1)]  \n  \n There are a few things to notice here. First, a singleton is created in `AppEventSource.Log`. That instance will be used for all logging. Second, each event method has an <xref:System.Diagnostics.Tracing.EventAttribute>. This helps tooling associate the index of the <xref:System.Diagnostics.Tracing.EventSource.WriteEvent%2A> method with the method that was called on `AppEventSource`.  \n  \n Note that these events are purely illustrative. Most app code will run after these events. You should understand which events in code correspond to user interactions, measure those, and improve those benchmarks. Also, the events themselves log only a single instance in time. It’s often useful to have paired start and stop events for every operation. When examining app startup, the start event is generally the \"Process/Start\" event that the operating system emits.  \n  \n For example, suppose you are creating an RSS reader. A few interesting locations to log an event are:  \n  \n-   When the main page is first rendered.  \n  \n-   When old RSS stories are deserialized from local storage.  \n  \n-   When your app begins syncing new stories.  \n  \n-   When your app has finished syncing new stories.  \n  \n Instrumenting an app is straightforward: Just call the appropriate method on the derived class. Using `AppEventSource` from the previous example, you can instrument an app as follows:  \n  \n [!code-csharp[ProjectN_ETW#2](../../../samples/snippets/csharp/VS_Snippets_CLR/projectn_etw/cs/etw2.cs#2)]  \n  \n When the app is instrumented, you’re ready to gather events.  \n  \n## Gathering events with PerfView  \n PerfView uses ETW events to help you do all sorts of performance investigations on your app. It also includes a configuration GUI that lets you turn logging for different types of events on or off. PerfView is a free tool and can be downloaded from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=28567). For more information, watch the [PerfView tutorial videos](https://channel9.msdn.com/Series/PerfView-Tutorial).  \n  \n> [!NOTE]\n>  PerfView cannot be used to collect events on ARM systems. To collect events on ARM systems, use Windows Performance Recorder (WPR). For more information, see [Vance Morrison's blog post](https://blogs.msdn.com/b/vancem/archive/2012/12/19/collecting-etw-perfview-data-on-an-windows-rt-winrt-arm-surface-device.aspx).  \n  \n You can also invoke PerfView from the command line. To log only the events from your provider, open the Command Prompt window and enter the command:  \n  \n```  \nperfview -KernelEvents:Process -OnlyProviders:*MyCompany-MyApp collect outputFile   \n```  \n  \n where:  \n  \n `-KernelEvents:Process`  \n Indicates that you want to know when the process starts and stops. You need the Process/Start event for your app so it can be subtracted from other event times.  \n  \n `-OnlyProviders:*MyCompany-MyApp`  \n Turns off other providers that PerfView turns on by default, and turns on the MyCompany-MyApp provider.  (The asterisk indicates that it is an <xref:System.Diagnostics.Tracing.EventSource>.)  \n  \n `collect outputFile`  \n Indicates that you want to start collection and save the data to outputFile.etl.zip.  \n  \n Run your app after starting PerfView. There are a few things to remember when running your app:  \n  \n-   Use a release build, not a debug build. Debug builds often contain extra error checking and error handling code that can cause your app to run slower than expected.  \n  \n-   Running your app with a debugger attached affects the performance of your app.  \n  \n-   Windows uses multiple caching strategies to speed up app launch times. If your app is currently cached in memory and doesn't have to be loaded from disk, it will start faster. To ensure consistency, start and close your app a few times before measuring it.  \n  \n When you’ve run your app so that PerfView can collect emitted events, choose the **Stop Collection** button. Generally, you should stop collection before closing your app so you don’t get extraneous events. However, if you’re measuring shutdown or suspension performance, you’ll want to continue collection.  \n  \n## Displaying the events  \n To view the events that have already been collected, use PerfView to open the .etl or .etl.zip file you created and choose **Events**. ETW will have collected information about a large number of events, including events from other processes. To focus your investigation, complete the following text boxes in the events view:  \n  \n-   In the **Process Filter** box, specify your app name (without \".exe\").  \n  \n-   In the **Event Types Filter** box, specify `Process/Start | MyCompany-MyApp`. This sets a filter for events from MyCompany-MyApp and the Windows Kernel/Process/Start event.  \n  \n Select all the events listed in the left pane (Ctrl-A) and choose the **Enter** key. Now, you should be able to see the timestamps from each event. These timestamps are relative to the start of the trace, so you have to subtract the time of each event from the start time of the process to identify the elapsed time since startup. If you use Ctrl+Click to select two timestamps, you'll see the difference between them displayed in the status bar at the bottom of the page. This makes it easy to see the elapsed time between any two events in the display (including process start). You can open the shortcut menu for the view and select from a number of useful options, like exporting to CSV files or opening Microsoft Excel to save or process the data.  \n  \n By repeating the procedure for both your original app and the version you built by using the [!INCLUDE[net_native](../../../includes/net-native-md.md)] tool chain, you can compare the difference in performance.   [!INCLUDE[net_native](../../../includes/net-native-md.md)] apps generally start faster than non-[!INCLUDE[net_native](../../../includes/net-native-md.md)] apps. If you’re interested in digging deeper, PerfView can also identify the parts of your code that are taking the most time. For more information, watch the [PerfView tutorials](https://channel9.msdn.com/Series/PerfView-Tutorial) or read [Vance Morrison’s blog entry](https://blogs.msdn.com/b/vancem/archive/2011/12/28/publication-of-the-perfview-performance-analysis-tool.aspx).  \n  \n## See also\n\n- <xref:System.Diagnostics.Tracing.EventSource>\n","nodes":[{"pos":[4,170],"embed":true,"restype":"x-metadata","content":"title: \"Measuring Startup Improvement with .NET Native\"\nms.date: \"03/30/2017\"\nms.assetid: c4d25b24-9c1a-4b3e-9705-97ba0d6c0289\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"Measuring Startup Improvement with .NET Native","nodes":[{"pos":[0,46],"content":"Measuring Startup Improvement with .NET Native","nodes":[{"content":"Measuring Startup Improvement with .NET Native","pos":[0,46]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[177,223],"content":"Measuring Startup Improvement with .NET Native","linkify":"Measuring Startup Improvement with .NET Native","nodes":[{"content":"Measuring Startup Improvement with .NET Native","pos":[0,46]}]},{"content":"<ph id=\"ph1\">[!INCLUDE[net_native](../../../includes/net-native-md.md)]</ph> significantly improves the launch time of apps.","pos":[224,330],"source":"[!INCLUDE[net_native](../../../includes/net-native-md.md)] significantly improves the launch time of apps."},{"content":"This improvement is particularly noticeable on portable, low-powered devices and with complex apps.","pos":[331,430]},{"content":"This topic helps you get started with the basic instrumentation needed to measure this startup improvement.","pos":[431,538]},{"content":"To facilitate performance investigations, the .NET Framework and Windows use an event framework called Event Tracing for Windows (ETW) that allows your app to notify tooling when events happen.","pos":[545,738]},{"content":"You can then use a tool called PerfView to easily view and analyze of ETW events.","pos":[739,820]},{"content":"This topic explains how to:","pos":[821,848]},{"pos":[858,933],"content":"Use the <ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventSource&gt;</ph> class to emit events.","source":"Use the <xref:System.Diagnostics.Tracing.EventSource> class to emit events."},{"content":"Use PerfView to gather those events.","pos":[943,979]},{"content":"Use PerfView to display those events.","pos":[989,1026]},{"pos":[1035,1067],"content":"Using EventSource to emit events","linkify":"Using EventSource to emit events","nodes":[{"content":"Using EventSource to emit events","pos":[0,32]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventSource&gt;</ph> provides a base class from which to create a custom event provider.","pos":[1071,1184],"source":"<xref:System.Diagnostics.Tracing.EventSource> provides a base class from which to create a custom event provider."},{"content":"Generally, you create a subclass of <ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventSource&gt;</ph> and wrap the <ph id=\"ph2\">`Write*`</ph> methods with your own event methods.","pos":[1185,1325],"source":" Generally, you create a subclass of <xref:System.Diagnostics.Tracing.EventSource> and wrap the `Write*` methods with your own event methods."},{"content":"A singleton pattern is generally used for each <ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventSource&gt;</ph>.","pos":[1326,1419],"source":" A singleton pattern is generally used for each <xref:System.Diagnostics.Tracing.EventSource>."},{"content":"For example, the class in the following example can be used to measure two performance characteristics:","pos":[1426,1529]},{"pos":[1539,1593],"content":"The time until the <ph id=\"ph1\">`App`</ph> class constructor was called.","source":"The time until the `App` class constructor was called."},{"pos":[1603,1656],"content":"The time until the <ph id=\"ph1\">`MainPage`</ph> constructor was called.","source":"The time until the `MainPage` constructor was called."},{"content":"There are a few things to notice here.","pos":[1776,1814]},{"content":"First, a singleton is created in <ph id=\"ph1\">`AppEventSource.Log`</ph>.","pos":[1815,1869],"source":" First, a singleton is created in `AppEventSource.Log`."},{"content":"That instance will be used for all logging.","pos":[1870,1913]},{"content":"Second, each event method has an <ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventAttribute&gt;</ph>.","pos":[1914,1996],"source":" Second, each event method has an <xref:System.Diagnostics.Tracing.EventAttribute>."},{"content":"This helps tooling associate the index of the <ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventSource.WriteEvent%2A&gt;</ph> method with the method that was called on <ph id=\"ph2\">`AppEventSource`</ph>.","pos":[1997,2162],"source":" This helps tooling associate the index of the <xref:System.Diagnostics.Tracing.EventSource.WriteEvent%2A> method with the method that was called on `AppEventSource`."},{"content":"Note that these events are purely illustrative.","pos":[2169,2216]},{"content":"Most app code will run after these events.","pos":[2217,2259]},{"content":"You should understand which events in code correspond to user interactions, measure those, and improve those benchmarks.","pos":[2260,2380]},{"content":"Also, the events themselves log only a single instance in time.","pos":[2381,2444]},{"content":"It’s often useful to have paired start and stop events for every operation.","pos":[2445,2520]},{"content":"When examining app startup, the start event is generally the \"Process/Start\" event that the operating system emits.","pos":[2521,2636]},{"content":"For example, suppose you are creating an RSS reader.","pos":[2643,2695]},{"content":"A few interesting locations to log an event are:","pos":[2696,2744]},{"content":"When the main page is first rendered.","pos":[2754,2791]},{"content":"When old RSS stories are deserialized from local storage.","pos":[2801,2858]},{"content":"When your app begins syncing new stories.","pos":[2868,2909]},{"content":"When your app has finished syncing new stories.","pos":[2919,2966]},{"content":"Instrumenting an app is straightforward: Just call the appropriate method on the derived class.","pos":[2973,3068]},{"content":"Using <ph id=\"ph1\">`AppEventSource`</ph> from the previous example, you can instrument an app as follows:","pos":[3069,3156],"source":" Using `AppEventSource` from the previous example, you can instrument an app as follows:"},{"content":"When the app is instrumented, you’re ready to gather events.","pos":[3276,3336]},{"pos":[3345,3375],"content":"Gathering events with PerfView","linkify":"Gathering events with PerfView","nodes":[{"content":"Gathering events with PerfView","pos":[0,30]}]},{"content":"PerfView uses ETW events to help you do all sorts of performance investigations on your app.","pos":[3379,3471]},{"content":"It also includes a configuration GUI that lets you turn logging for different types of events on or off.","pos":[3472,3576]},{"content":"PerfView is a free tool and can be downloaded from the <bpt id=\"p1\">[</bpt>Microsoft Download Center<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=28567)</ept>.","pos":[3577,3718],"source":" PerfView is a free tool and can be downloaded from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=28567)."},{"content":"For more information, watch the <bpt id=\"p1\">[</bpt>PerfView tutorial videos<ept id=\"p1\">](https://channel9.msdn.com/Series/PerfView-Tutorial)</ept>.","pos":[3719,3830],"source":" For more information, watch the [PerfView tutorial videos](https://channel9.msdn.com/Series/PerfView-Tutorial)."},{"pos":[3838,4164],"content":"[!NOTE]\n PerfView cannot be used to collect events on ARM systems. To collect events on ARM systems, use Windows Performance Recorder (WPR). For more information, see [Vance Morrison's blog post](https://blogs.msdn.com/b/vancem/archive/2012/12/19/collecting-etw-perfview-data-on-an-windows-rt-winrt-arm-surface-device.aspx).","leadings":["","> "],"nodes":[{"content":"PerfView cannot be used to collect events on ARM systems. To collect events on ARM systems, use Windows Performance Recorder (WPR). For more information, see [Vance Morrison's blog post](https://blogs.msdn.com/b/vancem/archive/2012/12/19/collecting-etw-perfview-data-on-an-windows-rt-winrt-arm-surface-device.aspx).","pos":[9,324],"nodes":[{"content":"PerfView cannot be used to collect events on ARM systems.","pos":[0,57]},{"content":"To collect events on ARM systems, use Windows Performance Recorder (WPR).","pos":[58,131]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Vance Morrison's blog post<ept id=\"p1\">](https://blogs.msdn.com/b/vancem/archive/2012/12/19/collecting-etw-perfview-data-on-an-windows-rt-winrt-arm-surface-device.aspx)</ept>.","pos":[132,315],"source":" For more information, see [Vance Morrison's blog post](https://blogs.msdn.com/b/vancem/archive/2012/12/19/collecting-etw-perfview-data-on-an-windows-rt-winrt-arm-surface-device.aspx)."}]}]},{"content":"You can also invoke PerfView from the command line.","pos":[4171,4222]},{"content":"To log only the events from your provider, open the Command Prompt window and enter the command:","pos":[4223,4319]},{"content":"where:","pos":[4426,4432]},{"content":"Indicates that you want to know when the process starts and stops.","pos":[4466,4532]},{"content":"You need the Process/Start event for your app so it can be subtracted from other event times.","pos":[4533,4626]},{"content":"Turns off other providers that PerfView turns on by default, and turns on the MyCompany-MyApp provider.","pos":[4670,4773]},{"content":"(The asterisk indicates that it is an <ph id=\"ph1\">&lt;xref:System.Diagnostics.Tracing.EventSource&gt;</ph>.)","pos":[4775,4860],"source":"  (The asterisk indicates that it is an <xref:System.Diagnostics.Tracing.EventSource>.)"},{"content":"Indicates that you want to start collection and save the data to outputFile.etl.zip.","pos":[4891,4975]},{"content":"Run your app after starting PerfView.","pos":[4982,5019]},{"content":"There are a few things to remember when running your app:","pos":[5020,5077]},{"content":"Use a release build, not a debug build.","pos":[5087,5126]},{"content":"Debug builds often contain extra error checking and error handling code that can cause your app to run slower than expected.","pos":[5127,5251]},{"content":"Running your app with a debugger attached affects the performance of your app.","pos":[5261,5339]},{"content":"Windows uses multiple caching strategies to speed up app launch times.","pos":[5349,5419]},{"content":"If your app is currently cached in memory and doesn't have to be loaded from disk, it will start faster.","pos":[5420,5524]},{"content":"To ensure consistency, start and close your app a few times before measuring it.","pos":[5525,5605]},{"content":"When you’ve run your app so that PerfView can collect emitted events, choose the <bpt id=\"p1\">**</bpt>Stop Collection<ept id=\"p1\">**</ept> button.","pos":[5612,5720],"source":"When you’ve run your app so that PerfView can collect emitted events, choose the **Stop Collection** button."},{"content":"Generally, you should stop collection before closing your app so you don’t get extraneous events.","pos":[5721,5818]},{"content":"However, if you’re measuring shutdown or suspension performance, you’ll want to continue collection.","pos":[5819,5919]},{"pos":[5928,5949],"content":"Displaying the events","linkify":"Displaying the events","nodes":[{"content":"Displaying the events","pos":[0,21]}]},{"content":"To view the events that have already been collected, use PerfView to open the .etl or .etl.zip file you created and choose <bpt id=\"p1\">**</bpt>Events<ept id=\"p1\">**</ept>.","pos":[5953,6087],"source":"To view the events that have already been collected, use PerfView to open the .etl or .etl.zip file you created and choose **Events**."},{"content":"ETW will have collected information about a large number of events, including events from other processes.","pos":[6088,6194]},{"content":"To focus your investigation, complete the following text boxes in the events view:","pos":[6195,6277]},{"pos":[6287,6357],"content":"In the <bpt id=\"p1\">**</bpt>Process Filter<ept id=\"p1\">**</ept> box, specify your app name (without \".exe\").","source":"In the **Process Filter** box, specify your app name (without \".exe\")."},{"content":"In the <bpt id=\"p1\">**</bpt>Event Types Filter<ept id=\"p1\">**</ept> box, specify <ph id=\"ph1\">`Process/Start | MyCompany-MyApp`</ph>.","pos":[6367,6444],"source":"In the **Event Types Filter** box, specify `Process/Start | MyCompany-MyApp`."},{"content":"This sets a filter for events from MyCompany-MyApp and the Windows Kernel/Process/Start event.","pos":[6445,6539]},{"content":"Select all the events listed in the left pane (Ctrl-A) and choose the <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept> key.","pos":[6546,6630],"source":"Select all the events listed in the left pane (Ctrl-A) and choose the **Enter** key."},{"content":"Now, you should be able to see the timestamps from each event.","pos":[6631,6693]},{"content":"These timestamps are relative to the start of the trace, so you have to subtract the time of each event from the start time of the process to identify the elapsed time since startup.","pos":[6694,6876]},{"content":"If you use Ctrl+Click to select two timestamps, you'll see the difference between them displayed in the status bar at the bottom of the page.","pos":[6877,7018]},{"content":"This makes it easy to see the elapsed time between any two events in the display (including process start).","pos":[7019,7126]},{"content":"You can open the shortcut menu for the view and select from a number of useful options, like exporting to CSV files or opening Microsoft Excel to save or process the data.","pos":[7127,7298]},{"content":"By repeating the procedure for both your original app and the version you built by using the <ph id=\"ph1\">[!INCLUDE[net_native](../../../includes/net-native-md.md)]</ph> tool chain, you can compare the difference in performance.","pos":[7305,7515],"source":"By repeating the procedure for both your original app and the version you built by using the [!INCLUDE[net_native](../../../includes/net-native-md.md)] tool chain, you can compare the difference in performance."},{"content":"<ph id=\"ph1\">[!INCLUDE[net_native](../../../includes/net-native-md.md)]</ph> apps generally start faster than non-<ph id=\"ph2\">[!INCLUDE[net_native](../../../includes/net-native-md.md)]</ph> apps.","pos":[7518,7678],"source":"[!INCLUDE[net_native](../../../includes/net-native-md.md)] apps generally start faster than non-[!INCLUDE[net_native](../../../includes/net-native-md.md)] apps."},{"content":"If you’re interested in digging deeper, PerfView can also identify the parts of your code that are taking the most time.","pos":[7679,7799]},{"content":"For more information, watch the <bpt id=\"p1\">[</bpt>PerfView tutorials<ept id=\"p1\">](https://channel9.msdn.com/Series/PerfView-Tutorial)</ept> or read <bpt id=\"p2\">[</bpt>Vance Morrison’s blog entry<ept id=\"p2\">](https://blogs.msdn.com/b/vancem/archive/2011/12/28/publication-of-the-perfview-performance-analysis-tool.aspx)</ept>.","pos":[7800,8054],"source":" For more information, watch the [PerfView tutorials](https://channel9.msdn.com/Series/PerfView-Tutorial) or read [Vance Morrison’s blog entry](https://blogs.msdn.com/b/vancem/archive/2011/12/28/publication-of-the-perfview-performance-analysis-tool.aspx)."},{"pos":[8063,8071],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]}]}