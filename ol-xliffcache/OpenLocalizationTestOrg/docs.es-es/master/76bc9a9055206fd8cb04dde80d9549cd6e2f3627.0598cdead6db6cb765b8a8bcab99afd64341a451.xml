{"content":"---\ntitle: \"How to: Implement a Producer-Consumer Dataflow Pattern | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"TPL dataflow library, implementing producer-consumer pattern\"\n  - \"Task Parallel Library, dataflows\"\n  - \"producer-consumer patterns, implementing [TPL]\"\nms.assetid: 47a1d38c-fe9c-44aa-bd15-937bd5659b0b\ncaps.latest.revision: 10\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"\n---\n# How to: Implement a Producer-Consumer Dataflow Pattern\nThis document describes how to use the TPL Dataflow Library to implement a producer-consumer pattern. In this pattern, the *producer* sends messages to a message block, and the *consumer* reads messages from that block.  \n  \n> [!TIP]\n>  The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.  \n  \n## Example  \n The following example demonstrates a basic producer- consumer model that uses dataflow. The `Produce` method writes arrays that contain random bytes of data to a <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601?displayProperty=fullName> object and the `Consume` method reads bytes from a <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601?displayProperty=fullName> object. By acting on the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> and <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> interfaces, instead of their derived types, you can write reusable code that can act on a variety of dataflow block types. This example uses the <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> class. Because the <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> class acts as both a source block and as a target block, the producer and the consumer can use a shared object to transfer data.  \n  \n The `Produce` method calls the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A> method in a loop to synchronously write data to the target block. After the `Produce` method writes all data to the target block, it calls the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A> method to indicate that the block will never have additional data available. The `Consume` method uses the [async](~/docs/csharp/language-reference/keywords/async.md) and [await](~/docs/csharp/language-reference/keywords/await.md) operators ([Async](~/docs/visual-basic/language-reference/modifiers/async.md) and [Await](~/docs/visual-basic/language-reference/operators/await-operator.md) in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) to asynchronously compute the total number of bytes that are received from the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> object. To act asynchronously, the `Consume` method calls the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.OutputAvailableAsync%2A> method to receive a notification when the source block has data available and when the source block will never have additional data available.  \n  \n [!code-csharp[TPLDataflow_ProducerConsumer#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_producerconsumer/cs/dataflowproducerconsumer.cs#1)]\n [!code-vb[TPLDataflow_ProducerConsumer#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_producerconsumer/vb/dataflowproducerconsumer.vb#1)]  \n  \n## Compiling the Code  \n Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named `DataflowProducerConsumer.cs` (`DataflowProducerConsumer.vb` for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), and then run the following command in a Visual Studio Command Prompt window.  \n  \n [!INCLUDE[csprcs](../../../includes/csprcs-md.md)]  \n  \n **csc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowProducerConsumer.cs**  \n  \n [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]  \n  \n **vbc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowProducerConsumer.vb**  \n  \n## Robust Programming  \n This example uses just one consumer to process the source data. If you have multiple consumers in your application, use the <xref:System.Threading.Tasks.Dataflow.IReceivableSourceBlock%601.TryReceive%2A> method to read data from the source block, as shown in the following example.  \n  \n [!code-csharp[TPLDataflow_ProducerConsumer#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_producerconsumer/cs/dataflowproducerconsumer.cs#2)]\n [!code-vb[TPLDataflow_ProducerConsumer#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_producerconsumer/vb/dataflowproducerconsumer.vb#2)]  \n  \n The <xref:System.Threading.Tasks.Dataflow.IReceivableSourceBlock%601.TryReceive%2A> method returns `False` when no data is available. When multiple consumers must access the source block concurrently, this mechanism guarantees that data is still available after the call to <xref:System.Threading.Tasks.Dataflow.DataflowBlock.OutputAvailableAsync%2A>.  \n  \n## See Also  \n [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)","nodes":[{"pos":[4,549],"embed":true,"restype":"x-metadata","content":"title: \"How to: Implement a Producer-Consumer Dataflow Pattern | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"TPL dataflow library, implementing producer-consumer pattern\"\n  - \"Task Parallel Library, dataflows\"\n  - \"producer-consumer patterns, implementing [TPL]\"\nms.assetid: 47a1d38c-fe9c-44aa-bd15-937bd5659b0b\ncaps.latest.revision: 10\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"","nodes":[{"content":"How to: Implement a Producer-Consumer Dataflow Pattern | Microsoft Docs","nodes":[{"pos":[0,71],"content":"How to: Implement a Producer-Consumer Dataflow Pattern | Microsoft Docs","nodes":[{"content":"How to: Implement a Producer-Consumer Dataflow Pattern | Microsoft Docs","pos":[0,71]}]}],"path":["title"]}],"yml":true},{"pos":[556,610],"content":"How to: Implement a Producer-Consumer Dataflow Pattern","linkify":"How to: Implement a Producer-Consumer Dataflow Pattern","nodes":[{"content":"How to: Implement a Producer-Consumer Dataflow Pattern","pos":[0,54]}]},{"content":"This document describes how to use the TPL Dataflow Library to implement a producer-consumer pattern.","pos":[611,712]},{"content":"In this pattern, the <bpt id=\"p1\">*</bpt>producer<ept id=\"p1\">*</ept> sends messages to a message block, and the <bpt id=\"p2\">*</bpt>consumer<ept id=\"p2\">*</ept> reads messages from that block.","pos":[713,830],"source":" In this pattern, the *producer* sends messages to a message block, and the *consumer* reads messages from that block."},{"pos":[838,1298],"content":"[!TIP]\n The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","leadings":["","> "],"nodes":[{"content":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","pos":[8,458],"nodes":[{"content":"The TPL Dataflow Library (<ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow?displayProperty=fullName&gt;</ph> namespace) is not distributed with the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>.","pos":[0,182],"source":"The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]."},{"content":"To install the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow&gt;</ph> namespace, open your project in <ph id=\"ph2\">[!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)]</ph>, choose <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> from the Project menu, and search online for the <ph id=\"ph3\">`Microsoft.Tpl.Dataflow`</ph> package.","pos":[183,450],"source":" To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package."}]}]},{"pos":[1307,1314],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following example demonstrates a basic producer- consumer model that uses dataflow.","pos":[1318,1405]},{"content":"The <ph id=\"ph1\">`Produce`</ph> method writes arrays that contain random bytes of data to a <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.ITargetBlock%601?displayProperty=fullName&gt;</ph> object and the <ph id=\"ph3\">`Consume`</ph> method reads bytes from a <ph id=\"ph4\">&lt;xref:System.Threading.Tasks.Dataflow.ISourceBlock%601?displayProperty=fullName&gt;</ph> object.","pos":[1406,1700],"source":" The `Produce` method writes arrays that contain random bytes of data to a <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601?displayProperty=fullName> object and the `Consume` method reads bytes from a <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601?displayProperty=fullName> object."},{"content":"By acting on the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ISourceBlock%601&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.ITargetBlock%601&gt;</ph> interfaces, instead of their derived types, you can write reusable code that can act on a variety of dataflow block types.","pos":[1701,1956],"source":" By acting on the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> and <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> interfaces, instead of their derived types, you can write reusable code that can act on a variety of dataflow block types."},{"content":"This example uses the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BufferBlock%601&gt;</ph> class.","pos":[1957,2040],"source":" This example uses the <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> class."},{"content":"Because the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.BufferBlock%601&gt;</ph> class acts as both a source block and as a target block, the producer and the consumer can use a shared object to transfer data.","pos":[2041,2236],"source":" Because the <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> class acts as both a source block and as a target block, the producer and the consumer can use a shared object to transfer data."},{"content":"The <ph id=\"ph1\">`Produce`</ph> method calls the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A&gt;</ph> method in a loop to synchronously write data to the target block.","pos":[2243,2400],"source":"The `Produce` method calls the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A> method in a loop to synchronously write data to the target block."},{"content":"After the <ph id=\"ph1\">`Produce`</ph> method writes all data to the target block, it calls the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A&gt;</ph> method to indicate that the block will never have additional data available.","pos":[2401,2620],"source":" After the `Produce` method writes all data to the target block, it calls the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A> method to indicate that the block will never have additional data available."},{"content":"The <ph id=\"ph1\">`Consume`</ph> method uses the <bpt id=\"p1\">[</bpt>async<ept id=\"p1\">](~/docs/csharp/language-reference/keywords/async.md)</ept> and <bpt id=\"p2\">[</bpt>await<ept id=\"p2\">](~/docs/csharp/language-reference/keywords/await.md)</ept> operators (<bpt id=\"p3\">[</bpt>Async<ept id=\"p3\">](~/docs/visual-basic/language-reference/modifiers/async.md)</ept> and <bpt id=\"p4\">[</bpt>Await<ept id=\"p4\">](~/docs/visual-basic/language-reference/operators/await-operator.md)</ept> in <ph id=\"ph2\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) to asynchronously compute the total number of bytes that are received from the <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.Dataflow.ISourceBlock%601&gt;</ph> object.","pos":[2621,3130],"source":" The `Consume` method uses the [async](~/docs/csharp/language-reference/keywords/async.md) and [await](~/docs/csharp/language-reference/keywords/await.md) operators ([Async](~/docs/visual-basic/language-reference/modifiers/async.md) and [Await](~/docs/visual-basic/language-reference/operators/await-operator.md) in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) to asynchronously compute the total number of bytes that are received from the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> object."},{"content":"To act asynchronously, the <ph id=\"ph1\">`Consume`</ph> method calls the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlock.OutputAvailableAsync%2A&gt;</ph> method to receive a notification when the source block has data available and when the source block will never have additional data available.","pos":[3131,3404],"source":" To act asynchronously, the `Consume` method calls the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.OutputAvailableAsync%2A> method to receive a notification when the source block has data available and when the source block will never have additional data available."},{"pos":[3741,3759],"content":"Compiling the Code","linkify":"Compiling the Code","nodes":[{"content":"Compiling the Code","pos":[0,18]}]},{"pos":[3763,4056],"content":"Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named <ph id=\"ph1\">`DataflowProducerConsumer.cs`</ph> (<ph id=\"ph2\">`DataflowProducerConsumer.vb`</ph> for <ph id=\"ph3\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>), and then run the following command in a Visual Studio Command Prompt window.","source":"Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named `DataflowProducerConsumer.cs` (`DataflowProducerConsumer.vb` for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), and then run the following command in a Visual Studio Command Prompt window."},{"pos":[4120,4198],"content":"<bpt id=\"p1\">**</bpt>csc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowProducerConsumer.cs<ept id=\"p1\">**</ept>","source":"**csc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowProducerConsumer.cs**"},{"pos":[4262,4340],"content":"<bpt id=\"p1\">**</bpt>vbc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowProducerConsumer.vb<ept id=\"p1\">**</ept>","source":"**vbc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowProducerConsumer.vb**"},{"pos":[4349,4367],"content":"Robust Programming","linkify":"Robust Programming","nodes":[{"content":"Robust Programming","pos":[0,18]}]},{"content":"This example uses just one consumer to process the source data.","pos":[4371,4434]},{"content":"If you have multiple consumers in your application, use the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.IReceivableSourceBlock%601.TryReceive%2A&gt;</ph> method to read data from the source block, as shown in the following example.","pos":[4435,4652],"source":" If you have multiple consumers in your application, use the <xref:System.Threading.Tasks.Dataflow.IReceivableSourceBlock%601.TryReceive%2A> method to read data from the source block, as shown in the following example."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.IReceivableSourceBlock%601.TryReceive%2A&gt;</ph> method returns <ph id=\"ph2\">`False`</ph> when no data is available.","pos":[4987,5120],"source":"The <xref:System.Threading.Tasks.Dataflow.IReceivableSourceBlock%601.TryReceive%2A> method returns `False` when no data is available."},{"content":"When multiple consumers must access the source block concurrently, this mechanism guarantees that data is still available after the call to <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlock.OutputAvailableAsync%2A&gt;</ph>.","pos":[5121,5338],"source":" When multiple consumers must access the source block concurrently, this mechanism guarantees that data is still available after the call to <xref:System.Threading.Tasks.Dataflow.DataflowBlock.OutputAvailableAsync%2A>."},{"pos":[5347,5355],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[5359,5448],"content":"<bpt id=\"p1\">[</bpt>Dataflow<ept id=\"p1\">](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)</ept>","source":"[Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)"}]}