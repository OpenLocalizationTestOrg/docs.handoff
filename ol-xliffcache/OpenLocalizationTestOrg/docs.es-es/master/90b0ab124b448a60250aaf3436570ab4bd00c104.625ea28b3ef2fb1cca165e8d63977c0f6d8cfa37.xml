{"content":"---\ntitle: \"How to: Enable Message Replay Detection | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"WCF security\"\n  - \"replay detection [WCF]\"\n  - \"WCF, custom bindings\"\n  - \"WCF, security\"\nms.assetid: 8b847e91-69a3-49e1-9e5f-0c455e50d804\ncaps.latest.revision: 10\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# How to: Enable Message Replay Detection\nA replay attack occurs when an attacker copies a stream of messages between two parties and replays the stream to one or more of the parties. Unless mitigated, the computers subject to the attack will process the stream as legitimate messages, resulting in a range of bad consequences, such as redundant orders of an item.  \n  \n [!INCLUDE[crabout](../../../../includes/crabout-md.md)] message replay detection, see [Message Replay Detection](http://go.microsoft.com/fwlink/?LinkId=88536).  \n  \n The following procedure demonstrates various properties that you can use to control replay detection using [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)].  \n  \n### To control replay detection on the client using code  \n  \n1.  Create a <xref:System.ServiceModel.Channels.SecurityBindingElement> to use in a <xref:System.ServiceModel.Channels.CustomBinding>. [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][How to: Create a Custom Binding Using the SecurityBindingElement](../../../../docs/framework/wcf/feature-details/how-to-create-a-custom-binding-using-the-securitybindingelement.md). The following example uses a <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> created with the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> of the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.  \n  \n2.  Use the <xref:System.ServiceModel.Channels.SecurityBindingElement.LocalClientSettings%2A> property to return a reference to the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings> class and set any of the following properties, as appropriate:  \n  \n    1.  `DetectReplay`. A Boolean value. This governs whether the client should detect replays from the server. The default is `true`.  \n  \n    2.  `MaxClockSkew`. A <xref:System.TimeSpan> value. Governs how much time skew the replay mechanism can tolerate between the client and the server. The security mechanism examines the time stamp sent and determines whether it was sent too far back in the past. The default is 5 minutes.  \n  \n    3.  `ReplayWindow`. A `TimeSpan` value. This governs how long a message can live in the network after the server sends it (through intermediaries) before reaching the client. The client tracks the signatures of the messages sent within the latest `ReplayWindow` for the purposes of replay detection.  \n  \n    4.  `ReplayCacheSize`. An integer value. The client stores the signatures of the message in a cache. This setting specifies how many signatures the cache can store. If the number of messages sent within the last replay window reaches the cache limit, new messages are rejected until the oldest cached signatures reach the time limit. The default is 500000.  \n  \n### To control replay detection on the service using code  \n  \n1.  Create a <xref:System.ServiceModel.Channels.SecurityBindingElement> to use in a <xref:System.ServiceModel.Channels.CustomBinding>.  \n  \n2.  Use the <xref:System.ServiceModel.Channels.SecurityBindingElement.LocalServiceSettings%2A> property to return a reference to the <xref:System.ServiceModel.Channels.LocalServiceSecuritySettings> class, and set the properties as described previously.  \n  \n### To control replay detection in configuration for the client or service  \n  \n1.  Create a [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md).  \n  \n2.  Create a `<security>` element.  \n  \n3.  Create a [\\<localClientSettings>](../../../../docs/framework/configure-apps/file-schema/wcf/localclientsettings-element.md) or [\\<localServiceSettings>](../../../../docs/framework/configure-apps/file-schema/wcf/localservicesettings-element.md).  \n  \n4.  Set the following attribute values, as appropriate: `detectReplays`, `maxClockSkew`, `replayWindow`, and `replayCacheSize`. The following example sets the attributes of both a `<localServiceSettings>` and a `<localClientSettings>` element:  \n  \n    ```  \n    <customBinding>  \n      <binding name=\"NewBinding0\">  \n       <textMessageEncoding />  \n        <security>  \n         <localClientSettings   \n          replayCacheSize=\"800000\"   \n          maxClockSkew=\"00:03:00\"  \n          replayWindow=\"00:03:00\" />  \n         <localServiceSettings   \n          replayCacheSize=\"800000\"   \n          maxClockSkew=\"00:03:00\"  \n          replayWindow=\"00:03:00\" />  \n        <secureConversationBootstrap />  \n       </security>  \n      <httpTransport />  \n     </binding>  \n    </customBinding>  \n    ```  \n  \n## Example  \n The following example creates a <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> using the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> method, and sets the replay properties of the binding.  \n  \n [!code-csharp[c_ReplayDetection#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_replaydetection/cs/source.cs#1)]\n [!code-vb[c_ReplayDetection#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_replaydetection/vb/source.vb#1)]  \n  \n## Scope of Replay: Message Security Only  \n Note that the following procedures apply only to Message security mode. For Transport and Transport with Message Credential modes, the transport mechanisms detect replays.  \n  \n## Secure Conversation Notes  \n For bindings that enable secure conversations, you can adjust these settings both for the application channel as well as for the secure conversation bootstrap binding. For example, you can turn off replays for the application channel but enable them for the bootstrap channel that establishes the secure conversation.  \n  \n If you do not use secure conversation sessions, replay detection does not guarantee detecting replays in server farm scenarios and when the process is recycled. This applies to the following system-provided bindings:  \n  \n-   <xref:System.ServiceModel.BasicHttpBinding>.  \n  \n-   <xref:System.ServiceModel.WSHttpBinding> with the <xref:System.ServiceModel.NonDualMessageSecurityOverHttp.EstablishSecurityContext%2A> property set to `false`.  \n  \n## Compiling the Code  \n  \n-   The following namespaces are required to compile the code:  \n  \n-   <xref:System>  \n  \n-   <xref:System.ServiceModel>  \n  \n-   <xref:System.ServiceModel.Channels>  \n  \n## See Also  \n <xref:System.ServiceModel.Channels.LocalClientSecuritySettings>   \n <xref:System.ServiceModel.Channels.LocalServiceSecuritySettings>   \n [Secure Conversations and Secure Sessions](../../../../docs/framework/wcf/feature-details/secure-conversations-and-secure-sessions.md)   \n [\\<localClientSettings>](../../../../docs/framework/configure-apps/file-schema/wcf/localclientsettings-element.md)   \n [How to: Create a Custom Binding Using the SecurityBindingElement](../../../../docs/framework/wcf/feature-details/how-to-create-a-custom-binding-using-the-securitybindingelement.md)","nodes":[{"pos":[4,477],"embed":true,"restype":"x-metadata","content":"title: \"How to: Enable Message Replay Detection | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"WCF security\"\n  - \"replay detection [WCF]\"\n  - \"WCF, custom bindings\"\n  - \"WCF, security\"\nms.assetid: 8b847e91-69a3-49e1-9e5f-0c455e50d804\ncaps.latest.revision: 10\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","nodes":[{"content":"How to: Enable Message Replay Detection | Microsoft Docs","nodes":[{"pos":[0,56],"content":"How to: Enable Message Replay Detection | Microsoft Docs","nodes":[{"content":"How to: Enable Message Replay Detection | Microsoft Docs","pos":[0,56]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[484,523],"content":"How to: Enable Message Replay Detection","linkify":"How to: Enable Message Replay Detection","nodes":[{"content":"How to: Enable Message Replay Detection","pos":[0,39]}]},{"content":"A replay attack occurs when an attacker copies a stream of messages between two parties and replays the stream to one or more of the parties.","pos":[524,665]},{"content":"Unless mitigated, the computers subject to the attack will process the stream as legitimate messages, resulting in a range of bad consequences, such as redundant orders of an item.","pos":[666,846]},{"pos":[853,1012],"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> message replay detection, see <bpt id=\"p1\">[</bpt>Message Replay Detection<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=88536)</ept>.","source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] message replay detection, see [Message Replay Detection](http://go.microsoft.com/fwlink/?LinkId=88536)."},{"pos":[1019,1182],"content":"The following procedure demonstrates various properties that you can use to control replay detection using <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph>.","source":"The following procedure demonstrates various properties that you can use to control replay detection using [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]."},{"pos":[1192,1244],"content":"To control replay detection on the client using code","linkify":"To control replay detection on the client using code","nodes":[{"content":"To control replay detection on the client using code","pos":[0,52]}]},{"content":"Create a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement&gt;</ph> to use in a <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.CustomBinding&gt;</ph>.","pos":[1254,1384],"source":"Create a <xref:System.ServiceModel.Channels.SecurityBindingElement> to use in a <xref:System.ServiceModel.Channels.CustomBinding>."},{"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)]</ph><bpt id=\"p1\">[</bpt>How to: Create a Custom Binding Using the SecurityBindingElement<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/how-to-create-a-custom-binding-using-the-securitybindingelement.md)</ept>.","pos":[1385,1626],"source":"[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][How to: Create a Custom Binding Using the SecurityBindingElement](../../../../docs/framework/wcf/feature-details/how-to-create-a-custom-binding-using-the-securitybindingelement.md)."},{"content":"The following example uses a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement&gt;</ph> created with the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A&gt;</ph> of the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement&gt;</ph> class.","pos":[1627,1904],"source":" The following example uses a <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> created with the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> of the <xref:System.ServiceModel.Channels.SecurityBindingElement> class."},{"pos":[1914,2168],"content":"Use the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.LocalClientSettings%2A&gt;</ph> property to return a reference to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.LocalClientSecuritySettings&gt;</ph> class and set any of the following properties, as appropriate:","source":"Use the <xref:System.ServiceModel.Channels.SecurityBindingElement.LocalClientSettings%2A> property to return a reference to the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings> class and set any of the following properties, as appropriate:"},{"content":"<ph id=\"ph1\">`DetectReplay`</ph>.","pos":[2182,2197],"source":"`DetectReplay`."},{"content":"A Boolean value.","pos":[2198,2214]},{"content":"This governs whether the client should detect replays from the server.","pos":[2215,2285]},{"content":"The default is <ph id=\"ph1\">`true`</ph>.","pos":[2286,2308],"source":" The default is `true`."},{"content":"<ph id=\"ph1\">`MaxClockSkew`</ph>.","pos":[2322,2337],"source":"`MaxClockSkew`."},{"content":"A <ph id=\"ph1\">&lt;xref:System.TimeSpan&gt;</ph> value.","pos":[2338,2369],"source":" A <xref:System.TimeSpan> value."},{"content":"Governs how much time skew the replay mechanism can tolerate between the client and the server.","pos":[2370,2465]},{"content":"The security mechanism examines the time stamp sent and determines whether it was sent too far back in the past.","pos":[2466,2578]},{"content":"The default is 5 minutes.","pos":[2579,2604]},{"content":"<ph id=\"ph1\">`ReplayWindow`</ph>.","pos":[2618,2633],"source":"`ReplayWindow`."},{"content":"A <ph id=\"ph1\">`TimeSpan`</ph> value.","pos":[2634,2653],"source":" A `TimeSpan` value."},{"content":"This governs how long a message can live in the network after the server sends it (through intermediaries) before reaching the client.","pos":[2654,2788]},{"content":"The client tracks the signatures of the messages sent within the latest <ph id=\"ph1\">`ReplayWindow`</ph> for the purposes of replay detection.","pos":[2789,2913],"source":" The client tracks the signatures of the messages sent within the latest `ReplayWindow` for the purposes of replay detection."},{"content":"<ph id=\"ph1\">`ReplayCacheSize`</ph>.","pos":[2927,2945],"source":"`ReplayCacheSize`."},{"content":"An integer value.","pos":[2946,2963]},{"content":"The client stores the signatures of the message in a cache.","pos":[2964,3023]},{"content":"This setting specifies how many signatures the cache can store.","pos":[3024,3087]},{"content":"If the number of messages sent within the last replay window reaches the cache limit, new messages are rejected until the oldest cached signatures reach the time limit.","pos":[3088,3256]},{"content":"The default is 500000.","pos":[3257,3279]},{"pos":[3289,3342],"content":"To control replay detection on the service using code","linkify":"To control replay detection on the service using code","nodes":[{"content":"To control replay detection on the service using code","pos":[0,53]}]},{"pos":[3352,3482],"content":"Create a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement&gt;</ph> to use in a <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.CustomBinding&gt;</ph>.","source":"Create a <xref:System.ServiceModel.Channels.SecurityBindingElement> to use in a <xref:System.ServiceModel.Channels.CustomBinding>."},{"pos":[3492,3740],"content":"Use the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.LocalServiceSettings%2A&gt;</ph> property to return a reference to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.LocalServiceSecuritySettings&gt;</ph> class, and set the properties as described previously.","source":"Use the <xref:System.ServiceModel.Channels.SecurityBindingElement.LocalServiceSettings%2A> property to return a reference to the <xref:System.ServiceModel.Channels.LocalServiceSecuritySettings> class, and set the properties as described previously."},{"pos":[3750,3820],"content":"To control replay detection in configuration for the client or service","linkify":"To control replay detection in configuration for the client or service","nodes":[{"content":"To control replay detection in configuration for the client or service","pos":[0,70]}]},{"pos":[3830,3934],"content":"Create a <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>customBinding&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)</ept>.","source":"Create a [\\<customBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/custombinding.md)."},{"pos":[3944,3974],"content":"Create a <ph id=\"ph1\">`&lt;security&gt;`</ph> element.","source":"Create a `<security>` element."},{"pos":[3984,4228],"content":"Create a <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>localClientSettings&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/localclientsettings-element.md)</ept> or <bpt id=\"p2\">[</bpt><ph id=\"ph2\">\\&lt;</ph>localServiceSettings&gt;<ept id=\"p2\">](../../../../docs/framework/configure-apps/file-schema/wcf/localservicesettings-element.md)</ept>.","source":"Create a [\\<localClientSettings>](../../../../docs/framework/configure-apps/file-schema/wcf/localclientsettings-element.md) or [\\<localServiceSettings>](../../../../docs/framework/configure-apps/file-schema/wcf/localservicesettings-element.md)."},{"content":"Set the following attribute values, as appropriate: <ph id=\"ph1\">`detectReplays`</ph>, <ph id=\"ph2\">`maxClockSkew`</ph>, <ph id=\"ph3\">`replayWindow`</ph>, and <ph id=\"ph4\">`replayCacheSize`</ph>.","pos":[4238,4361],"source":"Set the following attribute values, as appropriate: `detectReplays`, `maxClockSkew`, `replayWindow`, and `replayCacheSize`."},{"content":"The following example sets the attributes of both a <ph id=\"ph1\">`&lt;localServiceSettings&gt;`</ph> and a <ph id=\"ph2\">`&lt;localClientSettings&gt;`</ph> element:","pos":[4362,4477],"source":" The following example sets the attributes of both a `<localServiceSettings>` and a `<localClientSettings>` element:"},{"pos":[5045,5052],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[5056,5311],"content":"The following example creates a <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement&gt;</ph> using the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A&gt;</ph> method, and sets the replay properties of the binding.","source":"The following example creates a <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> using the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> method, and sets the replay properties of the binding."},{"pos":[5572,5610],"content":"Scope of Replay: Message Security Only","linkify":"Scope of Replay: Message Security Only","nodes":[{"content":"Scope of Replay: Message Security Only","pos":[0,38]}]},{"content":"Note that the following procedures apply only to Message security mode.","pos":[5614,5685]},{"content":"For Transport and Transport with Message Credential modes, the transport mechanisms detect replays.","pos":[5686,5785]},{"pos":[5794,5819],"content":"Secure Conversation Notes","linkify":"Secure Conversation Notes","nodes":[{"content":"Secure Conversation Notes","pos":[0,25]}]},{"content":"For bindings that enable secure conversations, you can adjust these settings both for the application channel as well as for the secure conversation bootstrap binding.","pos":[5823,5990]},{"content":"For example, you can turn off replays for the application channel but enable them for the bootstrap channel that establishes the secure conversation.","pos":[5991,6140]},{"content":"If you do not use secure conversation sessions, replay detection does not guarantee detecting replays in server farm scenarios and when the process is recycled.","pos":[6147,6307]},{"content":"This applies to the following system-provided bindings:","pos":[6308,6363]},{"pos":[6373,6417],"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.BasicHttpBinding&gt;</ph>.","source":"<xref:System.ServiceModel.BasicHttpBinding>."},{"pos":[6427,6587],"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.WSHttpBinding&gt;</ph> with the <ph id=\"ph2\">&lt;xref:System.ServiceModel.NonDualMessageSecurityOverHttp.EstablishSecurityContext%2A&gt;</ph> property set to <ph id=\"ph3\">`false`</ph>.","source":"<xref:System.ServiceModel.WSHttpBinding> with the <xref:System.ServiceModel.NonDualMessageSecurityOverHttp.EstablishSecurityContext%2A> property set to `false`."},{"pos":[6596,6614],"content":"Compiling the Code","linkify":"Compiling the Code","nodes":[{"content":"Compiling the Code","pos":[0,18]}]},{"content":"The following namespaces are required to compile the code:","pos":[6624,6682]},{"pos":[6795,6803],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Secure Conversations and Secure Sessions<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/secure-conversations-and-secure-sessions.md)</ept><ph id=\"ph1\"> </ph>","pos":[6944,7079],"source":"[Secure Conversations and Secure Sessions](../../../../docs/framework/wcf/feature-details/secure-conversations-and-secure-sessions.md) "},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>localClientSettings&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/localclientsettings-element.md)</ept><ph id=\"ph2\"> </ph>","pos":[7083,7198],"source":"[\\<localClientSettings>](../../../../docs/framework/configure-apps/file-schema/wcf/localclientsettings-element.md) "},{"content":"<bpt id=\"p1\">[</bpt>How to: Create a Custom Binding Using the SecurityBindingElement<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/how-to-create-a-custom-binding-using-the-securitybindingelement.md)</ept>","pos":[7202,7383],"source":"[How to: Create a Custom Binding Using the SecurityBindingElement](../../../../docs/framework/wcf/feature-details/how-to-create-a-custom-binding-using-the-securitybindingelement.md)"}]}