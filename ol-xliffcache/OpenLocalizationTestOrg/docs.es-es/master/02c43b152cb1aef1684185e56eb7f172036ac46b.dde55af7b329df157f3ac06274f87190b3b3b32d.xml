{"content":"---\ntitle: \"Configuring Message Flow Tracing\"\nms.date: \"03/30/2017\"\nms.assetid: 15571ca2-bee2-47fb-ba10-fcbc09152ad0\n---\n# Configuring Message Flow Tracing\nWhen Windows Communication Foundation (WCF) activity tracing is enabled, End-To-End Activity IDs are assigned to logical activities throughout the WCF stack. In [!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)], there is now a higher performance version of this feature that works with Event Tracing for Windows (ETW) called message flow tracing. When enabled, End-To-End activity IDs are taken from (or assigned to if empty) incoming messages and are propagated to all tracing events that are emitted after the message has been decoded by the channel. Customers can use this feature to reconstruct message flows with trace logs from different services after decoding.  \n  \n Tracing can be enabled after a problem is detected with the application and then disabled once the problem is resolved.  \n  \n## Enabling Tracing  \n You can enable message flow tracing by setting the .NET Framework 4 `messageFlowTracing` configuration element to `true`, as shown in the following example.  \n  \n```xml  \n<system.servicemodel>  \n  <diagnostics>  \n    <endToEndTracing propagateActivity=\"true\" messageFlowTracing=\"true\" />  \n  </diagnostics>  \n</system.servicemodel>  \n```  \n  \n> [!NOTE]\n>  Because the `endToEndTracing` configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW. For the `endToEndTracing` configuration element to take effect, the application must be recycled.  \n  \n Activities are correlated by the interchange of an identifier called the activity ID. This identifier is a GUID, and is generated by the System.Diagnostics.CorrelationManager class. If you manipulate System.Diagnostics.Trace.CorrelationManager.ActivityID, ensure that the value is set to original when execution control transfers back to WCF code.  Also, if you use an asynchronous WCF programming model ensure that System.Diagnostics.Trace.CorrelationManager.ActivityID is transferred between the threads.  \n  \n## Message Flow Tracing and REST Services  \n Message flow tracing allows you to trace a request end to end.  With SOAP-based services an Activity ID is sent in a SOAP message header. REST requests do not contain this header so a special HTTP event header is used instead. The following code snippet shows how you can programmatically retrieve the Activity ID value:  \n  \n```csharp\nObject output = null;\nif (OperationContext.Current.IncomingMessageProperties.TryGetValue(HttpRequestMessageProperty.Name, out output))\n{\n   HttpRequestMessageProperty httpHeaders = output as HttpRequestMessageProperty;\n   // Retrieve the Activity Id from the HTTP header    string e2eId = httpHeaders.Headers[\"E2EActivity\"];\n   // ...\n}\n```\n\n You can programmatically add the header using the following code:  \n  \n```csharp  \nHttpContent content = new StreamContent(contentStream);  \nGuid correlation = Guid.NewGuid();  \ncontent.Headers.Add(\"E2EActivity\", Convert.ToBase64String(correlation.ToByteArray()));  \n```\n","nodes":[{"pos":[4,116],"embed":true,"restype":"x-metadata","content":"title: \"Configuring Message Flow Tracing\"\nms.date: \"03/30/2017\"\nms.assetid: 15571ca2-bee2-47fb-ba10-fcbc09152ad0","nodes":[{"content":"Configuring Message Flow Tracing","nodes":[{"pos":[0,32],"content":"Configuring Message Flow Tracing","nodes":[{"content":"Configuring Message Flow Tracing","pos":[0,32]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[123,155],"content":"Configuring Message Flow Tracing","linkify":"Configuring Message Flow Tracing","nodes":[{"content":"Configuring Message Flow Tracing","pos":[0,32]}]},{"content":"When Windows Communication Foundation (WCF) activity tracing is enabled, End-To-End Activity IDs are assigned to logical activities throughout the WCF stack.","pos":[156,313]},{"content":"In <ph id=\"ph1\">[!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)]</ph>, there is now a higher performance version of this feature that works with Event Tracing for Windows (ETW) called message flow tracing.","pos":[314,535],"source":" In [!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)], there is now a higher performance version of this feature that works with Event Tracing for Windows (ETW) called message flow tracing."},{"content":"When enabled, End-To-End activity IDs are taken from (or assigned to if empty) incoming messages and are propagated to all tracing events that are emitted after the message has been decoded by the channel.","pos":[536,741]},{"content":"Customers can use this feature to reconstruct message flows with trace logs from different services after decoding.","pos":[742,857]},{"content":"Tracing can be enabled after a problem is detected with the application and then disabled once the problem is resolved.","pos":[864,983]},{"pos":[992,1008],"content":"Enabling Tracing","linkify":"Enabling Tracing","nodes":[{"content":"Enabling Tracing","pos":[0,16]}]},{"pos":[1012,1168],"content":"You can enable message flow tracing by setting the .NET Framework 4 <ph id=\"ph1\">`messageFlowTracing`</ph> configuration element to <ph id=\"ph2\">`true`</ph>, as shown in the following example.","source":"You can enable message flow tracing by setting the .NET Framework 4 `messageFlowTracing` configuration element to `true`, as shown in the following example."},{"pos":[1357,1607],"content":"[!NOTE]\n Because the `endToEndTracing` configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW. For the `endToEndTracing` configuration element to take effect, the application must be recycled.","leadings":["","> "],"nodes":[{"content":"Because the `endToEndTracing` configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW. For the `endToEndTracing` configuration element to take effect, the application must be recycled.","pos":[9,248],"nodes":[{"content":"Because the <ph id=\"ph1\">`endToEndTracing`</ph> configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW.","pos":[0,141],"source":"Because the `endToEndTracing` configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW."},{"content":"For the <ph id=\"ph1\">`endToEndTracing`</ph> configuration element to take effect, the application must be recycled.","pos":[142,239],"source":" For the `endToEndTracing` configuration element to take effect, the application must be recycled."}]}]},{"content":"Activities are correlated by the interchange of an identifier called the activity ID.","pos":[1614,1699]},{"content":"This identifier is a GUID, and is generated by the System.Diagnostics.CorrelationManager class.","pos":[1700,1795]},{"content":"If you manipulate System.Diagnostics.Trace.CorrelationManager.ActivityID, ensure that the value is set to original when execution control transfers back to WCF code.","pos":[1796,1961]},{"content":"Also, if you use an asynchronous WCF programming model ensure that System.Diagnostics.Trace.CorrelationManager.ActivityID is transferred between the threads.","pos":[1963,2120]},{"pos":[2129,2167],"content":"Message Flow Tracing and REST Services","linkify":"Message Flow Tracing and REST Services","nodes":[{"content":"Message Flow Tracing and REST Services","pos":[0,38]}]},{"content":"Message flow tracing allows you to trace a request end to end.","pos":[2171,2233]},{"content":"With SOAP-based services an Activity ID is sent in a SOAP message header.","pos":[2235,2308]},{"content":"REST requests do not contain this header so a special HTTP event header is used instead.","pos":[2309,2397]},{"content":"The following code snippet shows how you can programmatically retrieve the Activity ID value:","pos":[2398,2491]},{"content":"You can programmatically add the header using the following code:","pos":[2850,2915]}]}