{"content":"---\ntitle: \"Transaction and Bulk Copy Operations\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62\n---\n# Transaction and Bulk Copy Operations\nBulk copy operations can be performed as isolated operations or as part of a multiple step transaction. This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.  \n  \n By default, a bulk copy operation is performed as an isolated operation. The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back. If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.  \n  \n## Performing a Non-transacted Bulk Copy Operation  \n The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.  \n  \n In the example, the source table and destination table each include an `Identity` column named **ProductID**. The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table. By default, a new value for the `Identity` column is generated in the destination table for each row added. In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.  \n  \n The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10. When the operation encounters the invalid row, an exception is thrown. In this first example, the bulk copy operation is non-transacted. All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.  \n  \n> [!NOTE]\n>  This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.  \n  \n [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]\n [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  \n  \n## Performing a Dedicated Bulk Copy Operation in a Transaction  \n By default, a bulk copy operation is its own transaction. When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction. In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.  \n  \n You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.  \n  \n> [!NOTE]\n>  Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.  \n  \n The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions. All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.  \n  \n> [!IMPORTANT]\n>  This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.  \n  \n [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]\n [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  \n  \n## Using Existing Transactions  \n You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor. In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted). This allows an application to include the bulk copy operation in a transaction with other database operations. However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.  \n  \n If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.  \n  \n The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction. When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.  \n  \n> [!IMPORTANT]\n>  This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.  \n  \n [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]\n [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  \n  \n## See also\n\n- [Bulk Copy Operations in SQL Server](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)\n- [ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)\n","nodes":[{"pos":[4,154],"embed":true,"restype":"x-metadata","content":"title: \"Transaction and Bulk Copy Operations\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62","nodes":[{"content":"Transaction and Bulk Copy Operations","nodes":[{"pos":[0,36],"content":"Transaction and Bulk Copy Operations","nodes":[{"content":"Transaction and Bulk Copy Operations","pos":[0,36]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[161,197],"content":"Transaction and Bulk Copy Operations","linkify":"Transaction and Bulk Copy Operations","nodes":[{"content":"Transaction and Bulk Copy Operations","pos":[0,36]}]},{"content":"Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.","pos":[198,301]},{"content":"This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.","pos":[302,561]},{"content":"By default, a bulk copy operation is performed as an isolated operation.","pos":[568,640]},{"content":"The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.","pos":[641,737]},{"content":"If you need to roll back all or part of the bulk copy when an error occurs, you can use a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlBulkCopy&gt;</ph>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a <bpt id=\"p1\">**</bpt>System.Transactions<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;xref:System.Transactions.Transaction&gt;</ph>.","pos":[738,1036],"source":" If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>."},{"pos":[1045,1092],"content":"Performing a Non-transacted Bulk Copy Operation","linkify":"Performing a Non-transacted Bulk Copy Operation","nodes":[{"content":"Performing a Non-transacted Bulk Copy Operation","pos":[0,47]}]},{"content":"The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.","pos":[1096,1241]},{"content":"In the example, the source table and destination table each include an <ph id=\"ph1\">`Identity`</ph> column named <bpt id=\"p1\">**</bpt>ProductID<ept id=\"p1\">**</ept>.","pos":[1248,1357],"source":"In the example, the source table and destination table each include an `Identity` column named **ProductID**."},{"content":"The code first prepares the destination table by deleting all rows and then inserting a single row whose <bpt id=\"p1\">**</bpt>ProductID<ept id=\"p1\">**</ept> is known to exist in the source table.","pos":[1358,1515],"source":" The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table."},{"content":"By default, a new value for the <ph id=\"ph1\">`Identity`</ph> column is generated in the destination table for each row added.","pos":[1516,1623],"source":" By default, a new value for the `Identity` column is generated in the destination table for each row added."},{"content":"In this example, an option is set when the connection is opened that forces the bulk load process to use the <ph id=\"ph1\">`Identity`</ph> values from the source table instead.","pos":[1624,1781],"source":" In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead."},{"content":"The bulk copy operation is executed with the <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A&gt;</ph> property set to 10.","pos":[1788,1906],"source":"The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10."},{"content":"When the operation encounters the invalid row, an exception is thrown.","pos":[1907,1977]},{"content":"In this first example, the bulk copy operation is non-transacted.","pos":[1978,2043]},{"content":"All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.","pos":[2044,2236]},{"pos":[2244,2729],"content":"[!NOTE]\n This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.","leadings":["","> "],"nodes":[{"content":"This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.","pos":[9,483],"nodes":[{"content":"This sample will not run unless you have created the work tables as described in <bpt id=\"p1\">[</bpt>Bulk Copy Example Setup<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)</ept>.","pos":[0,181],"source":"This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)."},{"content":"This code is provided to demonstrate the syntax for using <bpt id=\"p1\">**</bpt>SqlBulkCopy<ept id=\"p1\">**</ept> only.","pos":[182,261],"source":" This code is provided to demonstrate the syntax for using **SqlBulkCopy** only."},{"content":"If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a <ph id=\"ph1\">[!INCLUDE[tsql](../../../../../includes/tsql-md.md)]</ph><ph id=\"ph2\">`INSERT … SELECT`</ph> statement to copy the data.","pos":[262,474],"source":" If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data."}]}]},{"pos":[3096,3155],"content":"Performing a Dedicated Bulk Copy Operation in a Transaction","linkify":"Performing a Dedicated Bulk Copy Operation in a Transaction","nodes":[{"content":"Performing a Dedicated Bulk Copy Operation in a Transaction","pos":[0,59]}]},{"content":"By default, a bulk copy operation is its own transaction.","pos":[3159,3216]},{"content":"When you want to perform a dedicated bulk copy operation, create a new instance of <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlBulkCopy&gt;</ph> with a connection string, or use an existing <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlConnection&gt;</ph> object without an active transaction.","pos":[3217,3466],"source":" When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction."},{"content":"In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.","pos":[3467,3565]},{"pos":[3572,3911],"content":"You can explicitly specify the <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction&gt;</ph> option in the <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlBulkCopy&gt;</ph> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.","source":"You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction."},{"pos":[3919,4159],"content":"[!NOTE]\n Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.","leadings":["","> "],"nodes":[{"content":"Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.","pos":[9,238]}]},{"content":"The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.","pos":[4166,4326]},{"content":"All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.","pos":[4327,4519]},{"pos":[4527,5017],"content":"[!IMPORTANT]\n This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.","leadings":["","> "],"nodes":[{"content":"This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.","pos":[14,488],"nodes":[{"content":"This sample will not run unless you have created the work tables as described in <bpt id=\"p1\">[</bpt>Bulk Copy Example Setup<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)</ept>.","pos":[0,181],"source":"This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)."},{"content":"This code is provided to demonstrate the syntax for using <bpt id=\"p1\">**</bpt>SqlBulkCopy<ept id=\"p1\">**</ept> only.","pos":[182,261],"source":" This code is provided to demonstrate the syntax for using **SqlBulkCopy** only."},{"content":"If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a <ph id=\"ph1\">[!INCLUDE[tsql](../../../../../includes/tsql-md.md)]</ph><ph id=\"ph2\">`INSERT … SELECT`</ph> statement to copy the data.","pos":[262,474],"source":" If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data."}]}]},{"pos":[5388,5415],"content":"Using Existing Transactions","linkify":"Using Existing Transactions","nodes":[{"content":"Using Existing Transactions","pos":[0,27]}]},{"content":"You can specify an existing <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlTransaction&gt;</ph> object as a parameter in a <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlBulkCopy&gt;</ph> constructor.","pos":[5419,5571],"source":"You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor."},{"content":"In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).","pos":[5572,5750]},{"content":"This allows an application to include the bulk copy operation in a transaction with other database operations.","pos":[5751,5861]},{"content":"However, if you do not specify a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlTransaction&gt;</ph> object and pass a null reference, and the connection has an active transaction, an exception is thrown.","pos":[5862,6042],"source":" However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown."},{"pos":[6049,6347],"content":"If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <ph id=\"ph1\">&lt;xref:System.Data.SqlClient.SqlTransaction&gt;</ph> object to the <ph id=\"ph2\">&lt;xref:System.Data.SqlClient.SqlBulkCopy&gt;</ph> constructor.","source":"If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor."},{"content":"The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.","pos":[6354,6545]},{"content":"When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.","pos":[6546,6676]},{"pos":[6684,7174],"content":"[!IMPORTANT]\n This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.","leadings":["","> "],"nodes":[{"content":"This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). This code is provided to demonstrate the syntax for using **SqlBulkCopy** only. If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.","pos":[14,488],"nodes":[{"content":"This sample will not run unless you have created the work tables as described in <bpt id=\"p1\">[</bpt>Bulk Copy Example Setup<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)</ept>.","pos":[0,181],"source":"This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)."},{"content":"This code is provided to demonstrate the syntax for using <bpt id=\"p1\">**</bpt>SqlBulkCopy<ept id=\"p1\">**</ept> only.","pos":[182,261],"source":" This code is provided to demonstrate the syntax for using **SqlBulkCopy** only."},{"content":"If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a <ph id=\"ph1\">[!INCLUDE[tsql](../../../../../includes/tsql-md.md)]</ph><ph id=\"ph2\">`INSERT … SELECT`</ph> statement to copy the data.","pos":[262,474],"source":" If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data."}]}]},{"pos":[7525,7533],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[7537,7658],"content":"<bpt id=\"p1\">[</bpt>Bulk Copy Operations in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)</ept>","source":"[Bulk Copy Operations in SQL Server](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)"},{"pos":[7661,7765],"content":"<bpt id=\"p1\">[</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=217917)</ept>","source":"[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)"}]}