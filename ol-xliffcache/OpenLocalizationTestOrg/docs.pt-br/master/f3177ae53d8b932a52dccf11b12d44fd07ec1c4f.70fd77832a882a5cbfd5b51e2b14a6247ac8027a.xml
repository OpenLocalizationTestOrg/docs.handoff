{"content":"---\ntitle: \"Mitigation: New 64-bit JIT Compiler\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"JIT compiler, 64-bit\"\n  - \"JIT compilation, 64-bit\"\n  - \"RyuJIT compiler\"\nms.assetid: 0332dabc-72c5-4bdc-8975-20d717802b17\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# Mitigation: New 64-bit JIT Compiler\nStarting with the .NET Framework 4.6, the runtime includes a new 64-bit JIT compiler for just-in-time compilation. This change does not affect compilation with the  32-bit JIT compiler.  \n  \n## Unexpected behavior or exceptions  \n In some cases, compilation with the new 64-bit JIT compiler results in a runtime exception or in behavior that is not observed when executing code compiled by the older 64-bit JIT compiler. The known differences include the following:  \n  \n> [!IMPORTANT]\n>  All of these known issues have been addressed in the new 64-bit compiler released with the .NET Framework 4.6.2. Most have also been addressed in service releases of the .NET Framework 4.6 and 4.6.1 that are included with Windows Update. You can eliminate these issues by ensuring that your version of Windows is up to date, or by upgrading to the .NET Framework 4.6.2.  \n  \n-   Under certain conditions, an unboxing operation may throw a <xref:System.NullReferenceException> in Release builds with optimization turned on.  \n  \n-   In some cases, execution of production code in a large method body may throw a <xref:System.StackOverflowException>.  \n  \n-   Under certain conditions, structures passed to a method are treated as reference types rather than value types in Release builds. One of the manifestations of this issue is that the individual items in a collection appear in an unexpected order.  \n  \n-   Under certain conditions, the comparison of <xref:System.UInt16> values with their high bit set is incorrect if optimization is enabled.  \n  \n-   Under certain conditions, particularly when initializing array values, memory initialization by the <xref:System.Reflection.Emit.OpCodes.Initblk?displayProperty=nameWithType> IL instruction may initialize memory with an incorrect value. This can result either in an unhandled exception or incorrect output.  \n  \n-   Under certain rare conditions, a conditional bit test can return the incorrect <xref:System.Boolean> value or throw an exception if compiler optimizations are enabled.  \n  \n-   Under certain conditions, if an `if` statement is used to test for a condition before entering  a `try` block and in the exit from the `try` block, and the same condition is evaluated in the `catch` or `finally` block, the new 64-bit JIT compiler removes the `if` condition from the `catch` or `finally` block when it optimizes code. As a result, code inside the `if` statement in the `catch` or `finally` block is executed unconditionally.  \n  \n<a name=\"General\"></a>   \n## Mitigation of known issues  \n If you encounter the issues listed above, you can address them by doing any of the following:  \n  \n-   Upgrade to the .NET Framework 4.6.2. The new 64-bit compiler included with the .NET Framework 4.6.2 addresses each of these known issues.  \n  \n-   Ensure that your version of Windows is up to date by running Windows Update. Service updates to the .NET Framework 4.6 and 4.6.1 address each of these issues except the <xref:System.NullReferenceException> in an unboxing operation.  \n  \n-   Compile with the older 64-bit JIT compiler. See the [Mitigation of other issues](#Other) section for more information on how to do this.  \n  \n<a name=\"Other\"></a>   \n## Mitigation of other issues  \n If you encounter any other difference in behavior between code compiled with the older 64-bit compiler and the new 64-bit JIT compiler, or between the debug and release versions of your app that are both compiled with the new 64-bit JIT compiler, you can do the following to compile your app with the older 64-bit JIT compiler:  \n  \n-   On a per-application basis, you can add the [\\<useLegacyJit>](../../../docs/framework/configure-apps/file-schema/runtime/uselegacyjit-element.md) element to your application's configuration file. The following disables compilation with the new 64-bit JIT compiler and instead uses the legacy 64-bit JIT compiler.  \n  \n    ```xml  \n    <?xml version =\"1.0\"?>  \n    <configuration>  \n        <runtime>  \n           <useLegacyJit enabled=\"1\" />  \n        </runtime>  \n    </configuration>  \n    ```  \n  \n-   On a per-user basis, you can add a `REG_DWORD` value named `useLegacyJit` to the `HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\.NETFramework` key of the registry. A value of 1 enables the legacy 64-bit JIT compiler; a value of 0 disables it and enables the new 64-bit JIT compiler.  \n  \n-   On a per-machine basis, you can add a `REG_DWORD` value named `useLegacyJit` to the `HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\.NETFramework` key of the registry. A value of 1 enables the legacy 64-bit JIT compiler; a value of 0 disables it and enables the new 64-bit JIT compiler.  \n  \n You can also let us know about the problem by reporting a bug on [Microsoft Connect](https://connect.microsoft.com/VisualStudio).  \n  \n## See also\n\n- [Runtime Changes](../../../docs/framework/migration-guide/runtime-changes-in-the-net-framework-4-6.md)\n- [\\<useLegacyJit> Element](../../../docs/framework/configure-apps/file-schema/runtime/uselegacyjit-element.md)\n","nodes":[{"pos":[4,260],"embed":true,"restype":"x-metadata","content":"title: \"Mitigation: New 64-bit JIT Compiler\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"JIT compiler, 64-bit\"\n  - \"JIT compilation, 64-bit\"\n  - \"RyuJIT compiler\"\nms.assetid: 0332dabc-72c5-4bdc-8975-20d717802b17\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"Mitigation: New 64-bit JIT Compiler","nodes":[{"pos":[0,35],"content":"Mitigation: New 64-bit JIT Compiler","nodes":[{"content":"Mitigation: New 64-bit JIT Compiler","pos":[0,35]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[267,302],"content":"Mitigation: New 64-bit JIT Compiler","linkify":"Mitigation: New 64-bit JIT Compiler","nodes":[{"content":"Mitigation: New 64-bit JIT Compiler","pos":[0,35]}]},{"content":"Starting with the .NET Framework 4.6, the runtime includes a new 64-bit JIT compiler for just-in-time compilation.","pos":[303,417]},{"content":"This change does not affect compilation with the  32-bit JIT compiler.","pos":[418,488]},{"pos":[497,530],"content":"Unexpected behavior or exceptions","linkify":"Unexpected behavior or exceptions","nodes":[{"content":"Unexpected behavior or exceptions","pos":[0,33]}]},{"content":"In some cases, compilation with the new 64-bit JIT compiler results in a runtime exception or in behavior that is not observed when executing code compiled by the older 64-bit JIT compiler.","pos":[534,723]},{"content":"The known differences include the following:","pos":[724,768]},{"pos":[776,1161],"content":"[!IMPORTANT]\n All of these known issues have been addressed in the new 64-bit compiler released with the .NET Framework 4.6.2. Most have also been addressed in service releases of the .NET Framework 4.6 and 4.6.1 that are included with Windows Update. You can eliminate these issues by ensuring that your version of Windows is up to date, or by upgrading to the .NET Framework 4.6.2.","leadings":["","> "],"nodes":[{"content":"All of these known issues have been addressed in the new 64-bit compiler released with the .NET Framework 4.6.2. Most have also been addressed in service releases of the .NET Framework 4.6 and 4.6.1 that are included with Windows Update. You can eliminate these issues by ensuring that your version of Windows is up to date, or by upgrading to the .NET Framework 4.6.2.","pos":[14,383],"nodes":[{"content":"All of these known issues have been addressed in the new 64-bit compiler released with the .NET Framework 4.6.2.","pos":[0,112]},{"content":"Most have also been addressed in service releases of the .NET Framework 4.6 and 4.6.1 that are included with Windows Update.","pos":[113,237]},{"content":"You can eliminate these issues by ensuring that your version of Windows is up to date, or by upgrading to the .NET Framework 4.6.2.","pos":[238,369]}]}]},{"pos":[1171,1314],"content":"Under certain conditions, an unboxing operation may throw a <ph id=\"ph1\">&lt;xref:System.NullReferenceException&gt;</ph> in Release builds with optimization turned on.","source":"Under certain conditions, an unboxing operation may throw a <xref:System.NullReferenceException> in Release builds with optimization turned on."},{"pos":[1324,1440],"content":"In some cases, execution of production code in a large method body may throw a <ph id=\"ph1\">&lt;xref:System.StackOverflowException&gt;</ph>.","source":"In some cases, execution of production code in a large method body may throw a <xref:System.StackOverflowException>."},{"content":"Under certain conditions, structures passed to a method are treated as reference types rather than value types in Release builds.","pos":[1450,1579]},{"content":"One of the manifestations of this issue is that the individual items in a collection appear in an unexpected order.","pos":[1580,1695]},{"pos":[1705,1841],"content":"Under certain conditions, the comparison of <ph id=\"ph1\">&lt;xref:System.UInt16&gt;</ph> values with their high bit set is incorrect if optimization is enabled.","source":"Under certain conditions, the comparison of <xref:System.UInt16> values with their high bit set is incorrect if optimization is enabled."},{"content":"Under certain conditions, particularly when initializing array values, memory initialization by the <ph id=\"ph1\">&lt;xref:System.Reflection.Emit.OpCodes.Initblk?displayProperty=nameWithType&gt;</ph> IL instruction may initialize memory with an incorrect value.","pos":[1851,2087],"source":"Under certain conditions, particularly when initializing array values, memory initialization by the <xref:System.Reflection.Emit.OpCodes.Initblk?displayProperty=nameWithType> IL instruction may initialize memory with an incorrect value."},{"content":"This can result either in an unhandled exception or incorrect output.","pos":[2088,2157]},{"pos":[2167,2334],"content":"Under certain rare conditions, a conditional bit test can return the incorrect <ph id=\"ph1\">&lt;xref:System.Boolean&gt;</ph> value or throw an exception if compiler optimizations are enabled.","source":"Under certain rare conditions, a conditional bit test can return the incorrect <xref:System.Boolean> value or throw an exception if compiler optimizations are enabled."},{"content":"Under certain conditions, if an <ph id=\"ph1\">`if`</ph> statement is used to test for a condition before entering  a <ph id=\"ph2\">`try`</ph> block and in the exit from the <ph id=\"ph3\">`try`</ph> block, and the same condition is evaluated in the <ph id=\"ph4\">`catch`</ph> or <ph id=\"ph5\">`finally`</ph> block, the new 64-bit JIT compiler removes the <ph id=\"ph6\">`if`</ph> condition from the <ph id=\"ph7\">`catch`</ph> or <ph id=\"ph8\">`finally`</ph> block when it optimizes code.","pos":[2344,2677],"source":"Under certain conditions, if an `if` statement is used to test for a condition before entering  a `try` block and in the exit from the `try` block, and the same condition is evaluated in the `catch` or `finally` block, the new 64-bit JIT compiler removes the `if` condition from the `catch` or `finally` block when it optimizes code."},{"content":"As a result, code inside the <ph id=\"ph1\">`if`</ph> statement in the <ph id=\"ph2\">`catch`</ph> or <ph id=\"ph3\">`finally`</ph> block is executed unconditionally.","pos":[2678,2784],"source":" As a result, code inside the `if` statement in the `catch` or `finally` block is executed unconditionally."},{"pos":[2819,2845],"content":"Mitigation of known issues","linkify":"Mitigation of known issues","nodes":[{"content":"Mitigation of known issues","pos":[0,26]}]},{"content":"If you encounter the issues listed above, you can address them by doing any of the following:","pos":[2849,2942]},{"content":"Upgrade to the .NET Framework 4.6.2.","pos":[2952,2988]},{"content":"The new 64-bit compiler included with the .NET Framework 4.6.2 addresses each of these known issues.","pos":[2989,3089]},{"content":"Ensure that your version of Windows is up to date by running Windows Update.","pos":[3099,3175]},{"content":"Service updates to the .NET Framework 4.6 and 4.6.1 address each of these issues except the <ph id=\"ph1\">&lt;xref:System.NullReferenceException&gt;</ph> in an unboxing operation.","pos":[3176,3330],"source":" Service updates to the .NET Framework 4.6 and 4.6.1 address each of these issues except the <xref:System.NullReferenceException> in an unboxing operation."},{"content":"Compile with the older 64-bit JIT compiler.","pos":[3340,3383]},{"content":"See the <bpt id=\"p1\">[</bpt>Mitigation of other issues<ept id=\"p1\">](#Other)</ept> section for more information on how to do this.","pos":[3384,3476],"source":" See the [Mitigation of other issues](#Other) section for more information on how to do this."},{"pos":[3509,3535],"content":"Mitigation of other issues","linkify":"Mitigation of other issues","nodes":[{"content":"Mitigation of other issues","pos":[0,26]}]},{"content":"If you encounter any other difference in behavior between code compiled with the older 64-bit compiler and the new 64-bit JIT compiler, or between the debug and release versions of your app that are both compiled with the new 64-bit JIT compiler, you can do the following to compile your app with the older 64-bit JIT compiler:","pos":[3539,3866]},{"content":"On a per-application basis, you can add the <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>useLegacyJit&gt;<ept id=\"p1\">](../../../docs/framework/configure-apps/file-schema/runtime/uselegacyjit-element.md)</ept> element to your application's configuration file.","pos":[3876,4071],"source":"On a per-application basis, you can add the [\\<useLegacyJit>](../../../docs/framework/configure-apps/file-schema/runtime/uselegacyjit-element.md) element to your application's configuration file."},{"content":"The following disables compilation with the new 64-bit JIT compiler and instead uses the legacy 64-bit JIT compiler.","pos":[4072,4188]},{"content":"On a per-user basis, you can add a <ph id=\"ph1\">`REG_DWORD`</ph> value named <ph id=\"ph2\">`useLegacyJit`</ph> to the <ph id=\"ph3\">`HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\.NETFramework`</ph> key of the registry.","pos":[4381,4535],"source":"On a per-user basis, you can add a `REG_DWORD` value named `useLegacyJit` to the `HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\.NETFramework` key of the registry."},{"content":"A value of 1 enables the legacy 64-bit JIT compiler; a value of 0 disables it and enables the new 64-bit JIT compiler.","pos":[4536,4654]},{"content":"On a per-machine basis, you can add a <ph id=\"ph1\">`REG_DWORD`</ph> value named <ph id=\"ph2\">`useLegacyJit`</ph> to the <ph id=\"ph3\">`HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\.NETFramework`</ph> key of the registry.","pos":[4664,4822],"source":"On a per-machine basis, you can add a `REG_DWORD` value named `useLegacyJit` to the `HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\.NETFramework` key of the registry."},{"content":"A value of 1 enables the legacy 64-bit JIT compiler; a value of 0 disables it and enables the new 64-bit JIT compiler.","pos":[4823,4941]},{"pos":[4948,5077],"content":"You can also let us know about the problem by reporting a bug on <bpt id=\"p1\">[</bpt>Microsoft Connect<ept id=\"p1\">](https://connect.microsoft.com/VisualStudio)</ept>.","source":"You can also let us know about the problem by reporting a bug on [Microsoft Connect](https://connect.microsoft.com/VisualStudio)."},{"pos":[5086,5094],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[5098,5200],"content":"<bpt id=\"p1\">[</bpt>Runtime Changes<ept id=\"p1\">](../../../docs/framework/migration-guide/runtime-changes-in-the-net-framework-4-6.md)</ept>","source":"[Runtime Changes](../../../docs/framework/migration-guide/runtime-changes-in-the-net-framework-4-6.md)"},{"pos":[5203,5312],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>useLegacyJit&gt; Element<ept id=\"p1\">](../../../docs/framework/configure-apps/file-schema/runtime/uselegacyjit-element.md)</ept>","source":"[\\<useLegacyJit> Element](../../../docs/framework/configure-apps/file-schema/runtime/uselegacyjit-element.md)"}]}