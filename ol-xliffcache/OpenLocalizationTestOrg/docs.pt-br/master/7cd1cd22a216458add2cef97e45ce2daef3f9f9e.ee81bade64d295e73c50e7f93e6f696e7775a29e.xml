{"content":"---\ntitle: \"How to: create a custom security token authenticator\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"WCF, authentication\"\nms.assetid: 10e245f7-d31e-42e7-82a2-d5780325d372\n---\n# How to: create a custom security token authenticator\nThis topic shows how to create a custom security token authenticator and how to integrate it with a custom security token manager. A security token authenticator validates the content of a security token provided with an incoming message. If the validation succeeds, the authenticator returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances that, when evaluated, returns a set of claims.  \n  \n To use a custom security token authenticator in Windows Communication Foundation (WCF), you must first create custom credentials and security token manager implementations. For more information about creating custom credentials and a security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).\n  \n## Procedures  \n  \n#### To create a custom security token authenticator  \n  \n1.  Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.  \n  \n2.  Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> method. The method returns `true` or `false` depending on whether the custom authenticator can validate the incoming token type or not.  \n  \n3.  Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method. This method needs to validate the token contents appropriately. If the token passes the validation step, it returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances. The following example uses a custom authorization policy implementation that will be created in the next procedure.  \n  \n     [!code-csharp[C_CustomTokenAuthenticator#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#1)]\n     [!code-vb[C_CustomTokenAuthenticator#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#1)]  \n  \n The previous code returns a collection of authorization policies in the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> method. WCF does not provide a public implementation of this interface. The following procedure shows how to do so for your own requirements.  \n  \n#### To create a custom authorization policy  \n  \n1.  Define a new class implementing the <xref:System.IdentityModel.Policy.IAuthorizationPolicy> interface.  \n  \n2.  Implement the <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> read-only property. One way to implement this property is to generate a globally unique identifier (GUID) in the class constructor and return it every time the value for this property is requested.  \n  \n3.  Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> read-only property. This property needs to return an issuer of the claim sets that are obtained from the token. This issuer should correspond to the issuer of the token or an authority that is responsible for validating the token contents. The following example uses the issuer claim that passed to this class from the custom security token authenticator created in the previous procedure. The custom security token authenticator uses the system-provided claim set (returned by the <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property) to represent the issuer of the username token.  \n  \n4.  Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method. This method populates an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class (passed in as an argument) with claims that are based on the incoming security token content. The method returns `true` when it is done with the evaluation. In cases when the implementation relies on the presence of other authorization policies that provide additional information to the evaluation context, this method can return `false` if the required information is not present yet in the evaluation context. In that case, WCF will call the method again after evaluating all other authorization policies generated for the incoming message if at least one of those authorization policies modified the evaluation context.  \n  \n     [!code-csharp[c_CustomTokenAuthenticator#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#3)]\n     [!code-vb[c_CustomTokenAuthenticator#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#3)]  \n\n [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md) describes how to create custom credentials and a custom security token manager. To use the custom security token authenticator created here, an implementation of the security token manager is modified to return the custom authenticator from the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method. The method returns an authenticator when an appropriate security token requirement is passed in.  \n  \n#### To integrate a custom security token authenticator with a custom security token manager  \n  \n1.  Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method in your custom security token manager implementation.  \n  \n2.  Add logic to the method to enable it to return your custom security token authenticator based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter. The following example returns a custom security token authenticator if the token requirements token type is a user name (represented by the <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> property) and the message direction for which the security token authenticator is being requested is input (represented by the <xref:System.ServiceModel.Description.MessageDirection.Input> field).  \n  \n     [!code-csharp[c_CustomTokenAuthenticator#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#2)]\n     [!code-vb[c_CustomTokenAuthenticator#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#2)]  \n \n## See also\n\n- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>\n- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>\n- <xref:System.IdentityModel.Selectors.SecurityTokenManager>\n- <xref:System.IdentityModel.Tokens.UserNameSecurityToken>\n- [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)\n- [How to: Create a Custom Security Token Provider](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)\n","nodes":[{"pos":[4,218],"embed":true,"restype":"x-metadata","content":"title: \"How to: create a custom security token authenticator\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"WCF, authentication\"\nms.assetid: 10e245f7-d31e-42e7-82a2-d5780325d372","nodes":[{"content":"How to: create a custom security token authenticator","nodes":[{"pos":[0,52],"content":"How to: create a custom security token authenticator","nodes":[{"content":"How to: create a custom security token authenticator","pos":[0,52]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[225,277],"content":"How to: create a custom security token authenticator","linkify":"How to: create a custom security token authenticator","nodes":[{"content":"How to: create a custom security token authenticator","pos":[0,52]}]},{"content":"This topic shows how to create a custom security token authenticator and how to integrate it with a custom security token manager.","pos":[278,408]},{"content":"A security token authenticator validates the content of a security token provided with an incoming message.","pos":[409,516]},{"content":"If the validation succeeds, the authenticator returns a collection of <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy&gt;</ph> instances that, when evaluated, returns a set of claims.","pos":[517,699],"source":" If the validation succeeds, the authenticator returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances that, when evaluated, returns a set of claims."},{"content":"To use a custom security token authenticator in Windows Communication Foundation (WCF), you must first create custom credentials and security token manager implementations.","pos":[706,878]},{"content":"For more information about creating custom credentials and a security token manager, see <bpt id=\"p1\">[</bpt>Walkthrough: Creating Custom Client and Service Credentials<ept id=\"p1\">](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)</ept>.","pos":[879,1134],"source":" For more information about creating custom credentials and a security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)."},{"pos":[1141,1151],"content":"Procedures","linkify":"Procedures","nodes":[{"content":"Procedures","pos":[0,10]}]},{"pos":[1162,1209],"content":"To create a custom security token authenticator","linkify":"To create a custom security token authenticator","nodes":[{"content":"To create a custom security token authenticator","pos":[0,47]}]},{"pos":[1219,1326],"content":"Define a new class derived from the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator&gt;</ph> class.","source":"Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class."},{"content":"Override the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A&gt;</ph> method.","pos":[1336,1445],"source":"Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> method."},{"content":"The method returns <ph id=\"ph1\">`true`</ph> or <ph id=\"ph2\">`false`</ph> depending on whether the custom authenticator can validate the incoming token type or not.","pos":[1446,1573],"source":" The method returns `true` or `false` depending on whether the custom authenticator can validate the incoming token type or not."},{"content":"Override the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A&gt;</ph> method.","pos":[1583,1689],"source":"Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method."},{"content":"This method needs to validate the token contents appropriately.","pos":[1690,1753]},{"content":"If the token passes the validation step, it returns a collection of <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy&gt;</ph> instances.","pos":[1754,1888],"source":" If the token passes the validation step, it returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances."},{"content":"The following example uses a custom authorization policy implementation that will be created in the next procedure.","pos":[1889,2004]},{"pos":[2015,2300],"content":"[!code-csharp[C_CustomTokenAuthenticator#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#1)]\n [!code-vb[C_CustomTokenAuthenticator#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#1)]","leadings":["","    "],"nodes":[]},{"content":"The previous code returns a collection of authorization policies in the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29&gt;</ph> method.","pos":[2307,2515],"source":"The previous code returns a collection of authorization policies in the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> method."},{"content":"WCF does not provide a public implementation of this interface.","pos":[2516,2579]},{"content":"The following procedure shows how to do so for your own requirements.","pos":[2580,2649]},{"pos":[2660,2699],"content":"To create a custom authorization policy","linkify":"To create a custom authorization policy","nodes":[{"content":"To create a custom authorization policy","pos":[0,39]}]},{"pos":[2709,2811],"content":"Define a new class implementing the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy&gt;</ph> interface.","source":"Define a new class implementing the <xref:System.IdentityModel.Policy.IAuthorizationPolicy> interface."},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A&gt;</ph> read-only property.","pos":[2821,2919],"source":"Implement the <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> read-only property."},{"content":"One way to implement this property is to generate a globally unique identifier (GUID) in the class constructor and return it every time the value for this property is requested.","pos":[2920,3097]},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A&gt;</ph> read-only property.","pos":[3107,3206],"source":"Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> read-only property."},{"content":"This property needs to return an issuer of the claim sets that are obtained from the token.","pos":[3207,3298]},{"content":"This issuer should correspond to the issuer of the token or an authority that is responsible for validating the token contents.","pos":[3299,3426]},{"content":"The following example uses the issuer claim that passed to this class from the custom security token authenticator created in the previous procedure.","pos":[3427,3576]},{"content":"The custom security token authenticator uses the system-provided claim set (returned by the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Claims.ClaimSet.System%2A&gt;</ph> property) to represent the issuer of the username token.","pos":[3577,3779],"source":" The custom security token authenticator uses the system-provided claim set (returned by the <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property) to represent the issuer of the username token."},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A&gt;</ph> method.","pos":[3789,3878],"source":"Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method."},{"content":"This method populates an instance of the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Policy.EvaluationContext&gt;</ph> class (passed in as an argument) with claims that are based on the incoming security token content.","pos":[3879,4072],"source":" This method populates an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class (passed in as an argument) with claims that are based on the incoming security token content."},{"content":"The method returns <ph id=\"ph1\">`true`</ph> when it is done with the evaluation.","pos":[4073,4135],"source":" The method returns `true` when it is done with the evaluation."},{"content":"In cases when the implementation relies on the presence of other authorization policies that provide additional information to the evaluation context, this method can return <ph id=\"ph1\">`false`</ph> if the required information is not present yet in the evaluation context.","pos":[4136,4391],"source":" In cases when the implementation relies on the presence of other authorization policies that provide additional information to the evaluation context, this method can return `false` if the required information is not present yet in the evaluation context."},{"content":"In that case, WCF will call the method again after evaluating all other authorization policies generated for the incoming message if at least one of those authorization policies modified the evaluation context.","pos":[4392,4602]},{"pos":[4613,4898],"content":"[!code-csharp[c_CustomTokenAuthenticator#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#3)]\n [!code-vb[c_CustomTokenAuthenticator#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#3)]","leadings":["","    "],"nodes":[]},{"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Creating Custom Client and Service Credentials<ept id=\"p1\">](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)</ept> describes how to create custom credentials and a custom security token manager.","pos":[4903,5148],"source":"[Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md) describes how to create custom credentials and a custom security token manager."},{"content":"To use the custom security token authenticator created here, an implementation of the security token manager is modified to return the custom authenticator from the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A&gt;</ph> method.","pos":[5149,5416],"source":" To use the custom security token authenticator created here, an implementation of the security token manager is modified to return the custom authenticator from the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method."},{"content":"The method returns an authenticator when an appropriate security token requirement is passed in.","pos":[5417,5513]},{"pos":[5524,5611],"content":"To integrate a custom security token authenticator with a custom security token manager","linkify":"To integrate a custom security token authenticator with a custom security token manager","nodes":[{"content":"To integrate a custom security token authenticator with a custom security token manager","pos":[0,87]}]},{"pos":[5621,5789],"content":"Override the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A&gt;</ph> method in your custom security token manager implementation.","source":"Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method in your custom security token manager implementation."},{"content":"Add logic to the method to enable it to return your custom security token authenticator based on the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenRequirement&gt;</ph> parameter.","pos":[5799,5973],"source":"Add logic to the method to enable it to return your custom security token authenticator based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter."},{"content":"The following example returns a custom security token authenticator if the token requirements token type is a user name (represented by the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A&gt;</ph> property) and the message direction for which the security token authenticator is being requested is input (represented by the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.MessageDirection.Input&gt;</ph> field).","pos":[5974,6376],"source":" The following example returns a custom security token authenticator if the token requirements token type is a user name (represented by the <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> property) and the message direction for which the security token authenticator is being requested is input (represented by the <xref:System.ServiceModel.Description.MessageDirection.Input> field)."},{"pos":[6387,6672],"content":"[!code-csharp[c_CustomTokenAuthenticator#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#2)]\n [!code-vb[c_CustomTokenAuthenticator#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#2)]","leadings":["","    "],"nodes":[]},{"pos":[6680,6688],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6944,7109],"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Creating Custom Client and Service Credentials<ept id=\"p1\">](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)</ept>","source":"[Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)"},{"pos":[7112,7253],"content":"<bpt id=\"p1\">[</bpt>How to: Create a Custom Security Token Provider<ept id=\"p1\">](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)</ept>","source":"[How to: Create a Custom Security Token Provider](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)"}]}