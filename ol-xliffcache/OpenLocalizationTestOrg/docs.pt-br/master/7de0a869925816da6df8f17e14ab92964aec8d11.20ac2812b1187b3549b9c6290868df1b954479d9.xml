{"content":"---\ntitle: \"reentrancy MDA\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"unmanaged code, debugging\"\n  - \"transitioning threads unmanaged to managed code\"\n  - \"reentrancy MDA\"\n  - \"reentrancy without an orderly transition\"\n  - \"managed debugging assistants (MDAs), reentrancy\"\n  - \"illegal reentrancy\"\n  - \"MDAs (managed debugging assistants), reentrancy\"\n  - \"threading [.NET Framework], managed debugging assistants\"\n  - \"managed code, debugging\"\n  - \"native debugging, MDAs\"\nms.assetid: 7240c3f3-7df8-4b03-bbf1-17cdce142d45\nauthor: \"mairaw\"\nms.author: \"mairaw\"\n---\n# reentrancy MDA\nThe `reentrancy` managed debugging assistant (MDA) is activated when an attempt is made to transition from native to managed code in cases where a prior switch from managed to native code was not performed through an orderly transition.  \n  \n## Symptoms  \n The object heap is corrupted or other serious errors are occurring when transitioning from native to managed code.  \n  \n Threads that switch between native and managed code in either direction must perform an orderly transition. However, certain low-level extensibility points in the operating system, such as the vectored exception handler, allow switches from managed to native code without performing an orderly transition.  These switches are under operating system control, rather than under common language runtime (CLR) control.  Any native code that executes inside these extensibility points must avoid calling back into managed code.  \n  \n## Cause  \n A low-level operating system extensibility point, such as the vectored exception handler, has activated while executing managed code.  The application code that is invoked through that extensibility point is attempting to call back into managed code.  \n  \n This problem is always caused by application code.  \n  \n## Resolution  \n Examine the stack trace for the thread that has activated this MDA.  The thread is attempting to illegally call into managed code.  The stack trace should reveal the application code using this extensibility point, the operating system code that provides this extensibility point, and the managed code that was interrupted by the extensibility point.  \n  \n For example, you will see the MDA activated in an attempt to call managed code from inside a vectored exception handler.  On the stack you will see the operating system exception handling code and some managed code triggering an exception such as a <xref:System.DivideByZeroException> or an <xref:System.AccessViolationException>.  \n  \n In this example, the correct resolution is to implement the vectored exception handler completely in unmanaged code.  \n  \n## Effect on the Runtime  \n This MDA has no effect on the CLR.  \n  \n## Output  \n The MDA reports that illegal reentrancy is being attempted.  Examine the thread's stack to determine why this is happening and how to correct the problem. The following is sample output.  \n  \n```  \nAdditional Information: Attempting to call into managed code without   \ntransitioning out first.  Do not attempt to run managed code inside   \nlow-level native extensibility points. Managed Debugging Assistant   \n'Reentrancy' has detected a problem in 'D:\\ConsoleApplication1\\  \nConsoleApplication1\\bin\\Debug\\ConsoleApplication1.vshost.exe'.  \n```  \n  \n## Configuration  \n  \n```xml  \n<mdaConfig>  \n  <assistants>  \n    <reentrancy />  \n  </assistants>  \n</mdaConfig>  \n```  \n  \n## Example  \n The following code example causes an <xref:System.AccessViolationException> to be thrown.  On versions of Windows that support vectored exception handling, this will cause the managed vectored exception handler to be called.  If the `reentrancy` MDA is enabled, the MDA will activate during the attempted call to `MyHandler` from the operating system's vectored exception handling support code.  \n  \n```csharp\nusing System;  \npublic delegate int ExceptionHandler(IntPtr ptrExceptionInfo);  \n  \npublic class Reenter   \n{  \n    public static ExceptionHandler keepAlive;  \n  \n    [System.Runtime.InteropServices.DllImport(\"kernel32\", ExactSpelling=true,   \n        CharSet=System.Runtime.InteropServices.CharSet.Auto)]  \n    public static extern IntPtr AddVectoredExceptionHandler(int bFirst,   \n        ExceptionHandler handler);  \n  \n    static int MyHandler(IntPtr ptrExceptionInfo)   \n    {  \n        // EXCEPTION_CONTINUE_SEARCH  \n        return 0;  \n    }  \n    void Run() {}  \n  \n    static void Main()   \n    {  \n        keepAlive = new ExceptionHandler(Reenter.MyHandler);  \n        IntPtr ret = AddVectoredExceptionHandler(1, keepAlive);  \n        try   \n        {  \n            // Dispatch on null should AV.  \n            Reenter r = null;   \n            r.Run();  \n        }   \n        catch { }  \n    }  \n}  \n```  \n  \n## See also\n\n- [Diagnosing Errors with Managed Debugging Assistants](../../../docs/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants.md)\n","nodes":[{"pos":[4,566],"embed":true,"restype":"x-metadata","content":"title: \"reentrancy MDA\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"unmanaged code, debugging\"\n  - \"transitioning threads unmanaged to managed code\"\n  - \"reentrancy MDA\"\n  - \"reentrancy without an orderly transition\"\n  - \"managed debugging assistants (MDAs), reentrancy\"\n  - \"illegal reentrancy\"\n  - \"MDAs (managed debugging assistants), reentrancy\"\n  - \"threading [.NET Framework], managed debugging assistants\"\n  - \"managed code, debugging\"\n  - \"native debugging, MDAs\"\nms.assetid: 7240c3f3-7df8-4b03-bbf1-17cdce142d45\nauthor: \"mairaw\"\nms.author: \"mairaw\"","nodes":[{"content":"reentrancy MDA","nodes":[{"pos":[0,14],"content":"reentrancy MDA","nodes":[{"content":"reentrancy MDA","pos":[0,14]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[573,587],"content":"reentrancy MDA","linkify":"reentrancy MDA","nodes":[{"content":"reentrancy MDA","pos":[0,14]}]},{"pos":[588,824],"content":"The <ph id=\"ph1\">`reentrancy`</ph> managed debugging assistant (MDA) is activated when an attempt is made to transition from native to managed code in cases where a prior switch from managed to native code was not performed through an orderly transition.","source":"The `reentrancy` managed debugging assistant (MDA) is activated when an attempt is made to transition from native to managed code in cases where a prior switch from managed to native code was not performed through an orderly transition."},{"pos":[833,841],"content":"Symptoms","linkify":"Symptoms","nodes":[{"content":"Symptoms","pos":[0,8]}]},{"content":"The object heap is corrupted or other serious errors are occurring when transitioning from native to managed code.","pos":[845,959]},{"content":"Threads that switch between native and managed code in either direction must perform an orderly transition.","pos":[966,1073]},{"content":"However, certain low-level extensibility points in the operating system, such as the vectored exception handler, allow switches from managed to native code without performing an orderly transition.","pos":[1074,1271]},{"content":"These switches are under operating system control, rather than under common language runtime (CLR) control.","pos":[1273,1380]},{"content":"Any native code that executes inside these extensibility points must avoid calling back into managed code.","pos":[1382,1488]},{"pos":[1497,1502],"content":"Cause","linkify":"Cause","nodes":[{"content":"Cause","pos":[0,5]}]},{"content":"A low-level operating system extensibility point, such as the vectored exception handler, has activated while executing managed code.","pos":[1506,1639]},{"content":"The application code that is invoked through that extensibility point is attempting to call back into managed code.","pos":[1641,1756]},{"content":"This problem is always caused by application code.","pos":[1763,1813]},{"pos":[1822,1832],"content":"Resolution","linkify":"Resolution","nodes":[{"content":"Resolution","pos":[0,10]}]},{"content":"Examine the stack trace for the thread that has activated this MDA.","pos":[1836,1903]},{"content":"The thread is attempting to illegally call into managed code.","pos":[1905,1966]},{"content":"The stack trace should reveal the application code using this extensibility point, the operating system code that provides this extensibility point, and the managed code that was interrupted by the extensibility point.","pos":[1968,2186]},{"content":"For example, you will see the MDA activated in an attempt to call managed code from inside a vectored exception handler.","pos":[2193,2313]},{"content":"On the stack you will see the operating system exception handling code and some managed code triggering an exception such as a <ph id=\"ph1\">&lt;xref:System.DivideByZeroException&gt;</ph> or an <ph id=\"ph2\">&lt;xref:System.AccessViolationException&gt;</ph>.","pos":[2315,2523],"source":"  On the stack you will see the operating system exception handling code and some managed code triggering an exception such as a <xref:System.DivideByZeroException> or an <xref:System.AccessViolationException>."},{"content":"In this example, the correct resolution is to implement the vectored exception handler completely in unmanaged code.","pos":[2530,2646]},{"pos":[2655,2676],"content":"Effect on the Runtime","linkify":"Effect on the Runtime","nodes":[{"content":"Effect on the Runtime","pos":[0,21]}]},{"content":"This MDA has no effect on the CLR.","pos":[2680,2714]},{"pos":[2723,2729],"content":"Output","linkify":"Output","nodes":[{"content":"Output","pos":[0,6]}]},{"content":"The MDA reports that illegal reentrancy is being attempted.","pos":[2733,2792]},{"content":"Examine the thread's stack to determine why this is happening and how to correct the problem.","pos":[2794,2887]},{"content":"The following is sample output.","pos":[2888,2919]},{"pos":[3287,3300],"content":"Configuration","linkify":"Configuration","nodes":[{"content":"Configuration","pos":[0,13]}]},{"pos":[3412,3419],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following code example causes an <ph id=\"ph1\">&lt;xref:System.AccessViolationException&gt;</ph> to be thrown.","pos":[3423,3512],"source":"The following code example causes an <xref:System.AccessViolationException> to be thrown."},{"content":"On versions of Windows that support vectored exception handling, this will cause the managed vectored exception handler to be called.","pos":[3514,3647]},{"content":"If the <ph id=\"ph1\">`reentrancy`</ph> MDA is enabled, the MDA will activate during the attempted call to <ph id=\"ph2\">`MyHandler`</ph> from the operating system's vectored exception handling support code.","pos":[3649,3817],"source":"  If the `reentrancy` MDA is enabled, the MDA will activate during the attempted call to `MyHandler` from the operating system's vectored exception handling support code."},{"pos":[4755,4763],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[4767,4920],"content":"<bpt id=\"p1\">[</bpt>Diagnosing Errors with Managed Debugging Assistants<ept id=\"p1\">](../../../docs/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants.md)</ept>","source":"[Diagnosing Errors with Managed Debugging Assistants](../../../docs/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants.md)"}]}