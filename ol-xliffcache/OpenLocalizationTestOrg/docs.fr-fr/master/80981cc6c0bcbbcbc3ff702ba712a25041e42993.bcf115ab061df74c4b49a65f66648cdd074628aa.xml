{"content":"---\ntitle: \"Message Queuing to Windows Communication Foundation\"\nms.date: \"03/30/2017\"\nms.assetid: 6d718eb0-9f61-4653-8a75-d2dac8fb3520\n---\n# Message Queuing to Windows Communication Foundation\nThis sample demonstrates how a Message Queuing (MSMQ) application can send an MSMQ message to a Windows Communication Foundation (WCF) service. The service is a self-hosted console application to enable you to observe the service receiving queued messages.  \n  \n The service contract is `IOrderProcessor`, which defines a one-way service that is suitable for use with queues. An MSMQ message does not have an Action header, so it is not possible to map different MSMQ messages to operation contracts automatically. Therefore, there can be only one operation contract. If you want to define more than one operation contract for the service, the application must provide information as to which header in the MSMQ message (for example, the label or correlationID) can be used to decide which operation contract to dispatch.\n  \n The MSMQ message does not contain information as to which headers are mapped to the different parameters of the operation contract. The parameter is of type <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>(`MsmqMessage<T>`), which contains the underlying MSMQ message. The type \"T\" in the <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>(`MsmqMessage<T>`) class represents the data that is serialized into the MSMQ message body. In this sample, the `PurchaseOrder` type is serialized into the MSMQ message body.  \n  \n The following sample code shows the service contract of the order processing service.  \n\n```csharp\n// Define a service contract.\n[ServiceContract(Namespace = \"http://Microsoft.ServiceModel.Samples\")]\n[ServiceKnownType(typeof(PurchaseOrder))]\npublic interface IOrderProcessor\n{\n    [OperationContract(IsOneWay = true, Action = \"*\")]\n    void SubmitPurchaseOrder(MsmqMessage<PurchaseOrder> msg);\n}\n```\n\n The service is self hosted. When using MSMQ, the queue used must be created in advance. This can be done manually or through code. In this sample, the service checks for the existence of the queue and creates it if required. The queue name is read from the configuration file.\n\n```csharp\npublic static void Main()\n{\n    // Get the MSMQ queue name from the application settings in\n    // configuration.\n    string queueName = ConfigurationManager.AppSettings[\"queueName\"];\n    // Create the MSMQ queue if necessary.\n    if (!MessageQueue.Exists(queueName))\n        MessageQueue.Create(queueName, true);\n    â€¦\n}\n```\n\n The service creates and opens a <xref:System.ServiceModel.ServiceHost> for the `OrderProcessorService`, as shown in the following sample code.\n\n```csharp\nusing (ServiceHost serviceHost = new ServiceHost(typeof(OrderProcessorService)))\n{\n    serviceHost.Open();\n    Console.WriteLine(\"The service is ready.\");\n    Console.WriteLine(\"Press <ENTER> to terminate service.\");\n    Console.ReadLine();\n    serviceHost.Close();\n}\n```\n\n The MSMQ queue name is specified in an appSettings section of the configuration file, as shown in the following sample configuration.\n\n> [!NOTE]\n>  The queue name uses a dot (.) for the local computer and backslash separators in its path. The WCF endpoint address specifies a msmq.formatname scheme, and uses localhost for the local computer. The address of the queue for each MSMQ Format Name addressing guidelines follows the msmq.formatname scheme.\n\n```xml\n<appSettings>\n    <add key=\"orderQueueName\" value=\".\\private$\\Orders\" />\n</appSettings>\n```\n\n The client application is an MSMQ application that uses the <xref:System.Messaging.MessageQueue.Send%2A> method to send a durable and transactional message to the queue, as shown in the following sample code.\n\n```csharp\n//Connect to the queue.\nMessageQueue orderQueue = new MessageQueue(ConfigurationManager.AppSettings[\"orderQueueName\"]);\n\n// Create the purchase order.\nPurchaseOrder po = new PurchaseOrder();\npo.CustomerId = \"somecustomer.com\";\npo.PONumber = Guid.NewGuid().ToString();\n\nPurchaseOrderLineItem lineItem1 = new PurchaseOrderLineItem();\nlineItem1.ProductId = \"Blue Widget\";\nlineItem1.Quantity = 54;\nlineItem1.UnitCost = 29.99F;\n\nPurchaseOrderLineItem lineItem2 = new PurchaseOrderLineItem();\nlineItem2.ProductId = \"Red Widget\";\nlineItem2.Quantity = 890;\nlineItem2.UnitCost = 45.89F;\n\npo.orderLineItems = new PurchaseOrderLineItem[2];\npo.orderLineItems[0] = lineItem1;\npo.orderLineItems[1] = lineItem2;\n\n// Submit the purchase order.\nMessage msg = new Message();\nmsg.Body = po;\n//Create a transaction scope.\nusing (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))\n{\n\n    orderQueue.Send(msg, MessageQueueTransactionType.Automatic);\n    // Complete the transaction.\n    scope.Complete();\n\n}\nConsole.WriteLine(\"Placed the order:{0}\", po);\nConsole.WriteLine(\"Press <ENTER> to terminate client.\");\nConsole.ReadLine();\n```\n\n When you run the sample, the client and service activities are displayed in both the service and client console windows. You can see the service receive messages from the client. Press ENTER in each console window to shut down the service and client. Note that because queuing is in use, the client and service do not have to be up and running at the same time. For example, you could run the client, shut it down, and then start up the service and it would still receive its messages.\n\n### To setup, build, and run the sample\n\n1.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).\n\n2.  If the service is run first, it will check to ensure that the queue is present. If the queue is not present, the service will create one. You can run the service first to create the queue, or you can create one via the MSMQ Queue Manager. Follow these steps to create a queue in Windows 2008.\n\n    1.  Open Server Manager in Visual Studio 2012.\n\n    2.  Expand the **Features** tab.\n\n    3.  Right-click **Private Message Queues**, and select **New**, **Private Queue**.\n\n    4.  Check the **Transactional** box.\n\n    5.  Enter `ServiceModelSamplesTransacted` as the name of the new queue.\n\n3.  To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).\n\n4.  To run the sample in a single- computer configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).\n\n### To run the sample across computers\n\n1.  Copy the service program files from the \\service\\bin\\ folder, under the language-specific folder, to the service computer.\n\n2.  Copy the client program files from the \\client\\bin\\ folder, under the language-specific folder, to the client computer.\n\n3.  In the Client.exe.config file, change the orderQueueName to specify the service computer name instead of \".\".\n\n4.  On the service computer, launch Service.exe from a command prompt.\n\n5.  On the client computer, launch Client.exe from a command prompt.\n\n> [!IMPORTANT]\n>  The samples may already be installed on your computer. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Binding\\MSMQIntegration\\MsmqToWcf`  \n  \n## See also\n\n- [Queues in WCF](../../../../docs/framework/wcf/feature-details/queues-in-wcf.md)\n- [How to: Exchange Messages with WCF Endpoints and Message Queuing Applications](../../../../docs/framework/wcf/feature-details/how-to-exchange-messages-with-wcf-endpoints-and-message-queuing-applications.md)\n- [Message Queuing](https://go.microsoft.com/fwlink/?LinkId=94968)\n","nodes":[{"pos":[4,135],"embed":true,"restype":"x-metadata","content":"title: \"Message Queuing to Windows Communication Foundation\"\nms.date: \"03/30/2017\"\nms.assetid: 6d718eb0-9f61-4653-8a75-d2dac8fb3520","nodes":[{"content":"Message Queuing to Windows Communication Foundation","nodes":[{"pos":[0,51],"content":"Message Queuing to Windows Communication Foundation","nodes":[{"content":"Message Queuing to Windows Communication Foundation","pos":[0,51]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[142,193],"content":"Message Queuing to Windows Communication Foundation","linkify":"Message Queuing to Windows Communication Foundation","nodes":[{"content":"Message Queuing to Windows Communication Foundation","pos":[0,51]}]},{"content":"This sample demonstrates how a Message Queuing (MSMQ) application can send an MSMQ message to a Windows Communication Foundation (WCF) service.","pos":[194,337]},{"content":"The service is a self-hosted console application to enable you to observe the service receiving queued messages.","pos":[338,450]},{"content":"The service contract is <ph id=\"ph1\">`IOrderProcessor`</ph>, which defines a one-way service that is suitable for use with queues.","pos":[457,569],"source":"The service contract is `IOrderProcessor`, which defines a one-way service that is suitable for use with queues."},{"content":"An MSMQ message does not have an Action header, so it is not possible to map different MSMQ messages to operation contracts automatically.","pos":[570,708]},{"content":"Therefore, there can be only one operation contract.","pos":[709,761]},{"content":"If you want to define more than one operation contract for the service, the application must provide information as to which header in the MSMQ message (for example, the label or correlationID) can be used to decide which operation contract to dispatch.","pos":[762,1015]},{"content":"The MSMQ message does not contain information as to which headers are mapped to the different parameters of the operation contract.","pos":[1020,1151]},{"content":"The parameter is of type <ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601&gt;</ph>(<ph id=\"ph2\">`MsmqMessage&lt;T&gt;`</ph>), which contains the underlying MSMQ message.","pos":[1152,1298],"source":" The parameter is of type <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>(`MsmqMessage<T>`), which contains the underlying MSMQ message."},{"content":"The type \"T\" in the <ph id=\"ph1\">&lt;xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601&gt;</ph>(<ph id=\"ph2\">`MsmqMessage&lt;T&gt;`</ph>) class represents the data that is serialized into the MSMQ message body.","pos":[1299,1468],"source":" The type \"T\" in the <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>(`MsmqMessage<T>`) class represents the data that is serialized into the MSMQ message body."},{"content":"In this sample, the <ph id=\"ph1\">`PurchaseOrder`</ph> type is serialized into the MSMQ message body.","pos":[1469,1551],"source":" In this sample, the `PurchaseOrder` type is serialized into the MSMQ message body."},{"content":"The following sample code shows the service contract of the order processing service.","pos":[1558,1643]},{"content":"The service is self hosted.","pos":[1960,1987]},{"content":"When using MSMQ, the queue used must be created in advance.","pos":[1988,2047]},{"content":"This can be done manually or through code.","pos":[2048,2090]},{"content":"In this sample, the service checks for the existence of the queue and creates it if required.","pos":[2091,2184]},{"content":"The queue name is read from the configuration file.","pos":[2185,2236]},{"pos":[2576,2718],"content":"The service creates and opens a <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph> for the <ph id=\"ph2\">`OrderProcessorService`</ph>, as shown in the following sample code.","source":"The service creates and opens a <xref:System.ServiceModel.ServiceHost> for the `OrderProcessorService`, as shown in the following sample code."},{"content":"The MSMQ queue name is specified in an appSettings section of the configuration file, as shown in the following sample configuration.","pos":[3004,3137]},{"pos":[3141,3455],"content":"[!NOTE]\n The queue name uses a dot (.) for the local computer and backslash separators in its path. The WCF endpoint address specifies a msmq.formatname scheme, and uses localhost for the local computer. The address of the queue for each MSMQ Format Name addressing guidelines follows the msmq.formatname scheme.","leadings":["","> "],"nodes":[{"content":"The queue name uses a dot (.) for the local computer and backslash separators in its path. The WCF endpoint address specifies a msmq.formatname scheme, and uses localhost for the local computer. The address of the queue for each MSMQ Format Name addressing guidelines follows the msmq.formatname scheme.","pos":[9,312],"nodes":[{"content":"The queue name uses a dot (.) for the local computer and backslash separators in its path.","pos":[0,90]},{"content":"The WCF endpoint address specifies a msmq.formatname scheme, and uses localhost for the local computer.","pos":[91,194]},{"content":"The address of the queue for each MSMQ Format Name addressing guidelines follows the msmq.formatname scheme.","pos":[195,303]}]}]},{"pos":[3558,3766],"content":"The client application is an MSMQ application that uses the <ph id=\"ph1\">&lt;xref:System.Messaging.MessageQueue.Send%2A&gt;</ph> method to send a durable and transactional message to the queue, as shown in the following sample code.","source":"The client application is an MSMQ application that uses the <xref:System.Messaging.MessageQueue.Send%2A> method to send a durable and transactional message to the queue, as shown in the following sample code."},{"content":"When you run the sample, the client and service activities are displayed in both the service and client console windows.","pos":[4923,5043]},{"content":"You can see the service receive messages from the client.","pos":[5044,5101]},{"content":"Press ENTER in each console window to shut down the service and client.","pos":[5102,5173]},{"content":"Note that because queuing is in use, the client and service do not have to be up and running at the same time.","pos":[5174,5284]},{"content":"For example, you could run the client, shut it down, and then start up the service and it would still receive its messages.","pos":[5285,5408]},{"pos":[5414,5449],"content":"To setup, build, and run the sample","linkify":"To setup, build, and run the sample","nodes":[{"content":"To setup, build, and run the sample","pos":[0,35]}]},{"pos":[5455,5654],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"content":"If the service is run first, it will check to ensure that the queue is present.","pos":[5660,5739]},{"content":"If the queue is not present, the service will create one.","pos":[5740,5797]},{"content":"You can run the service first to create the queue, or you can create one via the MSMQ Queue Manager.","pos":[5798,5898]},{"content":"Follow these steps to create a queue in Windows 2008.","pos":[5899,5952]},{"content":"Open Server Manager in Visual Studio 2012.","pos":[5962,6004]},{"pos":[6014,6042],"content":"Expand the <bpt id=\"p1\">**</bpt>Features<ept id=\"p1\">**</ept> tab.","source":"Expand the **Features** tab."},{"pos":[6052,6130],"content":"Right-click <bpt id=\"p1\">**</bpt>Private Message Queues<ept id=\"p1\">**</ept>, and select <bpt id=\"p2\">**</bpt>New<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Private Queue<ept id=\"p3\">**</ept>.","source":"Right-click **Private Message Queues**, and select **New**, **Private Queue**."},{"pos":[6140,6172],"content":"Check the <bpt id=\"p1\">**</bpt>Transactional<ept id=\"p1\">**</ept> box.","source":"Check the **Transactional** box."},{"pos":[6182,6249],"content":"Enter <ph id=\"ph1\">`ServiceModelSamplesTransacted`</ph> as the name of the new queue.","source":"Enter `ServiceModelSamplesTransacted` as the name of the new queue."},{"pos":[6255,6464],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[6470,6670],"content":"To run the sample in a single- computer configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- computer configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[6676,6710],"content":"To run the sample across computers","linkify":"To run the sample across computers","nodes":[{"content":"To run the sample across computers","pos":[0,34]}]},{"content":"Copy the service program files from the \\service\\bin\\ folder, under the language-specific folder, to the service computer.","pos":[6716,6838]},{"content":"Copy the client program files from the \\client\\bin\\ folder, under the language-specific folder, to the client computer.","pos":[6844,6963]},{"content":"In the Client.exe.config file, change the orderQueueName to specify the service computer name instead of \".\".","pos":[6969,7078]},{"content":"On the service computer, launch Service.exe from a command prompt.","pos":[7084,7150]},{"content":"On the client computer, launch Client.exe from a command prompt.","pos":[7156,7220]},{"pos":[7224,7357],"content":"[!IMPORTANT]\n The samples may already be installed on your computer. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your computer. Check for the following (default) directory before continuing.","pos":[14,131],"nodes":[{"content":"The samples may already be installed on your computer.","pos":[0,54]},{"content":"Check for the following (default) directory before continuing.","pos":[55,117]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[7411,7721],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[7722,7772]},{"pos":[7868,7876],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[7880,7960],"content":"<bpt id=\"p1\">[</bpt>Queues in WCF<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/queues-in-wcf.md)</ept>","source":"[Queues in WCF](../../../../docs/framework/wcf/feature-details/queues-in-wcf.md)"},{"pos":[7963,8170],"content":"<bpt id=\"p1\">[</bpt>How to: Exchange Messages with WCF Endpoints and Message Queuing Applications<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/how-to-exchange-messages-with-wcf-endpoints-and-message-queuing-applications.md)</ept>","source":"[How to: Exchange Messages with WCF Endpoints and Message Queuing Applications](../../../../docs/framework/wcf/feature-details/how-to-exchange-messages-with-wcf-endpoints-and-message-queuing-applications.md)"},{"pos":[8173,8237],"content":"<bpt id=\"p1\">[</bpt>Message Queuing<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=94968)</ept>","source":"[Message Queuing](https://go.microsoft.com/fwlink/?LinkId=94968)"}]}