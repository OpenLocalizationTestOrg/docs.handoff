{"content":"---\ntitle: \"Overriding the Identity of a Service for Authentication\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d\n---\n# Overriding the Identity of a Service for Authentication\nTypically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata. For example, the following configuration code uses the [\\<wsHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows.  \n\n The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined. In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name. The UPN is also known as the user logon name in a Windows domain.  \n\n For a sample application that demonstrates identity setting, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md). For more information about service identity, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).  \n  \n## Kerberos Authentication and Identity  \n By default, when a service is configured to use a Windows credential, an [\\<identity>](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) element that contains a [\\<userPrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) or [\\<servicePrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL. If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\\<*hostname*> because those accounts have access to the computer's SPN data. If the service is running under a different account, Windows Communication Foundation (WCF) generates a UPN in the form of \\<*username*>@<*domainName*`>`. This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.  \n  \n You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain. You can then use the SPN as the identity of the service. To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](https://go.microsoft.com/fwlink/?LinkId=91752). For more information about the tool, see [Setspn Overview](https://go.microsoft.com/fwlink/?LinkId=61374).  \n  \n> [!NOTE]\n>  To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain. You can do this in the following ways:  \n  \n-   Use the NetworkService or LocalSystem account to run your service. Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, WCF automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).  \n  \n-   Use an arbitrary Active Directory domain account to run your service. In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool. Once you create the SPN for the service's account, configure WCF to publish that SPN to the service's clients through its metadata (WSDL). This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.  \n  \n For more information about SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkId=88330).  \n  \n### When SPN or UPN Equals the Empty String  \n If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:  \n  \n-   If you are using transport level security, NT LanMan (NTLM) authentication is chosen.  \n  \n-   If you are using message level security, authentication may fail, depending on the authentication mode:  \n  \n-   If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail.  \n  \n-   If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty.  \n  \n-   If you are using Kerberos direct (also known as \"one-shot\"), authentication fails.  \n  \n### Using the \\<identity> Element in Configuration  \n If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code. This is the default for all client credential types other than Windows.  \n\n You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code. The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`.  \n\n### Setting Identity Programmatically  \n Your service does not have to explicitly specify an identity, because WCF automatically determines it. However, WCF allows you to specify an identity on an endpoint, if required. The following code adds a new service endpoint with a specific DNS identity.  \n  \n [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]\n [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  \n  \n## See also\n\n- [How to: Create a Custom Client Identity Verifier](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)\n- [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)\n","nodes":[{"pos":[4,173],"embed":true,"restype":"x-metadata","content":"title: \"Overriding the Identity of a Service for Authentication\"\nms.date: \"03/30/2017\"\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d","nodes":[{"content":"Overriding the Identity of a Service for Authentication","nodes":[{"pos":[0,55],"content":"Overriding the Identity of a Service for Authentication","nodes":[{"content":"Overriding the Identity of a Service for Authentication","pos":[0,55]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[180,235],"content":"Overriding the Identity of a Service for Authentication","linkify":"Overriding the Identity of a Service for Authentication","nodes":[{"content":"Overriding the Identity of a Service for Authentication","pos":[0,55]}]},{"content":"Typically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata.","pos":[236,408]},{"content":"For example, the following configuration code uses the <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>wsHttpBinding&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md)</ept> element and sets the <ph id=\"ph2\">`clientCredentialType`</ph> attribute to Windows.","pos":[409,624],"source":" For example, the following configuration code uses the [\\<wsHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows."},{"content":"The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined.","pos":[629,748]},{"content":"In this example, the service is running as a self-hosted service under a particular user account (<ph id=\"ph1\">username@contoso.com</ph>) and therefore the user principal name (UPN) identity contains the account name.","pos":[749,948],"source":" In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name."},{"content":"The UPN is also known as the user logon name in a Windows domain.","pos":[949,1014]},{"content":"For a sample application that demonstrates identity setting, see <bpt id=\"p1\">[</bpt>Service Identity Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/service-identity-sample.md)</ept>.","pos":[1019,1177],"source":"For a sample application that demonstrates identity setting, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md)."},{"content":"For more information about service identity, see <bpt id=\"p1\">[</bpt>Service Identity and Authentication<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)</ept>.","pos":[1178,1352],"source":" For more information about service identity, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)."},{"pos":[1361,1397],"content":"Kerberos Authentication and Identity","linkify":"Kerberos Authentication and Identity","nodes":[{"content":"Kerberos Authentication and Identity","pos":[0,36]}]},{"content":"By default, when a service is configured to use a Windows credential, an <bpt id=\"p1\">[</bpt><ph id=\"ph1\">\\&lt;</ph>identity&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md)</ept> element that contains a <bpt id=\"p2\">[</bpt><ph id=\"ph2\">\\&lt;</ph>userPrincipalName&gt;<ept id=\"p2\">](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md)</ept> or <bpt id=\"p3\">[</bpt><ph id=\"ph3\">\\&lt;</ph>servicePrincipalName&gt;<ept id=\"p3\">](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md)</ept> element is generated in the WSDL.","pos":[1401,1831],"source":"By default, when a service is configured to use a Windows credential, an [\\<identity>](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) element that contains a [\\<userPrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) or [\\<servicePrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL."},{"content":"If the service is running under the <ph id=\"ph1\">`LocalSystem`</ph>, <ph id=\"ph2\">`LocalService`</ph>, or <ph id=\"ph3\">`NetworkService`</ph> account, a service principal name (SPN) is generated by default in the form of <ph id=\"ph4\">`host/`</ph><ph id=\"ph5\">\\&lt;</ph><bpt id=\"p1\">*</bpt>hostname<ept id=\"p1\">*</ept>&gt; because those accounts have access to the computer's SPN data.","pos":[1832,2081],"source":" If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\\<*hostname*> because those accounts have access to the computer's SPN data."},{"content":"If the service is running under a different account, Windows Communication Foundation (WCF) generates a UPN in the form of <ph id=\"ph1\">\\&lt;</ph><bpt id=\"p1\">*</bpt>username<ept id=\"p1\">*</ept><ph id=\"ph2\">&gt;@&lt;</ph><bpt id=\"p2\">*</bpt>domainName<ept id=\"p2\">*</ept><ph id=\"ph3\">`&gt;`</ph>.","pos":[2082,2236],"source":" If the service is running under a different account, Windows Communication Foundation (WCF) generates a UPN in the form of \\<*username*>@<*domainName*`>`."},{"content":"This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.","pos":[2237,2362]},{"content":"You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain.","pos":[2369,2473]},{"content":"You can then use the SPN as the identity of the service.","pos":[2474,2530]},{"content":"To download the tool, see <bpt id=\"p1\">[</bpt>Windows 2000 Resource Kit Tool : Setspn.exe<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=91752)</ept>.","pos":[2531,2650],"source":" To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](https://go.microsoft.com/fwlink/?LinkId=91752)."},{"content":"For more information about the tool, see <bpt id=\"p1\">[</bpt>Setspn Overview<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=61374)</ept>.","pos":[2651,2757],"source":" For more information about the tool, see [Setspn Overview](https://go.microsoft.com/fwlink/?LinkId=61374)."},{"pos":[2765,2978],"content":"[!NOTE]\n To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain. You can do this in the following ways:","leadings":["","> "],"nodes":[{"content":"To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain. You can do this in the following ways:","pos":[9,211],"nodes":[{"content":"To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain.","pos":[0,163]},{"content":"You can do this in the following ways:","pos":[164,202]}]}]},{"content":"Use the NetworkService or LocalSystem account to run your service.","pos":[2988,3054]},{"content":"Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, WCF automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).","pos":[3055,3295]},{"content":"Use an arbitrary Active Directory domain account to run your service.","pos":[3305,3374]},{"content":"In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool.","pos":[3375,3485]},{"content":"Once you create the SPN for the service's account, configure WCF to publish that SPN to the service's clients through its metadata (WSDL).","pos":[3486,3624]},{"content":"This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.","pos":[3625,3754]},{"pos":[3761,3934],"content":"For more information about SPNs, the Kerberos protocol, and Active Directory, see <bpt id=\"p1\">[</bpt>Kerberos Technical Supplement for Windows<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=88330)</ept>.","source":"For more information about SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkId=88330)."},{"pos":[3944,3983],"content":"When SPN or UPN Equals the Empty String","linkify":"When SPN or UPN Equals the Empty String","nodes":[{"content":"When SPN or UPN Equals the Empty String","pos":[0,39]}]},{"content":"If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:","pos":[3987,4143]},{"content":"If you are using transport level security, NT LanMan (NTLM) authentication is chosen.","pos":[4153,4238]},{"content":"If you are using message level security, authentication may fail, depending on the authentication mode:","pos":[4248,4351]},{"pos":[4361,4461],"content":"If you are using <ph id=\"ph1\">`spnego`</ph> mode and the <ph id=\"ph2\">`AllowNtlm`</ph> attribute is set to <ph id=\"ph3\">`false`</ph>, authentication fail.","source":"If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail."},{"pos":[4471,4625],"content":"If you are using <ph id=\"ph1\">`spnego`</ph> mode and the <ph id=\"ph2\">`AllowNtlm`</ph> attribute is set to <ph id=\"ph3\">`true`</ph>, authentication fails if the UPN is empty, but succeeds if the SPN is empty.","source":"If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty."},{"content":"If you are using Kerberos direct (also known as \"one-shot\"), authentication fails.","pos":[4635,4717]},{"pos":[4727,4773],"content":"Using the \\<identity> Element in Configuration","linkify":"Using the \\<identity> Element in Configuration","nodes":[{"content":"Using the <ph id=\"ph1\">\\&lt;</ph>identity&gt; Element in Configuration","pos":[0,46],"source":"Using the \\<identity> Element in Configuration"}]},{"content":"If you change the client credential type in the binding previously shown to Certificate<ph id=\"ph1\">`,`</ph> then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code.","pos":[4777,4993],"source":"If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code."},{"content":"This is the default for all client credential types other than Windows.","pos":[4994,5065]},{"content":"You can change the value of the default service identity or change the type of the identity by using the &lt;<ph id=\"ph1\">`identity`</ph>&gt; element in configuration or by setting the identity in code.","pos":[5070,5248],"source":"You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code."},{"content":"The following configuration code sets a domain name system (DNS) identity with the value <ph id=\"ph1\">`contoso.com`</ph>.","pos":[5249,5352],"source":" The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`."},{"pos":[5360,5393],"content":"Setting Identity Programmatically","linkify":"Setting Identity Programmatically","nodes":[{"content":"Setting Identity Programmatically","pos":[0,33]}]},{"content":"Your service does not have to explicitly specify an identity, because WCF automatically determines it.","pos":[5397,5499]},{"content":"However, WCF allows you to specify an identity on an endpoint, if required.","pos":[5500,5575]},{"content":"The following code adds a new service endpoint with a specific DNS identity.","pos":[5576,5652]},{"pos":[5885,5893],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[5897,6040],"content":"<bpt id=\"p1\">[</bpt>How to: Create a Custom Client Identity Verifier<ept id=\"p1\">](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)</ept>","source":"[How to: Create a Custom Client Identity Verifier](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)"},{"pos":[6043,6167],"content":"<bpt id=\"p1\">[</bpt>Service Identity and Authentication<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)</ept>","source":"[Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)"}]}