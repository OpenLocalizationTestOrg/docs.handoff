{"content":"---\ntitle: \"How to: Create a Custom Persistence Participant\"\nms.date: \"03/30/2017\"\nms.assetid: 1d9cc47a-8966-4286-94d5-4221403d9c06\n---\n# How to: Create a Custom Persistence Participant\nThe following procedure has steps to create a persistence participant. See the [Participating in Persistence](https://go.microsoft.com/fwlink/?LinkID=177735) sample and [Store Extensibility](store-extensibility.md) topic for sample implementations of persistence participants.  \n  \n1.  Create a class deriving from the <xref:System.Activities.Persistence.PersistenceParticipant> or the <xref:System.Activities.Persistence.PersistenceIOParticipant> class. The PersistenceIOParticipant class offers the same extensibility points as the PersistenceParticipant class in addition to being able to participate in I/O operations. Follow one or more of the following steps.  \n  \n2.  Implement the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method. The **CollectValues** method has two dictionary parameters, one for storing read/write values and the other one for storing write-only values (used later in queries). In this method, you should populate these dictionaries with data that is specific to a persistence participant. Each dictionary contains the name of the value as the key and the value itself as an <xref:System.Runtime.DurableInstancing.InstanceValue> object.  \n  \n     The values in the readWriteValues dictionary are packaged as **InstanceValue** objects. The values in the write-only dictionary are packaged as **InstanceValue** objects with InstanceValueOptions.Optional and InstanceValueOption.WriteOnly set. Each **InstanceValue** provided by the **CollectValues** implementations across all persistence participants must have a unique name.  \n  \n    ```  \n    protected virtual void CollectValues (out IDictionary<XName,Object> readWriteValues, out IDictionary<XName,Object> writeOnlyValues)  \n    ```  \n  \n3.  Implement the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method. The **MapValues** method takes two parameters that are similar to the parameters that the **CollectValues** method receives. All the values collected in the **CollectValues** stage are passed through these dictionary parameters. The new values added by the **MapValues** stage are added to the write-only values.  The write-only dictionary is used to provide data to an external source not directly associated with the instance values. Each value provided by implementations of the **MapValues** method across all persistence participants must have a unique name.  \n  \n    ```  \n    protected virtual IDictionary<XName,Object> MapValues (IDictionary<XName,Object> readWriteValues,IDictionary<XName,Object> writeOnlyValues)  \n    ```  \n  \n     The <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method provides functionality that <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> does not, in that it allows for a dependency on another value provided by another persistence participant that hasn’t been processed by <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> yet.  \n  \n4.  Implement the **PublishValues** method. The **PublishValues** method receives a dictionary containing all the values loaded from the persistence store.  \n  \n    ```  \n    protected virtual void PublishValues (IDictionary<XName,Object> readWriteValues)  \n    ```  \n  \n5.  Implement the **BeginOnSave** method if the participant is a persistence I/O participant. This method is called during a Save operation. In this method, you should perform I/O adjunct to the persisting (saving) workflow instances.  If the host is using a transaction for the corresponding persistence command, the same transaction is provided in Transaction.Current.  Additionally, PersistenceIOParticipants may advertise a transactional consistency requirement, in which case the host creates a transaction for the persistence episode if one would not otherwise be used.  \n  \n    ```  \n    protected virtual IAsyncResult BeginOnSave (IDictionary<XName,Object> readWriteValues, IDictionary<XName,Object> writeOnlyValues, TimeSpan timeout, AsyncCallback callback, Object state)  \n    ```  \n  \n6.  Implement the **BeginOnLoad** method if the participant is a persistence I/O participant. This method is called during a Load operation. In this method, you should perform I/O adjunct to the loading of workflow instances. If the host is using a transaction for the corresponding persistence command, the same transaction is provided in Transaction.Current. Additionally, Persistence I/O participants may advertise a transactional consistency requirement, in which case the host creates a transaction for the persistence episode if one would not otherwise be used.  \n  \n    ```  \n    protected virtual IAsyncResult BeginOnLoad (IDictionary<XName,Object> readWriteValues, TimeSpan timeout, AsyncCallback callback, Object state)  \n    ```\n","nodes":[{"pos":[4,131],"embed":true,"restype":"x-metadata","content":"title: \"How to: Create a Custom Persistence Participant\"\nms.date: \"03/30/2017\"\nms.assetid: 1d9cc47a-8966-4286-94d5-4221403d9c06","nodes":[{"content":"How to: Create a Custom Persistence Participant","nodes":[{"pos":[0,47],"content":"How to: Create a Custom Persistence Participant","nodes":[{"content":"How to: Create a Custom Persistence Participant","pos":[0,47]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[138,185],"content":"How to: Create a Custom Persistence Participant","linkify":"How to: Create a Custom Persistence Participant","nodes":[{"content":"How to: Create a Custom Persistence Participant","pos":[0,47]}]},{"content":"The following procedure has steps to create a persistence participant.","pos":[186,256]},{"content":"See the <bpt id=\"p1\">[</bpt>Participating in Persistence<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkID=177735)</ept> sample and <bpt id=\"p2\">[</bpt>Store Extensibility<ept id=\"p2\">](store-extensibility.md)</ept> topic for sample implementations of persistence participants.","pos":[257,462],"source":" See the [Participating in Persistence](https://go.microsoft.com/fwlink/?LinkID=177735) sample and [Store Extensibility](store-extensibility.md) topic for sample implementations of persistence participants."},{"content":"Create a class deriving from the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant&gt;</ph> or the <ph id=\"ph2\">&lt;xref:System.Activities.Persistence.PersistenceIOParticipant&gt;</ph> class.","pos":[472,640],"source":"Create a class deriving from the <xref:System.Activities.Persistence.PersistenceParticipant> or the <xref:System.Activities.Persistence.PersistenceIOParticipant> class."},{"content":"The PersistenceIOParticipant class offers the same extensibility points as the PersistenceParticipant class in addition to being able to participate in I/O operations.","pos":[641,808]},{"content":"Follow one or more of the following steps.","pos":[809,851]},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A&gt;</ph> method.","pos":[861,959],"source":"Implement the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method."},{"content":"The <bpt id=\"p1\">**</bpt>CollectValues<ept id=\"p1\">**</ept> method has two dictionary parameters, one for storing read/write values and the other one for storing write-only values (used later in queries).","pos":[960,1126],"source":" The **CollectValues** method has two dictionary parameters, one for storing read/write values and the other one for storing write-only values (used later in queries)."},{"content":"In this method, you should populate these dictionaries with data that is specific to a persistence participant.","pos":[1127,1238]},{"content":"Each dictionary contains the name of the value as the key and the value itself as an <ph id=\"ph1\">&lt;xref:System.Runtime.DurableInstancing.InstanceValue&gt;</ph> object.","pos":[1239,1385],"source":" Each dictionary contains the name of the value as the key and the value itself as an <xref:System.Runtime.DurableInstancing.InstanceValue> object."},{"content":"The values in the readWriteValues dictionary are packaged as <bpt id=\"p1\">**</bpt>InstanceValue<ept id=\"p1\">**</ept> objects.","pos":[1396,1483],"source":"The values in the readWriteValues dictionary are packaged as **InstanceValue** objects."},{"content":"The values in the write-only dictionary are packaged as <bpt id=\"p1\">**</bpt>InstanceValue<ept id=\"p1\">**</ept> objects with InstanceValueOptions.Optional and InstanceValueOption.WriteOnly set.","pos":[1484,1639],"source":" The values in the write-only dictionary are packaged as **InstanceValue** objects with InstanceValueOptions.Optional and InstanceValueOption.WriteOnly set."},{"content":"Each <bpt id=\"p1\">**</bpt>InstanceValue<ept id=\"p1\">**</ept> provided by the <bpt id=\"p2\">**</bpt>CollectValues<ept id=\"p2\">**</ept> implementations across all persistence participants must have a unique name.","pos":[1640,1773],"source":" Each **InstanceValue** provided by the **CollectValues** implementations across all persistence participants must have a unique name."},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A&gt;</ph> method.","pos":[1944,2038],"source":"Implement the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method."},{"content":"The <bpt id=\"p1\">**</bpt>MapValues<ept id=\"p1\">**</ept> method takes two parameters that are similar to the parameters that the <bpt id=\"p2\">**</bpt>CollectValues<ept id=\"p2\">**</ept> method receives.","pos":[2039,2163],"source":" The **MapValues** method takes two parameters that are similar to the parameters that the **CollectValues** method receives."},{"content":"All the values collected in the <bpt id=\"p1\">**</bpt>CollectValues<ept id=\"p1\">**</ept> stage are passed through these dictionary parameters.","pos":[2164,2267],"source":" All the values collected in the **CollectValues** stage are passed through these dictionary parameters."},{"content":"The new values added by the <bpt id=\"p1\">**</bpt>MapValues<ept id=\"p1\">**</ept> stage are added to the write-only values.","pos":[2268,2351],"source":" The new values added by the **MapValues** stage are added to the write-only values."},{"content":"The write-only dictionary is used to provide data to an external source not directly associated with the instance values.","pos":[2353,2474]},{"content":"Each value provided by implementations of the <bpt id=\"p1\">**</bpt>MapValues<ept id=\"p1\">**</ept> method across all persistence participants must have a unique name.","pos":[2475,2602],"source":" Each value provided by implementations of the **MapValues** method across all persistence participants must have a unique name."},{"pos":[2782,3188],"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A&gt;</ph> method provides functionality that <ph id=\"ph2\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A&gt;</ph> does not, in that it allows for a dependency on another value provided by another persistence participant that hasn’t been processed by <ph id=\"ph3\">&lt;xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A&gt;</ph> yet.","source":"The <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method provides functionality that <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> does not, in that it allows for a dependency on another value provided by another persistence participant that hasn’t been processed by <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> yet."},{"content":"Implement the <bpt id=\"p1\">**</bpt>PublishValues<ept id=\"p1\">**</ept> method.","pos":[3198,3237],"source":"Implement the **PublishValues** method."},{"content":"The <bpt id=\"p1\">**</bpt>PublishValues<ept id=\"p1\">**</ept> method receives a dictionary containing all the values loaded from the persistence store.","pos":[3238,3349],"source":" The **PublishValues** method receives a dictionary containing all the values loaded from the persistence store."},{"content":"Implement the <bpt id=\"p1\">**</bpt>BeginOnSave<ept id=\"p1\">**</ept> method if the participant is a persistence I/O participant.","pos":[3469,3558],"source":"Implement the **BeginOnSave** method if the participant is a persistence I/O participant."},{"content":"This method is called during a Save operation.","pos":[3559,3605]},{"content":"In this method, you should perform I/O adjunct to the persisting (saving) workflow instances.","pos":[3606,3699]},{"content":"If the host is using a transaction for the corresponding persistence command, the same transaction is provided in Transaction.Current.","pos":[3701,3835]},{"content":"Additionally, PersistenceIOParticipants may advertise a transactional consistency requirement, in which case the host creates a transaction for the persistence episode if one would not otherwise be used.","pos":[3837,4040]},{"content":"Implement the <bpt id=\"p1\">**</bpt>BeginOnLoad<ept id=\"p1\">**</ept> method if the participant is a persistence I/O participant.","pos":[4265,4354],"source":"Implement the **BeginOnLoad** method if the participant is a persistence I/O participant."},{"content":"This method is called during a Load operation.","pos":[4355,4401]},{"content":"In this method, you should perform I/O adjunct to the loading of workflow instances.","pos":[4402,4486]},{"content":"If the host is using a transaction for the corresponding persistence command, the same transaction is provided in Transaction.Current.","pos":[4487,4621]},{"content":"Additionally, Persistence I/O participants may advertise a transactional consistency requirement, in which case the host creates a transaction for the persistence episode if one would not otherwise be used.","pos":[4622,4828]}]}