{"content":"---\ntitle: \"Workflow Service Host Internals\"\nms.date: \"03/30/2017\"\nms.assetid: af44596f-bf6a-4149-9f04-08d8e8f45250\n---\n# Workflow Service Host Internals\n<xref:System.ServiceModel.WorkflowServiceHost> provides a host for workflow services. It is responsible for listening for incoming messages and routing them to the appropriate workflow service instance, it controls unloading and persisting of idle workflows, and more. This topic describes how WorkflowServiceHost processes incoming messages.  \n  \n## WorkflowServiceHost Overview  \n\nThe <xref:System.ServiceModel.WorkflowServiceHost> class is used to host workflow services. It listens for incoming messages and routes them to the appropriate service instance, creating new instances or loading existing instances from durable storage as needed. The following diagram illustrates on a high level how <xref:System.ServiceModel.WorkflowServiceHost> works: \n  \n ![Diagram that shows an overview of the Workflow Service Host.](./media/workflow-service-host-internals/workflow-service-host-high-level-overview.gif)  \n  \n This diagram shows that <xref:System.ServiceModel.WorkflowServiceHost> loads workflow service definitions from .xamlx files and loads configuration information from a configuration file. It also loads tracking configuration from the tracking profile. <xref:System.ServiceModel.WorkflowServiceHost> exposes a workflow control endpoint which allows you to send control operations to workflow instances.  For more information see [Workflow Control Endpoint sample](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md).  \n  \n <xref:System.ServiceModel.WorkflowServiceHost> also exposes application endpoints that listen for incoming application messages. When an incoming message arrives it is sent to the appropriate workflow service instance (if it is currently loaded). If needed a new workflow instance is created. Or if an existing instance has been persisted it is loaded from the persistence store.  \n  \n## WorkflowServiceHost Details  \n The following diagram shows how <xref:System.ServiceModel.WorkflowServiceHost> handles messages in a bit more detail:  \n  \n ![Diagram that shows the Workflow Service Host message flow.](./media/workflow-service-host-internals/workflow-service-host-message-flow.gif)  \n  \n This diagram shows three different endpoints, an application endpoint, a workflow control endpoint, and a workflow hosting endpoint. The application endpoint receives messages that are bound for a specific workflow instance. The workflow control endpoint listens for control operations. The workflow hosting endpoint listens for messages that cause <xref:System.ServiceModel.WorkflowServiceHost> to load and execute non-service workflows. As shown in the diagram all messages are processed through the WCF runtime.  Workflow service instance throttling is achieved by using the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A> property. This property will limit the number of concurrent workflow service instances. When this throttle is exceeded any additional requests for new workflow service instances or requests to activate persisted workflow instances will be queued. The queued requests are processed in FIFO order regardless of whether they are requests for a new instance or a running, persisted instance. Host policy information is loaded that determines how unhandled exceptions are dealt with, and how idle workflow services are unloaded and persisted. For more information about these topics see [How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md) and [How to: Configure Idle Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/how-to-configure-idle-behavior-with-workflowservicehost.md). Workflow instances are persisted according to host policies and are reloaded when needed. For more information about workflow persistence see: [How to: Configure Persistence with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/how-to-configure-persistence-with-workflowservicehost.md), [Creating a Long-running Workflow Service](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md), and [Workflow Persistence](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md).  \n  \n The following illustration shows the flow when WorkflowServiceHost.Open is called:  \n  \n ![Diagram that shows the flow when WorkflowServiceHost.Open is called.](./media/workflow-service-host-internals/workflow-service-host-open.gif)  \n  \n The workflow is loaded from XAML and the activity tree is created. <xref:System.ServiceModel.WorkflowServiceHost> walks the activity tree and creates the service description. Configuration is applied to the host. Finally the host begins to listen for incoming messages.  \n  \n The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to `true`:  \n  \n ![Decision tree used by the WFS Host when it receives a message and CanCreateInstance is true.](./media/workflow-service-host-internals/workflow-service-host-receive-message-cancreateinstance.gif)  \n  \n The message arrives and is processed by the WCF channel stack. Throttles are checked and correlation queries are executed. If the message is bound for an existing instance the message is delivered. If a new instance needs to be created, the Receive activityâ€™s CanCreateInstance property is checked. If it is set to true, a new instance is created and the message is delivered.  \n  \n The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to false.  \n  \n ![Decision tree used by the WFS Host when it receives a message and CanCreateInstance is false.](./media/workflow-service-host-internals/workflow-service-host-receive-message.gif)  \n  \n The message arrives and is processed by the WCF channel stack. Throttles are checked and correlation queries are executed. The message is bound for an existing instance (because CanCreateInstance is false) so the instance is loaded from persistence store, the bookmark is resumed and the workflow executes.  \n  \n> [!WARNING]\n> Workflow Service Host will fail to open if SQL Server is configured to listen on NamedPipe protocol only.  \n  \n## See also\n\n- [Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)\n- [Hosting Workflow Services](../../../../docs/framework/wcf/feature-details/hosting-workflow-services.md)\n- [Workflow Control Endpoint](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)\n- [How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md)\n- [Creating a Long-running Workflow Service](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md)\n- [Workflow Persistence](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)\n","nodes":[{"pos":[4,115],"embed":true,"restype":"x-metadata","content":"title: \"Workflow Service Host Internals\"\nms.date: \"03/30/2017\"\nms.assetid: af44596f-bf6a-4149-9f04-08d8e8f45250","nodes":[{"content":"Workflow Service Host Internals","nodes":[{"pos":[0,31],"content":"Workflow Service Host Internals","nodes":[{"content":"Workflow Service Host Internals","pos":[0,31]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[122,153],"content":"Workflow Service Host Internals","linkify":"Workflow Service Host Internals","nodes":[{"content":"Workflow Service Host Internals","pos":[0,31]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> provides a host for workflow services.","pos":[154,239],"source":"<xref:System.ServiceModel.WorkflowServiceHost> provides a host for workflow services."},{"content":"It is responsible for listening for incoming messages and routing them to the appropriate workflow service instance, it controls unloading and persisting of idle workflows, and more.","pos":[240,422]},{"content":"This topic describes how WorkflowServiceHost processes incoming messages.","pos":[423,496]},{"pos":[505,533],"content":"WorkflowServiceHost Overview","linkify":"WorkflowServiceHost Overview","nodes":[{"content":"WorkflowServiceHost Overview","pos":[0,28]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> class is used to host workflow services.","pos":[537,628],"source":"The <xref:System.ServiceModel.WorkflowServiceHost> class is used to host workflow services."},{"content":"It listens for incoming messages and routes them to the appropriate service instance, creating new instances or loading existing instances from durable storage as needed.","pos":[629,799]},{"content":"The following diagram illustrates on a high level how <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> works:","pos":[800,907],"source":" The following diagram illustrates on a high level how <xref:System.ServiceModel.WorkflowServiceHost> works:"},{"content":"Diagram that shows an overview of the Workflow Service Host.","pos":[915,975]},{"content":"This diagram shows that <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> loads workflow service definitions from .xamlx files and loads configuration information from a configuration file.","pos":[1070,1256],"source":"This diagram shows that <xref:System.ServiceModel.WorkflowServiceHost> loads workflow service definitions from .xamlx files and loads configuration information from a configuration file."},{"content":"It also loads tracking configuration from the tracking profile.","pos":[1257,1320]},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> exposes a workflow control endpoint which allows you to send control operations to workflow instances.","pos":[1321,1470],"source":"<xref:System.ServiceModel.WorkflowServiceHost> exposes a workflow control endpoint which allows you to send control operations to workflow instances."},{"content":"For more information see <bpt id=\"p1\">[</bpt>Workflow Control Endpoint sample<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)</ept>.","pos":[1472,1609],"source":"  For more information see [Workflow Control Endpoint sample](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)."},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> also exposes application endpoints that listen for incoming application messages.","pos":[1616,1744],"source":"<xref:System.ServiceModel.WorkflowServiceHost> also exposes application endpoints that listen for incoming application messages."},{"content":"When an incoming message arrives it is sent to the appropriate workflow service instance (if it is currently loaded).","pos":[1745,1862]},{"content":"If needed a new workflow instance is created.","pos":[1863,1908]},{"content":"Or if an existing instance has been persisted it is loaded from the persistence store.","pos":[1909,1995]},{"pos":[2004,2031],"content":"WorkflowServiceHost Details","linkify":"WorkflowServiceHost Details","nodes":[{"content":"WorkflowServiceHost Details","pos":[0,27]}]},{"pos":[2035,2152],"content":"The following diagram shows how <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> handles messages in a bit more detail:","source":"The following diagram shows how <xref:System.ServiceModel.WorkflowServiceHost> handles messages in a bit more detail:"},{"content":"Diagram that shows the Workflow Service Host message flow.","pos":[2161,2219]},{"content":"This diagram shows three different endpoints, an application endpoint, a workflow control endpoint, and a workflow hosting endpoint.","pos":[2307,2439]},{"content":"The application endpoint receives messages that are bound for a specific workflow instance.","pos":[2440,2531]},{"content":"The workflow control endpoint listens for control operations.","pos":[2532,2593]},{"content":"The workflow hosting endpoint listens for messages that cause <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> to load and execute non-service workflows.","pos":[2594,2745],"source":" The workflow hosting endpoint listens for messages that cause <xref:System.ServiceModel.WorkflowServiceHost> to load and execute non-service workflows."},{"content":"As shown in the diagram all messages are processed through the WCF runtime.","pos":[2746,2821]},{"content":"Workflow service instance throttling is achieved by using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A&gt;</ph> property.","pos":[2823,2985],"source":"  Workflow service instance throttling is achieved by using the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A> property."},{"content":"This property will limit the number of concurrent workflow service instances.","pos":[2986,3063]},{"content":"When this throttle is exceeded any additional requests for new workflow service instances or requests to activate persisted workflow instances will be queued.","pos":[3064,3222]},{"content":"The queued requests are processed in FIFO order regardless of whether they are requests for a new instance or a running, persisted instance.","pos":[3223,3363]},{"content":"Host policy information is loaded that determines how unhandled exceptions are dealt with, and how idle workflow services are unloaded and persisted.","pos":[3364,3513]},{"content":"For more information about these topics see <bpt id=\"p1\">[</bpt>How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md)</ept> and <bpt id=\"p2\">[</bpt>How to: Configure Idle Behavior with WorkflowServiceHost<ept id=\"p2\">](../../../../docs/framework/wcf/feature-details/how-to-configure-idle-behavior-with-workflowservicehost.md)</ept>.","pos":[3514,3918],"source":" For more information about these topics see [How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md) and [How to: Configure Idle Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/how-to-configure-idle-behavior-with-workflowservicehost.md)."},{"content":"Workflow instances are persisted according to host policies and are reloaded when needed.","pos":[3919,4008]},{"content":"For more information about workflow persistence see: <bpt id=\"p1\">[</bpt>How to: Configure Persistence with WorkflowServiceHost<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/how-to-configure-persistence-with-workflowservicehost.md)</ept>, <bpt id=\"p2\">[</bpt>Creating a Long-running Workflow Service<ept id=\"p2\">](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md)</ept>, and <bpt id=\"p3\">[</bpt>Workflow Persistence<ept id=\"p3\">](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)</ept>.","pos":[4009,4468],"source":" For more information about workflow persistence see: [How to: Configure Persistence with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/how-to-configure-persistence-with-workflowservicehost.md), [Creating a Long-running Workflow Service](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md), and [Workflow Persistence](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)."},{"content":"The following illustration shows the flow when WorkflowServiceHost.Open is called:","pos":[4475,4557]},{"content":"Diagram that shows the flow when WorkflowServiceHost.Open is called.","pos":[4566,4634]},{"content":"The workflow is loaded from XAML and the activity tree is created.","pos":[4714,4780]},{"content":"<ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> walks the activity tree and creates the service description.","pos":[4781,4888],"source":"<xref:System.ServiceModel.WorkflowServiceHost> walks the activity tree and creates the service description."},{"content":"Configuration is applied to the host.","pos":[4889,4926]},{"content":"Finally the host begins to listen for incoming messages.","pos":[4927,4983]},{"pos":[4990,5181],"content":"The following illustration shows what the <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> does when it receives a message bound for a Receive activity that has CanCreateInstance set to <ph id=\"ph2\">`true`</ph>:","source":"The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to `true`:"},{"content":"Decision tree used by the WFS Host when it receives a message and CanCreateInstance is true.","pos":[5190,5282]},{"content":"The message arrives and is processed by the WCF channel stack.","pos":[5391,5453]},{"content":"Throttles are checked and correlation queries are executed.","pos":[5454,5513]},{"content":"If the message is bound for an existing instance the message is delivered.","pos":[5514,5588]},{"content":"If a new instance needs to be created, the Receive activityâ€™s CanCreateInstance property is checked.","pos":[5589,5689]},{"content":"If it is set to true, a new instance is created and the message is delivered.","pos":[5690,5767]},{"pos":[5774,5964],"content":"The following illustration shows what the <ph id=\"ph1\">&lt;xref:System.ServiceModel.WorkflowServiceHost&gt;</ph> does when it receives a message bound for a Receive activity that has CanCreateInstance set to false.","source":"The following illustration shows what the <xref:System.ServiceModel.WorkflowServiceHost> does when it receives a message bound for a Receive activity that has CanCreateInstance set to false."},{"content":"Decision tree used by the WFS Host when it receives a message and CanCreateInstance is false.","pos":[5973,6066]},{"content":"The message arrives and is processed by the WCF channel stack.","pos":[6157,6219]},{"content":"Throttles are checked and correlation queries are executed.","pos":[6220,6279]},{"content":"The message is bound for an existing instance (because CanCreateInstance is false) so the instance is loaded from persistence store, the bookmark is resumed and the workflow executes.","pos":[6280,6463]},{"pos":[6471,6589],"content":"[!WARNING]\nWorkflow Service Host will fail to open if SQL Server is configured to listen on NamedPipe protocol only.","leadings":["","> "],"nodes":[{"content":"Workflow Service Host will fail to open if SQL Server is configured to listen on NamedPipe protocol only.","pos":[11,116]}]},{"pos":[6598,6606],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6610,6698],"content":"<bpt id=\"p1\">[</bpt>Workflow Services<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/workflow-services.md)</ept>","source":"[Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)"},{"pos":[6701,6805],"content":"<bpt id=\"p1\">[</bpt>Hosting Workflow Services<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/hosting-workflow-services.md)</ept>","source":"[Hosting Workflow Services](../../../../docs/framework/wcf/feature-details/hosting-workflow-services.md)"},{"pos":[6808,6912],"content":"<bpt id=\"p1\">[</bpt>Workflow Control Endpoint<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)</ept>","source":"[Workflow Control Endpoint](../../../../docs/framework/wcf/feature-details/workflow-control-endpoint.md)"},{"pos":[6915,7104],"content":"<bpt id=\"p1\">[</bpt>How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md)</ept>","source":"[How to: Configure Workflow Unhandled Exception Behavior with WorkflowServiceHost](../../../../docs/framework/wcf/feature-details/config-workflow-unhandled-exception-workflowservicehost.md)"},{"pos":[7107,7241],"content":"<bpt id=\"p1\">[</bpt>Creating a Long-running Workflow Service<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md)</ept>","source":"[Creating a Long-running Workflow Service](../../../../docs/framework/wcf/feature-details/creating-a-long-running-workflow-service.md)"},{"pos":[7244,7346],"content":"<bpt id=\"p1\">[</bpt>Workflow Persistence<ept id=\"p1\">](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)</ept>","source":"[Workflow Persistence](../../../../docs/framework/windows-workflow-foundation/workflow-persistence.md)"}]}