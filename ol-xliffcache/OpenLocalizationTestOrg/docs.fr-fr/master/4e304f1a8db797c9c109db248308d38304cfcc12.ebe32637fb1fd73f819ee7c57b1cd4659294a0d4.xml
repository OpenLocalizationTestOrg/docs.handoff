{"content":"---\ntitle: \"How to: Cancel a Dataflow Block | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: dotnet-standard\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"Task Parallel Library, dataflows\"\n  - \"dataflow blocks, canceling in TPL\"\n  - \"TPL dataflow library,canceling dataflow blocks\"\nms.assetid: fbddda0d-da3b-4ec8-a1d6-67ab8573fcd7\ncaps.latest.revision: 9\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\nmanager: \"wpickett\"\n---\n# How to: Cancel a Dataflow Block\nThis document demonstrates how to enable cancellation in your application. This example uses Windows Forms to show where work items are active in a dataflow pipeline and also the effects of cancellation.  \n  \n> [!TIP]\n>  The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.  \n  \n### To Create the Windows Forms Application  \n  \n1.  Create a C# or Visual Basic **Windows Forms Application** project. In the following steps, the project is named `CancellationWinForms`.  \n  \n2.  On the form designer for the main form, Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), add a <xref:System.Windows.Forms.ToolStrip> control.  \n  \n3.  Add a <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control. Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle> and the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Add Work Items**.  \n  \n4.  Add a second <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control. Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle>, the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Cancel**, and the <xref:System.Windows.Forms.ToolStripItem.Enabled%2A> property to `False`.  \n  \n5.  Add four <xref:System.Windows.Forms.ToolStripProgressBar> objects to the <xref:System.Windows.Forms.ToolStrip> control.  \n  \n## Creating the Dataflow Pipeline  \n This section describes how to create the dataflow pipeline that processes work items and updates the progress bars.  \n  \n#### To Create the Dataflow Pipeline  \n  \n1.  In your project, add a reference to System.Threading.Tasks.Dataflow.dll.  \n  \n2.  Ensure that Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) contains the following `using` statements (`Imports` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]).  \n  \n     [!code-csharp[TPLDataflow_CancellationWinForms#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#1)]\n     [!code-vb[TPLDataflow_CancellationWinForms#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#1)]  \n  \n3.  Add the `WorkItem` class as an inner type of the `Form1` class.  \n  \n     [!code-csharp[TPLDataflow_CancellationWinForms#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#2)]\n     [!code-vb[TPLDataflow_CancellationWinForms#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#2)]  \n  \n4.  Add the following data members to the `Form1` class.  \n  \n     [!code-csharp[TPLDataflow_CancellationWinForms#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#3)]\n     [!code-vb[TPLDataflow_CancellationWinForms#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#3)]  \n  \n5.  Add the following method, `CreatePipeline`, to the `Form1` class.  \n  \n     [!code-csharp[TPLDataflow_CancellationWinForms#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#4)]\n     [!code-vb[TPLDataflow_CancellationWinForms#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#4)]  \n  \n Because the `incrementProgress` and `decrementProgress` dataflow blocks act on the user interface, it is important that these actions occur on the user-interface thread. To accomplish this, during construction these objects each provide a <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions> object that has the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A> property set to <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName>. The <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName> method creates a <xref:System.Threading.Tasks.TaskScheduler> object that performs work on the current synchronization context. Because the `Form1` constructor is called from the user-interface thread, the actions for the `incrementProgress` and `decrementProgress` dataflow blocks also run on the user-interface thread.  \n  \n This example sets the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property when it constructs the members of the pipeline. Because the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property permanently cancels dataflow block execution, the whole pipeline must be recreated after the user cancels the operation and then wants to add more work items to the pipeline. For an example that demonstrates an alternative way to cancel a dataflow block so that other work can be performed after an operation is canceled, see [Walkthrough: Using Dataflow in a Windows Forms Application](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).  \n  \n## Connecting the Dataflow Pipeline to the User Interface  \n This section describes how to connect the dataflow pipeline to the user interface. Both creating the pipeline and adding work items to the pipeline are controlled by the event handler for the **Add Work Items** button. Cancellation is initiated by the **Cancel** button. When the user clicks either of these buttons, the appropriate action is initiated in an asynchronous manner.  \n  \n#### To Connect the Dataflow Pipeline to the User Interface  \n  \n1.  On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Add Work Items** button.  \n  \n2.  Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Add Work Items** button.  \n  \n     [!code-csharp[TPLDataflow_CancellationWinForms#5](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#5)]\n     [!code-vb[TPLDataflow_CancellationWinForms#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#5)]  \n  \n3.  On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event handler for the **Cancel** button.  \n  \n4.  Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event handler for the **Cancel** button.  \n  \n     [!code-csharp[TPLDataflow_CancellationWinForms#6](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#6)]\n     [!code-vb[TPLDataflow_CancellationWinForms#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#6)]  \n  \n## Example  \n The following example shows the complete code for Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]).  \n  \n [!code-csharp[TPLDataflow_CancellationWinForms#100](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#100)]\n [!code-vb[TPLDataflow_CancellationWinForms#100](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#100)]  \n  \n The following illustration shows the running application.  \n  \n ![The Windows Forms Application](../../../docs/standard/parallel-programming/media/tpldataflow-cancellation.png \"TPLDataflow_Cancellation\")  \n  \n## Robust Programming  \n  \n## See Also  \n [Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)","nodes":[{"pos":[12,60],"content":"How to: Cancel a Dataflow Block | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"How to: Cancel a Dataflow Block | Microsoft Docs","pos":[0,48]}]},{"pos":[505,536],"content":"How to: Cancel a Dataflow Block","linkify":"How to: Cancel a Dataflow Block","nodes":[{"content":"How to: Cancel a Dataflow Block","pos":[0,31]}]},{"content":"This document demonstrates how to enable cancellation in your application.","pos":[537,611]},{"content":"This example uses Windows Forms to show where work items are active in a dataflow pipeline and also the effects of cancellation.","pos":[612,740]},{"pos":[748,1208],"content":"[!TIP]\n The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","leadings":["","> "],"nodes":[{"content":" The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.","pos":[7,458],"nodes":[{"content":"The TPL Dataflow Library (<ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow?displayProperty=fullName&gt;</ph> namespace) is not distributed with the <ph id=\"ph2\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>.","pos":[1,183],"source":" The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=fullName> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]."},{"content":"To install the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow&gt;</ph> namespace, open your project in <ph id=\"ph2\">[!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)]</ph>, choose <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> from the Project menu, and search online for the <ph id=\"ph3\">`Microsoft.Tpl.Dataflow`</ph> package.","pos":[184,451],"source":" To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package."}]}]},{"pos":[1218,1257],"content":"To Create the Windows Forms Application","linkify":"To Create the Windows Forms Application","nodes":[{"content":"To Create the Windows Forms Application","pos":[0,39]}]},{"content":"Create a C# or Visual Basic <bpt id=\"p1\">**</bpt>Windows Forms Application<ept id=\"p1\">**</ept> project.","pos":[1267,1333],"source":"Create a C# or Visual Basic **Windows Forms Application** project."},{"content":"In the following steps, the project is named <ph id=\"ph1\">`CancellationWinForms`</ph>.","pos":[1334,1402],"source":" In the following steps, the project is named `CancellationWinForms`."},{"pos":[1412,1580],"content":"On the form designer for the main form, Form1.cs (Form1.vb for <ph id=\"ph1\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>), add a <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","source":"On the form designer for the main form, Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), add a <xref:System.Windows.Forms.ToolStrip> control."},{"content":"Add a <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripButton&gt;</ph> control to the <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","pos":[1590,1701],"source":"Add a <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control."},{"content":"Set the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A&gt;</ph> property to <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStripItemDisplayStyle&gt;</ph> and the <ph id=\"ph3\">&lt;xref:System.Windows.Forms.ToolStripItem.Text%2A&gt;</ph> property to <bpt id=\"p1\">**</bpt>Add Work Items<ept id=\"p1\">**</ept>.","pos":[1702,1923],"source":" Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle> and the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Add Work Items**."},{"content":"Add a second <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripButton&gt;</ph> control to the <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","pos":[1933,2051],"source":"Add a second <xref:System.Windows.Forms.ToolStripButton> control to the <xref:System.Windows.Forms.ToolStrip> control."},{"content":"Set the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A&gt;</ph> property to <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStripItemDisplayStyle&gt;</ph>, the <ph id=\"ph3\">&lt;xref:System.Windows.Forms.ToolStripItem.Text%2A&gt;</ph> property to <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept>, and the <ph id=\"ph4\">&lt;xref:System.Windows.Forms.ToolStripItem.Enabled%2A&gt;</ph> property to <ph id=\"ph5\">`False`</ph>.","pos":[2052,2344],"source":" Set the <xref:System.Windows.Forms.ToolStripItem.DisplayStyle%2A> property to <xref:System.Windows.Forms.ToolStripItemDisplayStyle>, the <xref:System.Windows.Forms.ToolStripItem.Text%2A> property to **Cancel**, and the <xref:System.Windows.Forms.ToolStripItem.Enabled%2A> property to `False`."},{"content":"Add four <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripProgressBar&gt;</ph> objects to the <ph id=\"ph2\">&lt;xref:System.Windows.Forms.ToolStrip&gt;</ph> control.","pos":[2354,2473],"source":"Add four <xref:System.Windows.Forms.ToolStripProgressBar> objects to the <xref:System.Windows.Forms.ToolStrip> control."},{"pos":[2482,2512],"content":"Creating the Dataflow Pipeline","linkify":"Creating the Dataflow Pipeline","nodes":[{"content":"Creating the Dataflow Pipeline","pos":[0,30]}]},{"content":"This section describes how to create the dataflow pipeline that processes work items and updates the progress bars.","pos":[2516,2631]},{"pos":[2642,2673],"content":"To Create the Dataflow Pipeline","linkify":"To Create the Dataflow Pipeline","nodes":[{"content":"To Create the Dataflow Pipeline","pos":[0,31]}]},{"content":"In your project, add a reference to System.Threading.Tasks.Dataflow.dll.","pos":[2683,2755]},{"pos":[2765,2960],"content":"Ensure that Form1.cs (Form1.vb for <ph id=\"ph1\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>) contains the following <ph id=\"ph2\">`using`</ph> statements (<ph id=\"ph3\">`Imports`</ph> in <ph id=\"ph4\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>).","source":"Ensure that Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]) contains the following `using` statements (`Imports` in [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)])."},{"pos":[2971,3316],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#1<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#1)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#1<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#1)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[TPLDataflow_CancellationWinForms#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#1)]\n [!code-vb[TPLDataflow_CancellationWinForms#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#1)]"},{"pos":[3326,3389],"content":"Add the <ph id=\"ph1\">`WorkItem`</ph> class as an inner type of the <ph id=\"ph2\">`Form1`</ph> class.","source":"Add the `WorkItem` class as an inner type of the `Form1` class."},{"pos":[3400,3745],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#2<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#2)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#2<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#2)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[TPLDataflow_CancellationWinForms#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#2)]\n [!code-vb[TPLDataflow_CancellationWinForms#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#2)]"},{"pos":[3755,3807],"content":"Add the following data members to the <ph id=\"ph1\">`Form1`</ph> class.","source":"Add the following data members to the `Form1` class."},{"pos":[3818,4163],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#3<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#3)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#3<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#3)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[TPLDataflow_CancellationWinForms#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#3)]\n [!code-vb[TPLDataflow_CancellationWinForms#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#3)]"},{"pos":[4173,4238],"content":"Add the following method, <ph id=\"ph1\">`CreatePipeline`</ph>, to the <ph id=\"ph2\">`Form1`</ph> class.","source":"Add the following method, `CreatePipeline`, to the `Form1` class."},{"pos":[4249,4594],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#4<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#4)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#4<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#4)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[TPLDataflow_CancellationWinForms#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#4)]\n [!code-vb[TPLDataflow_CancellationWinForms#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#4)]"},{"content":"Because the <ph id=\"ph1\">`incrementProgress`</ph> and <ph id=\"ph2\">`decrementProgress`</ph> dataflow blocks act on the user interface, it is important that these actions occur on the user-interface thread.","pos":[4601,4770],"source":"Because the `incrementProgress` and `decrementProgress` dataflow blocks act on the user interface, it is important that these actions occur on the user-interface thread."},{"content":"To accomplish this, during construction these objects each provide a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions&gt;</ph> object that has the <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A&gt;</ph> property set to <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName&gt;</ph>.","pos":[4771,5128],"source":" To accomplish this, during construction these objects each provide a <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions> object that has the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A> property set to <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName>."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName&gt;</ph> method creates a <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.TaskScheduler&gt;</ph> object that performs work on the current synchronization context.","pos":[5129,5365],"source":" The <xref:System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext%2A?displayProperty=fullName> method creates a <xref:System.Threading.Tasks.TaskScheduler> object that performs work on the current synchronization context."},{"content":"Because the <ph id=\"ph1\">`Form1`</ph> constructor is called from the user-interface thread, the actions for the <ph id=\"ph2\">`incrementProgress`</ph> and <ph id=\"ph3\">`decrementProgress`</ph> dataflow blocks also run on the user-interface thread.","pos":[5366,5558],"source":" Because the `Form1` constructor is called from the user-interface thread, the actions for the `incrementProgress` and `decrementProgress` dataflow blocks also run on the user-interface thread."},{"content":"This example sets the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A&gt;</ph> property when it constructs the members of the pipeline.","pos":[5565,5724],"source":"This example sets the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property when it constructs the members of the pipeline."},{"content":"Because the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A&gt;</ph> property permanently cancels dataflow block execution, the whole pipeline must be recreated after the user cancels the operation and then wants to add more work items to the pipeline.","pos":[5725,6001],"source":" Because the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property permanently cancels dataflow block execution, the whole pipeline must be recreated after the user cancels the operation and then wants to add more work items to the pipeline."},{"content":"For an example that demonstrates an alternative way to cancel a dataflow block so that other work can be performed after an operation is canceled, see <bpt id=\"p1\">[</bpt>Walkthrough: Using Dataflow in a Windows Forms Application<ept id=\"p1\">](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md)</ept>.","pos":[6002,6320],"source":" For an example that demonstrates an alternative way to cancel a dataflow block so that other work can be performed after an operation is canceled, see [Walkthrough: Using Dataflow in a Windows Forms Application](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md)."},{"pos":[6329,6383],"content":"Connecting the Dataflow Pipeline to the User Interface","linkify":"Connecting the Dataflow Pipeline to the User Interface","nodes":[{"content":"Connecting the Dataflow Pipeline to the User Interface","pos":[0,54]}]},{"content":"This section describes how to connect the dataflow pipeline to the user interface.","pos":[6387,6469]},{"content":"Both creating the pipeline and adding work items to the pipeline are controlled by the event handler for the <bpt id=\"p1\">**</bpt>Add Work Items<ept id=\"p1\">**</ept> button.","pos":[6470,6605],"source":" Both creating the pipeline and adding work items to the pipeline are controlled by the event handler for the **Add Work Items** button."},{"content":"Cancellation is initiated by the <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept> button.","pos":[6606,6657],"source":" Cancellation is initiated by the **Cancel** button."},{"content":"When the user clicks either of these buttons, the appropriate action is initiated in an asynchronous manner.","pos":[6658,6766]},{"pos":[6777,6831],"content":"To Connect the Dataflow Pipeline to the User Interface","linkify":"To Connect the Dataflow Pipeline to the User Interface","nodes":[{"content":"To Connect the Dataflow Pipeline to the User Interface","pos":[0,54]}]},{"pos":[6841,7001],"content":"On the form designer for the main form, create an event handler for the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event for the <bpt id=\"p1\">**</bpt>Add Work Items<ept id=\"p1\">**</ept> button.","source":"On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Add Work Items** button."},{"pos":[7011,7113],"content":"Implement the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event for the <bpt id=\"p1\">**</bpt>Add Work Items<ept id=\"p1\">**</ept> button.","source":"Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event for the **Add Work Items** button."},{"pos":[7124,7469],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#5<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#5)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#5<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#5)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[TPLDataflow_CancellationWinForms#5](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#5)]\n [!code-vb[TPLDataflow_CancellationWinForms#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#5)]"},{"pos":[7479,7639],"content":"On the form designer for the main form, create an event handler for the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event handler for the <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept> button.","source":"On the form designer for the main form, create an event handler for the <xref:System.Windows.Forms.ToolStripItem.Click> event handler for the **Cancel** button."},{"pos":[7649,7751],"content":"Implement the <ph id=\"ph1\">&lt;xref:System.Windows.Forms.ToolStripItem.Click&gt;</ph> event handler for the <bpt id=\"p1\">**</bpt>Cancel<ept id=\"p1\">**</ept> button.","source":"Implement the <xref:System.Windows.Forms.ToolStripItem.Click> event handler for the **Cancel** button."},{"pos":[7762,8107],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#6<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#6)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#6<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#6)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[TPLDataflow_CancellationWinForms#6](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#6)]\n [!code-vb[TPLDataflow_CancellationWinForms#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#6)]"},{"pos":[8116,8123],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[8127,8252],"content":"The following example shows the complete code for Form1.cs (Form1.vb for <ph id=\"ph1\">[!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]</ph>).","source":"The following example shows the complete code for Form1.cs (Form1.vb for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)])."},{"pos":[8259,8608],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>TPLDataflow_CancellationWinForms#100<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#100)</ept><ept id=\"p1\">]</ept> <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>TPLDataflow_CancellationWinForms#100<ept id=\"p4\">](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#100)</ept><ept id=\"p3\">]</ept>","source":"[!code-csharp[TPLDataflow_CancellationWinForms#100](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_cancellationwinforms/cs/cancellationwinforms/form1.cs#100)]\n [!code-vb[TPLDataflow_CancellationWinForms#100](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_cancellationwinforms/vb/cancellationwinforms/form1.vb#100)]"},{"content":"The following illustration shows the running application.","pos":[8615,8672]},{"pos":[8679,8818],"content":"<bpt id=\"p1\">![</bpt>The Windows Forms Application<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../docs/standard/parallel-programming/media/tpldataflow-cancellation.png \"</bpt>TPLDataflow_Cancellation<ept id=\"p2\">\")</ept>","source":"![The Windows Forms Application](../../../docs/standard/parallel-programming/media/tpldataflow-cancellation.png \"TPLDataflow_Cancellation\")"},{"pos":[8827,8845],"content":"Robust Programming","linkify":"Robust Programming","nodes":[{"content":"Robust Programming","pos":[0,18]}]},{"pos":[8854,8862],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[8866,8955],"content":"<bpt id=\"p1\">[</bpt>Dataflow<ept id=\"p1\">](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)</ept>","source":"[Dataflow](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)"}]}