{"content":"---\ntitle: \"Transport: Custom Transactions over UDP Sample\"\nms.date: \"03/30/2017\"\nms.assetid: 6cebf975-41bd-443e-9540-fd2463c3eb23\n---\n# Transport: Custom Transactions over UDP Sample\nThis sample is based on the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample in the Windows Communication Foundation (WCF)[Transport Extensibility](../../../../docs/framework/wcf/samples/transport-extensibility.md). It extends the UDP Transport sample to support custom transaction flow and demonstrates the use of the <xref:System.ServiceModel.Channels.TransactionMessageProperty> property.  \n  \n## Code Changes in the UDP Transport Sample  \n To demonstrate transaction flow, the sample changes the service contract for `ICalculatorContract` to require a transaction scope for `CalculatorService.Add()`. The sample also adds an extra `System.Guid` parameter to the contract of the `Add` operation. This parameter is used to pass the identifier of the client transaction to the service.  \n  \n```  \nclass CalculatorService : IDatagramContract, ICalculatorContract  \n{  \n    [OperationBehavior(TransactionScopeRequired=true)]  \n    public int Add(int x, int y, Guid clientTransactionId)  \n    {  \n        if(Transaction.Current.TransactionInformation.DistributedIdentifier == clientTransactionId)  \n    {  \n        Console.WriteLine(\"The client transaction has flowed to the service\");  \n    }  \n    else  \n    {  \n     Console.WriteLine(\"The client transaction has NOT flowed to the service\");  \n    }  \n  \n    Console.WriteLine(\"   adding {0} + {1}\", x, y);              \n    return (x + y);  \n    }  \n  \n    [...]  \n}  \n```  \n  \n The [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample uses UDP packets to pass messages between a client and a service. The [Transport: Custom Transport Sample](../../../../docs/framework/wcf/samples/transport-custom-transactions-over-udp-sample.md) uses the same mechanism to transport messages, but when a transaction is flowed, it is inserted into the UDP packet along with the encoded message.  \n  \n```  \nbyte[] txmsgBuffer =                TransactionMessageBuffer.WriteTransactionMessageBuffer(txPropToken, messageBuffer);  \n  \nint bytesSent = this.socket.SendTo(txmsgBuffer, 0, txmsgBuffer.Length, SocketFlags.None, this.remoteEndPoint);  \n```  \n  \n `TransactionMessageBuffer.WriteTransactionMessageBuffer` is a helper method that contains new functionality to merge the propagation token for the current transaction with the message entity and place it into a buffer.  \n  \n For custom transaction flow transport, the client implementation must know what service operations require transaction flow and to pass this information to WCF. There should also be a mechanism for transmitting the user transaction to the transport layer. This sample uses \"WCF message inspectors\" to obtain this information. The client message inspector implemented here, which is called `TransactionFlowInspector`, performs the following tasks:  \n  \n-   Determines whether a transaction must be flowed for a given message action (this takes place in `IsTxFlowRequiredForThisOperation()`).  \n  \n-   Attaches the current ambient transaction to the message using `TransactionFlowProperty`, if a transaction is required to be flowed (this is done in `BeforeSendRequest()`).  \n  \n```  \npublic class TransactionFlowInspector : IClientMessageInspector  \n{  \n   void IClientMessageInspector.AfterReceiveReply(ref           System.ServiceModel.Channels.Message reply, object correlationState)  \n  {  \n  }  \n  \n   public object BeforeSendRequest(ref System.ServiceModel.Channels.Message request, System.ServiceModel.IClientChannel channel)  \n   {  \n       // obtain the tx propagation token  \n       byte[] propToken = null;             \n       if (Transaction.Current != null && IsTxFlowRequiredForThisOperation(request.Headers.Action))  \n       {  \n           try  \n           {  \n               propToken = TransactionInterop.GetTransmitterPropagationToken(Transaction.Current);  \n           }  \n           catch (TransactionException e)  \n           {  \n              throw new CommunicationException(\"TransactionInterop.GetTransmitterPropagationToken failed.\", e);  \n           }  \n       }  \n  \n      // set the propToken on the message in a TransactionFlowProperty  \n       TransactionFlowProperty.Set(propToken, request);  \n  \n       return null;              \n    }  \n  }  \n  \n  static bool IsTxFlowRequiredForThisOperation(String action)  \n {  \n       // In general, this should contain logic to identify which operations (actions)      require transaction flow.  \n      [...]  \n }  \n}  \n```  \n  \n The `TransactionFlowInspector` itself is passed to the framework using a custom behavior: the `TransactionFlowBehavior`.  \n  \n```  \npublic class TransactionFlowBehavior : IEndpointBehavior  \n{  \n       public void AddBindingParameters(ServiceEndpoint endpoint,            System.ServiceModel.Channels.BindingParameterCollection bindingParameters)  \n      {  \n      }  \n  \n       public void ApplyClientBehavior(ServiceEndpoint endpoint, System.ServiceModel.Dispatcher.ClientRuntime clientRuntime)  \n      {  \n            TransactionFlowInspector inspector = new TransactionFlowInspector();  \n            clientRuntime.MessageInspectors.Add(inspector);  \n      }  \n  \n      public void ApplyDispatchBehavior(ServiceEndpoint endpoint, System.ServiceModel.Dispatcher.EndpointDispatcher endpointDispatcher)  \n     {  \n     }  \n  \n      public void Validate(ServiceEndpoint endpoint)  \n      {  \n      }  \n}  \n```  \n  \n With the preceding mechanism in place, the user code creates a `TransactionScope` before calling the service operation. The message inspector ensures that the transaction is passed to the transport in case it is required to be flowed to the service operation.  \n  \n```  \nCalculatorContractClient calculatorClient = new CalculatorContractClient(\"SampleProfileUdpBinding_ICalculatorContract\");  \ncalculatorClient.Endpoint.Behaviors.Add(new TransactionFlowBehavior());               \n  \ntry  \n{  \n       for (int i = 0; i < 5; ++i)  \n      {  \n              // call the 'Add' service operation under a transaction scope  \n             using (TransactionScope ts = new TransactionScope())  \n             {  \n        [...]  \n        Console.WriteLine(calculatorClient.Add(i, i * 2));  \n         }  \n      }               \n       calculatorClient.Close();  \n}  \ncatch (TimeoutException)  \n{  \n    calculatorClient.Abort();  \n}  \ncatch (CommunicationException)  \n{  \n    calculatorClient.Abort();  \n}  \ncatch (Exception)  \n{  \n    calculatorClient.Abort();  \n    throw;  \n}  \n```  \n  \n Upon receiving a UDP packet from the client, the service deserializes it to extract the message and possibly a transaction.  \n  \n```  \ncount = listenSocket.EndReceiveFrom(result, ref dummy);  \n  \n// read the transaction and message                       TransactionMessageBuffer.ReadTransactionMessageBuffer(buffer, count, out transaction, out msg);  \n```  \n  \n `TransactionMessageBuffer.ReadTransactionMessageBuffer()` is the helper method that reverses the serialization process performed by `TransactionMessageBuffer.WriteTransactionMessageBuffer()`.  \n  \n If a transaction was flowed in, it is appended to the message in the `TransactionMessageProperty`.  \n  \n```  \nmessage = MessageEncoderFactory.Encoder.ReadMessage(msg, bufferManager);  \n  \nif (transaction != null)  \n{  \n       TransactionMessageProperty.Set(transaction, message);  \n}  \n```  \n  \n This ensures that the dispatcher picks up the transaction at dispatch time and uses it when calling the service operation addressed by the message.  \n  \n#### To set up, build, and run the sample  \n  \n1.  To build the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n2.  The current sample should be run similarly to the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample. To run it, start the service with UdpTestService.exe. If you are running [!INCLUDE[windowsver](../../../../includes/windowsver-md.md)], you must start the service with elevated privileges. To do so, right-click UdpTestService.exe in [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)] and click **Run as administrator**.  \n  \n3.  This produces the following output.  \n  \n    ```  \n    Testing Udp From Code.  \n    Service is started from code...  \n    Press <ENTER> to terminate the service and start service from config...  \n    ```  \n  \n4.  At this time, you can start the client by running UdpTestClient.exe. The output produced by the client is as follows.  \n  \n    ```  \n    0  \n    3  \n    6  \n    9  \n    12  \n    Press <ENTER> to complete test.  \n    ```  \n  \n5.  The service output is as follows.  \n  \n    ```  \n    Hello, world!  \n    Hello, world!  \n    Hello, world!  \n    Hello, world!  \n    Hello, world!  \n    The client transaction has flowed to the service  \n       adding 0 + 0  \n    The client transaction has flowed to the service  \n       adding 1 + 2  \n    The client transaction has flowed to the service  \n       adding 2 + 4  \n    The client transaction has flowed to the service  \n       adding 3 + 6  \n    The client transaction has flowed to the service  \n       adding 4 + 8  \n    ```  \n  \n6.  The service application displays the message `The client transaction has flowed to the service` if it can match the transaction identifier sent by the client, in the `clientTransactionId` parameter of the `CalculatorService.Add()` operation, to the identifier of the service transaction. A match is obtained only if the client transaction has flowed to the service.  \n  \n7.  To run the client application against endpoints published using configuration, press ENTER on the service application window and then run the test client again. You should see the following output on the service.  \n  \n    ```  \n    Testing Udp From Config.  \n    Service is started from config...  \n    Press <ENTER> to terminate the service and exit...  \n    ```  \n  \n8.  Running the client against the service now produces similar output as before.  \n  \n9. To regenerate the client code and configuration using Svcutil.exe, start the service application and then run the following Svcutil.exe command from the root directory of the sample.  \n  \n    ```  \n    svcutil http://localhost:8000/udpsample/ /reference:UdpTranport\\bin\\UdpTransport.dll /svcutilConfig:svcutil.exe.config  \n    ```  \n  \n10. Note that Svcutil.exe does not generate the binding extension configuration for the `sampleProfileUdpBinding`; you must add it manually.  \n  \n    ```xml  \n    <configuration>  \n        <system.serviceModel>      \n            â€¦  \n            <extensions>  \n                <!-- This was added manually because svcutil.exe does not add this extension to the file -->  \n                <bindingExtensions>  \n                    <add name=\"sampleProfileUdpBinding\" type=\"Microsoft.ServiceModel.Samples.SampleProfileUdpBindingCollectionElement, UdpTransport\" />  \n                </bindingExtensions>  \n            </extensions>  \n        </system.serviceModel>  \n    </configuration>  \n    ```  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Extensibility\\Transactions\\TransactionMessagePropertyUDPTransport`  \n  \n## See also\n\n- [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md)\n","nodes":[{"pos":[4,130],"embed":true,"restype":"x-metadata","content":"title: \"Transport: Custom Transactions over UDP Sample\"\nms.date: \"03/30/2017\"\nms.assetid: 6cebf975-41bd-443e-9540-fd2463c3eb23","nodes":[{"content":"Transport: Custom Transactions over UDP Sample","nodes":[{"pos":[0,46],"content":"Transport: Custom Transactions over UDP Sample","nodes":[{"content":"Transport: Custom Transactions over UDP Sample","pos":[0,46]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[137,183],"content":"Transport: Custom Transactions over UDP Sample","linkify":"Transport: Custom Transactions over UDP Sample","nodes":[{"content":"Transport: Custom Transactions over UDP Sample","pos":[0,46]}]},{"content":"This sample is based on the <bpt id=\"p1\">[</bpt>Transport: UDP<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-udp.md)</ept> sample in the Windows Communication Foundation (WCF)<bpt id=\"p2\">[</bpt>Transport Extensibility<ept id=\"p2\">](../../../../docs/framework/wcf/samples/transport-extensibility.md)</ept>.","pos":[184,431],"source":"This sample is based on the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample in the Windows Communication Foundation (WCF)[Transport Extensibility](../../../../docs/framework/wcf/samples/transport-extensibility.md)."},{"content":"It extends the UDP Transport sample to support custom transaction flow and demonstrates the use of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.TransactionMessageProperty&gt;</ph> property.","pos":[432,607],"source":" It extends the UDP Transport sample to support custom transaction flow and demonstrates the use of the <xref:System.ServiceModel.Channels.TransactionMessageProperty> property."},{"pos":[616,656],"content":"Code Changes in the UDP Transport Sample","linkify":"Code Changes in the UDP Transport Sample","nodes":[{"content":"Code Changes in the UDP Transport Sample","pos":[0,40]}]},{"content":"To demonstrate transaction flow, the sample changes the service contract for <ph id=\"ph1\">`ICalculatorContract`</ph> to require a transaction scope for <ph id=\"ph2\">`CalculatorService.Add()`</ph>.","pos":[660,820],"source":"To demonstrate transaction flow, the sample changes the service contract for `ICalculatorContract` to require a transaction scope for `CalculatorService.Add()`."},{"content":"The sample also adds an extra <ph id=\"ph1\">`System.Guid`</ph> parameter to the contract of the <ph id=\"ph2\">`Add`</ph> operation.","pos":[821,914],"source":" The sample also adds an extra `System.Guid` parameter to the contract of the `Add` operation."},{"content":"This parameter is used to pass the identifier of the client transaction to the service.","pos":[915,1002]},{"content":"The <bpt id=\"p1\">[</bpt>Transport: UDP<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-udp.md)</ept> sample uses UDP packets to pass messages between a client and a service.","pos":[1647,1797],"source":"The [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample uses UDP packets to pass messages between a client and a service."},{"content":"The <bpt id=\"p1\">[</bpt>Transport: Custom Transport Sample<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-custom-transactions-over-udp-sample.md)</ept> uses the same mechanism to transport messages, but when a transaction is flowed, it is inserted into the UDP packet along with the encoded message.","pos":[1798,2075],"source":" The [Transport: Custom Transport Sample](../../../../docs/framework/wcf/samples/transport-custom-transactions-over-udp-sample.md) uses the same mechanism to transport messages, but when a transaction is flowed, it is inserted into the UDP packet along with the encoded message."},{"pos":[2335,2553],"content":"<ph id=\"ph1\">`TransactionMessageBuffer.WriteTransactionMessageBuffer`</ph> is a helper method that contains new functionality to merge the propagation token for the current transaction with the message entity and place it into a buffer.","source":"`TransactionMessageBuffer.WriteTransactionMessageBuffer` is a helper method that contains new functionality to merge the propagation token for the current transaction with the message entity and place it into a buffer."},{"content":"For custom transaction flow transport, the client implementation must know what service operations require transaction flow and to pass this information to WCF.","pos":[2560,2720]},{"content":"There should also be a mechanism for transmitting the user transaction to the transport layer.","pos":[2721,2815]},{"content":"This sample uses \"WCF message inspectors\" to obtain this information.","pos":[2816,2885]},{"content":"The client message inspector implemented here, which is called <ph id=\"ph1\">`TransactionFlowInspector`</ph>, performs the following tasks:","pos":[2886,3006],"source":" The client message inspector implemented here, which is called `TransactionFlowInspector`, performs the following tasks:"},{"pos":[3016,3150],"content":"Determines whether a transaction must be flowed for a given message action (this takes place in <ph id=\"ph1\">`IsTxFlowRequiredForThisOperation()`</ph>).","source":"Determines whether a transaction must be flowed for a given message action (this takes place in `IsTxFlowRequiredForThisOperation()`)."},{"pos":[3160,3331],"content":"Attaches the current ambient transaction to the message using <ph id=\"ph1\">`TransactionFlowProperty`</ph>, if a transaction is required to be flowed (this is done in <ph id=\"ph2\">`BeforeSendRequest()`</ph>).","source":"Attaches the current ambient transaction to the message using `TransactionFlowProperty`, if a transaction is required to be flowed (this is done in `BeforeSendRequest()`)."},{"pos":[4660,4780],"content":"The <ph id=\"ph1\">`TransactionFlowInspector`</ph> itself is passed to the framework using a custom behavior: the <ph id=\"ph2\">`TransactionFlowBehavior`</ph>.","source":"The `TransactionFlowInspector` itself is passed to the framework using a custom behavior: the `TransactionFlowBehavior`."},{"content":"With the preceding mechanism in place, the user code creates a <ph id=\"ph1\">`TransactionScope`</ph> before calling the service operation.","pos":[5575,5694],"source":"With the preceding mechanism in place, the user code creates a `TransactionScope` before calling the service operation."},{"content":"The message inspector ensures that the transaction is passed to the transport in case it is required to be flowed to the service operation.","pos":[5695,5834]},{"content":"Upon receiving a UDP packet from the client, the service deserializes it to extract the message and possibly a transaction.","pos":[6654,6777]},{"pos":[7016,7207],"content":"<ph id=\"ph1\">`TransactionMessageBuffer.ReadTransactionMessageBuffer()`</ph> is the helper method that reverses the serialization process performed by <ph id=\"ph2\">`TransactionMessageBuffer.WriteTransactionMessageBuffer()`</ph>.","source":"`TransactionMessageBuffer.ReadTransactionMessageBuffer()` is the helper method that reverses the serialization process performed by `TransactionMessageBuffer.WriteTransactionMessageBuffer()`."},{"pos":[7214,7312],"content":"If a transaction was flowed in, it is appended to the message in the <ph id=\"ph1\">`TransactionMessageProperty`</ph>.","source":"If a transaction was flowed in, it is appended to the message in the `TransactionMessageProperty`."},{"content":"This ensures that the dispatcher picks up the transaction at dispatch time and uses it when calling the service operation addressed by the message.","pos":[7510,7657]},{"pos":[7668,7704],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[7714,7884],"content":"To build the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"content":"The current sample should be run similarly to the <bpt id=\"p1\">[</bpt>Transport: UDP<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-udp.md)</ept> sample.","pos":[7894,8025],"source":"The current sample should be run similarly to the [Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md) sample."},{"content":"To run it, start the service with UdpTestService.exe.","pos":[8026,8079]},{"content":"If you are running <ph id=\"ph1\">[!INCLUDE[windowsver](../../../../includes/windowsver-md.md)]</ph>, you must start the service with elevated privileges.","pos":[8080,8214],"source":" If you are running [!INCLUDE[windowsver](../../../../includes/windowsver-md.md)], you must start the service with elevated privileges."},{"content":"To do so, right-click UdpTestService.exe in <ph id=\"ph1\">[!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)]</ph> and click <bpt id=\"p1\">**</bpt>Run as administrator<ept id=\"p1\">**</ept>.","pos":[8215,8360],"source":" To do so, right-click UdpTestService.exe in [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)] and click **Run as administrator**."},{"content":"This produces the following output.","pos":[8370,8405]},{"content":"At this time, you can start the client by running UdpTestClient.exe.","pos":[8583,8651]},{"content":"The output produced by the client is as follows.","pos":[8652,8700]},{"content":"The service output is as follows.","pos":[8812,8845]},{"content":"The service application displays the message <ph id=\"ph1\">`The client transaction has flowed to the service`</ph> if it can match the transaction identifier sent by the client, in the <ph id=\"ph2\">`clientTransactionId`</ph> parameter of the <ph id=\"ph3\">`CalculatorService.Add()`</ph> operation, to the identifier of the service transaction.","pos":[9363,9650],"source":"The service application displays the message `The client transaction has flowed to the service` if it can match the transaction identifier sent by the client, in the `clientTransactionId` parameter of the `CalculatorService.Add()` operation, to the identifier of the service transaction."},{"content":"A match is obtained only if the client transaction has flowed to the service.","pos":[9651,9728]},{"content":"To run the client application against endpoints published using configuration, press ENTER on the service application window and then run the test client again.","pos":[9738,9898]},{"content":"You should see the following output on the service.","pos":[9899,9950]},{"content":"Running the client against the service now produces similar output as before.","pos":[10111,10188]},{"content":"To regenerate the client code and configuration using Svcutil.exe, start the service application and then run the following Svcutil.exe command from the root directory of the sample.","pos":[10197,10379]},{"pos":[10537,10673],"content":"Note that Svcutil.exe does not generate the binding extension configuration for the <ph id=\"ph1\">`sampleProfileUdpBinding`</ph>; you must add it manually.","source":"Note that Svcutil.exe does not generate the binding extension configuration for the `sampleProfileUdpBinding`; you must add it manually."},{"pos":[11234,11366],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[11420,11730],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[11731,11781]},{"pos":[11903,11911],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[11915,11988],"content":"<bpt id=\"p1\">[</bpt>Transport: UDP<ept id=\"p1\">](../../../../docs/framework/wcf/samples/transport-udp.md)</ept>","source":"[Transport: UDP](../../../../docs/framework/wcf/samples/transport-udp.md)"}]}