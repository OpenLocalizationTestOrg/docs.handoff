{"content":"---\ntitle: \"SendMail Custom Activity\"\nms.date: \"03/30/2017\"\nms.assetid: 947a9ae6-379c-43a3-9cd5-87f573a5739f\n---\n# SendMail Custom Activity\nThis sample demonstrates how to create a custom activity that derives from <xref:System.Activities.AsyncCodeActivity> to send mail using SMTP for use within a workflow application. The custom activity uses the capabilities of <xref:System.Net.Mail.SmtpClient> to send email asynchronously and to send mail with authentication. It also provides some end-user features like test mode, token replacement, file templates, and test drop path.  \n  \n The following table details the arguments for the `SendMail` activity.  \n  \n|Name|Type|Description|  \n|-|-|-|  \n|Host|String|Address of the SMTP server host.|  \n|Port|String|Port of the SMTP service in the host.|  \n|EnableSsl|bool|Specifies whether the <xref:System.Net.Mail.SmtpClient> uses Secure Sockets Layer (SSL) to encrypt the connection.|  \n|UserName|String|Username to set up the credentials to authenticate the sender <xref:System.Net.Mail.SmtpClient.Credentials%2A> property.|  \n|Password|String|Password to set up the credentials to authenticate the sender <xref:System.Net.Mail.SmtpClient.Credentials%2A> property.|  \n|Subject|<xref:System.Activities.InArgument%601>\\<string>|Subject of the message.|  \n|Body|<xref:System.Activities.InArgument%601>\\<string>|Body of the message.|  \n|Attachments|<xref:System.Activities.InArgument%601>\\<string>|Attachment collection used to store data attached to this email message.|  \n|From|<xref:System.Net.Mail.MailAddress>|From address for this email message.|  \n|To|<xref:System.Activities.InArgument%601>\\<<xref:System.Net.Mail.MailAddressCollection>>|Address collection that contains the recipients of this email message.|  \n|CC|<xref:System.Activities.InArgument%601>\\<<xref:System.Net.Mail.MailAddressCollection>>|Address collection that contains the carbon copy (CC) recipients for this email message.|  \n|BCC|<xref:System.Activities.InArgument%601>\\<<xref:System.Net.Mail.MailAddressCollection>>|Address collection that contains the blind carbon copy (BCC) recipients for this email message.|  \n|Tokens|<xref:System.Activities.InArgument%601><IDictionary\\<string, string>>|Tokens to replace in the body. This feature allows users to specify some values in the body than can be replaced later by the tokens provided using this property.|  \n|BodyTemplateFilePath|String|Path of a template for the body. The `SendMail` activity copies the contents of this file to its body property.<br /><br /> The template can contain tokens that are replaced by the contents of the tokens property.|  \n|TestMailTo|<xref:System.Net.Mail.MailAddress>|When this property is set, all emails are sent to the address specified in it.<br /><br /> This property is intended to be used when testing workflows. For example, when you want to make sure that all emails are sent without sending them to the actual recipients.|  \n|TestDropPath|String|When this property is set, all emails are also saved in the specified file.<br /><br /> This property is intended to be used when you are testing or debugging workflows, to make sure that the format and contents of the outgoing emails is appropriate.|  \n  \n## Solution Contents  \n The solution contains two projects.  \n  \n|Project|Description|Important Files|  \n|-------------|-----------------|---------------------|  \n|SendMail|The SendMail activity|1.  SendMail.cs: implementation for the main activity<br />2.  SendMailDesigner.xaml and SendMailDesigner.xaml.cs: designer for the SendMail activity<br />3.  MailTemplateBody.htm: template for the email to be sent out.|  \n|SendMailTestClient|Client to test the SendMail activity.  This project demonstrates two ways of invoking the SendMail activity: declaratively, and programmatically.|1.  Sequence1.xaml: workflow that invokes the SendMail activity.<br />2.  Program.cs: invokes Sequence1 and also creates a workflow programmatically that uses SendMail.|  \n  \n## Further configuration of the SendMail activity  \n Although not shown in the sample, users can perform addition configuration of the SendMail activity. The next three sections demonstrate how this is done.  \n  \n### Sending an email using tokens specified in the body  \n This code snippet demonstrates how you can send email with tokens in the body. Notice how the tokens are provided in the body property. Values for those tokens are provided to the tokens property.  \n  \n```html  \nIDictionary<string, string> tokens = new Dictionary<string, string>();  \ntokens.Add(\"@name\", \"John Doe\");  \ntokens.Add(\"@date\", DateTime.Now.ToString());  \ntokens.Add(\"@server\", \"localhost\");  \n  \nnew SendMail  \n{  \n    From = new LambdaValue<MailAddress>(ctx => new MailAddress(\"john.doe@contoso.com\")),  \n    To = new LambdaValue<MailAddressCollection>(  \n                    ctx => new MailAddressCollection() { new MailAddress(\"someone@microsoft.com\") }),  \n    Subject = \"Test email\",  \n    Body = \"Hello @name. This is a test email sent from @server. Current date is @date\",  \n    Host = \"localhost\",  \n    Port = 25,  \n    Tokens = new LambdaValue<IDictionary<string, string>>(ctx => tokens)  \n};  \n```  \n  \n### Sending an email using a template  \n This snippet shows how to send an email using a template tokens in the body. Notice that when setting the `BodyTemplateFilePath` property we don’t need to provide the value for Body property (the contents of the template file will be copied to the body).  \n  \n```  \nnew SendMail  \n{    \n    From = new LambdaValue<MailAddress>(ctx => new MailAddress(\"john.doe@contoso.com\")),  \n    To = new LambdaValue<MailAddressCollection>(  \n                    ctx => new MailAddressCollection() { new MailAddress(\"someone@microsoft.com\") }),  \n    Subject = \"Test email\",  \n    Host = \"localhost\",  \n    Port = 25,  \n    Tokens = new LambdaValue<IDictionary<string, string>>(ctx => tokens),  \n    BodyTemplateFilePath = @\"..\\..\\..\\SendMail\\Templates\\MailTemplateBody.htm\",   \n};  \n```  \n  \n### Sending Mails in Testing Mode  \n This code snippet shows how to set the two testing properties: by setting `TestMailTo` to all messages will be sent to `john.doe@contoso.con` (without regard of the values of To, Cc, Bcc). By setting TestDropPath all outgoing emails will be also recorded in the provided path. These properties can be set independently (they are not related).  \n  \n```  \nnew SendMail  \n{    \n   From = new LambdaValue<MailAddress>(ctx => new MailAddress(\"john.doe@contoso.com\")),  \n   To = new LambdaValue<MailAddressCollection>(  \n                    ctx => new MailAddressCollection() { new MailAddress(\"someone@microsoft.com\") }),  \n   Subject = \"Test email\",  \n   Host = \"localhost\",  \n   Port = 25,  \n   Tokens = new LambdaValue<IDictionary<string, string>>(ctx => tokens),  \n   BodyTemplateFilePath = @\"..\\..\\..\\SendMail\\Templates\\MailTemplateBody.htm\",  \n   TestMailTo= new LambdaValue<MailAddress>(ctx => new MailAddress(\"john.doe@contoso.com\")),  \n   TestDropPath = @\"c:\\Samples\\SendMail\\TestDropPath\\\",  \n};  \n```  \n  \n## Set-Up Instructions  \n Access to a SMTP server is required for this sample.  \n  \n For more information about setting up a SMTP server, see the following links.  \n  \n-   [Microsoft Technet](https://go.microsoft.com/fwlink/?LinkId=166060)  \n  \n-   [Configuring the SMTP Service (IIS 6.0)](https://go.microsoft.com/fwlink/?LinkId=150456)  \n  \n-   [IIS 7.0: Configure SMTP E-Mail](https://go.microsoft.com/fwlink/?LinkId=150457)  \n  \n-   [How to Install the SMTP Service](https://go.microsoft.com/fwlink/?LinkId=150458)  \n  \n SMTP emulators provided by third parties are available for download.  \n  \n##### To run this sample  \n  \n1.  Using Visual Studio 2010, open the SendMail.sln solution file.  \n  \n2.  Ensure that you have access to a valid SMTP server. See the set-up instructions.  \n  \n3.  Configure the program with your server address, and From and To email addresses.  \n  \n     To correctly run this sample, you may need to configure the value of From and To email addresses and the address of the SMTP server in  Program.cs and in Sequence.xaml. You will need to change the address in both locations since the program sends mail in two different ways  \n  \n4.  To build the solution, press CTRL+SHIFT+B.  \n  \n5.  To run the solution, press CTRL+F5.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WF\\Scenario\\ActivityLibrary\\SendMail`","nodes":[{"pos":[4,108],"embed":true,"restype":"x-metadata","content":"title: \"SendMail Custom Activity\"\nms.date: \"03/30/2017\"\nms.assetid: 947a9ae6-379c-43a3-9cd5-87f573a5739f","nodes":[{"content":"SendMail Custom Activity","nodes":[{"pos":[0,24],"content":"SendMail Custom Activity","nodes":[{"content":"SendMail Custom Activity","pos":[0,24]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[115,139],"content":"SendMail Custom Activity","linkify":"SendMail Custom Activity","nodes":[{"content":"SendMail Custom Activity","pos":[0,24]}]},{"content":"This sample demonstrates how to create a custom activity that derives from <ph id=\"ph1\">&lt;xref:System.Activities.AsyncCodeActivity&gt;</ph> to send mail using SMTP for use within a workflow application.","pos":[140,320],"source":"This sample demonstrates how to create a custom activity that derives from <xref:System.Activities.AsyncCodeActivity> to send mail using SMTP for use within a workflow application."},{"content":"The custom activity uses the capabilities of <ph id=\"ph1\">&lt;xref:System.Net.Mail.SmtpClient&gt;</ph> to send email asynchronously and to send mail with authentication.","pos":[321,466],"source":" The custom activity uses the capabilities of <xref:System.Net.Mail.SmtpClient> to send email asynchronously and to send mail with authentication."},{"content":"It also provides some end-user features like test mode, token replacement, file templates, and test drop path.","pos":[467,577]},{"pos":[584,654],"content":"The following table details the arguments for the <ph id=\"ph1\">`SendMail`</ph> activity.","source":"The following table details the arguments for the `SendMail` activity."},{"content":"Name","pos":[661,665]},{"content":"Type","pos":[666,670]},{"content":"Description","pos":[671,682]},{"content":"Host","pos":[697,701]},{"content":"String","pos":[702,708]},{"content":"Address of the SMTP server host.","pos":[709,741]},{"content":"Port","pos":[746,750]},{"content":"String","pos":[751,757]},{"content":"Port of the SMTP service in the host.","pos":[758,795]},{"content":"EnableSsl","pos":[800,809]},{"content":"bool","pos":[810,814]},{"pos":[815,929],"content":"Specifies whether the <ph id=\"ph1\">&lt;xref:System.Net.Mail.SmtpClient&gt;</ph> uses Secure Sockets Layer (SSL) to encrypt the connection.","source":"Specifies whether the <xref:System.Net.Mail.SmtpClient> uses Secure Sockets Layer (SSL) to encrypt the connection."},{"content":"UserName","pos":[934,942]},{"content":"String","pos":[943,949]},{"pos":[950,1070],"content":"Username to set up the credentials to authenticate the sender <ph id=\"ph1\">&lt;xref:System.Net.Mail.SmtpClient.Credentials%2A&gt;</ph> property.","source":"Username to set up the credentials to authenticate the sender <xref:System.Net.Mail.SmtpClient.Credentials%2A> property."},{"content":"Password","pos":[1075,1083]},{"content":"String","pos":[1084,1090]},{"pos":[1091,1211],"content":"Password to set up the credentials to authenticate the sender <ph id=\"ph1\">&lt;xref:System.Net.Mail.SmtpClient.Credentials%2A&gt;</ph> property.","source":"Password to set up the credentials to authenticate the sender <xref:System.Net.Mail.SmtpClient.Credentials%2A> property."},{"content":"Subject","pos":[1216,1223]},{"pos":[1224,1272],"content":"<ph id=\"ph1\">&lt;xref:System.Activities.InArgument%601&gt;</ph><ph id=\"ph2\">\\&lt;</ph>string&gt;","source":"<xref:System.Activities.InArgument%601>\\<string>"},{"content":"Subject of the message.","pos":[1273,1296]},{"content":"Body","pos":[1301,1305]},{"pos":[1306,1354],"content":"<ph id=\"ph1\">&lt;xref:System.Activities.InArgument%601&gt;</ph><ph id=\"ph2\">\\&lt;</ph>string&gt;","source":"<xref:System.Activities.InArgument%601>\\<string>"},{"content":"Body of the message.","pos":[1355,1375]},{"content":"Attachments","pos":[1380,1391]},{"pos":[1392,1440],"content":"<ph id=\"ph1\">&lt;xref:System.Activities.InArgument%601&gt;</ph><ph id=\"ph2\">\\&lt;</ph>string&gt;","source":"<xref:System.Activities.InArgument%601>\\<string>"},{"content":"Attachment collection used to store data attached to this email message.","pos":[1441,1513]},{"content":"From","pos":[1518,1522]},{"content":"From address for this email message.","pos":[1558,1594]},{"content":"To","pos":[1599,1601]},{"content":"Address collection that contains the recipients of this email message.","pos":[1689,1759]},{"content":"CC","pos":[1764,1766]},{"content":"Address collection that contains the carbon copy (CC) recipients for this email message.","pos":[1854,1942]},{"content":"BCC","pos":[1947,1950]},{"content":"Address collection that contains the blind carbon copy (BCC) recipients for this email message.","pos":[2038,2133]},{"content":"Tokens","pos":[2138,2144]},{"pos":[2145,2214],"content":"<ph id=\"ph1\">&lt;xref:System.Activities.InArgument%601&gt;</ph>&lt;IDictionary<ph id=\"ph2\">\\&lt;</ph>string, string&gt;&gt;","source":"<xref:System.Activities.InArgument%601><IDictionary\\<string, string>>"},{"content":"Tokens to replace in the body.","pos":[2215,2245]},{"content":"This feature allows users to specify some values in the body than can be replaced later by the tokens provided using this property.","pos":[2246,2377]},{"content":"BodyTemplateFilePath","pos":[2382,2402]},{"content":"String","pos":[2403,2409]},{"content":"Path of a template for the body.","pos":[2410,2442]},{"content":"The <ph id=\"ph1\">`SendMail`</ph> activity copies the contents of this file to its body property.","pos":[2443,2521],"source":" The `SendMail` activity copies the contents of this file to its body property."},{"content":"The template can contain tokens that are replaced by the contents of the tokens property.","pos":[2534,2623]},{"content":"TestMailTo","pos":[2628,2638]},{"content":"When this property is set, all emails are sent to the address specified in it.","pos":[2674,2752]},{"content":"This property is intended to be used when testing workflows.","pos":[2765,2825]},{"content":"For example, when you want to make sure that all emails are sent without sending them to the actual recipients.","pos":[2826,2937]},{"content":"TestDropPath","pos":[2942,2954]},{"content":"String","pos":[2955,2961]},{"content":"When this property is set, all emails are also saved in the specified file.","pos":[2962,3037]},{"content":"This property is intended to be used when you are testing or debugging workflows, to make sure that the format and contents of the outgoing emails is appropriate.","pos":[3050,3212]},{"pos":[3222,3239],"content":"Solution Contents","linkify":"Solution Contents","nodes":[{"content":"Solution Contents","pos":[0,17]}]},{"content":"The solution contains two projects.","pos":[3243,3278]},{"content":"Project","pos":[3285,3292]},{"content":"Description","pos":[3293,3304]},{"content":"Important Files","pos":[3305,3320]},{"content":"SendMail","pos":[3383,3391]},{"content":"The SendMail activity","pos":[3392,3413]},{"content":"1.  SendMail.cs: implementation for the main activity","pos":[3414,3467]},{"content":"2.  SendMailDesigner.xaml and SendMailDesigner.xaml.cs: designer for the SendMail activity","pos":[3473,3563]},{"content":"3.  MailTemplateBody.htm: template for the email to be sent out.","pos":[3569,3633]},{"content":"SendMailTestClient","pos":[3638,3656]},{"content":"Client to test the SendMail activity.","pos":[3657,3694]},{"content":"This project demonstrates two ways of invoking the SendMail activity: declaratively, and programmatically.","pos":[3696,3802]},{"content":"1.  Sequence1.xaml: workflow that invokes the SendMail activity.","pos":[3803,3867]},{"content":"2.  Program.cs: invokes Sequence1 and also creates a workflow programmatically that uses SendMail.","pos":[3873,3971]},{"pos":[3981,4027],"content":"Further configuration of the SendMail activity","linkify":"Further configuration of the SendMail activity","nodes":[{"content":"Further configuration of the SendMail activity","pos":[0,46]}]},{"content":"Although not shown in the sample, users can perform addition configuration of the SendMail activity.","pos":[4031,4131]},{"content":"The next three sections demonstrate how this is done.","pos":[4132,4185]},{"pos":[4195,4246],"content":"Sending an email using tokens specified in the body","linkify":"Sending an email using tokens specified in the body","nodes":[{"content":"Sending an email using tokens specified in the body","pos":[0,51]}]},{"content":"This code snippet demonstrates how you can send email with tokens in the body.","pos":[4250,4328]},{"content":"Notice how the tokens are provided in the body property.","pos":[4329,4385]},{"content":"Values for those tokens are provided to the tokens property.","pos":[4386,4446]},{"pos":[5181,5214],"content":"Sending an email using a template","linkify":"Sending an email using a template","nodes":[{"content":"Sending an email using a template","pos":[0,33]}]},{"content":"This snippet shows how to send an email using a template tokens in the body.","pos":[5218,5294]},{"content":"Notice that when setting the <ph id=\"ph1\">`BodyTemplateFilePath`</ph> property we don’t need to provide the value for Body property (the contents of the template file will be copied to the body).","pos":[5295,5472],"source":" Notice that when setting the `BodyTemplateFilePath` property we don’t need to provide the value for Body property (the contents of the template file will be copied to the body)."},{"pos":[6001,6030],"content":"Sending Mails in Testing Mode","linkify":"Sending Mails in Testing Mode","nodes":[{"content":"Sending Mails in Testing Mode","pos":[0,29]}]},{"content":"This code snippet shows how to set the two testing properties: by setting <ph id=\"ph1\">`TestMailTo`</ph> to all messages will be sent to <ph id=\"ph2\">`john.doe@contoso.con`</ph> (without regard of the values of To, Cc, Bcc).","pos":[6034,6222],"source":"This code snippet shows how to set the two testing properties: by setting `TestMailTo` to all messages will be sent to `john.doe@contoso.con` (without regard of the values of To, Cc, Bcc)."},{"content":"By setting TestDropPath all outgoing emails will be also recorded in the provided path.","pos":[6223,6310]},{"content":"These properties can be set independently (they are not related).","pos":[6311,6376]},{"pos":[7049,7068],"content":"Set-Up Instructions","linkify":"Set-Up Instructions","nodes":[{"content":"Set-Up Instructions","pos":[0,19]}]},{"content":"Access to a SMTP server is required for this sample.","pos":[7072,7124]},{"content":"For more information about setting up a SMTP server, see the following links.","pos":[7131,7208]},{"pos":[7218,7285],"content":"<bpt id=\"p1\">[</bpt>Microsoft Technet<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=166060)</ept>","source":"[Microsoft Technet](https://go.microsoft.com/fwlink/?LinkId=166060)"},{"pos":[7295,7383],"content":"<bpt id=\"p1\">[</bpt>Configuring the SMTP Service (IIS 6.0)<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150456)</ept>","source":"[Configuring the SMTP Service (IIS 6.0)](https://go.microsoft.com/fwlink/?LinkId=150456)"},{"pos":[7393,7473],"content":"<bpt id=\"p1\">[</bpt>IIS 7.0: Configure SMTP E-Mail<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150457)</ept>","source":"[IIS 7.0: Configure SMTP E-Mail](https://go.microsoft.com/fwlink/?LinkId=150457)"},{"pos":[7483,7564],"content":"<bpt id=\"p1\">[</bpt>How to Install the SMTP Service<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150458)</ept>","source":"[How to Install the SMTP Service](https://go.microsoft.com/fwlink/?LinkId=150458)"},{"content":"SMTP emulators provided by third parties are available for download.","pos":[7571,7639]},{"pos":[7651,7669],"content":"To run this sample","linkify":"To run this sample","nodes":[{"content":"To run this sample","pos":[0,18]}]},{"content":"Using Visual Studio 2010, open the SendMail.sln solution file.","pos":[7679,7741]},{"content":"Ensure that you have access to a valid SMTP server.","pos":[7751,7802]},{"content":"See the set-up instructions.","pos":[7803,7831]},{"content":"Configure the program with your server address, and From and To email addresses.","pos":[7841,7921]},{"content":"To correctly run this sample, you may need to configure the value of From and To email addresses and the address of the SMTP server in  Program.cs and in Sequence.xaml.","pos":[7932,8100]},{"content":"You will need to change the address in both locations since the program sends mail in two different ways","pos":[8101,8205]},{"content":"To build the solution, press CTRL+SHIFT+B.","pos":[8215,8257]},{"content":"To run the solution, press CTRL+F5.","pos":[8267,8302]},{"pos":[8310,8442],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[8496,8806],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[8807,8857]}]}