{"content":"---\ntitle: \"Compensation | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 722e9766-48d7-456c-9496-d7c5c8f0fa76\ncaps.latest.revision: 26\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Compensation\nCompensation in [!INCLUDE[wf](../../../includes/wf-md.md)] is the mechanism by which previously completed work can be undone or compensated (following the logic defined by the application) when a subsequent failure occurs. This section describes how to use compensation in workflows.  \n  \n## Compensation vs. Transactions  \n A transaction allows you to combine multiple operations into a single unit of work. Using a transaction gives your application the ability to abort (roll back) all changes executed from within the transaction if any errors occur during any part of the transaction process. However, using transactions may not be appropriate if the work is long running. For example, a travel planning application is implemented as a workflow. The steps of the workflow may consist of booking a flight, waiting for manager approval, and then paying for the flight. This process could take many days and it is not practical for the steps of booking and paying for the flight to participate in the same transaction. In a scenario such as this, compensation could be used to undo the booking step of the workflow if there is a failure later in the processing.  \n  \n> [!NOTE]\n>  This topic covers compensation in workflows. [!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions in workflows, see [Transactions](../../../docs/framework/windows-workflow-foundation/workflow-transactions.md) and <xref:System.Activities.Statements.TransactionScope>. [!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions, see <xref:System.Transactions?displayProperty=fullName> and <xref:System.Transactions.Transaction?displayProperty=fullName>.  \n  \n## Using CompensableActivity  \n <xref:System.Activities.Statements.CompensableActivity> is the core compensation activity in [!INCLUDE[wf1](../../../includes/wf1-md.md)]. Any activities that perform work that may need to be compensated are placed into the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of a <xref:System.Activities.Statements.CompensableActivity>. In this example, the reservation step of purchasing a flight is placed into the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of a <xref:System.Activities.Statements.CompensableActivity> and the cancellation of the reservation is placed into the <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A>. Immediately following the <xref:System.Activities.Statements.CompensableActivity> in the workflow are two activities that wait for manager approval and then complete the purchasing step of the flight. If an error condition causes the workflow to be canceled after the <xref:System.Activities.Statements.CompensableActivity> has successfully completed, then the activities in the <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A> handler are scheduled and the flight is canceled.  \n  \n [!code-csharp[CFX_CompensationExample#1](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#1)]  \n  \n The following example is the workflow in XAML.  \n  \n```xaml  \n<Sequence  \n   xmlns=\"http://schemas.microsoft.com/netfx/2009/xaml/activities\"  \n   xmlns:c=\"clr-namespace:CompensationExample;assembly=CompensationExample\"  \n   xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\">  \n  <CompensableActivity>  \n    <CompensableActivity.Result>  \n      <OutArgument  \n         x:TypeArguments=\"CompensationToken\" />  \n    </CompensableActivity.Result>  \n    <CompensableActivity.CompensationHandler>  \n      <c:CancelFlight />  \n    </CompensableActivity.CompensationHandler>  \n    <c:ReserveFlight />  \n  </CompensableActivity>  \n  <c:ManagerApproval />  \n  <c:PurchaseFlight />  \n</Sequence>  \n```  \n  \n When the workflow is invoked, the following output is displayed to the console.  \n  \n **ReserveFlight: Ticket is reserved.**   \n**ManagerApproval: Manager approval received.**   \n**PurchaseFlight: Ticket is purchased.**   \n**Workflow completed successfully with status: Closed.**    \n> [!NOTE]\n>  The sample activities in this topic such as `ReserveFlight` display their name and purpose to the console to help illustrate the order in which the activities are executed when compensation occurs.  \n  \n### Default Workflow Compensation  \n By default, if the workflow is canceled, the compensation logic is run for any compensable activity that has successfully completely and has not already been confirmed or compensated.  \n  \n> [!NOTE]\n>  When a <xref:System.Activities.Statements.CompensableActivity> is *confirmed*, compensation for the activity can no longer be invoked. The confirmation process is described later in this section.  \n  \n In this example, an exception is thrown after the flight is reserved but before the manager approval step.  \n  \n [!code-csharp[CFX_CompensationExample#2](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#2)]  \n  \n This example is the workflow in XAML.  \n  \n```xaml  \n<Sequence  \n   xmlns=\"http://schemas.microsoft.com/netfx/2009/xaml/activities\"  \n   xmlns:c=\"clr-namespace:CompensationExample;assembly=CompensationExample\"  \n   xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\">  \n  <CompensableActivity>  \n    <CompensableActivity.Result>  \n      <OutArgument  \n         x:TypeArguments=\"CompensationToken\" />  \n    </CompensableActivity.Result>  \n    <CompensableActivity.CompensationHandler>  \n      <c:CancelFlight />  \n    </CompensableActivity.CompensationHandler>  \n    <c:ReserveFlight />  \n  </CompensableActivity>  \n  <c:SimulatedErrorCondition />  \n  <c:ManagerApproval />  \n  <c:PurchaseFlight />  \n</Sequence>  \n```  \n  \n [!code-csharp[CFX_CompensationExample#100](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#100)]  \n  \n When the workflow is invoked, the simulated error condition exception is handled by the host application in <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>, the workflow is canceled, and the compensation logic is invoked.  \n  \n **ReserveFlight: Ticket is reserved.**   \n**SimulatedErrorCondition: Throwing an ApplicationException.**   \n**Workflow Unhandled Exception:**   \n**System.ApplicationException: Simulated error condition in the workflow.**   \n**CancelFlight: Ticket is canceled.**   \n**Workflow completed successfully with status: Canceled.**    \n### Cancellation and CompensableActivity  \n If the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of a <xref:System.Activities.Statements.CompensableActivity> have not completed and the activity is canceled, the activities in the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are executed.  \n  \n> [!NOTE]\n>  The <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> is only invoked if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have not completed and the activity is canceled. The <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A> is only executed if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have successfully completed and compensation is subsequently invoked on the activity.  \n  \n The <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> gives workflow authors the opportunity to provide any appropriate cancellation logic. In the following example, an exception is thrown during the execution of the <xref:System.Activities.Statements.CompensableActivity.Body%2A>, and then the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> is invoked.  \n  \n```csharp  \nActivity wf = new Sequence()  \n{  \n    Activities =  \n    {  \n        new CompensableActivity  \n        {  \n            Body = new Sequence  \n            {  \n                Activities =   \n                {  \n                    new ChargeCreditCard(),  \n                    new SimulatedErrorCondition(),  \n                    new ReserveFlight()  \n                }  \n            },  \n            CompensationHandler = new CancelFlight(),  \n            CancellationHandler = new CancelCreditCard()  \n        },  \n        new ManagerApproval(),  \n        new PurchaseFlight()  \n    }  \n};  \n  \n```  \n  \n This example is the workflow in XAML  \n  \n```xaml  \n<Sequence  \n   xmlns=\"http://schemas.microsoft.com/netfx/2009/xaml/activities\"  \n   xmlns:c=\"clr-namespace:CompensationExample;assembly=CompensationExample\"  \n   xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\">  \n  <CompensableActivity>  \n    <CompensableActivity.Result>  \n      <OutArgument  \n         x:TypeArguments=\"CompensationToken\" />  \n    </CompensableActivity.Result>  \n    <Sequence>  \n      <c:ChargeCreditCard />  \n      <c:SimulatedErrorCondition />  \n      <c:ReserveFlight />  \n    </Sequence>  \n    <CompensableActivity.CancellationHandler>  \n      <c:CancelCreditCard />  \n    </CompensableActivity.CancellationHandler>  \n    <CompensableActivity.CompensationHandler>  \n      <c:CancelFlight />  \n    </CompensableActivity.CompensationHandler>  \n  </CompensableActivity>  \n  <c:ManagerApproval />  \n  <c:PurchaseFlight />  \n</Sequence>  \n```  \n  \n When the workflow is invoked, the simulated error condition exception is handled by the host application in <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>, the workflow is canceled, and the cancellation logic of the <xref:System.Activities.Statements.CompensableActivity> is invoked. In this example, the compensation logic and the cancellation logic have different goals. If the <xref:System.Activities.Statements.CompensableActivity.Body%2A> completed successfully, then this means the credit card was charged and the flight booked, so the compensation should undo both steps. (In this example, canceling the flight automatically cancels the credit card charges.) However, if the <xref:System.Activities.Statements.CompensableActivity> is canceled, this means the <xref:System.Activities.Statements.CompensableActivity.Body%2A> did not complete and so the logic of the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> needs to be able to determine how to best handle the cancellation. In this example, the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> cancels the credit card charge, but since `ReserveFlight` was the last activity in the <xref:System.Activities.Statements.CompensableActivity.Body%2A>, it does not attempt to cancel the flight. Since `ReserveFlight` was the last activity in the <xref:System.Activities.Statements.CompensableActivity.Body%2A>, if it had successfully completed then the <xref:System.Activities.Statements.CompensableActivity.Body%2A> would have completed and no cancellation would be possible.  \n  \n **ChargeCreditCard: Charge credit card for flight.**   \n**SimulatedErrorCondition: Throwing an ApplicationException.**   \n**Workflow Unhandled Exception:**   \n**System.ApplicationException: Simulated error condition in the workflow.**   \n**CancelCreditCard: Cancel credit card charges.**   \n**Workflow completed successfully with status: Canceled.**  [!INCLUDE[crabout](../../../includes/crabout-md.md)] cancellation, see [Cancellation](../../../docs/framework/windows-workflow-foundation/modeling-cancellation-behavior-in-workflows.md).  \n  \n### Explicit Compensation Using the Compensate Activity  \n In the previous section, implicit compensation was covered. Implicit compensation can be appropriate for simple scenarios, but if more explicit control is required over the scheduling of compensation handling then the <xref:System.Activities.Statements.Compensate> activity can be used. To initiate the compensation process with the <xref:System.Activities.Statements.Compensate> activity, the <xref:System.Activities.Statements.CompensationToken> of the <xref:System.Activities.Statements.CompensableActivity> for which compensation is desired is used. The <xref:System.Activities.Statements.Compensate> activity can be used to initiate compensation on any completed <xref:System.Activities.Statements.CompensableActivity> that has not been confirmed or compensated. For example, a <xref:System.Activities.Statements.Compensate> activity could be used in the <xref:System.Activities.Statements.TryCatch.Catches%2A> section of a <xref:System.Activities.Statements.TryCatch> activity, or any time after the <xref:System.Activities.Statements.CompensableActivity> has completed. In this example, the <xref:System.Activities.Statements.Compensate> activity is used in the <xref:System.Activities.Statements.TryCatch.Catches%2A> section of a <xref:System.Activities.Statements.TryCatch> activity to reverse the action of the <xref:System.Activities.Statements.CompensableActivity>.  \n  \n [!code-csharp[CFX_CompensationExample#3](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#3)]  \n  \n This example is the workflow in XAML.  \n  \n```xaml  \n<TryCatch  \n   xmlns=\"http://schemas.microsoft.com/netfx/2009/xaml/activities\"  \n   xmlns:c=\"clr-namespace:CompensationExample;assembly=CompensationExample\"  \n   xmlns:s=\"clr-namespace:System;assembly=mscorlib\"  \n   xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\">  \n  <TryCatch.Variables>  \n    <Variable  \n       x:TypeArguments=\"CompensationToken\"  \n       x:Name=\"__ReferenceID0\"  \n       Name=\"token1\" />  \n  </TryCatch.Variables>  \n  <TryCatch.Try>  \n    <Sequence>  \n      <CompensableActivity>  \n        <CompensableActivity.Result>  \n          <OutArgument  \n             x:TypeArguments=\"CompensationToken\">  \n            <VariableReference  \n               x:TypeArguments=\"CompensationToken\"  \n               Variable=\"{x:Reference __ReferenceID0}\">  \n              <VariableReference.Result>  \n                <OutArgument  \n                   x:TypeArguments=\"Location(CompensationToken)\" />  \n              </VariableReference.Result>  \n            </VariableReference>  \n          </OutArgument>  \n        </CompensableActivity.Result>  \n        <CompensableActivity.CompensationHandler>  \n          <c:CancelFlight />  \n        </CompensableActivity.CompensationHandler>  \n        <CompensableActivity.ConfirmationHandler>  \n          <c:ConfirmFlight />  \n        </CompensableActivity.ConfirmationHandler>  \n        <c:ReserveFlight />  \n      </CompensableActivity>  \n      <c:SimulatedErrorCondition />  \n      <c:ManagerApproval />  \n      <c:PurchaseFlight />  \n    </Sequence>  \n  </TryCatch.Try>  \n  <TryCatch.Catches>  \n    <Catch  \n       x:TypeArguments=\"s:ApplicationException\">  \n      <ActivityAction  \n         x:TypeArguments=\"s:ApplicationException\">  \n        <Compensate>  \n          <Compensate.Target>  \n            <InArgument  \n               x:TypeArguments=\"CompensationToken\">  \n              <VariableValue  \n                 x:TypeArguments=\"CompensationToken\"  \n                 Variable=\"{x:Reference __ReferenceID0}\">  \n                <VariableValue.Result>  \n                  <OutArgument  \n                     x:TypeArguments=\"CompensationToken\" />  \n                </VariableValue.Result>  \n              </VariableValue>  \n            </InArgument>  \n          </Compensate.Target>  \n        </Compensate>  \n      </ActivityAction>  \n    </Catch>  \n  </TryCatch.Catches>  \n</TryCatch>  \n```  \n  \n When the workflow is invoked, the following output is displayed to the console.  \n  \n **ReserveFlight: Ticket is reserved.**   \n**SimulatedErrorCondition: Throwing an ApplicationException.**   \n**CancelFlight: Ticket is canceled.**   \n**Workflow completed successfully with status: Closed.**    \n### Confirming Compensation  \n By default, compensable activities can be compensated any time after they have completed. In some scenarios this may not be appropriate. In the previous example the compensation to reserving the ticket was to cancel the reservation. However, after the flight has been completed this compensation step is no longer valid. Confirming the compensable activity invokes the activity specified by the <xref:System.Activities.Statements.CompensableActivity.ConfirmationHandler%2A>. One possible use for this is to allow any resources that are necessary to perform the compensation to be released. After a compensable activity is confirmed it is not possible for it to be compensated, and if this is attempted an <xref:System.InvalidOperationException> exception is thrown. When a workflow completes successfully, all non-confirmed and non-compensated compensable activities that completed successfully are confirmed in reverse order of completion. In this example the flight is reserved, purchased, and completed, and then the compensable activity is confirmed. To confirm a <xref:System.Activities.Statements.CompensableActivity>, use the <xref:System.Activities.Statements.Confirm> activity and specify the <xref:System.Activities.Statements.CompensationToken> of the <xref:System.Activities.Statements.CompensableActivity> to confirm.  \n  \n [!code-csharp[CFX_CompensationExample#4](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#4)]  \n  \n This example is the workflow in XAML.  \n  \n```xaml  \n<Sequence  \n   xmlns=\"http://schemas.microsoft.com/netfx/2009/xaml/activities\"  \n   xmlns:c=\"clr-namespace:CompensationExample;assembly=CompensationExample\"  \n   xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\">  \n  <Sequence.Variables>  \n    <x:Reference>__ReferenceID0</x:Reference>  \n  </Sequence.Variables>  \n  <CompensableActivity>  \n    <CompensableActivity.Result>  \n      <OutArgument  \n         x:TypeArguments=\"CompensationToken\">  \n        <VariableReference  \n           x:TypeArguments=\"CompensationToken\">  \n          <VariableReference.Result>  \n            <OutArgument  \n               x:TypeArguments=\"Location(CompensationToken)\" />  \n          </VariableReference.Result>  \n          <VariableReference.Variable>  \n            <Variable  \n               x:TypeArguments=\"CompensationToken\"  \n               x:Name=\"__ReferenceID0\"  \n               Name=\"token1\" />  \n          </VariableReference.Variable>  \n        </VariableReference>  \n      </OutArgument>  \n    </CompensableActivity.Result>  \n    <CompensableActivity.CompensationHandler>  \n      <c:CancelFlight />  \n    </CompensableActivity.CompensationHandler>  \n    <CompensableActivity.ConfirmationHandler>  \n      <c:ConfirmFlight />  \n    </CompensableActivity.ConfirmationHandler>  \n    <c:ReserveFlight />  \n  </CompensableActivity>  \n  <c:ManagerApproval />  \n  <c:PurchaseFlight />  \n  <c:TakeFlight />  \n  <Confirm>  \n    <Confirm.Target>  \n      <InArgument  \n         x:TypeArguments=\"CompensationToken\">  \n        <VariableValue  \n           x:TypeArguments=\"CompensationToken\"  \n           Variable=\"{x:Reference __ReferenceID0}\">  \n          <VariableValue.Result>  \n            <OutArgument  \n               x:TypeArguments=\"CompensationToken\" />  \n          </VariableValue.Result>  \n        </VariableValue>  \n      </InArgument>  \n    </Confirm.Target>  \n  </Confirm>  \n</Sequence>  \n```  \n  \n When the workflow is invoked, the following output is displayed to the console.  \n  \n **ReserveFlight: Ticket is reserved.**   \n**ManagerApproval: Manager approval received.**   \n**PurchaseFlight: Ticket is purchased.**   \n**TakeFlight: Flight is completed.**   \n**ConfirmFlight: Flight has been taken, no compensation possible.**   \n**Workflow completed successfully with status: Closed.**   \n## Nesting Compensation Activities  \n A <xref:System.Activities.Statements.CompensableActivity> can be placed into the <xref:System.Activities.Statements.CompensableActivity.Body%2A> section of another <xref:System.Activities.Statements.CompensableActivity>. A <xref:System.Activities.Statements.CompensableActivity> may not be placed into a handler of another <xref:System.Activities.Statements.CompensableActivity>. It is the responsibility of a parent <xref:System.Activities.Statements.CompensableActivity> to ensure that when it is canceled, confirmed, or compensated, all child compensable activities that have completed successfully and have not already been confirmed or compensated must be confirmed or compensated before the parent completes cancellation, confirmation, or compensation. If this is not modeled explicitly the parent <xref:System.Activities.Statements.CompensableActivity> will implicitly compensate child compensable activities if the parent received the cancel or compensate signal. If the parent received the confirm signal the parent will implicitly confirm child compensable activities. If the logic to handle cancellation, confirmation, or compensation is explicitly modeled in the handler of the parent <xref:System.Activities.Statements.CompensableActivity>, any child not explicitly handled will be implicitly confirmed.  \n  \n## See Also  \n <xref:System.Activities.Statements.CompensableActivity>   \n <xref:System.Activities.Statements.Compensate>   \n <xref:System.Activities.Statements.Confirm>   \n <xref:System.Activities.Statements.CompensationToken>   \n [Compensable Activity](../../../docs/framework/windows-workflow-foundation/samples/compensable-activity-sample.md)","nodes":[{"pos":[4,300],"nodes":[{"content":"Compensation | Microsoft Docs","nodes":[{"pos":[0,29],"content":"Compensation | Microsoft Docs","nodes":[{"content":"Compensation | Microsoft Docs","pos":[0,29]}]}],"pos":[6,38],"yaml":true}],"content":"title: \"Compensation | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 722e9766-48d7-456c-9496-d7c5c8f0fa76\ncaps.latest.revision: 26\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","yamlblock":true},{"pos":[307,319],"content":"Compensation","linkify":"Compensation","nodes":[{"content":"Compensation","pos":[0,12]}]},{"content":"Compensation in <ph id=\"ph1\">[!INCLUDE[wf](../../../includes/wf-md.md)]</ph> is the mechanism by which previously completed work can be undone or compensated (following the logic defined by the application) when a subsequent failure occurs.","pos":[320,542],"source":"Compensation in [!INCLUDE[wf](../../../includes/wf-md.md)] is the mechanism by which previously completed work can be undone or compensated (following the logic defined by the application) when a subsequent failure occurs."},{"content":"This section describes how to use compensation in workflows.","pos":[543,603]},{"pos":[612,641],"content":"Compensation vs. Transactions","linkify":"Compensation vs. Transactions","nodes":[{"content":"Compensation vs. Transactions","pos":[0,29]}]},{"content":"A transaction allows you to combine multiple operations into a single unit of work.","pos":[645,728]},{"content":"Using a transaction gives your application the ability to abort (roll back) all changes executed from within the transaction if any errors occur during any part of the transaction process.","pos":[729,917]},{"content":"However, using transactions may not be appropriate if the work is long running.","pos":[918,997]},{"content":"For example, a travel planning application is implemented as a workflow.","pos":[998,1070]},{"content":"The steps of the workflow may consist of booking a flight, waiting for manager approval, and then paying for the flight.","pos":[1071,1191]},{"content":"This process could take many days and it is not practical for the steps of booking and paying for the flight to participate in the same transaction.","pos":[1192,1340]},{"content":"In a scenario such as this, compensation could be used to undo the booking step of the workflow if there is a failure later in the processing.","pos":[1341,1483]},{"pos":[1491,1973],"content":"[!NOTE]\n This topic covers compensation in workflows. [!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions in workflows, see [Transactions](../../../docs/framework/windows-workflow-foundation/workflow-transactions.md) and <xref:System.Activities.Statements.TransactionScope>. [!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions, see <xref:System.Transactions?displayProperty=fullName> and <xref:System.Transactions.Transaction?displayProperty=fullName>.","leadings":["","> "],"nodes":[{"content":"This topic covers compensation in workflows. [!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions in workflows, see [Transactions](../../../docs/framework/windows-workflow-foundation/workflow-transactions.md) and <xref:System.Activities.Statements.TransactionScope>. [!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions, see <xref:System.Transactions?displayProperty=fullName> and <xref:System.Transactions.Transaction?displayProperty=fullName>.","pos":[9,480],"nodes":[{"content":"This topic covers compensation in workflows.","pos":[0,44]},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../includes/crabout-md.md)]</ph> transactions in workflows, see <bpt id=\"p1\">[</bpt>Transactions<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/workflow-transactions.md)</ept> and <ph id=\"ph2\">&lt;xref:System.Activities.Statements.TransactionScope&gt;</ph>.","pos":[45,279],"source":"[!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions in workflows, see [Transactions](../../../docs/framework/windows-workflow-foundation/workflow-transactions.md) and <xref:System.Activities.Statements.TransactionScope>."},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../includes/crabout-md.md)]</ph> transactions, see <ph id=\"ph2\">&lt;xref:System.Transactions?displayProperty=fullName&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.Transactions.Transaction?displayProperty=fullName&gt;</ph>.","pos":[280,471],"source":"[!INCLUDE[crabout](../../../includes/crabout-md.md)] transactions, see <xref:System.Transactions?displayProperty=fullName> and <xref:System.Transactions.Transaction?displayProperty=fullName>."}]}]},{"pos":[1982,2007],"content":"Using CompensableActivity","linkify":"Using CompensableActivity","nodes":[{"content":"Using CompensableActivity","pos":[0,25]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> is the core compensation activity in <ph id=\"ph2\">[!INCLUDE[wf1](../../../includes/wf1-md.md)]</ph>.","pos":[2011,2149],"source":"<xref:System.Activities.Statements.CompensableActivity> is the core compensation activity in [!INCLUDE[wf1](../../../includes/wf1-md.md)]."},{"content":"Any activities that perform work that may need to be compensated are placed into the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> of a <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>.","pos":[2150,2360],"source":" Any activities that perform work that may need to be compensated are placed into the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of a <xref:System.Activities.Statements.CompensableActivity>."},{"content":"In this example, the reservation step of purchasing a flight is placed into the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> of a <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> and the cancellation of the reservation is placed into the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A&gt;</ph>.","pos":[2361,2704],"source":" In this example, the reservation step of purchasing a flight is placed into the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of a <xref:System.Activities.Statements.CompensableActivity> and the cancellation of the reservation is placed into the <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A>."},{"content":"Immediately following the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> in the workflow are two activities that wait for manager approval and then complete the purchasing step of the flight.","pos":[2705,2905],"source":" Immediately following the <xref:System.Activities.Statements.CompensableActivity> in the workflow are two activities that wait for manager approval and then complete the purchasing step of the flight."},{"content":"If an error condition causes the workflow to be canceled after the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> has successfully completed, then the activities in the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A&gt;</ph> handler are scheduled and the flight is canceled.","pos":[2906,3212],"source":" If an error condition causes the workflow to be canceled after the <xref:System.Activities.Statements.CompensableActivity> has successfully completed, then the activities in the <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A> handler are scheduled and the flight is canceled."},{"pos":[3219,3350],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>CFX_CompensationExample#1<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#1)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[CFX_CompensationExample#1](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#1)]"},{"content":"The following example is the workflow in XAML.","pos":[3357,3403]},{"content":"When the workflow is invoked, the following output is displayed to the console.","pos":[4059,4138]},{"content":"<bpt id=\"p1\">**</bpt>ReserveFlight: Ticket is reserved.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[4145,4184],"source":"**ReserveFlight: Ticket is reserved.** "},{"content":"<bpt id=\"p1\">**</bpt>ManagerApproval: Manager approval received.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[4187,4235],"source":"**ManagerApproval: Manager approval received.** "},{"content":"<bpt id=\"p1\">**</bpt>PurchaseFlight: Ticket is purchased.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[4238,4279],"source":"**PurchaseFlight: Ticket is purchased.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow completed successfully with status: Closed.<ept id=\"p1\">**</ept>","pos":[4282,4338],"source":"**Workflow completed successfully with status: Closed.**"},{"pos":[4345,4553],"content":"[!NOTE]\n The sample activities in this topic such as `ReserveFlight` display their name and purpose to the console to help illustrate the order in which the activities are executed when compensation occurs.","leadings":["","> "],"nodes":[{"content":"The sample activities in this topic such as <ph id=\"ph1\">`ReserveFlight`</ph> display their name and purpose to the console to help illustrate the order in which the activities are executed when compensation occurs.","pos":[9,206],"source":"The sample activities in this topic such as `ReserveFlight` display their name and purpose to the console to help illustrate the order in which the activities are executed when compensation occurs."}]},{"pos":[4563,4592],"content":"Default Workflow Compensation","linkify":"Default Workflow Compensation","nodes":[{"content":"Default Workflow Compensation","pos":[0,29]}]},{"content":"By default, if the workflow is canceled, the compensation logic is run for any compensable activity that has successfully completely and has not already been confirmed or compensated.","pos":[4596,4779]},{"pos":[4787,4993],"content":"[!NOTE]\n When a <xref:System.Activities.Statements.CompensableActivity> is *confirmed*, compensation for the activity can no longer be invoked. The confirmation process is described later in this section.","leadings":["","> "],"nodes":[{"content":"When a <xref:System.Activities.Statements.CompensableActivity> is *confirmed*, compensation for the activity can no longer be invoked. The confirmation process is described later in this section.","pos":[9,204],"nodes":[{"content":"When a <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> is <bpt id=\"p1\">*</bpt>confirmed<ept id=\"p1\">*</ept>, compensation for the activity can no longer be invoked.","pos":[0,134],"source":"When a <xref:System.Activities.Statements.CompensableActivity> is *confirmed*, compensation for the activity can no longer be invoked."},{"content":"The confirmation process is described later in this section.","pos":[135,195]}]}]},{"content":"In this example, an exception is thrown after the flight is reserved but before the manager approval step.","pos":[5000,5106]},{"pos":[5113,5244],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>CFX_CompensationExample#2<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#2)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[CFX_CompensationExample#2](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#2)]"},{"content":"This example is the workflow in XAML.","pos":[5251,5288]},{"pos":[5978,6113],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>CFX_CompensationExample#100<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#100)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[CFX_CompensationExample#100](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#100)]"},{"content":"When the workflow is invoked, the simulated error condition exception is handled by the host application in <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.OnUnhandledException%2A&gt;</ph>, the workflow is canceled, and the compensation logic is invoked.","pos":[6120,6362],"source":"When the workflow is invoked, the simulated error condition exception is handled by the host application in <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>, the workflow is canceled, and the compensation logic is invoked."},{"content":"<bpt id=\"p1\">**</bpt>ReserveFlight: Ticket is reserved.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[6369,6408],"source":"**ReserveFlight: Ticket is reserved.** "},{"content":"<bpt id=\"p1\">**</bpt>SimulatedErrorCondition: Throwing an ApplicationException.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[6411,6474],"source":"**SimulatedErrorCondition: Throwing an ApplicationException.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow Unhandled Exception:<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[6477,6511],"source":"**Workflow Unhandled Exception:** "},{"content":"<bpt id=\"p1\">**</bpt>System.ApplicationException: Simulated error condition in the workflow.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[6514,6590],"source":"**System.ApplicationException: Simulated error condition in the workflow.** "},{"content":"<bpt id=\"p1\">**</bpt>CancelFlight: Ticket is canceled.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[6593,6631],"source":"**CancelFlight: Ticket is canceled.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow completed successfully with status: Canceled.<ept id=\"p1\">**</ept>","pos":[6634,6692],"source":"**Workflow completed successfully with status: Canceled.**"},{"pos":[6701,6737],"content":"Cancellation and CompensableActivity","linkify":"Cancellation and CompensableActivity","nodes":[{"content":"Cancellation and CompensableActivity","pos":[0,36]}]},{"content":"If the activities in the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> of a <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> have not completed and the activity is canceled, the activities in the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A&gt;</ph> are executed.","pos":[6741,7054],"source":"If the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of a <xref:System.Activities.Statements.CompensableActivity> have not completed and the activity is canceled, the activities in the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are executed."},{"pos":[7062,7710],"content":"[!NOTE]\n The <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> is only invoked if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have not completed and the activity is canceled. The <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A> is only executed if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have successfully completed and compensation is subsequently invoked on the activity.","leadings":["","> "],"nodes":[{"content":"The <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> is only invoked if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have not completed and the activity is canceled. The <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A> is only executed if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have successfully completed and compensation is subsequently invoked on the activity.","pos":[9,646],"nodes":[{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A&gt;</ph> is only invoked if the activities in the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> of the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> have not completed and the activity is canceled.","pos":[0,299],"source":"The <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> is only invoked if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have not completed and the activity is canceled."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A&gt;</ph> is only executed if the activities in the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> of the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> have successfully completed and compensation is subsequently invoked on the activity.","pos":[300,637],"source":" The <xref:System.Activities.Statements.CompensableActivity.CompensationHandler%2A> is only executed if the activities in the <xref:System.Activities.Statements.CompensableActivity.Body%2A> of the <xref:System.Activities.Statements.CompensableActivity> have successfully completed and compensation is subsequently invoked on the activity."}]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A&gt;</ph> gives workflow authors the opportunity to provide any appropriate cancellation logic.","pos":[7717,7885],"source":"The <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> gives workflow authors the opportunity to provide any appropriate cancellation logic."},{"content":"In the following example, an exception is thrown during the execution of the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph>, and then the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A&gt;</ph> is invoked.","pos":[7886,8131],"source":" In the following example, an exception is thrown during the execution of the <xref:System.Activities.Statements.CompensableActivity.Body%2A>, and then the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> is invoked."},{"content":"This example is the workflow in XAML","pos":[8755,8791]},{"content":"When the workflow is invoked, the simulated error condition exception is handled by the host application in <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.OnUnhandledException%2A&gt;</ph>, the workflow is canceled, and the cancellation logic of the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> is invoked.","pos":[9681,9986],"source":"When the workflow is invoked, the simulated error condition exception is handled by the host application in <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>, the workflow is canceled, and the cancellation logic of the <xref:System.Activities.Statements.CompensableActivity> is invoked."},{"content":"In this example, the compensation logic and the cancellation logic have different goals.","pos":[9987,10075]},{"content":"If the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> completed successfully, then this means the credit card was charged and the flight booked, so the compensation should undo both steps.","pos":[10076,10281],"source":" If the <xref:System.Activities.Statements.CompensableActivity.Body%2A> completed successfully, then this means the credit card was charged and the flight booked, so the compensation should undo both steps."},{"content":"(In this example, canceling the flight automatically cancels the credit card charges.) However, if the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> is canceled, this means the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> did not complete and so the logic of the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A&gt;</ph> needs to be able to determine how to best handle the cancellation.","pos":[10282,10719],"source":" (In this example, canceling the flight automatically cancels the credit card charges.) However, if the <xref:System.Activities.Statements.CompensableActivity> is canceled, this means the <xref:System.Activities.Statements.CompensableActivity.Body%2A> did not complete and so the logic of the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> needs to be able to determine how to best handle the cancellation."},{"content":"In this example, the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A&gt;</ph> cancels the credit card charge, but since <ph id=\"ph2\">`ReserveFlight`</ph> was the last activity in the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph>, it does not attempt to cancel the flight.","pos":[10720,11013],"source":" In this example, the <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> cancels the credit card charge, but since `ReserveFlight` was the last activity in the <xref:System.Activities.Statements.CompensableActivity.Body%2A>, it does not attempt to cancel the flight."},{"content":"Since <ph id=\"ph1\">`ReserveFlight`</ph> was the last activity in the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph>, if it had successfully completed then the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> would have completed and no cancellation would be possible.","pos":[11014,11295],"source":" Since `ReserveFlight` was the last activity in the <xref:System.Activities.Statements.CompensableActivity.Body%2A>, if it had successfully completed then the <xref:System.Activities.Statements.CompensableActivity.Body%2A> would have completed and no cancellation would be possible."},{"content":"<bpt id=\"p1\">**</bpt>ChargeCreditCard: Charge credit card for flight.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[11302,11355],"source":"**ChargeCreditCard: Charge credit card for flight.** "},{"content":"<bpt id=\"p1\">**</bpt>SimulatedErrorCondition: Throwing an ApplicationException.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[11358,11421],"source":"**SimulatedErrorCondition: Throwing an ApplicationException.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow Unhandled Exception:<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[11424,11458],"source":"**Workflow Unhandled Exception:** "},{"content":"<bpt id=\"p1\">**</bpt>System.ApplicationException: Simulated error condition in the workflow.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[11461,11537],"source":"**System.ApplicationException: Simulated error condition in the workflow.** "},{"content":"<bpt id=\"p1\">**</bpt>CancelCreditCard: Cancel credit card charges.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[11540,11590],"source":"**CancelCreditCard: Cancel credit card charges.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow completed successfully with status: Canceled.<ept id=\"p1\">**</ept>","pos":[11593,11651],"source":"**Workflow completed successfully with status: Canceled.**"},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../includes/crabout-md.md)]</ph> cancellation, see <bpt id=\"p1\">[</bpt>Cancellation<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/modeling-cancellation-behavior-in-workflows.md)</ept>.","pos":[11653,11839],"source":"[!INCLUDE[crabout](../../../includes/crabout-md.md)] cancellation, see [Cancellation](../../../docs/framework/windows-workflow-foundation/modeling-cancellation-behavior-in-workflows.md)."},{"pos":[11849,11900],"content":"Explicit Compensation Using the Compensate Activity","linkify":"Explicit Compensation Using the Compensate Activity","nodes":[{"content":"Explicit Compensation Using the Compensate Activity","pos":[0,51]}]},{"content":"In the previous section, implicit compensation was covered.","pos":[11904,11963]},{"content":"Implicit compensation can be appropriate for simple scenarios, but if more explicit control is required over the scheduling of compensation handling then the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.Compensate&gt;</ph> activity can be used.","pos":[11964,12190],"source":" Implicit compensation can be appropriate for simple scenarios, but if more explicit control is required over the scheduling of compensation handling then the <xref:System.Activities.Statements.Compensate> activity can be used."},{"content":"To initiate the compensation process with the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.Compensate&gt;</ph> activity, the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensationToken&gt;</ph> of the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> for which compensation is desired is used.","pos":[12191,12457],"source":" To initiate the compensation process with the <xref:System.Activities.Statements.Compensate> activity, the <xref:System.Activities.Statements.CompensationToken> of the <xref:System.Activities.Statements.CompensableActivity> for which compensation is desired is used."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.Statements.Compensate&gt;</ph> activity can be used to initiate compensation on any completed <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> that has not been confirmed or compensated.","pos":[12458,12671],"source":" The <xref:System.Activities.Statements.Compensate> activity can be used to initiate compensation on any completed <xref:System.Activities.Statements.CompensableActivity> that has not been confirmed or compensated."},{"content":"For example, a <ph id=\"ph1\">&lt;xref:System.Activities.Statements.Compensate&gt;</ph> activity could be used in the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.TryCatch.Catches%2A&gt;</ph> section of a <ph id=\"ph3\">&lt;xref:System.Activities.Statements.TryCatch&gt;</ph> activity, or any time after the <ph id=\"ph4\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> has completed.","pos":[12672,12980],"source":" For example, a <xref:System.Activities.Statements.Compensate> activity could be used in the <xref:System.Activities.Statements.TryCatch.Catches%2A> section of a <xref:System.Activities.Statements.TryCatch> activity, or any time after the <xref:System.Activities.Statements.CompensableActivity> has completed."},{"content":"In this example, the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.Compensate&gt;</ph> activity is used in the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.TryCatch.Catches%2A&gt;</ph> section of a <ph id=\"ph3\">&lt;xref:System.Activities.Statements.TryCatch&gt;</ph> activity to reverse the action of the <ph id=\"ph4\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>.","pos":[12981,13281],"source":" In this example, the <xref:System.Activities.Statements.Compensate> activity is used in the <xref:System.Activities.Statements.TryCatch.Catches%2A> section of a <xref:System.Activities.Statements.TryCatch> activity to reverse the action of the <xref:System.Activities.Statements.CompensableActivity>."},{"pos":[13288,13419],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>CFX_CompensationExample#3<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#3)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[CFX_CompensationExample#3](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#3)]"},{"content":"This example is the workflow in XAML.","pos":[13426,13463]},{"content":"When the workflow is invoked, the following output is displayed to the console.","pos":[15839,15918]},{"content":"<bpt id=\"p1\">**</bpt>ReserveFlight: Ticket is reserved.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[15925,15964],"source":"**ReserveFlight: Ticket is reserved.** "},{"content":"<bpt id=\"p1\">**</bpt>SimulatedErrorCondition: Throwing an ApplicationException.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[15967,16030],"source":"**SimulatedErrorCondition: Throwing an ApplicationException.** "},{"content":"<bpt id=\"p1\">**</bpt>CancelFlight: Ticket is canceled.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[16033,16071],"source":"**CancelFlight: Ticket is canceled.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow completed successfully with status: Closed.<ept id=\"p1\">**</ept>","pos":[16074,16130],"source":"**Workflow completed successfully with status: Closed.**"},{"pos":[16139,16162],"content":"Confirming Compensation","linkify":"Confirming Compensation","nodes":[{"content":"Confirming Compensation","pos":[0,23]}]},{"content":"By default, compensable activities can be compensated any time after they have completed.","pos":[16166,16255]},{"content":"In some scenarios this may not be appropriate.","pos":[16256,16302]},{"content":"In the previous example the compensation to reserving the ticket was to cancel the reservation.","pos":[16303,16398]},{"content":"However, after the flight has been completed this compensation step is no longer valid.","pos":[16399,16486]},{"content":"Confirming the compensable activity invokes the activity specified by the <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity.ConfirmationHandler%2A&gt;</ph>.","pos":[16487,16640],"source":" Confirming the compensable activity invokes the activity specified by the <xref:System.Activities.Statements.CompensableActivity.ConfirmationHandler%2A>."},{"content":"One possible use for this is to allow any resources that are necessary to perform the compensation to be released.","pos":[16641,16755]},{"content":"After a compensable activity is confirmed it is not possible for it to be compensated, and if this is attempted an <ph id=\"ph1\">&lt;xref:System.InvalidOperationException&gt;</ph> exception is thrown.","pos":[16756,16931],"source":" After a compensable activity is confirmed it is not possible for it to be compensated, and if this is attempted an <xref:System.InvalidOperationException> exception is thrown."},{"content":"When a workflow completes successfully, all non-confirmed and non-compensated compensable activities that completed successfully are confirmed in reverse order of completion.","pos":[16932,17106]},{"content":"In this example the flight is reserved, purchased, and completed, and then the compensable activity is confirmed.","pos":[17107,17220]},{"content":"To confirm a <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>, use the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.Confirm&gt;</ph> activity and specify the <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensationToken&gt;</ph> of the <ph id=\"ph4\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> to confirm.","pos":[17221,17496],"source":" To confirm a <xref:System.Activities.Statements.CompensableActivity>, use the <xref:System.Activities.Statements.Confirm> activity and specify the <xref:System.Activities.Statements.CompensationToken> of the <xref:System.Activities.Statements.CompensableActivity> to confirm."},{"pos":[17503,17634],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>CFX_CompensationExample#4<ept id=\"p2\">](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#4)</ept><ept id=\"p1\">]</ept>","source":"[!code-csharp[CFX_CompensationExample#4](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_CompensationExample/cs/Program.cs#4)]"},{"content":"This example is the workflow in XAML.","pos":[17641,17678]},{"content":"When the workflow is invoked, the following output is displayed to the console.","pos":[19592,19671]},{"content":"<bpt id=\"p1\">**</bpt>ReserveFlight: Ticket is reserved.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[19678,19717],"source":"**ReserveFlight: Ticket is reserved.** "},{"content":"<bpt id=\"p1\">**</bpt>ManagerApproval: Manager approval received.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[19720,19768],"source":"**ManagerApproval: Manager approval received.** "},{"content":"<bpt id=\"p1\">**</bpt>PurchaseFlight: Ticket is purchased.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[19771,19812],"source":"**PurchaseFlight: Ticket is purchased.** "},{"content":"<bpt id=\"p1\">**</bpt>TakeFlight: Flight is completed.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[19815,19852],"source":"**TakeFlight: Flight is completed.** "},{"content":"<bpt id=\"p1\">**</bpt>ConfirmFlight: Flight has been taken, no compensation possible.<ept id=\"p1\">**</ept><ph id=\"ph1\"> </ph>","pos":[19855,19923],"source":"**ConfirmFlight: Flight has been taken, no compensation possible.** "},{"content":"<bpt id=\"p1\">**</bpt>Workflow completed successfully with status: Closed.<ept id=\"p1\">**</ept>","pos":[19926,19982],"source":"**Workflow completed successfully with status: Closed.**"},{"pos":[19989,20020],"content":"Nesting Compensation Activities","linkify":"Nesting Compensation Activities","nodes":[{"content":"Nesting Compensation Activities","pos":[0,31]}]},{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> can be placed into the <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity.Body%2A&gt;</ph> section of another <ph id=\"ph3\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>.","pos":[20024,20244],"source":"A <xref:System.Activities.Statements.CompensableActivity> can be placed into the <xref:System.Activities.Statements.CompensableActivity.Body%2A> section of another <xref:System.Activities.Statements.CompensableActivity>."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> may not be placed into a handler of another <ph id=\"ph2\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>.","pos":[20245,20403],"source":" A <xref:System.Activities.Statements.CompensableActivity> may not be placed into a handler of another <xref:System.Activities.Statements.CompensableActivity>."},{"content":"It is the responsibility of a parent <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> to ensure that when it is canceled, confirmed, or compensated, all child compensable activities that have completed successfully and have not already been confirmed or compensated must be confirmed or compensated before the parent completes cancellation, confirmation, or compensation.","pos":[20404,20782],"source":" It is the responsibility of a parent <xref:System.Activities.Statements.CompensableActivity> to ensure that when it is canceled, confirmed, or compensated, all child compensable activities that have completed successfully and have not already been confirmed or compensated must be confirmed or compensated before the parent completes cancellation, confirmation, or compensation."},{"content":"If this is not modeled explicitly the parent <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph> will implicitly compensate child compensable activities if the parent received the cancel or compensate signal.","pos":[20783,20995],"source":" If this is not modeled explicitly the parent <xref:System.Activities.Statements.CompensableActivity> will implicitly compensate child compensable activities if the parent received the cancel or compensate signal."},{"content":"If the parent received the confirm signal the parent will implicitly confirm child compensable activities.","pos":[20996,21102]},{"content":"If the logic to handle cancellation, confirmation, or compensation is explicitly modeled in the handler of the parent <ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>, any child not explicitly handled will be implicitly confirmed.","pos":[21103,21340],"source":" If the logic to handle cancellation, confirmation, or compensation is explicitly modeled in the handler of the parent <xref:System.Activities.Statements.CompensableActivity>, any child not explicitly handled will be implicitly confirmed."},{"pos":[21349,21357],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensableActivity&gt;</ph>","pos":[21361,21416],"source":"<xref:System.Activities.Statements.CompensableActivity> "},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.Statements.Compensate&gt;</ph>","pos":[21421,21467],"source":"<xref:System.Activities.Statements.Compensate> "},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.Statements.Confirm&gt;</ph>","pos":[21472,21515],"source":"<xref:System.Activities.Statements.Confirm> "},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.Statements.CompensationToken&gt;</ph>","pos":[21520,21573],"source":"<xref:System.Activities.Statements.CompensationToken> "},{"content":"<bpt id=\"p1\">[</bpt>Compensable Activity<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/samples/compensable-activity-sample.md)</ept>","pos":[21578,21692],"source":"[Compensable Activity](../../../docs/framework/windows-workflow-foundation/samples/compensable-activity-sample.md)"}]}