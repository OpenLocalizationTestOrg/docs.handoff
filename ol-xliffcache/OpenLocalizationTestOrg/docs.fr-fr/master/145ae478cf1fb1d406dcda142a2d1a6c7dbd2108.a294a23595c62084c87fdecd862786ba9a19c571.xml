{"content":"---\ntitle: \"Setting Up a Profiling Environment | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"reference\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"environment variables, profiling API\"\n  - \"profiling API [.NET Framework], setting up environment\"\n  - \"COR_PROFILER environment variable\"\n  - \"Windows Service applications, profiling\"\n  - \"profiling API [.NET Framework], Windows Service applications\"\n  - \"COR_ENABLE_PROFILING environment variable\"\n  - \"profiling API [.NET Framework], enabling\"\nms.assetid: fefca07f-7555-4e77-be86-3c542e928312\ncaps.latest.revision: 29\nauthor: \"mairaw\"\nms.author: \"mairaw\"\nmanager: \"wpickett\"\n---\n# Setting Up a Profiling Environment\n> [!NOTE]\n>  There have been substantial changes to profiling in the [!INCLUDE[net_v40_long](../../../../includes/net-v40-long-md.md)].  \n  \n When a managed process (application or service) starts, it loads the common language runtime (CLR). When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:  \n  \n-   COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.  \n  \n-   COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry. The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.  \n  \n    ```  \n    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  \n    set COR_PROFILER=\"MyProfiler\"  \n    ```  \n  \n To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application. You must also make sure that the profiler DLL is registered.  \n  \n> [!NOTE]\n>  Starting with the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)], profilers do not have to be registered.  \n  \n> [!NOTE]\n>  To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.  \n  \n## Environment Variable Scope  \n How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence. You can set these variables in one of the following ways:  \n  \n-   If you set the variables in an [ICorDebug::CreateProcess](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time. (They will also apply to other applications started by that application that inherit the environment.)  \n  \n-   If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.  \n  \n-   If you set the variables at the user level, they will apply to all applications that you start with File Explorer. A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window. To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.  \n  \n-   If you set the variables at the computer level, they will apply to all applications that are started on that computer. A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window. This means that every managed process on that computer will start with your profiler. To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer. After restarting, the variables will be available system-wide.  \n  \n If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL. For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).  \n  \n## Additional Considerations  \n  \n-   The profiler class implements the [ICorProfilerCallback](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-interface.md) and [ICorProfilerCallback2](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback2-interface.md) interfaces. In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`. If it does not, `ICorProfilerCallback2` will not be loaded.  \n  \n-   Only one profiler can profile a process at one time in a given environment. You can register two different profilers in different environments, but each must profile separate processes. The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled. This means that the profiler runs in-process. The .NET Framework does not support any other type of COM server. For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer. These agents will batch results and communicate them to the central data collection computer.  \n  \n-   Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler. Therefore, a single profiler instance does not have to handle data from multiple applications. However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.  \n  \n## Initializing the Profiler  \n When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function. The profiler is not loaded through a direct call to `CoCreateInstance`. Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided. The CLR then calls the [ICorProfilerCallback::Initialize](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method.md) method in the profiler. The signature of this method is as follows.  \n  \n```  \nHRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  \n```  \n  \n The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo-interface.md) or [ICorProfilerInfo2](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.  \n  \n## Setting Event Notifications  \n The profiler then calls the [ICorProfilerInfo::SetEventMask](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in. For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.  \n  \n```  \nICorProfilerInfo* pInfo;  \npICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  \npInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  \n```  \n  \n By setting the notifications mask in this manner, the profiler can limit which notifications it receives. This approach helps the user build a simple or special-purpose profiler. It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.  \n  \n Certain profiler events are immutable. This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on. Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.  \n  \n<a name=\"windows_service\"></a>   \n## Profiling a Windows Service  \n Profiling a Windows Service is like profiling a common language runtime application. Both profiling operations are enabled through environment variables. Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts. In addition, the profiling DLL must already be registered on the system.  \n  \n After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.  \n  \n Note that these changes will enable profiling on a system-wide basis. To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.  \n  \n This technique also leads to every CLR process getting profiled. The profiler should add logic to its [ICorProfilerCallback::Initialize](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest. If it is not, the profiler can fail the callback without performing the initialization.  \n  \n## See Also  \n [Profiling Overview](../../../../docs/framework/unmanaged-api/profiling/profiling-overview.md)","nodes":[{"pos":[12,63],"content":"Setting Up a Profiling Environment | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Setting Up a Profiling Environment | Microsoft Docs","pos":[0,51]}]},{"pos":[762,796],"content":"Setting Up a Profiling Environment","linkify":"Setting Up a Profiling Environment","nodes":[{"content":"Setting Up a Profiling Environment","pos":[0,34]}]},{"pos":[799,932],"content":"[!NOTE]\n There have been substantial changes to profiling in the [!INCLUDE[net_v40_long](../../../../includes/net-v40-long-md.md)].","leadings":["","> "],"nodes":[{"content":"There have been substantial changes to profiling in the <ph id=\"ph1\">[!INCLUDE[net_v40_long](../../../../includes/net-v40-long-md.md)]</ph>.","pos":[9,131],"source":" There have been substantial changes to profiling in the [!INCLUDE[net_v40_long](../../../../includes/net-v40-long-md.md)]."}]},{"content":"When a managed process (application or service) starts, it loads the common language runtime (CLR).","pos":[939,1038]},{"content":"When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:","pos":[1039,1182]},{"content":"COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.","pos":[1192,1302]},{"content":"COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.","pos":[1312,1487]},{"content":"The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.","pos":[1488,1589]},{"content":"To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.","pos":[1717,1855]},{"content":"You must also make sure that the profiler DLL is registered.","pos":[1856,1916]},{"pos":[1924,2061],"content":"[!NOTE]\n Starting with the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)], profilers do not have to be registered.","leadings":["","> "],"nodes":[{"content":"Starting with the <ph id=\"ph1\">[!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)]</ph>, profilers do not have to be registered.","pos":[9,135],"source":" Starting with the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)], profilers do not have to be registered."}]},{"pos":[2069,2317],"content":"[!NOTE]\n To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.","leadings":["","> "],"nodes":[{"content":"To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the <ph id=\"ph1\">[!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)]</ph> and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.","pos":[9,246],"source":" To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable."}]},{"pos":[2326,2352],"content":"Environment Variable Scope","linkify":"Environment Variable Scope","nodes":[{"content":"Environment Variable Scope","pos":[0,26]}]},{"content":"How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.","pos":[2356,2472]},{"content":"You can set these variables in one of the following ways:","pos":[2473,2530]},{"content":"If you set the variables in an <bpt id=\"p1\">[</bpt>ICorDebug::CreateProcess<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md)</ept> call, they will apply only to the application that you are running at the time.","pos":[2540,2763],"source":"If you set the variables in an [ICorDebug::CreateProcess](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time."},{"content":"(They will also apply to other applications started by that application that inherit the environment.)","pos":[2764,2866]},{"content":"If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.","pos":[2876,2999]},{"content":"If you set the variables at the user level, they will apply to all applications that you start with File Explorer.","pos":[3009,3123]},{"content":"A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.","pos":[3124,3288]},{"content":"To set environment variables at the user level, right-click <bpt id=\"p1\">**</bpt>My Computer<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept>, click the <bpt id=\"p3\">**</bpt>Advanced<ept id=\"p3\">**</ept> tab, click <bpt id=\"p4\">**</bpt>Environment Variables<ept id=\"p4\">**</ept>, and add the variables to the <bpt id=\"p5\">**</bpt>User variables<ept id=\"p5\">**</ept> list.","pos":[3289,3502],"source":" To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list."},{"content":"If you set the variables at the computer level, they will apply to all applications that are started on that computer.","pos":[3512,3630]},{"content":"A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.","pos":[3631,3784]},{"content":"This means that every managed process on that computer will start with your profiler.","pos":[3785,3870]},{"content":"To set environment variables at the computer level, right-click <bpt id=\"p1\">**</bpt>My Computer<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept>, click the <bpt id=\"p3\">**</bpt>Advanced<ept id=\"p3\">**</ept> tab, click <bpt id=\"p4\">**</bpt>Environment Variables<ept id=\"p4\">**</ept>, add the variables to the <bpt id=\"p5\">**</bpt>System variables<ept id=\"p5\">**</ept> list, and then restart your computer.","pos":[3871,4118],"source":" To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer."},{"content":"After restarting, the variables will be available system-wide.","pos":[4119,4181]},{"content":"If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.","pos":[4188,4329]},{"content":"For more information about these considerations, see the section <bpt id=\"p1\">[</bpt>Profiling a Windows Service<ept id=\"p1\">](#windows_service)</ept>.","pos":[4330,4443],"source":" For more information about these considerations, see the section [Profiling a Windows Service](#windows_service)."},{"pos":[4452,4477],"content":"Additional Considerations","linkify":"Additional Considerations","nodes":[{"content":"Additional Considerations","pos":[0,25]}]},{"content":"The profiler class implements the <bpt id=\"p1\">[</bpt>ICorProfilerCallback<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-interface.md)</ept> and <bpt id=\"p2\">[</bpt>ICorProfilerCallback2<ept id=\"p2\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback2-interface.md)</ept> interfaces.","pos":[4487,4756],"source":"The profiler class implements the [ICorProfilerCallback](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-interface.md) and [ICorProfilerCallback2](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback2-interface.md) interfaces."},{"content":"In the .NET Framework version 2.0, a profiler must implement <ph id=\"ph1\">`ICorProfilerCallback2`</ph>.","pos":[4757,4842],"source":" In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`."},{"content":"If it does not, <ph id=\"ph1\">`ICorProfilerCallback2`</ph> will not be loaded.","pos":[4843,4902],"source":" If it does not, `ICorProfilerCallback2` will not be loaded."},{"content":"Only one profiler can profile a process at one time in a given environment.","pos":[4912,4987]},{"content":"You can register two different profilers in different environments, but each must profile separate processes.","pos":[4988,5097]},{"content":"The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.","pos":[5098,5246]},{"content":"This means that the profiler runs in-process.","pos":[5247,5292]},{"content":"The .NET Framework does not support any other type of COM server.","pos":[5293,5358]},{"content":"For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.","pos":[5359,5492]},{"content":"These agents will batch results and communicate them to the central data collection computer.","pos":[5493,5586]},{"content":"Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.","pos":[5596,5731]},{"content":"Therefore, a single profiler instance does not have to handle data from multiple applications.","pos":[5732,5826]},{"content":"However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.","pos":[5827,5958]},{"pos":[5967,5992],"content":"Initializing the Profiler","linkify":"Initializing the Profiler","nodes":[{"content":"Initializing the Profiler","pos":[0,25]}]},{"content":"When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM <ph id=\"ph1\">`CoCreateInstance`</ph> function.","pos":[5996,6143],"source":"When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function."},{"content":"The profiler is not loaded through a direct call to <ph id=\"ph1\">`CoCreateInstance`</ph>.","pos":[6144,6215],"source":" The profiler is not loaded through a direct call to `CoCreateInstance`."},{"content":"Therefore, a call to <ph id=\"ph1\">`CoInitialize`</ph>, which requires setting the threading model, is avoided.","pos":[6216,6308],"source":" Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided."},{"content":"The CLR then calls the <bpt id=\"p1\">[</bpt>ICorProfilerCallback::Initialize<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method.md)</ept> method in the profiler.","pos":[6309,6484],"source":" The CLR then calls the [ICorProfilerCallback::Initialize](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method.md) method in the profiler."},{"content":"The signature of this method is as follows.","pos":[6485,6528]},{"pos":[6603,6957],"content":"The profiler must query <ph id=\"ph1\">`pICorProfilerInfoUnk`</ph> for an <bpt id=\"p1\">[</bpt>ICorProfilerInfo<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo-interface.md)</ept> or <bpt id=\"p2\">[</bpt>ICorProfilerInfo2<ept id=\"p2\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo2-interface.md)</ept> interface pointer and save it so that it can request more information later during profiling.","source":"The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo-interface.md) or [ICorProfilerInfo2](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling."},{"pos":[6966,6993],"content":"Setting Event Notifications","linkify":"Setting Event Notifications","nodes":[{"content":"Setting Event Notifications","pos":[0,27]}]},{"content":"The profiler then calls the <bpt id=\"p1\">[</bpt>ICorProfilerInfo::SetEventMask<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo-seteventmask-method.md)</ept> method to specify which categories of notifications it is interested in.","pos":[6997,7222],"source":"The profiler then calls the [ICorProfilerInfo::SetEventMask](../../../../docs/framework/unmanaged-api/profiling/icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in."},{"content":"For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.","pos":[7223,7378]},{"content":"By setting the notifications mask in this manner, the profiler can limit which notifications it receives.","pos":[7576,7681]},{"content":"This approach helps the user build a simple or special-purpose profiler.","pos":[7682,7754]},{"content":"It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.","pos":[7755,7859]},{"content":"Certain profiler events are immutable.","pos":[7866,7904]},{"content":"This means that as soon as these events are set in the <ph id=\"ph1\">`ICorProfilerCallback::Initialize`</ph> callback, they cannot be turned off and new events cannot be turned on.","pos":[7905,8066],"source":" This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on."},{"content":"Attempts to change an immutable event will result in <ph id=\"ph1\">`ICorProfilerInfo::SetEventMask`</ph> returning a failed HRESULT.","pos":[8067,8180],"source":" Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT."},{"pos":[8223,8250],"content":"Profiling a Windows Service","linkify":"Profiling a Windows Service","nodes":[{"content":"Profiling a Windows Service","pos":[0,27]}]},{"content":"Profiling a Windows Service is like profiling a common language runtime application.","pos":[8254,8338]},{"content":"Both profiling operations are enabled through environment variables.","pos":[8339,8407]},{"content":"Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.","pos":[8408,8620]},{"content":"In addition, the profiling DLL must already be registered on the system.","pos":[8621,8693]},{"content":"After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.","pos":[8700,8901]},{"content":"Note that these changes will enable profiling on a system-wide basis.","pos":[8908,8977]},{"content":"To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.","pos":[8978,9148]},{"content":"This technique also leads to every CLR process getting profiled.","pos":[9155,9219]},{"content":"The profiler should add logic to its <bpt id=\"p1\">[</bpt>ICorProfilerCallback::Initialize<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method.md)</ept> callback to detect whether the current process is of interest.","pos":[9220,9448],"source":" The profiler should add logic to its [ICorProfilerCallback::Initialize](../../../../docs/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest."},{"content":"If it is not, the profiler can fail the callback without performing the initialization.","pos":[9449,9536]},{"pos":[9545,9553],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[9557,9651],"content":"<bpt id=\"p1\">[</bpt>Profiling Overview<ept id=\"p1\">](../../../../docs/framework/unmanaged-api/profiling/profiling-overview.md)</ept>","source":"[Profiling Overview](../../../../docs/framework/unmanaged-api/profiling/profiling-overview.md)"}]}