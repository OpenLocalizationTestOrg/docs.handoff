{"content":"---\ntitle: \"Instance Locked Exception Action\"\nms.date: \"03/30/2017\"\nms.assetid: 164a5419-315c-4987-ad72-54cbdb88d402\n---\n# Instance Locked Exception Action\nThe <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A> property of the SQL Workflow Instance Store lets you specify what action the SQL persistence provider should take when it receives an <xref:System.Runtime.DurableInstancing.InstanceLockedException>. The persistence provider receives this exception when it tries to lock a workflow service instance that is currently locked by another service host. The values for this property are <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>, <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>, and <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>. The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>. The following list describes the three options:  \n  \n-   <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>. The service host does not attempt to lock the workflow service instance and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller.  If your workflow stays in memory for a period exceeding 60 seconds, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> as the retry. The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.  \n  \n-   <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>. The service host reattempts to lock the workflow service instance with a linear interval between retry attempts and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller at the end of the sequence. If you workflow stays in memory approximately between 5-60 seconds, and messages arrive in batches where it is more likely for messages being sent to the same instance on the same host to process all messages before unloading the workflow, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> to achieve the best latency without wasting resources.  \n  \n-   <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>. The service host reattempts to lock the workflow service instance with an exponential backoff interval between retry attempts, and passes the exception to the caller at the end of the sequence. If your workflow stays in memory for a very short time (less than 5 seconds), or a Web farm is large and the chance of another message being delivered to the same host is not very high, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> to achieve the best latency.  \n  \n The Instance Locked Exception Action feature supports the following scenarios. In all scenarios, if the instanceLockedExceptionAction property of the SqlWorkflowInstanceStore is set to <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> or <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>, the host transparently retries to acquire the lock on instances periodically.  \n  \n1.  **Enabling graceful shutdown and overlapped recycling of application domains.** Suppose an **AppDomain** with a service host running workflow service instances is being recycled and a new **AppDomain** is brought up to handle new requests in parallel while the old **AppDomain** is brought down gracefully. The shutdown waits until workflow service instances are idle, and then persists and unloads the instances. Any attempts by hosts in the new **AppDomain** to lock an instance will cause an <xref:System.Runtime.DurableInstancing.InstanceLockedException>.  \n  \n2.  **Horizontally scaling durable workflows across a homogeneous farm of servers.** Suppose a node of a server farm on which a workflow instance is running crashes and the workflow host cannot remove locks on the instance it is running. When a service host running on another node of the farm receives a message for that workflow instance, it tries to acquire locks on these instances it will receive the <xref:System.Runtime.DurableInstancing.InstanceLockedException>. The locks will expire after some time because the host that was supposed to renew the lock no longer exists.  \n  \n     **Horizontally scaling durable workflows across a homogeneous farm of servers.**  Suppose you want to horizontally scale a durable workflow using multiple hosts behind a NLB (Network Load Balancer), the workflow host running on one node of the farm loads a workflow instance and is processing a message, and the next message to the instance is routed to the host that is running on another node because the NLB does not have routing algorithm to deliver messages to the host that is already running the instance. Upon receiving the message, the second host attempts to load the workflow instance and receives the <xref:System.Runtime.DurableInstancing.InstanceLockedException> because the first host has a lock on the instance. The first host unlocks the instance when it is finished with processing the first message and the second host acquires the lock when it retries the next time, loads the instance, and processes the second message.\n","nodes":[{"pos":[4,116],"embed":true,"restype":"x-metadata","content":"title: \"Instance Locked Exception Action\"\nms.date: \"03/30/2017\"\nms.assetid: 164a5419-315c-4987-ad72-54cbdb88d402","nodes":[{"content":"Instance Locked Exception Action","nodes":[{"pos":[0,32],"content":"Instance Locked Exception Action","nodes":[{"content":"Instance Locked Exception Action","pos":[0,32]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[123,155],"content":"Instance Locked Exception Action","linkify":"Instance Locked Exception Action","nodes":[{"content":"Instance Locked Exception Action","pos":[0,32]}]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A&gt;</ph> property of the SQL Workflow Instance Store lets you specify what action the SQL persistence provider should take when it receives an <ph id=\"ph2\">&lt;xref:System.Runtime.DurableInstancing.InstanceLockedException&gt;</ph>.","pos":[156,459],"source":"The <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A> property of the SQL Workflow Instance Store lets you specify what action the SQL persistence provider should take when it receives an <xref:System.Runtime.DurableInstancing.InstanceLockedException>."},{"content":"The persistence provider receives this exception when it tries to lock a workflow service instance that is currently locked by another service host.","pos":[460,608]},{"content":"The values for this property are <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry&gt;</ph>, and <ph id=\"ph3\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry&gt;</ph>.","pos":[609,902],"source":" The values for this property are <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>, <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>, and <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>."},{"content":"The default value is <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry&gt;</ph>.","pos":[903,1005],"source":" The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>."},{"content":"The following list describes the three options:","pos":[1006,1053]},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry&gt;</ph>.","pos":[1063,1144],"source":"<xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>."},{"content":"The service host does not attempt to lock the workflow service instance and passes the <ph id=\"ph1\">&lt;xref:System.Runtime.DurableInstancing.InstanceLockedException&gt;</ph> to the caller.","pos":[1145,1310],"source":" The service host does not attempt to lock the workflow service instance and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller."},{"content":"If your workflow stays in memory for a period exceeding 60 seconds, use <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry&gt;</ph> as the retry.","pos":[1312,1478],"source":"  If your workflow stays in memory for a period exceeding 60 seconds, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> as the retry."},{"content":"The default value is <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry&gt;</ph>.","pos":[1479,1581],"source":" The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>."},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry&gt;</ph>.","pos":[1591,1675],"source":"<xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>."},{"content":"The service host reattempts to lock the workflow service instance with a linear interval between retry attempts and passes the <ph id=\"ph1\">&lt;xref:System.Runtime.DurableInstancing.InstanceLockedException&gt;</ph> to the caller at the end of the sequence.","pos":[1676,1908],"source":" The service host reattempts to lock the workflow service instance with a linear interval between retry attempts and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller at the end of the sequence."},{"content":"If you workflow stays in memory approximately between 5-60 seconds, and messages arrive in batches where it is more likely for messages being sent to the same instance on the same host to process all messages before unloading the workflow, use <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry&gt;</ph> to achieve the best latency without wasting resources.","pos":[1909,2291],"source":" If you workflow stays in memory approximately between 5-60 seconds, and messages arrive in batches where it is more likely for messages being sent to the same instance on the same host to process all messages before unloading the workflow, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> to achieve the best latency without wasting resources."},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry&gt;</ph>.","pos":[2301,2390],"source":"<xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>."},{"content":"The service host reattempts to lock the workflow service instance with an exponential backoff interval between retry attempts, and passes the exception to the caller at the end of the sequence.","pos":[2391,2584]},{"content":"If your workflow stays in memory for a very short time (less than 5 seconds), or a Web farm is large and the chance of another message being delivered to the same host is not very high, use <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry&gt;</ph> to achieve the best latency.","pos":[2585,2892],"source":" If your workflow stays in memory for a very short time (less than 5 seconds), or a Web farm is large and the chance of another message being delivered to the same host is not very high, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> to achieve the best latency."},{"content":"The Instance Locked Exception Action feature supports the following scenarios.","pos":[2899,2977]},{"content":"In all scenarios, if the instanceLockedExceptionAction property of the SqlWorkflowInstanceStore is set to <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry&gt;</ph> or <ph id=\"ph2\">&lt;xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry&gt;</ph>, the host transparently retries to acquire the lock on instances periodically.","pos":[2978,3338],"source":" In all scenarios, if the instanceLockedExceptionAction property of the SqlWorkflowInstanceStore is set to <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> or <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>, the host transparently retries to acquire the lock on instances periodically."},{"content":"<bpt id=\"p1\">**</bpt>Enabling graceful shutdown and overlapped recycling of application domains.<ept id=\"p1\">**</ept>","pos":[3348,3427],"source":"**Enabling graceful shutdown and overlapped recycling of application domains.**"},{"content":"Suppose an <bpt id=\"p1\">**</bpt>AppDomain<ept id=\"p1\">**</ept> with a service host running workflow service instances is being recycled and a new <bpt id=\"p2\">**</bpt>AppDomain<ept id=\"p2\">**</ept> is brought up to handle new requests in parallel while the old <bpt id=\"p3\">**</bpt>AppDomain<ept id=\"p3\">**</ept> is brought down gracefully.","pos":[3428,3654],"source":" Suppose an **AppDomain** with a service host running workflow service instances is being recycled and a new **AppDomain** is brought up to handle new requests in parallel while the old **AppDomain** is brought down gracefully."},{"content":"The shutdown waits until workflow service instances are idle, and then persists and unloads the instances.","pos":[3655,3761]},{"content":"Any attempts by hosts in the new <bpt id=\"p1\">**</bpt>AppDomain<ept id=\"p1\">**</ept> to lock an instance will cause an <ph id=\"ph1\">&lt;xref:System.Runtime.DurableInstancing.InstanceLockedException&gt;</ph>.","pos":[3762,3907],"source":" Any attempts by hosts in the new **AppDomain** to lock an instance will cause an <xref:System.Runtime.DurableInstancing.InstanceLockedException>."},{"content":"<bpt id=\"p1\">**</bpt>Horizontally scaling durable workflows across a homogeneous farm of servers.<ept id=\"p1\">**</ept>","pos":[3917,3997],"source":"**Horizontally scaling durable workflows across a homogeneous farm of servers.**"},{"content":"Suppose a node of a server farm on which a workflow instance is running crashes and the workflow host cannot remove locks on the instance it is running.","pos":[3998,4150]},{"content":"When a service host running on another node of the farm receives a message for that workflow instance, it tries to acquire locks on these instances it will receive the <ph id=\"ph1\">&lt;xref:System.Runtime.DurableInstancing.InstanceLockedException&gt;</ph>.","pos":[4151,4383],"source":" When a service host running on another node of the farm receives a message for that workflow instance, it tries to acquire locks on these instances it will receive the <xref:System.Runtime.DurableInstancing.InstanceLockedException>."},{"content":"The locks will expire after some time because the host that was supposed to renew the lock no longer exists.","pos":[4384,4492]},{"content":"<bpt id=\"p1\">**</bpt>Horizontally scaling durable workflows across a homogeneous farm of servers.<ept id=\"p1\">**</ept>","pos":[4503,4583],"source":"**Horizontally scaling durable workflows across a homogeneous farm of servers.**"},{"content":"Suppose you want to horizontally scale a durable workflow using multiple hosts behind a NLB (Network Load Balancer), the workflow host running on one node of the farm loads a workflow instance and is processing a message, and the next message to the instance is routed to the host that is running on another node because the NLB does not have routing algorithm to deliver messages to the host that is already running the instance.","pos":[4585,5015]},{"content":"Upon receiving the message, the second host attempts to load the workflow instance and receives the <ph id=\"ph1\">&lt;xref:System.Runtime.DurableInstancing.InstanceLockedException&gt;</ph> because the first host has a lock on the instance.","pos":[5016,5230],"source":" Upon receiving the message, the second host attempts to load the workflow instance and receives the <xref:System.Runtime.DurableInstancing.InstanceLockedException> because the first host has a lock on the instance."},{"content":"The first host unlocks the instance when it is finished with processing the first message and the second host acquires the lock when it retries the next time, loads the instance, and processes the second message.","pos":[5231,5443]}]}