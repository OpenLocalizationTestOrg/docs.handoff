{"content":"---\ntitle: \"Enabling Multiple Active Result Sets | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-ado\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 576079e4-debe-4ab5-9204-fcbe2ca7a5e2\ncaps.latest.revision: 6\nauthor: \"JennieHubbard\"\nms.author: \"jhubbard\"\nmanager: \"jhubbard\"\n---\n# Enabling Multiple Active Result Sets\nMultiple Active Result Sets (MARS) is a feature that works with SQL Server to allow the execution of multiple batches on a single connection. When MARS is enabled for use with SQL Server, each command object used adds a session to the connection.  \n  \n> [!NOTE]\n>  A single MARS session opens one logical connection for MARS to use and then one logical connection for each active command.  \n  \n## Enabling and Disabling MARS in the Connection String  \n  \n> [!NOTE]\n>  The following connection strings use the sample **AdventureWorks** database included with SQL Server. The connection strings provided assume that the database is installed on a server named MSSQL1. Modify the connection string as necessary for your environment.  \n  \n The MARS feature is disabled by default. It can be enabled by adding the \"MultipleActiveResultSets=True\" keyword pair to your connection string. \"True\" is the only valid value for enabling MARS. The following example demonstrates how to connect to an instance of SQL Server and how to specify that MARS should be enabled.  \n  \n```vb  \nDim connectionString As String = \"Data Source=MSSQL1;\" & _  \n    \"Initial Catalog=AdventureWorks;Integrated Security=SSPI;\" & _  \n    \"MultipleActiveResultSets=True\"  \n```  \n  \n```csharp  \nstring connectionString = \"Data Source=MSSQL1;\" +   \n    \"Initial Catalog=AdventureWorks;Integrated Security=SSPI;\" +  \n    \"MultipleActiveResultSets=True\";  \n```  \n  \n You can disable MARS by adding the \"MultipleActiveResultSets=False\" keyword pair to your connection string. \"False\" is the only valid value for disabling MARS. The following connection string demonstrates how to disable MARS.  \n  \n```vb  \nDim connectionString As String = \"Data Source=MSSQL1;\" & _  \n    \"Initial Catalog=AdventureWorks;Integrated Security=SSPI;\" & _  \n    \"MultipleActiveResultSets=False\"  \n```  \n  \n```csharp  \nstring connectionString = \"Data Source=MSSQL1;\" +   \n    \"Initial Catalog=AdventureWorks;Integrated Security=SSPI;\" +  \n    \"MultipleActiveResultSets=False\";  \n```  \n  \n## Special Considerations When Using MARS  \n In general, existing applications should not need modification to use a MARS-enabled connection. However, if you wish to use MARS features in your applications, you should understand the following special considerations.  \n  \n### Statement Interleaving  \n MARS operations execute synchronously on the server. Statement interleaving of SELECT and BULK INSERT statements is allowed. However, data manipulation language (DML) and data definition language (DDL) statements execute atomically. Any statements attempting to execute while an atomic batch is executing are blocked. Parallel execution at the server is not a MARS feature.  \n  \n If two batches are submitted under a MARS connection, one of them containing a SELECT statement, the other containing a DML statement, the DML can begin execution within execution of the SELECT statement. However, the DML statement must run to completion before the SELECT statement can make progress. If both statements are running under the same transaction, any changes made by a DML statement after the SELECT statement has started execution are not visible to the read operation.  \n  \n A WAITFOR statement inside a SELECT statement does not yield the transaction while it is waiting, that is, until the first row is produced. This implies that no other batches can execute within the same connection while a WAITFOR statement is waiting.  \n  \n### MARS Session Cache  \n When a connection is opened with MARS enabled, a logical session is created, which adds additional overhead. To minimize overhead and enhance performance, **SqlClient** caches the MARS session within a connection. The cache contains at most 10 MARS sessions. This value is not user adjustable. If the session limit is reached, a new session is created—an error is not generated. The cache and sessions contained in it are per-connection; they are not shared across connections. When a session is released, it is returned to the pool unless the pool's upper limit has been reached. If the cache pool is full, the session is closed. MARS sessions do not expire. They are only cleaned up when the connection object is disposed. The MARS session cache is not preloaded. It is loaded as the application requires more sessions.  \n  \n### Thread Safety  \n MARS operations are not thread-safe.  \n  \n### Connection Pooling  \n MARS-enabled connections are pooled like any other connection. If an application opens two connections, one with MARS enabled and one with MARS disabled, the two connections are in separate pools. For more information, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).  \n  \n### SQL Server Batch Execution Environment  \n When a connection is opened, a default environment is defined. This environment is then copied into a logical MARS session.  \n  \n The batch execution environment includes the following components:  \n  \n-   Set options (for example, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)  \n  \n-   Security context (user/application role)  \n  \n-   Database context (current database)  \n  \n-   Execution state variables (for example, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)  \n  \n-   Top-level temporary tables  \n  \n With MARS, a default execution environment is associated to a connection. Every new batch that starts executing under a given connection receives a copy of the default environment. Whenever code is executed under a given batch, all changes made to the environment are scoped to the specific batch. Once execution finishes, the execution settings are copied into the default environment. In the case of a single batch issuing several commands to be executed sequentially under the same transaction, semantics are the same as those exposed by connections involving earlier clients or servers.  \n  \n### Parallel Execution  \n MARS is not designed to remove all requirements for multiple connections in an application. If an application needs true parallel execution of commands against a server, multiple connections should be used.  \n  \n For example, consider the following scenario. Two command objects are created, one for processing a result set and another for updating data; they share a common connection via MARS. In this scenario, the `Transaction`.`Commit` fails on the update until all the results have been read on the first command object, yielding the following exception:  \n  \n Message: Transaction context in use by another session.  \n  \n Source: .Net SqlClient Data Provider  \n  \n Expected: (null)  \n  \n Received: System.Data.SqlClient.SqlException  \n  \n There are three options for handling this scenario:  \n  \n1.  Start the transaction after the reader is created, so that it is not part of the transaction. Every update then becomes its own transaction.  \n  \n2.  Commit all work after the reader is closed. This has the potential for a substantial batch of updates.  \n  \n3.  Don't use MARS; instead use a separate connection for each command object as you would have before MARS.  \n  \n### Detecting MARS Support  \n An application can check for MARS support by reading the `SqlConnection.ServerVersion` value. The major number should be 9 for SQL Server 2005 and 10 for SQL Server 2008.  \n  \n## See Also  \n [Multiple Active Result Sets (MARS)](../../../../../docs/framework/data/adonet/sql/multiple-active-result-sets-mars.md)   \n [ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)","nodes":[{"pos":[4,367],"nodes":[{"content":"Enabling Multiple Active Result Sets | Microsoft Docs","nodes":[{"pos":[0,53],"content":"Enabling Multiple Active Result Sets | Microsoft Docs","nodes":[{"content":"Enabling Multiple Active Result Sets | Microsoft Docs","pos":[0,53]}]}],"pos":[6,62],"yaml":true}],"content":"title: \"Enabling Multiple Active Result Sets | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-ado\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 576079e4-debe-4ab5-9204-fcbe2ca7a5e2\ncaps.latest.revision: 6\nauthor: \"JennieHubbard\"\nms.author: \"jhubbard\"\nmanager: \"jhubbard\"","yamlblock":true},{"pos":[374,410],"content":"Enabling Multiple Active Result Sets","linkify":"Enabling Multiple Active Result Sets","nodes":[{"content":"Enabling Multiple Active Result Sets","pos":[0,36]}]},{"content":"Multiple Active Result Sets (MARS) is a feature that works with SQL Server to allow the execution of multiple batches on a single connection.","pos":[411,552]},{"content":"When MARS is enabled for use with SQL Server, each command object used adds a session to the connection.","pos":[553,657]},{"pos":[665,799],"content":"[!NOTE]\n A single MARS session opens one logical connection for MARS to use and then one logical connection for each active command.","leadings":["","> "],"nodes":[{"content":"A single MARS session opens one logical connection for MARS to use and then one logical connection for each active command.","pos":[9,132]}]},{"pos":[808,860],"content":"Enabling and Disabling MARS in the Connection String","linkify":"Enabling and Disabling MARS in the Connection String","nodes":[{"content":"Enabling and Disabling MARS in the Connection String","pos":[0,52]}]},{"pos":[868,1140],"content":"[!NOTE]\n The following connection strings use the sample **AdventureWorks** database included with SQL Server. The connection strings provided assume that the database is installed on a server named MSSQL1. Modify the connection string as necessary for your environment.","leadings":["","> "],"nodes":[{"content":"The following connection strings use the sample **AdventureWorks** database included with SQL Server. The connection strings provided assume that the database is installed on a server named MSSQL1. Modify the connection string as necessary for your environment.","pos":[9,270],"nodes":[{"content":"The following connection strings use the sample <bpt id=\"p1\">**</bpt>AdventureWorks<ept id=\"p1\">**</ept> database included with SQL Server.","pos":[0,101],"source":"The following connection strings use the sample **AdventureWorks** database included with SQL Server."},{"content":"The connection strings provided assume that the database is installed on a server named MSSQL1.","pos":[102,197]},{"content":"Modify the connection string as necessary for your environment.","pos":[198,261]}]}]},{"content":"The MARS feature is disabled by default.","pos":[1147,1187]},{"content":"It can be enabled by adding the \"MultipleActiveResultSets=True\" keyword pair to your connection string.","pos":[1188,1291]},{"content":"\"True\" is the only valid value for enabling MARS.","pos":[1292,1341]},{"content":"The following example demonstrates how to connect to an instance of SQL Server and how to specify that MARS should be enabled.","pos":[1342,1468]},{"content":"You can disable MARS by adding the \"MultipleActiveResultSets=False\" keyword pair to your connection string.","pos":[1840,1947]},{"content":"\"False\" is the only valid value for disabling MARS.","pos":[1948,1999]},{"content":"The following connection string demonstrates how to disable MARS.","pos":[2000,2065]},{"pos":[2441,2479],"content":"Special Considerations When Using MARS","linkify":"Special Considerations When Using MARS","nodes":[{"content":"Special Considerations When Using MARS","pos":[0,38]}]},{"content":"In general, existing applications should not need modification to use a MARS-enabled connection.","pos":[2483,2579]},{"content":"However, if you wish to use MARS features in your applications, you should understand the following special considerations.","pos":[2580,2703]},{"pos":[2713,2735],"content":"Statement Interleaving","linkify":"Statement Interleaving","nodes":[{"content":"Statement Interleaving","pos":[0,22]}]},{"content":"MARS operations execute synchronously on the server.","pos":[2739,2791]},{"content":"Statement interleaving of SELECT and BULK INSERT statements is allowed.","pos":[2792,2863]},{"content":"However, data manipulation language (DML) and data definition language (DDL) statements execute atomically.","pos":[2864,2971]},{"content":"Any statements attempting to execute while an atomic batch is executing are blocked.","pos":[2972,3056]},{"content":"Parallel execution at the server is not a MARS feature.","pos":[3057,3112]},{"content":"If two batches are submitted under a MARS connection, one of them containing a SELECT statement, the other containing a DML statement, the DML can begin execution within execution of the SELECT statement.","pos":[3119,3323]},{"content":"However, the DML statement must run to completion before the SELECT statement can make progress.","pos":[3324,3420]},{"content":"If both statements are running under the same transaction, any changes made by a DML statement after the SELECT statement has started execution are not visible to the read operation.","pos":[3421,3603]},{"content":"A WAITFOR statement inside a SELECT statement does not yield the transaction while it is waiting, that is, until the first row is produced.","pos":[3610,3749]},{"content":"This implies that no other batches can execute within the same connection while a WAITFOR statement is waiting.","pos":[3750,3861]},{"pos":[3871,3889],"content":"MARS Session Cache","linkify":"MARS Session Cache","nodes":[{"content":"MARS Session Cache","pos":[0,18]}]},{"content":"When a connection is opened with MARS enabled, a logical session is created, which adds additional overhead.","pos":[3893,4001]},{"content":"To minimize overhead and enhance performance, <bpt id=\"p1\">**</bpt>SqlClient<ept id=\"p1\">**</ept> caches the MARS session within a connection.","pos":[4002,4106],"source":" To minimize overhead and enhance performance, **SqlClient** caches the MARS session within a connection."},{"content":"The cache contains at most 10 MARS sessions.","pos":[4107,4151]},{"content":"This value is not user adjustable.","pos":[4152,4186]},{"content":"If the session limit is reached, a new session is created—an error is not generated.","pos":[4187,4271]},{"content":"The cache and sessions contained in it are per-connection; they are not shared across connections.","pos":[4272,4370]},{"content":"When a session is released, it is returned to the pool unless the pool's upper limit has been reached.","pos":[4371,4473]},{"content":"If the cache pool is full, the session is closed.","pos":[4474,4523]},{"content":"MARS sessions do not expire.","pos":[4524,4552]},{"content":"They are only cleaned up when the connection object is disposed.","pos":[4553,4617]},{"content":"The MARS session cache is not preloaded.","pos":[4618,4658]},{"content":"It is loaded as the application requires more sessions.","pos":[4659,4714]},{"pos":[4724,4737],"content":"Thread Safety","linkify":"Thread Safety","nodes":[{"content":"Thread Safety","pos":[0,13]}]},{"content":"MARS operations are not thread-safe.","pos":[4741,4777]},{"pos":[4787,4805],"content":"Connection Pooling","linkify":"Connection Pooling","nodes":[{"content":"Connection Pooling","pos":[0,18]}]},{"content":"MARS-enabled connections are pooled like any other connection.","pos":[4809,4871]},{"content":"If an application opens two connections, one with MARS enabled and one with MARS disabled, the two connections are in separate pools.","pos":[4872,5005]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>SQL Server Connection Pooling (ADO.NET)<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md)</ept>.","pos":[5006,5150],"source":" For more information, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md)."},{"pos":[5160,5198],"content":"SQL Server Batch Execution Environment","linkify":"SQL Server Batch Execution Environment","nodes":[{"content":"SQL Server Batch Execution Environment","pos":[0,38]}]},{"content":"When a connection is opened, a default environment is defined.","pos":[5202,5264]},{"content":"This environment is then copied into a logical MARS session.","pos":[5265,5325]},{"content":"The batch execution environment includes the following components:","pos":[5332,5398]},{"content":"Set options (for example, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)","pos":[5408,5478]},{"content":"Security context (user/application role)","pos":[5488,5528]},{"content":"Database context (current database)","pos":[5538,5573]},{"content":"Execution state variables (for example, @<ph id=\"ph1\">@ERROR</ph>, @<ph id=\"ph2\">@ROWCOUNT</ph>, @<ph id=\"ph3\">@FETCH_STATUS</ph> @<ph id=\"ph4\">@IDENTITY</ph>)","pos":[5583,5670],"source":"Execution state variables (for example, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)"},{"content":"Top-level temporary tables","pos":[5680,5706]},{"content":"With MARS, a default execution environment is associated to a connection.","pos":[5713,5786]},{"content":"Every new batch that starts executing under a given connection receives a copy of the default environment.","pos":[5787,5893]},{"content":"Whenever code is executed under a given batch, all changes made to the environment are scoped to the specific batch.","pos":[5894,6010]},{"content":"Once execution finishes, the execution settings are copied into the default environment.","pos":[6011,6099]},{"content":"In the case of a single batch issuing several commands to be executed sequentially under the same transaction, semantics are the same as those exposed by connections involving earlier clients or servers.","pos":[6100,6303]},{"pos":[6313,6331],"content":"Parallel Execution","linkify":"Parallel Execution","nodes":[{"content":"Parallel Execution","pos":[0,18]}]},{"content":"MARS is not designed to remove all requirements for multiple connections in an application.","pos":[6335,6426]},{"content":"If an application needs true parallel execution of commands against a server, multiple connections should be used.","pos":[6427,6541]},{"content":"For example, consider the following scenario.","pos":[6548,6593]},{"content":"Two command objects are created, one for processing a result set and another for updating data; they share a common connection via MARS.","pos":[6594,6730]},{"content":"In this scenario, the <ph id=\"ph1\">`Transaction`</ph>.<ph id=\"ph2\">`Commit`</ph>","pos":[6731,6775],"source":" In this scenario, the `Transaction`.`Commit`"},{"content":"fails on the update until all the results have been read on the first command object, yielding the following exception:","pos":[6776,6895]},{"content":"Message: Transaction context in use by another session.","pos":[6902,6957]},{"content":"Source: .Net SqlClient Data Provider","pos":[6964,7000]},{"content":"Expected: (null)","pos":[7007,7023]},{"content":"Received: System.Data.SqlClient.SqlException","pos":[7030,7074]},{"content":"There are three options for handling this scenario:","pos":[7081,7132]},{"content":"Start the transaction after the reader is created, so that it is not part of the transaction.","pos":[7142,7235]},{"content":"Every update then becomes its own transaction.","pos":[7236,7282]},{"content":"Commit all work after the reader is closed.","pos":[7292,7335]},{"content":"This has the potential for a substantial batch of updates.","pos":[7336,7394]},{"content":"Don't use MARS; instead use a separate connection for each command object as you would have before MARS.","pos":[7404,7508]},{"pos":[7518,7540],"content":"Detecting MARS Support","linkify":"Detecting MARS Support","nodes":[{"content":"Detecting MARS Support","pos":[0,22]}]},{"content":"An application can check for MARS support by reading the <ph id=\"ph1\">`SqlConnection.ServerVersion`</ph> value.","pos":[7544,7637],"source":"An application can check for MARS support by reading the `SqlConnection.ServerVersion` value."},{"content":"The major number should be 9 for SQL Server 2005 and 10 for SQL Server 2008.","pos":[7638,7714]},{"pos":[7723,7731],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Multiple Active Result Sets (MARS)<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/multiple-active-result-sets-mars.md)</ept><ph id=\"ph1\"> </ph>","pos":[7735,7855],"source":"[Multiple Active Result Sets (MARS)](../../../../../docs/framework/data/adonet/sql/multiple-active-result-sets-mars.md) "},{"content":"<bpt id=\"p1\">[</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=217917)</ept>","pos":[7859,7962],"source":"[ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)"}]}