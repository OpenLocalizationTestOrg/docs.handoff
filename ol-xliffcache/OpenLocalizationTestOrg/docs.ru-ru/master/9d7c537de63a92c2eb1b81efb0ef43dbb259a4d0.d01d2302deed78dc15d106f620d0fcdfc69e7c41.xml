{"content":"---\ntitle: \"Securing Messages Using Message Security | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: a17ebe67-836b-4c52-9a81-2c3d58e225ee\ncaps.latest.revision: 16\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"\n---\n# Securing Messages Using Message Security\nThis section discusses [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message security when using <xref:System.ServiceModel.NetMsmqBinding>.  \n  \n> [!NOTE]\n>  Before reading through this topic, it is recommended that you read [Security Concepts](../../../../docs/framework/wcf/feature-details/security-concepts.md).  \n  \n The following illustration provides a conceptual model of queued communication using [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]. This illustration and terminology are used to explain  \n  \n transport security concepts.  \n  \n ![Queued Application Diagram](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg \"Distributed-Queue-Figure\")  \n  \n When sending queued messages using [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message is attached as a body of the Message Queuing (MSMQ) message. While transport security secures the entire MSMQ message, message (or SOAP) security only secures the body of the MSMQ message.  \n  \n The key concept of message security is that the client secures the message for the receiving application (service), unlike transport security where the client secures the message for the Target Queue. As such, MSMQ plays no part when securing the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message using message security.  \n  \n [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message security adds security headers to the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message that integrate with existing security infrastructures, such as a certificate or the Kerberos protocol.  \n  \n## Message Credential Type  \n Using message security, the service and client can present credentials to authenticate each another. You can select message security by setting the <xref:System.ServiceModel.NetMsmqBinding.Security%2A> mode to `Message` or `Both` (that is, use both transport security and message security).  \n  \n The service can use the <xref:System.ServiceModel.ServiceSecurityContext.Current%2A> property to inspect the credential used to authenticate the client. This can also be used for further authorization checks that the service chooses to implement.  \n  \n This section explains the different credential types and how to use them with queues.  \n  \n### Certificate  \n The certificate credential type uses an X.509 certificate to identify the service and the client.  \n  \n In a typical scenario, the client and the service are issued a valid certificate by a trusted certification authority. Then the connection is established, the client authenticates the validity of the service using the service's certificate to decide whether it can trust the service. Similarly, the service uses the client's certificate to validate the client trust.  \n  \n Given the disconnected nature of queues, the client and the service may not be online at the same time. As such, the client and service have to exchange certificates out-of-band. In particular, the client, by virtue of holding the service's certificate (which can be chained to a certification authority) in its trusted store, must trust that it is communicating with the correct service. For authenticating the client, the service uses the X.509 certificate attached with the message to matches it with the certificate in its store to verify the authenticity of the client. Again, the certificate must be chained to a certification authority.  \n  \n On a computer running Windows, certificates are held in several kinds of stores. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] the different stores, see [Certificate stores](http://go.microsoft.com/fwlink/?LinkId=87787).  \n  \n### Windows  \n Windows message credential type uses the Kerberos protocol.  \n  \n The Kerberos protocol is a security mechanism that authenticates users on a domain and allows the authenticated users to establish secure contexts with other entities on a domain.  \n  \n The problem with using the Kerberos protocol for queued communication is that the tickets that contain client identity that the Key Distribution Center (KDC) distributes are relatively short-lived. A *lifetime* is associated with the Kerberos ticket that indicates the validity of the ticket. As such, given high latency, you cannot be sure that the token is still valid for the service that authenticates the client.  \n  \n Note that when using this credential type, the service must be running under the SERVICE account.  \n  \n The Kerberos protocol is used by default when choosing message credential. [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Exploring Kerberos, the Protocol for Distributed Security in Windows 2000](http://go.microsoft.com/fwlink/?LinkId=87790).  \n  \n### Username Password  \n Using this property, the client can authenticate to the server using a username password in the security header of the message.  \n  \n### IssuedToken  \n The client can use the security token service to issue a token that can then be attached to the message for the service to authenticate the client.  \n  \n## Using Transport and Message Security  \n When using both transport security and message security, the certificate used to secure the message both at the transport and the SOAP message level must be the same.  \n  \n## See Also  \n [Securing Messages Using Transport Security](../../../../docs/framework/wcf/feature-details/securing-messages-using-transport-security.md)   \n [Message Security over Message Queuing](../../../../docs/framework/wcf/samples/message-security-over-message-queuing.md)   \n [Security Concepts](../../../../docs/framework/wcf/feature-details/security-concepts.md)   \n [Securing Services and Clients](../../../../docs/framework/wcf/feature-details/securing-services-and-clients.md)","nodes":[{"pos":[4,372],"embed":true,"restype":"x-metadata","content":"title: \"Securing Messages Using Message Security | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: a17ebe67-836b-4c52-9a81-2c3d58e225ee\ncaps.latest.revision: 16\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"","nodes":[{"content":"Securing Messages Using Message Security | Microsoft Docs","nodes":[{"pos":[0,57],"content":"Securing Messages Using Message Security | Microsoft Docs","nodes":[{"content":"Securing Messages Using Message Security | Microsoft Docs","pos":[0,57]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[379,419],"content":"Securing Messages Using Message Security","linkify":"Securing Messages Using Message Security","nodes":[{"content":"Securing Messages Using Message Security","pos":[0,40]}]},{"pos":[420,569],"content":"This section discusses <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> message security when using <ph id=\"ph2\">&lt;xref:System.ServiceModel.NetMsmqBinding&gt;</ph>.","source":"This section discusses [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message security when using <xref:System.ServiceModel.NetMsmqBinding>."},{"pos":[577,744],"content":"[!NOTE]\n Before reading through this topic, it is recommended that you read [Security Concepts](../../../../docs/framework/wcf/feature-details/security-concepts.md).","leadings":["","> "],"nodes":[{"content":"Before reading through this topic, it is recommended that you read <bpt id=\"p1\">[</bpt>Security Concepts<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-concepts.md)</ept>.","pos":[9,165],"source":"Before reading through this topic, it is recommended that you read [Security Concepts](../../../../docs/framework/wcf/feature-details/security-concepts.md)."}]},{"content":"The following illustration provides a conceptual model of queued communication using <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph>.","pos":[751,892],"source":"The following illustration provides a conceptual model of queued communication using [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]."},{"content":"This illustration and terminology are used to explain","pos":[893,946]},{"content":"transport security concepts.","pos":[953,981]},{"pos":[988,1127],"content":"<bpt id=\"p1\">![</bpt>Queued Application Diagram<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg \"</bpt>Distributed-Queue-Figure<ept id=\"p2\">\")</ept>","source":"![Queued Application Diagram](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg \"Distributed-Queue-Figure\")"},{"content":"When sending queued messages using <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph>, the <ph id=\"ph2\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> message is attached as a body of the Message Queuing (MSMQ) message.","pos":[1134,1354],"source":"When sending queued messages using [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message is attached as a body of the Message Queuing (MSMQ) message."},{"content":"While transport security secures the entire MSMQ message, message (or SOAP) security only secures the body of the MSMQ message.","pos":[1355,1482]},{"content":"The key concept of message security is that the client secures the message for the receiving application (service), unlike transport security where the client secures the message for the Target Queue.","pos":[1489,1689]},{"content":"As such, MSMQ plays no part when securing the <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> message using message security.","pos":[1690,1823],"source":" As such, MSMQ plays no part when securing the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message using message security."},{"pos":[1830,2098],"content":"<ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> message security adds security headers to the <ph id=\"ph2\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> message that integrate with existing security infrastructures, such as a certificate or the Kerberos protocol.","source":"[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message security adds security headers to the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] message that integrate with existing security infrastructures, such as a certificate or the Kerberos protocol."},{"pos":[2107,2130],"content":"Message Credential Type","linkify":"Message Credential Type","nodes":[{"content":"Message Credential Type","pos":[0,23]}]},{"content":"Using message security, the service and client can present credentials to authenticate each another.","pos":[2134,2234]},{"content":"You can select message security by setting the <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetMsmqBinding.Security%2A&gt;</ph> mode to <ph id=\"ph2\">`Message`</ph> or <ph id=\"ph3\">`Both`</ph> (that is, use both transport security and message security).","pos":[2235,2424],"source":" You can select message security by setting the <xref:System.ServiceModel.NetMsmqBinding.Security%2A> mode to `Message` or `Both` (that is, use both transport security and message security)."},{"content":"The service can use the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ServiceSecurityContext.Current%2A&gt;</ph> property to inspect the credential used to authenticate the client.","pos":[2431,2583],"source":"The service can use the <xref:System.ServiceModel.ServiceSecurityContext.Current%2A> property to inspect the credential used to authenticate the client."},{"content":"This can also be used for further authorization checks that the service chooses to implement.","pos":[2584,2677]},{"content":"This section explains the different credential types and how to use them with queues.","pos":[2684,2769]},{"pos":[2779,2790],"content":"Certificate","linkify":"Certificate","nodes":[{"content":"Certificate","pos":[0,11]}]},{"content":"The certificate credential type uses an X.509 certificate to identify the service and the client.","pos":[2794,2891]},{"content":"In a typical scenario, the client and the service are issued a valid certificate by a trusted certification authority.","pos":[2898,3016]},{"content":"Then the connection is established, the client authenticates the validity of the service using the service's certificate to decide whether it can trust the service.","pos":[3017,3181]},{"content":"Similarly, the service uses the client's certificate to validate the client trust.","pos":[3182,3264]},{"content":"Given the disconnected nature of queues, the client and the service may not be online at the same time.","pos":[3271,3374]},{"content":"As such, the client and service have to exchange certificates out-of-band.","pos":[3375,3449]},{"content":"In particular, the client, by virtue of holding the service's certificate (which can be chained to a certification authority) in its trusted store, must trust that it is communicating with the correct service.","pos":[3450,3659]},{"content":"For authenticating the client, the service uses the X.509 certificate attached with the message to matches it with the certificate in its store to verify the authenticity of the client.","pos":[3660,3845]},{"content":"Again, the certificate must be chained to a certification authority.","pos":[3846,3914]},{"content":"On a computer running Windows, certificates are held in several kinds of stores.","pos":[3921,4001]},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> the different stores, see <bpt id=\"p1\">[</bpt>Certificate stores<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=87787)</ept>.","pos":[4002,4151],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] the different stores, see [Certificate stores](http://go.microsoft.com/fwlink/?LinkId=87787)."},{"pos":[4161,4168],"content":"Windows","linkify":"Windows","nodes":[{"content":"Windows","pos":[0,7]}]},{"content":"Windows message credential type uses the Kerberos protocol.","pos":[4172,4231]},{"content":"The Kerberos protocol is a security mechanism that authenticates users on a domain and allows the authenticated users to establish secure contexts with other entities on a domain.","pos":[4238,4417]},{"content":"The problem with using the Kerberos protocol for queued communication is that the tickets that contain client identity that the Key Distribution Center (KDC) distributes are relatively short-lived.","pos":[4424,4621]},{"content":"A <bpt id=\"p1\">*</bpt>lifetime<ept id=\"p1\">*</ept> is associated with the Kerberos ticket that indicates the validity of the ticket.","pos":[4622,4716],"source":" A *lifetime* is associated with the Kerberos ticket that indicates the validity of the ticket."},{"content":"As such, given high latency, you cannot be sure that the token is still valid for the service that authenticates the client.","pos":[4717,4841]},{"content":"Note that when using this credential type, the service must be running under the SERVICE account.","pos":[4848,4945]},{"content":"The Kerberos protocol is used by default when choosing message credential.","pos":[4952,5026]},{"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)]</ph><bpt id=\"p1\">[</bpt>Exploring Kerberos, the Protocol for Distributed Security in Windows 2000<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=87790)</ept>.","pos":[5027,5208],"source":"[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Exploring Kerberos, the Protocol for Distributed Security in Windows 2000](http://go.microsoft.com/fwlink/?LinkId=87790)."},{"pos":[5218,5235],"content":"Username Password","linkify":"Username Password","nodes":[{"content":"Username Password","pos":[0,17]}]},{"content":"Using this property, the client can authenticate to the server using a username password in the security header of the message.","pos":[5239,5366]},{"pos":[5376,5387],"content":"IssuedToken","linkify":"IssuedToken","nodes":[{"content":"IssuedToken","pos":[0,11]}]},{"content":"The client can use the security token service to issue a token that can then be attached to the message for the service to authenticate the client.","pos":[5391,5538]},{"pos":[5547,5583],"content":"Using Transport and Message Security","linkify":"Using Transport and Message Security","nodes":[{"content":"Using Transport and Message Security","pos":[0,36]}]},{"content":"When using both transport security and message security, the certificate used to secure the message both at the transport and the SOAP message level must be the same.","pos":[5587,5753]},{"pos":[5762,5770],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Securing Messages Using Transport Security<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/securing-messages-using-transport-security.md)</ept><ph id=\"ph1\"> </ph>","pos":[5774,5913],"source":"[Securing Messages Using Transport Security](../../../../docs/framework/wcf/feature-details/securing-messages-using-transport-security.md) "},{"content":"<bpt id=\"p1\">[</bpt>Message Security over Message Queuing<ept id=\"p1\">](../../../../docs/framework/wcf/samples/message-security-over-message-queuing.md)</ept><ph id=\"ph1\"> </ph>","pos":[5917,6038],"source":"[Message Security over Message Queuing](../../../../docs/framework/wcf/samples/message-security-over-message-queuing.md) "},{"content":"<bpt id=\"p1\">[</bpt>Security Concepts<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-concepts.md)</ept><ph id=\"ph1\"> </ph>","pos":[6042,6131],"source":"[Security Concepts](../../../../docs/framework/wcf/feature-details/security-concepts.md) "},{"content":"<bpt id=\"p1\">[</bpt>Securing Services and Clients<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/securing-services-and-clients.md)</ept>","pos":[6135,6247],"source":"[Securing Services and Clients](../../../../docs/framework/wcf/feature-details/securing-services-and-clients.md)"}]}