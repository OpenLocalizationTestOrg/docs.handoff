{"content":"---\ntitle: \"Using WorkflowIdentity and Versioning | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: b8451735-8046-478f-912b-40870a6c0c3a\ncaps.latest.revision: 6\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Using WorkflowIdentity and Versioning\n<xref:System.Activities.WorkflowIdentity> provides a way for workflow application developers to associate a name and a <xref:System.Version> with a workflow definition, and for this information to be associated with a persisted workflow instance. This identity information can be used by workflow application developers to enable scenarios such as side-by-side execution of multiple versions of a workflow definition, and provides the cornerstone for other functionality such as dynamic update. This topic provides as overview of using <xref:System.Activities.WorkflowIdentity> with <xref:System.Activities.WorkflowApplication> hosting. For information on side-by-side execution of workflow definitions in a workflow service, see [Side by Side Versioning in WorkflowServiceHost](../../../docs/framework/wcf/feature-details/side-by-side-versioning-in-workflowservicehost.md). For information on dynamic update, see [Dynamic Update](../../../docs/framework/windows-workflow-foundation/dynamic-update.md).  \n  \n## In this topic  \n  \n-   [Using WorkflowIdentity](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UsingWorkflowIdentity)  \n  \n    -   [Side-by-side Execution using WorkflowIdentity](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#SxS)  \n  \n-   [Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases)  \n  \n    -   [To upgrade the database schema](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#ToUpgrade)  \n  \n##  <a name=\"UsingWorkflowIdentity\"></a> Using WorkflowIdentity  \n To use <xref:System.Activities.WorkflowIdentity>, create an instance, configure it, and associate it with a <xref:System.Activities.WorkflowApplication> instance. A <xref:System.Activities.WorkflowIdentity> instance contains three identifying pieces of information. <xref:System.Activities.WorkflowIdentity.Name%2A> and <xref:System.Activities.WorkflowIdentity.Version%2A> contain a name and a <xref:System.Version> and are required, and <xref:System.Activities.WorkflowIdentity.Package%2A> is optional and can be used to specify an additional string containing information such as assembly name or other desired information. A <xref:System.Activities.WorkflowIdentity> is unique if any of its three properties are different from another <xref:System.Activities.WorkflowIdentity>.  \n  \n> [!IMPORTANT]\n>  A <xref:System.Activities.WorkflowIdentity> should not contain any personally identifiable information (PII). Information about the <xref:System.Activities.WorkflowIdentity> used to create an instance is emitted to any configured tracking services at several different points of the activity life-cycle by the runtime. WF Tracking does not have any mechanism to hide PII (sensitive user data). Therefore, a <xref:System.Activities.WorkflowIdentity> instance should not contain any PII data as it will be emitted by the runtime in tracking records and may be visible to anyone with access to view the tracking records.  \n  \n In the following example, a <xref:System.Activities.WorkflowIdentity> is created and associated with an instance of a workflow created using a `MortgageWorkflow` workflow definition.  \n  \n```csharp  \nWorkflowIdentity identityV1 = new WorkflowIdentity  \n{  \n    Name = \"MortgageWorkflow v1\",  \n    Version = new Version(1, 0, 0, 0)  \n};  \n  \nWorkflowApplication wfApp = new WorkflowApplication(new MortgageWorkflow(), identity);  \n  \n// Configure the WorkflowApplication with persistence and desired workflow event handlers.  \nConfigureWorkflowApplication(wfApp);  \n  \n// Run the workflow.  \nwfApp.Run();  \n```  \n  \n When reloading and resuming a workflow, a <xref:System.Activities.WorkflowIdentity> that is configured to match the <xref:System.Activities.WorkflowIdentity> of the persisted workflow instance must be used.  \n  \n```csharp  \nWorkflowApplication wfApp = new WorkflowApplication(new MortgageWorkflow(), identityV1);  \n  \n// Configure the WorkflowApplication with persistence and desired workflow event handlers.  \nConfigureWorkflowApplication(wfApp);  \n  \n// Load the workflow.  \nwfApp.Load(instanceId);  \n  \n// Resume the workflow...  \n```  \n  \n If the <xref:System.Activities.WorkflowIdentity> used when reloading the workflow instance does not match the persisted <xref:System.Activities.WorkflowIdentity>, a <xref:System.Activities.VersionMismatchException> is thrown. In the following example a load attempt is made on the `MortgageWorkflow` instance that was persisted in the previous example. This load attempt is made using a <xref:System.Activities.WorkflowIdentity> configured for a newer version of the mortgage workflow that does not match the persisted instance.  \n  \n```csharp  \nWorkflowApplication wfApp = new WorkflowApplication(new MortgageWorkflow_v2(), identityV2);  \n  \n// Configure the WorkflowApplication with persistence and desired workflow event handlers.  \nConfigureWorkflowApplication(wfApp);  \n  \n// Attempt to load the workflow instance.  \nwfApp.Load(instanceId);  \n  \n// Resume the workflow...  \n```  \n  \n When the previous code is executed, the following <xref:System.Activities.VersionMismatchException> is thrown.  \n  \n **The WorkflowIdentity ('MortgageWorkflow v1; Version=1.0.0.0') of the loaded instance does not match the WorkflowIdentity ('MortgageWorkflow v2; Version=2.0.0.0') of the provided workflow definition. The instance can be loaded using a different definition, or updated using Dynamic Update.**   \n###  <a name=\"SxS\"></a> Side-by-side Execution using WorkflowIdentity  \n <xref:System.Activities.WorkflowIdentity> can be used to facilitate the execution of multiple versions of a workflow side-by-side. One common scenario is changing business requirements on a long-running workflow. Many instances of a workflow could be running when an updated version is deployed. The host application can be configured to use the updated workflow definition when starting new instances, and it is the responsibility of the host application to provide the correct workflow definition when resuming instances. <xref:System.Activities.WorkflowIdentity> can be used to identify and supply the matching workflow definition when resuming workflow instances.  \n  \n To retrieve the <xref:System.Activities.WorkflowIdentity> of a persisted workflow instance, the <xref:System.Activities.WorkflowApplication.GetInstance%2A> method is used. The <xref:System.Activities.WorkflowApplication.GetInstance%2A> method takes the <xref:System.Activities.WorkflowApplication.Id%2A> of the persisted workflow instance and the <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> that contains the persisted instance and returns a <xref:System.Activities.WorkflowApplicationInstance>. A <xref:System.Activities.WorkflowApplicationInstance> contains information about a persisted workflow instance, including its associated <xref:System.Activities.WorkflowIdentity>. This associated <xref:System.Activities.WorkflowIdentity> can be used by the host to supply the correct workflow definition when loading and resuming the workflow instance.  \n  \n> [!NOTE]\n>  A null <xref:System.Activities.WorkflowIdentity> is valid, and can be used by the host to map instances that were persisted with no associated <xref:System.Activities.WorkflowIdentity> to the proper workflow definition. This scenario can occur when a workflow application was not initially written with workflow versioning, or when an application is upgraded from [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)]. [!INCLUDE[crdefault](../../../includes/crdefault-md.md)] [Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases).  \n  \n In the following example a `Dictionary<WorkflowIdentity, Activity>` is used to associate <xref:System.Activities.WorkflowIdentity> instances with their matching workflow definitions, and a workflow is started using the `MortgageWorkflow` workflow definition, which is associated with the `identityV1` <xref:System.Activities.WorkflowIdentity>.  \n  \n```csharp  \nWorkflowIdentity identityV1 = new WorkflowIdentity  \n{  \n    Name = \"MortgageWorkflow v1\",  \n    Version = new Version(1, 0, 0, 0)  \n};  \n  \nWorkflowIdentity identityV2 = new WorkflowIdentity  \n{  \n    Name = \"MortgageWorkflow v2\",  \n    Version = new Version(2, 0, 0, 0)  \n};  \n  \nDictionary<WorkflowIdentity, Activity> WorkflowVersionMap = new Dictionary<WorkflowIdentity, Activity>();  \nWorkflowVersionMap.Add(identityV1, new MortgageWorkflow());  \nWorkflowVersionMap.Add(identityV2, new MortgageWorkflow_v2());  \n  \nWorkflowApplication wfApp = new WorkflowApplication(new MortgageWorkflow(), identityV1);  \n  \n// Configure the WorkflowApplication with persistence and desired workflow event handlers.  \nConfigureWorkflowApplication(wfApp);  \n  \n// Run the workflow.  \nwfApp.Run();  \n```  \n  \n In the following example, information about the persisted workflow instance from the previous example is retrieved by calling <xref:System.Activities.WorkflowApplication.GetInstance%2A>, and the persisted <xref:System.Activities.WorkflowIdentity> information is used to retrieve the matching workflow definition. This information is used to configure the <xref:System.Activities.WorkflowApplication>, and then the workflow is loaded. Note that because the <xref:System.Activities.WorkflowApplication.Load%2A> overload that takes the <xref:System.Activities.WorkflowApplicationInstance> is used, the <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> that was configured on the <xref:System.Activities.WorkflowApplicationInstance> is used by the <xref:System.Activities.WorkflowApplication> and therefore its <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property does not need to be configured.  \n  \n> [!NOTE]\n>  If the <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property is set, it must be set with the same <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> instance used by the <xref:System.Activities.WorkflowApplicationInstance> or else an <xref:System.ArgumentException> will be thrown with the following message: `The instance is configured with a different InstanceStore than this WorkflowApplication.`.  \n  \n```csharp  \n// Get the WorkflowApplicationInstance of the desired workflow from the specified  \n// SqlWorkflowInstanceStore.  \nWorkflowApplicationInstance instance = WorkflowApplication.GetInstance(instanceId, store);  \n  \n// Use the persisted WorkflowIdentity to retrieve the correct workflow  \n// definition from the dictionary.  \nActivity definition = WorkflowVersionMap[instance.DefinitionIdentity];  \n  \nWorkflowApplication wfApp = new WorkflowApplication(definition, instance.DefinitionIdentity);  \n  \n// Configure the WorkflowApplication with persistence and desired workflow event handlers.  \nConfigureWorkflowApplication(wfApp);  \n  \n// Load the persisted workflow instance.  \nwfApp.Load(instance);  \n  \n// Resume the workflow...  \n```  \n  \n##  <a name=\"UpdatingWF4PersistenceDatabases\"></a> Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning  \n A SqlWorkflowInstanceStoreSchemaUpgrade.sql database script is provided to upgrade persistence databases created using the [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)] database scripts. This script updates the databases to support the new versioning capabilities introduced in [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]. Any persisted workflow instances in the databases are given default versioning values, and can then participate in side-by-side execution and dynamic update.  \n  \n If a [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] workflow application attempts any persistence operations that use the new versioning features on a persistence database which has not been upgraded using the provided script, an <xref:System.Runtime.DurableInstancing.InstancePersistenceCommandException> is thrown with a message similar to the following message.  \n  \n **The SqlWorkflowInstanceStore has a database version of '4.0.0.0'. InstancePersistenceCommand 'System.Activities.DurableInstancing.CreateWorkflowOwnerWithIdentityCommand' cannot be run against this database version.  Please upgrade the database to '4.5.0.0'.**   \n###  <a name=\"ToUpgrade\"></a> To upgrade the database schema  \n  \n1.  Open SQL Server Management Studio and connect to the persistence database server, for example **.\\SQLEXPRESS**.  \n  \n2.  Choose **Open**, **File** from the **File** menu. Browse to the following folder: `C:\\Windows\\Microsoft.NET\\Framework\\4.0.30319\\sql\\en`  \n  \n3.  Select **SqlWorkflowInstanceStoreSchemaUpgrade.sql** and click **Open**.  \n  \n4.  Select the name of the persistence database in the **Available Databases** drop-down.  \n  \n5.  Choose **Execute** from the **Query** menu.  \n  \n When the query completes, the database schema is upgraded, and if desired, you can view the default workflow identity that was assigned to the persisted workflow instances. Expand your persistence database in the **Databases** node of the **Object Explorer**, and then expand the **Views** node. Right-click **System.Activities.DurableInstancing.Instances** and choose **Select Top 1000 Rows**. Scroll to end of the columns and note that there are six additional columns added to the view: **IdentityName**, **IdentityPackage**, **Build**, **Major**, **Minor**, and **Revision**. Any persisted workflows will have a value of **NULL** for these fields, representing a null workflow identity.","nodes":[{"pos":[12,66],"content":"Using WorkflowIdentity and Versioning | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Using WorkflowIdentity and Versioning | Microsoft Docs","pos":[0,54]}]},{"pos":[331,368],"content":"Using WorkflowIdentity and Versioning","linkify":"Using WorkflowIdentity and Versioning","nodes":[{"content":"Using WorkflowIdentity and Versioning","pos":[0,37]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> provides a way for workflow application developers to associate a name and a <ph id=\"ph2\">&lt;xref:System.Version&gt;</ph> with a workflow definition, and for this information to be associated with a persisted workflow instance.","pos":[369,615],"source":"<xref:System.Activities.WorkflowIdentity> provides a way for workflow application developers to associate a name and a <xref:System.Version> with a workflow definition, and for this information to be associated with a persisted workflow instance."},{"content":"This identity information can be used by workflow application developers to enable scenarios such as side-by-side execution of multiple versions of a workflow definition, and provides the cornerstone for other functionality such as dynamic update.","pos":[616,863]},{"content":"This topic provides as overview of using <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> with <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> hosting.","pos":[864,1005],"source":" This topic provides as overview of using <xref:System.Activities.WorkflowIdentity> with <xref:System.Activities.WorkflowApplication> hosting."},{"content":"For information on side-by-side execution of workflow definitions in a workflow service, see <bpt id=\"p1\">[</bpt>Side by Side Versioning in WorkflowServiceHost<ept id=\"p1\">](../../../docs/framework/wcf/feature-details/side-by-side-versioning-in-workflowservicehost.md)</ept>.","pos":[1006,1243],"source":" For information on side-by-side execution of workflow definitions in a workflow service, see [Side by Side Versioning in WorkflowServiceHost](../../../docs/framework/wcf/feature-details/side-by-side-versioning-in-workflowservicehost.md)."},{"content":"For information on dynamic update, see <bpt id=\"p1\">[</bpt>Dynamic Update<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/dynamic-update.md)</ept>.","pos":[1244,1371],"source":" For information on dynamic update, see [Dynamic Update](../../../docs/framework/windows-workflow-foundation/dynamic-update.md)."},{"pos":[1380,1393],"content":"In this topic","linkify":"In this topic","nodes":[{"content":"In this topic","pos":[0,13]}]},{"pos":[1403,1543],"content":"<bpt id=\"p1\">[</bpt>Using WorkflowIdentity<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UsingWorkflowIdentity)</ept>","source":"[Using WorkflowIdentity](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UsingWorkflowIdentity)"},{"pos":[1557,1702],"content":"<bpt id=\"p1\">[</bpt>Side-by-side Execution using WorkflowIdentity<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#SxS)</ept>","source":"[Side-by-side Execution using WorkflowIdentity](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#SxS)"},{"pos":[1712,1919],"content":"<bpt id=\"p1\">[</bpt>Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases)</ept>","source":"[Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases)"},{"pos":[1933,2069],"content":"<bpt id=\"p1\">[</bpt>To upgrade the database schema<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#ToUpgrade)</ept>","source":"[To upgrade the database schema](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#ToUpgrade)"},{"pos":[2079,2138],"content":"<bpt id=\"p1\">&lt;a name=\"UsingWorkflowIdentity\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Using WorkflowIdentity","linkify":"<a name=\"UsingWorkflowIdentity\"></a> Using WorkflowIdentity","source":"<a name=\"UsingWorkflowIdentity\"></a> Using WorkflowIdentity"},{"content":"To use <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph>, create an instance, configure it, and associate it with a <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> instance.","pos":[2142,2304],"source":"To use <xref:System.Activities.WorkflowIdentity>, create an instance, configure it, and associate it with a <xref:System.Activities.WorkflowApplication> instance."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> instance contains three identifying pieces of information.","pos":[2305,2407],"source":" A <xref:System.Activities.WorkflowIdentity> instance contains three identifying pieces of information."},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity.Name%2A&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity.Version%2A&gt;</ph> contain a name and a <ph id=\"ph3\">&lt;xref:System.Version&gt;</ph> and are required, and <ph id=\"ph4\">&lt;xref:System.Activities.WorkflowIdentity.Package%2A&gt;</ph> is optional and can be used to specify an additional string containing information such as assembly name or other desired information.","pos":[2408,2767],"source":"<xref:System.Activities.WorkflowIdentity.Name%2A> and <xref:System.Activities.WorkflowIdentity.Version%2A> contain a name and a <xref:System.Version> and are required, and <xref:System.Activities.WorkflowIdentity.Package%2A> is optional and can be used to specify an additional string containing information such as assembly name or other desired information."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> is unique if any of its three properties are different from another <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph>.","pos":[2768,2922],"source":" A <xref:System.Activities.WorkflowIdentity> is unique if any of its three properties are different from another <xref:System.Activities.WorkflowIdentity>."},{"pos":[2930,3563],"content":"[!IMPORTANT]\n A <xref:System.Activities.WorkflowIdentity> should not contain any personally identifiable information (PII). Information about the <xref:System.Activities.WorkflowIdentity> used to create an instance is emitted to any configured tracking services at several different points of the activity life-cycle by the runtime. WF Tracking does not have any mechanism to hide PII (sensitive user data). Therefore, a <xref:System.Activities.WorkflowIdentity> instance should not contain any PII data as it will be emitted by the runtime in tracking records and may be visible to anyone with access to view the tracking records.","leadings":["","> "],"nodes":[{"content":" A <xref:System.Activities.WorkflowIdentity> should not contain any personally identifiable information (PII). Information about the <xref:System.Activities.WorkflowIdentity> used to create an instance is emitted to any configured tracking services at several different points of the activity life-cycle by the runtime. WF Tracking does not have any mechanism to hide PII (sensitive user data). Therefore, a <xref:System.Activities.WorkflowIdentity> instance should not contain any PII data as it will be emitted by the runtime in tracking records and may be visible to anyone with access to view the tracking records.","pos":[13,631],"nodes":[{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> should not contain any personally identifiable information (PII).","pos":[1,110],"source":" A <xref:System.Activities.WorkflowIdentity> should not contain any personally identifiable information (PII)."},{"content":"Information about the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> used to create an instance is emitted to any configured tracking services at several different points of the activity life-cycle by the runtime.","pos":[111,319],"source":" Information about the <xref:System.Activities.WorkflowIdentity> used to create an instance is emitted to any configured tracking services at several different points of the activity life-cycle by the runtime."},{"content":"WF Tracking does not have any mechanism to hide PII (sensitive user data).","pos":[320,394]},{"content":"Therefore, a <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> instance should not contain any PII data as it will be emitted by the runtime in tracking records and may be visible to anyone with access to view the tracking records.","pos":[395,618],"source":" Therefore, a <xref:System.Activities.WorkflowIdentity> instance should not contain any PII data as it will be emitted by the runtime in tracking records and may be visible to anyone with access to view the tracking records."}]}]},{"pos":[3570,3752],"content":"In the following example, a <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> is created and associated with an instance of a workflow created using a <ph id=\"ph2\">`MortgageWorkflow`</ph> workflow definition.","source":"In the following example, a <xref:System.Activities.WorkflowIdentity> is created and associated with an instance of a workflow created using a `MortgageWorkflow` workflow definition."},{"content":"When reloading and resuming a workflow, a <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> that is configured to match the <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> of the persisted workflow instance must be used.","pos":[4186,4392],"source":"When reloading and resuming a workflow, a <xref:System.Activities.WorkflowIdentity> that is configured to match the <xref:System.Activities.WorkflowIdentity> of the persisted workflow instance must be used."},{"content":"If the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> used when reloading the workflow instance does not match the persisted <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph>, a <ph id=\"ph3\">&lt;xref:System.Activities.VersionMismatchException&gt;</ph> is thrown.","pos":[4730,4955],"source":"If the <xref:System.Activities.WorkflowIdentity> used when reloading the workflow instance does not match the persisted <xref:System.Activities.WorkflowIdentity>, a <xref:System.Activities.VersionMismatchException> is thrown."},{"content":"In the following example a load attempt is made on the <ph id=\"ph1\">`MortgageWorkflow`</ph> instance that was persisted in the previous example.","pos":[4956,5082],"source":" In the following example a load attempt is made on the `MortgageWorkflow` instance that was persisted in the previous example."},{"content":"This load attempt is made using a <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> configured for a newer version of the mortgage workflow that does not match the persisted instance.","pos":[5083,5258],"source":" This load attempt is made using a <xref:System.Activities.WorkflowIdentity> configured for a newer version of the mortgage workflow that does not match the persisted instance."},{"content":"When the previous code is executed, the following <ph id=\"ph1\">&lt;xref:System.Activities.VersionMismatchException&gt;</ph> is thrown.","pos":[5619,5729],"source":"When the previous code is executed, the following <xref:System.Activities.VersionMismatchException> is thrown."},{"pos":[5736,6028],"content":"<bpt id=\"p1\">**</bpt>The WorkflowIdentity ('MortgageWorkflow v1; Version=1.0.0.0') of the loaded instance does not match the WorkflowIdentity ('MortgageWorkflow v2; Version=2.0.0.0') of the provided workflow definition. The instance can be loaded using a different definition, or updated using Dynamic Update.<ept id=\"p1\">**</ept>","source":"**The WorkflowIdentity ('MortgageWorkflow v1; Version=1.0.0.0') of the loaded instance does not match the WorkflowIdentity ('MortgageWorkflow v2; Version=2.0.0.0') of the provided workflow definition. The instance can be loaded using a different definition, or updated using Dynamic Update.**"},{"pos":[6037,6101],"content":"<bpt id=\"p1\">&lt;a name=\"SxS\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Side-by-side Execution using WorkflowIdentity","linkify":"<a name=\"SxS\"></a> Side-by-side Execution using WorkflowIdentity","source":"<a name=\"SxS\"></a> Side-by-side Execution using WorkflowIdentity"},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> can be used to facilitate the execution of multiple versions of a workflow side-by-side.","pos":[6105,6235],"source":"<xref:System.Activities.WorkflowIdentity> can be used to facilitate the execution of multiple versions of a workflow side-by-side."},{"content":"One common scenario is changing business requirements on a long-running workflow.","pos":[6236,6317]},{"content":"Many instances of a workflow could be running when an updated version is deployed.","pos":[6318,6400]},{"content":"The host application can be configured to use the updated workflow definition when starting new instances, and it is the responsibility of the host application to provide the correct workflow definition when resuming instances.","pos":[6401,6628]},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> can be used to identify and supply the matching workflow definition when resuming workflow instances.","pos":[6629,6772],"source":"<xref:System.Activities.WorkflowIdentity> can be used to identify and supply the matching workflow definition when resuming workflow instances."},{"content":"To retrieve the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> of a persisted workflow instance, the <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplication.GetInstance%2A&gt;</ph> method is used.","pos":[6779,6950],"source":"To retrieve the <xref:System.Activities.WorkflowIdentity> of a persisted workflow instance, the <xref:System.Activities.WorkflowApplication.GetInstance%2A> method is used."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.GetInstance%2A&gt;</ph> method takes the <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplication.Id%2A&gt;</ph> of the persisted workflow instance and the <ph id=\"ph3\">&lt;xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore&gt;</ph> that contains the persisted instance and returns a <ph id=\"ph4\">&lt;xref:System.Activities.WorkflowApplicationInstance&gt;</ph>.","pos":[6951,7298],"source":" The <xref:System.Activities.WorkflowApplication.GetInstance%2A> method takes the <xref:System.Activities.WorkflowApplication.Id%2A> of the persisted workflow instance and the <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> that contains the persisted instance and returns a <xref:System.Activities.WorkflowApplicationInstance>."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplicationInstance&gt;</ph> contains information about a persisted workflow instance, including its associated <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph>.","pos":[7299,7479],"source":" A <xref:System.Activities.WorkflowApplicationInstance> contains information about a persisted workflow instance, including its associated <xref:System.Activities.WorkflowIdentity>."},{"content":"This associated <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> can be used by the host to supply the correct workflow definition when loading and resuming the workflow instance.","pos":[7480,7652],"source":" This associated <xref:System.Activities.WorkflowIdentity> can be used by the host to supply the correct workflow definition when loading and resuming the workflow instance."},{"pos":[7660,8366],"content":"[!NOTE]\n A null <xref:System.Activities.WorkflowIdentity> is valid, and can be used by the host to map instances that were persisted with no associated <xref:System.Activities.WorkflowIdentity> to the proper workflow definition. This scenario can occur when a workflow application was not initially written with workflow versioning, or when an application is upgraded from [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)]. [!INCLUDE[crdefault](../../../includes/crdefault-md.md)] [Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases).","leadings":["","> "],"nodes":[{"content":" A null <xref:System.Activities.WorkflowIdentity> is valid, and can be used by the host to map instances that were persisted with no associated <xref:System.Activities.WorkflowIdentity> to the proper workflow definition. This scenario can occur when a workflow application was not initially written with workflow versioning, or when an application is upgraded from [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)]. [!INCLUDE[crdefault](../../../includes/crdefault-md.md)] [Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases).","pos":[8,704],"nodes":[{"content":"A null <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> is valid, and can be used by the host to map instances that were persisted with no associated <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> to the proper workflow definition.","pos":[1,220],"source":" A null <xref:System.Activities.WorkflowIdentity> is valid, and can be used by the host to map instances that were persisted with no associated <xref:System.Activities.WorkflowIdentity> to the proper workflow definition."},{"content":"This scenario can occur when a workflow application was not initially written with workflow versioning, or when an application is upgraded from <ph id=\"ph1\">[!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)]</ph>.","pos":[221,430],"source":" This scenario can occur when a workflow application was not initially written with workflow versioning, or when an application is upgraded from [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)]."},{"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../includes/crdefault-md.md)]</ph> <bpt id=\"p1\">[</bpt>Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning<ept id=\"p1\">](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases)</ept>.","pos":[431,696],"source":"[!INCLUDE[crdefault](../../../includes/crdefault-md.md)] [Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning](../../../docs/framework/windows-workflow-foundation/using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases)."}]}]},{"pos":[8373,8716],"content":"In the following example a <ph id=\"ph1\">`Dictionary&lt;WorkflowIdentity, Activity&gt;`</ph> is used to associate <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> instances with their matching workflow definitions, and a workflow is started using the <ph id=\"ph3\">`MortgageWorkflow`</ph> workflow definition, which is associated with the <ph id=\"ph4\">`identityV1`</ph> <ph id=\"ph5\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph>.","source":"In the following example a `Dictionary<WorkflowIdentity, Activity>` is used to associate <xref:System.Activities.WorkflowIdentity> instances with their matching workflow definitions, and a workflow is started using the `MortgageWorkflow` workflow definition, which is associated with the `identityV1` <xref:System.Activities.WorkflowIdentity>."},{"content":"In the following example, information about the persisted workflow instance from the previous example is retrieved by calling <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.GetInstance%2A&gt;</ph>, and the persisted <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowIdentity&gt;</ph> information is used to retrieve the matching workflow definition.","pos":[9531,9843],"source":"In the following example, information about the persisted workflow instance from the previous example is retrieved by calling <xref:System.Activities.WorkflowApplication.GetInstance%2A>, and the persisted <xref:System.Activities.WorkflowIdentity> information is used to retrieve the matching workflow definition."},{"content":"This information is used to configure the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph>, and then the workflow is loaded.","pos":[9844,9964],"source":" This information is used to configure the <xref:System.Activities.WorkflowApplication>, and then the workflow is loaded."},{"content":"Note that because the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.Load%2A&gt;</ph> overload that takes the <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplicationInstance&gt;</ph> is used, the <ph id=\"ph3\">&lt;xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore&gt;</ph> that was configured on the <ph id=\"ph4\">&lt;xref:System.Activities.WorkflowApplicationInstance&gt;</ph> is used by the <ph id=\"ph5\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> and therefore its <ph id=\"ph6\">&lt;xref:System.Activities.WorkflowApplication.InstanceStore%2A&gt;</ph> property does not need to be configured.","pos":[9965,10458],"source":" Note that because the <xref:System.Activities.WorkflowApplication.Load%2A> overload that takes the <xref:System.Activities.WorkflowApplicationInstance> is used, the <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> that was configured on the <xref:System.Activities.WorkflowApplicationInstance> is used by the <xref:System.Activities.WorkflowApplication> and therefore its <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property does not need to be configured."},{"pos":[10466,10911],"content":"[!NOTE]\n If the <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property is set, it must be set with the same <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> instance used by the <xref:System.Activities.WorkflowApplicationInstance> or else an <xref:System.ArgumentException> will be thrown with the following message: `The instance is configured with a different InstanceStore than this WorkflowApplication.`.","leadings":["","> "],"nodes":[{"content":"If the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.InstanceStore%2A&gt;</ph> property is set, it must be set with the same <ph id=\"ph2\">&lt;xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore&gt;</ph> instance used by the <ph id=\"ph3\">&lt;xref:System.Activities.WorkflowApplicationInstance&gt;</ph> or else an <ph id=\"ph4\">&lt;xref:System.ArgumentException&gt;</ph> will be thrown with the following message: <ph id=\"ph5\">`The instance is configured with a different InstanceStore than this WorkflowApplication.`</ph>.","pos":[9,443],"source":" If the <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property is set, it must be set with the same <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> instance used by the <xref:System.Activities.WorkflowApplicationInstance> or else an <xref:System.ArgumentException> will be thrown with the following message: `The instance is configured with a different InstanceStore than this WorkflowApplication.`."}]},{"pos":[11671,11797],"content":"<bpt id=\"p1\">&lt;a name=\"UpdatingWF4PersistenceDatabases\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning","linkify":"<a name=\"UpdatingWF4PersistenceDatabases\"></a> Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning","source":"<a name=\"UpdatingWF4PersistenceDatabases\"></a> Upgrading .NET Framework 4 Persistence Databases to Support Workflow Versioning"},{"content":"A SqlWorkflowInstanceStoreSchemaUpgrade.sql database script is provided to upgrade persistence databases created using the <ph id=\"ph1\">[!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)]</ph> database scripts.","pos":[11801,12006],"source":"A SqlWorkflowInstanceStoreSchemaUpgrade.sql database script is provided to upgrade persistence databases created using the [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)] database scripts."},{"content":"This script updates the databases to support the new versioning capabilities introduced in <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph>.","pos":[12007,12151],"source":" This script updates the databases to support the new versioning capabilities introduced in [!INCLUDE[net_v45](../../../includes/net-v45-md.md)]."},{"content":"Any persisted workflow instances in the databases are given default versioning values, and can then participate in side-by-side execution and dynamic update.","pos":[12152,12309]},{"pos":[12316,12686],"content":"If a <ph id=\"ph1\">[!INCLUDE[net_v45](../../../includes/net-v45-md.md)]</ph> workflow application attempts any persistence operations that use the new versioning features on a persistence database which has not been upgraded using the provided script, an <ph id=\"ph2\">&lt;xref:System.Runtime.DurableInstancing.InstancePersistenceCommandException&gt;</ph> is thrown with a message similar to the following message.","source":"If a [!INCLUDE[net_v45](../../../includes/net-v45-md.md)] workflow application attempts any persistence operations that use the new versioning features on a persistence database which has not been upgraded using the provided script, an <xref:System.Runtime.DurableInstancing.InstancePersistenceCommandException> is thrown with a message similar to the following message."},{"pos":[12693,12954],"content":"<bpt id=\"p1\">**</bpt>The SqlWorkflowInstanceStore has a database version of '4.0.0.0'. InstancePersistenceCommand 'System.Activities.DurableInstancing.CreateWorkflowOwnerWithIdentityCommand' cannot be run against this database version.  Please upgrade the database to '4.5.0.0'.<ept id=\"p1\">**</ept>","source":"**The SqlWorkflowInstanceStore has a database version of '4.0.0.0'. InstancePersistenceCommand 'System.Activities.DurableInstancing.CreateWorkflowOwnerWithIdentityCommand' cannot be run against this database version.  Please upgrade the database to '4.5.0.0'.**"},{"pos":[12963,13018],"content":"<bpt id=\"p1\">&lt;a name=\"ToUpgrade\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> To upgrade the database schema","linkify":"<a name=\"ToUpgrade\"></a> To upgrade the database schema","source":"<a name=\"ToUpgrade\"></a> To upgrade the database schema"},{"pos":[13028,13139],"content":"Open SQL Server Management Studio and connect to the persistence database server, for example <bpt id=\"p1\">**</bpt>.\\SQLEXPRESS<ept id=\"p1\">**</ept>.","source":"Open SQL Server Management Studio and connect to the persistence database server, for example **.\\SQLEXPRESS**."},{"content":"Choose <bpt id=\"p1\">**</bpt>Open<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>File<ept id=\"p2\">**</ept> from the <bpt id=\"p3\">**</bpt>File<ept id=\"p3\">**</ept> menu.","pos":[13149,13198],"source":"Choose **Open**, **File** from the **File** menu."},{"content":"Browse to the following folder: <ph id=\"ph1\">`C:\\Windows\\Microsoft.NET\\Framework\\4.0.30319\\sql\\en`</ph>","pos":[13199,13284],"source":" Browse to the following folder: `C:\\Windows\\Microsoft.NET\\Framework\\4.0.30319\\sql\\en`"},{"pos":[13294,13366],"content":"Select <bpt id=\"p1\">**</bpt>SqlWorkflowInstanceStoreSchemaUpgrade.sql<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept>.","source":"Select **SqlWorkflowInstanceStoreSchemaUpgrade.sql** and click **Open**."},{"pos":[13376,13461],"content":"Select the name of the persistence database in the <bpt id=\"p1\">**</bpt>Available Databases<ept id=\"p1\">**</ept> drop-down.","source":"Select the name of the persistence database in the **Available Databases** drop-down."},{"pos":[13471,13514],"content":"Choose <bpt id=\"p1\">**</bpt>Execute<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>Query<ept id=\"p2\">**</ept> menu.","source":"Choose **Execute** from the **Query** menu."},{"content":"When the query completes, the database schema is upgraded, and if desired, you can view the default workflow identity that was assigned to the persisted workflow instances.","pos":[13521,13693]},{"content":"Expand your persistence database in the <bpt id=\"p1\">**</bpt>Databases<ept id=\"p1\">**</ept> node of the <bpt id=\"p2\">**</bpt>Object Explorer<ept id=\"p2\">**</ept>, and then expand the <bpt id=\"p3\">**</bpt>Views<ept id=\"p3\">**</ept> node.","pos":[13694,13816],"source":" Expand your persistence database in the **Databases** node of the **Object Explorer**, and then expand the **Views** node."},{"content":"Right-click <bpt id=\"p1\">**</bpt>System.Activities.DurableInstancing.Instances<ept id=\"p1\">**</ept> and choose <bpt id=\"p2\">**</bpt>Select Top 1000 Rows<ept id=\"p2\">**</ept>.","pos":[13817,13915],"source":" Right-click **System.Activities.DurableInstancing.Instances** and choose **Select Top 1000 Rows**."},{"content":"Scroll to end of the columns and note that there are six additional columns added to the view: <bpt id=\"p1\">**</bpt>IdentityName<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>IdentityPackage<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Build<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>Major<ept id=\"p4\">**</ept>, <bpt id=\"p5\">**</bpt>Minor<ept id=\"p5\">**</ept>, and <bpt id=\"p6\">**</bpt>Revision<ept id=\"p6\">**</ept>.","pos":[13916,14100],"source":" Scroll to end of the columns and note that there are six additional columns added to the view: **IdentityName**, **IdentityPackage**, **Build**, **Major**, **Minor**, and **Revision**."},{"content":"Any persisted workflows will have a value of <bpt id=\"p1\">**</bpt>NULL<ept id=\"p1\">**</ept> for these fields, representing a null workflow identity.","pos":[14101,14211],"source":" Any persisted workflows will have a value of **NULL** for these fields, representing a null workflow identity."}]}