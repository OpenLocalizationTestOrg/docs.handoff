{"content":"---\ntitle: \"Best Practices for Security in WCF | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"best practices [WCF], security\"\nms.assetid: 3639de41-1fa7-4875-a1d7-f393e4c8bd69\ncaps.latest.revision: 19\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"\n---\n# Best Practices for Security in WCF\nThe following sections list the best practices to consider when creating secure applications using [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] security, see [Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md), [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md), and [Security Considerations with Metadata](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md).  \n  \n## Identify Services Performing Windows Authentication with SPNs  \n Services can be identified with either user principal names (UPNs) or service principal names (SPNs). Services running under machine accounts such as network service have an SPN identity corresponding to the machine they're running. Services running under user accounts have a UPN identity corresponding to the user they're running as, although the `setspn` tool can be used to assign an SPN to the user account. Configuring a service so it can be identified via SPN and configuring the clients connecting to the service to use that SPN can make certain attacks more difficult. This guidance applies to bindings using Kerberos or SSPI negotiation.  Clients should still specify an SPN in the case where SSPI falls back to NTLM.  \n  \n## Verify Service Identities in WSDL  \n WS-SecurityPolicy allows services to publish information about their own identities in metadata. When retrieved via `svcutil` or other methods such as <xref:System.ServiceModel.Description.WsdlImporter>, this identity information is translated to the identity properties of the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service endpoint addresses. Clients which do not verify that these service identities are correct and valid effectively bypass service authentication. A malicious service can exploit such clients to execute credential forwarding and other \"man in the middle\" attacks by changing the identity claimed in its WSDL.  \n  \n## Use X509 Certificates Instead of NTLM  \n [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM.  Certificate-based authentication using key sizes of 1024 bits or more is preferred to NTLM for several reasons:  \n  \n-   the availability of mutual authentication,  \n  \n-   the use of stronger cryptographic algorithms, and  \n  \n-   the greater difficulty of utilizing forwarded X509 credentials.  \n  \n For an overview of NTLM forwarding attacks, go to [http://msdn.microsoft.com/msdnmag/issues/06/09/SecureByDesign/default.aspx](http://go.microsoft.com/fwlink/?LinkId=109571).  \n  \n## Always Revert After Impersonation  \n When using APIs that enable impersonation of a client, be sure to revert to the original identity. For example, when using the <xref:System.Security.Principal.WindowsIdentity> and <xref:System.Security.Principal.WindowsImpersonationContext>, use the C# `using` statement or the [!INCLUDE[vbprvb](../../../../includes/vbprvb-md.md)]`Using` statement, as shown in the following code. The <xref:System.Security.Principal.WindowsImpersonationContext> class implements the <xref:System.IDisposable> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the `using` block.  \n  \n [!code-csharp[c_SecurityBestPractices#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_securitybestpractices/cs/source.cs#1)]\n [!code-vb[c_SecurityBestPractices#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_securitybestpractices/vb/source.vb#1)]  \n  \n## Impersonate Only as Needed  \n Using the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method of the <xref:System.Security.Principal.WindowsIdentity> class, it is possible to use impersonation in a very controlled scope. This is in contrast to using the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute>, which allows impersonation for the scope of the entire operation. Whenever possible, control the scope of impersonation by using the more precise <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method.  \n  \n## Obtain Metadata from Trusted Sources  \n Be sure you trust the source of your metadata and make sure that no one has tampered with the metadata. Metadata retrieved using the HTTP protocol is sent in clear text and can be tampered with. If the service uses the <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> and <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol.  \n  \n## Publish Metadata Using Security  \n To prevent tampering with a service's published metadata, secure the metadata exchange endpoint with transport or message-level security. [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Publishing Metadata Endpoints](../../../../docs/framework/wcf/publishing-metadata-endpoints.md) and [How to: Publish Metadata for a Service Using Code](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md).  \n  \n## Ensure Use of Local Issuer  \n If an issuer address and binding are specified for a given binding, the local issuer is not used for endpoints that use that binding. Clients who expect to always use the local issuer should ensure that they do not use such a binding or that they modify the binding such that the issuer address is null.  \n  \n## SAML Token Size Quotas  \n When Security Assertions Markup Language (SAML) tokens are serialized in messages, either when they are issued by a Security Token Service (STS) or when clients present them to services as part of authentication, the maximum message size quota must be sufficiently large to accommodate the SAML token and the other message parts. In normal cases, the default message size quotas are sufficient. However, in cases where a SAML token is large because it contains hundreds of claims, the quotas should be increased to accommodate the serialized token. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] quotas, see [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md).  \n  \n## Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings  \n When you create a custom binding, you must set <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> to `true`. Otherwise, if <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> is set to `false`, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed.  \n  \n## See Also  \n [Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)   \n [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)   \n [Security Considerations with Metadata](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)","nodes":[{"pos":[4,425],"embed":true,"restype":"x-metadata","content":"title: \"Best Practices for Security in WCF | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"best practices [WCF], security\"\nms.assetid: 3639de41-1fa7-4875-a1d7-f393e4c8bd69\ncaps.latest.revision: 19\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"","nodes":[{"content":"Best Practices for Security in WCF | Microsoft Docs","nodes":[{"pos":[0,51],"content":"Best Practices for Security in WCF | Microsoft Docs","nodes":[{"content":"Best Practices for Security in WCF | Microsoft Docs","pos":[0,51]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[432,466],"content":"Best Practices for Security in WCF","linkify":"Best Practices for Security in WCF","nodes":[{"content":"Best Practices for Security in WCF","pos":[0,34]}]},{"content":"The following sections list the best practices to consider when creating secure applications using <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph>.","pos":[467,622],"source":"The following sections list the best practices to consider when creating secure applications using [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]."},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> security, see <bpt id=\"p1\">[</bpt>Security Considerations<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)</ept>, <bpt id=\"p2\">[</bpt>Security Considerations for Data<ept id=\"p2\">](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)</ept>, and <bpt id=\"p3\">[</bpt>Security Considerations with Metadata<ept id=\"p3\">](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)</ept>.","pos":[623,1055],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] security, see [Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md), [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md), and [Security Considerations with Metadata](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)."},{"pos":[1064,1125],"content":"Identify Services Performing Windows Authentication with SPNs","linkify":"Identify Services Performing Windows Authentication with SPNs","nodes":[{"content":"Identify Services Performing Windows Authentication with SPNs","pos":[0,61]}]},{"content":"Services can be identified with either user principal names (UPNs) or service principal names (SPNs).","pos":[1129,1230]},{"content":"Services running under machine accounts such as network service have an SPN identity corresponding to the machine they're running.","pos":[1231,1361]},{"content":"Services running under user accounts have a UPN identity corresponding to the user they're running as, although the <ph id=\"ph1\">`setspn`</ph> tool can be used to assign an SPN to the user account.","pos":[1362,1541],"source":" Services running under user accounts have a UPN identity corresponding to the user they're running as, although the `setspn` tool can be used to assign an SPN to the user account."},{"content":"Configuring a service so it can be identified via SPN and configuring the clients connecting to the service to use that SPN can make certain attacks more difficult.","pos":[1542,1706]},{"content":"This guidance applies to bindings using Kerberos or SSPI negotiation.","pos":[1707,1776]},{"content":"Clients should still specify an SPN in the case where SSPI falls back to NTLM.","pos":[1778,1856]},{"pos":[1865,1898],"content":"Verify Service Identities in WSDL","linkify":"Verify Service Identities in WSDL","nodes":[{"content":"Verify Service Identities in WSDL","pos":[0,33]}]},{"content":"WS-SecurityPolicy allows services to publish information about their own identities in metadata.","pos":[1902,1998]},{"content":"When retrieved via <ph id=\"ph1\">`svcutil`</ph> or other methods such as <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.WsdlImporter&gt;</ph>, this identity information is translated to the identity properties of the <ph id=\"ph3\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> service endpoint addresses.","pos":[1999,2263],"source":" When retrieved via `svcutil` or other methods such as <xref:System.ServiceModel.Description.WsdlImporter>, this identity information is translated to the identity properties of the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service endpoint addresses."},{"content":"Clients which do not verify that these service identities are correct and valid effectively bypass service authentication.","pos":[2264,2386]},{"content":"A malicious service can exploit such clients to execute credential forwarding and other \"man in the middle\" attacks by changing the identity claimed in its WSDL.","pos":[2387,2548]},{"pos":[2557,2594],"content":"Use X509 Certificates Instead of NTLM","linkify":"Use X509 Certificates Instead of NTLM","nodes":[{"content":"Use X509 Certificates Instead of NTLM","pos":[0,37]}]},{"content":"<ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM.","pos":[2598,2836],"source":"[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM."},{"content":"Certificate-based authentication using key sizes of 1024 bits or more is preferred to NTLM for several reasons:","pos":[2838,2949]},{"content":"the availability of mutual authentication,","pos":[2959,3001]},{"content":"the use of stronger cryptographic algorithms, and","pos":[3011,3060]},{"content":"the greater difficulty of utilizing forwarded X509 credentials.","pos":[3070,3133]},{"pos":[3140,3314],"content":"For an overview of NTLM forwarding attacks, go to <bpt id=\"p1\">[</bpt>http://msdn.microsoft.com/msdnmag/issues/06/09/SecureByDesign/default.aspx<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=109571)</ept>.","source":"For an overview of NTLM forwarding attacks, go to [http://msdn.microsoft.com/msdnmag/issues/06/09/SecureByDesign/default.aspx](http://go.microsoft.com/fwlink/?LinkId=109571)."},{"pos":[3323,3356],"content":"Always Revert After Impersonation","linkify":"Always Revert After Impersonation","nodes":[{"content":"Always Revert After Impersonation","pos":[0,33]}]},{"content":"When using APIs that enable impersonation of a client, be sure to revert to the original identity.","pos":[3360,3458]},{"content":"For example, when using the <ph id=\"ph1\">&lt;xref:System.Security.Principal.WindowsIdentity&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Security.Principal.WindowsImpersonationContext&gt;</ph>, use the C# <ph id=\"ph3\">`using`</ph> statement or the <ph id=\"ph4\">[!INCLUDE[vbprvb](../../../../includes/vbprvb-md.md)]</ph><ph id=\"ph5\">`Using`</ph> statement, as shown in the following code.","pos":[3459,3741],"source":" For example, when using the <xref:System.Security.Principal.WindowsIdentity> and <xref:System.Security.Principal.WindowsImpersonationContext>, use the C# `using` statement or the [!INCLUDE[vbprvb](../../../../includes/vbprvb-md.md)]`Using` statement, as shown in the following code."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Security.Principal.WindowsImpersonationContext&gt;</ph> class implements the <ph id=\"ph2\">&lt;xref:System.IDisposable&gt;</ph> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the <ph id=\"ph3\">`using`</ph> block.","pos":[3742,3999],"source":" The <xref:System.Security.Principal.WindowsImpersonationContext> class implements the <xref:System.IDisposable> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the `using` block."},{"pos":[4284,4310],"content":"Impersonate Only as Needed","linkify":"Impersonate Only as Needed","nodes":[{"content":"Impersonate Only as Needed","pos":[0,26]}]},{"content":"Using the <ph id=\"ph1\">&lt;xref:System.Security.Principal.WindowsIdentity.Impersonate%2A&gt;</ph> method of the <ph id=\"ph2\">&lt;xref:System.Security.Principal.WindowsIdentity&gt;</ph> class, it is possible to use impersonation in a very controlled scope.","pos":[4314,4521],"source":"Using the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method of the <xref:System.Security.Principal.WindowsIdentity> class, it is possible to use impersonation in a very controlled scope."},{"content":"This is in contrast to using the <ph id=\"ph1\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute&gt;</ph>, which allows impersonation for the scope of the entire operation.","pos":[4522,4762],"source":" This is in contrast to using the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute>, which allows impersonation for the scope of the entire operation."},{"content":"Whenever possible, control the scope of impersonation by using the more precise <ph id=\"ph1\">&lt;xref:System.Security.Principal.WindowsIdentity.Impersonate%2A&gt;</ph> method.","pos":[4763,4914],"source":" Whenever possible, control the scope of impersonation by using the more precise <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method."},{"pos":[4923,4959],"content":"Obtain Metadata from Trusted Sources","linkify":"Obtain Metadata from Trusted Sources","nodes":[{"content":"Obtain Metadata from Trusted Sources","pos":[0,36]}]},{"content":"Be sure you trust the source of your metadata and make sure that no one has tampered with the metadata.","pos":[4963,5066]},{"content":"Metadata retrieved using the HTTP protocol is sent in clear text and can be tampered with.","pos":[5067,5157]},{"content":"If the service uses the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A&gt;</ph> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol.","pos":[5158,5448],"source":" If the service uses the <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> and <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol."},{"pos":[5457,5488],"content":"Publish Metadata Using Security","linkify":"Publish Metadata Using Security","nodes":[{"content":"Publish Metadata Using Security","pos":[0,31]}]},{"content":"To prevent tampering with a service's published metadata, secure the metadata exchange endpoint with transport or message-level security.","pos":[5492,5629]},{"content":"<ph id=\"ph1\">[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)]</ph><bpt id=\"p1\">[</bpt>Publishing Metadata Endpoints<ept id=\"p1\">](../../../../docs/framework/wcf/publishing-metadata-endpoints.md)</ept> and <bpt id=\"p2\">[</bpt>How to: Publish Metadata for a Service Using Code<ept id=\"p2\">](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md)</ept>.","pos":[5630,5942],"source":"[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Publishing Metadata Endpoints](../../../../docs/framework/wcf/publishing-metadata-endpoints.md) and [How to: Publish Metadata for a Service Using Code](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md)."},{"pos":[5951,5977],"content":"Ensure Use of Local Issuer","linkify":"Ensure Use of Local Issuer","nodes":[{"content":"Ensure Use of Local Issuer","pos":[0,26]}]},{"content":"If an issuer address and binding are specified for a given binding, the local issuer is not used for endpoints that use that binding.","pos":[5981,6114]},{"content":"Clients who expect to always use the local issuer should ensure that they do not use such a binding or that they modify the binding such that the issuer address is null.","pos":[6115,6284]},{"pos":[6293,6315],"content":"SAML Token Size Quotas","linkify":"SAML Token Size Quotas","nodes":[{"content":"SAML Token Size Quotas","pos":[0,22]}]},{"content":"When Security Assertions Markup Language (SAML) tokens are serialized in messages, either when they are issued by a Security Token Service (STS) or when clients present them to services as part of authentication, the maximum message size quota must be sufficiently large to accommodate the SAML token and the other message parts.","pos":[6319,6648]},{"content":"In normal cases, the default message size quotas are sufficient.","pos":[6649,6713]},{"content":"However, in cases where a SAML token is large because it contains hundreds of claims, the quotas should be increased to accommodate the serialized token.","pos":[6714,6867]},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> quotas, see <bpt id=\"p1\">[</bpt>Security Considerations for Data<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)</ept>.","pos":[6868,7055],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] quotas, see [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)."},{"pos":[7064,7134],"content":"Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings","linkify":"Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings","nodes":[{"content":"Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings","pos":[0,70]}]},{"content":"When you create a custom binding, you must set <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A&gt;</ph> to <ph id=\"ph2\">`true`</ph>.","pos":[7138,7274],"source":"When you create a custom binding, you must set <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> to `true`."},{"content":"Otherwise, if <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A&gt;</ph> is set to <ph id=\"ph2\">`false`</ph>, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed.","pos":[7275,7501],"source":" Otherwise, if <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> is set to `false`, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed."},{"pos":[7510,7518],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Security Considerations<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)</ept><ph id=\"ph1\"> </ph>","pos":[7522,7630],"source":"[Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md) "},{"content":"<bpt id=\"p1\">[</bpt>Security Considerations for Data<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)</ept><ph id=\"ph1\"> </ph>","pos":[7634,7753],"source":"[Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md) "},{"content":"<bpt id=\"p1\">[</bpt>Security Considerations with Metadata<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)</ept>","pos":[7757,7885],"source":"[Security Considerations with Metadata](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)"}]}