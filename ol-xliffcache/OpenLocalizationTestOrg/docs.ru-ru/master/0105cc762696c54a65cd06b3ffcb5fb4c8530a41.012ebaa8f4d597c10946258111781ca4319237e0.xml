{"content":"---\ntitle: \"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1\"\nms.date: \"03/30/2017\"\nms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a\n---\n# Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1\nSecurity changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace. These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used. This change can impact web servers and client applications that are configured to use integrated Windows authentication.  \n  \n## Overview  \n The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded. If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information. Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN). With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.  \n  \n Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application. This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.  \n  \n## Changes  \n The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer. When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).  \n  \n When accessing a service running on an internal Web server, it is common to access the service using a URL similar to `http://contoso/service` or `https://contoso/service`. The name \"contoso\" is often not the computer name of the computer on which the service is deployed. The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\\system32\\drivers\\etc\\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\\system32\\drivers\\etc\\lmhosts, for example) to resolve names to addresses. The name \"contoso\" is resolved so that requests sent to \"contoso\" are sent to the appropriate server computer.  \n  \n When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users. For example, you might call the server `www.contoso.com`, but on an internal network simply use \"contoso\". This name is called the Host header in the client web request. As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested. This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL). On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property.  \n  \n The <xref:System.Net.AuthenticationManager> class controls the managed authentication components (\"modules\") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class. The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.  \n  \n Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set. The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request. The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address. In these cases, Windows will fail the authentication request. To address the issue, we need to notify Windows that the host name used in the request URL in the client request (\"contoso\", for example) is actually an alternate name for the local computer.  \n  \n There are several possible methods for a server application to work around this change. The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server. The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address. The steps are listed below.  \n  \n To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:  \n  \n 1. Click Start, click Run, type regedit, and then click OK.  \n  \n 2. In Registry Editor, locate and then click the following registry key:  \n  \n `HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0`  \n  \n 3. Right-click MSV1_0, point to New, and then click Multi-String Value.  \n  \n 4. Type `BackConnectionHostNames`, and then press ENTER.  \n  \n 5. Right-click `BackConnectionHostNames`, and then click Modify.  \n  \n 6. In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.  \n  \n 7. Quit Registry Editor, and then restart the IISAdmin service and run IISReset.  \n  \n A less secure work around is to disable the loop back check, as described in <https://support.microsoft.com/kb/896861>. This disables the protection against reflection attacks. So it is better to constrain the set of alternate names to only those you expect the machine to actually use.  \n  \n## See also\n\n- <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>\n- <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>\n- <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>\n","nodes":[{"pos":[4,152],"embed":true,"restype":"x-metadata","content":"title: \"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1\"\nms.date: \"03/30/2017\"\nms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a","nodes":[{"content":"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1","nodes":[{"pos":[0,68],"content":"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1","nodes":[{"content":"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1","pos":[0,68]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[159,227],"content":"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1","linkify":"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1","nodes":[{"content":"Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1","pos":[0,68]}]},{"content":"Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <ph id=\"ph1\">&lt;xref:System.Net.HttpWebRequest&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.Net.HttpListener&gt;</ph>, <ph id=\"ph3\">&lt;xref:System.Net.Security.NegotiateStream&gt;</ph>, and related classes in the System.Net namespace.","pos":[228,525],"source":"Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace."},{"content":"These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used.","pos":[526,692]},{"content":"This change can impact web servers and client applications that are configured to use integrated Windows authentication.","pos":[693,813]},{"pos":[822,830],"content":"Overview","linkify":"Overview","nodes":[{"content":"Overview","pos":[0,8]}]},{"content":"The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded.","pos":[834,977]},{"content":"If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information.","pos":[978,1142]},{"content":"Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN).","pos":[1143,1301]},{"content":"With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.","pos":[1302,1476]},{"content":"Multiple components in the <ph id=\"ph1\">&lt;xref:System.Net&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Net.Security&gt;</ph> namespaces perform integrated Windows authentication on behalf of a calling application.","pos":[1483,1647],"source":"Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application."},{"content":"This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.","pos":[1648,1781]},{"pos":[1790,1797],"content":"Changes","linkify":"Changes","nodes":[{"content":"Changes","pos":[0,7]}]},{"content":"The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer.","pos":[1801,1970]},{"content":"When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).","pos":[1971,2144]},{"content":"When accessing a service running on an internal Web server, it is common to access the service using a URL similar to <ph id=\"ph1\">`http://contoso/service`</ph> or <ph id=\"ph2\">`https://contoso/service`</ph>.","pos":[2151,2323],"source":"When accessing a service running on an internal Web server, it is common to access the service using a URL similar to `http://contoso/service` or `https://contoso/service`."},{"content":"The name \"contoso\" is often not the computer name of the computer on which the service is deployed.","pos":[2324,2423]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net&gt;</ph> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\\system32\\drivers\\etc\\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\\system32\\drivers\\etc\\lmhosts, for example) to resolve names to addresses.","pos":[2424,2737],"source":" The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\\system32\\drivers\\etc\\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\\system32\\drivers\\etc\\lmhosts, for example) to resolve names to addresses."},{"content":"The name \"contoso\" is resolved so that requests sent to \"contoso\" are sent to the appropriate server computer.","pos":[2738,2848]},{"content":"When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users.","pos":[2855,3057]},{"content":"For example, you might call the server <ph id=\"ph1\">`www.contoso.com`</ph>, but on an internal network simply use \"contoso\".","pos":[3058,3164],"source":" For example, you might call the server `www.contoso.com`, but on an internal network simply use \"contoso\"."},{"content":"This name is called the Host header in the client web request.","pos":[3165,3227]},{"content":"As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested.","pos":[3228,3369]},{"content":"This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL).","pos":[3370,3485]},{"content":"On .NET Framework version 4, this information can also be set by the client using the new <ph id=\"ph1\">&lt;xref:System.Net.HttpWebRequest.Host%2A&gt;</ph> property.","pos":[3486,3626],"source":" On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net.AuthenticationManager&gt;</ph> class controls the managed authentication components (\"modules\") that are used by <ph id=\"ph2\">&lt;xref:System.Net.WebRequest&gt;</ph> derivative classes and the <ph id=\"ph3\">&lt;xref:System.Net.WebClient&gt;</ph> class.","pos":[3633,3849],"source":"The <xref:System.Net.AuthenticationManager> class controls the managed authentication components (\"modules\") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Net.AuthenticationManager&gt;</ph> class provides a property that exposes a <ph id=\"ph2\">&lt;xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType&gt;</ph> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.","pos":[3850,4145],"source":" The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication."},{"content":"Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <ph id=\"ph1\">&lt;xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A&gt;</ph> property is not set.","pos":[4152,4396],"source":"Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set."},{"content":"The host name used in the request URL may be different from the Host header specified in the <ph id=\"ph1\">&lt;xref:System.Net.HttpRequestHeader?displayProperty=nameWithType&gt;</ph> in the client request.","pos":[4397,4577],"source":" The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request."},{"content":"The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address.","pos":[4578,4757]},{"content":"In these cases, Windows will fail the authentication request.","pos":[4758,4819]},{"content":"To address the issue, we need to notify Windows that the host name used in the request URL in the client request (\"contoso\", for example) is actually an alternate name for the local computer.","pos":[4820,5011]},{"content":"There are several possible methods for a server application to work around this change.","pos":[5018,5105]},{"content":"The recommended approach is to map the host name used in the request URL to the <ph id=\"ph1\">`BackConnectionHostNames`</ph> key in the registry on the server.","pos":[5106,5246],"source":" The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server."},{"content":"The <ph id=\"ph1\">`BackConnectionHostNames`</ph> registry key is normally used to map a host name to a loopback address.","pos":[5247,5348],"source":" The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address."},{"content":"The steps are listed below.","pos":[5349,5376]},{"content":"To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:","pos":[5383,5518]},{"content":"Click Start, click Run, type regedit, and then click OK.","pos":[5528,5584]},{"content":"In Registry Editor, locate and then click the following registry key:","pos":[5594,5663]},{"content":"Right-click MSV1_0, point to New, and then click Multi-String Value.","pos":[5744,5812]},{"pos":[5822,5875],"content":"Type <ph id=\"ph1\">`BackConnectionHostNames`</ph>, and then press ENTER.","source":"Type `BackConnectionHostNames`, and then press ENTER."},{"pos":[5885,5946],"content":"Right-click <ph id=\"ph1\">`BackConnectionHostNames`</ph>, and then click Modify.","source":"Right-click `BackConnectionHostNames`, and then click Modify."},{"content":"In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.","pos":[5956,6120]},{"content":"Quit Registry Editor, and then restart the IISAdmin service and run IISReset.","pos":[6130,6207]},{"content":"A less secure work around is to disable the loop back check, as described in <ph id=\"ph1\">&lt;https://support.microsoft.com/kb/896861&gt;</ph>.","pos":[6214,6333],"source":"A less secure work around is to disable the loop back check, as described in <https://support.microsoft.com/kb/896861>."},{"content":"This disables the protection against reflection attacks.","pos":[6334,6390]},{"content":"So it is better to constrain the set of alternate names to only those you expect the machine to actually use.","pos":[6391,6500]},{"pos":[6509,6517],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]}]}