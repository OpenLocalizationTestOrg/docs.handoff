{"content":"---\ntitle: \"Custom Find Criteria\"\nms.date: \"03/30/2017\"\nms.assetid: b2723929-8829-424d-8015-a37ba2ab4f68\n---\n# Custom Find Criteria\nThis sample demonstrates how to create a custom scope match using logic and how to implement a custom discovery service. Clients use custom scope matching functionality to refine and further build on top of the system-provided find functionality of WCF Discovery. The scenario this sample covers is as follows:  \n  \n1.  A client is looking for a calculator service.  \n  \n2.  To refine its search, the client must use a custom scope matching rule.  \n  \n3.  According to this rule, a service responds back to the client if its endpoint matches any of the scopes specified by the client.  \n  \n## Demonstrates  \n  \n-   Creating a custom discovery service.  \n  \n-   Implementing a custom scope match by algorithm.  \n  \n## Discussion  \n The client is looking for \"OR\" type matching criteria. A service responds back if the scopes on its endpoints match any of the scopes provided by the client. In this case, the client is looking for a calculator service that has any of the scopes in the following list:  \n  \n1.  `net.tcp://Microsoft.Samples.Discovery/RedmondLocation`  \n  \n2.  `net.tcp://Microsoft.Samples.Discovery/SeattleLocation`  \n  \n3.  `net.tcp://Microsoft.Samples.Discovery/PortlandLocation`  \n  \n To accomplish this, the client directs services to use a custom scope matching rule by passing in a custom scope match by URI. To facilitate the custom scope matching, the service must use a custom discovery service that understands the custom scope match rule and implements the associated matching logic.  \n  \n In the client project, open the Program.cs file. Note that the `ScopeMatchBy` field of the `FindCriteria` object is set to a specific URI. This identifier is sent to the service. If the service does not understand this rule, it ignores the client’s find request.  \n  \n Open the service project. Three files are used to implement the Custom Discovery Service:  \n  \n1.  **AsyncResult.cs**: This is the implementation of the `AsyncResult` that is required by Discovery methods.  \n  \n2.  **CustomDiscoveryService.cs**: This file implements the custom discovery service. The implementation extends the <xref:System.ServiceModel.Discovery.DiscoveryService> class and overrides the necessary methods. Note the implementation of the <xref:System.ServiceModel.Discovery.DiscoveryService.OnBeginFind%2A> method. The method checks to see whether the custom scope match by rule was specified by the client. This is the same custom URI that the client specified previously. If the custom rule is specified, the code path that implements the \"OR\" match logic is followed.  \n  \n     This custom logic goes through all of the scopes on each of the endpoints that the service has. If any of the endpoint's scopes match any of the scopes provided by the client, the discovery service adds that endpoint to the response that is sent back to the client.  \n  \n3.  **CustomDiscoveryExtension.cs**: The last step in implementing the discovery service is to connect this implementation of the custom discover service to the service host. The helper class used here is the `CustomDiscoveryExtension` class. This class extends the <xref:System.ServiceModel.Discovery.DiscoveryServiceExtension> class. The user must override the <xref:System.ServiceModel.Discovery.DiscoveryServiceExtension.GetDiscoveryService%2A> method. In this case, the method returns an instance of the custom discovery service that was created before. `PublishedEndpoints` is a <xref:System.Collections.ObjectModel.ReadOnlyCollection%601> that contains all of the application endpoints that are added to the <xref:System.ServiceModel.ServiceHost>. The custom discovery service uses this to populate its internal list. A user can to add other endpoint metadata as well.  \n  \n Lastly, open Program.cs. Note that both the <xref:System.ServiceModel.Discovery.ServiceDiscoveryBehavior> and `CustomDiscoveryExtension` are added to the host. Once this is done and the host has an endpoint over which to receive discovery messages, the application can use the custom discovery service.  \n  \n Observe that the client is able to find the service without knowing its address.  \n  \n#### To set up, build, and run the sample  \n  \n1.  Open the solution that contains the project.  \n  \n2.  Build the project.  \n  \n3.  Run the service application.  \n  \n4.  Run the client application.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Discovery\\CustomFindCriteria`\n","nodes":[{"pos":[4,104],"embed":true,"restype":"x-metadata","content":"title: \"Custom Find Criteria\"\nms.date: \"03/30/2017\"\nms.assetid: b2723929-8829-424d-8015-a37ba2ab4f68","nodes":[{"content":"Custom Find Criteria","nodes":[{"pos":[0,20],"content":"Custom Find Criteria","nodes":[{"content":"Custom Find Criteria","pos":[0,20]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[111,131],"content":"Custom Find Criteria","linkify":"Custom Find Criteria","nodes":[{"content":"Custom Find Criteria","pos":[0,20]}]},{"content":"This sample demonstrates how to create a custom scope match using logic and how to implement a custom discovery service.","pos":[132,252]},{"content":"Clients use custom scope matching functionality to refine and further build on top of the system-provided find functionality of WCF Discovery.","pos":[253,395]},{"content":"The scenario this sample covers is as follows:","pos":[396,442]},{"content":"A client is looking for a calculator service.","pos":[452,497]},{"content":"To refine its search, the client must use a custom scope matching rule.","pos":[507,578]},{"content":"According to this rule, a service responds back to the client if its endpoint matches any of the scopes specified by the client.","pos":[588,716]},{"pos":[725,737],"content":"Demonstrates","linkify":"Demonstrates","nodes":[{"content":"Demonstrates","pos":[0,12]}]},{"content":"Creating a custom discovery service.","pos":[747,783]},{"content":"Implementing a custom scope match by algorithm.","pos":[793,840]},{"pos":[849,859],"content":"Discussion","linkify":"Discussion","nodes":[{"content":"Discussion","pos":[0,10]}]},{"content":"The client is looking for \"OR\" type matching criteria.","pos":[863,917]},{"content":"A service responds back if the scopes on its endpoints match any of the scopes provided by the client.","pos":[918,1020]},{"content":"In this case, the client is looking for a calculator service that has any of the scopes in the following list:","pos":[1021,1131]},{"content":"To accomplish this, the client directs services to use a custom scope matching rule by passing in a custom scope match by URI.","pos":[1334,1460]},{"content":"To facilitate the custom scope matching, the service must use a custom discovery service that understands the custom scope match rule and implements the associated matching logic.","pos":[1461,1640]},{"content":"In the client project, open the Program.cs file.","pos":[1647,1695]},{"content":"Note that the <ph id=\"ph1\">`ScopeMatchBy`</ph> field of the <ph id=\"ph2\">`FindCriteria`</ph> object is set to a specific URI.","pos":[1696,1785],"source":" Note that the `ScopeMatchBy` field of the `FindCriteria` object is set to a specific URI."},{"content":"This identifier is sent to the service.","pos":[1786,1825]},{"content":"If the service does not understand this rule, it ignores the client’s find request.","pos":[1826,1909]},{"content":"Open the service project.","pos":[1916,1941]},{"content":"Three files are used to implement the Custom Discovery Service:","pos":[1942,2005]},{"pos":[2015,2121],"content":"<bpt id=\"p1\">**</bpt>AsyncResult.cs<ept id=\"p1\">**</ept>: This is the implementation of the <ph id=\"ph1\">`AsyncResult`</ph> that is required by Discovery methods.","source":"**AsyncResult.cs**: This is the implementation of the `AsyncResult` that is required by Discovery methods."},{"content":"<bpt id=\"p1\">**</bpt>CustomDiscoveryService.cs<ept id=\"p1\">**</ept>: This file implements the custom discovery service.","pos":[2131,2212],"source":"**CustomDiscoveryService.cs**: This file implements the custom discovery service."},{"content":"The implementation extends the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.DiscoveryService&gt;</ph> class and overrides the necessary methods.","pos":[2213,2340],"source":" The implementation extends the <xref:System.ServiceModel.Discovery.DiscoveryService> class and overrides the necessary methods."},{"content":"Note the implementation of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.DiscoveryService.OnBeginFind%2A&gt;</ph> method.","pos":[2341,2448],"source":" Note the implementation of the <xref:System.ServiceModel.Discovery.DiscoveryService.OnBeginFind%2A> method."},{"content":"The method checks to see whether the custom scope match by rule was specified by the client.","pos":[2449,2541]},{"content":"This is the same custom URI that the client specified previously.","pos":[2542,2607]},{"content":"If the custom rule is specified, the code path that implements the \"OR\" match logic is followed.","pos":[2608,2704]},{"content":"This custom logic goes through all of the scopes on each of the endpoints that the service has.","pos":[2715,2810]},{"content":"If any of the endpoint's scopes match any of the scopes provided by the client, the discovery service adds that endpoint to the response that is sent back to the client.","pos":[2811,2980]},{"content":"<bpt id=\"p1\">**</bpt>CustomDiscoveryExtension.cs<ept id=\"p1\">**</ept>: The last step in implementing the discovery service is to connect this implementation of the custom discover service to the service host.","pos":[2990,3160],"source":"**CustomDiscoveryExtension.cs**: The last step in implementing the discovery service is to connect this implementation of the custom discover service to the service host."},{"content":"The helper class used here is the <ph id=\"ph1\">`CustomDiscoveryExtension`</ph> class.","pos":[3161,3228],"source":" The helper class used here is the `CustomDiscoveryExtension` class."},{"content":"This class extends the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.DiscoveryServiceExtension&gt;</ph> class.","pos":[3229,3321],"source":" This class extends the <xref:System.ServiceModel.Discovery.DiscoveryServiceExtension> class."},{"content":"The user must override the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.DiscoveryServiceExtension.GetDiscoveryService%2A&gt;</ph> method.","pos":[3322,3442],"source":" The user must override the <xref:System.ServiceModel.Discovery.DiscoveryServiceExtension.GetDiscoveryService%2A> method."},{"content":"In this case, the method returns an instance of the custom discovery service that was created before.","pos":[3443,3544]},{"content":"<ph id=\"ph1\">`PublishedEndpoints`</ph> is a <ph id=\"ph2\">&lt;xref:System.Collections.ObjectModel.ReadOnlyCollection%601&gt;</ph> that contains all of the application endpoints that are added to the <ph id=\"ph3\">&lt;xref:System.ServiceModel.ServiceHost&gt;</ph>.","pos":[3545,3740],"source":"`PublishedEndpoints` is a <xref:System.Collections.ObjectModel.ReadOnlyCollection%601> that contains all of the application endpoints that are added to the <xref:System.ServiceModel.ServiceHost>."},{"content":"The custom discovery service uses this to populate its internal list.","pos":[3741,3810]},{"content":"A user can to add other endpoint metadata as well.","pos":[3811,3861]},{"content":"Lastly, open Program.cs.","pos":[3868,3892]},{"content":"Note that both the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Discovery.ServiceDiscoveryBehavior&gt;</ph> and <ph id=\"ph2\">`CustomDiscoveryExtension`</ph> are added to the host.","pos":[3893,4027],"source":" Note that both the <xref:System.ServiceModel.Discovery.ServiceDiscoveryBehavior> and `CustomDiscoveryExtension` are added to the host."},{"content":"Once this is done and the host has an endpoint over which to receive discovery messages, the application can use the custom discovery service.","pos":[4028,4170]},{"content":"Observe that the client is able to find the service without knowing its address.","pos":[4177,4257]},{"pos":[4268,4304],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"content":"Open the solution that contains the project.","pos":[4314,4358]},{"content":"Build the project.","pos":[4368,4386]},{"content":"Run the service application.","pos":[4396,4424]},{"content":"Run the client application.","pos":[4434,4461]},{"pos":[4469,4601],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[4655,4965],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[4966,5016]}]}