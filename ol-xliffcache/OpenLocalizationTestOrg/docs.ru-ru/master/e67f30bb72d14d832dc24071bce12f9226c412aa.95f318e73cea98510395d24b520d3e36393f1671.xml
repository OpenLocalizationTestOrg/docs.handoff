{"content":"---\ntitle: \"Committing a Transaction in Single-Phase and Multi-Phase | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 694ea153-e4db-41ae-96ac-9ac66dcb69a9\ncaps.latest.revision: 3\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Committing a Transaction in Single-Phase and Multi-Phase\nEach resource used in a transaction is managed by a resource manager (RM), whose actions are coordinated by a transaction manager (TM). The [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md) topic discusses how a resource (or multiple resources) can be enlisted in a transaction. This topic discusses how transaction commitment can be coordinated among enlisted resources.  \n  \n At the end of the transaction, the application requests the transaction to be either committed or rolled back. The transaction manager must eliminate risks like some resource managers voting to commit while others voting to roll back the transaction.  \n  \n If your transaction involves more than one resource, you must perform a two-phase commit (2PC). The two-phase commit protocol (the prepare phase and the commit phase) ensures that when the transaction ends, all changes to all resources are either totally committed or fully rolled back. All the participants are then informed of the final result. For a detailed discussion of the two-phase commit protocol, please consult the book \"*Transaction Processing : Concepts and Techniques (Morgan Kaufmann Series in Data Management Systems) ISBN:1558601902*\" by Jim Gray.  \n  \n You can also optimize your transaction's performance by taking part in the Single Phase Commit protocol. For more information, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md).  \n  \n If you just want to be informed of a transaction's outcome, and do not want to participate in voting, you should register for the <xref:System.Transactions.Transaction.TransactionCompleted> event.  \n  \n## Two-phase Commit (2PC)  \n In the first transaction phase, the transaction manager queries each resource to determine whether a transaction should be committed or rolled back. In the second transaction phase, the transaction manager notifies each resource of the outcome of its queries, allowing it to perform any necessary cleanup.  \n  \n To participate in this kind of transaction, a resource manager must implement the <xref:System.Transactions.IEnlistmentNotification> interface, which provides methods that are called by the TM as notifications during a 2PC.  The following sample shows an example of such implementation.  \n  \n [!code-csharp[Tx_Enlist#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#2)]\n [!code-vb[Tx_Enlist#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#2)]  \n  \n### Prepare phase (Phase 1)  \n Upon receiving a <xref:System.Transactions.CommittableTransaction.Commit%2A> request from the application, the transaction manager begins the Prepare phase of all the enlisted participants by calling the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method on each enlisted resource, in order to obtain each resource's vote on the transaction.  \n  \n Your resource manager that implements the <xref:System.Transactions.IEnlistmentNotification> interface should first implement the <xref:System.Transactions.IEnlistmentNotification.Prepare%28System.Transactions.PreparingEnlistment%29> method as the following simple example shows.  \n  \n```  \npublic void Prepare(PreparingEnlistment preparingEnlistment)  \n{  \n     Console.WriteLine(\"Prepare notification received\");  \n     //Perform work  \n  \n     Console.Write(\"reply with prepared? [Y|N] \");  \n     c = Console.ReadKey();  \n     Console.WriteLine();  \n  \n     //If work finished correctly, reply with prepared  \n     if ((c.KeyChar == 'Y') || (c.KeyChar == 'y'))  \n     {  \n          preparingEnlistment.Prepared();  \n          break;  \n     }  \n  \n     // otherwise, do a ForceRollback  \n     else if ((c.KeyChar == 'N') || (c.KeyChar == 'n'))  \n     {  \n          preparingEnlistment.ForceRollback();  \n          break;  \n     }  \n}  \n  \n```  \n  \n When the durable resource manager receives this call, it should log the transaction's recovery information (available by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property) and whatever information is necessary to complete the transaction on commit. This does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method because the RM can do this on a worker thread.  \n  \n When the RM has finished its prepare work, it should vote to commit or roll back by calling the <xref:System.Transactions.PreparingEnlistment.Prepared%2A> or <xref:System.Transactions.PreparingEnlistment.ForceRollback%2A> method. Notice that the <xref:System.Transactions.PreparingEnlistment> class inherits a <xref:System.Transactions.Enlistment.Done%2A> method from the <xref:System.Transactions.Enlistment> class. If you call this method on the <xref:System.Transactions.PreparingEnlistment> callback during the Prepare phase, it informs the TM that it is a Read-Only enlistment (that is, resource managers that can read but cannot update transaction-protected data) and the RM receives no further notifications from the transaction manager as to the outcome of the transaction in phase 2.  \n  \n The application is told of the successful commitment of the transaction after all the resource managers vote <xref:System.Transactions.PreparingEnlistment.Prepared%2A>.  \n  \n### Commit phase (Phase 2)  \n In the second phase of the transaction, if the transaction manager receives successful prepares from all the resource managers (all the resource managers have invoked <xref:System.Transactions.PreparingEnlistment.Prepared%2A> at the end of phase 1), it invokes the <xref:System.Transactions.IEnlistmentNotification.Commit%2A> method for each resource manager. The resource managers can then make the changes durable and complete the commit.  \n  \n If any resource manager reported a failure to prepare in phase 1, the transaction manager invokes the <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> method for each resource manager and indicates the failure of the commit to the application.  \n  \n Thus, your resource manager should implement the following methods.  \n  \n```  \npublic void Commit (Enlistment enlistment)  \n{  \n     // Do any work necessary when commit notification is received  \n  \n     // Declare done on the enlistment  \n     enlistment.Done();  \n}  \n  \npublic void Rollback (Enlistment enlistment)  \n{  \n     // Do any work necessary when rollback notification is received  \n  \n     // Declare done on the enlistment    \n     enlistment.Done();    \n}  \n```  \n  \n The RM should perform any work necessary to finish the transaction based on the notification type, and inform the TM that it has finished by calling <xref:System.Transactions.Enlistment.Done%2A> method on the <xref:System.Transactions.Enlistment> parameter. This work can be done on a worker thread. Note that the phase 2 notifications can happen inline on the same thread that called the <xref:System.Transactions.PreparingEnlistment.Prepared%2A> method in phase 1. As such, you should not do any work after the <xref:System.Transactions.PreparingEnlistment.Prepared%2A> call (for example, releasing locks) that you would expect to have completed before receiving the phase 2 notifications.  \n  \n### Implementing InDoubt  \n Finally, you should implement the <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> method for the volatile resource manager. This method is called if the transaction manager loses contact with one or more participants, so their status is unknown. If this occurs, you should log this fact so that you can investigate later whether any of the transaction participants has been left in an inconsistent state.  \n  \n```  \npublic void InDoubt (Enlistment enlistment)  \n{  \n     // log this  \n     enlistment.Done();  \n}  \n```  \n  \n## Single Phase Commit Optimization  \n The Single Phase Commit protocol is more efficient at run time because all updates are done without any explicit coordination. For more information on this protocol, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md).  \n  \n## See Also  \n [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)   \n [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)","nodes":[{"pos":[4,343],"embed":true,"restype":"x-metadata","content":"title: \"Committing a Transaction in Single-Phase and Multi-Phase | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 694ea153-e4db-41ae-96ac-9ac66dcb69a9\ncaps.latest.revision: 3\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","nodes":[{"content":"Committing a Transaction in Single-Phase and Multi-Phase | Microsoft Docs","nodes":[{"pos":[0,73],"content":"Committing a Transaction in Single-Phase and Multi-Phase | Microsoft Docs","nodes":[{"content":"Committing a Transaction in Single-Phase and Multi-Phase | Microsoft Docs","pos":[0,73]}]}],"path":["title"]}],"yml":true},{"pos":[350,406],"content":"Committing a Transaction in Single-Phase and Multi-Phase","linkify":"Committing a Transaction in Single-Phase and Multi-Phase","nodes":[{"content":"Committing a Transaction in Single-Phase and Multi-Phase","pos":[0,56]}]},{"content":"Each resource used in a transaction is managed by a resource manager (RM), whose actions are coordinated by a transaction manager (TM).","pos":[407,542]},{"content":"The <bpt id=\"p1\">[</bpt>Enlisting Resources as Participants in a Transaction<ept id=\"p1\">](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)</ept> topic discusses how a resource (or multiple resources) can be enlisted in a transaction.","pos":[543,792],"source":" The [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md) topic discusses how a resource (or multiple resources) can be enlisted in a transaction."},{"content":"This topic discusses how transaction commitment can be coordinated among enlisted resources.","pos":[793,885]},{"content":"At the end of the transaction, the application requests the transaction to be either committed or rolled back.","pos":[892,1002]},{"content":"The transaction manager must eliminate risks like some resource managers voting to commit while others voting to roll back the transaction.","pos":[1003,1142]},{"content":"If your transaction involves more than one resource, you must perform a two-phase commit (2PC).","pos":[1149,1244]},{"content":"The two-phase commit protocol (the prepare phase and the commit phase) ensures that when the transaction ends, all changes to all resources are either totally committed or fully rolled back.","pos":[1245,1435]},{"content":"All the participants are then informed of the final result.","pos":[1436,1495]},{"content":"For a detailed discussion of the two-phase commit protocol, please consult the book \"<bpt id=\"p1\">*</bpt>Transaction Processing : Concepts and Techniques (Morgan Kaufmann Series in Data Management Systems) ISBN:1558601902<ept id=\"p1\">*</ept>\" by Jim Gray.","pos":[1496,1713],"source":" For a detailed discussion of the two-phase commit protocol, please consult the book \"*Transaction Processing : Concepts and Techniques (Morgan Kaufmann Series in Data Management Systems) ISBN:1558601902*\" by Jim Gray."},{"content":"You can also optimize your transaction's performance by taking part in the Single Phase Commit protocol.","pos":[1720,1824]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Optimization using Single Phase Commit and Promotable Single Phase Notification<ept id=\"p1\">](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)</ept>.","pos":[1825,2018],"source":" For more information, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)."},{"content":"If you just want to be informed of a transaction's outcome, and do not want to participate in voting, you should register for the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.TransactionCompleted&gt;</ph> event.","pos":[2025,2221],"source":"If you just want to be informed of a transaction's outcome, and do not want to participate in voting, you should register for the <xref:System.Transactions.Transaction.TransactionCompleted> event."},{"pos":[2230,2252],"content":"Two-phase Commit (2PC)","linkify":"Two-phase Commit (2PC)","nodes":[{"content":"Two-phase Commit (2PC)","pos":[0,22]}]},{"content":"In the first transaction phase, the transaction manager queries each resource to determine whether a transaction should be committed or rolled back.","pos":[2256,2404]},{"content":"In the second transaction phase, the transaction manager notifies each resource of the outcome of its queries, allowing it to perform any necessary cleanup.","pos":[2405,2561]},{"content":"To participate in this kind of transaction, a resource manager must implement the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification&gt;</ph> interface, which provides methods that are called by the TM as notifications during a 2PC.","pos":[2568,2791],"source":"To participate in this kind of transaction, a resource manager must implement the <xref:System.Transactions.IEnlistmentNotification> interface, which provides methods that are called by the TM as notifications during a 2PC."},{"content":"The following sample shows an example of such implementation.","pos":[2793,2854]},{"pos":[3084,3107],"content":"Prepare phase (Phase 1)","linkify":"Prepare phase (Phase 1)","nodes":[{"content":"Prepare phase (Phase 1)","pos":[0,23]}]},{"content":"Upon receiving a <ph id=\"ph1\">&lt;xref:System.Transactions.CommittableTransaction.Commit%2A&gt;</ph> request from the application, the transaction manager begins the Prepare phase of all the enlisted participants by calling the <ph id=\"ph2\">&lt;xref:System.Transactions.IEnlistmentNotification.Prepare%2A&gt;</ph> method on each enlisted resource, in order to obtain each resource's vote on the transaction.","pos":[3111,3470],"source":"Upon receiving a <xref:System.Transactions.CommittableTransaction.Commit%2A> request from the application, the transaction manager begins the Prepare phase of all the enlisted participants by calling the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method on each enlisted resource, in order to obtain each resource's vote on the transaction."},{"content":"Your resource manager that implements the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification&gt;</ph> interface should first implement the <ph id=\"ph2\">&lt;xref:System.Transactions.IEnlistmentNotification.Prepare%28System.Transactions.PreparingEnlistment%29&gt;</ph> method as the following simple example shows.","pos":[3477,3756],"source":"Your resource manager that implements the <xref:System.Transactions.IEnlistmentNotification> interface should first implement the <xref:System.Transactions.IEnlistmentNotification.Prepare%28System.Transactions.PreparingEnlistment%29> method as the following simple example shows."},{"content":"When the durable resource manager receives this call, it should log the transaction's recovery information (available by retrieving the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A&gt;</ph> property) and whatever information is necessary to complete the transaction on commit.","pos":[4428,4720],"source":"When the durable resource manager receives this call, it should log the transaction's recovery information (available by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property) and whatever information is necessary to complete the transaction on commit."},{"content":"This does not need to be performed within the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification.Prepare%2A&gt;</ph> method because the RM can do this on a worker thread.","pos":[4721,4882],"source":" This does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method because the RM can do this on a worker thread."},{"content":"When the RM has finished its prepare work, it should vote to commit or roll back by calling the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.Prepared%2A&gt;</ph> or <ph id=\"ph2\">&lt;xref:System.Transactions.PreparingEnlistment.ForceRollback%2A&gt;</ph> method.","pos":[4889,5118],"source":"When the RM has finished its prepare work, it should vote to commit or roll back by calling the <xref:System.Transactions.PreparingEnlistment.Prepared%2A> or <xref:System.Transactions.PreparingEnlistment.ForceRollback%2A> method."},{"content":"Notice that the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment&gt;</ph> class inherits a <ph id=\"ph2\">&lt;xref:System.Transactions.Enlistment.Done%2A&gt;</ph> method from the <ph id=\"ph3\">&lt;xref:System.Transactions.Enlistment&gt;</ph> class.","pos":[5119,5305],"source":" Notice that the <xref:System.Transactions.PreparingEnlistment> class inherits a <xref:System.Transactions.Enlistment.Done%2A> method from the <xref:System.Transactions.Enlistment> class."},{"content":"If you call this method on the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment&gt;</ph> callback during the Prepare phase, it informs the TM that it is a Read-Only enlistment (that is, resource managers that can read but cannot update transaction-protected data) and the RM receives no further notifications from the transaction manager as to the outcome of the transaction in phase 2.","pos":[5306,5681],"source":" If you call this method on the <xref:System.Transactions.PreparingEnlistment> callback during the Prepare phase, it informs the TM that it is a Read-Only enlistment (that is, resource managers that can read but cannot update transaction-protected data) and the RM receives no further notifications from the transaction manager as to the outcome of the transaction in phase 2."},{"content":"The application is told of the successful commitment of the transaction after all the resource managers vote <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.Prepared%2A&gt;</ph>.","pos":[5688,5856],"source":"The application is told of the successful commitment of the transaction after all the resource managers vote <xref:System.Transactions.PreparingEnlistment.Prepared%2A>."},{"pos":[5866,5888],"content":"Commit phase (Phase 2)","linkify":"Commit phase (Phase 2)","nodes":[{"content":"Commit phase (Phase 2)","pos":[0,22]}]},{"content":"In the second phase of the transaction, if the transaction manager receives successful prepares from all the resource managers (all the resource managers have invoked <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.Prepared%2A&gt;</ph> at the end of phase 1), it invokes the <ph id=\"ph2\">&lt;xref:System.Transactions.IEnlistmentNotification.Commit%2A&gt;</ph> method for each resource manager.","pos":[5892,6251],"source":"In the second phase of the transaction, if the transaction manager receives successful prepares from all the resource managers (all the resource managers have invoked <xref:System.Transactions.PreparingEnlistment.Prepared%2A> at the end of phase 1), it invokes the <xref:System.Transactions.IEnlistmentNotification.Commit%2A> method for each resource manager."},{"content":"The resource managers can then make the changes durable and complete the commit.","pos":[6252,6332]},{"content":"If any resource manager reported a failure to prepare in phase 1, the transaction manager invokes the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification.Rollback%2A&gt;</ph> method for each resource manager and indicates the failure of the commit to the application.","pos":[6339,6596],"source":"If any resource manager reported a failure to prepare in phase 1, the transaction manager invokes the <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> method for each resource manager and indicates the failure of the commit to the application."},{"content":"Thus, your resource manager should implement the following methods.","pos":[6603,6670]},{"content":"The RM should perform any work necessary to finish the transaction based on the notification type, and inform the TM that it has finished by calling <ph id=\"ph1\">&lt;xref:System.Transactions.Enlistment.Done%2A&gt;</ph> method on the <ph id=\"ph2\">&lt;xref:System.Transactions.Enlistment&gt;</ph> parameter.","pos":[7087,7344],"source":"The RM should perform any work necessary to finish the transaction based on the notification type, and inform the TM that it has finished by calling <xref:System.Transactions.Enlistment.Done%2A> method on the <xref:System.Transactions.Enlistment> parameter."},{"content":"This work can be done on a worker thread.","pos":[7345,7386]},{"content":"Note that the phase 2 notifications can happen inline on the same thread that called the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.Prepared%2A&gt;</ph> method in phase 1.","pos":[7387,7553],"source":" Note that the phase 2 notifications can happen inline on the same thread that called the <xref:System.Transactions.PreparingEnlistment.Prepared%2A> method in phase 1."},{"content":"As such, you should not do any work after the <ph id=\"ph1\">&lt;xref:System.Transactions.PreparingEnlistment.Prepared%2A&gt;</ph> call (for example, releasing locks) that you would expect to have completed before receiving the phase 2 notifications.","pos":[7554,7778],"source":" As such, you should not do any work after the <xref:System.Transactions.PreparingEnlistment.Prepared%2A> call (for example, releasing locks) that you would expect to have completed before receiving the phase 2 notifications."},{"pos":[7788,7808],"content":"Implementing InDoubt","linkify":"Implementing InDoubt","nodes":[{"content":"Implementing InDoubt","pos":[0,20]}]},{"content":"Finally, you should implement the <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification.InDoubt%2A&gt;</ph> method for the volatile resource manager.","pos":[7812,7949],"source":"Finally, you should implement the <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> method for the volatile resource manager."},{"content":"This method is called if the transaction manager loses contact with one or more participants, so their status is unknown.","pos":[7950,8071]},{"content":"If this occurs, you should log this fact so that you can investigate later whether any of the transaction participants has been left in an inconsistent state.","pos":[8072,8230]},{"pos":[8353,8385],"content":"Single Phase Commit Optimization","linkify":"Single Phase Commit Optimization","nodes":[{"content":"Single Phase Commit Optimization","pos":[0,32]}]},{"content":"The Single Phase Commit protocol is more efficient at run time because all updates are done without any explicit coordination.","pos":[8389,8515]},{"content":"For more information on this protocol, see <bpt id=\"p1\">[</bpt>Optimization using Single Phase Commit and Promotable Single Phase Notification<ept id=\"p1\">](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)</ept>.","pos":[8516,8726],"source":" For more information on this protocol, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)."},{"pos":[8735,8743],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Optimization using Single Phase Commit and Promotable Single Phase Notification<ept id=\"p1\">](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)</ept><ph id=\"ph1\"> </ph>","pos":[8747,8914],"source":"[Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md) "},{"content":"<bpt id=\"p1\">[</bpt>Enlisting Resources as Participants in a Transaction<ept id=\"p1\">](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)</ept>","pos":[8918,9074],"source":"[Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)"}]}