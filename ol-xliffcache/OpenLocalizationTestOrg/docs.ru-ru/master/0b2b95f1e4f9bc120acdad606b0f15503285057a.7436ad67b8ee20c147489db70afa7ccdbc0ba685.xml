{"content":"---\ntitle: \"Using Async for File Access (Visual Basic)\"\nms.date: 07/20/2015\nms.assetid: c989305f-08e3-4687-95c3-948465cda202\n---\n# Using Async for File Access (Visual Basic)\nYou can use the Async feature to access files. By using the Async feature, you can call into asynchronous methods without using callbacks or splitting your code across multiple methods or lambda expressions. To make synchronous code asynchronous, you just call an asynchronous method instead of a synchronous method and add a few keywords to the code.  \n  \n You might consider the following reasons for adding asynchrony to file access calls:  \n  \n-   Asynchrony makes UI applications more responsive because the UI thread that launches the operation can perform other work. If the UI thread must execute code that takes a long time (for example, more than 50 milliseconds), the UI may freeze until the I/O is complete and the UI thread can again process keyboard and mouse input and other events.  \n  \n-   Asynchrony improves the scalability of ASP.NET and other server-based applications by reducing the need for threads. If the application uses a dedicated thread per response and a thousand requests are being handled simultaneously, a thousand threads are needed. Asynchronous operations often don’t need to use a thread during the wait. They use the existing I/O completion thread briefly at the end.  \n  \n-   The latency of a file access operation might be very low under current conditions, but the latency may greatly increase in the future. For example, a file may be moved to a server that's across the world.  \n  \n-   The added overhead of using the Async feature is small.  \n  \n-   Asynchronous tasks can easily be run in parallel.  \n  \n## Running the Examples  \n To run the examples in this topic, you can create a **WPF Application** or a **Windows Forms Application** and then add a **Button**. In the button's `Click` event, add a call to the first method in each example.  \n  \n In the following examples, include the following `Imports` statements.  \n  \n```vb  \nImports System  \nImports System.Collections.Generic  \nImports System.Diagnostics  \nImports System.IO  \nImports System.Text  \nImports System.Threading.Tasks  \n```  \n  \n## Use of the FileStream Class  \n The examples in this topic use the <xref:System.IO.FileStream> class, which has an option that causes asynchronous I/O to occur at the operating system level. By using this option, you can avoid blocking a ThreadPool thread in many cases. To enable this option, you specify the `useAsync=true` or `options=FileOptions.Asynchronous` argument in the constructor call.  \n  \n You can’t use this option with <xref:System.IO.StreamReader> and <xref:System.IO.StreamWriter> if you open them directly by specifying a file path. However, you can use this option if you provide them a <xref:System.IO.Stream> that the <xref:System.IO.FileStream> class opened. Note that asynchronous calls are faster in UI apps even if a ThreadPool thread is blocked, because the UI thread isn’t blocked during the wait.  \n  \n## Writing Text  \n The following example writes text to a file. At each await statement, the method immediately exits. When the file I/O is complete, the method resumes at the statement that follows the await statement. Note that the async modifier is in the definition of methods that use the await statement.  \n  \n```vb  \nPublic Async Sub ProcessWrite()  \n    Dim filePath = \"temp2.txt\"  \n    Dim text = \"Hello World\" & ControlChars.CrLf  \n  \n    Await WriteTextAsync(filePath, text)  \nEnd Sub  \n  \nPrivate Async Function WriteTextAsync(filePath As String, text As String) As Task  \n    Dim encodedText As Byte() = Encoding.Unicode.GetBytes(text)  \n  \n    Using sourceStream As New FileStream(filePath,  \n        FileMode.Append, FileAccess.Write, FileShare.None,  \n        bufferSize:=4096, useAsync:=True)  \n  \n        Await sourceStream.WriteAsync(encodedText, 0, encodedText.Length)  \n    End Using  \nEnd Function  \n```  \n  \n The original example has the statement `Await sourceStream.WriteAsync(encodedText, 0, encodedText.Length)`, which is a contraction of the following two statements:  \n  \n```vb  \nDim theTask As Task = sourceStream.WriteAsync(encodedText, 0, encodedText.Length)  \nAwait theTask  \n```  \n  \n The first statement returns a task and causes file processing to start. The second statement with the await causes the method to immediately exit and return a different task. When the file processing later completes, execution returns to the statement that follows the await. For more information, see  [Control Flow in Async Programs (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/control-flow-in-async-programs.md).  \n  \n## Reading Text  \n The following example reads text from a file. The text is buffered and, in this case, placed into a <xref:System.Text.StringBuilder>. Unlike in the previous example, the evaluation of the await produces a value. The <xref:System.IO.Stream.ReadAsync%2A> method returns a <xref:System.Threading.Tasks.Task>\\<<xref:System.Int32>>, so the evaluation of the await produces an `Int32` value (`numRead`) after the operation completes. For more information, see [Async Return Types (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/async-return-types.md).  \n  \n```vb  \nPublic Async Sub ProcessRead()  \n    Dim filePath = \"temp2.txt\"  \n  \n    If File.Exists(filePath) = False Then  \n        Debug.WriteLine(\"file not found: \" & filePath)  \n    Else  \n        Try  \n            Dim text As String = Await ReadTextAsync(filePath)  \n            Debug.WriteLine(text)  \n        Catch ex As Exception  \n            Debug.WriteLine(ex.Message)  \n        End Try  \n    End If  \nEnd Sub  \n  \nPrivate Async Function ReadTextAsync(filePath As String) As Task(Of String)  \n  \n    Using sourceStream As New FileStream(filePath,  \n        FileMode.Open, FileAccess.Read, FileShare.Read,  \n        bufferSize:=4096, useAsync:=True)  \n  \n        Dim sb As New StringBuilder  \n  \n        Dim buffer As Byte() = New Byte(&H1000) {}  \n        Dim numRead As Integer  \n        numRead = Await sourceStream.ReadAsync(buffer, 0, buffer.Length)  \n        While numRead <> 0  \n            Dim text As String = Encoding.Unicode.GetString(buffer, 0, numRead)  \n            sb.Append(text)  \n  \n            numRead = Await sourceStream.ReadAsync(buffer, 0, buffer.Length)  \n        End While  \n  \n        Return sb.ToString  \n    End Using  \nEnd Function  \n```  \n  \n## Parallel Asynchronous I/O  \n The following example demonstrates parallel processing by writing 10 text files. For each file, the <xref:System.IO.Stream.WriteAsync%2A> method returns a task that is then added to a list of tasks. The `Await Task.WhenAll(tasks)` statement exits the method and resumes within the method when file processing is complete for all of the tasks.  \n  \n The example closes all <xref:System.IO.FileStream> instances in a `Finally` block after the tasks are complete. If each `FileStream` was instead created in a `Imports` statement, the `FileStream` might be disposed of before the task was complete.  \n  \n Note that any performance boost is almost entirely from the parallel processing and not the asynchronous processing. The advantages of asynchrony are that it doesn’t tie up multiple threads, and that it doesn’t tie up the user interface thread.  \n  \n```vb  \nPublic Async Sub ProcessWriteMult()  \n    Dim folder = \"tempfolder\\\"  \n    Dim tasks As New List(Of Task)  \n    Dim sourceStreams As New List(Of FileStream)  \n  \n    Try  \n        For index = 1 To 10  \n            Dim text = \"In file \" & index.ToString & ControlChars.CrLf  \n  \n            Dim fileName = \"thefile\" & index.ToString(\"00\") & \".txt\"  \n            Dim filePath = folder & fileName  \n  \n            Dim encodedText As Byte() = Encoding.Unicode.GetBytes(text)  \n  \n            Dim sourceStream As New FileStream(filePath,  \n                FileMode.Append, FileAccess.Write, FileShare.None,  \n                bufferSize:=4096, useAsync:=True)  \n  \n            Dim theTask As Task = sourceStream.WriteAsync(encodedText, 0, encodedText.Length)  \n            sourceStreams.Add(sourceStream)  \n  \n            tasks.Add(theTask)  \n        Next  \n  \n        Await Task.WhenAll(tasks)  \n    Finally  \n        For Each sourceStream As FileStream In sourceStreams  \n            sourceStream.Close()  \n        Next  \n    End Try  \nEnd Sub  \n```  \n  \n When using the <xref:System.IO.Stream.WriteAsync%2A> and <xref:System.IO.Stream.ReadAsync%2A> methods, you can specify a <xref:System.Threading.CancellationToken>, which you can use to cancel the operation mid-stream. For more information, see [Fine-Tuning Your Async Application (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/fine-tuning-your-async-application.md) and [Cancellation in Managed Threads](../../../../standard/threading/cancellation-in-managed-threads.md).  \n  \n## See also\n\n- [Asynchronous Programming with Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/index.md)\n- [Async Return Types (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/async-return-types.md)\n- [Control Flow in Async Programs (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/control-flow-in-async-programs.md)\n","nodes":[{"pos":[4,124],"embed":true,"restype":"x-metadata","content":"title: \"Using Async for File Access (Visual Basic)\"\nms.date: 07/20/2015\nms.assetid: c989305f-08e3-4687-95c3-948465cda202","nodes":[{"content":"Using Async for File Access (Visual Basic)","nodes":[{"pos":[0,42],"content":"Using Async for File Access (Visual Basic)","nodes":[{"content":"Using Async for File Access (Visual Basic)","pos":[0,42]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[131,173],"content":"Using Async for File Access (Visual Basic)","linkify":"Using Async for File Access (Visual Basic)","nodes":[{"content":"Using Async for File Access (Visual Basic)","pos":[0,42]}]},{"content":"You can use the Async feature to access files.","pos":[174,220]},{"content":"By using the Async feature, you can call into asynchronous methods without using callbacks or splitting your code across multiple methods or lambda expressions.","pos":[221,381]},{"content":"To make synchronous code asynchronous, you just call an asynchronous method instead of a synchronous method and add a few keywords to the code.","pos":[382,525]},{"content":"You might consider the following reasons for adding asynchrony to file access calls:","pos":[532,616]},{"content":"Asynchrony makes UI applications more responsive because the UI thread that launches the operation can perform other work.","pos":[626,748]},{"content":"If the UI thread must execute code that takes a long time (for example, more than 50 milliseconds), the UI may freeze until the I/O is complete and the UI thread can again process keyboard and mouse input and other events.","pos":[749,971]},{"content":"Asynchrony improves the scalability of ASP.NET and other server-based applications by reducing the need for threads.","pos":[981,1097]},{"content":"If the application uses a dedicated thread per response and a thousand requests are being handled simultaneously, a thousand threads are needed.","pos":[1098,1242]},{"content":"Asynchronous operations often don’t need to use a thread during the wait.","pos":[1243,1316]},{"content":"They use the existing I/O completion thread briefly at the end.","pos":[1317,1380]},{"content":"The latency of a file access operation might be very low under current conditions, but the latency may greatly increase in the future.","pos":[1390,1524]},{"content":"For example, a file may be moved to a server that's across the world.","pos":[1525,1594]},{"content":"The added overhead of using the Async feature is small.","pos":[1604,1659]},{"content":"Asynchronous tasks can easily be run in parallel.","pos":[1669,1718]},{"pos":[1727,1747],"content":"Running the Examples","linkify":"Running the Examples","nodes":[{"content":"Running the Examples","pos":[0,20]}]},{"content":"To run the examples in this topic, you can create a <bpt id=\"p1\">**</bpt>WPF Application<ept id=\"p1\">**</ept> or a <bpt id=\"p2\">**</bpt>Windows Forms Application<ept id=\"p2\">**</ept> and then add a <bpt id=\"p3\">**</bpt>Button<ept id=\"p3\">**</ept>.","pos":[1751,1884],"source":"To run the examples in this topic, you can create a **WPF Application** or a **Windows Forms Application** and then add a **Button**."},{"content":"In the button's <ph id=\"ph1\">`Click`</ph> event, add a call to the first method in each example.","pos":[1885,1963],"source":" In the button's `Click` event, add a call to the first method in each example."},{"pos":[1970,2040],"content":"In the following examples, include the following <ph id=\"ph1\">`Imports`</ph> statements.","source":"In the following examples, include the following `Imports` statements."},{"pos":[2224,2251],"content":"Use of the FileStream Class","linkify":"Use of the FileStream Class","nodes":[{"content":"Use of the FileStream Class","pos":[0,27]}]},{"content":"The examples in this topic use the <ph id=\"ph1\">&lt;xref:System.IO.FileStream&gt;</ph> class, which has an option that causes asynchronous I/O to occur at the operating system level.","pos":[2255,2413],"source":"The examples in this topic use the <xref:System.IO.FileStream> class, which has an option that causes asynchronous I/O to occur at the operating system level."},{"content":"By using this option, you can avoid blocking a ThreadPool thread in many cases.","pos":[2414,2493]},{"content":"To enable this option, you specify the <ph id=\"ph1\">`useAsync=true`</ph> or <ph id=\"ph2\">`options=FileOptions.Asynchronous`</ph> argument in the constructor call.","pos":[2494,2620],"source":" To enable this option, you specify the `useAsync=true` or `options=FileOptions.Asynchronous` argument in the constructor call."},{"content":"You can’t use this option with <ph id=\"ph1\">&lt;xref:System.IO.StreamReader&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.IO.StreamWriter&gt;</ph> if you open them directly by specifying a file path.","pos":[2627,2774],"source":"You can’t use this option with <xref:System.IO.StreamReader> and <xref:System.IO.StreamWriter> if you open them directly by specifying a file path."},{"content":"However, you can use this option if you provide them a <ph id=\"ph1\">&lt;xref:System.IO.Stream&gt;</ph> that the <ph id=\"ph2\">&lt;xref:System.IO.FileStream&gt;</ph> class opened.","pos":[2775,2904],"source":" However, you can use this option if you provide them a <xref:System.IO.Stream> that the <xref:System.IO.FileStream> class opened."},{"content":"Note that asynchronous calls are faster in UI apps even if a ThreadPool thread is blocked, because the UI thread isn’t blocked during the wait.","pos":[2905,3048]},{"pos":[3057,3069],"content":"Writing Text","linkify":"Writing Text","nodes":[{"content":"Writing Text","pos":[0,12]}]},{"content":"The following example writes text to a file.","pos":[3073,3117]},{"content":"At each await statement, the method immediately exits.","pos":[3118,3172]},{"content":"When the file I/O is complete, the method resumes at the statement that follows the await statement.","pos":[3173,3273]},{"content":"Note that the async modifier is in the definition of methods that use the await statement.","pos":[3274,3364]},{"pos":[3986,4149],"content":"The original example has the statement <ph id=\"ph1\">`Await sourceStream.WriteAsync(encodedText, 0, encodedText.Length)`</ph>, which is a contraction of the following two statements:","source":"The original example has the statement `Await sourceStream.WriteAsync(encodedText, 0, encodedText.Length)`, which is a contraction of the following two statements:"},{"content":"The first statement returns a task and causes file processing to start.","pos":[4273,4344]},{"content":"The second statement with the await causes the method to immediately exit and return a different task.","pos":[4345,4447]},{"content":"When the file processing later completes, execution returns to the statement that follows the await.","pos":[4448,4548]},{"content":"For more information, see  <bpt id=\"p1\">[</bpt>Control Flow in Async Programs (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/control-flow-in-async-programs.md)</ept>.","pos":[4549,4717],"source":" For more information, see  [Control Flow in Async Programs (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/control-flow-in-async-programs.md)."},{"pos":[4726,4738],"content":"Reading Text","linkify":"Reading Text","nodes":[{"content":"Reading Text","pos":[0,12]}]},{"content":"The following example reads text from a file.","pos":[4742,4787]},{"content":"The text is buffered and, in this case, placed into a <ph id=\"ph1\">&lt;xref:System.Text.StringBuilder&gt;</ph>.","pos":[4788,4875],"source":" The text is buffered and, in this case, placed into a <xref:System.Text.StringBuilder>."},{"content":"Unlike in the previous example, the evaluation of the await produces a value.","pos":[4876,4953]},{"content":"The <ph id=\"ph1\">&lt;xref:System.IO.Stream.ReadAsync%2A&gt;</ph> method returns a <ph id=\"ph2\">&lt;xref:System.Threading.Tasks.Task&gt;</ph><ph id=\"ph3\">\\&lt;</ph><ph id=\"ph4\">&lt;xref:System.Int32&gt;</ph>&gt;, so the evaluation of the await produces an <ph id=\"ph5\">`Int32`</ph> value (<ph id=\"ph6\">`numRead`</ph>) after the operation completes.","pos":[4954,5169],"source":" The <xref:System.IO.Stream.ReadAsync%2A> method returns a <xref:System.Threading.Tasks.Task>\\<<xref:System.Int32>>, so the evaluation of the await produces an `Int32` value (`numRead`) after the operation completes."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Async Return Types (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/async-return-types.md)</ept>.","pos":[5170,5313],"source":" For more information, see [Async Return Types (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/async-return-types.md)."},{"pos":[6500,6525],"content":"Parallel Asynchronous I/O","linkify":"Parallel Asynchronous I/O","nodes":[{"content":"Parallel Asynchronous I/O","pos":[0,25]}]},{"content":"The following example demonstrates parallel processing by writing 10 text files.","pos":[6529,6609]},{"content":"For each file, the <ph id=\"ph1\">&lt;xref:System.IO.Stream.WriteAsync%2A&gt;</ph> method returns a task that is then added to a list of tasks.","pos":[6610,6727],"source":" For each file, the <xref:System.IO.Stream.WriteAsync%2A> method returns a task that is then added to a list of tasks."},{"content":"The <ph id=\"ph1\">`Await Task.WhenAll(tasks)`</ph> statement exits the method and resumes within the method when file processing is complete for all of the tasks.","pos":[6728,6871],"source":" The `Await Task.WhenAll(tasks)` statement exits the method and resumes within the method when file processing is complete for all of the tasks."},{"content":"The example closes all <ph id=\"ph1\">&lt;xref:System.IO.FileStream&gt;</ph> instances in a <ph id=\"ph2\">`Finally`</ph> block after the tasks are complete.","pos":[6878,6989],"source":"The example closes all <xref:System.IO.FileStream> instances in a `Finally` block after the tasks are complete."},{"content":"If each <ph id=\"ph1\">`FileStream`</ph> was instead created in a <ph id=\"ph2\">`Imports`</ph> statement, the <ph id=\"ph3\">`FileStream`</ph> might be disposed of before the task was complete.","pos":[6990,7124],"source":" If each `FileStream` was instead created in a `Imports` statement, the `FileStream` might be disposed of before the task was complete."},{"content":"Note that any performance boost is almost entirely from the parallel processing and not the asynchronous processing.","pos":[7131,7247]},{"content":"The advantages of asynchrony are that it doesn’t tie up multiple threads, and that it doesn’t tie up the user interface thread.","pos":[7248,7375]},{"content":"When using the <ph id=\"ph1\">&lt;xref:System.IO.Stream.WriteAsync%2A&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.IO.Stream.ReadAsync%2A&gt;</ph> methods, you can specify a <ph id=\"ph3\">&lt;xref:System.Threading.CancellationToken&gt;</ph>, which you can use to cancel the operation mid-stream.","pos":[8441,8658],"source":"When using the <xref:System.IO.Stream.WriteAsync%2A> and <xref:System.IO.Stream.ReadAsync%2A> methods, you can specify a <xref:System.Threading.CancellationToken>, which you can use to cancel the operation mid-stream."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Fine-Tuning Your Async Application (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/fine-tuning-your-async-application.md)</ept> and <bpt id=\"p2\">[</bpt>Cancellation in Managed Threads<ept id=\"p2\">](../../../../standard/threading/cancellation-in-managed-threads.md)</ept>.","pos":[8659,8939],"source":" For more information, see [Fine-Tuning Your Async Application (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/fine-tuning-your-async-application.md) and [Cancellation in Managed Threads](../../../../standard/threading/cancellation-in-managed-threads.md)."},{"pos":[8948,8956],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[8960,9090],"content":"<bpt id=\"p1\">[</bpt>Asynchronous Programming with Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/index.md)</ept>","source":"[Asynchronous Programming with Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/index.md)"},{"pos":[9093,9209],"content":"<bpt id=\"p1\">[</bpt>Async Return Types (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/async-return-types.md)</ept>","source":"[Async Return Types (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/async-return-types.md)"},{"pos":[9212,9352],"content":"<bpt id=\"p1\">[</bpt>Control Flow in Async Programs (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/control-flow-in-async-programs.md)</ept>","source":"[Control Flow in Async Programs (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/control-flow-in-async-programs.md)"}]}