{"content":"---\ntitle: \"Creating a Long-running Workflow Service | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345\ncaps.latest.revision: 9\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Creating a Long-running Workflow Service\nThis topic describes how to create a long-running workflow service. Long running workflow services may run for long periods of time. At some point the workflow may go idle waiting for some additional information. When this occurs the workflow is persisted to a SQL database and is removed from memory. When the additional information becomes available the workflow instance is loaded back into memory and continues executing.  In this scenario you are implementing a very simplified ordering system.  The client sends an initial message to the workflow service to start the order. It returns an order ID to the client. At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.  When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order. In the code sample it returns a string stating the item has been added to the order. The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services. This topic assumes you know how to create [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] projects and solutions.  \n  \n## Prerequisites  \n You must have the following software installed to use this walkthrough:  \n  \n1.  Microsoft SQL Server 2008  \n  \n2.  [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]  \n  \n3.  Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]  \n  \n4.  You are familiar with WCF and [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] and know how to create projects/solutions.  \n  \n### To Setup the SQL Database  \n  \n1.  In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances. Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**.  \n  \n2.  Click the **Connect** button to log on to the SQL Server instance  \n  \n3.  Right click **Databases** in the tree view and select **New Database..** to create a new database called `SQLPersistenceStore`.  \n  \n4.  Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\\Windows\\Microsoft.NET\\Framework\\v4.0\\SQL\\en directory on the SQLPersistenceStore database to set up the needed database schemas.  \n  \n5.  Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\\Windows\\Microsoft.NET\\Framework\\v4.0\\SQL\\en directory on the SQLPersistenceStore database to set up the needed database logic.  \n  \n### To Create the Web Hosted Workflow Service  \n  \n1.  Create an empty [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] solution, name it `OrderProcessing`.  \n  \n2.  Add a new [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] Workflow Service Application project called `OrderService` to the solution.  \n  \n3.  In the project properties dialog, select the **Web** tab.  \n  \n    1.  Under **Start Action** select **Specific Page** and specify `Service1.xamlx`.  \n  \n         ![Workflow Service Project Web Properties](../../../../docs/framework/wcf/feature-details/media/startaction.png \"StartAction\")  \n  \n    2.  Under **Servers** select **Use Local IIS Web server**.  \n  \n         ![Local Web Server Settings](../../../../docs/framework/wcf/feature-details/media/uselocalwebserver.png \"UseLocalWebServer\")  \n  \n        > [!WARNING]\n        >  You must run [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] in administrator mode to make this setting.  \n  \n         These two steps configure the workflow service project to be hosted by IIS.  \n  \n4.  Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities.  \n  \n5.  Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration. Doing this adds some variables that will be used later on in the workflow service.  \n  \n    > [!NOTE]\n    >  If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down. Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.  \n  \n     ![Add Variables](../../../../docs/framework/wcf/feature-details/media/addvariables.gif \"AddVariables\")  \n  \n6.  Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity. This set of activities will receive a message from a client and send a reply back.  \n  \n    1.  Select the **Receive** activity and set the properties highlighted in the following illustration.  \n  \n         ![Set Receive Activity Properties](../../../../docs/framework/wcf/feature-details/media/setreceiveproperties.png \"SetReceiveProperties\")  \n  \n         The DisplayName property sets the name displayed for the Receive activity in the designer. The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] how contracts are used in Workflow services see [Using Contracts in Workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).  \n  \n    2.  Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration.  Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable. This configures the **Receive** activity to receive some data and bind that data to local variables.  \n  \n         ![Setting the data received by the Receive activity](../../../../docs/framework/wcf/feature-details/media/setreceivecontent.png \"SetReceiveContent\")  \n  \n    3.  Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration.  \n  \n         ![Setting the properties of the SendReply activity](../../../../docs/framework/wcf/feature-details/media/setreplyproperties.png \"SetReplyProperties\")  \n  \n    4.  Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration. Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable. This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.  \n  \n         ![Configuring the SendReply activity content data](../../../../docs/framework/wcf/feature-details/media/setreplycontent.png \"SetReplyContent\")  \n  \n    5.  Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:  \n  \n         ![Adding an assign activity](../../../../docs/framework/wcf/feature-details/media/addassign.png \"AddAssign\")  \n  \n         This creates a new order ID and places the value in the orderId variable.  \n  \n    6.  Select the **ReplyToStartOrder** activity. In the properties window click the ellipsis button for **CorrelationInitializers**. Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box. These settings are shown in the following illustration. Click **OK**.  This initializes a correlation between the client and this instance of the workflow service. When a message containing this order ID is received it is routed to this instance of the workflow service.  \n  \n         ![Adding a correlation initializer](../../../../docs/framework/wcf/feature-details/media/addcorrelationinitializers.png \"AddCorrelationInitializers\")  \n  \n7.  Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities). This will receive the second message sent by the client and respond to it.  \n  \n    1.  Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button. Add the variable highlighted in the following illustration:  \n  \n         ![Adding new variables](../../../../docs/framework/wcf/feature-details/media/addorderitemidvariable.png \"AddOrderItemIdVariable\")  \n  \n    2.  Select the **Receive** activity and set the properties shown in the following illustration:  \n  \n         ![Set the Receive acitivity properties](../../../../docs/framework/wcf/feature-details/media/setreceiveproperties2.png \"SetReceiveProperties2\")  \n  \n    3.  Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.  \n  \n         ![Specifying parameters for the second receive](../../../../docs/framework/wcf/feature-details/media/addreceive2parameters.png \"AddReceive2Parameters\")  \n  \n    4.  Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`. Under **XPath Queries**, click the drop down arrow and select `p_orderId`. This configures the correlation on the second receive activity. [!INCLUDE[crabout](../../../../includes/crabout-md.md)] correlation see [Correlation](../../../../docs/framework/wcf/feature-details/correlation.md).  \n  \n         ![Setting the CorrelatesOn property](../../../../docs/framework/wcf/feature-details/media/correlateson.png \"CorrelatesOn\")  \n  \n    5.  Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity. This activity acts just like an if statement.  \n  \n        1.  Set the **Condition** property to `itemId==\"Zune HD\" (itemId=\"Zune HD\" for Visual Basic)`  \n  \n        2.  Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration.  \n  \n             ![Assigning the result of the service call](../../../../docs/framework/wcf/feature-details/media/resultassign.png \"ResultAssign\")  \n  \n             If the condition is `true` the **Then** section will be executed. If the condition is `false` the **Else** section is executed.  \n  \n        3.  Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration.  \n  \n             ![Setting the SendReply activity properties](../../../../docs/framework/wcf/feature-details/media/setreply2properties.png \"SetReply2Properties\")  \n  \n        4.  Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration. This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable.  \n  \n             ![Setting the data binding for the SendReply activit](../../../../docs/framework/wcf/feature-details/media/replytoadditemcontent.gif \"ReplyToAddItemContent\")  \n  \n8.  Open the web.config file and add the following elements in the \\<behavior> section to enable workflow persistence.  \n  \n    ```xml  \n    <sqlWorkflowInstanceStore connectionString=\"Data Source=your-machine\\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True\" instanceEncodingOption=\"None\" instanceCompletionAction=\"DeleteAll\" instanceLockedExceptionAction=\"BasicRetry\" hostLockRenewalPeriod=\"00:00:30\" runnableInstancesDetectionPeriod=\"00:00:02\" />  \n              <workflowIdle timeToUnload=\"0\"/>  \n  \n    ```  \n  \n    > [!WARNING]\n    >  Make sure to replace your host and SQL server instance name in the previous code snippet.  \n  \n9. Build the solution.  \n  \n### To Create a Client Application to Call the Workflow Service  \n  \n1.  Add a new Console application project called `OrderClient` to the solution.  \n  \n2.  Add references to the following assemblies to the `OrderClient` project  \n  \n    1.  System.ServiceModel.dll  \n  \n    2.  System.ServiceModel.Activities.dll  \n  \n3.  Add a service reference to the workflow service and specify `OrderService` as the namespace.  \n  \n4.  In the `Main()` method of the client project add the following code:  \n  \n    ```  \n    static void Main(string[] args)  \n    {  \n       // Send initial message to start the workflow service  \n       Console.WriteLine(\"Sending start message\");  \n       StartOrderClient startProxy = new StartOrderClient();  \n       string orderId = startProxy.StartOrder(\"Kim Abercrombie\");  \n  \n       // The workflow service is now waiting for the second message to be sent  \n       Console.WriteLine(\"Workflow service is idle...\");  \n       Console.WriteLine(\"Press [ENTER] to send an add item message to reactivate the workflow service...\");  \n       Console.ReadLine();  \n  \n       // Send the second message  \n       Console.WriteLine(\"Sending add item message\");  \n       AddItemClient addProxy = new AddItemClient();  \n       AddItem item = new AddItem();  \n       item.p_itemId = \"Zune HD\";  \n       item.p_orderId = orderId;  \n  \n       string orderResult = addProxy.AddItem(item);  \n       Console.WriteLine(\"Service returned: \" + orderResult);  \n    }  \n  \n    ```  \n  \n5.  Build the solution and run the `OrderClient` application. The client will display the following text:  \n  \n    ```Output  \n    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...  \n    ```  \n  \n6.  To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.  \n  \n    1.  In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**. In the **Results** pane verify you see at least one instance listed. There may be other instances from prior runs if an exception occurred while running. You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**.  To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client. Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.  \n  \n7.  Press enter to send the add item message to the workflow service. The client will display the following text:  \n  \n    ```Output  \n    Sending add item messageService returned: Item added to orderPress any key to continue . . .  \n    ```  \n  \n## See Also  \n [Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)","nodes":[{"pos":[12,69],"content":"Creating a Long-running Workflow Service | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Creating a Long-running Workflow Service | Microsoft Docs","pos":[0,57]}]},{"pos":[367,407],"content":"Creating a Long-running Workflow Service","linkify":"Creating a Long-running Workflow Service","nodes":[{"content":"Creating a Long-running Workflow Service","pos":[0,40]}]},{"content":"This topic describes how to create a long-running workflow service.","pos":[408,475]},{"content":"Long running workflow services may run for long periods of time.","pos":[476,540]},{"content":"At some point the workflow may go idle waiting for some additional information.","pos":[541,620]},{"content":"When this occurs the workflow is persisted to a SQL database and is removed from memory.","pos":[621,709]},{"content":"When the additional information becomes available the workflow instance is loaded back into memory and continues executing.","pos":[710,833]},{"content":"In this scenario you are implementing a very simplified ordering system.","pos":[835,907]},{"content":"The client sends an initial message to the workflow service to start the order.","pos":[909,988]},{"content":"It returns an order ID to the client.","pos":[989,1026]},{"content":"At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.","pos":[1027,1180]},{"content":"When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order.","pos":[1182,1321]},{"content":"In the code sample it returns a string stating the item has been added to the order.","pos":[1322,1406]},{"content":"The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services.","pos":[1407,1561]},{"content":"This topic assumes you know how to create <ph id=\"ph1\">[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]</ph> projects and solutions.","pos":[1562,1699],"source":" This topic assumes you know how to create [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] projects and solutions."},{"pos":[1708,1721],"content":"Prerequisites","linkify":"Prerequisites","nodes":[{"content":"Prerequisites","pos":[0,13]}]},{"content":"You must have the following software installed to use this walkthrough:","pos":[1725,1796]},{"content":"Microsoft SQL Server 2008","pos":[1806,1831]},{"pos":[1922,2010],"content":"Microsoft  <ph id=\"ph1\">[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</ph>","source":"Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]"},{"pos":[2020,2164],"content":"You are familiar with WCF and <ph id=\"ph1\">[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]</ph> and know how to create projects/solutions.","source":"You are familiar with WCF and [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] and know how to create projects/solutions."},{"pos":[2174,2199],"content":"To Setup the SQL Database","linkify":"To Setup the SQL Database","nodes":[{"content":"To Setup the SQL Database","pos":[0,25]}]},{"content":"In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances.","pos":[2209,2386]},{"content":"Run Microsoft SQL Management Studio by clicking the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button, selecting <bpt id=\"p2\">**</bpt>All Programs<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Microsoft SQL Server 2008<ept id=\"p3\">**</ept>, and <bpt id=\"p4\">**</bpt>Microsoft SQL Management Studio<ept id=\"p4\">**</ept>.","pos":[2387,2556],"source":" Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**."},{"pos":[2566,2631],"content":"Click the <bpt id=\"p1\">**</bpt>Connect<ept id=\"p1\">**</ept> button to log on to the SQL Server instance","source":"Click the **Connect** button to log on to the SQL Server instance"},{"content":"Right click <bpt id=\"p1\">**</bpt>Databases<ept id=\"p1\">**</ept> in the tree view and select <bpt id=\"p2\">**</bpt>New Database..<ept id=\"p2\">**</ept>","pos":[2641,2713],"source":"Right click **Databases** in the tree view and select **New Database..**"},{"content":"to create a new database called <ph id=\"ph1\">`SQLPersistenceStore`</ph>.","pos":[2714,2768],"source":" to create a new database called `SQLPersistenceStore`."},{"content":"Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\\Windows\\Microsoft.NET\\Framework\\v4.0\\SQL\\en directory on the SQLPersistenceStore database to set up the needed database schemas.","pos":[2778,2979]},{"content":"Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\\Windows\\Microsoft.NET\\Framework\\v4.0\\SQL\\en directory on the SQLPersistenceStore database to set up the needed database logic.","pos":[2989,3187]},{"pos":[3197,3238],"content":"To Create the Web Hosted Workflow Service","linkify":"To Create the Web Hosted Workflow Service","nodes":[{"content":"To Create the Web Hosted Workflow Service","pos":[0,41]}]},{"pos":[3248,3372],"content":"Create an empty <ph id=\"ph1\">[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]</ph> solution, name it <ph id=\"ph2\">`OrderProcessing`</ph>.","source":"Create an empty [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] solution, name it `OrderProcessing`."},{"pos":[3382,3523],"content":"Add a new <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> Workflow Service Application project called <ph id=\"ph2\">`OrderService`</ph> to the solution.","source":"Add a new [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] Workflow Service Application project called `OrderService` to the solution."},{"pos":[3533,3590],"content":"In the project properties dialog, select the <bpt id=\"p1\">**</bpt>Web<ept id=\"p1\">**</ept> tab.","source":"In the project properties dialog, select the **Web** tab."},{"pos":[3604,3681],"content":"Under <bpt id=\"p1\">**</bpt>Start Action<ept id=\"p1\">**</ept> select <bpt id=\"p2\">**</bpt>Specific Page<ept id=\"p2\">**</ept> and specify <ph id=\"ph1\">`Service1.xamlx`</ph>.","source":"Under **Start Action** select **Specific Page** and specify `Service1.xamlx`."},{"pos":[3696,3822],"content":"<bpt id=\"p1\">![</bpt>Workflow Service Project Web Properties<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/startaction.png \"</bpt>StartAction<ept id=\"p2\">\")</ept>","source":"![Workflow Service Project Web Properties](../../../../docs/framework/wcf/feature-details/media/startaction.png \"StartAction\")"},{"pos":[3836,3890],"content":"Under <bpt id=\"p1\">**</bpt>Servers<ept id=\"p1\">**</ept> select <bpt id=\"p2\">**</bpt>Use Local IIS Web server<ept id=\"p2\">**</ept>.","source":"Under **Servers** select **Use Local IIS Web server**."},{"pos":[3905,4029],"content":"<bpt id=\"p1\">![</bpt>Local Web Server Settings<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/uselocalwebserver.png \"</bpt>UseLocalWebServer<ept id=\"p2\">\")</ept>","source":"![Local Web Server Settings](../../../../docs/framework/wcf/feature-details/media/uselocalwebserver.png \"UseLocalWebServer\")"},{"pos":[4045,4195],"content":"[!WARNING]\nYou must run [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] in administrator mode to make this setting.","leadings":["","        >  "],"nodes":[{"content":"You must run <ph id=\"ph1\">[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]</ph> in administrator mode to make this setting.","pos":[11,139],"source":"You must run [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] in administrator mode to make this setting."}]},{"content":"These two steps configure the workflow service project to be hosted by IIS.","pos":[4210,4285]},{"pos":[4295,4418],"content":"Open <ph id=\"ph1\">`Service1.xamlx`</ph> if it is not open already and delete the existing <bpt id=\"p1\">**</bpt>ReceiveRequest<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>SendResponse<ept id=\"p2\">**</ept> activities.","source":"Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities."},{"content":"Select the <bpt id=\"p1\">**</bpt>Sequential Service<ept id=\"p1\">**</ept> activity and click the <bpt id=\"p2\">**</bpt>Variables<ept id=\"p2\">**</ept> link and add the variables shown in the following illustration.","pos":[4428,4562],"source":"Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration."},{"content":"Doing this adds some variables that will be used later on in the workflow service.","pos":[4563,4645]},{"pos":[4657,4888],"content":"[!NOTE]\nIf CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down. Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.","leadings":["","    >  "],"nodes":[{"content":"If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down. Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.","pos":[8,224],"nodes":[{"content":"If CorrelationHandle is not in the Variable Type drop-down, select <bpt id=\"p1\">**</bpt>Browse for types<ept id=\"p1\">**</ept> from the drop-down.","pos":[0,107],"source":"If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down."},{"content":"Type CorrelationHandle in the <bpt id=\"p1\">**</bpt>Type name<ept id=\"p1\">**</ept> box, select CorrelationHandle from the listbox and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","pos":[108,216],"source":" Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**."}]}]},{"pos":[4899,5001],"content":"<bpt id=\"p1\">![</bpt>Add Variables<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/addvariables.gif \"</bpt>AddVariables<ept id=\"p2\">\")</ept>","source":"![Add Variables](../../../../docs/framework/wcf/feature-details/media/addvariables.gif \"AddVariables\")"},{"content":"Drag and drop a <bpt id=\"p1\">**</bpt>ReceiveAndSendReply<ept id=\"p1\">**</ept> activity template into the <bpt id=\"p2\">**</bpt>Sequential Service<ept id=\"p2\">**</ept> activity.","pos":[5011,5110],"source":"Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity."},{"content":"This set of activities will receive a message from a client and send a reply back.","pos":[5111,5193]},{"pos":[5207,5304],"content":"Select the <bpt id=\"p1\">**</bpt>Receive<ept id=\"p1\">**</ept> activity and set the properties highlighted in the following illustration.","source":"Select the **Receive** activity and set the properties highlighted in the following illustration."},{"pos":[5319,5455],"content":"<bpt id=\"p1\">![</bpt>Set Receive Activity Properties<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/setreceiveproperties.png \"</bpt>SetReceiveProperties<ept id=\"p2\">\")</ept>","source":"![Set Receive Activity Properties](../../../../docs/framework/wcf/feature-details/media/setreceiveproperties.png \"SetReceiveProperties\")"},{"content":"The DisplayName property sets the name displayed for the Receive activity in the designer.","pos":[5470,5560]},{"content":"The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity.","pos":[5561,5714]},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> how contracts are used in Workflow services see <bpt id=\"p1\">[</bpt>Using Contracts in Workflow<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md)</ept>.","pos":[5715,5928],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] how contracts are used in Workflow services see [Using Contracts in Workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md)."},{"content":"Click the <bpt id=\"p1\">**</bpt>Define...<ept id=\"p1\">**</ept> link in the <bpt id=\"p2\">**</bpt>ReceiveStartOrder<ept id=\"p2\">**</ept> activity and set the properties shown in the following illustration.","pos":[5942,6068],"source":"Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration."},{"content":"Notice that the <bpt id=\"p1\">**</bpt>Parameters<ept id=\"p1\">**</ept> radio button is selected, a parameter named <ph id=\"ph1\">`p_customerName`</ph> is bound to the <ph id=\"ph2\">`customerName`</ph> variable.","pos":[6070,6202],"source":"  Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable."},{"content":"This configures the <bpt id=\"p1\">**</bpt>Receive<ept id=\"p1\">**</ept> activity to receive some data and bind that data to local variables.","pos":[6203,6303],"source":" This configures the **Receive** activity to receive some data and bind that data to local variables."},{"pos":[6318,6466],"content":"<bpt id=\"p1\">![</bpt>Setting the data received by the Receive activity<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/setreceivecontent.png \"</bpt>SetReceiveContent<ept id=\"p2\">\")</ept>","source":"![Setting the data received by the Receive activity](../../../../docs/framework/wcf/feature-details/media/setreceivecontent.png \"SetReceiveContent\")"},{"pos":[6480,6592],"content":"Select The <bpt id=\"p1\">**</bpt>SendReplyToReceive<ept id=\"p1\">**</ept> activity and set the highlighted property shown in the following illustration.","source":"Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration."},{"pos":[6607,6756],"content":"<bpt id=\"p1\">![</bpt>Setting the properties of the SendReply activity<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/setreplyproperties.png \"</bpt>SetReplyProperties<ept id=\"p2\">\")</ept>","source":"![Setting the properties of the SendReply activity](../../../../docs/framework/wcf/feature-details/media/setreplyproperties.png \"SetReplyProperties\")"},{"content":"Click the <bpt id=\"p1\">**</bpt>Define...<ept id=\"p1\">**</ept> link in the <bpt id=\"p2\">**</bpt>SendReplyToStartOrder<ept id=\"p2\">**</ept> activity and set the properties shown in the following illustration.","pos":[6770,6900],"source":"Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration."},{"content":"Notice that the <bpt id=\"p1\">**</bpt>Parameters<ept id=\"p1\">**</ept> radio button is selected; a parameter named <ph id=\"ph1\">`p_orderId`</ph> is bound to the <ph id=\"ph2\">`orderId`</ph> variable.","pos":[6901,7023],"source":" Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable."},{"content":"This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.","pos":[7024,7136]},{"pos":[7151,7293],"content":"<bpt id=\"p1\">![</bpt>Configuring the SendReply activity content data<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/setreplycontent.png \"</bpt>SetReplyContent<ept id=\"p2\">\")</ept>","source":"![Configuring the SendReply activity content data](../../../../docs/framework/wcf/feature-details/media/setreplycontent.png \"SetReplyContent\")"},{"pos":[7307,7458],"content":"Drag and drop an Assign activity in between the <bpt id=\"p1\">**</bpt>Receive<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>SendReply<ept id=\"p2\">**</ept> activities and set the properties as shown in the following illustration:","source":"Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:"},{"pos":[7473,7581],"content":"<bpt id=\"p1\">![</bpt>Adding an assign activity<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/addassign.png \"</bpt>AddAssign<ept id=\"p2\">\")</ept>","source":"![Adding an assign activity](../../../../docs/framework/wcf/feature-details/media/addassign.png \"AddAssign\")"},{"content":"This creates a new order ID and places the value in the orderId variable.","pos":[7596,7669]},{"content":"Select the <bpt id=\"p1\">**</bpt>ReplyToStartOrder<ept id=\"p1\">**</ept> activity.","pos":[7683,7725],"source":"Select the **ReplyToStartOrder** activity."},{"content":"In the properties window click the ellipsis button for <bpt id=\"p1\">**</bpt>CorrelationInitializers<ept id=\"p1\">**</ept>.","pos":[7726,7809],"source":" In the properties window click the ellipsis button for **CorrelationInitializers**."},{"content":"Select the <bpt id=\"p1\">**</bpt>Add initializer<ept id=\"p1\">**</ept> link, enter <ph id=\"ph1\">`orderIdHandle`</ph> in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box.","pos":[7810,8019],"source":" Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box."},{"content":"These settings are shown in the following illustration.","pos":[8020,8075]},{"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","pos":[8076,8089],"source":" Click **OK**."},{"content":"This initializes a correlation between the client and this instance of the workflow service.","pos":[8091,8183]},{"content":"When a message containing this order ID is received it is routed to this instance of the workflow service.","pos":[8184,8290]},{"pos":[8305,8454],"content":"<bpt id=\"p1\">![</bpt>Adding a correlation initializer<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/addcorrelationinitializers.png \"</bpt>AddCorrelationInitializers<ept id=\"p2\">\")</ept>","source":"![Adding a correlation initializer](../../../../docs/framework/wcf/feature-details/media/addcorrelationinitializers.png \"AddCorrelationInitializers\")"},{"content":"Drag and drop another <bpt id=\"p1\">**</bpt>ReceiveAndSendReply<ept id=\"p1\">**</ept> activity to the end of the workflow (outside the <bpt id=\"p2\">**</bpt>Sequence<ept id=\"p2\">**</ept> containing the first <bpt id=\"p3\">**</bpt>Receive<ept id=\"p3\">**</ept> and <bpt id=\"p4\">**</bpt>SendReply<ept id=\"p4\">**</ept> activities).","pos":[8464,8635],"source":"Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities)."},{"content":"This will receive the second message sent by the client and respond to it.","pos":[8636,8710]},{"content":"Select the <bpt id=\"p1\">**</bpt>Sequence<ept id=\"p1\">**</ept> that contains the newly added <bpt id=\"p2\">**</bpt>Receive<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>SendReply<ept id=\"p3\">**</ept> activities and click the <bpt id=\"p4\">**</bpt>Variables<ept id=\"p4\">**</ept> button.","pos":[8724,8854],"source":"Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button."},{"content":"Add the variable highlighted in the following illustration:","pos":[8855,8914]},{"pos":[8929,9058],"content":"<bpt id=\"p1\">![</bpt>Adding new variables<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/addorderitemidvariable.png \"</bpt>AddOrderItemIdVariable<ept id=\"p2\">\")</ept>","source":"![Adding new variables](../../../../docs/framework/wcf/feature-details/media/addorderitemidvariable.png \"AddOrderItemIdVariable\")"},{"pos":[9072,9163],"content":"Select the <bpt id=\"p1\">**</bpt>Receive<ept id=\"p1\">**</ept> activity and set the properties shown in the following illustration:","source":"Select the **Receive** activity and set the properties shown in the following illustration:"},{"pos":[9178,9321],"content":"<bpt id=\"p1\">![</bpt>Set the Receive acitivity properties<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/setreceiveproperties2.png \"</bpt>SetReceiveProperties2<ept id=\"p2\">\")</ept>","source":"![Set the Receive acitivity properties](../../../../docs/framework/wcf/feature-details/media/setreceiveproperties2.png \"SetReceiveProperties2\")"},{"pos":[9335,9571],"content":"Click the <bpt id=\"p1\">**</bpt>Define...<ept id=\"p1\">**</ept> link in the <bpt id=\"p2\">**</bpt>ReceiveAddItem<ept id=\"p2\">**</ept> activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.","source":"Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered."},{"pos":[9586,9737],"content":"<bpt id=\"p1\">![</bpt>Specifying parameters for the second receive<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/addreceive2parameters.png \"</bpt>AddReceive2Parameters<ept id=\"p2\">\")</ept>","source":"![Specifying parameters for the second receive](../../../../docs/framework/wcf/feature-details/media/addreceive2parameters.png \"AddReceive2Parameters\")"},{"content":"Click the <bpt id=\"p1\">**</bpt>CorrelateOn<ept id=\"p1\">**</ept> ellipsis button and enter <ph id=\"ph1\">`orderIdHandle`</ph>.","pos":[9751,9819],"source":"Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`."},{"content":"Under <bpt id=\"p1\">**</bpt>XPath Queries<ept id=\"p1\">**</ept>, click the drop down arrow and select <ph id=\"ph1\">`p_orderId`</ph>.","pos":[9820,9894],"source":" Under **XPath Queries**, click the drop down arrow and select `p_orderId`."},{"content":"This configures the correlation on the second receive activity.","pos":[9895,9958]},{"content":"<ph id=\"ph1\">[!INCLUDE[crabout](../../../../includes/crabout-md.md)]</ph> correlation see <bpt id=\"p1\">[</bpt>Correlation<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/correlation.md)</ept>.","pos":[9959,10108],"source":"[!INCLUDE[crabout](../../../../includes/crabout-md.md)] correlation see [Correlation](../../../../docs/framework/wcf/feature-details/correlation.md)."},{"pos":[10123,10245],"content":"<bpt id=\"p1\">![</bpt>Setting the CorrelatesOn property<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/correlateson.png \"</bpt>CorrelatesOn<ept id=\"p2\">\")</ept>","source":"![Setting the CorrelatesOn property](../../../../docs/framework/wcf/feature-details/media/correlateson.png \"CorrelatesOn\")"},{"content":"Drag and drop an <bpt id=\"p1\">**</bpt>If<ept id=\"p1\">**</ept> activity immediately after the <bpt id=\"p2\">**</bpt>ReceiveAddItem<ept id=\"p2\">**</ept> activity.","pos":[10259,10342],"source":"Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity."},{"content":"This activity acts just like an if statement.","pos":[10343,10388]},{"pos":[10406,10495],"content":"Set the <bpt id=\"p1\">**</bpt>Condition<ept id=\"p1\">**</ept> property to <ph id=\"ph1\">`itemId==\"Zune HD\" (itemId=\"Zune HD\" for Visual Basic)`</ph>","source":"Set the **Condition** property to `itemId==\"Zune HD\" (itemId=\"Zune HD\" for Visual Basic)`"},{"pos":[10513,10702],"content":"Drag and drop an <bpt id=\"p1\">**</bpt>Assign<ept id=\"p1\">**</ept> activity in to the <bpt id=\"p2\">**</bpt>Then<ept id=\"p2\">**</ept> section and another into the <bpt id=\"p3\">**</bpt>Else<ept id=\"p3\">**</ept> section set the properties of the <bpt id=\"p4\">**</bpt>Assign<ept id=\"p4\">**</ept> activities as shown in the following illustration.","source":"Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration."},{"pos":[10721,10850],"content":"<bpt id=\"p1\">![</bpt>Assigning the result of the service call<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/resultassign.png \"</bpt>ResultAssign<ept id=\"p2\">\")</ept>","source":"![Assigning the result of the service call](../../../../docs/framework/wcf/feature-details/media/resultassign.png \"ResultAssign\")"},{"content":"If the condition is <ph id=\"ph1\">`true`</ph> the <bpt id=\"p1\">**</bpt>Then<ept id=\"p1\">**</ept> section will be executed.","pos":[10869,10934],"source":"If the condition is `true` the **Then** section will be executed."},{"content":"If the condition is <ph id=\"ph1\">`false`</ph> the <bpt id=\"p1\">**</bpt>Else<ept id=\"p1\">**</ept> section is executed.","pos":[10935,10996],"source":" If the condition is `false` the **Else** section is executed."},{"pos":[11014,11130],"content":"Select the <bpt id=\"p1\">**</bpt>SendReplyToReceive<ept id=\"p1\">**</ept> activity and set the <bpt id=\"p2\">**</bpt>DisplayName<ept id=\"p2\">**</ept> property shown in the following illustration.","source":"Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration."},{"pos":[11149,11293],"content":"<bpt id=\"p1\">![</bpt>Setting the SendReply activity properties<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/setreply2properties.png \"</bpt>SetReply2Properties<ept id=\"p2\">\")</ept>","source":"![Setting the SendReply activity properties](../../../../docs/framework/wcf/feature-details/media/setreply2properties.png \"SetReply2Properties\")"},{"content":"Click the <bpt id=\"p1\">**</bpt>Define ...<ept id=\"p1\">**</ept> link in the <bpt id=\"p2\">**</bpt>SetReplyToAddItem<ept id=\"p2\">**</ept> activity and configure it as shown in the following illustration.","pos":[11311,11435],"source":"Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration."},{"content":"This configures the <bpt id=\"p1\">**</bpt>SendReplyToAddItem<ept id=\"p1\">**</ept> activity to return the value in the <ph id=\"ph1\">`orderResult`</ph> variable.","pos":[11436,11538],"source":" This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable."},{"pos":[11557,11714],"content":"<bpt id=\"p1\">![</bpt>Setting the data binding for the SendReply activit<ept id=\"p1\">]</ept><bpt id=\"p2\">(../../../../docs/framework/wcf/feature-details/media/replytoadditemcontent.gif \"</bpt>ReplyToAddItemContent<ept id=\"p2\">\")</ept>","source":"![Setting the data binding for the SendReply activit](../../../../docs/framework/wcf/feature-details/media/replytoadditemcontent.gif \"ReplyToAddItemContent\")"},{"content":"Open the web.config file and add the following elements in the <ph id=\"ph1\">\\&lt;</ph>behavior&gt; section to enable workflow persistence.","pos":[11724,11838],"source":"Open the web.config file and add the following elements in the \\<behavior> section to enable workflow persistence."},{"pos":[12295,12402],"content":"[!WARNING]\nMake sure to replace your host and SQL server instance name in the previous code snippet.","leadings":["","    >  "],"nodes":[{"content":"Make sure to replace your host and SQL server instance name in the previous code snippet.","pos":[11,100]}]},{"content":"Build the solution.","pos":[12411,12430]},{"pos":[12440,12499],"content":"To Create a Client Application to Call the Workflow Service","linkify":"To Create a Client Application to Call the Workflow Service","nodes":[{"content":"To Create a Client Application to Call the Workflow Service","pos":[0,59]}]},{"pos":[12509,12584],"content":"Add a new Console application project called <ph id=\"ph1\">`OrderClient`</ph> to the solution.","source":"Add a new Console application project called `OrderClient` to the solution."},{"pos":[12594,12665],"content":"Add references to the following assemblies to the <ph id=\"ph1\">`OrderClient`</ph> project","source":"Add references to the following assemblies to the `OrderClient` project"},{"content":"System.ServiceModel.dll","pos":[12679,12702]},{"content":"System.ServiceModel.Activities.dll","pos":[12716,12750]},{"pos":[12760,12852],"content":"Add a service reference to the workflow service and specify <ph id=\"ph1\">`OrderService`</ph> as the namespace.","source":"Add a service reference to the workflow service and specify `OrderService` as the namespace."},{"pos":[12862,12930],"content":"In the <ph id=\"ph1\">`Main()`</ph> method of the client project add the following code:","source":"In the `Main()` method of the client project add the following code:"},{"content":"Build the solution and run the <ph id=\"ph1\">`OrderClient`</ph> application.","pos":[13932,13989],"source":"Build the solution and run the `OrderClient` application."},{"content":"The client will display the following text:","pos":[13990,14033]},{"pos":[14206,14425],"content":"To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> menu, Selecting <bpt id=\"p2\">**</bpt>All Programs<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Microsoft SQL Server 2008<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>SQL Server Management Studio<ept id=\"p4\">**</ept>.","source":"To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**."},{"content":"In the left hand pane expand, <bpt id=\"p1\">**</bpt>Databases<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>SQLPersistenceStore<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Views<ept id=\"p3\">**</ept> and right click <bpt id=\"p4\">**</bpt>System.Activities.DurableInstancing.Instances<ept id=\"p4\">**</ept> and select <bpt id=\"p5\">**</bpt>Select Top 1000 Rows<ept id=\"p5\">**</ept>.","pos":[14439,14621],"source":"In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**."},{"content":"In the <bpt id=\"p1\">**</bpt>Results<ept id=\"p1\">**</ept> pane verify you see at least one instance listed.","pos":[14622,14690],"source":" In the **Results** pane verify you see at least one instance listed."},{"content":"There may be other instances from prior runs if an exception occurred while running.","pos":[14691,14775]},{"content":"You can delete existing rows by right clicking <bpt id=\"p1\">**</bpt>System.Activities.DurableInstancing.Instances<ept id=\"p1\">**</ept> and selecting <bpt id=\"p2\">**</bpt>Edit Top 200 rows<ept id=\"p2\">**</ept>, pressing the <bpt id=\"p3\">**</bpt>Execute<ept id=\"p3\">**</ept> button, selecting all rows in the results pane and selecting <bpt id=\"p4\">**</bpt>delete<ept id=\"p4\">**</ept>.","pos":[14776,15007],"source":" You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**."},{"content":"To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client.","pos":[15009,15163]},{"content":"Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.","pos":[15164,15272]},{"content":"Press enter to send the add item message to the workflow service.","pos":[15282,15347]},{"content":"The client will display the following text:","pos":[15348,15391]},{"pos":[15528,15536],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[15540,15628],"content":"<bpt id=\"p1\">[</bpt>Workflow Services<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/workflow-services.md)</ept>","source":"[Workflow Services](../../../../docs/framework/wcf/feature-details/workflow-services.md)"}]}