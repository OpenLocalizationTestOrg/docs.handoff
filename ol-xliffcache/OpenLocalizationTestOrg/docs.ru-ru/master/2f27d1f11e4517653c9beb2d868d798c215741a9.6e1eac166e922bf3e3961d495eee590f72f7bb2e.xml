{"content":"---\ntitle: \"How to: Write a Parallel.ForEach loop with partition-local variables\"\nms.date: \"06/26/2018\"\nms.technology: dotnet-standard\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"parallel foreach loop, how to use local state\"\nms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# How to: Write a Parallel.ForEach loop with partition-local variables\nThe following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses partition-local variables. When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions. Each partition has its own copy of the partition-local variable. A partition-local variable is similar to a [thread-local variable](xref:System.Threading.ThreadLocal%601), except that multiple partitions can run on a single thread.\n  \n The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method. For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).  \n  \n To use a partition-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters. The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the partition-local variable.  \n  \n## Example  \n The following example calls the <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements. This overload has four parameters:  \n  \n-   `source`, which is the data source. It must implement <xref:System.Collections.Generic.IEnumerable%601>. The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.  \n  \n-   `localInit`, or the function that initializes the partition-local variable. This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes. Our example initializes the partition-local variable to zero.  \n  \n-   `body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop. Its signature is `Func\\<TSource, ParallelLoopState, TLocal, TLocal>`. You supply the code for the delegate, and the loop passes in the input parameters, which are:  \n  \n    -   The current element of the <xref:System.Collections.Generic.IEnumerable%601>.\n  \n    -   A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.  \n  \n    -   The partition-local variable.  \n  \n     Your delegate returns the partition-local variable, which is then passed to the next iteration of the loop that executes in that particular partition. Each loop partition maintains a separate instance of this variable.  \n  \n     In the example, the delegate adds the value of each integer to the partition-local variable, which maintains a running total of the values of the integer elements in that partition.  \n  \n-   `localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed. The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the partition-local variable for this loop partition, and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions. This delegate can be invoked concurrently by multiple tasks. Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable. Because the delegate type is an <xref:System.Action%601>, there is no return value.  \n  \n [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]\n [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  \n  \n## See also\n\n- [Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)\n- [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)\n- [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)\n","nodes":[{"pos":[4,331],"embed":true,"restype":"x-metadata","content":"title: \"How to: Write a Parallel.ForEach loop with partition-local variables\"\nms.date: \"06/26/2018\"\nms.technology: dotnet-standard\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"parallel foreach loop, how to use local state\"\nms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"How to: Write a Parallel.ForEach loop with partition-local variables","nodes":[{"pos":[0,68],"content":"How to: Write a Parallel.ForEach loop with partition-local variables","nodes":[{"content":"How to: Write a Parallel.ForEach loop with partition-local variables","pos":[0,68]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[338,406],"content":"How to: Write a Parallel.ForEach loop with partition-local variables","linkify":"How to: Write a Parallel.ForEach loop with partition-local variables","nodes":[{"content":"How to: Write a Parallel.ForEach loop with partition-local variables","pos":[0,68]}]},{"content":"The following example shows how to write a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A&gt;</ph> method that uses partition-local variables.","pos":[407,543],"source":"The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses partition-local variables."},{"content":"When a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A&gt;</ph> loop executes, it divides its source collection into multiple partitions.","pos":[544,674],"source":" When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions."},{"content":"Each partition has its own copy of the partition-local variable.","pos":[675,739]},{"content":"A partition-local variable is similar to a <bpt id=\"p1\">[</bpt>thread-local variable<ept id=\"p1\">](xref:System.Threading.ThreadLocal%601)</ept>, except that multiple partitions can run on a single thread.","pos":[740,906],"source":" A partition-local variable is similar to a [thread-local variable](xref:System.Threading.ThreadLocal%601), except that multiple partitions can run on a single thread."},{"content":"The code and parameters in this example closely resemble the corresponding <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.For%2A&gt;</ph> method.","pos":[911,1039],"source":"The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>How to: Write a Parallel.For Loop with Thread-Local Variables<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)</ept>.","pos":[1040,1239],"source":" For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)."},{"content":"To use a partition-local variable in a <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A&gt;</ph> loop, you must call one of the method overloads that takes two type parameters.","pos":[1246,1414],"source":"To use a partition-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters."},{"content":"The first type parameter, <ph id=\"ph1\">`TSource`</ph>, specifies the type of the source element, and the second type parameter, <ph id=\"ph2\">`TLocal`</ph>, specifies the type of the partition-local variable.","pos":[1415,1586],"source":" The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the partition-local variable."},{"pos":[1595,1602],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following example calls the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType&gt;</ph> overload to compute the sum of an array of one million elements.","pos":[1606,1988],"source":"The following example calls the <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements."},{"content":"This overload has four parameters:","pos":[1989,2023]},{"content":"<ph id=\"ph1\">`source`</ph>, which is the data source.","pos":[2033,2068],"source":"`source`, which is the data source."},{"content":"It must implement <ph id=\"ph1\">&lt;xref:System.Collections.Generic.IEnumerable%601&gt;</ph>.","pos":[2069,2137],"source":" It must implement <xref:System.Collections.Generic.IEnumerable%601>."},{"content":"The data source in our example is the one million member <ph id=\"ph1\">`IEnumerable&lt;Int32&gt;`</ph> object returned by the <ph id=\"ph2\">&lt;xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType&gt;</ph> method.","pos":[2138,2314],"source":" The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method."},{"content":"<ph id=\"ph1\">`localInit`</ph>, or the function that initializes the partition-local variable.","pos":[2324,2399],"source":"`localInit`, or the function that initializes the partition-local variable."},{"content":"This function is called once for each partition in which the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType&gt;</ph> operation executes.","pos":[2400,2559],"source":" This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes."},{"content":"Our example initializes the partition-local variable to zero.","pos":[2560,2621]},{"content":"<ph id=\"ph1\">`body`</ph>, a <ph id=\"ph2\">&lt;xref:System.Func%604&gt;</ph> that is invoked by the parallel loop on each iteration of the loop.","pos":[2631,2731],"source":"`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop."},{"content":"Its signature is <ph id=\"ph1\">`Func\\&lt;TSource, ParallelLoopState, TLocal, TLocal&gt;`</ph>.","pos":[2732,2801],"source":" Its signature is `Func\\<TSource, ParallelLoopState, TLocal, TLocal>`."},{"content":"You supply the code for the delegate, and the loop passes in the input parameters, which are:","pos":[2802,2895]},{"pos":[2909,2986],"content":"The current element of the <ph id=\"ph1\">&lt;xref:System.Collections.Generic.IEnumerable%601&gt;</ph>.","source":"The current element of the <xref:System.Collections.Generic.IEnumerable%601>."},{"pos":[2998,3131],"content":"A <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.ParallelLoopState&gt;</ph> variable that you can use in your delegate's code to examine the state of the loop.","source":"A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop."},{"content":"The partition-local variable.","pos":[3145,3174]},{"content":"Your delegate returns the partition-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.","pos":[3185,3335]},{"content":"Each loop partition maintains a separate instance of this variable.","pos":[3336,3403]},{"content":"In the example, the delegate adds the value of each integer to the partition-local variable, which maintains a running total of the values of the integer elements in that partition.","pos":[3414,3595]},{"content":"<ph id=\"ph1\">`localFinally`</ph>, an <ph id=\"ph2\">`Action&lt;TLocal&gt;`</ph> delegate that the <ph id=\"ph3\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType&gt;</ph> invokes when the looping operations in each partition have completed.","pos":[3605,3807],"source":"`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType&gt;</ph> method passes your <ph id=\"ph2\">`Action&lt;TLocal&gt;`</ph> delegate the final value of the partition-local variable for this loop partition, and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.","pos":[3808,4156],"source":" The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the partition-local variable for this loop partition, and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions."},{"content":"This delegate can be invoked concurrently by multiple tasks.","pos":[4157,4217]},{"content":"Because of this, the example uses the <ph id=\"ph1\">&lt;xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType&gt;</ph> method to synchronize access to the <ph id=\"ph2\">`total`</ph> variable.","pos":[4218,4414],"source":" Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable."},{"content":"Because the delegate type is an <ph id=\"ph1\">&lt;xref:System.Action%601&gt;</ph>, there is no return value.","pos":[4415,4498],"source":" Because the delegate type is an <xref:System.Action%601>, there is no return value."},{"pos":[4505,4754],"content":"[!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]\n[!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]","leadings":[""," "],"nodes":[]},{"pos":[4763,4771],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[4775,4880],"content":"<bpt id=\"p1\">[</bpt>Data Parallelism<ept id=\"p1\">](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)</ept>","source":"[Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)"},{"pos":[4883,5055],"content":"<bpt id=\"p1\">[</bpt>How to: Write a Parallel.For Loop with Thread-Local Variables<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)</ept>","source":"[How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)"},{"pos":[5058,5179],"content":"<bpt id=\"p1\">[</bpt>Lambda Expressions in PLINQ and TPL<ept id=\"p1\">](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)</ept>","source":"[Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)"}]}