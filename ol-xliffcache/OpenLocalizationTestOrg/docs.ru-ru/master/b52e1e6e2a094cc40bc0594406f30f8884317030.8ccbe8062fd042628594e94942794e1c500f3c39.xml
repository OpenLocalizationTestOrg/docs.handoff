{"content":"---\ntitle: \"How to: Create a Custom Security Token Provider | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"security [WCF], providing credentials\"\nms.assetid: db8cb478-aa43-478b-bf97-c6489ad7c7fd\ncaps.latest.revision: 10\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"\n---\n# How to: Create a Custom Security Token Provider\nThis topic shows how to create new token types with a custom security token provider and how to integrate the provider with a custom security token manager.  \n  \n> [!NOTE]\n>  Create a custom token provider if the system-provided tokens found in the <xref:System.IdentityModel.Tokens> namespace do not match your requirements.  \n  \n The security token provider creates a security token representation based on information in the client or service credentials. To use the custom security token provider in [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] security, you must create custom credentials and security token manager implementations.  \n  \n For more information about custom credentials and security token manager see the [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).  \n  \n For more information about credentials, security token manager, provider and authenticator classes, see the [Security Architecture](http://msdn.microsoft.com/en-us/16593476-d36a-408d-808c-ae6fd483e28f).  \n  \n### To create a custom security token provider  \n  \n1.  Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.  \n  \n2.  Implement the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%28System.TimeSpan%29> method. The method is responsible for creating and returning an instance of the security token. The following example creates a class named `MySecurityTokenProvider`, and overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%28System.TimeSpan%29> method to return an instance of the <xref:System.IdentityModel.Tokens.X509SecurityToken> class. The class constructor requires an instance of the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class.  \n  \n     [!code-csharp[c_CustomTokenProvider#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#1)]\n     [!code-vb[c_CustomTokenProvider#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#1)]  \n  \n### To integrate a custom security token provider with a custom security token manager  \n  \n1.  Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenManager> class. (The example below derives from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class, which derives from the <xref:System.IdentityModel.Selectors.SecurityTokenManager> class.)  \n  \n2.  Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenProvider%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method if is not already overridden.  \n  \n     The <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenProvider%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method is responsible for returning an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class appropriate to the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter passed to the method by the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] security framework. Modify the method to return the custom security token provider implementation (created in the previous procedure) when the method is called with an appropriate security token parameter. For more information about the security token manager, see the [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).  \n  \n3.  Add custom logic to the method to enable it to return your custom security token provider based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter. The following sample returns the custom security token provider if the token requirements are met. The requirements include an X.509 security token and the message direction (that the token is used for message output). For all other cases, the code calls the base class to maintain the system-provided behavior for other security token requirements.  \n  \n [!code-csharp[c_CustomTokenProvider#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#2)]\n [!code-vb[c_CustomTokenProvider#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#2)]  \n  \n## Example  \n The following shows a complete <xref:System.IdentityModel.Selectors.SecurityTokenProvider> implementation along with a corresponding <xref:System.IdentityModel.Selectors.SecurityTokenManager> implementation.  \n  \n [!code-csharp[c_CustomTokenProvider#0](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#0)]\n [!code-vb[c_CustomTokenProvider#0](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#0)]  \n  \n## See Also  \n <xref:System.IdentityModel.Selectors.SecurityTokenProvider>   \n <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>   \n <xref:System.IdentityModel.Selectors.SecurityTokenManager>   \n <xref:System.IdentityModel.Tokens.X509SecurityToken>   \n [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)   \n [How to: Create a Custom Security Token Authenticator](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md)   \n [Security Architecture](http://msdn.microsoft.com/en-us/16593476-d36a-408d-808c-ae6fd483e28f)","nodes":[{"pos":[4,445],"nodes":[{"content":"How to: Create a Custom Security Token Provider | Microsoft Docs","nodes":[{"pos":[0,64],"content":"How to: Create a Custom Security Token Provider | Microsoft Docs","nodes":[{"content":"How to: Create a Custom Security Token Provider | Microsoft Docs","pos":[0,64]}]}],"pos":[6,73],"yaml":true}],"content":"title: \"How to: Create a Custom Security Token Provider | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nhelpviewer_keywords: \n  - \"security [WCF], providing credentials\"\nms.assetid: db8cb478-aa43-478b-bf97-c6489ad7c7fd\ncaps.latest.revision: 10\nauthor: \"BrucePerlerMS\"\nms.author: \"bruceper\"\nmanager: \"mbaldwin\"","yamlblock":true},{"pos":[452,499],"content":"How to: Create a Custom Security Token Provider","linkify":"How to: Create a Custom Security Token Provider","nodes":[{"content":"How to: Create a Custom Security Token Provider","pos":[0,47]}]},{"content":"This topic shows how to create new token types with a custom security token provider and how to integrate the provider with a custom security token manager.","pos":[500,656]},{"pos":[664,825],"content":"[!NOTE]\n Create a custom token provider if the system-provided tokens found in the <xref:System.IdentityModel.Tokens> namespace do not match your requirements.","leadings":["","> "],"nodes":[{"content":"Create a custom token provider if the system-provided tokens found in the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens&gt;</ph> namespace do not match your requirements.","pos":[9,159],"source":"Create a custom token provider if the system-provided tokens found in the <xref:System.IdentityModel.Tokens> namespace do not match your requirements."}]},{"content":"The security token provider creates a security token representation based on information in the client or service credentials.","pos":[832,958]},{"content":"To use the custom security token provider in <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> security, you must create custom credentials and security token manager implementations.","pos":[959,1148],"source":" To use the custom security token provider in [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] security, you must create custom credentials and security token manager implementations."},{"pos":[1155,1402],"content":"For more information about custom credentials and security token manager see the <bpt id=\"p1\">[</bpt>Walkthrough: Creating Custom Client and Service Credentials<ept id=\"p1\">](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)</ept>.","source":"For more information about custom credentials and security token manager see the [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)."},{"pos":[1409,1611],"content":"For more information about credentials, security token manager, provider and authenticator classes, see the <bpt id=\"p1\">[</bpt>Security Architecture<ept id=\"p1\">](http://msdn.microsoft.com/en-us/16593476-d36a-408d-808c-ae6fd483e28f)</ept>.","source":"For more information about credentials, security token manager, provider and authenticator classes, see the [Security Architecture](http://msdn.microsoft.com/en-us/16593476-d36a-408d-808c-ae6fd483e28f)."},{"pos":[1621,1663],"content":"To create a custom security token provider","linkify":"To create a custom security token provider","nodes":[{"content":"To create a custom security token provider","pos":[0,42]}]},{"content":"Define a new class derived from the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenProvider&gt;</ph> class.","pos":[1673,1775],"source":"Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class."},{"content":"Implement the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%28System.TimeSpan%29&gt;</ph> method.","pos":[1785,1900],"source":"Implement the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%28System.TimeSpan%29> method."},{"content":"The method is responsible for creating and returning an instance of the security token.","pos":[1901,1988]},{"content":"The following example creates a class named <ph id=\"ph1\">`MySecurityTokenProvider`</ph>, and overrides the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%28System.TimeSpan%29&gt;</ph> method to return an instance of the <ph id=\"ph3\">&lt;xref:System.IdentityModel.Tokens.X509SecurityToken&gt;</ph> class.","pos":[1989,2267],"source":" The following example creates a class named `MySecurityTokenProvider`, and overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%28System.TimeSpan%29> method to return an instance of the <xref:System.IdentityModel.Tokens.X509SecurityToken> class."},{"content":"The class constructor requires an instance of the <ph id=\"ph1\">&lt;xref:System.Security.Cryptography.X509Certificates.X509Certificate2&gt;</ph> class.","pos":[2268,2394],"source":" The class constructor requires an instance of the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class."},{"pos":[2405,2670],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>c_CustomTokenProvider#1<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#1)</ept><ept id=\"p1\">]</ept>  <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>c_CustomTokenProvider#1<ept id=\"p4\">](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#1)</ept><ept id=\"p3\">]</ept>","leadings":["","    "],"source":"[!code-csharp[c_CustomTokenProvider#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#1)]\n [!code-vb[c_CustomTokenProvider#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#1)]"},{"pos":[2680,2762],"content":"To integrate a custom security token provider with a custom security token manager","linkify":"To integrate a custom security token provider with a custom security token manager","nodes":[{"content":"To integrate a custom security token provider with a custom security token manager","pos":[0,82]}]},{"content":"Define a new class derived from the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager&gt;</ph> class.","pos":[2772,2873],"source":"Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenManager> class."},{"content":"(The example below derives from the <ph id=\"ph1\">&lt;xref:System.ServiceModel.ClientCredentialsSecurityTokenManager&gt;</ph> class, which derives from the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager&gt;</ph> class.)","pos":[2874,3071],"source":" (The example below derives from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class, which derives from the <xref:System.IdentityModel.Selectors.SecurityTokenManager> class.)"},{"content":"Override the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenProvider%28System.IdentityModel.Selectors.SecurityTokenRequirement%29&gt;</ph> method if is not already overridden.","pos":[3081,3278],"source":"Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenProvider%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method if is not already overridden."},{"content":"The <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenProvider%28System.IdentityModel.Selectors.SecurityTokenRequirement%29&gt;</ph> method is responsible for returning an instance of the <ph id=\"ph2\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenProvider&gt;</ph> class appropriate to the <ph id=\"ph3\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenRequirement&gt;</ph> parameter passed to the method by the <ph id=\"ph4\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> security framework.","pos":[3289,3757],"source":"The <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenProvider%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method is responsible for returning an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class appropriate to the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter passed to the method by the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] security framework."},{"content":"Modify the method to return the custom security token provider implementation (created in the previous procedure) when the method is called with an appropriate security token parameter.","pos":[3758,3943]},{"content":"For more information about the security token manager, see the <bpt id=\"p1\">[</bpt>Walkthrough: Creating Custom Client and Service Credentials<ept id=\"p1\">](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)</ept>.","pos":[3944,4173],"source":" For more information about the security token manager, see the [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)."},{"content":"Add custom logic to the method to enable it to return your custom security token provider based on the <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenRequirement&gt;</ph> parameter.","pos":[4183,4359],"source":"Add custom logic to the method to enable it to return your custom security token provider based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter."},{"content":"The following sample returns the custom security token provider if the token requirements are met.","pos":[4360,4458]},{"content":"The requirements include an X.509 security token and the message direction (that the token is used for message output).","pos":[4459,4578]},{"content":"For all other cases, the code calls the base class to maintain the system-provided behavior for other security token requirements.","pos":[4579,4709]},{"pos":[4716,4977],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>c_CustomTokenProvider#2<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#2)</ept><ept id=\"p1\">]</ept> <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>c_CustomTokenProvider#2<ept id=\"p4\">](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#2)</ept><ept id=\"p3\">]</ept>","leadings":[""," "],"source":"[!code-csharp[c_CustomTokenProvider#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#2)]\n[!code-vb[c_CustomTokenProvider#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#2)]"},{"pos":[4986,4993],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following shows a complete <ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenProvider&gt;</ph> implementation along with a corresponding <ph id=\"ph2\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager&gt;</ph> implementation.","pos":[4997,5204],"source":"The following shows a complete <xref:System.IdentityModel.Selectors.SecurityTokenProvider> implementation along with a corresponding <xref:System.IdentityModel.Selectors.SecurityTokenManager> implementation."},{"pos":[5211,5472],"content":"<bpt id=\"p1\">[!code-csharp</bpt><bpt id=\"p2\">[</bpt>c_CustomTokenProvider#0<ept id=\"p2\">](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#0)</ept><ept id=\"p1\">]</ept> <bpt id=\"p3\">[!code-vb</bpt><bpt id=\"p4\">[</bpt>c_CustomTokenProvider#0<ept id=\"p4\">](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#0)</ept><ept id=\"p3\">]</ept>","source":"[!code-csharp[c_CustomTokenProvider#0](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenprovider/cs/source.cs#0)]\n [!code-vb[c_CustomTokenProvider#0](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenprovider/vb/source.vb#0)]"},{"pos":[5481,5489],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenProvider&gt;</ph>","pos":[5493,5552],"source":"<xref:System.IdentityModel.Selectors.SecurityTokenProvider> "},{"content":"<ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenRequirement&gt;</ph>","pos":[5557,5619],"source":"<xref:System.IdentityModel.Selectors.SecurityTokenRequirement> "},{"content":"<ph id=\"ph1\">&lt;xref:System.IdentityModel.Selectors.SecurityTokenManager&gt;</ph>","pos":[5624,5682],"source":"<xref:System.IdentityModel.Selectors.SecurityTokenManager> "},{"content":"<ph id=\"ph1\">&lt;xref:System.IdentityModel.Tokens.X509SecurityToken&gt;</ph>","pos":[5687,5739],"source":"<xref:System.IdentityModel.Tokens.X509SecurityToken> "},{"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Creating Custom Client and Service Credentials<ept id=\"p1\">](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)</ept><ph id=\"ph1\"> </ph>","pos":[5744,5910],"source":"[Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md) "},{"content":"<bpt id=\"p1\">[</bpt>How to: Create a Custom Security Token Authenticator<ept id=\"p1\">](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md)</ept><ph id=\"ph1\"> </ph>","pos":[5914,6066],"source":"[How to: Create a Custom Security Token Authenticator](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md) "},{"content":"<bpt id=\"p1\">[</bpt>Security Architecture<ept id=\"p1\">](http://msdn.microsoft.com/en-us/16593476-d36a-408d-808c-ae6fd483e28f)</ept>","pos":[6070,6163],"source":"[Security Architecture](http://msdn.microsoft.com/en-us/16593476-d36a-408d-808c-ae6fd483e28f)"}]}