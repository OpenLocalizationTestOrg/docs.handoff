{"content":"---\ntitle: \"Persisting a Workflow Application | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: abcff14c-f047-4195-ba26-d27f4a82c24e\ncaps.latest.revision: 15\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Persisting a Workflow Application\nThis sample demonstrates how to run a <xref:System.Activities.WorkflowApplication>, unload it when it goes idle, and then reload it to continue its execution.  \n  \n## Sample Details  \n <xref:System.Activities.WorkflowApplication> is a host for a single workflow instance that provides a simple interface and enables several of the more common hosting scenarios. One such scenario is long running workflows facilitated by persistence. Host control of persistence is performed either by calling a persistence operation on the <xref:System.Activities.WorkflowApplication>, or by handling a <xref:System.Activities.WorkflowApplication> event and indicating that the <xref:System.Activities.WorkflowApplication> should persist.  \n  \n The sample workflow is a <xref:System.Activities.Statements.WriteLine> activity prompting the user for their name, a `ReadLine` activity for receiving the name as input through the resumption of a <xref:System.Activities.Bookmark>, and another <xref:System.Activities.Statements.WriteLine> for echoing a greeting back to the user. When a workflow is waiting for input, this provides a natural point for persistence. This is often referred to as an <xref:System.Workflow.Runtime.Tracking.TrackingWorkflowEvent> point. <xref:System.Activities.WorkflowApplication> raises the <xref:System.Workflow.Runtime.Tracking.TrackingWorkflowEvent> event whenever the workflow program can be persisted, is waiting on a bookmark resumption, and no other work is being performed. In this sample’s workflow, that point comes immediately after the `ReadLine` activity begins executing.  \n  \n A <xref:System.Activities.WorkflowApplication> is set up to perform persistence with an <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore`. This sample uses the <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore>. The <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore` must be assigned to the <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property before the <xref:System.Activities.WorkflowApplication> is run.  \n  \n The sample adds a handler to the <xref:System.Activities.WorkflowApplication.PersistableIdle%2A> event. The handler for this event indicates what the <xref:System.Activities.WorkflowApplication> should do by returning a <xref:System.Activities.PersistableIdleAction>. When <xref:System.Activities.PersistableIdleAction> is returned, the <xref:System.Activities.WorkflowApplication> is unloaded.  \n  \n The sample then accepts input from the user and loads the persisted workflow into a new <xref:System.Activities.WorkflowApplication>. It does so by creating a new <xref:System.Activities.WorkflowApplication>, recreating the <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore`, and associating the completed and unloaded events to the instance, and then calling <xref:System.Activities.WorkflowApplication.Load%2A> with the identifier of the target workflow instance. Once the instance is acquired, the `ReadLine` activity’s bookmark is resumed. The workflow carries on execution from within the `ReadLine` activity and runs to completion. When the workflow completes and unloads, the <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore` is called one last time to delete the workflow.  \n  \n#### To use this sample  \n  \n1.  Open a [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] command prompt.  \n  \n     This sample requires SQL Server Express, which is installed by default with [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)].  \n  \n2.  Navigate to the sample directory (\\WF\\Basic\\Persistence\\InstancePersistence\\CS) and run CreateInstanceStore.cmd.  \n  \n    > [!CAUTION]\n    >  The CreateInstanceStore.cmd script attempts to create the database on the default instance of SQL Server 2008 Express. If you want to install the database on a different instance, modify the script to do so.  \n  \n3.  Using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)], open the Persistence.sln solution file and press CTRL+SHIFT+B to build it.  \n  \n    > [!CAUTION]\n    >  If you installed the database on a non-default instance of SQL Server, update the connection string in the code prior to building the solution.  \n  \n4.  Run the sample with administrator privileges by navigating to the project’s bin directory (\\WF\\Basic\\Persistence\\InstancePersistence\\bin\\Debug) in [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)], right-clicking Workflow.exe and selecting **Run as Administrator**.  \n  \n#### To remove the instance store database  \n  \n1.  Open a [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] command prompt.  \n  \n2.  Navigate to the sample directory and run RemoveInstanceStore.cmd.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your computer. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WF\\Basic\\Persistence\\InstancePersistence`  \n  \n## See Also  \n [AppFabric Hosting and Persistence Samples](http://go.microsoft.com/fwlink/?LinkId=193961)","nodes":[{"pos":[12,62],"content":"Persisting a Workflow Application | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Persisting a Workflow Application | Microsoft Docs","pos":[0,50]}]},{"pos":[328,361],"content":"Persisting a Workflow Application","linkify":"Persisting a Workflow Application","nodes":[{"content":"Persisting a Workflow Application","pos":[0,33]}]},{"content":"This sample demonstrates how to run a <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph>, unload it when it goes idle, and then reload it to continue its execution.","pos":[362,520],"source":"This sample demonstrates how to run a <xref:System.Activities.WorkflowApplication>, unload it when it goes idle, and then reload it to continue its execution."},{"pos":[529,543],"content":"Sample Details","linkify":"Sample Details","nodes":[{"content":"Sample Details","pos":[0,14]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> is a host for a single workflow instance that provides a simple interface and enables several of the more common hosting scenarios.","pos":[547,723],"source":"<xref:System.Activities.WorkflowApplication> is a host for a single workflow instance that provides a simple interface and enables several of the more common hosting scenarios."},{"content":"One such scenario is long running workflows facilitated by persistence.","pos":[724,795]},{"content":"Host control of persistence is performed either by calling a persistence operation on the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph>, or by handling a <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> event and indicating that the <ph id=\"ph3\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> should persist.","pos":[796,1084],"source":" Host control of persistence is performed either by calling a persistence operation on the <xref:System.Activities.WorkflowApplication>, or by handling a <xref:System.Activities.WorkflowApplication> event and indicating that the <xref:System.Activities.WorkflowApplication> should persist."},{"content":"The sample workflow is a <ph id=\"ph1\">&lt;xref:System.Activities.Statements.WriteLine&gt;</ph> activity prompting the user for their name, a <ph id=\"ph2\">`ReadLine`</ph> activity for receiving the name as input through the resumption of a <ph id=\"ph3\">&lt;xref:System.Activities.Bookmark&gt;</ph>, and another <ph id=\"ph4\">&lt;xref:System.Activities.Statements.WriteLine&gt;</ph> for echoing a greeting back to the user.","pos":[1091,1421],"source":"The sample workflow is a <xref:System.Activities.Statements.WriteLine> activity prompting the user for their name, a `ReadLine` activity for receiving the name as input through the resumption of a <xref:System.Activities.Bookmark>, and another <xref:System.Activities.Statements.WriteLine> for echoing a greeting back to the user."},{"content":"When a workflow is waiting for input, this provides a natural point for persistence.","pos":[1422,1506]},{"content":"This is often referred to as an <ph id=\"ph1\">&lt;xref:System.Workflow.Runtime.Tracking.TrackingWorkflowEvent&gt;</ph> point.","pos":[1507,1607],"source":" This is often referred to as an <xref:System.Workflow.Runtime.Tracking.TrackingWorkflowEvent> point."},{"content":"<ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> raises the <ph id=\"ph2\">&lt;xref:System.Workflow.Runtime.Tracking.TrackingWorkflowEvent&gt;</ph> event whenever the workflow program can be persisted, is waiting on a bookmark resumption, and no other work is being performed.","pos":[1608,1854],"source":"<xref:System.Activities.WorkflowApplication> raises the <xref:System.Workflow.Runtime.Tracking.TrackingWorkflowEvent> event whenever the workflow program can be persisted, is waiting on a bookmark resumption, and no other work is being performed."},{"content":"In this sample’s workflow, that point comes immediately after the <ph id=\"ph1\">`ReadLine`</ph> activity begins executing.","pos":[1855,1958],"source":" In this sample’s workflow, that point comes immediately after the `ReadLine` activity begins executing."},{"content":"A <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> is set up to perform persistence with an <ph id=\"ph2\">&lt;!--zz &lt;xref:System.Runtime.Persistence.InstanceStore&gt; --&gt;</ph> <ph id=\"ph3\">`System.Runtime.Persistence.InstanceStore`</ph>.","pos":[1965,2155],"source":"A <xref:System.Activities.WorkflowApplication> is set up to perform persistence with an <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore`."},{"content":"This sample uses the <ph id=\"ph1\">&lt;xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore&gt;</ph>.","pos":[2156,2245],"source":" This sample uses the <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore>."},{"content":"The <ph id=\"ph1\">&lt;!--zz &lt;xref:System.Runtime.Persistence.InstanceStore&gt; --&gt;</ph> <ph id=\"ph2\">`System.Runtime.Persistence.InstanceStore`</ph> must be assigned to the <ph id=\"ph3\">&lt;xref:System.Activities.WorkflowApplication.InstanceStore%2A&gt;</ph> property before the <ph id=\"ph4\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> is run.","pos":[2246,2510],"source":" The <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore` must be assigned to the <xref:System.Activities.WorkflowApplication.InstanceStore%2A> property before the <xref:System.Activities.WorkflowApplication> is run."},{"content":"The sample adds a handler to the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication.PersistableIdle%2A&gt;</ph> event.","pos":[2517,2620],"source":"The sample adds a handler to the <xref:System.Activities.WorkflowApplication.PersistableIdle%2A> event."},{"content":"The handler for this event indicates what the <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> should do by returning a <ph id=\"ph2\">&lt;xref:System.Activities.PersistableIdleAction&gt;</ph>.","pos":[2621,2784],"source":" The handler for this event indicates what the <xref:System.Activities.WorkflowApplication> should do by returning a <xref:System.Activities.PersistableIdleAction>."},{"content":"When <ph id=\"ph1\">&lt;xref:System.Activities.PersistableIdleAction&gt;</ph> is returned, the <ph id=\"ph2\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph> is unloaded.","pos":[2785,2911],"source":" When <xref:System.Activities.PersistableIdleAction> is returned, the <xref:System.Activities.WorkflowApplication> is unloaded."},{"content":"The sample then accepts input from the user and loads the persisted workflow into a new <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph>.","pos":[2918,3051],"source":"The sample then accepts input from the user and loads the persisted workflow into a new <xref:System.Activities.WorkflowApplication>."},{"content":"It does so by creating a new <ph id=\"ph1\">&lt;xref:System.Activities.WorkflowApplication&gt;</ph>, recreating the <ph id=\"ph2\">&lt;!--zz &lt;xref:System.Runtime.Persistence.InstanceStore&gt; --&gt;</ph> <ph id=\"ph3\">`System.Runtime.Persistence.InstanceStore`</ph>, and associating the completed and unloaded events to the instance, and then calling <ph id=\"ph4\">&lt;xref:System.Activities.WorkflowApplication.Load%2A&gt;</ph> with the identifier of the target workflow instance.","pos":[3052,3434],"source":" It does so by creating a new <xref:System.Activities.WorkflowApplication>, recreating the <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore`, and associating the completed and unloaded events to the instance, and then calling <xref:System.Activities.WorkflowApplication.Load%2A> with the identifier of the target workflow instance."},{"content":"Once the instance is acquired, the <ph id=\"ph1\">`ReadLine`</ph> activity’s bookmark is resumed.","pos":[3435,3512],"source":" Once the instance is acquired, the `ReadLine` activity’s bookmark is resumed."},{"content":"The workflow carries on execution from within the <ph id=\"ph1\">`ReadLine`</ph> activity and runs to completion.","pos":[3513,3606],"source":" The workflow carries on execution from within the `ReadLine` activity and runs to completion."},{"content":"When the workflow completes and unloads, the <ph id=\"ph1\">&lt;!--zz &lt;xref:System.Runtime.Persistence.InstanceStore&gt; --&gt;</ph> <ph id=\"ph2\">`System.Runtime.Persistence.InstanceStore`</ph> is called one last time to delete the workflow.","pos":[3607,3801],"source":" When the workflow completes and unloads, the <!--zz <xref:System.Runtime.Persistence.InstanceStore> --> `System.Runtime.Persistence.InstanceStore` is called one last time to delete the workflow."},{"pos":[3812,3830],"content":"To use this sample","linkify":"To use this sample","nodes":[{"content":"To use this sample","pos":[0,18]}]},{"pos":[3840,3916],"content":"Open a <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph> command prompt.","source":"Open a [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] command prompt."},{"pos":[3927,4057],"content":"This sample requires SQL Server Express, which is installed by default with <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph>.","source":"This sample requires SQL Server Express, which is installed by default with [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]."},{"content":"Navigate to the sample directory (\\WF\\Basic\\Persistence\\InstancePersistence\\CS) and run CreateInstanceStore.cmd.","pos":[4067,4179]},{"pos":[4191,4416],"content":"[!CAUTION]\nThe CreateInstanceStore.cmd script attempts to create the database on the default instance of SQL Server 2008 Express. If you want to install the database on a different instance, modify the script to do so.","leadings":["","    >  "],"nodes":[{"content":"The CreateInstanceStore.cmd script attempts to create the database on the default instance of SQL Server 2008 Express. If you want to install the database on a different instance, modify the script to do so.","pos":[11,218],"nodes":[{"content":"The CreateInstanceStore.cmd script attempts to create the database on the default instance of SQL Server 2008 Express.","pos":[0,118]},{"content":"If you want to install the database on a different instance, modify the script to do so.","pos":[119,207]}]}]},{"pos":[4426,4561],"content":"Using <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph>, open the Persistence.sln solution file and press CTRL+SHIFT+B to build it.","source":"Using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)], open the Persistence.sln solution file and press CTRL+SHIFT+B to build it."},{"pos":[4573,4734],"content":"[!CAUTION]\nIf you installed the database on a non-default instance of SQL Server, update the connection string in the code prior to building the solution.","leadings":["","    >  "],"nodes":[{"content":"If you installed the database on a non-default instance of SQL Server, update the connection string in the code prior to building the solution.","pos":[11,154]}]},{"pos":[4744,5025],"content":"Run the sample with administrator privileges by navigating to the project’s bin directory (\\WF\\Basic\\Persistence\\InstancePersistence\\bin\\Debug) in <ph id=\"ph1\">[!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)]</ph>, right-clicking Workflow.exe and selecting <bpt id=\"p1\">**</bpt>Run as Administrator<ept id=\"p1\">**</ept>.","source":"Run the sample with administrator privileges by navigating to the project’s bin directory (\\WF\\Basic\\Persistence\\InstancePersistence\\bin\\Debug) in [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)], right-clicking Workflow.exe and selecting **Run as Administrator**."},{"pos":[5036,5073],"content":"To remove the instance store database","linkify":"To remove the instance store database","nodes":[{"content":"To remove the instance store database","pos":[0,37]}]},{"pos":[5083,5159],"content":"Open a <ph id=\"ph1\">[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]</ph> command prompt.","source":"Open a [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] command prompt."},{"content":"Navigate to the sample directory and run RemoveInstanceStore.cmd.","pos":[5169,5234]},{"pos":[5242,5375],"content":"[!IMPORTANT]\n The samples may already be installed on your computer. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":" The samples may already be installed on your computer. Check for the following (default) directory before continuing.","pos":[13,131],"nodes":[{"content":"The samples may already be installed on your computer.","pos":[1,55]},{"content":"Check for the following (default) directory before continuing.","pos":[56,118]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[5429,5755],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[5756,5806]},{"pos":[5899,5907],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"pos":[5911,6001],"content":"<bpt id=\"p1\">[</bpt>AppFabric Hosting and Persistence Samples<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=193961)</ept>","source":"[AppFabric Hosting and Persistence Samples](http://go.microsoft.com/fwlink/?LinkId=193961)"}]}