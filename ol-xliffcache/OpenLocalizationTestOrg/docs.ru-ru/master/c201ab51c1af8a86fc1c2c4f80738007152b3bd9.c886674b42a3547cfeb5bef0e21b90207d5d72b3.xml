{"content":"---\ntitle: \"invalidApartmentStateChange MDA\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"MDAs (managed debugging assistants), invalid apartment state\"\n  - \"managed debugging assistants (MDAs), invalid apartment state\"\n  - \"InvalidApartmentStateChange MDA\"\n  - \"invalid apartment state changes\"\n  - \"threading [.NET Framework], apartment states\"\n  - \"apartment states\"\n  - \"threading [.NET Framework], managed debugging assistants\"\n  - \"COM apartment states\"\nms.assetid: e56fb9df-5286-4be7-b313-540c4d876cd7\nauthor: \"mairaw\"\nms.author: \"mairaw\"\n---\n# invalidApartmentStateChange MDA\nThe `invalidApartmentStateChange` managed debugging assistant (MDS) is activated by either of two problems:  \n  \n-   An attempt is made to change the COM apartment state of a thread that has already been initialized by COM to a different apartment state.  \n  \n-   The COM apartment state of a thread changes unexpectedly.  \n  \n## Symptoms  \n  \n-   A thread's COM apartment state is not what was requested. This may cause proxies to be used for COM components that have a threading model different from the current one. This in turn may cause an <xref:System.InvalidCastException> to be thrown when calling the COM object through interfaces that are not set up for cross-apartment marshaling.  \n  \n-   The COM apartment state of the thread is different than expected. This can cause a <xref:System.Runtime.InteropServices.COMException> with an HRESULT of RPC_E_WRONG_THREAD as well as a <xref:System.InvalidCastException> when making calls on a [Runtime Callable Wrapper](../../../docs/framework/interop/runtime-callable-wrapper.md) (RCW). This can also cause some single-threaded COM components to be accessed by multiple threads at the same time, which can lead to corruption or data loss.  \n  \n## Cause  \n  \n-   The thread was previously initialized to a different COM apartment state. Note that the apartment state of a thread can be set either explicitly or implicitly. The explicit operations include the <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType> property and the <xref:System.Threading.Thread.SetApartmentState%2A> and <xref:System.Threading.Thread.TrySetApartmentState%2A> methods. A thread created using the <xref:System.Threading.Thread.Start%2A> method is implicitly set to <xref:System.Threading.ApartmentState.MTA> unless <xref:System.Threading.Thread.SetApartmentState%2A> is called before the thread is started. The main thread of the application is also implicitly initialized to <xref:System.Threading.ApartmentState.MTA> unless the <xref:System.STAThreadAttribute> attribute is specified on the main method.  \n  \n-   The `CoUninitialize` method (or the `CoInitializeEx` method) with a different concurrency model is called on the thread.  \n  \n## Resolution  \n Set the apartment state of the thread before it begins executing, or apply either the <xref:System.STAThreadAttribute> attribute or the <xref:System.MTAThreadAttribute> attribute to the main method of the application.  \n  \n For the second cause, ideally, the code that calls the `CoUninitialize` method should be modified to delay the call until the thread is about to terminate and there are no RCWs and their underlying COM components still in use by the thread. However, if it is not possible to modify the code that calls the `CoUninitialize` method, then no RCWs should be used from threads that are uninitialized in this way.  \n  \n## Effect on the Runtime  \n This MDA has no effect on the CLR.  \n  \n## Output  \n The COM apartment state of the current thread, and the state that the code was attempting to apply.  \n  \n## Configuration  \n  \n```xml  \n<mdaConfig>  \n  <assistants>  \n    <invalidApartmentStateChange />  \n  </assistants>  \n</mdaConfig>  \n```  \n  \n## Example  \n The following code example demonstrates a situation that can activate this MDA.  \n  \n```csharp\nusing System.Threading;  \nnamespace ApartmentStateMDA  \n{  \n    class Program  \n    {  \n        static void Main(string[] args)  \n        {  \n            Thread.CurrentThread.SetApartmentState(ApartmentState.STA);  \n        }  \n    }  \n}  \n```  \n  \n## See also\n\n- <xref:System.Runtime.InteropServices.MarshalAsAttribute>\n- [Diagnosing Errors with Managed Debugging Assistants](../../../docs/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants.md)\n- [Interop Marshaling](../../../docs/framework/interop/interop-marshaling.md)\n","nodes":[{"pos":[4,548],"embed":true,"restype":"x-metadata","content":"title: \"invalidApartmentStateChange MDA\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"MDAs (managed debugging assistants), invalid apartment state\"\n  - \"managed debugging assistants (MDAs), invalid apartment state\"\n  - \"InvalidApartmentStateChange MDA\"\n  - \"invalid apartment state changes\"\n  - \"threading [.NET Framework], apartment states\"\n  - \"apartment states\"\n  - \"threading [.NET Framework], managed debugging assistants\"\n  - \"COM apartment states\"\nms.assetid: e56fb9df-5286-4be7-b313-540c4d876cd7\nauthor: \"mairaw\"\nms.author: \"mairaw\"","nodes":[{"content":"invalidApartmentStateChange MDA","nodes":[{"pos":[0,31],"content":"invalidApartmentStateChange MDA","nodes":[{"content":"invalidApartmentStateChange MDA","pos":[0,31]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[555,586],"content":"invalidApartmentStateChange MDA","linkify":"invalidApartmentStateChange MDA","nodes":[{"content":"invalidApartmentStateChange MDA","pos":[0,31]}]},{"pos":[587,694],"content":"The <ph id=\"ph1\">`invalidApartmentStateChange`</ph> managed debugging assistant (MDS) is activated by either of two problems:","source":"The `invalidApartmentStateChange` managed debugging assistant (MDS) is activated by either of two problems:"},{"content":"An attempt is made to change the COM apartment state of a thread that has already been initialized by COM to a different apartment state.","pos":[704,841]},{"content":"The COM apartment state of a thread changes unexpectedly.","pos":[851,908]},{"pos":[917,925],"content":"Symptoms","linkify":"Symptoms","nodes":[{"content":"Symptoms","pos":[0,8]}]},{"content":"A thread's COM apartment state is not what was requested.","pos":[935,992]},{"content":"This may cause proxies to be used for COM components that have a threading model different from the current one.","pos":[993,1105]},{"content":"This in turn may cause an <ph id=\"ph1\">&lt;xref:System.InvalidCastException&gt;</ph> to be thrown when calling the COM object through interfaces that are not set up for cross-apartment marshaling.","pos":[1106,1278],"source":" This in turn may cause an <xref:System.InvalidCastException> to be thrown when calling the COM object through interfaces that are not set up for cross-apartment marshaling."},{"content":"The COM apartment state of the thread is different than expected.","pos":[1288,1353]},{"content":"This can cause a <ph id=\"ph1\">&lt;xref:System.Runtime.InteropServices.COMException&gt;</ph> with an HRESULT of RPC_E_WRONG_THREAD as well as a <ph id=\"ph2\">&lt;xref:System.InvalidCastException&gt;</ph> when making calls on a <bpt id=\"p1\">[</bpt>Runtime Callable Wrapper<ept id=\"p1\">](../../../docs/framework/interop/runtime-callable-wrapper.md)</ept> (RCW).","pos":[1354,1625],"source":" This can cause a <xref:System.Runtime.InteropServices.COMException> with an HRESULT of RPC_E_WRONG_THREAD as well as a <xref:System.InvalidCastException> when making calls on a [Runtime Callable Wrapper](../../../docs/framework/interop/runtime-callable-wrapper.md) (RCW)."},{"content":"This can also cause some single-threaded COM components to be accessed by multiple threads at the same time, which can lead to corruption or data loss.","pos":[1626,1777]},{"pos":[1786,1791],"content":"Cause","linkify":"Cause","nodes":[{"content":"Cause","pos":[0,5]}]},{"content":"The thread was previously initialized to a different COM apartment state.","pos":[1801,1874]},{"content":"Note that the apartment state of a thread can be set either explicitly or implicitly.","pos":[1875,1960]},{"content":"The explicit operations include the <ph id=\"ph1\">&lt;xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType&gt;</ph> property and the <ph id=\"ph2\">&lt;xref:System.Threading.Thread.SetApartmentState%2A&gt;</ph> and <ph id=\"ph3\">&lt;xref:System.Threading.Thread.TrySetApartmentState%2A&gt;</ph> methods.","pos":[1961,2211],"source":" The explicit operations include the <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType> property and the <xref:System.Threading.Thread.SetApartmentState%2A> and <xref:System.Threading.Thread.TrySetApartmentState%2A> methods."},{"content":"A thread created using the <ph id=\"ph1\">&lt;xref:System.Threading.Thread.Start%2A&gt;</ph> method is implicitly set to <ph id=\"ph2\">&lt;xref:System.Threading.ApartmentState.MTA&gt;</ph> unless <ph id=\"ph3\">&lt;xref:System.Threading.Thread.SetApartmentState%2A&gt;</ph> is called before the thread is started.","pos":[2212,2448],"source":" A thread created using the <xref:System.Threading.Thread.Start%2A> method is implicitly set to <xref:System.Threading.ApartmentState.MTA> unless <xref:System.Threading.Thread.SetApartmentState%2A> is called before the thread is started."},{"content":"The main thread of the application is also implicitly initialized to <ph id=\"ph1\">&lt;xref:System.Threading.ApartmentState.MTA&gt;</ph> unless the <ph id=\"ph2\">&lt;xref:System.STAThreadAttribute&gt;</ph> attribute is specified on the main method.","pos":[2449,2647],"source":" The main thread of the application is also implicitly initialized to <xref:System.Threading.ApartmentState.MTA> unless the <xref:System.STAThreadAttribute> attribute is specified on the main method."},{"pos":[2657,2777],"content":"The <ph id=\"ph1\">`CoUninitialize`</ph> method (or the <ph id=\"ph2\">`CoInitializeEx`</ph> method) with a different concurrency model is called on the thread.","source":"The `CoUninitialize` method (or the `CoInitializeEx` method) with a different concurrency model is called on the thread."},{"pos":[2786,2796],"content":"Resolution","linkify":"Resolution","nodes":[{"content":"Resolution","pos":[0,10]}]},{"pos":[2800,3017],"content":"Set the apartment state of the thread before it begins executing, or apply either the <ph id=\"ph1\">&lt;xref:System.STAThreadAttribute&gt;</ph> attribute or the <ph id=\"ph2\">&lt;xref:System.MTAThreadAttribute&gt;</ph> attribute to the main method of the application.","source":"Set the apartment state of the thread before it begins executing, or apply either the <xref:System.STAThreadAttribute> attribute or the <xref:System.MTAThreadAttribute> attribute to the main method of the application."},{"content":"For the second cause, ideally, the code that calls the <ph id=\"ph1\">`CoUninitialize`</ph> method should be modified to delay the call until the thread is about to terminate and there are no RCWs and their underlying COM components still in use by the thread.","pos":[3024,3264],"source":"For the second cause, ideally, the code that calls the `CoUninitialize` method should be modified to delay the call until the thread is about to terminate and there are no RCWs and their underlying COM components still in use by the thread."},{"content":"However, if it is not possible to modify the code that calls the <ph id=\"ph1\">`CoUninitialize`</ph> method, then no RCWs should be used from threads that are uninitialized in this way.","pos":[3265,3431],"source":" However, if it is not possible to modify the code that calls the `CoUninitialize` method, then no RCWs should be used from threads that are uninitialized in this way."},{"pos":[3440,3461],"content":"Effect on the Runtime","linkify":"Effect on the Runtime","nodes":[{"content":"Effect on the Runtime","pos":[0,21]}]},{"content":"This MDA has no effect on the CLR.","pos":[3465,3499]},{"pos":[3508,3514],"content":"Output","linkify":"Output","nodes":[{"content":"Output","pos":[0,6]}]},{"content":"The COM apartment state of the current thread, and the state that the code was attempting to apply.","pos":[3518,3617]},{"pos":[3626,3639],"content":"Configuration","linkify":"Configuration","nodes":[{"content":"Configuration","pos":[0,13]}]},{"pos":[3768,3775],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"content":"The following code example demonstrates a situation that can activate this MDA.","pos":[3779,3858]},{"pos":[4126,4134],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[4197,4350],"content":"<bpt id=\"p1\">[</bpt>Diagnosing Errors with Managed Debugging Assistants<ept id=\"p1\">](../../../docs/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants.md)</ept>","source":"[Diagnosing Errors with Managed Debugging Assistants](../../../docs/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants.md)"},{"pos":[4353,4428],"content":"<bpt id=\"p1\">[</bpt>Interop Marshaling<ept id=\"p1\">](../../../docs/framework/interop/interop-marshaling.md)</ept>","source":"[Interop Marshaling](../../../docs/framework/interop/interop-marshaling.md)"}]}