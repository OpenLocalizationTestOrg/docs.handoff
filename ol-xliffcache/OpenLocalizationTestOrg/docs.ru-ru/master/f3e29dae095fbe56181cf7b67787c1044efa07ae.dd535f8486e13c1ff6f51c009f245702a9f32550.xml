{"content":"---\ntitle: \"Implementing a Resource Manager\"\nms.date: \"03/30/2017\"\nms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3\n---\n# Implementing a Resource Manager\nEach resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager. Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation. Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.  \n  \n A resource manager manages either durable or volatile data. The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery. If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager. In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).  \n  \n In order for a resource to participate in a transaction, it must enlist in the transaction. The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality. The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have. Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources. For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager. For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md).  \n  \n By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts. There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment. Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.  \n  \n After enlistment, the resource manager responds to the transaction's requests. A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages. There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.  \n  \n When the application commits the transaction, the transaction manager initiates the two-phase commit protocol. The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction. The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.  \n  \n During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails. If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction. If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.  \n  \n Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2. Typically, the entire prepare and commit protocol completes in a fraction of a second. If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours. During this period, the resource manager is in doubt about the outcome of the transaction. It does not know whether the transaction committed or aborted. While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.  \n  \n When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure. When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.  \n  \n In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.  \n  \n The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE). This allows a durable resource manager (RM) to host and \"own\" a transaction that can later be escalated to be managed by the MSDTC if necessary. For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md).  \n  \n## In This Section  \n The steps generally followed by a resource manager are outlined in the following topics.  \n  \n [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)  \n  \n Describes how a durable or volatile resource can enlist in a transaction.  \n  \n [Committing a Transaction in Single-Phase and Multi-Phase](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)  \n  \n Describes how a resource manager responds to commit notification and prepare the commit.  \n  \n [Performing Recovery](../../../../docs/framework/data/transactions/performing-recovery.md)  \n  \n Describes how a durable resource manager recovers from failure.  \n  \n [Security Trust Levels in Accessing Resources](../../../../docs/framework/data/transactions/security-trust-levels-in-accessing-resources.md)  \n  \n Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.  \n  \n [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)  \n  \n Describes optimization practices available to implementations of resource managers.\n","nodes":[{"pos":[4,115],"embed":true,"restype":"x-metadata","content":"title: \"Implementing a Resource Manager\"\nms.date: \"03/30/2017\"\nms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3","nodes":[{"content":"Implementing a Resource Manager","nodes":[{"pos":[0,31],"content":"Implementing a Resource Manager","nodes":[{"content":"Implementing a Resource Manager","pos":[0,31]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[122,153],"content":"Implementing a Resource Manager","linkify":"Implementing a Resource Manager","nodes":[{"content":"Implementing a Resource Manager","pos":[0,31]}]},{"content":"Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.","pos":[154,279]},{"content":"Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.","pos":[280,418]},{"content":"Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.","pos":[419,525]},{"content":"A resource manager manages either durable or volatile data.","pos":[532,591]},{"content":"The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.","pos":[592,725]},{"content":"If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.","pos":[726,1026]},{"content":"In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).","pos":[1027,1321]},{"content":"In order for a resource to participate in a transaction, it must enlist in the transaction.","pos":[1328,1419]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction&gt;</ph> class defines a set of methods whose names begin with <bpt id=\"p1\">**</bpt>Enlist<ept id=\"p1\">**</ept> that provide this functionality.","pos":[1420,1560],"source":" The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality."},{"content":"The different <bpt id=\"p1\">**</bpt>Enlist<ept id=\"p1\">**</ept> methods correspond to the different types of enlistment that a resource manager may have.","pos":[1561,1675],"source":" The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have."},{"content":"Specifically, you use the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.EnlistVolatile%2A&gt;</ph> methods for volatile resources, and the <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction.EnlistDurable%2A&gt;</ph> method for durable resources.","pos":[1676,1884],"source":" Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources."},{"content":"For simplicity, after deciding whether to use the <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction.EnlistDurable%2A&gt;</ph> or <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction.EnlistVolatile%2A&gt;</ph> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <ph id=\"ph3\">&lt;xref:System.Transactions.IEnlistmentNotification&gt;</ph> interface for your resource manager.","pos":[1885,2283],"source":" For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager."},{"content":"For more information on 2PC, see <bpt id=\"p1\">[</bpt>Committing a Transaction in Single-Phase and Multi-Phase<ept id=\"p1\">](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)</ept>.","pos":[2284,2482],"source":" For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)."},{"content":"By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.","pos":[2489,2623]},{"content":"There is one instance of <ph id=\"ph1\">&lt;xref:System.Transactions.IEnlistmentNotification&gt;</ph> per enlistment.","pos":[2624,2715],"source":" There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment."},{"content":"Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.","pos":[2716,2851]},{"content":"After enlistment, the resource manager responds to the transaction's requests.","pos":[2858,2936]},{"content":"A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.","pos":[2937,3072]},{"content":"There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.","pos":[3073,3188]},{"content":"When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.","pos":[3195,3305]},{"content":"The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.","pos":[3306,3416]},{"content":"The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.","pos":[3417,3521]},{"content":"During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.","pos":[3528,3699]},{"content":"If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.","pos":[3700,3827]},{"content":"If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.","pos":[3828,4015]},{"content":"Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.","pos":[4022,4147]},{"content":"Typically, the entire prepare and commit protocol completes in a fraction of a second.","pos":[4148,4234]},{"content":"If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.","pos":[4235,4351]},{"content":"During this period, the resource manager is in doubt about the outcome of the transaction.","pos":[4352,4442]},{"content":"It does not know whether the transaction committed or aborted.","pos":[4443,4505]},{"content":"While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.","pos":[4506,4688]},{"content":"When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.","pos":[4695,4840]},{"content":"When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.","pos":[4841,5068]},{"content":"In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.","pos":[5075,5191]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Transactions.Transaction&gt;</ph> class also provides the <ph id=\"ph2\">&lt;xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A&gt;</ph> method to enlist a Promotable Single Phase Enlistment (PSPE).","pos":[5198,5396],"source":"The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE)."},{"content":"This allows a durable resource manager (RM) to host and \"own\" a transaction that can later be escalated to be managed by the MSDTC if necessary.","pos":[5397,5541]},{"content":"For more information on this, see <bpt id=\"p1\">[</bpt>Optimization using Single Phase Commit and Promotable Single Phase Notification<ept id=\"p1\">](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)</ept>.","pos":[5542,5743],"source":" For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)."},{"pos":[5752,5767],"content":"In This Section","linkify":"In This Section","nodes":[{"content":"In This Section","pos":[0,15]}]},{"content":"The steps generally followed by a resource manager are outlined in the following topics.","pos":[5771,5859]},{"pos":[5866,6022],"content":"<bpt id=\"p1\">[</bpt>Enlisting Resources as Participants in a Transaction<ept id=\"p1\">](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)</ept>","source":"[Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)"},{"content":"Describes how a durable or volatile resource can enlist in a transaction.","pos":[6029,6102]},{"pos":[6109,6273],"content":"<bpt id=\"p1\">[</bpt>Committing a Transaction in Single-Phase and Multi-Phase<ept id=\"p1\">](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)</ept>","source":"[Committing a Transaction in Single-Phase and Multi-Phase](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)"},{"content":"Describes how a resource manager responds to commit notification and prepare the commit.","pos":[6280,6368]},{"pos":[6375,6465],"content":"<bpt id=\"p1\">[</bpt>Performing Recovery<ept id=\"p1\">](../../../../docs/framework/data/transactions/performing-recovery.md)</ept>","source":"[Performing Recovery](../../../../docs/framework/data/transactions/performing-recovery.md)"},{"content":"Describes how a durable resource manager recovers from failure.","pos":[6472,6535]},{"pos":[6542,6682],"content":"<bpt id=\"p1\">[</bpt>Security Trust Levels in Accessing Resources<ept id=\"p1\">](../../../../docs/framework/data/transactions/security-trust-levels-in-accessing-resources.md)</ept>","source":"[Security Trust Levels in Accessing Resources](../../../../docs/framework/data/transactions/security-trust-levels-in-accessing-resources.md)"},{"pos":[6689,6835],"content":"Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <ph id=\"ph1\">&lt;xref:System.Transactions&gt;</ph> exposes.","source":"Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes."},{"pos":[6842,7008],"content":"<bpt id=\"p1\">[</bpt>Optimization using Single Phase Commit and Promotable Single Phase Notification<ept id=\"p1\">](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)</ept>","source":"[Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)"},{"content":"Describes optimization practices available to implementations of resource managers.","pos":[7015,7098]}]}