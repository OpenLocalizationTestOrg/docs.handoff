{"content":"---\ntitle: \"Customizing Permissions with Impersonation in SQL Server\"\nms.date: \"03/30/2017\"\nms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1\n---\n# Customizing Permissions with Impersonation in SQL Server\nMany applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables. You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables. SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner. However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.  \n  \n You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects. The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user. All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user. Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.  \n  \n## Context Switching with the EXECUTE AS Statement  \n The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user. This is a useful technique for testing queries and procedures as another user.  \n  \n```  \nEXECUTE AS LOGIN = 'loginName';  \nEXECUTE AS USER = 'userName';  \n```  \n  \n You must have IMPERSONATE permissions on the login or user you are impersonating. This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own.  \n  \n## Granting Permissions with the EXECUTE AS Clause  \n You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions). This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause. You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure. Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.  \n  \n> [!NOTE]\n>  Some actions, such as TRUNCATE TABLE, do not have grantable permissions. By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.  \n  \n The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers. Context reverts to the caller when execution is complete or the REVERT statement is issued.  \n  \n There are three steps involved in using the EXECUTE AS clause in a procedure.  \n  \n1.  Create a proxy user in the database that is not mapped to a login. This is not required, but it helps when managing permissions.  \n  \n```  \nCREATE USER proxyUser WITHOUT LOGIN  \n```  \n  \n1.  Grant the proxy user the necessary permissions.  \n  \n2.  Add the EXECUTE AS clause to the stored procedure or user-defined function.  \n  \n```  \nCREATE PROCEDURE [procName] WITH EXECUTE AS 'proxyUser' AS ...  \n```  \n  \n> [!NOTE]\n>  Applications that require auditing can break because the original security context of the caller is not retained. Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.  \n  \n### Using EXECUTE AS with REVERT  \n You can use the Transact-SQL REVERT statement to revert to the original execution context.  \n  \n The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value. This allows you to switch the execution context back to the caller in environments where connection pooling is used. Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application. When the connection is closed, it is returned to the pool. For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).  \n  \n### Specifying the Execution Context  \n In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.  \n  \n-   CALLER. Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.  \n  \n-   OWNER. Executing as OWNER executes the procedure in the context of the procedure owner. If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions.  \n  \n-   SELF. Executing as SELF executes in the security context of the creator of the stored procedure. This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.  \n  \n## See also\n\n- [Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)\n- [Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)\n- [Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)\n- [Managing Permissions with Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)\n- [Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)\n- [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)\n- [Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)\n- [ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)\n","nodes":[{"pos":[4,140],"embed":true,"restype":"x-metadata","content":"title: \"Customizing Permissions with Impersonation in SQL Server\"\nms.date: \"03/30/2017\"\nms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1","nodes":[{"content":"Customizing Permissions with Impersonation in SQL Server","nodes":[{"pos":[0,56],"content":"Customizing Permissions with Impersonation in SQL Server","nodes":[{"content":"Customizing Permissions with Impersonation in SQL Server","pos":[0,56]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[147,203],"content":"Customizing Permissions with Impersonation in SQL Server","linkify":"Customizing Permissions with Impersonation in SQL Server","nodes":[{"content":"Customizing Permissions with Impersonation in SQL Server","pos":[0,56]}]},{"content":"Many applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables.","pos":[204,324]},{"content":"You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables.","pos":[325,432]},{"content":"SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner.","pos":[433,544]},{"content":"However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.","pos":[545,649]},{"content":"You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects.","pos":[656,788]},{"content":"The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user.","pos":[789,885]},{"content":"All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user.","pos":[886,1012]},{"content":"Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.","pos":[1013,1141]},{"pos":[1150,1197],"content":"Context Switching with the EXECUTE AS Statement","linkify":"Context Switching with the EXECUTE AS Statement","nodes":[{"content":"Context Switching with the EXECUTE AS Statement","pos":[0,47]}]},{"content":"The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user.","pos":[1201,1345]},{"content":"This is a useful technique for testing queries and procedures as another user.","pos":[1346,1424]},{"content":"You must have IMPERSONATE permissions on the login or user you are impersonating.","pos":[1512,1593]},{"content":"This permission is implied for <ph id=\"ph1\">`sysadmin`</ph> for all databases, and <ph id=\"ph2\">`db_owner`</ph> role members in databases that they own.","pos":[1594,1710],"source":" This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own."},{"pos":[1719,1766],"content":"Granting Permissions with the EXECUTE AS Clause","linkify":"Granting Permissions with the EXECUTE AS Clause","nodes":[{"content":"Granting Permissions with the EXECUTE AS Clause","pos":[0,47]}]},{"content":"You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions).","pos":[1770,1929]},{"content":"This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause.","pos":[1930,2045]},{"content":"You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure.","pos":[2046,2205]},{"content":"Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.","pos":[2206,2321]},{"pos":[2329,2639],"content":"[!NOTE]\n Some actions, such as TRUNCATE TABLE, do not have grantable permissions. By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.","leadings":["","> "],"nodes":[{"content":"Some actions, such as TRUNCATE TABLE, do not have grantable permissions. By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.","pos":[9,308],"nodes":[{"content":"Some actions, such as TRUNCATE TABLE, do not have grantable permissions.","pos":[0,72]},{"content":"By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.","pos":[73,299]}]}]},{"content":"The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers.","pos":[2646,2778]},{"content":"Context reverts to the caller when execution is complete or the REVERT statement is issued.","pos":[2779,2870]},{"content":"There are three steps involved in using the EXECUTE AS clause in a procedure.","pos":[2877,2954]},{"content":"Create a proxy user in the database that is not mapped to a login.","pos":[2964,3030]},{"content":"This is not required, but it helps when managing permissions.","pos":[3031,3092]},{"content":"Grant the proxy user the necessary permissions.","pos":[3155,3202]},{"content":"Add the EXECUTE AS clause to the stored procedure or user-defined function.","pos":[3212,3287]},{"pos":[3375,3686],"content":"[!NOTE]\n Applications that require auditing can break because the original security context of the caller is not retained. Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.","leadings":["","> "],"nodes":[{"content":"Applications that require auditing can break because the original security context of the caller is not retained. Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.","pos":[9,309],"nodes":[{"content":"Applications that require auditing can break because the original security context of the caller is not retained.","pos":[0,113]},{"content":"Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.","pos":[114,300]}]}]},{"pos":[3696,3724],"content":"Using EXECUTE AS with REVERT","linkify":"Using EXECUTE AS with REVERT","nodes":[{"content":"Using EXECUTE AS with REVERT","pos":[0,28]}]},{"content":"You can use the Transact-SQL REVERT statement to revert to the original execution context.","pos":[3728,3818]},{"content":"The optional clause, WITH NO REVERT COOKIE = <ph id=\"ph1\">@variableName</ph>, allows you switch the execution context back to the caller if the <ph id=\"ph2\">@variableName</ph> variable contains the correct value.","pos":[3825,4001],"source":"The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value."},{"content":"This allows you to switch the execution context back to the caller in environments where connection pooling is used.","pos":[4002,4118]},{"content":"Because the value of <ph id=\"ph1\">@variableName</ph> is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application.","pos":[4119,4326],"source":" Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application."},{"content":"When the connection is closed, it is returned to the pool.","pos":[4327,4385]},{"content":"For more information on connection pooling in ADO.NET, see <bpt id=\"p1\">[</bpt>SQL Server Connection Pooling (ADO.NET)<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md)</ept>.","pos":[4386,4563],"source":" For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md)."},{"pos":[4573,4605],"content":"Specifying the Execution Context","linkify":"Specifying the Execution Context","nodes":[{"content":"Specifying the Execution Context","pos":[0,32]}]},{"content":"In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.","pos":[4609,4706]},{"content":"CALLER.","pos":[4716,4723]},{"content":"Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.","pos":[4724,4859]},{"content":"OWNER.","pos":[4869,4875]},{"content":"Executing as OWNER executes the procedure in the context of the procedure owner.","pos":[4876,4956]},{"content":"If the procedure is created in a schema owned by <ph id=\"ph1\">`dbo`</ph> or the database owner, the procedure will execute with unrestricted permissions.","pos":[4957,5092],"source":" If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions."},{"content":"SELF.","pos":[5102,5107]},{"content":"Executing as SELF executes in the security context of the creator of the stored procedure.","pos":[5108,5198]},{"content":"This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.","pos":[5199,5326]},{"pos":[5335,5343],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[5347,5454],"content":"<bpt id=\"p1\">[</bpt>Securing ADO.NET Applications<ept id=\"p1\">](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</ept>","source":"[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)"},{"pos":[5457,5572],"content":"<bpt id=\"p1\">[</bpt>Overview of SQL Server Security<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)</ept>","source":"[Overview of SQL Server Security](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)"},{"pos":[5575,5716],"content":"<bpt id=\"p1\">[</bpt>Application Security Scenarios in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)</ept>","source":"[Application Security Scenarios in SQL Server](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)"},{"pos":[5719,5886],"content":"<bpt id=\"p1\">[</bpt>Managing Permissions with Stored Procedures in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)</ept>","source":"[Managing Permissions with Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)"},{"pos":[5889,6022],"content":"<bpt id=\"p1\">[</bpt>Writing Secure Dynamic SQL in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)</ept>","source":"[Writing Secure Dynamic SQL in SQL Server](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)"},{"pos":[6025,6156],"content":"<bpt id=\"p1\">[</bpt>Signing Stored Procedures in SQL Server<ept id=\"p1\">](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)</ept>","source":"[Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)"},{"pos":[6159,6282],"content":"<bpt id=\"p1\">[</bpt>Modifying Data with Stored Procedures<ept id=\"p1\">](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)</ept>","source":"[Modifying Data with Stored Procedures](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)"},{"pos":[6285,6389],"content":"<bpt id=\"p1\">[</bpt>ADO.NET Managed Providers and DataSet Developer Center<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=217917)</ept>","source":"[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)"}]}