{"content":"---\ntitle: \"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic) | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"2015-07-20\"\nms.prod: .net\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-visual-basic\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"VB\"\nms.assetid: c06d386d-e996-4da9-bf3d-05a3b6c0a258\ncaps.latest.revision: 3\nauthor: dotnet-bot\nms.author: dotnetcontent\n\ntranslation.priority.mt: \n  - \"cs-cz\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"tr-tr\"\n---\n# How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic)\nYou can improve the performance of the async solution in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md) by using the <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=fullName> method. This method asynchronously awaits multiple asynchronous operations, which are represented as a collection of tasks.  \n  \n You might have noticed in the walkthrough that the websites download at different rates. Sometimes one of the websites is very slow, which delays all the remaining downloads. When you run the asynchronous solutions that you build in the walkthrough, you can end the program easily if you don't want to wait, but a better option would be to start all the downloads at the same time and let faster downloads continue without waiting for the one that’s delayed.  \n  \n You apply the `Task.WhenAll` method to a collection of tasks. The application of `WhenAll` returns a single task that isn’t complete until every task in the collection is completed. The tasks appear to run in parallel, but no additional threads are created. The tasks can complete in any order.  \n  \n> [!IMPORTANT]\n>  The following procedures describe extensions to the async applications that are developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md). You can develop the applications by either completing the walkthrough or downloading the code from [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191).  \n>   \n>  To run the example, you must have Visual Studio 2012 or later installed on your computer.  \n  \n### To add Task.WhenAll to your GetURLContentsAsync solution  \n  \n1.  Add the `ProcessURLAsync` method to the first application that's developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md).  \n  \n    -   If you downloaded the code from  [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191), open the AsyncWalkthrough project, and then add `ProcessURLAsync` to the MainWindow.xaml.vb file.  \n  \n    -   If you developed the code by completing the walkthrough, add `ProcessURLAsync` to the application that includes the `GetURLContentsAsync` method. The MainWindow.xaml.vb file for this application is the first example in the \"Complete Code Examples from the Walkthrough\" section.  \n  \n     The `ProcessURLAsync` method consolidates the actions in the body of the `For Each` loop in `SumPageSizesAsync` in the original walkthrough. The method asynchronously downloads the contents of a specified website as a byte array, and then displays and returns the length of the byte array.  \n  \n    ```vb  \n    Private Async Function ProcessURLAsync(url As String) As Task(Of Integer)  \n  \n        Dim byteArray = Await GetURLContentsAsync(url)  \n        DisplayResults(url, byteArray)  \n        Return byteArray.Length  \n    End Function  \n    ```  \n  \n2.  Comment out or delete the `For Each` loop in `SumPageSizesAsync`, as the following code shows.  \n  \n    ```vb  \n    'Dim total = 0  \n    'For Each url In urlList  \n  \n    '    Dim urlContents As Byte() = Await GetURLContentsAsync(url)  \n  \n    '    ' The previous line abbreviates the following two assignment statements.  \n  \n    '    ' GetURLContentsAsync returns a task. At completion, the task  \n    '    ' produces a byte array.  \n    '    'Dim getContentsTask As Task(Of Byte()) = GetURLContentsAsync(url)  \n    '    'Dim urlContents As Byte() = Await getContentsTask  \n  \n    '    DisplayResults(url, urlContents)  \n  \n    '    ' Update the total.  \n    '    total += urlContents.Length  \n    'Next  \n    ```  \n  \n3.  Create a collection of tasks. The following code defines a [query](http://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d) that, when executed by the <xref:System.Linq.Enumerable.ToArray%2A> method, creates a collection of tasks that download the contents of each website. The tasks are started when the query is evaluated.  \n  \n     Add the following code to method `SumPageSizesAsync` after the declaration of `urlList`.  \n  \n    ```vb  \n    ' Create a query.   \n    Dim downloadTasksQuery As IEnumerable(Of Task(Of Integer)) =  \n        From url In urlList Select ProcessURLAsync(url)  \n  \n    ' Use ToArray to execute the query and start the download tasks.  \n    Dim downloadTasks As Task(Of Integer)() = downloadTasksQuery.ToArray()  \n    ```  \n  \n4.  Apply `Task.WhenAll` to the collection of tasks, `downloadTasks`. `Task.WhenAll` returns a single task that finishes when all the tasks in the collection of tasks have completed.  \n  \n     In the following example, the `Await` expression awaits the completion of the single task that `WhenAll` returns. The expression evaluates to an array of integers, where each integer is the length of a downloaded website. Add the following code to `SumPageSizesAsync`, just after the code that you added in the previous step.  \n  \n    ```vb  \n    ' Await the completion of all the running tasks.  \n    Dim lengths As Integer() = Await Task.WhenAll(downloadTasks)  \n  \n    '' The previous line is equivalent to the following two statements.  \n    'Dim whenAllTask As Task(Of Integer()) = Task.WhenAll(downloadTasks)  \n    'Dim lengths As Integer() = Await whenAllTask  \n    ```  \n  \n5.  Finally, use the <xref:System.Linq.Enumerable.Sum%2A> method to calculate the sum of the lengths of all the websites. Add the following line to `SumPageSizesAsync`.  \n  \n    ```vb  \n    Dim total = lengths.Sum()  \n    ```  \n  \n### To add Task.WhenAll to the HttpClient.GetByteArrayAsync solution  \n  \n1.  Add the following version of `ProcessURLAsync` to the second application that's developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md).  \n  \n    -   If you downloaded the code from [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191), open the AsyncWalkthrough_HttpClient project, and then add `ProcessURLAsync` to the MainWindow.xaml.vb file.  \n  \n    -   If you developed the code by completing the walkthrough, add `ProcessURLAsync` to the application that uses the `HttpClient.GetByteArrayAsync` method. The MainWindow.xaml.vb file for this application is the second example in the \"Complete Code Examples from the Walkthrough\" section.  \n  \n     The `ProcessURLAsync` method consolidates the actions in the body of the `For Each` loop in `SumPageSizesAsync` in the original walkthrough. The method asynchronously downloads the contents of a specified website as a byte array, and then displays and returns the length of the byte array.  \n  \n     The only difference from the `ProcessURLAsync` method in the previous procedure is the use of the <xref:System.Net.Http.HttpClient> instance, `client`.  \n  \n    ```vb  \n    Private Async Function ProcessURLAsync(url As String, client As HttpClient) As Task(Of Integer)  \n  \n        Dim byteArray = Await client.GetByteArrayAsync(url)  \n        DisplayResults(url, byteArray)  \n        Return byteArray.Length  \n    End Function  \n    ```  \n  \n2.  Comment out or delete the `For Each` loop in `SumPageSizesAsync`, as the following code shows.  \n  \n    ```vb  \n    'Dim total = 0   \n    'For Each url In urlList   \n    '    ' GetByteArrayAsync returns a task. At completion, the task   \n    '    ' produces a byte array.   \n    '    Dim urlContents As Byte() = Await client.GetByteArrayAsync(url)   \n  \n    '    ' The following two lines can replace the previous assignment statement.   \n    '    'Dim getContentsTask As Task(Of Byte()) = client.GetByteArrayAsync(url)   \n    '    'Dim urlContents As Byte() = Await getContentsTask   \n  \n    '    DisplayResults(url, urlContents)   \n  \n    '    ' Update the total.   \n    '    total += urlContents.Length   \n    'Next  \n  \n    ```  \n  \n3.  Define a [query](http://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d) that, when executed by the <xref:System.Linq.Enumerable.ToArray%2A> method, creates a collection of tasks that download the contents of each website. The tasks are started when the query is evaluated.  \n  \n     Add the following code to method `SumPageSizesAsync` after the declaration of `client` and `urlList`.  \n  \n    ```vb  \n    ' Create a query.  \n    Dim downloadTasksQuery As IEnumerable(Of Task(Of Integer)) =  \n        From url In urlList Select ProcessURLAsync(url, client)  \n  \n    ' Use ToArray to execute the query and start the download tasks.  \n    Dim downloadTasks As Task(Of Integer)() = downloadTasksQuery.ToArray()  \n    ```  \n  \n4.  Next, apply `Task.WhenAll` to the collection of tasks, `downloadTasks`. `Task.WhenAll` returns a single task that finishes when all the tasks in the collection of tasks have completed.  \n  \n     In the following example, the `Await` expression awaits the completion of the single task that `WhenAll` returns. When complete, the `Await` expression evaluates to an array of integers, where each integer is the length of a downloaded website. Add the following code to `SumPageSizesAsync`, just after the code that you added in the previous step.  \n  \n    ```vb  \n    ' Await the completion of all the running tasks.  \n    Dim lengths As Integer() = Await Task.WhenAll(downloadTasks)  \n  \n    '' The previous line is equivalent to the following two statements.  \n    'Dim whenAllTask As Task(Of Integer()) = Task.WhenAll(downloadTasks)  \n    'Dim lengths As Integer() = Await whenAllTask  \n    ```  \n  \n5.  Finally, use the <xref:System.Linq.Enumerable.Sum%2A> method to get the sum of the lengths of all the websites. Add the following line to `SumPageSizesAsync`.  \n  \n    ```vb  \n    Dim total = lengths.Sum()  \n    ```  \n  \n### To test the Task.WhenAll solutions  \n  \n-   For either solution, choose the F5 key to run the program, and then choose the **Start** button. The output should resemble the output from the async solutions in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md). However, notice that the websites appear in a different order each time.  \n  \n## Example  \n The following code shows the extensions to the project that uses the `GetURLContentsAsync` method to download content from the web.  \n  \n```vb  \n' Add the following Imports statements, and add a reference for System.Net.Http.  \nImports System.Net.Http  \nImports System.Net  \nImports System.IO  \n  \nClass MainWindow  \n  \n    Async Sub startButton_Click(sender As Object, e As RoutedEventArgs) Handles startButton.Click  \n  \n        resultsTextBox.Clear()  \n  \n        ' One-step async call.  \n        Await SumPageSizesAsync()  \n  \n        '' Two-step async call.  \n        'Dim sumTask As Task = SumPageSizesAsync()  \n        'Await sumTask  \n  \n        resultsTextBox.Text &= vbCrLf & \"Control returned to button1_Click.\"  \n    End Sub  \n  \n    Private Async Function SumPageSizesAsync() As Task  \n  \n        ' Make a list of web addresses.  \n        Dim urlList As List(Of String) = SetUpURLList()  \n  \n        ' Create a query.   \n        Dim downloadTasksQuery As IEnumerable(Of Task(Of Integer)) =  \n            From url In urlList Select ProcessURLAsync(url)  \n  \n        ' Use ToArray to execute the query and start the download tasks.  \n        Dim downloadTasks As Task(Of Integer)() = downloadTasksQuery.ToArray()  \n  \n        ' You can do other work here before awaiting.  \n  \n        ' Await the completion of all the running tasks.  \n        Dim lengths As Integer() = Await Task.WhenAll(downloadTasks)  \n  \n        '' The previous line is equivalent to the following two statements.  \n        'Dim whenAllTask As Task(Of Integer()) = Task.WhenAll(downloadTasks)  \n        'Dim lengths As Integer() = Await whenAllTask  \n  \n        Dim total = lengths.Sum()  \n  \n        'Dim total = 0  \n        'For Each url In urlList  \n  \n        '    Dim urlContents As Byte() = Await GetURLContentsAsync(url)  \n  \n        '    ' The previous line abbreviates the following two assignment statements.  \n  \n        '    ' GetURLContentsAsync returns a task. At completion, the task  \n        '    ' produces a byte array.  \n        '    'Dim getContentsTask As Task(Of Byte()) = GetURLContentsAsync(url)  \n        '    'Dim urlContents As Byte() = Await getContentsTask  \n  \n        '    DisplayResults(url, urlContents)  \n  \n        '    ' Update the total.  \n        '    total += urlContents.Length  \n        'NextNext  \n  \n        ' Display the total count for all of the web addresses.  \n        resultsTextBox.Text &= String.Format(vbCrLf & vbCrLf &  \n                                             \"Total bytes returned:  {0}\" & vbCrLf, total)  \n    End Function  \n  \n    Private Function SetUpURLList() As List(Of String)  \n  \n        Dim urls = New List(Of String) From  \n            {  \n                \"http://msdn.microsoft.com\",  \n                \"http://msdn.microsoft.com/library/hh290136.aspx\",  \n                \"http://msdn.microsoft.com/library/ee256749.aspx\",  \n                \"http://msdn.microsoft.com/library/hh290138.aspx\",  \n                \"http://msdn.microsoft.com/library/hh290140.aspx\",  \n                \"http://msdn.microsoft.com/library/dd470362.aspx\",  \n                \"http://msdn.microsoft.com/library/aa578028.aspx\",  \n                \"http://msdn.microsoft.com/library/ms404677.aspx\",  \n                \"http://msdn.microsoft.com/library/ff730837.aspx\"  \n            }  \n        Return urls  \n    End Function  \n  \n    ' The actions from the foreach loop are moved to this async method.  \n    Private Async Function ProcessURLAsync(url As String) As Task(Of Integer)  \n  \n        Dim byteArray = Await GetURLContentsAsync(url)  \n        DisplayResults(url, byteArray)  \n        Return byteArray.Length  \n    End Function  \n  \n    Private Async Function GetURLContentsAsync(url As String) As Task(Of Byte())  \n  \n        ' The downloaded resource ends up in the variable named content.  \n        Dim content = New MemoryStream()  \n  \n        ' Initialize an HttpWebRequest for the current URL.  \n        Dim webReq = CType(WebRequest.Create(url), HttpWebRequest)  \n  \n        ' Send the request to the Internet resource and wait for  \n        ' the response.  \n        Using response As WebResponse = Await webReq.GetResponseAsync()  \n            ' Get the data stream that is associated with the specified URL.  \n            Using responseStream As Stream = response.GetResponseStream()  \n                ' Read the bytes in responseStream and copy them to content.    \n                ' CopyToAsync returns a Task, not a Task<T>.  \n                Await responseStream.CopyToAsync(content)  \n            End Using  \n        End Using  \n  \n        ' Return the result as a byte array.  \n        Return content.ToArray()  \n    End Function  \n  \n    Private Sub DisplayResults(url As String, content As Byte())  \n  \n        ' Display the length of each website. The string format   \n        ' is designed to be used with a monospaced font, such as  \n        ' Lucida Console or Global Monospace.  \n        Dim bytes = content.Length  \n        ' Strip off the \"http://\".  \n        Dim displayURL = url.Replace(\"http://\", \"\")  \n        resultsTextBox.Text &= String.Format(vbCrLf & \"{0,-58} {1,8}\", displayURL, bytes)  \n    End Sub  \n  \nEnd Class  \n```  \n  \n## Example  \n The following code shows the extensions to the project that uses method `HttpClient.GetByteArrayAsync` to download content from the web.  \n  \n```vb  \n' Add the following Imports statements, and add a reference for System.Net.Http.  \nImports System.Net.Http  \nImports System.Net  \nImports System.IO  \n  \nClass MainWindow  \n  \n    Async Sub startButton_Click(sender As Object, e As RoutedEventArgs) Handles startButton.Click  \n  \n        resultsTextBox.Clear()  \n  \n        '' One-step async call.  \n        Await SumPageSizesAsync()  \n  \n        '' Two-step async call.  \n        'Dim sumTask As Task = SumPageSizesAsync()  \n        'Await sumTask  \n  \n        resultsTextBox.Text &= vbCrLf & \"Control returned to button1_Click.\"  \n    End Sub  \n  \n    Private Async Function SumPageSizesAsync() As Task  \n  \n        ' Declare an HttpClient object and increase the buffer size. The  \n        ' default buffer size is 65,536.  \n        Dim client As HttpClient =  \n            New HttpClient() With {.MaxResponseContentBufferSize = 1000000}  \n  \n        ' Make a list of web addresses.  \n        Dim urlList As List(Of String) = SetUpURLList()  \n  \n        ' Create a query.  \n        Dim downloadTasksQuery As IEnumerable(Of Task(Of Integer)) =  \n            From url In urlList Select ProcessURLAsync(url, client)  \n  \n        ' Use ToArray to execute the query and start the download tasks.  \n        Dim downloadTasks As Task(Of Integer)() = downloadTasksQuery.ToArray()  \n  \n        ' You can do other work here before awaiting.  \n  \n        ' Await the completion of all the running tasks.  \n        Dim lengths As Integer() = Await Task.WhenAll(downloadTasks)  \n  \n        '' The previous line is equivalent to the following two statements.  \n        'Dim whenAllTask As Task(Of Integer()) = Task.WhenAll(downloadTasks)  \n        'Dim lengths As Integer() = Await whenAllTask  \n  \n        Dim total = lengths.Sum()  \n  \n        ''<snippet7>  \n        'Dim total = 0  \n        'For Each url In urlList  \n        '    ' GetByteArrayAsync returns a task. At completion, the task  \n        '    ' produces a byte array.  \n        '    '<snippet31>  \n        '    Dim urlContents As Byte() = Await client.GetByteArrayAsync(url)  \n        '    '</snippet31>  \n  \n        '    ' The following two lines can replace the previous assignment statement.  \n        '    'Dim getContentsTask As Task(Of Byte()) = client.GetByteArrayAsync(url)  \n        '    'Dim urlContents As Byte() = Await getContentsTask  \n  \n        '    DisplayResults(url, urlContents)  \n  \n        '    ' Update the total.  \n        '    total += urlContents.Length  \n        'NextNext  \n  \n        ' Display the total count for all of the web addresses.  \n        resultsTextBox.Text &= String.Format(vbCrLf & vbCrLf &  \n                                             \"Total bytes returned:  {0}\" & vbCrLf, total)  \n    End Function  \n  \n    Private Function SetUpURLList() As List(Of String)  \n  \n        Dim urls = New List(Of String) From  \n            {  \n                \"http://www.msdn.com\",  \n                \"http://msdn.microsoft.com/library/hh290136.aspx\",  \n                \"http://msdn.microsoft.com/library/ee256749.aspx\",  \n                \"http://msdn.microsoft.com/library/hh290138.aspx\",  \n                \"http://msdn.microsoft.com/library/hh290140.aspx\",  \n                \"http://msdn.microsoft.com/library/dd470362.aspx\",  \n                \"http://msdn.microsoft.com/library/aa578028.aspx\",  \n                \"http://msdn.microsoft.com/library/ms404677.aspx\",  \n                \"http://msdn.microsoft.com/library/ff730837.aspx\"  \n            }  \n        Return urls  \n    End Function  \n  \n    Private Async Function ProcessURLAsync(url As String, client As HttpClient) As Task(Of Integer)  \n  \n        Dim byteArray = Await client.GetByteArrayAsync(url)  \n        DisplayResults(url, byteArray)  \n        Return byteArray.Length  \n    End Function  \n  \n    Private Sub DisplayResults(url As String, content As Byte())  \n  \n        ' Display the length of each website. The string format   \n        ' is designed to be used with a monospaced font, such as  \n        ' Lucida Console or Global Monospace.  \n        Dim bytes = content.Length  \n        ' Strip off the \"http://\".  \n        Dim displayURL = url.Replace(\"http://\", \"\")  \n        resultsTextBox.Text &= String.Format(vbCrLf & \"{0,-58} {1,8}\", displayURL, bytes)  \n    End Sub  \n  \nEnd Class  \n```  \n  \n## See Also  \n <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=fullName>   \n [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)","nodes":[{"pos":[4,476],"nodes":[{"content":"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic) | Microsoft Docs","nodes":[{"pos":[0,90],"content":"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic) | Microsoft Docs","nodes":[{"content":"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic) | Microsoft Docs","pos":[0,90]}]}],"pos":[6,99],"yaml":true}],"content":"title: \"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic) | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"2015-07-20\"\nms.prod: .net\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-visual-basic\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"VB\"\nms.assetid: c06d386d-e996-4da9-bf3d-05a3b6c0a258\ncaps.latest.revision: 3\nauthor: dotnet-bot\nms.author: dotnetcontent\n\ntranslation.priority.mt: \n  - \"cs-cz\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"tr-tr\"","yamlblock":true},{"pos":[483,556],"content":"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic)","linkify":"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic)","nodes":[{"content":"How to: Extend the Async Walkthrough by Using Task.WhenAll (Visual Basic)","pos":[0,73]}]},{"content":"You can improve the performance of the async solution in <bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept> by using the <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=fullName&gt;</ph> method.","pos":[557,895],"source":"You can improve the performance of the async solution in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md) by using the <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=fullName> method."},{"content":"This method asynchronously awaits multiple asynchronous operations, which are represented as a collection of tasks.","pos":[896,1011]},{"content":"You might have noticed in the walkthrough that the websites download at different rates.","pos":[1018,1106]},{"content":"Sometimes one of the websites is very slow, which delays all the remaining downloads.","pos":[1107,1192]},{"content":"When you run the asynchronous solutions that you build in the walkthrough, you can end the program easily if you don't want to wait, but a better option would be to start all the downloads at the same time and let faster downloads continue without waiting for the one that’s delayed.","pos":[1193,1476]},{"content":"You apply the <ph id=\"ph1\">`Task.WhenAll`</ph> method to a collection of tasks.","pos":[1483,1544],"source":"You apply the `Task.WhenAll` method to a collection of tasks."},{"content":"The application of <ph id=\"ph1\">`WhenAll`</ph> returns a single task that isn’t complete until every task in the collection is completed.","pos":[1545,1664],"source":" The application of `WhenAll` returns a single task that isn’t complete until every task in the collection is completed."},{"content":"The tasks appear to run in parallel, but no additional threads are created.","pos":[1665,1740]},{"content":"The tasks can complete in any order.","pos":[1741,1777]},{"pos":[1785,2256],"content":"[!IMPORTANT]\n The following procedures describe extensions to the async applications that are developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md). You can develop the applications by either completing the walkthrough or downloading the code from [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191).","leadings":["","> "],"nodes":[{"content":"The following procedures describe extensions to the async applications that are developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md). You can develop the applications by either completing the walkthrough or downloading the code from [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191).","pos":[14,469],"nodes":[{"content":"The following procedures describe extensions to the async applications that are developed in <bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept>.","pos":[0,283],"source":"The following procedures describe extensions to the async applications that are developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)."},{"content":"You can develop the applications by either completing the walkthrough or downloading the code from <bpt id=\"p1\">[</bpt>Developer Code Samples<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=255191)</ept>.","pos":[284,455],"source":" You can develop the applications by either completing the walkthrough or downloading the code from [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191)."}]}]},{"content":"To run the example, you must have Visual Studio 2012 or later installed on your computer.","pos":[2267,2356]},{"pos":[2366,2422],"content":"To add Task.WhenAll to your GetURLContentsAsync solution","linkify":"To add Task.WhenAll to your GetURLContentsAsync solution","nodes":[{"content":"To add Task.WhenAll to your GetURLContentsAsync solution","pos":[0,56]}]},{"pos":[2432,2700],"content":"Add the <ph id=\"ph1\">`ProcessURLAsync`</ph> method to the first application that's developed in <bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept>.","source":"Add the `ProcessURLAsync` method to the first application that's developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)."},{"pos":[2714,2917],"content":"If you downloaded the code from  <bpt id=\"p1\">[</bpt>Developer Code Samples<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=255191)</ept>, open the AsyncWalkthrough project, and then add <ph id=\"ph1\">`ProcessURLAsync`</ph> to the MainWindow.xaml.vb file.","source":"If you downloaded the code from  [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191), open the AsyncWalkthrough project, and then add `ProcessURLAsync` to the MainWindow.xaml.vb file."},{"content":"If you developed the code by completing the walkthrough, add <ph id=\"ph1\">`ProcessURLAsync`</ph> to the application that includes the <ph id=\"ph2\">`GetURLContentsAsync`</ph> method.","pos":[2931,3076],"source":"If you developed the code by completing the walkthrough, add `ProcessURLAsync` to the application that includes the `GetURLContentsAsync` method."},{"content":"The MainWindow.xaml.vb file for this application is the first example in the \"Complete Code Examples from the Walkthrough\" section.","pos":[3077,3208]},{"content":"The <ph id=\"ph1\">`ProcessURLAsync`</ph> method consolidates the actions in the body of the <ph id=\"ph2\">`For Each`</ph> loop in <ph id=\"ph3\">`SumPageSizesAsync`</ph> in the original walkthrough.","pos":[3219,3359],"source":"The `ProcessURLAsync` method consolidates the actions in the body of the `For Each` loop in `SumPageSizesAsync` in the original walkthrough."},{"content":"The method asynchronously downloads the contents of a specified website as a byte array, and then displays and returns the length of the byte array.","pos":[3360,3508]},{"pos":[3777,3871],"content":"Comment out or delete the <ph id=\"ph1\">`For Each`</ph> loop in <ph id=\"ph2\">`SumPageSizesAsync`</ph>, as the following code shows.","source":"Comment out or delete the `For Each` loop in `SumPageSizesAsync`, as the following code shows."},{"content":"Create a collection of tasks.","pos":[4502,4531]},{"content":"The following code defines a <bpt id=\"p1\">[</bpt>query<ept id=\"p1\">](http://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d)</ept> that, when executed by the <ph id=\"ph1\">&lt;xref:System.Linq.Enumerable.ToArray%2A&gt;</ph> method, creates a collection of tasks that download the contents of each website.","pos":[4532,4790],"source":" The following code defines a [query](http://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d) that, when executed by the <xref:System.Linq.Enumerable.ToArray%2A> method, creates a collection of tasks that download the contents of each website."},{"content":"The tasks are started when the query is evaluated.","pos":[4791,4841]},{"pos":[4852,4940],"content":"Add the following code to method <ph id=\"ph1\">`SumPageSizesAsync`</ph> after the declaration of <ph id=\"ph2\">`urlList`</ph>.","source":"Add the following code to method `SumPageSizesAsync` after the declaration of `urlList`."},{"content":"Apply <ph id=\"ph1\">`Task.WhenAll`</ph> to the collection of tasks, <ph id=\"ph2\">`downloadTasks`</ph>.","pos":[5276,5341],"source":"Apply `Task.WhenAll` to the collection of tasks, `downloadTasks`."},{"content":"<ph id=\"ph1\">`Task.WhenAll`</ph> returns a single task that finishes when all the tasks in the collection of tasks have completed.","pos":[5342,5454],"source":"`Task.WhenAll` returns a single task that finishes when all the tasks in the collection of tasks have completed."},{"content":"In the following example, the <ph id=\"ph1\">`Await`</ph> expression awaits the completion of the single task that <ph id=\"ph2\">`WhenAll`</ph> returns.","pos":[5465,5578],"source":"In the following example, the `Await` expression awaits the completion of the single task that `WhenAll` returns."},{"content":"The expression evaluates to an array of integers, where each integer is the length of a downloaded website.","pos":[5579,5686]},{"content":"Add the following code to <ph id=\"ph1\">`SumPageSizesAsync`</ph>, just after the code that you added in the previous step.","pos":[5687,5790],"source":" Add the following code to `SumPageSizesAsync`, just after the code that you added in the previous step."},{"content":"Finally, use the <ph id=\"ph1\">&lt;xref:System.Linq.Enumerable.Sum%2A&gt;</ph> method to calculate the sum of the lengths of all the websites.","pos":[6151,6268],"source":"Finally, use the <xref:System.Linq.Enumerable.Sum%2A> method to calculate the sum of the lengths of all the websites."},{"content":"Add the following line to <ph id=\"ph1\">`SumPageSizesAsync`</ph>.","pos":[6269,6315],"source":" Add the following line to `SumPageSizesAsync`."},{"pos":[6382,6446],"content":"To add Task.WhenAll to the HttpClient.GetByteArrayAsync solution","linkify":"To add Task.WhenAll to the HttpClient.GetByteArrayAsync solution","nodes":[{"content":"To add Task.WhenAll to the HttpClient.GetByteArrayAsync solution","pos":[0,64]}]},{"pos":[6456,6739],"content":"Add the following version of <ph id=\"ph1\">`ProcessURLAsync`</ph> to the second application that's developed in <bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept>.","source":"Add the following version of `ProcessURLAsync` to the second application that's developed in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)."},{"pos":[6753,6966],"content":"If you downloaded the code from <bpt id=\"p1\">[</bpt>Developer Code Samples<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=255191)</ept>, open the AsyncWalkthrough_HttpClient project, and then add <ph id=\"ph1\">`ProcessURLAsync`</ph> to the MainWindow.xaml.vb file.","source":"If you downloaded the code from [Developer Code Samples](http://go.microsoft.com/fwlink/?LinkId=255191), open the AsyncWalkthrough_HttpClient project, and then add `ProcessURLAsync` to the MainWindow.xaml.vb file."},{"content":"If you developed the code by completing the walkthrough, add <ph id=\"ph1\">`ProcessURLAsync`</ph> to the application that uses the <ph id=\"ph2\">`HttpClient.GetByteArrayAsync`</ph> method.","pos":[6980,7130],"source":"If you developed the code by completing the walkthrough, add `ProcessURLAsync` to the application that uses the `HttpClient.GetByteArrayAsync` method."},{"content":"The MainWindow.xaml.vb file for this application is the second example in the \"Complete Code Examples from the Walkthrough\" section.","pos":[7131,7263]},{"content":"The <ph id=\"ph1\">`ProcessURLAsync`</ph> method consolidates the actions in the body of the <ph id=\"ph2\">`For Each`</ph> loop in <ph id=\"ph3\">`SumPageSizesAsync`</ph> in the original walkthrough.","pos":[7274,7414],"source":"The `ProcessURLAsync` method consolidates the actions in the body of the `For Each` loop in `SumPageSizesAsync` in the original walkthrough."},{"content":"The method asynchronously downloads the contents of a specified website as a byte array, and then displays and returns the length of the byte array.","pos":[7415,7563]},{"pos":[7574,7725],"content":"The only difference from the <ph id=\"ph1\">`ProcessURLAsync`</ph> method in the previous procedure is the use of the <ph id=\"ph2\">&lt;xref:System.Net.Http.HttpClient&gt;</ph> instance, <ph id=\"ph3\">`client`</ph>.","source":"The only difference from the `ProcessURLAsync` method in the previous procedure is the use of the <xref:System.Net.Http.HttpClient> instance, `client`."},{"pos":[8021,8115],"content":"Comment out or delete the <ph id=\"ph1\">`For Each`</ph> loop in <ph id=\"ph2\">`SumPageSizesAsync`</ph>, as the following code shows.","source":"Comment out or delete the `For Each` loop in `SumPageSizesAsync`, as the following code shows."},{"content":"Define a <bpt id=\"p1\">[</bpt>query<ept id=\"p1\">](http://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d)</ept> that, when executed by the <ph id=\"ph1\">&lt;xref:System.Linq.Enumerable.ToArray%2A&gt;</ph> method, creates a collection of tasks that download the contents of each website.","pos":[8762,9000],"source":"Define a [query](http://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d) that, when executed by the <xref:System.Linq.Enumerable.ToArray%2A> method, creates a collection of tasks that download the contents of each website."},{"content":"The tasks are started when the query is evaluated.","pos":[9001,9051]},{"pos":[9062,9163],"content":"Add the following code to method <ph id=\"ph1\">`SumPageSizesAsync`</ph> after the declaration of <ph id=\"ph2\">`client`</ph> and <ph id=\"ph3\">`urlList`</ph>.","source":"Add the following code to method `SumPageSizesAsync` after the declaration of `client` and `urlList`."},{"content":"Next, apply <ph id=\"ph1\">`Task.WhenAll`</ph> to the collection of tasks, <ph id=\"ph2\">`downloadTasks`</ph>.","pos":[9506,9577],"source":"Next, apply `Task.WhenAll` to the collection of tasks, `downloadTasks`."},{"content":"<ph id=\"ph1\">`Task.WhenAll`</ph> returns a single task that finishes when all the tasks in the collection of tasks have completed.","pos":[9578,9690],"source":"`Task.WhenAll` returns a single task that finishes when all the tasks in the collection of tasks have completed."},{"content":"In the following example, the <ph id=\"ph1\">`Await`</ph> expression awaits the completion of the single task that <ph id=\"ph2\">`WhenAll`</ph> returns.","pos":[9701,9814],"source":"In the following example, the `Await` expression awaits the completion of the single task that `WhenAll` returns."},{"content":"When complete, the <ph id=\"ph1\">`Await`</ph> expression evaluates to an array of integers, where each integer is the length of a downloaded website.","pos":[9815,9945],"source":" When complete, the `Await` expression evaluates to an array of integers, where each integer is the length of a downloaded website."},{"content":"Add the following code to <ph id=\"ph1\">`SumPageSizesAsync`</ph>, just after the code that you added in the previous step.","pos":[9946,10049],"source":" Add the following code to `SumPageSizesAsync`, just after the code that you added in the previous step."},{"content":"Finally, use the <ph id=\"ph1\">&lt;xref:System.Linq.Enumerable.Sum%2A&gt;</ph> method to get the sum of the lengths of all the websites.","pos":[10410,10521],"source":"Finally, use the <xref:System.Linq.Enumerable.Sum%2A> method to get the sum of the lengths of all the websites."},{"content":"Add the following line to <ph id=\"ph1\">`SumPageSizesAsync`</ph>.","pos":[10522,10568],"source":" Add the following line to `SumPageSizesAsync`."},{"pos":[10635,10669],"content":"To test the Task.WhenAll solutions","linkify":"To test the Task.WhenAll solutions","nodes":[{"content":"To test the Task.WhenAll solutions","pos":[0,34]}]},{"content":"For either solution, choose the F5 key to run the program, and then choose the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button.","pos":[10679,10775],"source":"For either solution, choose the F5 key to run the program, and then choose the **Start** button."},{"content":"The output should resemble the output from the async solutions in <bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept>.","pos":[10776,11032],"source":" The output should resemble the output from the async solutions in [Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)."},{"content":"However, notice that the websites appear in a different order each time.","pos":[11033,11105]},{"pos":[11114,11121],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[11125,11256],"content":"The following code shows the extensions to the project that uses the <ph id=\"ph1\">`GetURLContentsAsync`</ph> method to download content from the web.","source":"The following code shows the extensions to the project that uses the `GetURLContentsAsync` method to download content from the web."},{"pos":[16320,16327],"content":"Example","linkify":"Example","nodes":[{"content":"Example","pos":[0,7]}]},{"pos":[16331,16467],"content":"The following code shows the extensions to the project that uses method <ph id=\"ph1\">`HttpClient.GetByteArrayAsync`</ph> to download content from the web.","source":"The following code shows the extensions to the project that uses method `HttpClient.GetByteArrayAsync` to download content from the web."},{"pos":[20786,20794],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=fullName&gt;</ph>","pos":[20798,20868],"source":"<xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=fullName> "},{"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)<ept id=\"p1\">](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept>","pos":[20873,21062],"source":"[Walkthrough: Accessing the Web by Using Async and Await (Visual Basic)](../../../../visual-basic/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)"}]}