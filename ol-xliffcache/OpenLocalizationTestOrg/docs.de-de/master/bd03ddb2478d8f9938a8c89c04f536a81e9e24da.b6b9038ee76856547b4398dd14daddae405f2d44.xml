{"content":"---\ntitle: \"Impersonating the Client\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"service behaviors, impersonation sample\"\n  - \"Impersonating the Client Sample [Windows Communication Foundation]\"\n  - \"impersonation, Windows Communication Foundation sample\"\nms.assetid: 8bd974e1-90db-4152-95a3-1d4b1a7734f8\n---\n# Impersonating the Client\nThe Impersonation sample demonstrates how to impersonate the caller application at the service so that the service can access system resources on behalf of the caller.  \n  \n This sample is based on the [Self-Host](../../../../docs/framework/wcf/samples/self-host.md) sample. The service and client configuration files are the same as that of the [Self-Host](../../../../docs/framework/wcf/samples/self-host.md) sample.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n The service code has been modified such that the `Add` method on the service impersonates the caller using the <xref:System.ServiceModel.OperationBehaviorAttribute> as shown in the following sample code.  \n  \n```csharp\n[OperationBehavior(Impersonation = ImpersonationOption.Required)]  \npublic double Add(double n1, double n2)  \n{  \n    double result = n1 + n2;  \n    Console.WriteLine(\"Received Add({0},{1})\", n1, n2);  \n    Console.WriteLine(\"Return: {0}\", result);  \n    DisplayIdentityInformation();  \n    return result;  \n}  \n```  \n  \n As a result, the security context of the executing thread is switched to impersonate the caller before entering the `Add` method and reverted on exiting the method.  \n  \n The `DisplayIdentityInformation` method shown in the following sample code is a utility function that displays the caller's identity.  \n  \n```csharp\nstatic void DisplayIdentityInformation()  \n{  \n    Console.WriteLine(\"\\t\\tThread Identity            :{0}\",  \n         WindowsIdentity.GetCurrent().Name);  \n    Console.WriteLine(\"\\t\\tThread Identity level  :{0}\",   \n         WindowsIdentity.GetCurrent().ImpersonationLevel);  \n    Console.WriteLine(\"\\t\\thToken                     :{0}\",  \n         WindowsIdentity.GetCurrent().Token.ToString());  \n    return;  \n}  \n```  \n  \n The `Subtract` method on the service impersonates the caller using imperative calls as shown in the following sample code.  \n  \n```csharp\npublic double Subtract(double n1, double n2)  \n{  \n    double result = n1 - n2;  \n    Console.WriteLine(\"Received Subtract({0},{1})\", n1, n2);  \n    Console.WriteLine(\"Return: {0}\", result);  \n    Console.WriteLine(\"Before impersonating\");  \n    DisplayIdentityInformation();  \n  \n    if (ServiceSecurityContext.Current.WindowsIdentity.ImpersonationLevel == TokenImpersonationLevel.Impersonation ||  \n        ServiceSecurityContext.Current.WindowsIdentity.ImpersonationLevel == TokenImpersonationLevel.Delegation)  \n    {  \n        // Impersonate.  \n        using (ServiceSecurityContext.Current.WindowsIdentity.Impersonate())  \n        {  \n            // Make a system call in the caller's context and ACLs   \n            // on the system resource are enforced in the caller's context.   \n            Console.WriteLine(\"Impersonating the caller imperatively\");  \n            DisplayIdentityInformation();  \n        }  \n    }  \n    else  \n    {  \n        Console.WriteLine(\"ImpersonationLevel is not high enough to perform this operation.\");  \n    }  \n  \n    Console.WriteLine(\"After reverting\");  \n    DisplayIdentityInformation();  \n    return result;  \n}  \n```  \n  \n Note that in this case the caller is not impersonated for the entire call but is only impersonated for a portion of the call. In general, impersonating for the smallest scope is preferable to impersonating for the entire operation.  \n  \n The other methods do not impersonate the caller.  \n  \n The client code has been modified to set the impersonation level to <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>. The client specifies the impersonation level to be used by the service, by using the <xref:System.Security.Principal.TokenImpersonationLevel> enumeration. The enumeration supports the following values: <xref:System.Security.Principal.TokenImpersonationLevel.None>, <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation> and <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>. To perform an access check when accessing a system resource on the local machine that is protected using Windows ACLs, the impersonation level must be set to <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, as shown in the following sample code.  \n  \n```csharp\n// Create a client with given client endpoint configuration  \nCalculatorClient client = new CalculatorClient();  \n  \nclient.ClientCredentials.Windows.AllowedImpersonationLevel = TokenImpersonationLevel.Impersonation;  \n```  \n  \n When you run the sample, the operation requests and responses are displayed in both the service and client console windows. Press ENTER in each console window to shut down the service and client.  \n  \n> [!NOTE]\n>  The service must either run under an administrative account or the account it runs under must be granted rights to register the `http://localhost:8000/ServiceModelSamples` URI with the HTTP layer. Such rights can be granted by setting up a [Namespace Reservation](https://go.microsoft.com/fwlink/?LinkId=95012) using the [Httpcfg.exe tool](https://go.microsoft.com/fwlink/?LinkId=95010).  \n  \n> [!NOTE]\n>  On computers running [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], impersonation is supported only if the Host.exe application has the Impersonation privilege. (By default, only administrators have this permission.) To add this privilege to an account the service is running as, go to **Administrative Tools**, open **Local Security Policy**, open **Local Policies**, click **User Rights Assignment**, and select **Impersonate a Client after Authentication** and double-click **Properties** to add a user or group.  \n  \n### To set up, build, and run the sample  \n  \n1.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).  \n  \n2.  To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n3.  To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).  \n  \n4.  To demonstrate that the service impersonates the caller, run the client under a different account than the one the service is running under. To do so, at the command prompt, type:  \n  \n    ```  \n    runas /user:<machine-name>\\<user-name> client.exe  \n    ```  \n  \n     You are then prompted for a password. Enter the password for the account you previously specified.  \n  \n5.  When you run the client, note the identity before and after running it with different credentials.  \n","nodes":[{"pos":[4,310],"embed":true,"restype":"x-metadata","content":"title: \"Impersonating the Client\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"service behaviors, impersonation sample\"\n  - \"Impersonating the Client Sample [Windows Communication Foundation]\"\n  - \"impersonation, Windows Communication Foundation sample\"\nms.assetid: 8bd974e1-90db-4152-95a3-1d4b1a7734f8","nodes":[{"content":"Impersonating the Client","nodes":[{"pos":[0,24],"content":"Impersonating the Client","nodes":[{"content":"Impersonating the Client","pos":[0,24]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[317,341],"content":"Impersonating the Client","linkify":"Impersonating the Client","nodes":[{"content":"Impersonating the Client","pos":[0,24]}]},{"content":"The Impersonation sample demonstrates how to impersonate the caller application at the service so that the service can access system resources on behalf of the caller.","pos":[342,509]},{"content":"This sample is based on the <bpt id=\"p1\">[</bpt>Self-Host<ept id=\"p1\">](../../../../docs/framework/wcf/samples/self-host.md)</ept> sample.","pos":[516,616],"source":"This sample is based on the [Self-Host](../../../../docs/framework/wcf/samples/self-host.md) sample."},{"content":"The service and client configuration files are the same as that of the <bpt id=\"p1\">[</bpt>Self-Host<ept id=\"p1\">](../../../../docs/framework/wcf/samples/self-host.md)</ept> sample.","pos":[617,760],"source":" The service and client configuration files are the same as that of the [Self-Host](../../../../docs/framework/wcf/samples/self-host.md) sample."},{"pos":[768,875],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"pos":[882,1085],"content":"The service code has been modified such that the <ph id=\"ph1\">`Add`</ph> method on the service impersonates the caller using the <ph id=\"ph2\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute&gt;</ph> as shown in the following sample code.","source":"The service code has been modified such that the `Add` method on the service impersonates the caller using the <xref:System.ServiceModel.OperationBehaviorAttribute> as shown in the following sample code."},{"pos":[1423,1587],"content":"As a result, the security context of the executing thread is switched to impersonate the caller before entering the <ph id=\"ph1\">`Add`</ph> method and reverted on exiting the method.","source":"As a result, the security context of the executing thread is switched to impersonate the caller before entering the `Add` method and reverted on exiting the method."},{"pos":[1594,1727],"content":"The <ph id=\"ph1\">`DisplayIdentityInformation`</ph> method shown in the following sample code is a utility function that displays the caller's identity.","source":"The `DisplayIdentityInformation` method shown in the following sample code is a utility function that displays the caller's identity."},{"pos":[2171,2293],"content":"The <ph id=\"ph1\">`Subtract`</ph> method on the service impersonates the caller using imperative calls as shown in the following sample code.","source":"The `Subtract` method on the service impersonates the caller using imperative calls as shown in the following sample code."},{"content":"Note that in this case the caller is not impersonated for the entire call but is only impersonated for a portion of the call.","pos":[3479,3604]},{"content":"In general, impersonating for the smallest scope is preferable to impersonating for the entire operation.","pos":[3605,3710]},{"content":"The other methods do not impersonate the caller.","pos":[3717,3765]},{"content":"The client code has been modified to set the impersonation level to <ph id=\"ph1\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Impersonation&gt;</ph>.","pos":[3772,3911],"source":"The client code has been modified to set the impersonation level to <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>."},{"content":"The client specifies the impersonation level to be used by the service, by using the <ph id=\"ph1\">&lt;xref:System.Security.Principal.TokenImpersonationLevel&gt;</ph> enumeration.","pos":[3912,4066],"source":" The client specifies the impersonation level to be used by the service, by using the <xref:System.Security.Principal.TokenImpersonationLevel> enumeration."},{"content":"The enumeration supports the following values: <ph id=\"ph1\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.None&gt;</ph>, <ph id=\"ph2\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Anonymous&gt;</ph>, <ph id=\"ph3\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Identification&gt;</ph>, <ph id=\"ph4\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Impersonation&gt;</ph> and <ph id=\"ph5\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Delegation&gt;</ph>.","pos":[4067,4461],"source":" The enumeration supports the following values: <xref:System.Security.Principal.TokenImpersonationLevel.None>, <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation> and <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>."},{"content":"To perform an access check when accessing a system resource on the local machine that is protected using Windows ACLs, the impersonation level must be set to <ph id=\"ph1\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Impersonation&gt;</ph>, as shown in the following sample code.","pos":[4462,4730],"source":" To perform an access check when accessing a system resource on the local machine that is protected using Windows ACLs, the impersonation level must be set to <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, as shown in the following sample code."},{"content":"When you run the sample, the operation requests and responses are displayed in both the service and client console windows.","pos":[4975,5098]},{"content":"Press ENTER in each console window to shut down the service and client.","pos":[5099,5170]},{"pos":[5178,5576],"content":"[!NOTE]\n The service must either run under an administrative account or the account it runs under must be granted rights to register the `http://localhost:8000/ServiceModelSamples` URI with the HTTP layer. Such rights can be granted by setting up a [Namespace Reservation](https://go.microsoft.com/fwlink/?LinkId=95012) using the [Httpcfg.exe tool](https://go.microsoft.com/fwlink/?LinkId=95010).","leadings":["","> "],"nodes":[{"content":"The service must either run under an administrative account or the account it runs under must be granted rights to register the `http://localhost:8000/ServiceModelSamples` URI with the HTTP layer. Such rights can be granted by setting up a [Namespace Reservation](https://go.microsoft.com/fwlink/?LinkId=95012) using the [Httpcfg.exe tool](https://go.microsoft.com/fwlink/?LinkId=95010).","pos":[9,396],"nodes":[{"content":"The service must either run under an administrative account or the account it runs under must be granted rights to register the <ph id=\"ph1\">`http://localhost:8000/ServiceModelSamples`</ph> URI with the HTTP layer.","pos":[0,196],"source":"The service must either run under an administrative account or the account it runs under must be granted rights to register the `http://localhost:8000/ServiceModelSamples` URI with the HTTP layer."},{"content":"Such rights can be granted by setting up a <bpt id=\"p1\">[</bpt>Namespace Reservation<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=95012)</ept> using the <bpt id=\"p2\">[</bpt>Httpcfg.exe tool<ept id=\"p2\">](https://go.microsoft.com/fwlink/?LinkId=95010)</ept>.","pos":[197,387],"source":" Such rights can be granted by setting up a [Namespace Reservation](https://go.microsoft.com/fwlink/?LinkId=95012) using the [Httpcfg.exe tool](https://go.microsoft.com/fwlink/?LinkId=95010)."}]}]},{"pos":[5584,6118],"content":"[!NOTE]\n On computers running [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], impersonation is supported only if the Host.exe application has the Impersonation privilege. (By default, only administrators have this permission.) To add this privilege to an account the service is running as, go to **Administrative Tools**, open **Local Security Policy**, open **Local Policies**, click **User Rights Assignment**, and select **Impersonate a Client after Authentication** and double-click **Properties** to add a user or group.","leadings":["","> "],"nodes":[{"content":"On computers running [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], impersonation is supported only if the Host.exe application has the Impersonation privilege. (By default, only administrators have this permission.) To add this privilege to an account the service is running as, go to **Administrative Tools**, open **Local Security Policy**, open **Local Policies**, click **User Rights Assignment**, and select **Impersonate a Client after Authentication** and double-click **Properties** to add a user or group.","pos":[9,532],"nodes":[{"content":"On computers running <ph id=\"ph1\">[!INCLUDE[ws2003](../../../../includes/ws2003-md.md)]</ph>, impersonation is supported only if the Host.exe application has the Impersonation privilege.","pos":[0,168],"source":"On computers running [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], impersonation is supported only if the Host.exe application has the Impersonation privilege."},{"content":"(By default, only administrators have this permission.) To add this privilege to an account the service is running as, go to <bpt id=\"p1\">**</bpt>Administrative Tools<ept id=\"p1\">**</ept>, open <bpt id=\"p2\">**</bpt>Local Security Policy<ept id=\"p2\">**</ept>, open <bpt id=\"p3\">**</bpt>Local Policies<ept id=\"p3\">**</ept>, click <bpt id=\"p4\">**</bpt>User Rights Assignment<ept id=\"p4\">**</ept>, and select <bpt id=\"p5\">**</bpt>Impersonate a Client after Authentication<ept id=\"p5\">**</ept> and double-click <bpt id=\"p6\">**</bpt>Properties<ept id=\"p6\">**</ept> to add a user or group.","pos":[169,523],"source":" (By default, only administrators have this permission.) To add this privilege to an account the service is running as, go to **Administrative Tools**, open **Local Security Policy**, open **Local Policies**, click **User Rights Assignment**, and select **Impersonate a Client after Authentication** and double-click **Properties** to add a user or group."}]}]},{"pos":[6128,6164],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[6174,6373],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"pos":[6383,6592],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[6602,6810],"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"content":"To demonstrate that the service impersonates the caller, run the client under a different account than the one the service is running under.","pos":[6820,6960]},{"content":"To do so, at the command prompt, type:","pos":[6961,6999]},{"content":"You are then prompted for a password.","pos":[7089,7126]},{"content":"Enter the password for the account you previously specified.","pos":[7127,7187]},{"content":"When you run the client, note the identity before and after running it with different credentials.","pos":[7197,7295]}]}