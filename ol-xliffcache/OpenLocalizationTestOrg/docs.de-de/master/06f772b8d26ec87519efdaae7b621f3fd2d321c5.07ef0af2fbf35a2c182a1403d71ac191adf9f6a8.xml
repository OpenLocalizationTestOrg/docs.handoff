{"content":"---\ntitle: \"Merge Options in PLINQ\"\nms.date: \"03/30/2017\"\nms.technology: dotnet-standard\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"PLINQ queries, merge options\"\nms.assetid: e8f7be3b-88de-4f33-ab14-dc008e76c1ba\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# Merge Options in PLINQ\nWhen a query is executing as parallel, PLINQ partitions the source sequence so that multiple threads can work on different parts concurrently, typically on separate threads. If the results are to be consumed on one thread, for example, in a `foreach` (`For Each` in Visual Basic) loop, then the results from every thread must be merged back into one sequence. The kind of merge that PLINQ performs depends on the operators that are present in the query. For example, operators that impose a new order on the results must buffer all elements from all threads. From the perspective of the consuming thread (which is also that of the application user) a fully buffered query might run for a noticeable period of time before it produces its first result. Other operators, by default, are partially buffered; they yield their results in batches. One operator, <xref:System.Linq.ParallelEnumerable.ForAll%2A> is not buffered by default. It yields all elements from all threads immediately.  \n  \n By using the <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> method, as shown in the following example, you can provide a hint to PLINQ that indicates what kind of merging to perform.  \n  \n [!code-csharp[PLINQ#26](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinqsamples.cs#26)]\n [!code-vb[PLINQ#26](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#26)]  \n  \n For the complete example, see [How to: Specify Merge Options in PLINQ](../../../docs/standard/parallel-programming/how-to-specify-merge-options-in-plinq.md).  \n  \n If the particular query cannot support the requested option, then the option will just be ignored. In most cases, you do not have to specify a merge option for a PLINQ query. However, in some cases you may find by testing and measurement that a query executes best in a non-default mode. A common use of this option is to force a chunk-merging operator to stream its results in order to provide a more responsive user interface.  \n  \n## ParallelMergeOptions  \n The <xref:System.Linq.ParallelMergeOptions> enumeration includes the following options that specify, for supported query shapes, how the final output of the query is yielded when the results are consumed on one thread:  \n  \n-   `Not Buffered`  \n  \n     The <xref:System.Linq.ParallelMergeOptions.NotBuffered> option causes each processed element to be returned from each thread as soon as it is produced. This behavior is analogous to \"streaming\" the output. If the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator is present in the query, `NotBuffered` preserves the order of the source elements. Although `NotBuffered` starts yielding results as soon as they're available,, the total time to produce all the results might still be longer than using one of the other merge options.  \n  \n-   `Auto Buffered`  \n  \n     The <xref:System.Linq.ParallelMergeOptions.AutoBuffered> option causes the query to collect elements into a buffer and then periodically yield the buffer contents all at once to the consuming thread. This is analogous to yielding the source data in \"chunks\" instead of using the \"streaming\" behavior of `NotBuffered`. `AutoBuffered` may take longer than `NotBuffered` to make the first element available on the consuming thread. The size of the buffer and the exact yielding behavior are not configurable and may vary, depending on various factors that relate to the query.  \n  \n-   `FullyBuffered`  \n  \n     The <xref:System.Linq.ParallelMergeOptions.FullyBuffered> option causes the output of the whole query to be buffered before any of the elements are yielded. When you use this option, it can take longer before the first element is available on the consuming thread, but the complete results might still be produced faster than by using the other options.  \n  \n## Query Operators that Support Merge Options  \n The following table lists the operators that support all merge option modes, subject to the specified restrictions.  \n  \n|Operator|Restrictions|  \n|--------------|------------------|  \n|<xref:System.Linq.ParallelEnumerable.AsEnumerable%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.Cast%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.Concat%2A>|Non-ordered queries that have an Array or List source only.|  \n|<xref:System.Linq.ParallelEnumerable.DefaultIfEmpty%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.OfType%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.Reverse%2A>|Non-ordered queries that have an Array or List source only.|  \n|<xref:System.Linq.ParallelEnumerable.Select%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.SelectMany%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.Skip%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.Take%2A>|None|  \n|<xref:System.Linq.ParallelEnumerable.Where%2A>|None|  \n  \n All other PLINQ query operators might ignore user-provided merge options. Some query operators, for example, <xref:System.Linq.ParallelEnumerable.Reverse%2A> and <xref:System.Linq.ParallelEnumerable.OrderBy%2A>, cannot yield any elements until all have been produced and reordered. Therefore, when <xref:System.Linq.ParallelMergeOptions> is used in a query that also contains an operator such as <xref:System.Linq.ParallelEnumerable.Reverse%2A>, the merge behavior will not be applied in the query until after that operator has produced its results.  \n  \n The ability of some operators to handle merge options depends on the type of the source sequence, and whether the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator was used earlier in the query. <xref:System.Linq.ParallelEnumerable.ForAll%2A> is always <xref:System.Linq.ParallelMergeOptions.NotBuffered> ; it yields its elements immediately. <xref:System.Linq.ParallelEnumerable.OrderBy%2A> is always <xref:System.Linq.ParallelMergeOptions.FullyBuffered>; it must sort the whole list before it yields.  \n  \n## See also\n\n- [Parallel LINQ (PLINQ)](../../../docs/standard/parallel-programming/parallel-linq-plinq.md)\n- [How to: Specify Merge Options in PLINQ](../../../docs/standard/parallel-programming/how-to-specify-merge-options-in-plinq.md)\n","nodes":[{"pos":[4,268],"embed":true,"restype":"x-metadata","content":"title: \"Merge Options in PLINQ\"\nms.date: \"03/30/2017\"\nms.technology: dotnet-standard\ndev_langs: \n  - \"csharp\"\n  - \"vb\"\nhelpviewer_keywords: \n  - \"PLINQ queries, merge options\"\nms.assetid: e8f7be3b-88de-4f33-ab14-dc008e76c1ba\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"Merge Options in PLINQ","nodes":[{"pos":[0,22],"content":"Merge Options in PLINQ","nodes":[{"content":"Merge Options in PLINQ","pos":[0,22]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[275,297],"content":"Merge Options in PLINQ","linkify":"Merge Options in PLINQ","nodes":[{"content":"Merge Options in PLINQ","pos":[0,22]}]},{"content":"When a query is executing as parallel, PLINQ partitions the source sequence so that multiple threads can work on different parts concurrently, typically on separate threads.","pos":[298,471]},{"content":"If the results are to be consumed on one thread, for example, in a <ph id=\"ph1\">`foreach`</ph> (<ph id=\"ph2\">`For Each`</ph> in Visual Basic) loop, then the results from every thread must be merged back into one sequence.","pos":[472,657],"source":" If the results are to be consumed on one thread, for example, in a `foreach` (`For Each` in Visual Basic) loop, then the results from every thread must be merged back into one sequence."},{"content":"The kind of merge that PLINQ performs depends on the operators that are present in the query.","pos":[658,751]},{"content":"For example, operators that impose a new order on the results must buffer all elements from all threads.","pos":[752,856]},{"content":"From the perspective of the consuming thread (which is also that of the application user) a fully buffered query might run for a noticeable period of time before it produces its first result.","pos":[857,1048]},{"content":"Other operators, by default, are partially buffered; they yield their results in batches.","pos":[1049,1138]},{"content":"One operator, <ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.ForAll%2A&gt;</ph> is not buffered by default.","pos":[1139,1228],"source":" One operator, <xref:System.Linq.ParallelEnumerable.ForAll%2A> is not buffered by default."},{"content":"It yields all elements from all threads immediately.","pos":[1229,1281]},{"pos":[1288,1481],"content":"By using the <ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A&gt;</ph> method, as shown in the following example, you can provide a hint to PLINQ that indicates what kind of merging to perform.","source":"By using the <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> method, as shown in the following example, you can provide a hint to PLINQ that indicates what kind of merging to perform."},{"pos":[1701,1858],"content":"For the complete example, see <bpt id=\"p1\">[</bpt>How to: Specify Merge Options in PLINQ<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-specify-merge-options-in-plinq.md)</ept>.","source":"For the complete example, see [How to: Specify Merge Options in PLINQ](../../../docs/standard/parallel-programming/how-to-specify-merge-options-in-plinq.md)."},{"content":"If the particular query cannot support the requested option, then the option will just be ignored.","pos":[1865,1963]},{"content":"In most cases, you do not have to specify a merge option for a PLINQ query.","pos":[1964,2039]},{"content":"However, in some cases you may find by testing and measurement that a query executes best in a non-default mode.","pos":[2040,2152]},{"content":"A common use of this option is to force a chunk-merging operator to stream its results in order to provide a more responsive user interface.","pos":[2153,2293]},{"pos":[2302,2322],"content":"ParallelMergeOptions","linkify":"ParallelMergeOptions","nodes":[{"content":"ParallelMergeOptions","pos":[0,20]}]},{"pos":[2326,2544],"content":"The <ph id=\"ph1\">&lt;xref:System.Linq.ParallelMergeOptions&gt;</ph> enumeration includes the following options that specify, for supported query shapes, how the final output of the query is yielded when the results are consumed on one thread:","source":"The <xref:System.Linq.ParallelMergeOptions> enumeration includes the following options that specify, for supported query shapes, how the final output of the query is yielded when the results are consumed on one thread:"},{"content":"The <ph id=\"ph1\">&lt;xref:System.Linq.ParallelMergeOptions.NotBuffered&gt;</ph> option causes each processed element to be returned from each thread as soon as it is produced.","pos":[2579,2730],"source":"The <xref:System.Linq.ParallelMergeOptions.NotBuffered> option causes each processed element to be returned from each thread as soon as it is produced."},{"content":"This behavior is analogous to \"streaming\" the output.","pos":[2731,2784]},{"content":"If the <ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.AsOrdered%2A&gt;</ph> operator is present in the query, <ph id=\"ph2\">`NotBuffered`</ph> preserves the order of the source elements.","pos":[2785,2934],"source":" If the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator is present in the query, `NotBuffered` preserves the order of the source elements."},{"content":"Although <ph id=\"ph1\">`NotBuffered`</ph> starts yielding results as soon as they're available,, the total time to produce all the results might still be longer than using one of the other merge options.","pos":[2935,3119],"source":" Although `NotBuffered` starts yielding results as soon as they're available,, the total time to produce all the results might still be longer than using one of the other merge options."},{"content":"The <ph id=\"ph1\">&lt;xref:System.Linq.ParallelMergeOptions.AutoBuffered&gt;</ph> option causes the query to collect elements into a buffer and then periodically yield the buffer contents all at once to the consuming thread.","pos":[3155,3354],"source":"The <xref:System.Linq.ParallelMergeOptions.AutoBuffered> option causes the query to collect elements into a buffer and then periodically yield the buffer contents all at once to the consuming thread."},{"content":"This is analogous to yielding the source data in \"chunks\" instead of using the \"streaming\" behavior of <ph id=\"ph1\">`NotBuffered`</ph>.","pos":[3355,3472],"source":" This is analogous to yielding the source data in \"chunks\" instead of using the \"streaming\" behavior of `NotBuffered`."},{"content":"<ph id=\"ph1\">`AutoBuffered`</ph> may take longer than <ph id=\"ph2\">`NotBuffered`</ph> to make the first element available on the consuming thread.","pos":[3473,3583],"source":"`AutoBuffered` may take longer than `NotBuffered` to make the first element available on the consuming thread."},{"content":"The size of the buffer and the exact yielding behavior are not configurable and may vary, depending on various factors that relate to the query.","pos":[3584,3728]},{"content":"The <ph id=\"ph1\">&lt;xref:System.Linq.ParallelMergeOptions.FullyBuffered&gt;</ph> option causes the output of the whole query to be buffered before any of the elements are yielded.","pos":[3764,3920],"source":"The <xref:System.Linq.ParallelMergeOptions.FullyBuffered> option causes the output of the whole query to be buffered before any of the elements are yielded."},{"content":"When you use this option, it can take longer before the first element is available on the consuming thread, but the complete results might still be produced faster than by using the other options.","pos":[3921,4117]},{"pos":[4126,4168],"content":"Query Operators that Support Merge Options","linkify":"Query Operators that Support Merge Options","nodes":[{"content":"Query Operators that Support Merge Options","pos":[0,42]}]},{"content":"The following table lists the operators that support all merge option modes, subject to the specified restrictions.","pos":[4172,4287]},{"content":"Operator","pos":[4294,4302]},{"content":"Restrictions","pos":[4303,4315]},{"content":"None","pos":[4412,4416]},{"content":"None","pos":[4467,4471]},{"content":"Non-ordered queries that have an Array or List source only.","pos":[4524,4583]},{"content":"None","pos":[4644,4648]},{"content":"None","pos":[4701,4705]},{"content":"Non-ordered queries that have an Array or List source only.","pos":[4759,4818]},{"content":"None","pos":[4871,4875]},{"content":"None","pos":[4932,4936]},{"content":"None","pos":[4987,4991]},{"content":"None","pos":[5042,5046]},{"content":"None","pos":[5098,5102]},{"content":"All other PLINQ query operators might ignore user-provided merge options.","pos":[5110,5183]},{"content":"Some query operators, for example, <ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.Reverse%2A&gt;</ph> and <ph id=\"ph2\">&lt;xref:System.Linq.ParallelEnumerable.OrderBy%2A&gt;</ph>, cannot yield any elements until all have been produced and reordered.","pos":[5184,5391],"source":" Some query operators, for example, <xref:System.Linq.ParallelEnumerable.Reverse%2A> and <xref:System.Linq.ParallelEnumerable.OrderBy%2A>, cannot yield any elements until all have been produced and reordered."},{"content":"Therefore, when <ph id=\"ph1\">&lt;xref:System.Linq.ParallelMergeOptions&gt;</ph> is used in a query that also contains an operator such as <ph id=\"ph2\">&lt;xref:System.Linq.ParallelEnumerable.Reverse%2A&gt;</ph>, the merge behavior will not be applied in the query until after that operator has produced its results.","pos":[5392,5659],"source":" Therefore, when <xref:System.Linq.ParallelMergeOptions> is used in a query that also contains an operator such as <xref:System.Linq.ParallelEnumerable.Reverse%2A>, the merge behavior will not be applied in the query until after that operator has produced its results."},{"content":"The ability of some operators to handle merge options depends on the type of the source sequence, and whether the <ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.AsOrdered%2A&gt;</ph> operator was used earlier in the query.","pos":[5666,5870],"source":"The ability of some operators to handle merge options depends on the type of the source sequence, and whether the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator was used earlier in the query."},{"content":"<ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.ForAll%2A&gt;</ph> is always <ph id=\"ph2\">&lt;xref:System.Linq.ParallelMergeOptions.NotBuffered&gt;</ph> ; it yields its elements immediately.","pos":[5871,6018],"source":"<xref:System.Linq.ParallelEnumerable.ForAll%2A> is always <xref:System.Linq.ParallelMergeOptions.NotBuffered> ; it yields its elements immediately."},{"content":"<ph id=\"ph1\">&lt;xref:System.Linq.ParallelEnumerable.OrderBy%2A&gt;</ph> is always <ph id=\"ph2\">&lt;xref:System.Linq.ParallelMergeOptions.FullyBuffered&gt;</ph>; it must sort the whole list before it yields.","pos":[6019,6178],"source":"<xref:System.Linq.ParallelEnumerable.OrderBy%2A> is always <xref:System.Linq.ParallelMergeOptions.FullyBuffered>; it must sort the whole list before it yields."},{"pos":[6187,6195],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[6199,6290],"content":"<bpt id=\"p1\">[</bpt>Parallel LINQ (PLINQ)<ept id=\"p1\">](../../../docs/standard/parallel-programming/parallel-linq-plinq.md)</ept>","source":"[Parallel LINQ (PLINQ)](../../../docs/standard/parallel-programming/parallel-linq-plinq.md)"},{"pos":[6293,6419],"content":"<bpt id=\"p1\">[</bpt>How to: Specify Merge Options in PLINQ<ept id=\"p1\">](../../../docs/standard/parallel-programming/how-to-specify-merge-options-in-plinq.md)</ept>","source":"[How to: Specify Merge Options in PLINQ](../../../docs/standard/parallel-programming/how-to-specify-merge-options-in-plinq.md)"}]}