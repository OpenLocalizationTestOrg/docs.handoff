{"content":"---\ntitle: \"Custom Lifetime | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 52806c07-b91c-48fe-b992-88a41924f51f\ncaps.latest.revision: 5\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"\n---\n# Custom Lifetime\nThis sample demonstrates how to write a [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] extension to provide custom lifetime services for shared [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service instances.  \n  \n> [!NOTE]\n>  The setup procedure and build instructions for this sample are located at the end of this topic.  \n  \n## Shared Instancing  \n [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] offers several instancing modes for your service instances. The Shared Instancing mode covered in this topic provides a way to share a service instance between multiple channels. Clients can either resolve the instance’s endpoint address locally or contact a factory method in the service to obtain the endpoint address of a running instance. Once it has the endpoint address, it can create a new channel and start communication. The following code snippet shows how a client application creates a new channel to an existing service instance.  \n  \n```  \n// Create the first channel.  \nIEchoService proxy = channelFactory.CreateChannel();  \n  \n// Resolve the instance.  \nEndpointAddress epa = ((IClientChannel)proxy).ResolveInstance();  \n  \n// Create new channel factory with the endpoint address resolved by   \n// previous statement.  \nChannelFactory<IEchoService> channelFactory2 =  \n                new ChannelFactory<IEchoService>(\"echoservice\",  \n                epa);  \n  \n// Create the second channel to the same instance.  \nIEchoService proxy2 = channelFactory2.CreateChannel();  \n  \n```  \n  \n Unlike other instancing modes, the shared instancing mode has a unique way of releasing the service instances. When all the channels are closed for an instance, the service [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] runtime starts a timer. If nobody makes a connection before the timeout expires, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] releases the instance and claims the resources. As a part of the teardown procedure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] invokes the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method of all <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementations before releasing the instance. If all of them return `true` the instance is released. Otherwise the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementation is responsible for notifying the `Dispatcher` of the idle state by using a callback method.  \n  \n By default, the idle timeout value of <xref:System.ServiceModel.InstanceContext> is one minute. However this sample demonstrates how you can extend this using a custom extension.  \n  \n## Extending the InstanceContext  \n In [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], <xref:System.ServiceModel.InstanceContext> is the link between the service instance and the `Dispatcher`. [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] allows you to extend this runtime component by adding new state or behavior by using its extensible object pattern. The extensible object pattern is used in [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to either extend existing runtime classes with new functionality or to add new state features to an object. There are three interfaces in the extensible object pattern: `IExtensibleObject<T>`, `IExtension<T>`, and `IExtensionCollection<T>`.  \n  \n The `IExtensibleObject<T>` interface is implemented by objects to allow extensions which customize their functionality.  \n  \n The `IExtension<T>` interface is implemented by objects that can be extensions of classes of type `T`.  \n  \n And finally, the `IExtensionCollection<T>` interface is a collection of `IExtensions` that allows for retrieving `IExtensions` by their type.  \n  \n Therefore in order to extend the <xref:System.ServiceModel.InstanceContext> you must implement the `IExtension` interface. In this sample project the `CustomLeaseExtension` class contains this implementation.  \n  \n```  \nclass CustomLeaseExtension : IExtension<InstanceContext>  \n{  \n}  \n  \n```  \n  \n The `IExtension` interface has two methods `Attach` and `Detach`. As their names imply, these two methods are called when the runtime attaches and detaches the extension to an instance of the <xref:System.ServiceModel.InstanceContext> class. In this sample, the `Attach` method is used to keep track of the <xref:System.ServiceModel.InstanceContext> object that belongs to the current instance of the extension.  \n  \n```  \nInstanceContext owner;  \n  \npublic void Attach(InstanceContext owner)  \n{  \n  this.owner = owner;   \n}  \n```  \n  \n In addition, you must add the necessary implementation to the extension to provide the extended lifetime support. Therefore the `ICustomLease` interface is declared with the desired methods and is implemented in the `CustomLeaseExtension` class.  \n  \n```  \ninterface ICustomLease  \n{  \n    bool IsIdle { get; }          \n    InstanceContextIdleCallback Callback { get; set; }  \n}  \n  \nclass CustomLeaseExtension : IExtension<InstanceContext>, ICustomLease  \n{  \n}  \n  \n```  \n  \n When [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] invokes the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method in the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementation this call is routed to the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method of the `CustomLeaseExtension`. Then the `CustomLeaseExtension` checks its private state to see whether the <xref:System.ServiceModel.InstanceContext> is idle. If it is idle it returns `true`. Otherwise, it starts a timer for a specified amount of extended lifetime.  \n  \n```  \npublic bool IsIdle  \n{  \n  get  \n  {  \n    lock (thisLock)  \n    {  \n      if (isIdle)  \n      {  \n        return true;  \n      }  \n      else  \n      {  \n        StartTimer();  \n        return false;  \n      }  \n    }  \n  }  \n}  \n  \n```  \n  \n In the timer’s `Elapsed` event the callback function in the Dispatcher is called in order to start another clean up cycle.  \n  \n```  \nvoid idleTimer_Elapsed(object sender, ElapsedEventArgs args)  \n{  \n    idleTimer.Stop();  \n    isIdle = true;    \n    callback(owner);  \n}  \n  \n```  \n  \n There is no way to renew the running timer when a new message arrives for the instance being moved to the idle state.  \n  \n The sample implements <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> to intercept the calls to the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method and route them to the `CustomLeaseExtension`. The <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementation is contained in `CustomLifetimeLease` class. The <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method is invoked when [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] is about to release the service instance. However, there is only one instance of a particular `ISharedSessionInstance` implementation in the ServiceBehavior’s <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> collection. This means there is no way of knowing the <xref:System.ServiceModel.InstanceContext> being closed at the time [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] checks the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method. Therefore this sample uses thread locking to serialize requests to the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method.  \n  \n> [!IMPORTANT]\n>  Using thread locking is not a recommended approach because serialization can severely affect the performance of your application.  \n  \n A private member variable is used in the `CustomLeaseExtension` class to track the `IsIdle` value. Each time the value of <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> is retrieved the `IsIdle` private member is returned and reset to `false`. It is essential to set this value to `false` in order to make sure the Dispatcher calls the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.NotifyIdle%2A> method.  \n  \n```  \npublic bool IsIdle  \n{  \n    get   \n    {  \n       lock (thisLock)  \n       {  \n           bool idleCopy = isIdle;  \n           isIdle = false;  \n           return idleCopy;  \n       }  \n    }  \n}  \n  \n```  \n  \n If the `ISharedSessionLifetime.IsIdle` property returns `false` the Dispatcher registers a callback function by using the `NotifyIdle` method. This method receives a reference to the <xref:System.ServiceModel.InstanceContext> being released. Therefore the sample code can query the `ICustomLease` type extension and check the `ICustomLease.IsIdle` property in the extended state.  \n  \n```  \npublic void NotifyIdle(InstanceContextIdleCallback callback,   \n            InstanceContext instanceContext)  \n{  \n    lock (thisLock)  \n    {  \n       ICustomLease customLease =  \n           instanceContext.Extensions.Find<ICustomLease>();  \n       customLease.Callback = callback;   \n       isIdle = customLease.IsIdle;  \n       if (isIdle)  \n       {  \n             callback(instanceContext);  \n       }  \n    }   \n}  \n  \n```  \n  \n Before the `ICustomLease.IsIdle` property is checked the Callback property needs to be set as this is essential for `CustomLeaseExtension` to notify the Dispatcher when it becomes idle. If `ICustomLease.IsIdle` returns `true`, the `isIdle` private member is simply set in `CustomLifetimeLease` to `true` and calls the callback method. Because the code holds a lock, other threads cannot change the value of this private member. And the next time Dispatcher checks the `ISharedSessionLifetime.IsIdle`, it returns `true` and lets Dispatcher release the instance.  \n  \n Now that the groundwork for the custom extension is completed, it has to be hooked up to the service model. To hook up the `CustomLeaseExtension` implementation to the <xref:System.ServiceModel.InstanceContext>, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] provides the <xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer> interface to perform the bootstrapping of <xref:System.ServiceModel.InstanceContext>. In the sample, the `CustomLeaseInitializer` class implements this interface and adds an instance of `CustomLeaseExtension` to the <xref:System.ServiceModel.InstanceContext.Extensions%2A> collection from the only method initialization. This method is called by Dispatcher while initializing the <xref:System.ServiceModel.InstanceContext>.  \n  \n```  \npublic void Initialize(InstanceContext instanceContext, Message message)  \n{  \n  IExtension<InstanceContext> customLeaseExtension =  \n    new CustomLeaseExtension(timeout);  \n  instanceContext.Extensions.Add(customLeaseExtension);  \n}  \n```  \n  \n Finally the `System.ServiceModel.Dispatcher.IShareableInstanceContextLifetime` and <xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer> implementations are is hooked up to the service model by using the <xref:System.ServiceModel.Description.IServiceBehavior> implementation. This implementation is placed in the `CustomLeaseTimeAttribute` class and it also derives from the `Attribute` base class to expose this behavior as an attribute. In the `IServiceBehavior.ApplyBehavior` method, instances of <xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer> and `System.ServiceModel.Dispatcher.IShareableInstanceContextLifetime` implementations are added to the `System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextLifetimes` and <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextInitializers%2A> collections of the <xref:System.ServiceModel.Dispatcher> respectively.  \n  \n```  \npublic void ApplyBehavior(ServiceDescription description,   \n           ServiceHostBase serviceHostBase,   \n           Collection<DispatchBehavior> behaviors,  \n           Collection<BindingParameterCollection> parameters)  \n{  \n    CustomLifetimeLease customLease = new CustomLifetimeLease();  \n    CustomLeaseInitializer initializer =   \n                new CustomLeaseInitializer(timeout);  \n  \n    foreach (DispatchBehavior dispatchBehavior in behaviors)  \n    {  \n        dispatchBehavior.InstanceContextLifetimes.Add(customLease);  \n        dispatchBehavior.InstanceContextInitializers.Add(initializer);  \n    }  \n}  \n  \n```  \n  \n This behavior can be added to a sample service class by annotating it with the `CustomLeaseTime` attribute.  \n  \n```  \n[ServiceBehavior(InstanceContextMode=InstanceContextMode.Shareable)]  \n[CustomLeaseTime(Timeout = 20000)]  \npublic class EchoService : IEchoService  \n{  \n  //…  \n}  \n```  \n  \n When you run the sample, the operation requests and responses are displayed in both the service and client console windows. Press ENTER in each console window to shut down the service and client.  \n  \n#### To set up, build, and run the sample  \n  \n1.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).  \n  \n2.  To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n3.  To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md).  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Extensibility\\Instancing\\Lifetime`  \n  \n## See Also","nodes":[{"pos":[4,335],"embed":true,"restype":"x-metadata","content":"title: \"Custom Lifetime | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"03/30/2017\"\nms.prod: \".net-framework\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"dotnet-clr\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nms.assetid: 52806c07-b91c-48fe-b992-88a41924f51f\ncaps.latest.revision: 5\nauthor: \"Erikre\"\nms.author: \"erikre\"\nmanager: \"erikre\"","nodes":[{"content":"Custom Lifetime | Microsoft Docs","nodes":[{"pos":[0,32],"content":"Custom Lifetime | Microsoft Docs","nodes":[{"content":"Custom Lifetime | Microsoft Docs","pos":[0,32]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[342,357],"content":"Custom Lifetime","linkify":"Custom Lifetime","nodes":[{"content":"Custom Lifetime","pos":[0,15]}]},{"pos":[358,585],"content":"This sample demonstrates how to write a <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> extension to provide custom lifetime services for shared <ph id=\"ph2\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> service instances.","source":"This sample demonstrates how to write a [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] extension to provide custom lifetime services for shared [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service instances."},{"pos":[593,700],"content":"[!NOTE]\n The setup procedure and build instructions for this sample are located at the end of this topic.","leadings":["","> "],"nodes":[{"content":"The setup procedure and build instructions for this sample are located at the end of this topic.","pos":[9,105]}]},{"pos":[709,726],"content":"Shared Instancing","linkify":"Shared Instancing","nodes":[{"content":"Shared Instancing","pos":[0,17]}]},{"content":"<ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> offers several instancing modes for your service instances.","pos":[730,845],"source":"[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] offers several instancing modes for your service instances."},{"content":"The Shared Instancing mode covered in this topic provides a way to share a service instance between multiple channels.","pos":[846,964]},{"content":"Clients can either resolve the instance’s endpoint address locally or contact a factory method in the service to obtain the endpoint address of a running instance.","pos":[965,1128]},{"content":"Once it has the endpoint address, it can create a new channel and start communication.","pos":[1129,1215]},{"content":"The following code snippet shows how a client application creates a new channel to an existing service instance.","pos":[1216,1328]},{"content":"Unlike other instancing modes, the shared instancing mode has a unique way of releasing the service instances.","pos":[1887,1997]},{"content":"When all the channels are closed for an instance, the service <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> runtime starts a timer.","pos":[1998,2139],"source":" When all the channels are closed for an instance, the service [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] runtime starts a timer."},{"content":"If nobody makes a connection before the timeout expires, <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> releases the instance and claims the resources.","pos":[2140,2300],"source":" If nobody makes a connection before the timeout expires, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] releases the instance and claims the resources."},{"content":"As a part of the teardown procedure <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> invokes the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method of all <ph id=\"ph3\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> implementations before releasing the instance.","pos":[2301,2601],"source":" As a part of the teardown procedure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] invokes the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method of all <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementations before releasing the instance."},{"content":"If all of them return <ph id=\"ph1\">`true`</ph> the instance is released.","pos":[2602,2656],"source":" If all of them return `true` the instance is released."},{"content":"Otherwise the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> implementation is responsible for notifying the <ph id=\"ph2\">`Dispatcher`</ph> of the idle state by using a callback method.","pos":[2657,2840],"source":" Otherwise the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementation is responsible for notifying the `Dispatcher` of the idle state by using a callback method."},{"content":"By default, the idle timeout value of <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> is one minute.","pos":[2847,2942],"source":"By default, the idle timeout value of <xref:System.ServiceModel.InstanceContext> is one minute."},{"content":"However this sample demonstrates how you can extend this using a custom extension.","pos":[2943,3025]},{"pos":[3034,3063],"content":"Extending the InstanceContext","linkify":"Extending the InstanceContext","nodes":[{"content":"Extending the InstanceContext","pos":[0,29]}]},{"content":"In <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph>, <ph id=\"ph2\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> is the link between the service instance and the <ph id=\"ph3\">`Dispatcher`</ph>.","pos":[3067,3232],"source":"In [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], <xref:System.ServiceModel.InstanceContext> is the link between the service instance and the `Dispatcher`."},{"content":"<ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> allows you to extend this runtime component by adding new state or behavior by using its extensible object pattern.","pos":[3233,3404],"source":"[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] allows you to extend this runtime component by adding new state or behavior by using its extensible object pattern."},{"content":"The extensible object pattern is used in <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> to either extend existing runtime classes with new functionality or to add new state features to an object.","pos":[3405,3609],"source":" The extensible object pattern is used in [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to either extend existing runtime classes with new functionality or to add new state features to an object."},{"content":"There are three interfaces in the extensible object pattern: <ph id=\"ph1\">`IExtensibleObject&lt;T&gt;`</ph>, <ph id=\"ph2\">`IExtension&lt;T&gt;`</ph>, and <ph id=\"ph3\">`IExtensionCollection&lt;T&gt;`</ph>.","pos":[3610,3742],"source":" There are three interfaces in the extensible object pattern: `IExtensibleObject<T>`, `IExtension<T>`, and `IExtensionCollection<T>`."},{"pos":[3749,3868],"content":"The <ph id=\"ph1\">`IExtensibleObject&lt;T&gt;`</ph> interface is implemented by objects to allow extensions which customize their functionality.","source":"The `IExtensibleObject<T>` interface is implemented by objects to allow extensions which customize their functionality."},{"pos":[3875,3977],"content":"The <ph id=\"ph1\">`IExtension&lt;T&gt;`</ph> interface is implemented by objects that can be extensions of classes of type <ph id=\"ph2\">`T`</ph>.","source":"The `IExtension<T>` interface is implemented by objects that can be extensions of classes of type `T`."},{"pos":[3984,4125],"content":"And finally, the <ph id=\"ph1\">`IExtensionCollection&lt;T&gt;`</ph> interface is a collection of <ph id=\"ph2\">`IExtensions`</ph> that allows for retrieving <ph id=\"ph3\">`IExtensions`</ph> by their type.","source":"And finally, the `IExtensionCollection<T>` interface is a collection of `IExtensions` that allows for retrieving `IExtensions` by their type."},{"content":"Therefore in order to extend the <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> you must implement the <ph id=\"ph2\">`IExtension`</ph> interface.","pos":[4132,4254],"source":"Therefore in order to extend the <xref:System.ServiceModel.InstanceContext> you must implement the `IExtension` interface."},{"content":"In this sample project the <ph id=\"ph1\">`CustomLeaseExtension`</ph> class contains this implementation.","pos":[4255,4340],"source":" In this sample project the `CustomLeaseExtension` class contains this implementation."},{"content":"The <ph id=\"ph1\">`IExtension`</ph> interface has two methods <ph id=\"ph2\">`Attach`</ph> and <ph id=\"ph3\">`Detach`</ph>.","pos":[4432,4497],"source":"The `IExtension` interface has two methods `Attach` and `Detach`."},{"content":"As their names imply, these two methods are called when the runtime attaches and detaches the extension to an instance of the <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> class.","pos":[4498,4673],"source":" As their names imply, these two methods are called when the runtime attaches and detaches the extension to an instance of the <xref:System.ServiceModel.InstanceContext> class."},{"content":"In this sample, the <ph id=\"ph1\">`Attach`</ph> method is used to keep track of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> object that belongs to the current instance of the extension.","pos":[4674,4843],"source":" In this sample, the `Attach` method is used to keep track of the <xref:System.ServiceModel.InstanceContext> object that belongs to the current instance of the extension."},{"content":"In addition, you must add the necessary implementation to the extension to provide the extended lifetime support.","pos":[4970,5083]},{"content":"Therefore the <ph id=\"ph1\">`ICustomLease`</ph> interface is declared with the desired methods and is implemented in the <ph id=\"ph2\">`CustomLeaseExtension`</ph> class.","pos":[5084,5215],"source":" Therefore the `ICustomLease` interface is declared with the desired methods and is implemented in the `CustomLeaseExtension` class."},{"content":"When <ph id=\"ph1\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> invokes the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method in the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> implementation this call is routed to the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method of the <ph id=\"ph5\">`CustomLeaseExtension`</ph>.","pos":[5449,5824],"source":"When [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] invokes the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method in the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementation this call is routed to the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method of the `CustomLeaseExtension`."},{"content":"Then the <ph id=\"ph1\">`CustomLeaseExtension`</ph> checks its private state to see whether the <ph id=\"ph2\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> is idle.","pos":[5825,5952],"source":" Then the `CustomLeaseExtension` checks its private state to see whether the <xref:System.ServiceModel.InstanceContext> is idle."},{"content":"If it is idle it returns <ph id=\"ph1\">`true`</ph>.","pos":[5953,5985],"source":" If it is idle it returns `true`."},{"content":"Otherwise, it starts a timer for a specified amount of extended lifetime.","pos":[5986,6059]},{"pos":[6315,6437],"content":"In the timer’s <ph id=\"ph1\">`Elapsed`</ph> event the callback function in the Dispatcher is called in order to start another clean up cycle.","source":"In the timer’s `Elapsed` event the callback function in the Dispatcher is called in order to start another clean up cycle."},{"content":"There is no way to renew the running timer when a new message arrives for the instance being moved to the idle state.","pos":[6603,6720]},{"content":"The sample implements <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> to intercept the calls to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method and route them to the <ph id=\"ph3\">`CustomLeaseExtension`</ph>.","pos":[6727,6967],"source":"The sample implements <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> to intercept the calls to the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method and route them to the `CustomLeaseExtension`."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> implementation is contained in <ph id=\"ph2\">`CustomLifetimeLease`</ph> class.","pos":[6968,7094],"source":" The <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> implementation is contained in `CustomLifetimeLease` class."},{"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method is invoked when <ph id=\"ph2\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> is about to release the service instance.","pos":[7095,7292],"source":" The <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method is invoked when [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] is about to release the service instance."},{"content":"However, there is only one instance of a particular <ph id=\"ph1\">`ISharedSessionInstance`</ph> implementation in the ServiceBehavior’s <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> collection.","pos":[7293,7484],"source":" However, there is only one instance of a particular `ISharedSessionInstance` implementation in the ServiceBehavior’s <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> collection."},{"content":"This means there is no way of knowing the <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> being closed at the time <ph id=\"ph2\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> checks the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method.","pos":[7485,7742],"source":" This means there is no way of knowing the <xref:System.ServiceModel.InstanceContext> being closed at the time [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] checks the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method."},{"content":"Therefore this sample uses thread locking to serialize requests to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A&gt;</ph> method.","pos":[7743,7894],"source":" Therefore this sample uses thread locking to serialize requests to the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.IsIdle%2A> method."},{"pos":[7902,8047],"content":"[!IMPORTANT]\n Using thread locking is not a recommended approach because serialization can severely affect the performance of your application.","leadings":["","> "],"nodes":[{"content":"Using thread locking is not a recommended approach because serialization can severely affect the performance of your application.","pos":[14,143]}]},{"content":"A private member variable is used in the <ph id=\"ph1\">`CustomLeaseExtension`</ph> class to track the <ph id=\"ph2\">`IsIdle`</ph> value.","pos":[8054,8152],"source":"A private member variable is used in the `CustomLeaseExtension` class to track the `IsIdle` value."},{"content":"Each time the value of <ph id=\"ph1\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider&gt;</ph> is retrieved the <ph id=\"ph2\">`IsIdle`</ph> private member is returned and reset to <ph id=\"ph3\">`false`</ph>.","pos":[8153,8313],"source":" Each time the value of <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider> is retrieved the `IsIdle` private member is returned and reset to `false`."},{"content":"It is essential to set this value to <ph id=\"ph1\">`false`</ph> in order to make sure the Dispatcher calls the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.NotifyIdle%2A&gt;</ph> method.","pos":[8314,8490],"source":" It is essential to set this value to `false` in order to make sure the Dispatcher calls the <xref:System.ServiceModel.Dispatcher.IInstanceContextProvider.NotifyIdle%2A> method."},{"content":"If the <ph id=\"ph1\">`ISharedSessionLifetime.IsIdle`</ph> property returns <ph id=\"ph2\">`false`</ph> the Dispatcher registers a callback function by using the <ph id=\"ph3\">`NotifyIdle`</ph> method.","pos":[8714,8856],"source":"If the `ISharedSessionLifetime.IsIdle` property returns `false` the Dispatcher registers a callback function by using the `NotifyIdle` method."},{"content":"This method receives a reference to the <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph> being released.","pos":[8857,8955],"source":" This method receives a reference to the <xref:System.ServiceModel.InstanceContext> being released."},{"content":"Therefore the sample code can query the <ph id=\"ph1\">`ICustomLease`</ph> type extension and check the <ph id=\"ph2\">`ICustomLease.IsIdle`</ph> property in the extended state.","pos":[8956,9093],"source":" Therefore the sample code can query the `ICustomLease` type extension and check the `ICustomLease.IsIdle` property in the extended state."},{"content":"Before the <ph id=\"ph1\">`ICustomLease.IsIdle`</ph> property is checked the Callback property needs to be set as this is essential for <ph id=\"ph2\">`CustomLeaseExtension`</ph> to notify the Dispatcher when it becomes idle.","pos":[9540,9725],"source":"Before the `ICustomLease.IsIdle` property is checked the Callback property needs to be set as this is essential for `CustomLeaseExtension` to notify the Dispatcher when it becomes idle."},{"content":"If <ph id=\"ph1\">`ICustomLease.IsIdle`</ph> returns <ph id=\"ph2\">`true`</ph>, the <ph id=\"ph3\">`isIdle`</ph> private member is simply set in <ph id=\"ph4\">`CustomLifetimeLease`</ph> to <ph id=\"ph5\">`true`</ph> and calls the callback method.","pos":[9726,9874],"source":" If `ICustomLease.IsIdle` returns `true`, the `isIdle` private member is simply set in `CustomLifetimeLease` to `true` and calls the callback method."},{"content":"Because the code holds a lock, other threads cannot change the value of this private member.","pos":[9875,9967]},{"content":"And the next time Dispatcher checks the <ph id=\"ph1\">`ISharedSessionLifetime.IsIdle`</ph>, it returns <ph id=\"ph2\">`true`</ph> and lets Dispatcher release the instance.","pos":[9968,10100],"source":" And the next time Dispatcher checks the `ISharedSessionLifetime.IsIdle`, it returns `true` and lets Dispatcher release the instance."},{"content":"Now that the groundwork for the custom extension is completed, it has to be hooked up to the service model.","pos":[10107,10214]},{"content":"To hook up the <ph id=\"ph1\">`CustomLeaseExtension`</ph> implementation to the <ph id=\"ph2\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph>, <ph id=\"ph3\">[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]</ph> provides the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer&gt;</ph> interface to perform the bootstrapping of <ph id=\"ph5\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph>.","pos":[10215,10539],"source":" To hook up the `CustomLeaseExtension` implementation to the <xref:System.ServiceModel.InstanceContext>, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] provides the <xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer> interface to perform the bootstrapping of <xref:System.ServiceModel.InstanceContext>."},{"content":"In the sample, the <ph id=\"ph1\">`CustomLeaseInitializer`</ph> class implements this interface and adds an instance of <ph id=\"ph2\">`CustomLeaseExtension`</ph> to the <ph id=\"ph3\">&lt;xref:System.ServiceModel.InstanceContext.Extensions%2A&gt;</ph> collection from the only method initialization.","pos":[10540,10774],"source":" In the sample, the `CustomLeaseInitializer` class implements this interface and adds an instance of `CustomLeaseExtension` to the <xref:System.ServiceModel.InstanceContext.Extensions%2A> collection from the only method initialization."},{"content":"This method is called by Dispatcher while initializing the <ph id=\"ph1\">&lt;xref:System.ServiceModel.InstanceContext&gt;</ph>.","pos":[10775,10877],"source":" This method is called by Dispatcher while initializing the <xref:System.ServiceModel.InstanceContext>."},{"content":"Finally the <ph id=\"ph1\">`System.ServiceModel.Dispatcher.IShareableInstanceContextLifetime`</ph> and <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer&gt;</ph> implementations are is hooked up to the service model by using the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Description.IServiceBehavior&gt;</ph> implementation.","pos":[11136,11423],"source":"Finally the `System.ServiceModel.Dispatcher.IShareableInstanceContextLifetime` and <xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer> implementations are is hooked up to the service model by using the <xref:System.ServiceModel.Description.IServiceBehavior> implementation."},{"content":"This implementation is placed in the <ph id=\"ph1\">`CustomLeaseTimeAttribute`</ph> class and it also derives from the <ph id=\"ph2\">`Attribute`</ph> base class to expose this behavior as an attribute.","pos":[11424,11586],"source":" This implementation is placed in the `CustomLeaseTimeAttribute` class and it also derives from the `Attribute` base class to expose this behavior as an attribute."},{"content":"In the <ph id=\"ph1\">`IServiceBehavior.ApplyBehavior`</ph> method, instances of <ph id=\"ph2\">&lt;xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer&gt;</ph> and <ph id=\"ph3\">`System.ServiceModel.Dispatcher.IShareableInstanceContextLifetime`</ph> implementations are added to the <ph id=\"ph4\">`System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextLifetimes`</ph> and <ph id=\"ph5\">&lt;xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextInitializers%2A&gt;</ph> collections of the <ph id=\"ph6\">&lt;xref:System.ServiceModel.Dispatcher&gt;</ph> respectively.","pos":[11587,12051],"source":" In the `IServiceBehavior.ApplyBehavior` method, instances of <xref:System.ServiceModel.Dispatcher.IInstanceContextInitializer> and `System.ServiceModel.Dispatcher.IShareableInstanceContextLifetime` implementations are added to the `System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextLifetimes` and <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextInitializers%2A> collections of the <xref:System.ServiceModel.Dispatcher> respectively."},{"pos":[12700,12807],"content":"This behavior can be added to a sample service class by annotating it with the <ph id=\"ph1\">`CustomLeaseTime`</ph> attribute.","source":"This behavior can be added to a sample service class by annotating it with the `CustomLeaseTime` attribute."},{"content":"When you run the sample, the operation requests and responses are displayed in both the service and client console windows.","pos":[12995,13118]},{"content":"Press ENTER in each console window to shut down the service and client.","pos":[13119,13190]},{"pos":[13201,13237],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[13247,13446],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"pos":[13456,13665],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"pos":[13675,13883],"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"pos":[13891,14023],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all <ph id=\"ph1\">[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]</ph> and <ph id=\"ph2\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[14077,14403],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[14404,14454]},{"pos":[14544,14552],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]}]}