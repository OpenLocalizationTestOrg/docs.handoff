{"content":"---\ntitle: \"Walkthrough: Hosting a WPF Clock in Win32\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords:\n  - \"interoperability [WPF], tutorials\"\n  - \"Win32 code [WPF], WPF interoperation\"\n  - \"interoperability [WPF], Win32\"\nms.assetid: 555e55a7-0851-4ec8-b1c6-0acba7e9b648\n---\n\n# Walkthrough: Hosting a WPF Clock in Win32\n\nTo put [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] inside [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] applications, use <xref:System.Windows.Interop.HwndSource>, which provides the HWND that contains your [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content. First you create the <xref:System.Windows.Interop.HwndSource>, giving it parameters similar to CreateWindow. Then you tell the <xref:System.Windows.Interop.HwndSource> about the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content you want inside it. Finally, you get the HWND out of the <xref:System.Windows.Interop.HwndSource>. This walkthrough illustrates how to create a mixed [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] inside [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] application that reimplements the operating system **Date and Time Properties** dialog.\n\n## Prerequisites\n\nSee [WPF and Win32 Interoperation](wpf-and-win32-interoperation.md).\n\n## How to Use This Tutorial\n\nThis tutorial concentrates on the important steps of producing an interoperation application. The tutorial is backed by a sample, [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051), but that sample is reflective of the end product. This tutorial documents the steps as if you were starting with an existing [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project of your own, perhaps a pre-existing project, and you were adding a hosted [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] to your application. You can compare your end product with [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051).\n\n## A Walkthrough of Windows Presentation Framework Inside Win32 (HwndSource)\n\nThe following graphic shows the intended end product of this tutorial:\n\n![Date and Time Properties dialog box](./media/interoparch06.PNG \"InteropArch06\")\n\nYou can recreate this dialog by creating C++ [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project in [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)], and using the dialog editor to create the following:\n\n![Date and Time Properties dialog box](./media/interoparch07.PNG \"InteropArch07\")\n\n(You do not need to use [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)] to use <xref:System.Windows.Interop.HwndSource>, and you do not need to use C++ to write [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] programs, but this is a fairly typical way to do it, and lends itself well to a stepwise tutorial explanation).\n\nYou need to accomplish five particular substeps in order to put a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock into the dialog:\n\n1. Enable your [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project to call managed code (**/clr**) by changing project settings in [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)].\n\n2. Create a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> in a separate DLL.\n\n3. Put that [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> inside an <xref:System.Windows.Interop.HwndSource>.\n\n4. Get an HWND for that <xref:System.Windows.Controls.Page> using the <xref:System.Windows.Interop.HwndSource.Handle%2A> property.\n\n5. Use [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] to decide where to place the HWND within the larger [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] application\n\n## /clr\n\nThe first step is to turn this unmanaged [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project into one that can call managed code. You use the /clr compiler option, which will link to the necessary DLLs you want to use, and adjust the Main method for use with [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)].\n\nTo enable the use of managed code inside the C++ project: Right-click on win32clock project and select **Properties**. On the **General** property page (the default), change Common Language Runtime support to `/clr`.\n\nNext, add references to DLLs necessary for [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]: PresentationCore.dll, PresentationFramework.dll, System.dll, WindowsBase.dll, UIAutomationProvider.dll, and UIAutomationTypes.dll. (Following instructions assume the operating system is installed on C: drive.)\n\n1. Right-click win32clock project and select **References...**, and inside that dialog:\n\n2. Right-click win32clock project and select **References...**.\n\n3. Click **Add New Reference**, click Browse tab, enter C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\PresentationCore.dll, and click OK.\n\n4. Repeat for PresentationFramework.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\PresentationFramework.dll.\n\n5. Repeat for WindowsBase.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\WindowsBase.dll.\n\n6. Repeat for UIAutomationTypes.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\UIAutomationTypes.dll.\n\n7. Repeat for UIAutomationProvider.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\UIAutomationProvider.dll.\n\n8. Click **Add New Reference**, select System.dll, and click **OK**.\n\n9. Click **OK** to exit the win32clock Property Pages for adding references.\n\n Finally, add the `STAThreadAttribute` to the `_tWinMain` method for use with [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]:\n\n```cpp\n[System::STAThreadAttribute]\nint APIENTRY _tWinMain(HINSTANCE hInstance,\n                     HINSTANCE hPrevInstance,\n                     LPTSTR    lpCmdLine,\n                     int       nCmdShow)\n```\n\nThis attribute tells the [!INCLUDE[TLA#tla_clr](../../../../includes/tlasharptla-clr-md.md)] that when it initializes [!INCLUDE[TLA#tla_com](../../../../includes/tlasharptla-com-md.md)], it should use a single threaded apartment model (STA), which is necessary for [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] (and [!INCLUDE[TLA#tla_winforms](../../../../includes/tlasharptla-winforms-md.md)]).\n\n## Create a Windows Presentation Framework Page\n\nNext, you create a DLL that defines a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page>. It’s often easiest to create the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> as a standalone application, and write and debug the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] portion that way. Once done, that project can be turned into a DLL by right-clicking the project, clicking on **Properties**, going to the Application, and changing Output type to Windows Class Library.\n\nThe [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] dll project can then be combined with the [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project (one solution that contains two projects) – right-click on the solution, select **Add\\Existing Project**.\n\nTo use that [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] dll from the [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project, you need to add a reference:\n\n1. Right-click win32clock project and select **References...**.\n\n2. Click **Add New Reference**.\n\n3. Click the **Projects** tab. Select WPFClock, click OK.\n\n4. Click **OK** to exit the win32clock Property Pages for adding references.\n\n## HwndSource\n\nNext, you use <xref:System.Windows.Interop.HwndSource> to make the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> look like an HWND. You add this block of code to a C++ file:\n\n```cpp\nnamespace ManagedCode\n{\n    using namespace System;\n    using namespace System::Windows;\n    using namespace System::Windows::Interop;\n    using namespace System::Windows::Media;\n\n    HWND GetHwnd(HWND parent, int x, int y, int width, int height) {\n        HwndSource^ source = gcnew HwndSource(\n            0, // class style\n            WS_VISIBLE | WS_CHILD, // style\n            0, // exstyle\n            x, y, width, height,\n            \"hi\", // NAME\n            IntPtr(parent)        // parent window\n            );\n\n        UIElement^ page = gcnew WPFClock::Clock();\n        source->RootVisual = page;\n        return (HWND) source->Handle.ToPointer();\n    }\n}\n}\n```\n\n This is a long piece of code that could use some explanation. The first part is various clauses so that you do not need to fully qualify all the calls:\n\n```cpp\nnamespace ManagedCode\n{\n    using namespace System;\n    using namespace System::Windows;\n    using namespace System::Windows::Interop;\n    using namespace System::Windows::Media;\n```\n\n Then you define a function that creates the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content, puts an <xref:System.Windows.Interop.HwndSource> around it, and returns the HWND:\n\n```cpp\nHWND GetHwnd(HWND parent, int x, int y, int width, int height) {\n```\n\nFirst you create an <xref:System.Windows.Interop.HwndSource>, whose parameters are similar to CreateWindow:\n\n```cpp\nHwndSource^ source = gcnew HwndSource(\n    0, // class style\n    WS_VISIBLE | WS_CHILD, // style\n    0, // exstyle\n    x, y, width, height,\n    \"hi\", // NAME\n    IntPtr(parent) // parent window\n);\n```\n\nThen you create the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content class by calling its constructor:\n\n```cpp\nUIElement^ page = gcnew WPFClock::Clock();\n```\n\nYou then connect the page to the <xref:System.Windows.Interop.HwndSource>:\n\n```cpp\nsource->RootVisual = page;\n```\n\n And in the final line, return the HWND for the <xref:System.Windows.Interop.HwndSource>:\n\n```cpp\nreturn (HWND) source->Handle.ToPointer();\n```\n\n## Positioning the Hwnd\n\nNow that you have an HWND that contains the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock, you need to put that HWND inside the [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] dialog. If you knew just where to put the HWND, you would just pass that size and location to the `GetHwnd` function you defined earlier. But you used a resource file to define the dialog, so you are not exactly sure where any of the HWNDs are positioned. You can use the [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)] dialog editor to put a [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] STATIC control where you want the clock to go (\"Insert clock here\"), and use that to position the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock.\n\nWhere you handle WM_INITDIALOG, you use `GetDlgItem` to retrieve the HWND for the placeholder STATIC:\n\n```cpp\nHWND placeholder = GetDlgItem(hDlg, IDC_CLOCK);\n```\n\nYou then calculate the size and position of that placeholder STATIC, so you can put the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock in that place:\n\nRECT rectangle;\n\n```cpp\nGetWindowRect(placeholder, &rectangle);\nint width = rectangle.right - rectangle.left;\nint height = rectangle.bottom - rectangle.top;\nPOINT point;\npoint.x = rectangle.left;\npoint.y = rectangle.top;\nresult = MapWindowPoints(NULL, hDlg, &point, 1);\n```\n\nThen you hide the placeholder STATIC:\n\n```cpp\nShowWindow(placeholder, SW_HIDE);\n```\n\nAnd create the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock HWND in that location:\n\n```cpp\nHWND clock = ManagedCode::GetHwnd(hDlg, point.x, point.y, width, height);\n```\n\nTo make the tutorial interesting, and to produce a real [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock, you will need to create a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock control at this point. You can do so mostly in markup, with just a few event handlers in code-behind. Since this tutorial is about interoperation and not about control design, complete code for the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock is provided here as a code block, without discrete instructions for building it up or what each part means. Feel free to experiment with this code to change the look and feel or functionality of the control.\n\nHere is the markup:\n\n[!code-xaml[Win32Clock#AllClockXAML](~/samples/snippets/csharp/VS_Snippets_Wpf/Win32Clock/CS/Clock.xaml#allclockxaml)]\n\nAnd here is the accompanying code-behind:\n\n[!code-csharp[Win32Clock#AllClockCS](~/samples/snippets/csharp/VS_Snippets_Wpf/Win32Clock/CS/Clock.xaml.cs#allclockcs)]\n\nThe final result looks like:\n\n![Date and Time Properties dialog box](./media/interoparch08.PNG \"InteropArch08\")\n\nTo compare your end result to the code that produced this screenshot, see [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051).\n\n## See also\n\n- <xref:System.Windows.Interop.HwndSource>\n- [WPF and Win32 Interoperation](wpf-and-win32-interoperation.md)\n- [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051)\n","nodes":[{"pos":[4,265],"embed":true,"restype":"x-metadata","content":"title: \"Walkthrough: Hosting a WPF Clock in Win32\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords:\n  - \"interoperability [WPF], tutorials\"\n  - \"Win32 code [WPF], WPF interoperation\"\n  - \"interoperability [WPF], Win32\"\nms.assetid: 555e55a7-0851-4ec8-b1c6-0acba7e9b648","nodes":[{"content":"Walkthrough: Hosting a WPF Clock in Win32","nodes":[{"pos":[0,41],"content":"Walkthrough: Hosting a WPF Clock in Win32","nodes":[{"content":"Walkthrough: Hosting a WPF Clock in Win32","pos":[0,41]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[273,314],"content":"Walkthrough: Hosting a WPF Clock in Win32","linkify":"Walkthrough: Hosting a WPF Clock in Win32","nodes":[{"content":"Walkthrough: Hosting a WPF Clock in Win32","pos":[0,41]}]},{"content":"To put <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> inside <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> applications, use <ph id=\"ph3\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>, which provides the HWND that contains your <ph id=\"ph4\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> content.","pos":[316,679],"source":"To put [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] inside [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] applications, use <xref:System.Windows.Interop.HwndSource>, which provides the HWND that contains your [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content."},{"content":"First you create the <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>, giving it parameters similar to CreateWindow.","pos":[680,788],"source":" First you create the <xref:System.Windows.Interop.HwndSource>, giving it parameters similar to CreateWindow."},{"content":"Then you tell the <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph> about the <ph id=\"ph2\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> content you want inside it.","pos":[789,967],"source":" Then you tell the <xref:System.Windows.Interop.HwndSource> about the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content you want inside it."},{"content":"Finally, you get the HWND out of the <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>.","pos":[968,1046],"source":" Finally, you get the HWND out of the <xref:System.Windows.Interop.HwndSource>."},{"content":"This walkthrough illustrates how to create a mixed <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> inside <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> application that reimplements the operating system <bpt id=\"p1\">**</bpt>Date and Time Properties<ept id=\"p1\">**</ept> dialog.","pos":[1047,1348],"source":" This walkthrough illustrates how to create a mixed [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] inside [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] application that reimplements the operating system **Date and Time Properties** dialog."},{"pos":[1353,1366],"content":"Prerequisites","linkify":"Prerequisites","nodes":[{"content":"Prerequisites","pos":[0,13]}]},{"pos":[1368,1436],"content":"See <bpt id=\"p1\">[</bpt>WPF and Win32 Interoperation<ept id=\"p1\">](wpf-and-win32-interoperation.md)</ept>.","source":"See [WPF and Win32 Interoperation](wpf-and-win32-interoperation.md)."},{"pos":[1441,1465],"content":"How to Use This Tutorial","linkify":"How to Use This Tutorial","nodes":[{"content":"How to Use This Tutorial","pos":[0,24]}]},{"content":"This tutorial concentrates on the important steps of producing an interoperation application.","pos":[1467,1560]},{"content":"The tutorial is backed by a sample, <bpt id=\"p1\">[</bpt>Win32 Clock Interoperation Sample<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkID=160051)</ept>, but that sample is reflective of the end product.","pos":[1561,1731],"source":" The tutorial is backed by a sample, [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051), but that sample is reflective of the end product."},{"content":"This tutorial documents the steps as if you were starting with an existing <ph id=\"ph1\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> project of your own, perhaps a pre-existing project, and you were adding a hosted <ph id=\"ph2\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> to your application.","pos":[1732,2065],"source":" This tutorial documents the steps as if you were starting with an existing [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project of your own, perhaps a pre-existing project, and you were adding a hosted [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] to your application."},{"content":"You can compare your end product with <bpt id=\"p1\">[</bpt>Win32 Clock Interoperation Sample<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkID=160051)</ept>.","pos":[2066,2188],"source":" You can compare your end product with [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051)."},{"pos":[2193,2266],"content":"A Walkthrough of Windows Presentation Framework Inside Win32 (HwndSource)","linkify":"A Walkthrough of Windows Presentation Framework Inside Win32 (HwndSource)","nodes":[{"content":"A Walkthrough of Windows Presentation Framework Inside Win32 (HwndSource)","pos":[0,73]}]},{"content":"The following graphic shows the intended end product of this tutorial:","pos":[2268,2338]},{"pos":[2340,2421],"content":"<bpt id=\"p1\">![</bpt>Date and Time Properties dialog box<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interoparch06.PNG \"</bpt>InteropArch06<ept id=\"p2\">\")</ept>","source":"![Date and Time Properties dialog box](./media/interoparch06.PNG \"InteropArch06\")"},{"pos":[2423,2686],"content":"You can recreate this dialog by creating C++ <ph id=\"ph1\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> project in <ph id=\"ph2\">[!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)]</ph>, and using the dialog editor to create the following:","source":"You can recreate this dialog by creating C++ [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project in [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)], and using the dialog editor to create the following:"},{"pos":[2688,2769],"content":"<bpt id=\"p1\">![</bpt>Date and Time Properties dialog box<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interoparch07.PNG \"</bpt>InteropArch07<ept id=\"p2\">\")</ept>","source":"![Date and Time Properties dialog box](./media/interoparch07.PNG \"InteropArch07\")"},{"pos":[2771,3149],"content":"(You do not need to use <ph id=\"ph1\">[!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)]</ph> to use <ph id=\"ph2\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>, and you do not need to use C++ to write <ph id=\"ph3\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> programs, but this is a fairly typical way to do it, and lends itself well to a stepwise tutorial explanation).","source":"(You do not need to use [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)] to use <xref:System.Windows.Interop.HwndSource>, and you do not need to use C++ to write [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] programs, but this is a fairly typical way to do it, and lends itself well to a stepwise tutorial explanation)."},{"pos":[3151,3321],"content":"You need to accomplish five particular substeps in order to put a <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock into the dialog:","source":"You need to accomplish five particular substeps in order to put a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock into the dialog:"},{"pos":[3326,3564],"content":"Enable your <ph id=\"ph1\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> project to call managed code (<bpt id=\"p1\">**</bpt>/clr<ept id=\"p1\">**</ept>) by changing project settings in <ph id=\"ph2\">[!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)]</ph>.","source":"Enable your [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project to call managed code (**/clr**) by changing project settings in [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)]."},{"pos":[3569,3713],"content":"Create a <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph><ph id=\"ph2\">&lt;xref:System.Windows.Controls.Page&gt;</ph> in a separate DLL.","source":"Create a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> in a separate DLL."},{"pos":[3718,3895],"content":"Put that <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph><ph id=\"ph2\">&lt;xref:System.Windows.Controls.Page&gt;</ph> inside an <ph id=\"ph3\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>.","source":"Put that [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> inside an <xref:System.Windows.Interop.HwndSource>."},{"pos":[3900,4027],"content":"Get an HWND for that <ph id=\"ph1\">&lt;xref:System.Windows.Controls.Page&gt;</ph> using the <ph id=\"ph2\">&lt;xref:System.Windows.Interop.HwndSource.Handle%2A&gt;</ph> property.","source":"Get an HWND for that <xref:System.Windows.Controls.Page> using the <xref:System.Windows.Interop.HwndSource.Handle%2A> property."},{"pos":[4032,4247],"content":"Use <ph id=\"ph1\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> to decide where to place the HWND within the larger <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> application","source":"Use [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] to decide where to place the HWND within the larger [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] application"},{"pos":[4252,4256],"content":"/clr","linkify":"/clr","nodes":[{"content":"/clr","pos":[0,4]}]},{"content":"The first step is to turn this unmanaged <ph id=\"ph1\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> project into one that can call managed code.","pos":[4258,4417],"source":"The first step is to turn this unmanaged [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project into one that can call managed code."},{"content":"You use the /clr compiler option, which will link to the necessary DLLs you want to use, and adjust the Main method for use with <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph>.","pos":[4418,4629],"source":" You use the /clr compiler option, which will link to the necessary DLLs you want to use, and adjust the Main method for use with [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]."},{"content":"To enable the use of managed code inside the C++ project: Right-click on win32clock project and select <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.","pos":[4631,4749],"source":"To enable the use of managed code inside the C++ project: Right-click on win32clock project and select **Properties**."},{"content":"On the <bpt id=\"p1\">**</bpt>General<ept id=\"p1\">**</ept> property page (the default), change Common Language Runtime support to <ph id=\"ph1\">`/clr`</ph>.","pos":[4750,4847],"source":" On the **General** property page (the default), change Common Language Runtime support to `/clr`."},{"content":"Next, add references to DLLs necessary for <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph>: PresentationCore.dll, PresentationFramework.dll, System.dll, WindowsBase.dll, UIAutomationProvider.dll, and UIAutomationTypes.dll.","pos":[4849,5105],"source":"Next, add references to DLLs necessary for [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]: PresentationCore.dll, PresentationFramework.dll, System.dll, WindowsBase.dll, UIAutomationProvider.dll, and UIAutomationTypes.dll."},{"content":"(Following instructions assume the operating system is installed on C: drive.)","pos":[5106,5184]},{"pos":[5189,5273],"content":"Right-click win32clock project and select <bpt id=\"p1\">**</bpt>References...<ept id=\"p1\">**</ept>, and inside that dialog:","source":"Right-click win32clock project and select **References...**, and inside that dialog:"},{"pos":[5278,5338],"content":"Right-click win32clock project and select <bpt id=\"p1\">**</bpt>References...<ept id=\"p1\">**</ept>.","source":"Right-click win32clock project and select **References...**."},{"pos":[5343,5494],"content":"Click <bpt id=\"p1\">**</bpt>Add New Reference<ept id=\"p1\">**</ept>, click Browse tab, enter C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\PresentationCore.dll, and click OK.","source":"Click **Add New Reference**, click Browse tab, enter C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\PresentationCore.dll, and click OK."},{"content":"Repeat for PresentationFramework.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\PresentationFramework.dll.","pos":[5499,5626]},{"content":"Repeat for WindowsBase.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\WindowsBase.dll.","pos":[5631,5738]},{"content":"Repeat for UIAutomationTypes.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\UIAutomationTypes.dll.","pos":[5743,5862]},{"content":"Repeat for UIAutomationProvider.dll: C:\\Program Files\\Reference Assemblies\\Microsoft\\Framework\\v3.0\\UIAutomationProvider.dll.","pos":[5867,5992]},{"pos":[5997,6062],"content":"Click <bpt id=\"p1\">**</bpt>Add New Reference<ept id=\"p1\">**</ept>, select System.dll, and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","source":"Click **Add New Reference**, select System.dll, and click **OK**."},{"pos":[6067,6140],"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to exit the win32clock Property Pages for adding references.","source":"Click **OK** to exit the win32clock Property Pages for adding references."},{"pos":[6143,6302],"content":"Finally, add the <ph id=\"ph1\">`STAThreadAttribute`</ph> to the <ph id=\"ph2\">`_tWinMain`</ph> method for use with <ph id=\"ph3\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph>:","source":"Finally, add the `STAThreadAttribute` to the `_tWinMain` method for use with [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]:"},{"pos":[6518,6949],"content":"This attribute tells the <ph id=\"ph1\">[!INCLUDE[TLA#tla_clr](../../../../includes/tlasharptla-clr-md.md)]</ph> that when it initializes <ph id=\"ph2\">[!INCLUDE[TLA#tla_com](../../../../includes/tlasharptla-com-md.md)]</ph>, it should use a single threaded apartment model (STA), which is necessary for <ph id=\"ph3\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> (and <ph id=\"ph4\">[!INCLUDE[TLA#tla_winforms](../../../../includes/tlasharptla-winforms-md.md)]</ph>).","source":"This attribute tells the [!INCLUDE[TLA#tla_clr](../../../../includes/tlasharptla-clr-md.md)] that when it initializes [!INCLUDE[TLA#tla_com](../../../../includes/tlasharptla-com-md.md)], it should use a single threaded apartment model (STA), which is necessary for [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] (and [!INCLUDE[TLA#tla_winforms](../../../../includes/tlasharptla-winforms-md.md)])."},{"pos":[6954,6998],"content":"Create a Windows Presentation Framework Page","linkify":"Create a Windows Presentation Framework Page","nodes":[{"content":"Create a Windows Presentation Framework Page","pos":[0,44]}]},{"content":"Next, you create a DLL that defines a <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph><ph id=\"ph2\">&lt;xref:System.Windows.Controls.Page&gt;</ph>.","pos":[7000,7155],"source":"Next, you create a DLL that defines a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page>."},{"content":"It’s often easiest to create the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph><ph id=\"ph2\">&lt;xref:System.Windows.Controls.Page&gt;</ph> as a standalone application, and write and debug the <ph id=\"ph3\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> portion that way.","pos":[7156,7458],"source":" It’s often easiest to create the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> as a standalone application, and write and debug the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] portion that way."},{"content":"Once done, that project can be turned into a DLL by right-clicking the project, clicking on <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>, going to the Application, and changing Output type to Windows Class Library.","pos":[7459,7643],"source":" Once done, that project can be turned into a DLL by right-clicking the project, clicking on **Properties**, going to the Application, and changing Output type to Windows Class Library."},{"pos":[7645,7960],"content":"The <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> dll project can then be combined with the <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> project (one solution that contains two projects) – right-click on the solution, select <bpt id=\"p1\">**</bpt>Add\\Existing Project<ept id=\"p1\">**</ept>.","source":"The [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] dll project can then be combined with the [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project (one solution that contains two projects) – right-click on the solution, select **Add\\Existing Project**."},{"pos":[7962,8180],"content":"To use that <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> dll from the <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> project, you need to add a reference:","source":"To use that [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] dll from the [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] project, you need to add a reference:"},{"pos":[8185,8245],"content":"Right-click win32clock project and select <bpt id=\"p1\">**</bpt>References...<ept id=\"p1\">**</ept>.","source":"Right-click win32clock project and select **References...**."},{"pos":[8250,8278],"content":"Click <bpt id=\"p1\">**</bpt>Add New Reference<ept id=\"p1\">**</ept>.","source":"Click **Add New Reference**."},{"pos":[8283,8337],"content":"Click the <bpt id=\"p1\">**</bpt>Projects<ept id=\"p1\">**</ept> tab. Select WPFClock, click OK.","source":"Click the **Projects** tab. Select WPFClock, click OK."},{"pos":[8342,8415],"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to exit the win32clock Property Pages for adding references.","source":"Click **OK** to exit the win32clock Property Pages for adding references."},{"pos":[8420,8430],"content":"HwndSource","linkify":"HwndSource","nodes":[{"content":"HwndSource","pos":[0,10]}]},{"content":"Next, you use <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph> to make the <ph id=\"ph2\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph><ph id=\"ph3\">&lt;xref:System.Windows.Controls.Page&gt;</ph> look like an HWND.","pos":[8432,8634],"source":"Next, you use <xref:System.Windows.Interop.HwndSource> to make the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]<xref:System.Windows.Controls.Page> look like an HWND."},{"content":"You add this block of code to a C++ file:","pos":[8635,8676]},{"content":"This is a long piece of code that could use some explanation.","pos":[9359,9420]},{"content":"The first part is various clauses so that you do not need to fully qualify all the calls:","pos":[9421,9510]},{"pos":[9704,9920],"content":"Then you define a function that creates the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> content, puts an <ph id=\"ph2\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph> around it, and returns the HWND:","source":"Then you define a function that creates the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content, puts an <xref:System.Windows.Interop.HwndSource> around it, and returns the HWND:"},{"pos":[9999,10106],"content":"First you create an <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>, whose parameters are similar to CreateWindow:","source":"First you create an <xref:System.Windows.Interop.HwndSource>, whose parameters are similar to CreateWindow:"},{"pos":[10317,10460],"content":"Then you create the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> content class by calling its constructor:","source":"Then you create the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] content class by calling its constructor:"},{"pos":[10517,10591],"content":"You then connect the page to the <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>:","source":"You then connect the page to the <xref:System.Windows.Interop.HwndSource>:"},{"pos":[10633,10721],"content":"And in the final line, return the HWND for the <ph id=\"ph1\">&lt;xref:System.Windows.Interop.HwndSource&gt;</ph>:","source":"And in the final line, return the HWND for the <xref:System.Windows.Interop.HwndSource>:"},{"pos":[10780,10800],"content":"Positioning the Hwnd","linkify":"Positioning the Hwnd","nodes":[{"content":"Positioning the Hwnd","pos":[0,20]}]},{"content":"Now that you have an HWND that contains the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock, you need to put that HWND inside the <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> dialog.","pos":[10802,11053],"source":"Now that you have an HWND that contains the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock, you need to put that HWND inside the [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] dialog."},{"content":"If you knew just where to put the HWND, you would just pass that size and location to the <ph id=\"ph1\">`GetHwnd`</ph> function you defined earlier.","pos":[11054,11183],"source":" If you knew just where to put the HWND, you would just pass that size and location to the `GetHwnd` function you defined earlier."},{"content":"But you used a resource file to define the dialog, so you are not exactly sure where any of the HWNDs are positioned.","pos":[11184,11301]},{"content":"You can use the <ph id=\"ph1\">[!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)]</ph> dialog editor to put a <ph id=\"ph2\">[!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)]</ph> STATIC control where you want the clock to go (\"Insert clock here\"), and use that to position the <ph id=\"ph3\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock.","pos":[11302,11681],"source":" You can use the [!INCLUDE[TLA#tla_visualstu](../../../../includes/tlasharptla-visualstu-md.md)] dialog editor to put a [!INCLUDE[TLA2#tla_win32](../../../../includes/tla2sharptla-win32-md.md)] STATIC control where you want the clock to go (\"Insert clock here\"), and use that to position the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock."},{"pos":[11683,11784],"content":"Where you handle WM_INITDIALOG, you use <ph id=\"ph1\">`GetDlgItem`</ph> to retrieve the HWND for the placeholder STATIC:","source":"Where you handle WM_INITDIALOG, you use `GetDlgItem` to retrieve the HWND for the placeholder STATIC:"},{"pos":[11846,12036],"content":"You then calculate the size and position of that placeholder STATIC, so you can put the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock in that place:","source":"You then calculate the size and position of that placeholder STATIC, so you can put the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock in that place:"},{"content":"RECT rectangle;","pos":[12038,12053]},{"content":"Then you hide the placeholder STATIC:","pos":[12313,12350]},{"pos":[12398,12523],"content":"And create the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock HWND in that location:","source":"And create the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock HWND in that location:"},{"content":"To make the tutorial interesting, and to produce a real <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock, you will need to create a <ph id=\"ph2\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock control at this point.","pos":[12611,12892],"source":"To make the tutorial interesting, and to produce a real [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock, you will need to create a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock control at this point."},{"content":"You can do so mostly in markup, with just a few event handlers in code-behind.","pos":[12893,12971]},{"content":"Since this tutorial is about interoperation and not about control design, complete code for the <ph id=\"ph1\">[!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)]</ph> clock is provided here as a code block, without discrete instructions for building it up or what each part means.","pos":[12972,13263],"source":" Since this tutorial is about interoperation and not about control design, complete code for the [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] clock is provided here as a code block, without discrete instructions for building it up or what each part means."},{"content":"Feel free to experiment with this code to change the look and feel or functionality of the control.","pos":[13264,13363]},{"content":"Here is the markup:","pos":[13365,13384]},{"content":"And here is the accompanying code-behind:","pos":[13506,13547]},{"content":"The final result looks like:","pos":[13670,13698]},{"pos":[13700,13781],"content":"<bpt id=\"p1\">![</bpt>Date and Time Properties dialog box<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interoparch08.PNG \"</bpt>InteropArch08<ept id=\"p2\">\")</ept>","source":"![Date and Time Properties dialog box](./media/interoparch08.PNG \"InteropArch08\")"},{"pos":[13783,13941],"content":"To compare your end result to the code that produced this screenshot, see <bpt id=\"p1\">[</bpt>Win32 Clock Interoperation Sample<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkID=160051)</ept>.","source":"To compare your end result to the code that produced this screenshot, see [Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051)."},{"pos":[13946,13954],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[14001,14064],"content":"<bpt id=\"p1\">[</bpt>WPF and Win32 Interoperation<ept id=\"p1\">](wpf-and-win32-interoperation.md)</ept>","source":"[WPF and Win32 Interoperation](wpf-and-win32-interoperation.md)"},{"pos":[14067,14150],"content":"<bpt id=\"p1\">[</bpt>Win32 Clock Interoperation Sample<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkID=160051)</ept>","source":"[Win32 Clock Interoperation Sample](https://go.microsoft.com/fwlink/?LinkID=160051)"}]}