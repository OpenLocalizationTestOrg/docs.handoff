{"content":"---\ntitle: \"Handling Reentrancy in Async Apps (C#) | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"2015-07-20\"\nms.prod: .net\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-csharp\"\n\nms.topic: \"article\"\ndev_langs: \n  - \"CSharp\"\nms.assetid: 47c5075e-c448-45ce-9155-ed4e7e98c677\ncaps.latest.revision: 3\nauthor: \"BillWagner\"\nms.author: \"wiwagn\"\n\ntranslation.priority.mt: \n  - \"cs-cz\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"tr-tr\"\n---\n# Handling Reentrancy in Async Apps (C#)\nWhen you include asynchronous code in your app, you should consider and possibly prevent reentrancy, which refers to reentering an asynchronous operation before it has completed. If you don't identify and handle possibilities for reentrancy, it can cause unexpected results.  \n  \n **In this topic**  \n  \n-   [Recognizing Reentrancy](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n-   [Handling Reentrancy](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n    -   [Disable the Start Button](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n    -   [Cancel and Restart the Operation](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n    -   [Run Multiple Operations and Queue the Output](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n-   [Reviewing and Running the Example App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n> [!NOTE]\n>  To run the example, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.  \n  \n##  <a name=\"BKMK_RecognizingReentrancy\"></a> Recognizing Reentrancy  \n In the example in this topic, users choose a **Start** button to initiate an asynchronous app that downloads a series of websites and calculates the total number of bytes that are downloaded. A synchronous version of the example would respond the same way regardless of how many times a user chooses the button because, after the first time, the UI thread ignores those events until the app finishes running. In an asynchronous app, however, the UI thread continues to respond, and you might reenter the asynchronous operation before it has completed.  \n  \n The following example shows the expected output if the user chooses the **Start** button only once. A list of the downloaded websites appears with the size, in bytes, of each site. The total number of bytes appears at the end.  \n  \n```  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n3. msdn.microsoft.com/library/jj155761.aspx                29019  \n4. msdn.microsoft.com/library/hh290140.aspx               117152  \n5. msdn.microsoft.com/library/hh524395.aspx                68959  \n6. msdn.microsoft.com/library/ms404677.aspx               197325  \n7. msdn.microsoft.com                                            42972  \n8. msdn.microsoft.com/library/ff730837.aspx               146159  \n  \nTOTAL bytes returned:  890591  \n```  \n  \n However, if the user chooses the button more than once, the event handler is invoked repeatedly, and the download process is reentered each time. As a result, several asynchronous operations are running at the same time, the output interleaves the results, and the total number of bytes is confusing.  \n  \n```  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n3. msdn.microsoft.com/library/jj155761.aspx                29019  \n4. msdn.microsoft.com/library/hh290140.aspx               117152  \n5. msdn.microsoft.com/library/hh524395.aspx                68959  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n6. msdn.microsoft.com/library/ms404677.aspx               197325  \n3. msdn.microsoft.com/en-us/library/jj155761.aspx                29019  \n7. msdn.microsoft.com                                            42972  \n4. msdn.microsoft.com/library/hh290140.aspx               117152  \n8. msdn.microsoft.com/library/ff730837.aspx               146159  \n  \nTOTAL bytes returned:  890591  \n  \n5. msdn.microsoft.com/library/hh524395.aspx                68959  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n6. msdn.microsoft.com/library/ms404677.aspx               197325  \n3. msdn.microsoft.com/library/jj155761.aspx                29019  \n4. msdn.microsoft.com/library/hh290140.aspx               117152  \n7. msdn.microsoft.com                                            42972  \n5. msdn.microsoft.com/library/hh524395.aspx                68959  \n8. msdn.microsoft.com/library/ff730837.aspx               146159  \n  \nTOTAL bytes returned:  890591  \n  \n6. msdn.microsoft.com/library/ms404677.aspx               197325  \n7. msdn.microsoft.com                                            42972  \n8. msdn.microsoft.com/library/ff730837.aspx               146159  \n  \nTOTAL bytes returned:  890591  \n```  \n  \n You can review the code that produces this output by scrolling to the end of this topic. You can experiment with the code by downloading the solution to your local computer and then running the WebsiteDownload project or by using the code at the end of this topic to create your own project For more information and instructions, see [Reviewing and Running the Example App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645).  \n  \n##  <a name=\"BKMK_HandlingReentrancy\"></a> Handling Reentrancy  \n You can handle reentrancy in a variety of ways, depending on what you want your app to do. This topic presents the following examples:  \n  \n-   [Disable the Start Button](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n     Disable the **Start** button while the operation is running so that the user can't interrupt it.  \n  \n-   [Cancel and Restart the Operation](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n     Cancel any operation that is still running when the user chooses the **Start** button again, and then let the most recently requested operation continue.  \n  \n-   [Run Multiple Operations and Queue the Output](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)  \n  \n     Allow all requested operations to run asynchronously, but coordinate the display of output so that the results from each operation appear together and in order.  \n  \n###  <a name=\"BKMK_DisableTheStartButton\"></a> Disable the Start Button  \n You can block the **Start** button while an operation is running by disabling the button at the top of the `StartButton_Click` event handler. You can then reenable the button from within a  `finally` block when the operation finishes so that users can run the app again.  \n  \n The following code shows these changes, which are marked with asterisks. You can add the changes to the code at the end of this topic, or you can download the finished app from [Async Samples: Reentrancy in .NET Desktop Apps](http://go.microsoft.com/fwlink/?LinkId=266571). The project name is DisableStartButton.  \n  \n```csharp  \nprivate async void StartButton_Click(object sender, RoutedEventArgs e)  \n{  \n    // This line is commented out to make the results clearer in the output.  \n    //ResultsTextBox.Text = \"\";  \n  \n    // ***Disable the Start button until the downloads are complete.   \n    StartButton.IsEnabled = false;   \n  \n    try  \n    {  \n        await AccessTheWebAsync();  \n    }  \n    catch (Exception)  \n    {  \n        ResultsTextBox.Text += \"\\r\\nDownloads failed.\";  \n    }  \n    // ***Enable the Start button in case you want to run the program again.   \n    finally  \n    {  \n        StartButton.IsEnabled = true;  \n    }  \n}  \n```  \n  \n As a result of the changes, the button doesn't respond while `AccessTheWebAsync` is downloading the websites, so the process can’t be reentered.  \n  \n###  <a name=\"BKMK_CancelAndRestart\"></a> Cancel and Restart the Operation  \n Instead of disabling the **Start** button, you can keep the button active but, if the user chooses that button again, cancel the operation that's already running and let the most recently started operation continue.  \n  \n For more information about cancellation, see [Fine-Tuning Your Async Application (C#)](../../../../csharp/programming-guide/concepts/async/fine-tuning-your-async-application.md).  \n  \n To set up this scenario, make the following changes to the basic code that is provided in [Reviewing and Running the Example App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645). You also can download the finished app from [Async Samples: Reentrancy in .NET Desktop Apps](http://go.microsoft.com/fwlink/?LinkId=266571). The name of this project is CancelAndRestart.  \n  \n1.  Declare a <xref:System.Threading.CancellationTokenSource> variable, `cts`, that’s in scope for all methods.  \n  \n    ```csharp  \n    public partial class MainWindow : Window   // Or class MainPage  \n    {  \n        // *** Declare a System.Threading.CancellationTokenSource.  \n        CancellationTokenSource cts;  \n    ```  \n  \n2.  In `StartButton_Click`, determine whether an operation is already underway. If the value of `cts` is null, no operation is already active. If the value isn't null, the operation that is already running is canceled.  \n  \n    ```csharp  \n    // *** If a download process is already underway, cancel it.  \n    if (cts != null)  \n    {  \n        cts.Cancel();  \n    }  \n    ```  \n  \n3.  Set `cts` to a different value that represents the current process.  \n  \n    ```csharp  \n    // *** Now set cts to a new value that you can use to cancel the current process  \n    // if the button is chosen again.  \n    CancellationTokenSource newCTS = new CancellationTokenSource();  \n    cts = newCTS;  \n    ```  \n  \n4.  At the end of `StartButton_Click`, the current process is complete, so set the value of `cts` back to null.  \n  \n    ```csharp  \n    // *** When the process is complete, signal that another process can begin.  \n    if (cts == newCTS)  \n        cts = null;  \n    ```  \n  \n The following code shows all the changes in `StartButton_Click`. The additions are marked with asterisks.  \n  \n```csharp  \nprivate async void StartButton_Click(object sender, RoutedEventArgs e)  \n{  \n    // This line is commented out to make the results clearer in the output.  \n    //ResultsTextBox.Clear();  \n  \n    // *** If a download process is already underway, cancel it.  \n    if (cts != null)  \n    {  \n        cts.Cancel();  \n    }  \n  \n    // *** Now set cts to cancel the current process if the button is chosen again.  \n    CancellationTokenSource newCTS = new CancellationTokenSource();  \n    cts = newCTS;  \n  \n    try  \n    {  \n        // ***Send cts.Token to carry the message if there is a cancellation request.  \n        await AccessTheWebAsync(cts.Token);  \n  \n    }  \n    // *** Catch cancellations separately.  \n    catch (OperationCanceledException)  \n    {  \n        ResultsTextBox.Text += \"\\r\\nDownloads canceled.\\r\\n\";  \n    }  \n    catch (Exception)  \n    {  \n        ResultsTextBox.Text += \"\\r\\nDownloads failed.\\r\\n\";  \n    }  \n    // *** When the process is complete, signal that another process can proceed.  \n    if (cts == newCTS)  \n        cts = null;  \n}  \n```  \n  \n In `AccessTheWebAsync`, make the following changes.  \n  \n-   Add a parameter to accept the cancellation token from `StartButton_Click`.  \n  \n-   Use the <xref:System.Net.Http.HttpClient.GetAsync%2A> method to download the websites because `GetAsync` accepts a <xref:System.Threading.CancellationToken> argument.  \n  \n-   Before calling `DisplayResults` to display the results for each downloaded website, check `ct` to verify that the current operation hasn’t been canceled.  \n  \n The following code shows these changes, which are marked with asterisks.  \n  \n```csharp  \n// *** Provide a parameter for the CancellationToken from StartButton_Click.  \nasync Task AccessTheWebAsync(CancellationToken ct)  \n{  \n    // Declare an HttpClient object.  \n    HttpClient client = new HttpClient();  \n  \n    // Make a list of web addresses.  \n    List<string> urlList = SetUpURLList();  \n  \n    var total = 0;  \n    var position = 0;  \n  \n    foreach (var url in urlList)  \n    {  \n        // *** Use the HttpClient.GetAsync method because it accepts a   \n        // cancellation token.  \n        HttpResponseMessage response = await client.GetAsync(url, ct);  \n  \n        // *** Retrieve the website contents from the HttpResponseMessage.  \n        byte[] urlContents = await response.Content.ReadAsByteArrayAsync();  \n  \n        // *** Check for cancellations before displaying information about the   \n        // latest site.   \n        ct.ThrowIfCancellationRequested();  \n  \n        DisplayResults(url, urlContents, ++position);  \n  \n        // Update the total.  \n        total += urlContents.Length;  \n    }  \n  \n    // Display the total count for all of the websites.  \n    ResultsTextBox.Text +=  \n        string.Format(\"\\r\\n\\r\\nTOTAL bytes returned:  {0}\\r\\n\", total);  \n}     \n```  \n  \n If you choose the **Start** button several times while this app is running, it should produce results that resemble the following output.  \n  \n```  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n3. msdn.microsoft.com/library/jj155761.aspx                29019  \n4. msdn.microsoft.com/library/hh290140.aspx               122505  \n5. msdn.microsoft.com/library/hh524395.aspx                68959  \n6. msdn.microsoft.com/library/ms404677.aspx               197325  \nDownload canceled.  \n  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n3. msdn.microsoft.com/library/jj155761.aspx                29019  \nDownload canceled.  \n  \n1. msdn.microsoft.com/library/hh191443.aspx                83732  \n2. msdn.microsoft.com/library/aa578028.aspx               205273  \n3. msdn.microsoft.com/library/jj155761.aspx                29019  \n4. msdn.microsoft.com/library/hh290140.aspx               117152  \n5. msdn.microsoft.com/library/hh524395.aspx                68959  \n6. msdn.microsoft.com/library/ms404677.aspx               197325  \n7. msdn.microsoft.com                                            42972  \n8. msdn.microsoft.com/library/ff730837.aspx               146159  \n  \nTOTAL bytes returned:  890591  \n```  \n  \n To eliminate the partial lists, uncomment the first line of code in `StartButton_Click` to clear the text box each time the user restarts the operation.  \n  \n###  <a name=\"BKMK_RunMultipleOperations\"></a> Run Multiple Operations and Queue the Output  \n This third example is the most complicated in that the app starts another asynchronous operation each time that the user chooses the **Start** button, and all the operations run to completion. All the requested operations download websites from the list asynchronously, but the output from the operations is presented sequentially. That is, the actual downloading activity is interleaved, as the output in [Recognizing Reentrancy](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) shows, but the list of results for each group is presented separately.  \n  \n The operations share a global <xref:System.Threading.Tasks.Task>, `pendingWork`, which serves as a gatekeeper for the display process.  \n  \n You can run this example by pasting the changes into the code in [Building the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), or you can follow the instructions in [Downloading the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) to download the sample and then run the QueueResults project.  \n  \n The following output shows the result if the user chooses the **Start** button only once. The letter label, A, indicates that the result is from the first time the **Start** button is chosen. The numbers show the order of the URLs in the list of download targets.  \n  \n```  \n  \n#Starting group A.  \n#Task assigned for group A.  \n  \nA-1. msdn.microsoft.com/library/hh191443.aspx                87389  \nA-2. msdn.microsoft.com/library/aa578028.aspx               209858  \nA-3. msdn.microsoft.com/library/jj155761.aspx                30870  \nA-4. msdn.microsoft.com/library/hh290140.aspx               119027  \nA-5. msdn.microsoft.com/library/hh524395.aspx                71260  \nA-6. msdn.microsoft.com/library/ms404677.aspx               199186  \nA-7. msdn.microsoft.com                                            53266  \nA-8. msdn.microsoft.com/library/ff730837.aspx               148020  \n  \nTOTAL bytes returned:  918876  \n  \n#Group A is complete.  \n```  \n  \n If the user chooses the **Start** button three times, the app produces output that resembles the following lines. The information lines that start with a pound sign (#) trace the progress of the application.  \n  \n```  \n#Starting group A.  \n#Task assigned for group A.  \n  \nA-1. msdn.microsoft.com/library/hh191443.aspx                87389  \nA-2. msdn.microsoft.com/library/aa578028.aspx               207089  \nA-3. msdn.microsoft.com/library/jj155761.aspx                30870  \nA-4. msdn.microsoft.com/library/hh290140.aspx               119027  \nA-5. msdn.microsoft.com/library/hh524395.aspx                71259  \nA-6. msdn.microsoft.com/library/ms404677.aspx               199185  \n  \n#Starting group B.  \n#Task assigned for group B.  \n  \nA-7. msdn.microsoft.com                                            53266  \n  \n#Starting group C.  \n#Task assigned for group C.  \n  \nA-8. msdn.microsoft.com/library/ff730837.aspx               148010  \n  \nTOTAL bytes returned:  916095  \n  \nB-1. msdn.microsoft.com/library/hh191443.aspx                87389  \nB-2. msdn.microsoft.com/library/aa578028.aspx               207089  \nB-3. msdn.microsoft.com/library/jj155761.aspx                30870  \nB-4. msdn.microsoft.com/library/hh290140.aspx               119027  \nB-5. msdn.microsoft.com/library/hh524395.aspx                71260  \nB-6. msdn.microsoft.com/library/ms404677.aspx               199186  \n  \n#Group A is complete.  \n  \nB-7. msdn.microsoft.com                                            53266  \nB-8. msdn.microsoft.com/library/ff730837.aspx               148010  \n  \nTOTAL bytes returned:  916097  \n  \nC-1. msdn.microsoft.com/library/hh191443.aspx                87389  \nC-2. msdn.microsoft.com/library/aa578028.aspx               207089  \n  \n#Group B is complete.  \n  \nC-3. msdn.microsoft.com/library/jj155761.aspx                30870  \nC-4. msdn.microsoft.com/library/hh290140.aspx               119027  \nC-5. msdn.microsoft.com/library/hh524395.aspx                72765  \nC-6. msdn.microsoft.com/library/ms404677.aspx               199186  \nC-7. msdn.microsoft.com                                            56190  \nC-8. msdn.microsoft.com/library/ff730837.aspx               148010  \n  \nTOTAL bytes returned:  920526  \n  \n#Group C is complete.  \n  \n```  \n  \n Groups B and C start before group A has finished, but the output for the each group appears separately. All the output for group A appears first, followed by all the output for group B, and then all the output for group C. The app always displays the groups in order and, for each group, always displays the information about the individual websites in the order that the URLs appear in the list of URLs.  \n  \n However, you can't predict the order in which the downloads actually happen. After multiple groups have been started, the download tasks that they generate are all active. You can't assume that A-1 will be downloaded before B-1, and you can't assume that A-1 will be downloaded before A-2.  \n  \n#### Global Definitions  \n The sample code contains the following two global declarations that are visible from all methods.  \n  \n```csharp  \npublic partial class MainWindow : Window  // Class MainPage in Windows Store app.  \n{  \n    // ***Declare the following variables where all methods can access them.   \n    private Task pendingWork = null;     \n    private char group = (char)('A' - 1);  \n```  \n  \n The `Task` variable, `pendingWork`, oversees the display process and prevents any group from interrupting another group's display operation. The character variable, `group`, labels the output from different groups to verify that results appear in the expected order.  \n  \n#### The Click Event Handler  \n The event handler, `StartButton_Click`, increments the group letter each time the user chooses the **Start** button. Then the handler calls `AccessTheWebAsync` to run the downloading operation.  \n  \n```csharp  \nprivate async void StartButton_Click(object sender, RoutedEventArgs e)  \n{  \n    // ***Verify that each group's results are displayed together, and that  \n    // the groups display in order, by marking each group with a letter.  \n    group = (char)(group + 1);  \n    ResultsTextBox.Text += string.Format(\"\\r\\n\\r\\n#Starting group {0}.\", group);  \n  \n    try  \n    {  \n        // *** Pass the group value to AccessTheWebAsync.  \n        char finishedGroup = await AccessTheWebAsync(group);  \n  \n        // The following line verifies a successful return from the download and  \n        // display procedures.   \n        ResultsTextBox.Text += string.Format(\"\\r\\n\\r\\n#Group {0} is complete.\\r\\n\", finishedGroup);  \n    }  \n    catch (Exception)  \n    {  \n        ResultsTextBox.Text += \"\\r\\nDownloads failed.\";  \n    }  \n}  \n```  \n  \n#### The AccessTheWebAsync Method  \n This example splits `AccessTheWebAsync` into two methods. The first method, `AccessTheWebAsync`, starts all the download tasks for a group and sets up `pendingWork` to control the display process. The method uses a Language Integrated Query (LINQ query) and <xref:System.Linq.Enumerable.ToArray%2A> to start all the download tasks at the same time.  \n  \n `AccessTheWebAsync` then calls `FinishOneGroupAsync` to await the completion of each download and display its length.  \n  \n `FinishOneGroupAsync` returns a task that's assigned to `pendingWork` in `AccessTheWebAsync`. That value prevents interruption by another operation before the task is complete.  \n  \n```csharp  \nprivate async Task<char> AccessTheWebAsync(char grp)  \n{  \n    HttpClient client = new HttpClient();  \n  \n    // Make a list of the web addresses to download.  \n    List<string> urlList = SetUpURLList();  \n  \n    // ***Kick off the downloads. The application of ToArray activates all the download tasks.  \n    Task<byte[]>[] getContentTasks = urlList.Select(url => client.GetByteArrayAsync(url)).ToArray();  \n  \n    // ***Call the method that awaits the downloads and displays the results.  \n    // Assign the Task that FinishOneGroupAsync returns to the gatekeeper task, pendingWork.  \n    pendingWork = FinishOneGroupAsync(urlList, getContentTasks, grp);  \n  \n    ResultsTextBox.Text += string.Format(\"\\r\\n#Task assigned for group {0}. Download tasks are active.\\r\\n\", grp);  \n  \n    // ***This task is complete when a group has finished downloading and displaying.  \n    await pendingWork;  \n  \n    // You can do other work here or just return.  \n    return grp;  \n}  \n```  \n  \n#### The FinishOneGroupAsync Method  \n This method cycles through the download tasks in a group, awaiting each one, displaying the length of the downloaded website, and adding the length to the total.  \n  \n The first statement in `FinishOneGroupAsync` uses `pendingWork` to make sure that entering the method doesn't interfere with an operation that is already in the display process or that's already waiting. If such an operation is in progress, the entering operation must wait its turn.  \n  \n```csharp  \nprivate async Task FinishOneGroupAsync(List<string> urls, Task<byte[]>[] contentTasks, char grp)  \n{  \n    // ***Wait for the previous group to finish displaying results.  \n    if (pendingWork != null) await pendingWork;  \n  \n    int total = 0;  \n  \n    // contentTasks is the array of Tasks that was created in AccessTheWebAsync.  \n    for (int i = 0; i < contentTasks.Length; i++)  \n    {  \n        // Await the download of a particular URL, and then display the URL and  \n        // its length.  \n        byte[] content = await contentTasks[i];  \n        DisplayResults(urls[i], content, i, grp);  \n        total += content.Length;  \n    }  \n  \n    // Display the total count for all of the websites.  \n    ResultsTextBox.Text +=  \n        string.Format(\"\\r\\n\\r\\nTOTAL bytes returned:  {0}\\r\\n\", total);  \n}  \n```  \n  \n You can run this example by pasting the changes into the code in [Building the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), or you can follow the instructions in [Downloading the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) to download the sample, and then run the QueueResults project.  \n  \n#### Points of Interest  \n The information lines that start with a pound sign (#) in the output clarify how this example works.  \n  \n The output shows the following patterns.  \n  \n-   A group can be started while a previous group is displaying its output, but the display of the previous group's output isn't interrupted.  \n  \n    ```  \n    #Starting group A.  \n    #Task assigned for group A. Download tasks are active.  \n  \n    A-1. msdn.microsoft.com/library/hh191443.aspx                87389  \n    A-2. msdn.microsoft.com/library/aa578028.aspx               207089  \n    A-3. msdn.microsoft.com/library/jj155761.aspx                30870  \n    A-4. msdn.microsoft.com/library/hh290140.aspx               119037  \n    A-5. msdn.microsoft.com/library/hh524395.aspx                71260  \n  \n    #Starting group B.  \n    #Task assigned for group B. Download tasks are active.  \n  \n    A-6. msdn.microsoft.com/library/ms404677.aspx               199186  \n    A-7. msdn.microsoft.com                                            53078  \n    A-8. msdn.microsoft.com/library/ff730837.aspx               148010  \n  \n    TOTAL bytes returned:  915919  \n  \n    B-1. msdn.microsoft.com/library/hh191443.aspx                87388  \n    B-2. msdn.microsoft.com/library/aa578028.aspx               207089  \n    B-3. msdn.microsoft.com/library/jj155761.aspx                30870  \n  \n    #Group A is complete.  \n  \n    B-4. msdn.microsoft.com/library/hh290140.aspx               119027  \n    B-5. msdn.microsoft.com/library/hh524395.aspx                71260  \n    B-6. msdn.microsoft.com/library/ms404677.aspx               199186  \n    B-7. msdn.microsoft.com                                            53078  \n    B-8. msdn.microsoft.com/library/ff730837.aspx               148010  \n  \n    TOTAL bytes returned:  915908  \n    ```  \n  \n-   The `pendingWork` task is null  at the start of `FinishOneGroupAsync` only for group A, which started first. Group A hasn’t yet completed an await expression when it reaches `FinishOneGroupAsync`. Therefore, control hasn't returned to `AccessTheWebAsync`, and the first assignment to `pendingWork` hasn't occurred.  \n  \n-   The following two lines always appear together in the output. The code is never interrupted between starting a group's operation in `StartButton_Click` and assigning a task for the group to `pendingWork`.  \n  \n    ```  \n    #Starting group B.  \n    #Task assigned for group B. Download tasks are active.  \n    ```  \n  \n     After a group enters `StartButton_Click`, the operation doesn't complete an await expression until the operation enters `FinishOneGroupAsync`. Therefore, no other operation can gain control during that segment of code.  \n  \n##  <a name=\"BKMD_SettingUpTheExample\"></a> Reviewing and Running the Example App  \n To better understand the example app, you can download it, build it yourself, or review the code at the end of this topic without implementing the app.  \n  \n> [!NOTE]\n>  To run the example as a Windows Presentation Foundation (WPF) desktop app, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.  \n  \n###  <a name=\"BKMK_DownloadingTheApp\"></a> Downloading the App  \n  \n1.  Download the compressed file from [Async Samples: Reentrancy in .NET Desktop Apps](http://go.microsoft.com/fwlink/?LinkId=266571).  \n  \n2.  Decompress the file that you downloaded, and then start Visual Studio.  \n  \n3.  On the menu bar, choose **File**, **Open**, **Project/Solution**.  \n  \n4.  Navigate to the folder that holds the decompressed sample code, and then open the solution (.sln) file.  \n  \n5.  In **Solution Explorer**, open the shortcut menu for the project that you want to run, and then choose **Set as StartUpProject**.  \n  \n6.  Choose the CTRL+F5 keys to build and run the project.  \n  \n###  <a name=\"BKMK_BuildingTheApp\"></a> Building the App  \n The following section provides the code to build the example as a WPF app.  \n  \n##### To build a WPF app  \n  \n1.  Start Visual Studio.  \n  \n2.  On the menu bar, choose **File**, **New**, **Project**.  \n  \n     The **New Project** dialog box opens.  \n  \n3.  In the **Installed Templates** pane, expand **Visual C#**, and then expand **Windows**.  \n  \n4.  In the list of project types, choose **WPF Application**.  \n  \n5.  Name the project `WebsiteDownloadWPF`, and then choose the **OK** button.  \n  \n     The new project appears in **Solution Explorer**.  \n  \n6.  In the Visual Studio Code Editor, choose the **MainWindow.xaml** tab.  \n  \n     If the tab isn’t visible, open the shortcut menu for MainWindow.xaml in **Solution Explorer**, and then choose **View Code**.  \n  \n7.  In the **XAML** view of MainWindow.xaml, replace the code with the following code.  \n  \n    ```csharp  \n    <Window x:Class=\"WebsiteDownloadWPF.MainWindow\"  \n        xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"  \n        xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\"  \n        xmlns:local=\"using:WebsiteDownloadWPF\"  \n        xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\"  \n        xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"  \n        mc:Ignorable=\"d\">  \n  \n        <Grid Width=\"517\" Height=\"360\">  \n            <Button x:Name=\"StartButton\" Content=\"Start\" HorizontalAlignment=\"Left\" Margin=\"-1,0,0,0\" VerticalAlignment=\"Top\" Click=\"StartButton_Click\" Height=\"53\" Background=\"#FFA89B9B\" FontSize=\"36\" Width=\"518\"  />  \n            <TextBox x:Name=\"ResultsTextBox\" HorizontalAlignment=\"Left\" Margin=\"-1,53,0,-36\" TextWrapping=\"Wrap\" VerticalAlignment=\"Top\" Height=\"343\" FontSize=\"10\" ScrollViewer.VerticalScrollBarVisibility=\"Visible\" Width=\"518\" FontFamily=\"Lucida Console\" />  \n        </Grid>  \n    </Window>  \n    ```  \n  \n     A simple window that contains a text box and a button appears in the **Design** view of MainWindow.xaml.  \n  \n8.  Add a reference for <xref:System.Net.Http>.  \n  \n9. In **Solution Explorer**, open the shortcut menu for MainWindow.xaml.cs, and then choose **View Code**.  \n  \n10. In MainWindow.xaml.cs, replace the code with the following code.  \n  \n    ```csharp  \n    using System;  \n    using System.Collections.Generic;  \n    using System.Linq;  \n    using System.Text;  \n    using System.Threading.Tasks;  \n    using System.Windows;  \n    using System.Windows.Controls;  \n    using System.Windows.Data;  \n    using System.Windows.Documents;  \n    using System.Windows.Input;  \n    using System.Windows.Media;  \n    using System.Windows.Media.Imaging;  \n    using System.Windows.Navigation;  \n    using System.Windows.Shapes;  \n  \n    // Add the following using directives, and add a reference for System.Net.Http.  \n    using System.Net.Http;  \n    using System.Threading;  \n  \n    namespace WebsiteDownloadWPF  \n    {  \n        public partial class MainWindow : Window  \n        {  \n            public MainWindow()  \n            {  \n                InitializeComponent();  \n            }  \n  \n            private async void StartButton_Click(object sender, RoutedEventArgs e)  \n            {  \n                // This line is commented out to make the results clearer in the output.  \n                //ResultsTextBox.Text = \"\";  \n  \n                try  \n                {  \n                    await AccessTheWebAsync();  \n                }  \n                catch (Exception)  \n                {  \n                    ResultsTextBox.Text += \"\\r\\nDownloads failed.\";  \n                }  \n            }  \n  \n            private async Task AccessTheWebAsync()  \n            {  \n                // Declare an HttpClient object.  \n                HttpClient client = new HttpClient();  \n  \n                // Make a list of web addresses.  \n                List<string> urlList = SetUpURLList();  \n  \n                var total = 0;  \n                var position = 0;  \n  \n                foreach (var url in urlList)  \n                {  \n                    // GetByteArrayAsync returns a task. At completion, the task  \n                    // produces a byte array.  \n                    byte[] urlContents = await client.GetByteArrayAsync(url);  \n  \n                    DisplayResults(url, urlContents, ++position);  \n  \n                    // Update the total.  \n                    total += urlContents.Length;  \n                }  \n  \n                // Display the total count for all of the websites.  \n                ResultsTextBox.Text +=  \n                    string.Format(\"\\r\\n\\r\\nTOTAL bytes returned:  {0}\\r\\n\", total);  \n            }  \n  \n            private List<string> SetUpURLList()  \n            {  \n                List<string> urls = new List<string>   \n                {   \n                    \"http://msdn.microsoft.com/library/hh191443.aspx\",  \n                    \"http://msdn.microsoft.com/library/aa578028.aspx\",  \n                    \"http://msdn.microsoft.com/library/jj155761.aspx\",  \n                    \"http://msdn.microsoft.com/library/hh290140.aspx\",  \n                    \"http://msdn.microsoft.com/library/hh524395.aspx\",  \n                    \"http://msdn.microsoft.com/library/ms404677.aspx\",  \n                    \"http://msdn.microsoft.com\",  \n                    \"http://msdn.microsoft.com/library/ff730837.aspx\"  \n                };  \n                return urls;  \n            }  \n  \n            private void DisplayResults(string url, byte[] content, int pos)  \n            {  \n                // Display the length of each website. The string format is designed  \n                // to be used with a monospaced font, such as Lucida Console or   \n                // Global Monospace.  \n  \n                // Strip off the \"http://\".  \n                var displayURL = url.Replace(\"http://\", \"\");  \n                // Display position in the URL list, the URL, and the number of bytes.  \n                ResultsTextBox.Text += string.Format(\"\\n{0}. {1,-58} {2,8}\", pos, displayURL, content.Length);  \n            }  \n        }  \n    }  \n    ```  \n  \n11. Choose the CTRL+F5 keys to run the program, and then choose the **Start** button several times.  \n  \n12. Make the changes from [Disable the Start Button](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), [Cancel and Restart the Operation](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), or [Run Multiple Operations and Queue the Output](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) to handle the reentrancy.  \n  \n## See Also  \n [Walkthrough: Accessing the Web by Using async and await (C#)](../../../../csharp/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)   \n [Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)","nodes":[{"pos":[4,419],"nodes":[{"content":"Handling Reentrancy in Async Apps (C#) | Microsoft Docs","nodes":[{"pos":[0,55],"content":"Handling Reentrancy in Async Apps (C#) | Microsoft Docs","nodes":[{"content":"Handling Reentrancy in Async Apps (C#) | Microsoft Docs","pos":[0,55]}]}],"pos":[6,64],"yaml":true}],"content":"title: \"Handling Reentrancy in Async Apps (C#) | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"2015-07-20\"\nms.prod: .net\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-csharp\"\n\nms.topic: \"article\"\ndev_langs: \n  - \"CSharp\"\nms.assetid: 47c5075e-c448-45ce-9155-ed4e7e98c677\ncaps.latest.revision: 3\nauthor: \"BillWagner\"\nms.author: \"wiwagn\"\n\ntranslation.priority.mt: \n  - \"cs-cz\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"tr-tr\"","yamlblock":true},{"pos":[426,464],"content":"Handling Reentrancy in Async Apps (C#)","linkify":"Handling Reentrancy in Async Apps (C#)","nodes":[{"content":"Handling Reentrancy in Async Apps (C#)","pos":[0,38]}]},{"content":"When you include asynchronous code in your app, you should consider and possibly prevent reentrancy, which refers to reentering an asynchronous operation before it has completed.","pos":[465,643]},{"content":"If you don't identify and handle possibilities for reentrancy, it can cause unexpected results.","pos":[644,739]},{"pos":[746,763],"content":"<bpt id=\"p1\">**</bpt>In this topic<ept id=\"p1\">**</ept>","source":"**In this topic**"},{"pos":[773,869],"content":"<bpt id=\"p1\">[</bpt>Recognizing Reentrancy<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Recognizing Reentrancy](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[879,972],"content":"<bpt id=\"p1\">[</bpt>Handling Reentrancy<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Handling Reentrancy](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[986,1084],"content":"<bpt id=\"p1\">[</bpt>Disable the Start Button<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Disable the Start Button](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[1098,1204],"content":"<bpt id=\"p1\">[</bpt>Cancel and Restart the Operation<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Cancel and Restart the Operation](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[1218,1336],"content":"<bpt id=\"p1\">[</bpt>Run Multiple Operations and Queue the Output<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Run Multiple Operations and Queue the Output](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[1346,1457],"content":"<bpt id=\"p1\">[</bpt>Reviewing and Running the Example App<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Reviewing and Running the Example App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[1465,1601],"content":"[!NOTE]\n To run the example, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.","leadings":["","> "],"nodes":[{"content":"To run the example, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.","pos":[9,134]}]},{"pos":[1611,1675],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_RecognizingReentrancy\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Recognizing Reentrancy","linkify":"<a name=\"BKMK_RecognizingReentrancy\"></a> Recognizing Reentrancy","source":"<a name=\"BKMK_RecognizingReentrancy\"></a> Recognizing Reentrancy"},{"content":"In the example in this topic, users choose a <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button to initiate an asynchronous app that downloads a series of websites and calculates the total number of bytes that are downloaded.","pos":[1679,1870],"source":"In the example in this topic, users choose a **Start** button to initiate an asynchronous app that downloads a series of websites and calculates the total number of bytes that are downloaded."},{"content":"A synchronous version of the example would respond the same way regardless of how many times a user chooses the button because, after the first time, the UI thread ignores those events until the app finishes running.","pos":[1871,2087]},{"content":"In an asynchronous app, however, the UI thread continues to respond, and you might reenter the asynchronous operation before it has completed.","pos":[2088,2230]},{"content":"The following example shows the expected output if the user chooses the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button only once.","pos":[2237,2336],"source":"The following example shows the expected output if the user chooses the **Start** button only once."},{"content":"A list of the downloaded websites appears with the size, in bytes, of each site.","pos":[2337,2417]},{"content":"The total number of bytes appears at the end.","pos":[2418,2463]},{"content":"However, if the user chooses the button more than once, the event handler is invoked repeatedly, and the download process is reentered each time.","pos":[3062,3207]},{"content":"As a result, several asynchronous operations are running at the same time, the output interleaves the results, and the total number of bytes is confusing.","pos":[3208,3362]},{"content":"You can review the code that produces this output by scrolling to the end of this topic.","pos":[5127,5215]},{"content":"You can experiment with the code by downloading the solution to your local computer and then running the WebsiteDownload project or by using the code at the end of this topic to create your own project For more information and instructions, see <bpt id=\"p1\">[</bpt>Reviewing and Running the Example App<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>.","pos":[5216,5573],"source":" You can experiment with the code by downloading the solution to your local computer and then running the WebsiteDownload project or by using the code at the end of this topic to create your own project For more information and instructions, see [Reviewing and Running the Example App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)."},{"pos":[5583,5641],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_HandlingReentrancy\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Handling Reentrancy","linkify":"<a name=\"BKMK_HandlingReentrancy\"></a> Handling Reentrancy","source":"<a name=\"BKMK_HandlingReentrancy\"></a> Handling Reentrancy"},{"content":"You can handle reentrancy in a variety of ways, depending on what you want your app to do.","pos":[5645,5735]},{"content":"This topic presents the following examples:","pos":[5736,5779]},{"pos":[5789,5887],"content":"<bpt id=\"p1\">[</bpt>Disable the Start Button<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Disable the Start Button](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[5898,5994],"content":"Disable the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button while the operation is running so that the user can't interrupt it.","source":"Disable the **Start** button while the operation is running so that the user can't interrupt it."},{"pos":[6004,6110],"content":"<bpt id=\"p1\">[</bpt>Cancel and Restart the Operation<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Cancel and Restart the Operation](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"pos":[6121,6274],"content":"Cancel any operation that is still running when the user chooses the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button again, and then let the most recently requested operation continue.","source":"Cancel any operation that is still running when the user chooses the **Start** button again, and then let the most recently requested operation continue."},{"pos":[6284,6402],"content":"<bpt id=\"p1\">[</bpt>Run Multiple Operations and Queue the Output<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>","source":"[Run Multiple Operations and Queue the Output](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)"},{"content":"Allow all requested operations to run asynchronously, but coordinate the display of output so that the results from each operation appear together and in order.","pos":[6413,6573]},{"pos":[6584,6650],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_DisableTheStartButton\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Disable the Start Button","linkify":"<a name=\"BKMK_DisableTheStartButton\"></a> Disable the Start Button","source":"<a name=\"BKMK_DisableTheStartButton\"></a> Disable the Start Button"},{"content":"You can block the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button while an operation is running by disabling the button at the top of the <ph id=\"ph1\">`StartButton_Click`</ph> event handler.","pos":[6654,6795],"source":"You can block the **Start** button while an operation is running by disabling the button at the top of the `StartButton_Click` event handler."},{"content":"You can then reenable the button from within a  <ph id=\"ph1\">`finally`</ph> block when the operation finishes so that users can run the app again.","pos":[6796,6924],"source":" You can then reenable the button from within a  `finally` block when the operation finishes so that users can run the app again."},{"content":"The following code shows these changes, which are marked with asterisks.","pos":[6931,7003]},{"content":"You can add the changes to the code at the end of this topic, or you can download the finished app from <bpt id=\"p1\">[</bpt>Async Samples: Reentrancy in .NET Desktop Apps<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=266571)</ept>.","pos":[7004,7204],"source":" You can add the changes to the code at the end of this topic, or you can download the finished app from [Async Samples: Reentrancy in .NET Desktop Apps](http://go.microsoft.com/fwlink/?LinkId=266571)."},{"content":"The project name is DisableStartButton.","pos":[7205,7244]},{"pos":[7893,8037],"content":"As a result of the changes, the button doesn't respond while <ph id=\"ph1\">`AccessTheWebAsync`</ph> is downloading the websites, so the process can’t be reentered.","source":"As a result of the changes, the button doesn't respond while `AccessTheWebAsync` is downloading the websites, so the process can’t be reentered."},{"pos":[8048,8117],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_CancelAndRestart\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Cancel and Restart the Operation","linkify":"<a name=\"BKMK_CancelAndRestart\"></a> Cancel and Restart the Operation","source":"<a name=\"BKMK_CancelAndRestart\"></a> Cancel and Restart the Operation"},{"pos":[8121,8336],"content":"Instead of disabling the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button, you can keep the button active but, if the user chooses that button again, cancel the operation that's already running and let the most recently started operation continue.","source":"Instead of disabling the **Start** button, you can keep the button active but, if the user chooses that button again, cancel the operation that's already running and let the most recently started operation continue."},{"pos":[8343,8521],"content":"For more information about cancellation, see <bpt id=\"p1\">[</bpt>Fine-Tuning Your Async Application (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/fine-tuning-your-async-application.md)</ept>.","source":"For more information about cancellation, see [Fine-Tuning Your Async Application (C#)](../../../../csharp/programming-guide/concepts/async/fine-tuning-your-async-application.md)."},{"content":"To set up this scenario, make the following changes to the basic code that is provided in <bpt id=\"p1\">[</bpt>Reviewing and Running the Example App<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>.","pos":[8528,8730],"source":"To set up this scenario, make the following changes to the basic code that is provided in [Reviewing and Running the Example App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)."},{"content":"You also can download the finished app from <bpt id=\"p1\">[</bpt>Async Samples: Reentrancy in .NET Desktop Apps<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=266571)</ept>.","pos":[8731,8871],"source":" You also can download the finished app from [Async Samples: Reentrancy in .NET Desktop Apps](http://go.microsoft.com/fwlink/?LinkId=266571)."},{"content":"The name of this project is CancelAndRestart.","pos":[8872,8917]},{"pos":[8927,9034],"content":"Declare a <ph id=\"ph1\">&lt;xref:System.Threading.CancellationTokenSource&gt;</ph> variable, <ph id=\"ph2\">`cts`</ph>, that’s in scope for all methods.","source":"Declare a <xref:System.Threading.CancellationTokenSource> variable, `cts`, that’s in scope for all methods."},{"content":"In <ph id=\"ph1\">`StartButton_Click`</ph>, determine whether an operation is already underway.","pos":[9259,9334],"source":"In `StartButton_Click`, determine whether an operation is already underway."},{"content":"If the value of <ph id=\"ph1\">`cts`</ph> is null, no operation is already active.","pos":[9335,9397],"source":" If the value of `cts` is null, no operation is already active."},{"content":"If the value isn't null, the operation that is already running is canceled.","pos":[9398,9473]},{"pos":[9642,9709],"content":"Set <ph id=\"ph1\">`cts`</ph> to a different value that represents the current process.","source":"Set `cts` to a different value that represents the current process."},{"pos":[9965,10072],"content":"At the end of <ph id=\"ph1\">`StartButton_Click`</ph>, the current process is complete, so set the value of <ph id=\"ph2\">`cts`</ph> back to null.","source":"At the end of `StartButton_Click`, the current process is complete, so set the value of `cts` back to null."},{"content":"The following code shows all the changes in <ph id=\"ph1\">`StartButton_Click`</ph>.","pos":[10237,10301],"source":"The following code shows all the changes in `StartButton_Click`."},{"content":"The additions are marked with asterisks.","pos":[10302,10342]},{"pos":[11439,11490],"content":"In <ph id=\"ph1\">`AccessTheWebAsync`</ph>, make the following changes.","source":"In `AccessTheWebAsync`, make the following changes."},{"pos":[11500,11574],"content":"Add a parameter to accept the cancellation token from <ph id=\"ph1\">`StartButton_Click`</ph>.","source":"Add a parameter to accept the cancellation token from `StartButton_Click`."},{"pos":[11584,11750],"content":"Use the <ph id=\"ph1\">&lt;xref:System.Net.Http.HttpClient.GetAsync%2A&gt;</ph> method to download the websites because <ph id=\"ph2\">`GetAsync`</ph> accepts a <ph id=\"ph3\">&lt;xref:System.Threading.CancellationToken&gt;</ph> argument.","source":"Use the <xref:System.Net.Http.HttpClient.GetAsync%2A> method to download the websites because `GetAsync` accepts a <xref:System.Threading.CancellationToken> argument."},{"pos":[11760,11913],"content":"Before calling <ph id=\"ph1\">`DisplayResults`</ph> to display the results for each downloaded website, check <ph id=\"ph2\">`ct`</ph> to verify that the current operation hasn’t been canceled.","source":"Before calling `DisplayResults` to display the results for each downloaded website, check `ct` to verify that the current operation hasn’t been canceled."},{"content":"The following code shows these changes, which are marked with asterisks.","pos":[11920,11992]},{"pos":[13226,13363],"content":"If you choose the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button several times while this app is running, it should produce results that resemble the following output.","source":"If you choose the **Start** button several times while this app is running, it should produce results that resemble the following output."},{"pos":[14613,14765],"content":"To eliminate the partial lists, uncomment the first line of code in <ph id=\"ph1\">`StartButton_Click`</ph> to clear the text box each time the user restarts the operation.","source":"To eliminate the partial lists, uncomment the first line of code in `StartButton_Click` to clear the text box each time the user restarts the operation."},{"pos":[14776,14862],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_RunMultipleOperations\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Run Multiple Operations and Queue the Output","linkify":"<a name=\"BKMK_RunMultipleOperations\"></a> Run Multiple Operations and Queue the Output","source":"<a name=\"BKMK_RunMultipleOperations\"></a> Run Multiple Operations and Queue the Output"},{"content":"This third example is the most complicated in that the app starts another asynchronous operation each time that the user chooses the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button, and all the operations run to completion.","pos":[14866,15058],"source":"This third example is the most complicated in that the app starts another asynchronous operation each time that the user chooses the **Start** button, and all the operations run to completion."},{"content":"All the requested operations download websites from the list asynchronously, but the output from the operations is presented sequentially.","pos":[15059,15197]},{"content":"That is, the actual downloading activity is interleaved, as the output in <bpt id=\"p1\">[</bpt>Recognizing Reentrancy<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept> shows, but the list of results for each group is presented separately.","pos":[15198,15439],"source":" That is, the actual downloading activity is interleaved, as the output in [Recognizing Reentrancy](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) shows, but the list of results for each group is presented separately."},{"pos":[15446,15580],"content":"The operations share a global <ph id=\"ph1\">&lt;xref:System.Threading.Tasks.Task&gt;</ph>, <ph id=\"ph2\">`pendingWork`</ph>, which serves as a gatekeeper for the display process.","source":"The operations share a global <xref:System.Threading.Tasks.Task>, `pendingWork`, which serves as a gatekeeper for the display process."},{"pos":[15587,15937],"content":"You can run this example by pasting the changes into the code in <bpt id=\"p1\">[</bpt>Building the App<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>, or you can follow the instructions in <bpt id=\"p2\">[</bpt>Downloading the App<ept id=\"p2\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept> to download the sample and then run the QueueResults project.","source":"You can run this example by pasting the changes into the code in [Building the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), or you can follow the instructions in [Downloading the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) to download the sample and then run the QueueResults project."},{"content":"The following output shows the result if the user chooses the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button only once.","pos":[15944,16033],"source":"The following output shows the result if the user chooses the **Start** button only once."},{"content":"The letter label, A, indicates that the result is from the first time the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button is chosen.","pos":[16034,16135],"source":" The letter label, A, indicates that the result is from the first time the **Start** button is chosen."},{"content":"The numbers show the order of the URLs in the list of download targets.","pos":[16136,16207]},{"content":"If the user chooses the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button three times, the app produces output that resembles the following lines.","pos":[16906,17019],"source":"If the user chooses the **Start** button three times, the app produces output that resembles the following lines."},{"content":"The information lines that start with a pound sign (#) trace the progress of the application.","pos":[17020,17113]},{"content":"Groups B and C start before group A has finished, but the output for the each group appears separately.","pos":[19178,19281]},{"content":"All the output for group A appears first, followed by all the output for group B, and then all the output for group C. The app always displays the groups in order and, for each group, always displays the information about the individual websites in the order that the URLs appear in the list of URLs.","pos":[19282,19582]},{"content":"However, you can't predict the order in which the downloads actually happen.","pos":[19589,19665]},{"content":"After multiple groups have been started, the download tasks that they generate are all active.","pos":[19666,19760]},{"content":"You can't assume that A-1 will be downloaded before B-1, and you can't assume that A-1 will be downloaded before A-2.","pos":[19761,19878]},{"pos":[19889,19907],"content":"Global Definitions","linkify":"Global Definitions","nodes":[{"content":"Global Definitions","pos":[0,18]}]},{"content":"The sample code contains the following two global declarations that are visible from all methods.","pos":[19911,20008]},{"content":"The <ph id=\"ph1\">`Task`</ph> variable, <ph id=\"ph2\">`pendingWork`</ph>, oversees the display process and prevents any group from interrupting another group's display operation.","pos":[20290,20430],"source":"The `Task` variable, `pendingWork`, oversees the display process and prevents any group from interrupting another group's display operation."},{"content":"The character variable, <ph id=\"ph1\">`group`</ph>, labels the output from different groups to verify that results appear in the expected order.","pos":[20431,20556],"source":" The character variable, `group`, labels the output from different groups to verify that results appear in the expected order."},{"pos":[20567,20590],"content":"The Click Event Handler","linkify":"The Click Event Handler","nodes":[{"content":"The Click Event Handler","pos":[0,23]}]},{"content":"The event handler, <ph id=\"ph1\">`StartButton_Click`</ph>, increments the group letter each time the user chooses the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button.","pos":[20594,20710],"source":"The event handler, `StartButton_Click`, increments the group letter each time the user chooses the **Start** button."},{"content":"Then the handler calls <ph id=\"ph1\">`AccessTheWebAsync`</ph> to run the downloading operation.","pos":[20711,20787],"source":" Then the handler calls `AccessTheWebAsync` to run the downloading operation."},{"pos":[21641,21669],"content":"The AccessTheWebAsync Method","linkify":"The AccessTheWebAsync Method","nodes":[{"content":"The AccessTheWebAsync Method","pos":[0,28]}]},{"content":"This example splits <ph id=\"ph1\">`AccessTheWebAsync`</ph> into two methods.","pos":[21673,21730],"source":"This example splits `AccessTheWebAsync` into two methods."},{"content":"The first method, <ph id=\"ph1\">`AccessTheWebAsync`</ph>, starts all the download tasks for a group and sets up <ph id=\"ph2\">`pendingWork`</ph> to control the display process.","pos":[21731,21869],"source":" The first method, `AccessTheWebAsync`, starts all the download tasks for a group and sets up `pendingWork` to control the display process."},{"content":"The method uses a Language Integrated Query (LINQ query) and <ph id=\"ph1\">&lt;xref:System.Linq.Enumerable.ToArray%2A&gt;</ph> to start all the download tasks at the same time.","pos":[21870,22021],"source":" The method uses a Language Integrated Query (LINQ query) and <xref:System.Linq.Enumerable.ToArray%2A> to start all the download tasks at the same time."},{"pos":[22028,22145],"content":"<ph id=\"ph1\">`AccessTheWebAsync`</ph> then calls <ph id=\"ph2\">`FinishOneGroupAsync`</ph> to await the completion of each download and display its length.","source":"`AccessTheWebAsync` then calls `FinishOneGroupAsync` to await the completion of each download and display its length."},{"content":"<ph id=\"ph1\">`FinishOneGroupAsync`</ph> returns a task that's assigned to <ph id=\"ph2\">`pendingWork`</ph> in <ph id=\"ph3\">`AccessTheWebAsync`</ph>.","pos":[22152,22245],"source":"`FinishOneGroupAsync` returns a task that's assigned to `pendingWork` in `AccessTheWebAsync`."},{"content":"That value prevents interruption by another operation before the task is complete.","pos":[22246,22328]},{"pos":[23332,23362],"content":"The FinishOneGroupAsync Method","linkify":"The FinishOneGroupAsync Method","nodes":[{"content":"The FinishOneGroupAsync Method","pos":[0,30]}]},{"content":"This method cycles through the download tasks in a group, awaiting each one, displaying the length of the downloaded website, and adding the length to the total.","pos":[23366,23527]},{"content":"The first statement in <ph id=\"ph1\">`FinishOneGroupAsync`</ph> uses <ph id=\"ph2\">`pendingWork`</ph> to make sure that entering the method doesn't interfere with an operation that is already in the display process or that's already waiting.","pos":[23534,23737],"source":"The first statement in `FinishOneGroupAsync` uses `pendingWork` to make sure that entering the method doesn't interfere with an operation that is already in the display process or that's already waiting."},{"content":"If such an operation is in progress, the entering operation must wait its turn.","pos":[23738,23817]},{"pos":[24658,25009],"content":"You can run this example by pasting the changes into the code in <bpt id=\"p1\">[</bpt>Building the App<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>, or you can follow the instructions in <bpt id=\"p2\">[</bpt>Downloading the App<ept id=\"p2\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept> to download the sample, and then run the QueueResults project.","source":"You can run this example by pasting the changes into the code in [Building the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), or you can follow the instructions in [Downloading the App](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) to download the sample, and then run the QueueResults project."},{"pos":[25020,25038],"content":"Points of Interest","linkify":"Points of Interest","nodes":[{"content":"Points of Interest","pos":[0,18]}]},{"content":"The information lines that start with a pound sign (#) in the output clarify how this example works.","pos":[25042,25142]},{"content":"The output shows the following patterns.","pos":[25149,25189]},{"content":"A group can be started while a previous group is displaying its output, but the display of the previous group's output isn't interrupted.","pos":[25199,25336]},{"content":"The <ph id=\"ph1\">`pendingWork`</ph> task is null  at the start of <ph id=\"ph2\">`FinishOneGroupAsync`</ph> only for group A, which started first.","pos":[26845,26953],"source":"The `pendingWork` task is null  at the start of `FinishOneGroupAsync` only for group A, which started first."},{"content":"Group A hasn’t yet completed an await expression when it reaches <ph id=\"ph1\">`FinishOneGroupAsync`</ph>.","pos":[26954,27041],"source":" Group A hasn’t yet completed an await expression when it reaches `FinishOneGroupAsync`."},{"content":"Therefore, control hasn't returned to <ph id=\"ph1\">`AccessTheWebAsync`</ph>, and the first assignment to <ph id=\"ph2\">`pendingWork`</ph> hasn't occurred.","pos":[27042,27159],"source":" Therefore, control hasn't returned to `AccessTheWebAsync`, and the first assignment to `pendingWork` hasn't occurred."},{"content":"The following two lines always appear together in the output.","pos":[27169,27230]},{"content":"The code is never interrupted between starting a group's operation in <ph id=\"ph1\">`StartButton_Click`</ph> and assigning a task for the group to <ph id=\"ph2\">`pendingWork`</ph>.","pos":[27231,27373],"source":" The code is never interrupted between starting a group's operation in `StartButton_Click` and assigning a task for the group to `pendingWork`."},{"content":"After a group enters <ph id=\"ph1\">`StartButton_Click`</ph>, the operation doesn't complete an await expression until the operation enters <ph id=\"ph2\">`FinishOneGroupAsync`</ph>.","pos":[27493,27635],"source":"After a group enters `StartButton_Click`, the operation doesn't complete an await expression until the operation enters `FinishOneGroupAsync`."},{"content":"Therefore, no other operation can gain control during that segment of code.","pos":[27636,27711]},{"pos":[27721,27798],"content":"<bpt id=\"p1\">&lt;a name=\"BKMD_SettingUpTheExample\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Reviewing and Running the Example App","linkify":"<a name=\"BKMD_SettingUpTheExample\"></a> Reviewing and Running the Example App","source":"<a name=\"BKMD_SettingUpTheExample\"></a> Reviewing and Running the Example App"},{"content":"To better understand the example app, you can download it, build it yourself, or review the code at the end of this topic without implementing the app.","pos":[27802,27953]},{"pos":[27961,28152],"content":"[!NOTE]\n To run the example as a Windows Presentation Foundation (WPF) desktop app, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.","leadings":["","> "],"nodes":[{"content":"To run the example as a Windows Presentation Foundation (WPF) desktop app, you must have Visual Studio 2012 or newer and the .NET Framework 4.5 or newer installed on your computer.","pos":[9,189]}]},{"pos":[28163,28220],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_DownloadingTheApp\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Downloading the App","linkify":"<a name=\"BKMK_DownloadingTheApp\"></a> Downloading the App","source":"<a name=\"BKMK_DownloadingTheApp\"></a> Downloading the App"},{"pos":[28230,28360],"content":"Download the compressed file from <bpt id=\"p1\">[</bpt>Async Samples: Reentrancy in .NET Desktop Apps<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=266571)</ept>.","source":"Download the compressed file from [Async Samples: Reentrancy in .NET Desktop Apps](http://go.microsoft.com/fwlink/?LinkId=266571)."},{"content":"Decompress the file that you downloaded, and then start Visual Studio.","pos":[28370,28440]},{"pos":[28450,28515],"content":"On the menu bar, choose <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Project/Solution<ept id=\"p3\">**</ept>.","source":"On the menu bar, choose **File**, **Open**, **Project/Solution**."},{"content":"Navigate to the folder that holds the decompressed sample code, and then open the solution (.sln) file.","pos":[28525,28628]},{"pos":[28638,28767],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, open the shortcut menu for the project that you want to run, and then choose <bpt id=\"p2\">**</bpt>Set as StartUpProject<ept id=\"p2\">**</ept>.","source":"In **Solution Explorer**, open the shortcut menu for the project that you want to run, and then choose **Set as StartUpProject**."},{"content":"Choose the CTRL+F5 keys to build and run the project.","pos":[28777,28830]},{"pos":[28841,28892],"content":"<bpt id=\"p1\">&lt;a name=\"BKMK_BuildingTheApp\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Building the App","linkify":"<a name=\"BKMK_BuildingTheApp\"></a> Building the App","source":"<a name=\"BKMK_BuildingTheApp\"></a> Building the App"},{"content":"The following section provides the code to build the example as a WPF app.","pos":[28896,28970]},{"pos":[28982,29000],"content":"To build a WPF app","linkify":"To build a WPF app","nodes":[{"content":"To build a WPF app","pos":[0,18]}]},{"content":"Start Visual Studio.","pos":[29010,29030]},{"pos":[29040,29095],"content":"On the menu bar, choose <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>New<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Project<ept id=\"p3\">**</ept>.","source":"On the menu bar, choose **File**, **New**, **Project**."},{"pos":[29106,29143],"content":"The <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> dialog box opens.","source":"The **New Project** dialog box opens."},{"pos":[29153,29240],"content":"In the <bpt id=\"p1\">**</bpt>Installed Templates<ept id=\"p1\">**</ept> pane, expand <bpt id=\"p2\">**</bpt>Visual C#<ept id=\"p2\">**</ept>, and then expand <bpt id=\"p3\">**</bpt>Windows<ept id=\"p3\">**</ept>.","source":"In the **Installed Templates** pane, expand **Visual C#**, and then expand **Windows**."},{"pos":[29250,29307],"content":"In the list of project types, choose <bpt id=\"p1\">**</bpt>WPF Application<ept id=\"p1\">**</ept>.","source":"In the list of project types, choose **WPF Application**."},{"pos":[29317,29390],"content":"Name the project <ph id=\"ph1\">`WebsiteDownloadWPF`</ph>, and then choose the <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> button.","source":"Name the project `WebsiteDownloadWPF`, and then choose the **OK** button."},{"pos":[29401,29450],"content":"The new project appears in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>.","source":"The new project appears in **Solution Explorer**."},{"pos":[29460,29529],"content":"In the Visual Studio Code Editor, choose the <bpt id=\"p1\">**</bpt>MainWindow.xaml<ept id=\"p1\">**</ept> tab.","source":"In the Visual Studio Code Editor, choose the **MainWindow.xaml** tab."},{"pos":[29540,29665],"content":"If the tab isn’t visible, open the shortcut menu for MainWindow.xaml in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, and then choose <bpt id=\"p2\">**</bpt>View Code<ept id=\"p2\">**</ept>.","source":"If the tab isn’t visible, open the shortcut menu for MainWindow.xaml in **Solution Explorer**, and then choose **View Code**."},{"pos":[29675,29757],"content":"In the <bpt id=\"p1\">**</bpt>XAML<ept id=\"p1\">**</ept> view of MainWindow.xaml, replace the code with the following code.","source":"In the **XAML** view of MainWindow.xaml, replace the code with the following code."},{"pos":[30779,30883],"content":"A simple window that contains a text box and a button appears in the <bpt id=\"p1\">**</bpt>Design<ept id=\"p1\">**</ept> view of MainWindow.xaml.","source":"A simple window that contains a text box and a button appears in the **Design** view of MainWindow.xaml."},{"content":"Add a reference for <ph id=\"ph1\">&lt;xref:System.Net.Http&gt;</ph>.","pos":[30893,30936],"source":"Add a reference for <xref:System.Net.Http>."},{"pos":[30945,31048],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, open the shortcut menu for MainWindow.xaml.cs, and then choose <bpt id=\"p2\">**</bpt>View Code<ept id=\"p2\">**</ept>.","source":"In **Solution Explorer**, open the shortcut menu for MainWindow.xaml.cs, and then choose **View Code**."},{"content":"In MainWindow.xaml.cs, replace the code with the following code.","pos":[31058,31122]},{"pos":[34987,35082],"content":"Choose the CTRL+F5 keys to run the program, and then choose the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button several times.","source":"Choose the CTRL+F5 keys to run the program, and then choose the **Start** button several times."},{"pos":[35092,35469],"content":"Make the changes from <bpt id=\"p1\">[</bpt>Disable the Start Button<ept id=\"p1\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>, <bpt id=\"p2\">[</bpt>Cancel and Restart the Operation<ept id=\"p2\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept>, or <bpt id=\"p3\">[</bpt>Run Multiple Operations and Queue the Output<ept id=\"p3\">](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645)</ept> to handle the reentrancy.","source":"Make the changes from [Disable the Start Button](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), [Cancel and Restart the Operation](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645), or [Run Multiple Operations and Queue the Output](http://msdn.microsoft.com/library/5b54de66-6be3-459e-b869-65070b020645) to handle the reentrancy."},{"pos":[35478,35486],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"<bpt id=\"p1\">[</bpt>Walkthrough: Accessing the Web by Using async and await (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md)</ept><ph id=\"ph1\"> </ph>","pos":[35490,35664],"source":"[Walkthrough: Accessing the Web by Using async and await (C#)](../../../../csharp/programming-guide/concepts/async/walkthrough-accessing-the-web-by-using-async-and-await.md) "},{"content":"<bpt id=\"p1\">[</bpt>Asynchronous Programming with async and await (C#)<ept id=\"p1\">](../../../../csharp/programming-guide/concepts/async/index.md)</ept>","pos":[35668,35782],"source":"[Asynchronous Programming with async and await (C#)](../../../../csharp/programming-guide/concepts/async/index.md)"}]}