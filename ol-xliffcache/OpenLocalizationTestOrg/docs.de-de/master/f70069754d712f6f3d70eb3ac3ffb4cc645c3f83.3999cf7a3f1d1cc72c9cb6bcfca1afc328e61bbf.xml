{"content":"---\ntitle: \"Net.TCP Port Sharing Sample\"\nms.date: \"03/30/2017\"\nms.assetid: 03da5959-0574-4e91-8a53-05854b6c55dc\n---\n# Net.TCP Port Sharing Sample\nThe TCP/IP protocol uses a 16-bit number, called a port, to differentiate connections to multiple network applications running on the same machine. If an application is listening on a port, then all TCP traffic for that port goes to that application. Other applications cannot listen on that port at the same time.  \n  \n> [!IMPORTANT]\n>  The samples may already be installed on your machine. Check for the following (default) directory before continuing.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples`  \n>   \n>  If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples. This sample is located in the following directory.  \n>   \n>  `<InstallDrive>:\\WF_WCF_Samples\\WCF\\Basic\\Binding\\Net\\TCP\\PortSharing`  \n  \n Many protocols have a standard or default port number that they use. For example, the HTTP protocol typically uses TCP port 80. Internet Information Services (IIS) has a listener to share a port between multiple HTTP applications. IIS listens on the port directly and forwards messages to the appropriate application based on information inside the message stream. This allows multiple HTTP applications to use the same port number without having to compete to reserve the port for receiving messages.  \n  \n NetTcp Port Sharing is a Windows Communication Foundation (WCF)feature that similarly allows multiple network applications to share a single port. The NetTcp Port Sharing Service accepts connections using the net.tcp protocol and forwards messages based on their destination address.  \n  \n The NetTcp Port Sharing Service is not enabled by default. Before running this sample, you must manually enable the service. For more information, see [How to: Enable the Net.TCP Port Sharing Service](../../../../docs/framework/wcf/feature-details/how-to-enable-the-net-tcp-port-sharing-service.md). If the service is disabled, an exception is thrown when the server application is started.  \n  \n```  \nUnhandled Exception: System.ServiceModel.CommunicationException: The TransportManager failed to listen on the supplied URI using the NetTcpPortSharing service: failed to start the service because it is disabled. An administrator can enable it by running 'sc.exe config NetTcpPortSharing start= demand'.. ---> System.InvalidOperationException: Cannot start service NetTcpPortSharing on computer '.'. ---> System.ComponentModel.Win32Exception: The service cannot be started, either because it is disabled or because it has no enabled devices associated with it  \n```  \n  \n Port sharing is enabled on the server by setting the <xref:System.ServiceModel.NetTcpBinding.PortSharingEnabled%2A> property of the <xref:System.ServiceModel.NetTcpBinding> binding or the <xref:System.ServiceModel.Channels.TcpTransportBindingElement> binding element. The client does not have to know how port sharing has been configured to use it on the server.  \n  \n## Enabling Port Sharing  \n The following code demonstrates enabling port sharing on the server. It starts an instance of the `ICalculator` service on a fixed port with a random URI path. Even though two services can share the same port, their overall endpoint addresses still must be unique so that the NetTcp Port Sharing Service can route messages to the correct application.  \n\n```csharp\n// Configure a binding with TCP port sharing enabled  \nNetTcpBinding binding = new NetTcpBinding();  \nbinding.PortSharingEnabled = true;  \n  \n// Start a service on a fixed TCP port  \nServiceHost host = new ServiceHost(typeof(CalculatorService));  \nushort salt = (ushort)new Random().Next();  \nstring address = $\"net.tcp://localhost:9000/calculator/{salt}\";\nhost.AddServiceEndpoint(typeof(ICalculator), binding, address);  \nhost.Open();  \n```\n\n With port sharing enabled, you can run the service multiple times without having a conflict over the port number. If you change the code to disable port sharing, starting up two copies of the service results in the second failing with an <xref:System.ServiceModel.AddressAlreadyInUseException>.  \n  \n```  \nUnhandled Exception: System.ServiceModel.AddressAlreadyInUseException: There is already a listener on IP endpoint 0.0.0.0:9000.  Make sure that you are not trying to use this endpoint multiple times in your application and that there are no other applications listening on this endpoint. ---> System.Net.Sockets.SocketException: Only one usage of each socket address (protocol/network address/port) is normally permitted  \n```  \n  \n## Running the Sample  \n You can use the test client to check that messages are correctly routed to services sharing the port.  \n\n```csharp\nclass client  \n{  \n   static void Main(string[] args)  \n   {  \n      Console.Write(\"Enter the service number to test: \");  \n      ushort salt = ushort.Parse(Console.ReadLine());  \n      string address = $\"net.tcp://localhost:9000/calculator/{salt}\";\n      ChannelFactory<ICalculator> factory = new ChannelFactory<ICalculator>(new NetTcpBinding());  \n      ICalculator proxy = factory.CreateChannel(new EndpointAddress(address));  \n  \n      // Call the Add service operation.  \n      double value1 = 100.00D;  \n      double value2 = 15.99D;  \n      double result = proxy.Add(value1, value2);  \n      Console.WriteLine(\"Add({0},{1}) = {2}\", value1, value2, result);  \n  \n      // Call the Subtract service operation.  \n      value1 = 145.00D;  \n      value2 = 76.54D;  \n      result = proxy.Subtract(value1, value2);  \n      Console.WriteLine(\"Subtract({0},{1}) = {2}\", value1, value2, result);  \n  \n      // Call the Multiply service operation.  \n      value1 = 9.00D;  \n      value2 = 81.25D;  \n      result = proxy.Multiply(value1, value2);  \n      Console.WriteLine(\"Multiply({0},{1}) = {2}\", value1, value2, result);  \n  \n      // Call the Divide service operation.  \n      value1 = 22.00D;  \n      value2 = 7.00D;  \n      result = proxy.Divide(value1, value2);  \n      Console.WriteLine(\"Divide({0},{1}) = {2}\", value1, value2, result);  \n  \n      Console.WriteLine();  \n      Console.WriteLine(\"Press <ENTER> to terminate client.\");  \n      Console.ReadLine();  \n  \n      factory.Close();  \n   }  \n}  \n```\n\n Each instance of the service prints out its unique number and address. For instance, you may see the following text when you run service.exe.  \n  \n```  \nService #4381 listening on net.tcp://localhost:9000/calculator/4381.  \nPress <ENTER> to terminate service.  \n```  \n  \n Enter the service number you see here when you run client.exe.  \n  \n```  \nEnter the service number to test: 4381  \nAdd(100,15.99) = 115.99  \nSubtract(145,76.54) = 68.46  \nMultiply(9,81.25) = 731.25  \nDivide(22,7) = 3.14285714285714  \n  \nPress <ENTER> to terminate client.  \n```  \n  \n This sample can be run in a cross-machine configuration by changing the generated address that the client uses. In the Client.cs, change the endpoint address format string to match the new address of your service. Replace any references to \"localhost\" with the IP address of the server machine. You must recompile the sample after making this change.  \n  \n#### To set up, build, and run the sample  \n  \n1.  Install [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] 4.0 using the following command.  \n  \n    ```  \n    %windir%\\Microsoft.NET\\Framework\\v4.0.XXXXX\\aspnet_regiis.exe /i /enable  \n    ```  \n  \n2.  Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md).  \n  \n3.  Enable the NetTcp Port Sharing Service as previously described in the introduction section.  \n  \n4.  To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md).  \n  \n5.  To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md). Specific details for running this sample are included previously in the Running the Sample section.  \n","nodes":[{"pos":[4,111],"embed":true,"restype":"x-metadata","content":"title: \"Net.TCP Port Sharing Sample\"\nms.date: \"03/30/2017\"\nms.assetid: 03da5959-0574-4e91-8a53-05854b6c55dc","nodes":[{"content":"Net.TCP Port Sharing Sample","nodes":[{"pos":[0,27],"content":"Net.TCP Port Sharing Sample","nodes":[{"content":"Net.TCP Port Sharing Sample","pos":[0,27]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[118,145],"content":"Net.TCP Port Sharing Sample","linkify":"Net.TCP Port Sharing Sample","nodes":[{"content":"Net.TCP Port Sharing Sample","pos":[0,27]}]},{"content":"The TCP/IP protocol uses a 16-bit number, called a port, to differentiate connections to multiple network applications running on the same machine.","pos":[146,293]},{"content":"If an application is listening on a port, then all TCP traffic for that port goes to that application.","pos":[294,396]},{"content":"Other applications cannot listen on that port at the same time.","pos":[397,460]},{"pos":[468,600],"content":"[!IMPORTANT]\n The samples may already be installed on your machine. Check for the following (default) directory before continuing.","leadings":["","> "],"nodes":[{"content":"The samples may already be installed on your machine. Check for the following (default) directory before continuing.","pos":[14,130],"nodes":[{"content":"The samples may already be installed on your machine.","pos":[0,53]},{"content":"Check for the following (default) directory before continuing.","pos":[54,116]}]}]},{"content":"If this directory does not exist, go to <bpt id=\"p1\">[</bpt>Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=150780)</ept> to download all Windows Communication Foundation (WCF) and <ph id=\"ph1\">[!INCLUDE[wf1](../../../../includes/wf1-md.md)]</ph> samples.","pos":[654,964],"source":"If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples."},{"content":"This sample is located in the following directory.","pos":[965,1015]},{"content":"Many protocols have a standard or default port number that they use.","pos":[1103,1171]},{"content":"For example, the HTTP protocol typically uses TCP port 80.","pos":[1172,1230]},{"content":"Internet Information Services (IIS) has a listener to share a port between multiple HTTP applications.","pos":[1231,1333]},{"content":"IIS listens on the port directly and forwards messages to the appropriate application based on information inside the message stream.","pos":[1334,1467]},{"content":"This allows multiple HTTP applications to use the same port number without having to compete to reserve the port for receiving messages.","pos":[1468,1604]},{"content":"NetTcp Port Sharing is a Windows Communication Foundation (WCF)feature that similarly allows multiple network applications to share a single port.","pos":[1611,1757]},{"content":"The NetTcp Port Sharing Service accepts connections using the net.tcp protocol and forwards messages based on their destination address.","pos":[1758,1894]},{"content":"The NetTcp Port Sharing Service is not enabled by default.","pos":[1901,1959]},{"content":"Before running this sample, you must manually enable the service.","pos":[1960,2025]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>How to: Enable the Net.TCP Port Sharing Service<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/how-to-enable-the-net-tcp-port-sharing-service.md)</ept>.","pos":[2026,2200],"source":" For more information, see [How to: Enable the Net.TCP Port Sharing Service](../../../../docs/framework/wcf/feature-details/how-to-enable-the-net-tcp-port-sharing-service.md)."},{"content":"If the service is disabled, an exception is thrown when the server application is started.","pos":[2201,2291]},{"content":"Port sharing is enabled on the server by setting the <ph id=\"ph1\">&lt;xref:System.ServiceModel.NetTcpBinding.PortSharingEnabled%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.NetTcpBinding&gt;</ph> binding or the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.TcpTransportBindingElement&gt;</ph> binding element.","pos":[2874,3141],"source":"Port sharing is enabled on the server by setting the <xref:System.ServiceModel.NetTcpBinding.PortSharingEnabled%2A> property of the <xref:System.ServiceModel.NetTcpBinding> binding or the <xref:System.ServiceModel.Channels.TcpTransportBindingElement> binding element."},{"content":"The client does not have to know how port sharing has been configured to use it on the server.","pos":[3142,3236]},{"pos":[3245,3266],"content":"Enabling Port Sharing","linkify":"Enabling Port Sharing","nodes":[{"content":"Enabling Port Sharing","pos":[0,21]}]},{"content":"The following code demonstrates enabling port sharing on the server.","pos":[3270,3338]},{"content":"It starts an instance of the <ph id=\"ph1\">`ICalculator`</ph> service on a fixed port with a random URI path.","pos":[3339,3429],"source":" It starts an instance of the `ICalculator` service on a fixed port with a random URI path."},{"content":"Even though two services can share the same port, their overall endpoint addresses still must be unique so that the NetTcp Port Sharing Service can route messages to the correct application.","pos":[3430,3620]},{"content":"With port sharing enabled, you can run the service multiple times without having a conflict over the port number.","pos":[4078,4191]},{"content":"If you change the code to disable port sharing, starting up two copies of the service results in the second failing with an <ph id=\"ph1\">&lt;xref:System.ServiceModel.AddressAlreadyInUseException&gt;</ph>.","pos":[4192,4372],"source":" If you change the code to disable port sharing, starting up two copies of the service results in the second failing with an <xref:System.ServiceModel.AddressAlreadyInUseException>."},{"pos":[4819,4837],"content":"Running the Sample","linkify":"Running the Sample","nodes":[{"content":"Running the Sample","pos":[0,18]}]},{"content":"You can use the test client to check that messages are correctly routed to services sharing the port.","pos":[4841,4942]},{"content":"Each instance of the service prints out its unique number and address.","pos":[6469,6539]},{"content":"For instance, you may see the following text when you run service.exe.","pos":[6540,6610]},{"content":"Enter the service number you see here when you run client.exe.","pos":[6741,6803]},{"content":"This sample can be run in a cross-machine configuration by changing the generated address that the client uses.","pos":[7025,7136]},{"content":"In the Client.cs, change the endpoint address format string to match the new address of your service.","pos":[7137,7238]},{"content":"Replace any references to \"localhost\" with the IP address of the server machine.","pos":[7239,7319]},{"content":"You must recompile the sample after making this change.","pos":[7320,7375]},{"pos":[7386,7422],"content":"To set up, build, and run the sample","linkify":"To set up, build, and run the sample","nodes":[{"content":"To set up, build, and run the sample","pos":[0,36]}]},{"pos":[7432,7530],"content":"Install <ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> 4.0 using the following command.","source":"Install [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] 4.0 using the following command."},{"pos":[7642,7841],"content":"Ensure that you have performed the <bpt id=\"p1\">[</bpt>One-Time Setup Procedure for the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)</ept>.","source":"Ensure that you have performed the [One-Time Setup Procedure for the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/one-time-setup-procedure-for-the-wcf-samples.md)."},{"content":"Enable the NetTcp Port Sharing Service as previously described in the introduction section.","pos":[7851,7942]},{"pos":[7952,8161],"content":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in <bpt id=\"p1\">[</bpt>Building the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/building-the-samples.md)</ept>.","source":"To build the C# or Visual Basic .NET edition of the solution, follow the instructions in [Building the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/building-the-samples.md)."},{"content":"To run the sample in a single- or cross-machine configuration, follow the instructions in <bpt id=\"p1\">[</bpt>Running the Windows Communication Foundation Samples<ept id=\"p1\">](../../../../docs/framework/wcf/samples/running-the-samples.md)</ept>.","pos":[8171,8379],"source":"To run the sample in a single- or cross-machine configuration, follow the instructions in [Running the Windows Communication Foundation Samples](../../../../docs/framework/wcf/samples/running-the-samples.md)."},{"content":"Specific details for running this sample are included previously in the Running the Sample section.","pos":[8380,8479]}]}