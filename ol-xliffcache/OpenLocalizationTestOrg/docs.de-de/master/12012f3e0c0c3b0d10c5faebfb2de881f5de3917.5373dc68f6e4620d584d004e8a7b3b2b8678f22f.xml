{"content":"---\ntitle: \"Unsupported Scenarios\"\nms.date: \"03/30/2017\"\nms.assetid: 72027d0f-146d-40c5-9d72-e94392c8bb40\n---\n# Unsupported Scenarios\nFor various reasons, Windows Communication Foundation (WCF) does not support some specific security scenarios. For example, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition does not implement the SSPI or Kerberos authentication protocols, and therefore WCF does not support running a service with Windows authentication on that platform. Other authentication mechanisms, such as username/password and HTTP/HTTPS integrated authentication are supported when running WCF under Windows XP Home Edition.  \n  \n## Impersonation Scenarios  \n  \n### Impersonated Identity Might Not Flow When Clients Make Asynchronous Calls  \n When a WCF client makes asynchronous calls to a WCF service using Windows authentication under impersonation, authentication might occur with the identity of the client process instead of the impersonated identity.  \n  \n### Windows XP and Secure Context Token Cookie Enabled  \n WCF does not support impersonation and an <xref:System.InvalidOperationException> is thrown when the following conditions exist:  \n  \n-   The operating system is [!INCLUDE[wxp](../../../../includes/wxp-md.md)].  \n  \n-   The authentication mode results in a Windows identity.  \n  \n-   The <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute> is set to <xref:System.ServiceModel.ImpersonationOption.Required>.  \n  \n-   A state-based security context token (SCT) is created (by default, creation is disabled).  \n  \n The state-based SCT can only be created using a custom binding. For more information, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).) In code, the token is enabled by creating a security binding element (either <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> or <xref:System.ServiceModel.Channels.AsymmetricSecurityBindingElement>) using the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateSspiNegotiationBindingElement%28System.Boolean%29?displayProperty=nameWithType> or the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateSecureConversationBindingElement%28System.ServiceModel.Channels.SecurityBindingElement%2CSystem.Boolean%29?displayProperty=nameWithType> method and setting the `requireCancellation` parameter to `false`. The parameter refers to the caching of the SCT. Setting the value to `false` enables the state-based SCT feature.  \n  \n Alternatively, in configuration, the token is enabled by creating a <`customBinding`>, then adding a <`security`> element, and setting the `authenticationMode` attribute to SecureConversation and the `requireSecurityContextCancellation` attribute to `true`.  \n  \n> [!NOTE]\n>  The preceding requirements are specific. For example, the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> creates a binding element that results in a Windows identity, but does not establish an SCT. Therefore, you can use it with the `Required` option on [!INCLUDE[wxp](../../../../includes/wxp-md.md)].  \n  \n### Possible ASP.NET Conflict  \n WCF and [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] can both enable or disable impersonation. When [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] hosts an WCF application, a conflict may exist between the WCF and [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] configuration settings. In case of conflict, the WCF setting takes precedence, unless the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.NotAllowed>, in which case the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] impersonation setting takes precedence.  \n  \n### Assembly Loads May Fail Under Impersonation  \n If the impersonated context does not have access rights to load an assembly and if it is the first time the common language runtime (CLR) is attempting to load the assembly for that AppDomain, the <xref:System.AppDomain> caches the failure. Subsequent attempts to load that assembly (or assemblies) fail, even after reverting the impersonation, and even if the reverted context has access rights to load the assembly. This is because the CLR does not re-attempt the load after the user context is changed. You must restart the application domain to recover from the failure.  \n  \n> [!NOTE]\n>  The default value for the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class is <xref:System.Security.Principal.TokenImpersonationLevel.Identification>. In most cases, an identification-level impersonation context has no rights to load any additional assemblies. This is the default value, so this is a very common condition to be aware of. Identification-level impersonation also occurs when the impersonating process does not have the `SeImpersonate` privilege. For more information, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).  \n  \n### Delegation Requires Credential Negotiation  \n To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called multi-leg or multi-step Kerberos). If you implement Kerberos authentication without credential negotiation (sometimes called one-shot or single-leg Kerberos), an exception is thrown. For more information about how to implement credential negotiation, see [Debugging Windows Authentication Errors](../../../../docs/framework/wcf/feature-details/debugging-windows-authentication-errors.md).  \n  \n## Cryptography  \n  \n### SHA-256 Supported Only for Symmetric Key Usages  \n WCF supports a variety of encryption and signature digest creation algorithms that you can specify using the algorithm suite in the system-provided bindings. For improved security, WCF supports Secure Hash Algorithm (SHA) 2 algorithms, specifically SHA-256, for creating signature digest hashes. This release supports SHA-256 only for symmetric key usages, such as Kerberos keys, and where an X.509 certificate is not used to sign the message. WCF does not support RSA signatures (used in X.509 certificates) using SHA-256 hash due to the current lack of support for RSA-SHA256 in the [!INCLUDE[vstecwinfx](../../../../includes/vstecwinfx-md.md)].  \n  \n### FIPS-Compliant SHA-256 Hashes not Supported  \n WCF does not support SHA-256 FIPS-compliant hashes, so algorithm suites that use SHA-256 are not supported by WCF on systems where use of FIPS compliant algorithms is required.  \n  \n### FIPS-Compliant Algorithms May Fail if Registry Is Edited  \n You can enable and disable Federal Information Processing Standards (FIPS)-compliant algorithms by using the Local Security Settings Microsoft Management Console (MMC) snap-in. You can also access the setting in the registry. Note, however, that WCF does not support using the registry to reset the setting. If the value is set to anything other than 1 or 0, inconsistent results can occur between the CLR and the operating system.  \n  \n### FIPS-Compliant AES Encryption Limitation  \n FIPS compliant AES encryption does not work in duplex callbacks under identification level impersonation.  \n  \n### CNG/KSP Certificates  \n *Cryptography API: Next Generation (CNG)* is the long-term replacement for the CryptoAPI. This API is available in unmanaged code on [!INCLUDE[wv](../../../../includes/wv-md.md)],  [!INCLUDE[lserver](../../../../includes/lserver-md.md)] and later Windows versions.  \n  \n .NET Framework 4.6.1 and earlier versions do not support these certificates because they use the legacy CryptoAPI to handle CNG/KSP certificates. The use of these certificates with   .NET Framework 4.6.1 and earlier versions will cause an exception.  \n  \n There are two possible ways to tell if a certificate uses KSP:  \n  \n-   Do a `p/invoke` of `CertGetCertificateContextProperty`, and inspect `dwProvType` on the returned `CertGetCertificateContextProperty`.  \n  \n-   Use the  `certutil` command from the command line for querying certificates. For more information, see [Certutil tasks for troubleshooting certificates](https://go.microsoft.com/fwlink/?LinkId=120056).  \n  \n## Message Security Fails if Using ASP.NET Impersonation and ASP.NET Compatibility Is Required  \n WCF does not support the following combination of settings because they can prevent client authentication from occurring:  \n  \n-   [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] Impersonation is enabled. This is done in the Web.config file by setting the `impersonate` attribute of the <`identity`> element to `true`.  \n  \n-   [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] compatibility mode is enabled by setting the `aspNetCompatibilityEnabled` attribute of the [\\<serviceHostingEnvironment>](../../../../docs/framework/configure-apps/file-schema/wcf/servicehostingenvironment.md) to `true`.  \n  \n-   Message mode security is used.  \n  \n The work-around is to turn off the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] compatibility mode. Or, if the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] compatibility mode is required, disable the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] impersonation feature and use WCF-provided impersonation instead. For more information, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).  \n  \n## IPv6 Literal Address Failure  \n Security requests fail when the client and service are on the same machine, and IPv6 literal addresses are used for the service.  \n  \n Literal IPv6 addresses work if the service and client are on different machines.  \n  \n## WSDL Retrieval Failures with Federated Trust  \n WCF requires exactly one WSDL document for each node in the federated trust chain. Be careful not to set up a loop when specifying endpoints. One way in which loops can arise is using a WSDL download of federated trust chains with two or more links in the same WSDL document. A common scenario that can produce this problem is a federated service where the Security Token Server and the service are contained inside the same ServiceHost.  \n  \n An example of this situation is a service with the following three endpoint addresses:  \n  \n- `http://localhost/CalculatorService/service` (the service)  \n  \n- `http://localhost/CalculatorService/issue_ticket` (the STS)  \n  \n- `http://localhost/CalculatorService/mex` (the metadata endpoint)  \n  \n This throws an exception.  \n  \n You can make this scenario work by putting the `issue_ticket` endpoint elsewhere.  \n  \n## WSDL Import Attributes can be Lost  \n WCF loses track of the attributes on a `<wst:Claims>` element in an `RST` template when doing a WSDL import. This happens during a WSDL import if you specify `<Claims>` directly in `WSFederationHttpBinding.Security.Message.TokenRequestParameters` or `IssuedSecurityTokenRequestParameters.AdditionalRequestParameters` instead of using the claim type collections directly.  Since the import loses the attributes, the binding does not round trip properly through WSDL and hence is incorrect on the client side.  \n  \n The fix is to modify the binding directly on the client after doing the import.  \n  \n## See also\n\n- [Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)\n- [Information Disclosure](../../../../docs/framework/wcf/feature-details/information-disclosure.md)\n- [Elevation of Privilege](../../../../docs/framework/wcf/feature-details/elevation-of-privilege.md)\n- [Denial of Service](../../../../docs/framework/wcf/feature-details/denial-of-service.md)\n- [Tampering](../../../../docs/framework/wcf/feature-details/tampering.md)\n- [Replay Attacks](../../../../docs/framework/wcf/feature-details/replay-attacks.md)\n","nodes":[{"pos":[4,105],"embed":true,"restype":"x-metadata","content":"title: \"Unsupported Scenarios\"\nms.date: \"03/30/2017\"\nms.assetid: 72027d0f-146d-40c5-9d72-e94392c8bb40","nodes":[{"content":"Unsupported Scenarios","nodes":[{"pos":[0,21],"content":"Unsupported Scenarios","nodes":[{"content":"Unsupported Scenarios","pos":[0,21]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[112,133],"content":"Unsupported Scenarios","linkify":"Unsupported Scenarios","nodes":[{"content":"Unsupported Scenarios","pos":[0,21]}]},{"content":"For various reasons, Windows Communication Foundation (WCF) does not support some specific security scenarios.","pos":[134,244]},{"content":"For example, <ph id=\"ph1\">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]</ph> Home Edition does not implement the SSPI or Kerberos authentication protocols, and therefore WCF does not support running a service with Windows authentication on that platform.","pos":[245,483],"source":" For example, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition does not implement the SSPI or Kerberos authentication protocols, and therefore WCF does not support running a service with Windows authentication on that platform."},{"content":"Other authentication mechanisms, such as username/password and HTTP/HTTPS integrated authentication are supported when running WCF under Windows XP Home Edition.","pos":[484,645]},{"pos":[654,677],"content":"Impersonation Scenarios","linkify":"Impersonation Scenarios","nodes":[{"content":"Impersonation Scenarios","pos":[0,23]}]},{"pos":[687,760],"content":"Impersonated Identity Might Not Flow When Clients Make Asynchronous Calls","linkify":"Impersonated Identity Might Not Flow When Clients Make Asynchronous Calls","nodes":[{"content":"Impersonated Identity Might Not Flow When Clients Make Asynchronous Calls","pos":[0,73]}]},{"content":"When a WCF client makes asynchronous calls to a WCF service using Windows authentication under impersonation, authentication might occur with the identity of the client process instead of the impersonated identity.","pos":[764,978]},{"pos":[988,1038],"content":"Windows XP and Secure Context Token Cookie Enabled","linkify":"Windows XP and Secure Context Token Cookie Enabled","nodes":[{"content":"Windows XP and Secure Context Token Cookie Enabled","pos":[0,50]}]},{"pos":[1042,1170],"content":"WCF does not support impersonation and an <ph id=\"ph1\">&lt;xref:System.InvalidOperationException&gt;</ph> is thrown when the following conditions exist:","source":"WCF does not support impersonation and an <xref:System.InvalidOperationException> is thrown when the following conditions exist:"},{"pos":[1180,1252],"content":"The operating system is <ph id=\"ph1\">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]</ph>.","source":"The operating system is [!INCLUDE[wxp](../../../../includes/wxp-md.md)]."},{"content":"The authentication mode results in a Windows identity.","pos":[1262,1316]},{"pos":[1326,1537],"content":"The <ph id=\"ph1\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute&gt;</ph> is set to <ph id=\"ph3\">&lt;xref:System.ServiceModel.ImpersonationOption.Required&gt;</ph>.","source":"The <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute> is set to <xref:System.ServiceModel.ImpersonationOption.Required>."},{"content":"A state-based security context token (SCT) is created (by default, creation is disabled).","pos":[1547,1636]},{"content":"The state-based SCT can only be created using a custom binding.","pos":[1643,1706]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>How to: Create a Security Context Token for a Secure Session<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md)</ept>.) In code, the token is enabled by creating a security binding element (either <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement&gt;</ph> or <ph id=\"ph2\">&lt;xref:System.ServiceModel.Channels.AsymmetricSecurityBindingElement&gt;</ph>) using the <ph id=\"ph3\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.CreateSspiNegotiationBindingElement%28System.Boolean%29?displayProperty=nameWithType&gt;</ph> or the <ph id=\"ph4\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.CreateSecureConversationBindingElement%28System.ServiceModel.Channels.SecurityBindingElement%2CSystem.Boolean%29?displayProperty=nameWithType&gt;</ph> method and setting the <ph id=\"ph5\">`requireCancellation`</ph> parameter to <ph id=\"ph6\">`false`</ph>.","pos":[1707,2555],"source":" For more information, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).) In code, the token is enabled by creating a security binding element (either <xref:System.ServiceModel.Channels.SymmetricSecurityBindingElement> or <xref:System.ServiceModel.Channels.AsymmetricSecurityBindingElement>) using the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateSspiNegotiationBindingElement%28System.Boolean%29?displayProperty=nameWithType> or the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateSecureConversationBindingElement%28System.ServiceModel.Channels.SecurityBindingElement%2CSystem.Boolean%29?displayProperty=nameWithType> method and setting the `requireCancellation` parameter to `false`."},{"content":"The parameter refers to the caching of the SCT.","pos":[2556,2603]},{"content":"Setting the value to <ph id=\"ph1\">`false`</ph> enables the state-based SCT feature.","pos":[2604,2669],"source":" Setting the value to `false` enables the state-based SCT feature."},{"pos":[2676,2933],"content":"Alternatively, in configuration, the token is enabled by creating a &lt;<ph id=\"ph1\">`customBinding`</ph>&gt;, then adding a &lt;<ph id=\"ph2\">`security`</ph>&gt; element, and setting the <ph id=\"ph3\">`authenticationMode`</ph> attribute to SecureConversation and the <ph id=\"ph4\">`requireSecurityContextCancellation`</ph> attribute to <ph id=\"ph5\">`true`</ph>.","source":"Alternatively, in configuration, the token is enabled by creating a <`customBinding`>, then adding a <`security`> element, and setting the `authenticationMode` attribute to SecureConversation and the `requireSecurityContextCancellation` attribute to `true`."},{"pos":[2941,3298],"content":"[!NOTE]\n The preceding requirements are specific. For example, the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> creates a binding element that results in a Windows identity, but does not establish an SCT. Therefore, you can use it with the `Required` option on [!INCLUDE[wxp](../../../../includes/wxp-md.md)].","leadings":["","> "],"nodes":[{"content":"The preceding requirements are specific. For example, the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> creates a binding element that results in a Windows identity, but does not establish an SCT. Therefore, you can use it with the `Required` option on [!INCLUDE[wxp](../../../../includes/wxp-md.md)].","pos":[9,355],"nodes":[{"content":"The preceding requirements are specific.","pos":[0,40]},{"content":"For example, the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A&gt;</ph> creates a binding element that results in a Windows identity, but does not establish an SCT.","pos":[41,241],"source":" For example, the <xref:System.ServiceModel.Channels.SecurityBindingElement.CreateKerberosBindingElement%2A> creates a binding element that results in a Windows identity, but does not establish an SCT."},{"content":"Therefore, you can use it with the <ph id=\"ph1\">`Required`</ph> option on <ph id=\"ph2\">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]</ph>.","pos":[242,346],"source":" Therefore, you can use it with the `Required` option on [!INCLUDE[wxp](../../../../includes/wxp-md.md)]."}]}]},{"pos":[3308,3333],"content":"Possible ASP.NET Conflict","linkify":"Possible ASP.NET Conflict","nodes":[{"content":"Possible ASP.NET Conflict","pos":[0,25]}]},{"content":"WCF and <ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> can both enable or disable impersonation.","pos":[3337,3444],"source":"WCF and [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] can both enable or disable impersonation."},{"content":"When <ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> hosts an WCF application, a conflict may exist between the WCF and <ph id=\"ph2\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> configuration settings.","pos":[3445,3656],"source":" When [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] hosts an WCF application, a conflict may exist between the WCF and [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] configuration settings."},{"content":"In case of conflict, the WCF setting takes precedence, unless the <ph id=\"ph1\">&lt;xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A&gt;</ph> property is set to <ph id=\"ph2\">&lt;xref:System.ServiceModel.ImpersonationOption.NotAllowed&gt;</ph>, in which case the <ph id=\"ph3\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> impersonation setting takes precedence.","pos":[3657,3987],"source":" In case of conflict, the WCF setting takes precedence, unless the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.NotAllowed>, in which case the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] impersonation setting takes precedence."},{"pos":[3997,4040],"content":"Assembly Loads May Fail Under Impersonation","linkify":"Assembly Loads May Fail Under Impersonation","nodes":[{"content":"Assembly Loads May Fail Under Impersonation","pos":[0,43]}]},{"content":"If the impersonated context does not have access rights to load an assembly and if it is the first time the common language runtime (CLR) is attempting to load the assembly for that AppDomain, the <ph id=\"ph1\">&lt;xref:System.AppDomain&gt;</ph> caches the failure.","pos":[4044,4284],"source":"If the impersonated context does not have access rights to load an assembly and if it is the first time the common language runtime (CLR) is attempting to load the assembly for that AppDomain, the <xref:System.AppDomain> caches the failure."},{"content":"Subsequent attempts to load that assembly (or assemblies) fail, even after reverting the impersonation, and even if the reverted context has access rights to load the assembly.","pos":[4285,4461]},{"content":"This is because the CLR does not re-attempt the load after the user context is changed.","pos":[4462,4549]},{"content":"You must restart the application domain to recover from the failure.","pos":[4550,4618]},{"pos":[4626,5367],"content":"[!NOTE]\n The default value for the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class is <xref:System.Security.Principal.TokenImpersonationLevel.Identification>. In most cases, an identification-level impersonation context has no rights to load any additional assemblies. This is the default value, so this is a very common condition to be aware of. Identification-level impersonation also occurs when the impersonating process does not have the `SeImpersonate` privilege. For more information, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).","leadings":["","> "],"nodes":[{"content":"The default value for the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class is <xref:System.Security.Principal.TokenImpersonationLevel.Identification>. In most cases, an identification-level impersonation context has no rights to load any additional assemblies. This is the default value, so this is a very common condition to be aware of. Identification-level impersonation also occurs when the impersonating process does not have the `SeImpersonate` privilege. For more information, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).","pos":[9,739],"nodes":[{"content":"The default value for the <ph id=\"ph1\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A&gt;</ph> property of the <ph id=\"ph2\">&lt;xref:System.ServiceModel.Security.WindowsClientCredential&gt;</ph> class is <ph id=\"ph3\">&lt;xref:System.Security.Principal.TokenImpersonationLevel.Identification&gt;</ph>.","pos":[0,272],"source":"The default value for the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class is <xref:System.Security.Principal.TokenImpersonationLevel.Identification>."},{"content":"In most cases, an identification-level impersonation context has no rights to load any additional assemblies.","pos":[273,382]},{"content":"This is the default value, so this is a very common condition to be aware of.","pos":[383,460]},{"content":"Identification-level impersonation also occurs when the impersonating process does not have the <ph id=\"ph1\">`SeImpersonate`</ph> privilege.","pos":[461,583],"source":" Identification-level impersonation also occurs when the impersonating process does not have the `SeImpersonate` privilege."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Delegation and Impersonation<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)</ept>.","pos":[584,730],"source":" For more information, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)."}]}]},{"pos":[5377,5419],"content":"Delegation Requires Credential Negotiation","linkify":"Delegation Requires Credential Negotiation","nodes":[{"content":"Delegation Requires Credential Negotiation","pos":[0,42]}]},{"content":"To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called multi-leg or multi-step Kerberos).","pos":[5423,5605]},{"content":"If you implement Kerberos authentication without credential negotiation (sometimes called one-shot or single-leg Kerberos), an exception is thrown.","pos":[5606,5753]},{"content":"For more information about how to implement credential negotiation, see <bpt id=\"p1\">[</bpt>Debugging Windows Authentication Errors<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/debugging-windows-authentication-errors.md)</ept>.","pos":[5754,5959],"source":" For more information about how to implement credential negotiation, see [Debugging Windows Authentication Errors](../../../../docs/framework/wcf/feature-details/debugging-windows-authentication-errors.md)."},{"pos":[5968,5980],"content":"Cryptography","linkify":"Cryptography","nodes":[{"content":"Cryptography","pos":[0,12]}]},{"pos":[5990,6037],"content":"SHA-256 Supported Only for Symmetric Key Usages","linkify":"SHA-256 Supported Only for Symmetric Key Usages","nodes":[{"content":"SHA-256 Supported Only for Symmetric Key Usages","pos":[0,47]}]},{"content":"WCF supports a variety of encryption and signature digest creation algorithms that you can specify using the algorithm suite in the system-provided bindings.","pos":[6041,6198]},{"content":"For improved security, WCF supports Secure Hash Algorithm (SHA) 2 algorithms, specifically SHA-256, for creating signature digest hashes.","pos":[6199,6336]},{"content":"This release supports SHA-256 only for symmetric key usages, such as Kerberos keys, and where an X.509 certificate is not used to sign the message.","pos":[6337,6484]},{"content":"WCF does not support RSA signatures (used in X.509 certificates) using SHA-256 hash due to the current lack of support for RSA-SHA256 in the <ph id=\"ph1\">[!INCLUDE[vstecwinfx](../../../../includes/vstecwinfx-md.md)]</ph>.","pos":[6485,6688],"source":" WCF does not support RSA signatures (used in X.509 certificates) using SHA-256 hash due to the current lack of support for RSA-SHA256 in the [!INCLUDE[vstecwinfx](../../../../includes/vstecwinfx-md.md)]."},{"pos":[6698,6741],"content":"FIPS-Compliant SHA-256 Hashes not Supported","linkify":"FIPS-Compliant SHA-256 Hashes not Supported","nodes":[{"content":"FIPS-Compliant SHA-256 Hashes not Supported","pos":[0,43]}]},{"content":"WCF does not support SHA-256 FIPS-compliant hashes, so algorithm suites that use SHA-256 are not supported by WCF on systems where use of FIPS compliant algorithms is required.","pos":[6745,6921]},{"pos":[6931,6987],"content":"FIPS-Compliant Algorithms May Fail if Registry Is Edited","linkify":"FIPS-Compliant Algorithms May Fail if Registry Is Edited","nodes":[{"content":"FIPS-Compliant Algorithms May Fail if Registry Is Edited","pos":[0,56]}]},{"content":"You can enable and disable Federal Information Processing Standards (FIPS)-compliant algorithms by using the Local Security Settings Microsoft Management Console (MMC) snap-in.","pos":[6991,7167]},{"content":"You can also access the setting in the registry.","pos":[7168,7216]},{"content":"Note, however, that WCF does not support using the registry to reset the setting.","pos":[7217,7298]},{"content":"If the value is set to anything other than 1 or 0, inconsistent results can occur between the CLR and the operating system.","pos":[7299,7422]},{"pos":[7432,7472],"content":"FIPS-Compliant AES Encryption Limitation","linkify":"FIPS-Compliant AES Encryption Limitation","nodes":[{"content":"FIPS-Compliant AES Encryption Limitation","pos":[0,40]}]},{"content":"FIPS compliant AES encryption does not work in duplex callbacks under identification level impersonation.","pos":[7476,7581]},{"pos":[7591,7611],"content":"CNG/KSP Certificates","linkify":"CNG/KSP Certificates","nodes":[{"content":"CNG/KSP Certificates","pos":[0,20]}]},{"content":"<bpt id=\"p1\">*</bpt>Cryptography API: Next Generation (CNG)<ept id=\"p1\">*</ept> is the long-term replacement for the CryptoAPI.","pos":[7615,7704],"source":"*Cryptography API: Next Generation (CNG)* is the long-term replacement for the CryptoAPI."},{"content":"This API is available in unmanaged code on <ph id=\"ph1\">[!INCLUDE[wv](../../../../includes/wv-md.md)]</ph>,  <ph id=\"ph2\">[!INCLUDE[lserver](../../../../includes/lserver-md.md)]</ph> and later Windows versions.","pos":[7705,7879],"source":" This API is available in unmanaged code on [!INCLUDE[wv](../../../../includes/wv-md.md)],  [!INCLUDE[lserver](../../../../includes/lserver-md.md)] and later Windows versions."},{"content":".NET Framework 4.6.1 and earlier versions do not support these certificates because they use the legacy CryptoAPI to handle CNG/KSP certificates.","pos":[7886,8031]},{"content":"The use of these certificates with   .NET Framework 4.6.1 and earlier versions will cause an exception.","pos":[8032,8135]},{"content":"There are two possible ways to tell if a certificate uses KSP:","pos":[8142,8204]},{"pos":[8214,8347],"content":"Do a <ph id=\"ph1\">`p/invoke`</ph> of <ph id=\"ph2\">`CertGetCertificateContextProperty`</ph>, and inspect <ph id=\"ph3\">`dwProvType`</ph> on the returned <ph id=\"ph4\">`CertGetCertificateContextProperty`</ph>.","source":"Do a `p/invoke` of `CertGetCertificateContextProperty`, and inspect `dwProvType` on the returned `CertGetCertificateContextProperty`."},{"content":"Use the  <ph id=\"ph1\">`certutil`</ph> command from the command line for querying certificates.","pos":[8357,8433],"source":"Use the  `certutil` command from the command line for querying certificates."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Certutil tasks for troubleshooting certificates<ept id=\"p1\">](https://go.microsoft.com/fwlink/?LinkId=120056)</ept>.","pos":[8434,8558],"source":" For more information, see [Certutil tasks for troubleshooting certificates](https://go.microsoft.com/fwlink/?LinkId=120056)."},{"pos":[8567,8658],"content":"Message Security Fails if Using ASP.NET Impersonation and ASP.NET Compatibility Is Required","linkify":"Message Security Fails if Using ASP.NET Impersonation and ASP.NET Compatibility Is Required","nodes":[{"content":"Message Security Fails if Using ASP.NET Impersonation and ASP.NET Compatibility Is Required","pos":[0,91]}]},{"content":"WCF does not support the following combination of settings because they can prevent client authentication from occurring:","pos":[8662,8783]},{"content":"<ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> Impersonation is enabled.","pos":[8793,8876],"source":"[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] Impersonation is enabled."},{"content":"This is done in the Web.config file by setting the <ph id=\"ph1\">`impersonate`</ph> attribute of the &lt;<ph id=\"ph2\">`identity`</ph>&gt; element to <ph id=\"ph3\">`true`</ph>.","pos":[8877,8990],"source":" This is done in the Web.config file by setting the `impersonate` attribute of the <`identity`> element to `true`."},{"pos":[9000,9278],"content":"<ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> compatibility mode is enabled by setting the <ph id=\"ph2\">`aspNetCompatibilityEnabled`</ph> attribute of the <bpt id=\"p1\">[</bpt><ph id=\"ph3\">\\&lt;</ph>serviceHostingEnvironment&gt;<ept id=\"p1\">](../../../../docs/framework/configure-apps/file-schema/wcf/servicehostingenvironment.md)</ept> to <ph id=\"ph4\">`true`</ph>.","source":"[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] compatibility mode is enabled by setting the `aspNetCompatibilityEnabled` attribute of the [\\<serviceHostingEnvironment>](../../../../docs/framework/configure-apps/file-schema/wcf/servicehostingenvironment.md) to `true`."},{"content":"Message mode security is used.","pos":[9288,9318]},{"content":"The work-around is to turn off the <ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> compatibility mode.","pos":[9325,9437],"source":"The work-around is to turn off the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] compatibility mode."},{"content":"Or, if the <ph id=\"ph1\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> compatibility mode is required, disable the <ph id=\"ph2\">[!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]</ph> impersonation feature and use WCF-provided impersonation instead.","pos":[9438,9674],"source":" Or, if the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] compatibility mode is required, disable the [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] impersonation feature and use WCF-provided impersonation instead."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Delegation and Impersonation<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)</ept>.","pos":[9675,9821],"source":" For more information, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)."},{"pos":[9830,9858],"content":"IPv6 Literal Address Failure","linkify":"IPv6 Literal Address Failure","nodes":[{"content":"IPv6 Literal Address Failure","pos":[0,28]}]},{"content":"Security requests fail when the client and service are on the same machine, and IPv6 literal addresses are used for the service.","pos":[9862,9990]},{"content":"Literal IPv6 addresses work if the service and client are on different machines.","pos":[9997,10077]},{"pos":[10086,10130],"content":"WSDL Retrieval Failures with Federated Trust","linkify":"WSDL Retrieval Failures with Federated Trust","nodes":[{"content":"WSDL Retrieval Failures with Federated Trust","pos":[0,44]}]},{"content":"WCF requires exactly one WSDL document for each node in the federated trust chain.","pos":[10134,10216]},{"content":"Be careful not to set up a loop when specifying endpoints.","pos":[10217,10275]},{"content":"One way in which loops can arise is using a WSDL download of federated trust chains with two or more links in the same WSDL document.","pos":[10276,10409]},{"content":"A common scenario that can produce this problem is a federated service where the Security Token Server and the service are contained inside the same ServiceHost.","pos":[10410,10571]},{"content":"An example of this situation is a service with the following three endpoint addresses:","pos":[10578,10664]},{"pos":[10672,10730],"content":"<ph id=\"ph1\">`http://localhost/CalculatorService/service`</ph> (the service)","source":"`http://localhost/CalculatorService/service` (the service)"},{"pos":[10738,10797],"content":"<ph id=\"ph1\">`http://localhost/CalculatorService/issue_ticket`</ph> (the STS)","source":"`http://localhost/CalculatorService/issue_ticket` (the STS)"},{"pos":[10805,10869],"content":"<ph id=\"ph1\">`http://localhost/CalculatorService/mex`</ph> (the metadata endpoint)","source":"`http://localhost/CalculatorService/mex` (the metadata endpoint)"},{"content":"This throws an exception.","pos":[10876,10901]},{"pos":[10908,10989],"content":"You can make this scenario work by putting the <ph id=\"ph1\">`issue_ticket`</ph> endpoint elsewhere.","source":"You can make this scenario work by putting the `issue_ticket` endpoint elsewhere."},{"pos":[10998,11032],"content":"WSDL Import Attributes can be Lost","linkify":"WSDL Import Attributes can be Lost","nodes":[{"content":"WSDL Import Attributes can be Lost","pos":[0,34]}]},{"content":"WCF loses track of the attributes on a <ph id=\"ph1\">`&lt;wst:Claims&gt;`</ph> element in an <ph id=\"ph2\">`RST`</ph> template when doing a WSDL import.","pos":[11036,11144],"source":"WCF loses track of the attributes on a `<wst:Claims>` element in an `RST` template when doing a WSDL import."},{"content":"This happens during a WSDL import if you specify <ph id=\"ph1\">`&lt;Claims&gt;`</ph> directly in <ph id=\"ph2\">`WSFederationHttpBinding.Security.Message.TokenRequestParameters`</ph> or <ph id=\"ph3\">`IssuedSecurityTokenRequestParameters.AdditionalRequestParameters`</ph> instead of using the claim type collections directly.","pos":[11145,11406],"source":" This happens during a WSDL import if you specify `<Claims>` directly in `WSFederationHttpBinding.Security.Message.TokenRequestParameters` or `IssuedSecurityTokenRequestParameters.AdditionalRequestParameters` instead of using the claim type collections directly."},{"content":"Since the import loses the attributes, the binding does not round trip properly through WSDL and hence is incorrect on the client side.","pos":[11408,11543]},{"content":"The fix is to modify the binding directly on the client after doing the import.","pos":[11550,11629]},{"pos":[11638,11646],"content":"See also","linkify":"See also","nodes":[{"content":"See also","pos":[0,8]}]},{"pos":[11650,11757],"content":"<bpt id=\"p1\">[</bpt>Security Considerations<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)</ept>","source":"[Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)"},{"pos":[11760,11858],"content":"<bpt id=\"p1\">[</bpt>Information Disclosure<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/information-disclosure.md)</ept>","source":"[Information Disclosure](../../../../docs/framework/wcf/feature-details/information-disclosure.md)"},{"pos":[11861,11959],"content":"<bpt id=\"p1\">[</bpt>Elevation of Privilege<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/elevation-of-privilege.md)</ept>","source":"[Elevation of Privilege](../../../../docs/framework/wcf/feature-details/elevation-of-privilege.md)"},{"pos":[11962,12050],"content":"<bpt id=\"p1\">[</bpt>Denial of Service<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/denial-of-service.md)</ept>","source":"[Denial of Service](../../../../docs/framework/wcf/feature-details/denial-of-service.md)"},{"pos":[12053,12125],"content":"<bpt id=\"p1\">[</bpt>Tampering<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/tampering.md)</ept>","source":"[Tampering](../../../../docs/framework/wcf/feature-details/tampering.md)"},{"pos":[12128,12210],"content":"<bpt id=\"p1\">[</bpt>Replay Attacks<ept id=\"p1\">](../../../../docs/framework/wcf/feature-details/replay-attacks.md)</ept>","source":"[Replay Attacks](../../../../docs/framework/wcf/feature-details/replay-attacks.md)"}]}