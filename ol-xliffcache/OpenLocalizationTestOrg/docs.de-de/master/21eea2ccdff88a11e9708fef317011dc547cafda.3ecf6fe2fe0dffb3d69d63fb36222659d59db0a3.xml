{"content":"---\ntitle: \"Interop Marshaling\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"marshaling, COM interop\"\n  - \"interop marshaling\"\n  - \"interop marshaling, about interop marshaling\"\nms.assetid: 115f7a2f-d422-4605-ab36-13a8dd28142a\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"\n---\n# Interop Marshaling\n<a name=\"top\"></a> Interop marshaling governs how data is passed in method arguments and return values between managed and unmanaged memory during calls. Interop marshaling is a run-time activity performed by the common language runtime's marshaling service.  \n  \n Most data types have common representations in both managed and unmanaged memory. The interop marshaler handles these types for you. Other types can be ambiguous or not represented at all in managed memory.  \n  \n An ambiguous type can have either multiple unmanaged representations that map to a single managed type, or missing type information, such as the size of an array. For ambiguous types, the marshaler provides a default representation and alternative representations where multiple representations exist. You can supply explicit instructions to the marshaler on how it is to marshal an ambiguous type.  \n  \n This overview contains the following sections:  \n  \n-   [Platform Invoke and COM Interop Models](#platform_invoke_and_com_interop_models)  \n  \n-   [Marshaling and COM Apartments](#marshaling_and_com_apartments)  \n  \n-   [Marshaling Remote Calls](#marshaling_remote_calls)  \n  \n-   [Related Topics](#related_topics)  \n  \n-   [Reference](#reference)  \n  \n<a name=\"platform_invoke_and_com_interop_models\"></a>   \n## Platform Invoke and COM Interop Models  \n The common language runtime provides two mechanisms for interoperating with unmanaged code:  \n  \n-   Platform invoke, which enables managed code to call functions exported from an unmanaged library.  \n  \n-   COM interop, which enables managed code to interact with Component Object Model (COM) objects through interfaces.  \n  \n Both platform invoke and COM interop use interop marshaling to accurately move method arguments between caller and callee and back, if required. As the following illustration shows, a platform invoke method call flows from managed to unmanaged code and never the other way, except when [callback functions](callback-functions.md) are involved. Even though platform invoke calls can flow only from managed to unmanaged code, data can flow in both directions as input or output parameters. COM interop method calls can flow in either direction.  \n  \n ![Platform invoke](./media/interop-marshaling/interop-marshaling-invoke-and-com.png \"Platform invoke and COM interop call flow\")  \n  \n At the lowest level, both mechanisms use the same interop marshaling service; however, certain data types are supported exclusively by COM interop or platform invoke. For details, see [Default Marshaling Behavior](default-marshaling-behavior.md).  \n  \n [Back to top](#top)  \n  \n<a name=\"marshaling_and_com_apartments\"></a>   \n## Marshaling and COM Apartments  \n The interop marshaler marshals data between the common language runtime heap and the unmanaged heap. Marshaling occurs whenever the caller and callee cannot operate on the same instance of data. The interop marshaler makes it possible for the caller and callee to appear to be operating on the same data even if they have their own copy of the data.  \n  \n COM also has a marshaler that marshals data between COM apartments or different COM processes. When calling between managed and unmanaged code within the same COM apartment, the interop marshaler is the only marshaler involved. When calling between managed code and unmanaged code in a different COM apartment or a different process, both the interop marshaler and the COM marshaler are involved.  \n  \n### COM Clients and Managed Servers  \n An exported managed server with a type library registered by the [Regasm.exe (Assembly Registration Tool)](../tools/regasm-exe-assembly-registration-tool.md) has a `ThreadingModel` registry entry set to `Both`. This value indicates that the server can be activated in a single-threaded apartment (STA) or a multithreaded apartment (MTA). The server object is created in the same apartment as its caller, as shown in the following table.  \n  \n|COM client|.NET server|Marshaling requirements|  \n|----------------|-----------------|-----------------------------|  \n|STA|`Both` becomes STA.|Same-apartment marshaling.|  \n|MTA|`Both` becomes MTA.|Same-apartment marshaling.|  \n  \n Because the client and server are in the same apartment, the interop marshaling service automatically handles all data marshaling. The following illustration shows the interop marshaling service operating between managed and unmanaged heaps within the same COM-style apartment.  \n  \n ![Interop marshaling between managed and unmanaged heaps](./media/interop-marshaling/interop-heaps-managed-and-unmanaged.gif \"Same-apartment marshaling process\")  \n  \n If you plan to export a managed server, be aware that the COM client determines the apartment of the server. A managed server called by a COM client initialized in an MTA must ensure thread safety.  \n  \n### Managed Clients and COM Servers  \n The default setting for managed client apartments is MTA; however, the application type of the .NET client can change the default setting. For example, a [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] client apartment setting is STA. You can use the <xref:System.STAThreadAttribute?displayProperty=nameWithType>, the <xref:System.MTAThreadAttribute?displayProperty=nameWithType>, the <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType> property, or the <xref:System.Web.UI.Page.AspCompatMode%2A?displayProperty=nameWithType> property to examine and change the apartment setting of a managed client.  \n  \n The author of the component sets the thread affinity of a COM server. The following table shows the combinations of apartment settings for .NET clients and COM servers. It also shows the resulting marshaling requirements for the combinations.  \n  \n|.NET client|COM server|Marshaling requirements|  \n|-----------------|----------------|-----------------------------|  \n|MTA (default)|MTA<br /><br /> STA|Interop marshaling.<br /><br /> Interop and COM marshaling.|  \n|STA|MTA<br /><br /> STA|Interop and COM marshaling.<br /><br /> Interop marshaling.|  \n  \n When a managed client and unmanaged server are in the same apartment, the interop marshaling service handles all data marshaling. However, when client and server are initialized in different apartments, COM marshaling is also required. The following illustration shows the elements of a cross-apartment call.  \n  \n ![COM marshaling](./media/interop-marshaling/single-process-across-multi-apartment.gif \"Cross-apartment call between a .NET client and COM object\")  \n  \n For cross-apartment marshaling, you can do the following:  \n  \n-   Accept the overhead of the cross-apartment marshaling, which is noticeable only when there are many calls across the boundary. You must register the type library of the COM component for calls to successfully cross the apartment boundary.  \n  \n-   Alter the main thread by setting the client thread to STA or MTA. For example, if your C# client calls many STA COM components, you can avoid cross-apartment marshaling by setting the main thread to STA.  \n  \n    > [!NOTE]\n    >  Once the thread of a C# client is set to STA, calls to MTA COM components will require cross-apartment marshaling.  \n  \n For instructions on explicitly selecting an apartment model, see [Managed and Unmanaged Threading](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/5s8ee185(v=vs.100)).  \n  \n [Back to top](#top)  \n  \n<a name=\"marshaling_remote_calls\"></a>   \n## Marshaling Remote Calls  \n As with cross-apartment marshaling, COM marshaling is involved in each call between managed and unmanaged code whenever the objects reside in separate processes. For example:  \n  \n-   A COM client that invokes a managed server on a remote host uses distributed COM (DCOM).  \n  \n-   A managed client that invokes a COM server on a remote host uses DCOM.  \n  \n The following illustration shows how interop marshaling and COM marshaling provide communications channels across process and host boundaries.  \n  \n ![COM marshaling](./media/interop-marshaling/interop-and-com-marshaling.gif \"Cross-process marshaling\")  \n  \n### Preserving Identity  \n The common language runtime preserves the identity of managed and unmanaged references. The following illustration shows the flow of direct unmanaged references (top row) and direct managed references (bottom row) across process and host boundaries.  \n  \n ![COM callable wrapper and runtime callable wrapper](./media/interop-marshaling/interop-direct-ref-across-process.gif \"Reference passing across process and host boundaries\")  \n  \n In this illustration:  \n  \n-   An unmanaged client gets a reference to a COM object from a managed object that gets this reference from a remote host. The remoting mechanism is DCOM.  \n  \n-   A managed client gets a reference to a managed object from a COM object that gets this reference from a remote host. The remoting mechanism is DCOM.  \n  \n    > [!NOTE]\n    >  The exported type library of the managed server must be registered.  \n  \n The number of process boundaries between caller and callee is irrelevant; the same direct referencing occurs for in-process and out-of-process calls.  \n  \n### Managed Remoting  \n The runtime also provides managed remoting, which you can use to establish a communications channel between managed objects across process and host boundaries. Managed remoting can accommodate a firewall between the communicating components, as the following illustration shows.  \n  \n ![SOAP or TcpChannel](./media/interop-marshaling/interop-remote-soap-or-tcp.gif \"Remote calls across firewalls using SOAP or the TcpChannel class\")  \nRemote calls across firewalls using SOAP or the TcpChannel class  \n  \n Some unmanaged calls can be channeled through SOAP, such as the calls between serviced components and COM.  \n  \n [Back to top](#top)  \n  \n<a name=\"related_topics\"></a>   \n## Related Topics  \n  \n|Title|Description|  \n|-----------|-----------------|  \n|[Default Marshaling Behavior](default-marshaling-behavior.md)|Describes the rules that the interop marshaling service uses to marshal data.|  \n|[Marshaling Data with Platform Invoke](marshaling-data-with-platform-invoke.md)|Describes how to declare method parameters and pass arguments to functions exported by unmanaged libraries.|  \n|[Marshaling Data with COM Interop](marshaling-data-with-com-interop.md)|Describes how to customize COM wrappers to alter marshaling behavior.|  \n|[How to: Migrate Managed-Code DCOM to WCF](how-to-migrate-managed-code-dcom-to-wcf.md)|Describes how to migrate from DCOM to WCF.|  \n|[How to: Map HRESULTs and Exceptions](how-to-map-hresults-and-exceptions.md)|Describes how to map custom exceptions to HRESULTs and provides the complete mapping from each HRESULT to its comparable exception class in the .NET Framework.|  \n|[Interoperating Using Generic Types](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms229590(v=vs.100))|Describes which actions are supported when using generic types for COM interoperability.|  \n|[Interoperating with Unmanaged Code](index.md)|Describes interoperability services provided by the common language runtime.|  \n|[Advanced COM Interoperability](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bd9cdfyx(v=vs.100))|Provides links to more information about incorporating COM components into your .NET Framework application.|  \n|[Design Considerations for Interoperation](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/61aax4kh(v=vs.100))|Provides tips for writing integrated COM components.|  \n  \n [Back to top](#top)  \n  \n<a name=\"reference\"></a>   \n## Reference  \n <xref:System.Runtime.InteropServices?displayProperty=nameWithType>  \n  \n [Back to top](#top)\n","nodes":[{"pos":[4,270],"embed":true,"restype":"x-metadata","content":"title: \"Interop Marshaling\"\nms.date: \"03/30/2017\"\nhelpviewer_keywords: \n  - \"marshaling, COM interop\"\n  - \"interop marshaling\"\n  - \"interop marshaling, about interop marshaling\"\nms.assetid: 115f7a2f-d422-4605-ab36-13a8dd28142a\nauthor: \"rpetrusha\"\nms.author: \"ronpet\"","nodes":[{"content":"Interop Marshaling","nodes":[{"pos":[0,18],"content":"Interop Marshaling","nodes":[{"content":"Interop Marshaling","pos":[0,18]}]}],"path":["title"],"nosxs":false}],"yml":true},{"pos":[277,295],"content":"Interop Marshaling","linkify":"Interop Marshaling","nodes":[{"content":"Interop Marshaling","pos":[0,18]}]},{"content":"<bpt id=\"p1\">&lt;a name=\"top\"&gt;</bpt><ept id=\"p1\">&lt;/a&gt;</ept> Interop marshaling governs how data is passed in method arguments and return values between managed and unmanaged memory during calls.","pos":[296,449],"source":"<a name=\"top\"></a> Interop marshaling governs how data is passed in method arguments and return values between managed and unmanaged memory during calls."},{"content":"Interop marshaling is a run-time activity performed by the common language runtime's marshaling service.","pos":[450,554]},{"content":"Most data types have common representations in both managed and unmanaged memory.","pos":[561,642]},{"content":"The interop marshaler handles these types for you.","pos":[643,693]},{"content":"Other types can be ambiguous or not represented at all in managed memory.","pos":[694,767]},{"content":"An ambiguous type can have either multiple unmanaged representations that map to a single managed type, or missing type information, such as the size of an array.","pos":[774,936]},{"content":"For ambiguous types, the marshaler provides a default representation and alternative representations where multiple representations exist.","pos":[937,1075]},{"content":"You can supply explicit instructions to the marshaler on how it is to marshal an ambiguous type.","pos":[1076,1172]},{"content":"This overview contains the following sections:","pos":[1179,1225]},{"pos":[1235,1316],"content":"<bpt id=\"p1\">[</bpt>Platform Invoke and COM Interop Models<ept id=\"p1\">](#platform_invoke_and_com_interop_models)</ept>","source":"[Platform Invoke and COM Interop Models](#platform_invoke_and_com_interop_models)"},{"pos":[1326,1389],"content":"<bpt id=\"p1\">[</bpt>Marshaling and COM Apartments<ept id=\"p1\">](#marshaling_and_com_apartments)</ept>","source":"[Marshaling and COM Apartments](#marshaling_and_com_apartments)"},{"pos":[1399,1450],"content":"<bpt id=\"p1\">[</bpt>Marshaling Remote Calls<ept id=\"p1\">](#marshaling_remote_calls)</ept>","source":"[Marshaling Remote Calls](#marshaling_remote_calls)"},{"pos":[1460,1493],"content":"<bpt id=\"p1\">[</bpt>Related Topics<ept id=\"p1\">](#related_topics)</ept>","source":"[Related Topics](#related_topics)"},{"pos":[1503,1526],"content":"<bpt id=\"p1\">[</bpt>Reference<ept id=\"p1\">](#reference)</ept>","source":"[Reference](#reference)"},{"pos":[1592,1630],"content":"Platform Invoke and COM Interop Models","linkify":"Platform Invoke and COM Interop Models","nodes":[{"content":"Platform Invoke and COM Interop Models","pos":[0,38]}]},{"content":"The common language runtime provides two mechanisms for interoperating with unmanaged code:","pos":[1634,1725]},{"content":"Platform invoke, which enables managed code to call functions exported from an unmanaged library.","pos":[1735,1832]},{"content":"COM interop, which enables managed code to interact with Component Object Model (COM) objects through interfaces.","pos":[1842,1955]},{"content":"Both platform invoke and COM interop use interop marshaling to accurately move method arguments between caller and callee and back, if required.","pos":[1962,2106]},{"content":"As the following illustration shows, a platform invoke method call flows from managed to unmanaged code and never the other way, except when <bpt id=\"p1\">[</bpt>callback functions<ept id=\"p1\">](callback-functions.md)</ept> are involved.","pos":[2107,2305],"source":" As the following illustration shows, a platform invoke method call flows from managed to unmanaged code and never the other way, except when [callback functions](callback-functions.md) are involved."},{"content":"Even though platform invoke calls can flow only from managed to unmanaged code, data can flow in both directions as input or output parameters.","pos":[2306,2449]},{"content":"COM interop method calls can flow in either direction.","pos":[2450,2504]},{"pos":[2511,2639],"content":"<bpt id=\"p1\">![</bpt>Platform invoke<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interop-marshaling/interop-marshaling-invoke-and-com.png \"</bpt>Platform invoke and COM interop call flow<ept id=\"p2\">\")</ept>","source":"![Platform invoke](./media/interop-marshaling/interop-marshaling-invoke-and-com.png \"Platform invoke and COM interop call flow\")"},{"content":"At the lowest level, both mechanisms use the same interop marshaling service; however, certain data types are supported exclusively by COM interop or platform invoke.","pos":[2646,2812]},{"content":"For details, see <bpt id=\"p1\">[</bpt>Default Marshaling Behavior<ept id=\"p1\">](default-marshaling-behavior.md)</ept>.","pos":[2813,2892],"source":" For details, see [Default Marshaling Behavior](default-marshaling-behavior.md)."},{"pos":[2899,2918],"content":"<bpt id=\"p1\">[</bpt>Back to top<ept id=\"p1\">](#top)</ept>","source":"[Back to top](#top)"},{"pos":[2975,3004],"content":"Marshaling and COM Apartments","linkify":"Marshaling and COM Apartments","nodes":[{"content":"Marshaling and COM Apartments","pos":[0,29]}]},{"content":"The interop marshaler marshals data between the common language runtime heap and the unmanaged heap.","pos":[3008,3108]},{"content":"Marshaling occurs whenever the caller and callee cannot operate on the same instance of data.","pos":[3109,3202]},{"content":"The interop marshaler makes it possible for the caller and callee to appear to be operating on the same data even if they have their own copy of the data.","pos":[3203,3357]},{"content":"COM also has a marshaler that marshals data between COM apartments or different COM processes.","pos":[3364,3458]},{"content":"When calling between managed and unmanaged code within the same COM apartment, the interop marshaler is the only marshaler involved.","pos":[3459,3591]},{"content":"When calling between managed code and unmanaged code in a different COM apartment or a different process, both the interop marshaler and the COM marshaler are involved.","pos":[3592,3760]},{"pos":[3770,3801],"content":"COM Clients and Managed Servers","linkify":"COM Clients and Managed Servers","nodes":[{"content":"COM Clients and Managed Servers","pos":[0,31]}]},{"content":"An exported managed server with a type library registered by the <bpt id=\"p1\">[</bpt>Regasm.exe (Assembly Registration Tool)<ept id=\"p1\">](../tools/regasm-exe-assembly-registration-tool.md)</ept> has a <ph id=\"ph1\">`ThreadingModel`</ph> registry entry set to <ph id=\"ph2\">`Both`</ph>.","pos":[3805,4015],"source":"An exported managed server with a type library registered by the [Regasm.exe (Assembly Registration Tool)](../tools/regasm-exe-assembly-registration-tool.md) has a `ThreadingModel` registry entry set to `Both`."},{"content":"This value indicates that the server can be activated in a single-threaded apartment (STA) or a multithreaded apartment (MTA).","pos":[4016,4142]},{"content":"The server object is created in the same apartment as its caller, as shown in the following table.","pos":[4143,4241]},{"content":"COM client","pos":[4248,4258]},{"content":".NET server","pos":[4259,4270]},{"content":"Marshaling requirements","pos":[4271,4294]},{"content":"STA","pos":[4368,4371]},{"pos":[4372,4391],"content":"<ph id=\"ph1\">`Both`</ph> becomes STA.","source":"`Both` becomes STA."},{"content":"Same-apartment marshaling.","pos":[4392,4418]},{"content":"MTA","pos":[4423,4426]},{"pos":[4427,4446],"content":"<ph id=\"ph1\">`Both`</ph> becomes MTA.","source":"`Both` becomes MTA."},{"content":"Same-apartment marshaling.","pos":[4447,4473]},{"content":"Because the client and server are in the same apartment, the interop marshaling service automatically handles all data marshaling.","pos":[4481,4611]},{"content":"The following illustration shows the interop marshaling service operating between managed and unmanaged heaps within the same COM-style apartment.","pos":[4612,4758]},{"pos":[4765,4926],"content":"<bpt id=\"p1\">![</bpt>Interop marshaling between managed and unmanaged heaps<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interop-marshaling/interop-heaps-managed-and-unmanaged.gif \"</bpt>Same-apartment marshaling process<ept id=\"p2\">\")</ept>","source":"![Interop marshaling between managed and unmanaged heaps](./media/interop-marshaling/interop-heaps-managed-and-unmanaged.gif \"Same-apartment marshaling process\")"},{"content":"If you plan to export a managed server, be aware that the COM client determines the apartment of the server.","pos":[4933,5041]},{"content":"A managed server called by a COM client initialized in an MTA must ensure thread safety.","pos":[5042,5130]},{"pos":[5140,5171],"content":"Managed Clients and COM Servers","linkify":"Managed Clients and COM Servers","nodes":[{"content":"Managed Clients and COM Servers","pos":[0,31]}]},{"content":"The default setting for managed client apartments is MTA; however, the application type of the .NET client can change the default setting.","pos":[5175,5313]},{"content":"For example, a <ph id=\"ph1\">[!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)]</ph> client apartment setting is STA.","pos":[5314,5420],"source":" For example, a [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] client apartment setting is STA."},{"content":"You can use the <ph id=\"ph1\">&lt;xref:System.STAThreadAttribute?displayProperty=nameWithType&gt;</ph>, the <ph id=\"ph2\">&lt;xref:System.MTAThreadAttribute?displayProperty=nameWithType&gt;</ph>, the <ph id=\"ph3\">&lt;xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType&gt;</ph> property, or the <ph id=\"ph4\">&lt;xref:System.Web.UI.Page.AspCompatMode%2A?displayProperty=nameWithType&gt;</ph> property to examine and change the apartment setting of a managed client.","pos":[5421,5811],"source":" You can use the <xref:System.STAThreadAttribute?displayProperty=nameWithType>, the <xref:System.MTAThreadAttribute?displayProperty=nameWithType>, the <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType> property, or the <xref:System.Web.UI.Page.AspCompatMode%2A?displayProperty=nameWithType> property to examine and change the apartment setting of a managed client."},{"content":"The author of the component sets the thread affinity of a COM server.","pos":[5818,5887]},{"content":"The following table shows the combinations of apartment settings for .NET clients and COM servers.","pos":[5888,5986]},{"content":"It also shows the resulting marshaling requirements for the combinations.","pos":[5987,6060]},{"content":".NET client","pos":[6067,6078]},{"content":"COM server","pos":[6079,6089]},{"content":"Marshaling requirements","pos":[6090,6113]},{"content":"MTA (default)","pos":[6187,6200]},{"content":"MTA","pos":[6201,6204]},{"content":"STA","pos":[6217,6220]},{"content":"Interop marshaling.","pos":[6221,6240]},{"content":"Interop and COM marshaling.","pos":[6253,6280]},{"content":"STA","pos":[6285,6288]},{"content":"MTA","pos":[6289,6292]},{"content":"STA","pos":[6305,6308]},{"content":"Interop and COM marshaling.","pos":[6309,6336]},{"content":"Interop marshaling.","pos":[6349,6368]},{"content":"When a managed client and unmanaged server are in the same apartment, the interop marshaling service handles all data marshaling.","pos":[6376,6505]},{"content":"However, when client and server are initialized in different apartments, COM marshaling is also required.","pos":[6506,6611]},{"content":"The following illustration shows the elements of a cross-apartment call.","pos":[6612,6684]},{"pos":[6691,6838],"content":"<bpt id=\"p1\">![</bpt>COM marshaling<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interop-marshaling/single-process-across-multi-apartment.gif \"</bpt>Cross-apartment call between a .NET client and COM object<ept id=\"p2\">\")</ept>","source":"![COM marshaling](./media/interop-marshaling/single-process-across-multi-apartment.gif \"Cross-apartment call between a .NET client and COM object\")"},{"content":"For cross-apartment marshaling, you can do the following:","pos":[6845,6902]},{"content":"Accept the overhead of the cross-apartment marshaling, which is noticeable only when there are many calls across the boundary.","pos":[6912,7038]},{"content":"You must register the type library of the COM component for calls to successfully cross the apartment boundary.","pos":[7039,7150]},{"content":"Alter the main thread by setting the client thread to STA or MTA.","pos":[7160,7225]},{"content":"For example, if your C# client calls many STA COM components, you can avoid cross-apartment marshaling by setting the main thread to STA.","pos":[7226,7363]},{"pos":[7375,7504],"content":"[!NOTE]\nOnce the thread of a C# client is set to STA, calls to MTA COM components will require cross-apartment marshaling.","leadings":["","    >  "],"nodes":[{"content":"Once the thread of a C# client is set to STA, calls to MTA COM components will require cross-apartment marshaling.","pos":[8,122]}]},{"pos":[7511,7699],"content":"For instructions on explicitly selecting an apartment model, see <bpt id=\"p1\">[</bpt>Managed and Unmanaged Threading<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/5s8ee185(v=vs.100))</ept>.","source":"For instructions on explicitly selecting an apartment model, see [Managed and Unmanaged Threading](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/5s8ee185(v=vs.100))."},{"pos":[7706,7725],"content":"<bpt id=\"p1\">[</bpt>Back to top<ept id=\"p1\">](#top)</ept>","source":"[Back to top](#top)"},{"pos":[7776,7799],"content":"Marshaling Remote Calls","linkify":"Marshaling Remote Calls","nodes":[{"content":"Marshaling Remote Calls","pos":[0,23]}]},{"content":"As with cross-apartment marshaling, COM marshaling is involved in each call between managed and unmanaged code whenever the objects reside in separate processes.","pos":[7803,7964]},{"content":"For example:","pos":[7965,7977]},{"content":"A COM client that invokes a managed server on a remote host uses distributed COM (DCOM).","pos":[7987,8075]},{"content":"A managed client that invokes a COM server on a remote host uses DCOM.","pos":[8085,8155]},{"content":"The following illustration shows how interop marshaling and COM marshaling provide communications channels across process and host boundaries.","pos":[8162,8304]},{"pos":[8311,8414],"content":"<bpt id=\"p1\">![</bpt>COM marshaling<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interop-marshaling/interop-and-com-marshaling.gif \"</bpt>Cross-process marshaling<ept id=\"p2\">\")</ept>","source":"![COM marshaling](./media/interop-marshaling/interop-and-com-marshaling.gif \"Cross-process marshaling\")"},{"pos":[8424,8443],"content":"Preserving Identity","linkify":"Preserving Identity","nodes":[{"content":"Preserving Identity","pos":[0,19]}]},{"content":"The common language runtime preserves the identity of managed and unmanaged references.","pos":[8447,8534]},{"content":"The following illustration shows the flow of direct unmanaged references (top row) and direct managed references (bottom row) across process and host boundaries.","pos":[8535,8696]},{"pos":[8703,8876],"content":"<bpt id=\"p1\">![</bpt>COM callable wrapper and runtime callable wrapper<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interop-marshaling/interop-direct-ref-across-process.gif \"</bpt>Reference passing across process and host boundaries<ept id=\"p2\">\")</ept>","source":"![COM callable wrapper and runtime callable wrapper](./media/interop-marshaling/interop-direct-ref-across-process.gif \"Reference passing across process and host boundaries\")"},{"content":"In this illustration:","pos":[8883,8904]},{"content":"An unmanaged client gets a reference to a COM object from a managed object that gets this reference from a remote host.","pos":[8914,9033]},{"content":"The remoting mechanism is DCOM.","pos":[9034,9065]},{"content":"A managed client gets a reference to a managed object from a COM object that gets this reference from a remote host.","pos":[9075,9191]},{"content":"The remoting mechanism is DCOM.","pos":[9192,9223]},{"pos":[9235,9317],"content":"[!NOTE]\nThe exported type library of the managed server must be registered.","leadings":["","    >  "],"nodes":[{"content":"The exported type library of the managed server must be registered.","pos":[8,75]}]},{"content":"The number of process boundaries between caller and callee is irrelevant; the same direct referencing occurs for in-process and out-of-process calls.","pos":[9324,9473]},{"pos":[9483,9499],"content":"Managed Remoting","linkify":"Managed Remoting","nodes":[{"content":"Managed Remoting","pos":[0,16]}]},{"content":"The runtime also provides managed remoting, which you can use to establish a communications channel between managed objects across process and host boundaries.","pos":[9503,9662]},{"content":"Managed remoting can accommodate a firewall between the communicating components, as the following illustration shows.","pos":[9663,9781]},{"content":"<bpt id=\"p1\">![</bpt>SOAP or TcpChannel<ept id=\"p1\">]</ept><bpt id=\"p2\">(./media/interop-marshaling/interop-remote-soap-or-tcp.gif \"</bpt>Remote calls across firewalls using SOAP or the TcpChannel class<ept id=\"p2\">\")</ept>","pos":[9788,9935],"source":"![SOAP or TcpChannel](./media/interop-marshaling/interop-remote-soap-or-tcp.gif \"Remote calls across firewalls using SOAP or the TcpChannel class\")"},{"content":"Remote calls across firewalls using SOAP or the TcpChannel class","pos":[9938,10002]},{"content":"Some unmanaged calls can be channeled through SOAP, such as the calls between serviced components and COM.","pos":[10009,10115]},{"pos":[10122,10141],"content":"<bpt id=\"p1\">[</bpt>Back to top<ept id=\"p1\">](#top)</ept>","source":"[Back to top](#top)"},{"pos":[10183,10197],"content":"Related Topics","linkify":"Related Topics","nodes":[{"content":"Related Topics","pos":[0,14]}]},{"content":"Title","pos":[10204,10209]},{"content":"Description","pos":[10210,10221]},{"pos":[10260,10321],"content":"<bpt id=\"p1\">[</bpt>Default Marshaling Behavior<ept id=\"p1\">](default-marshaling-behavior.md)</ept>","source":"[Default Marshaling Behavior](default-marshaling-behavior.md)"},{"content":"Describes the rules that the interop marshaling service uses to marshal data.","pos":[10322,10399]},{"pos":[10404,10483],"content":"<bpt id=\"p1\">[</bpt>Marshaling Data with Platform Invoke<ept id=\"p1\">](marshaling-data-with-platform-invoke.md)</ept>","source":"[Marshaling Data with Platform Invoke](marshaling-data-with-platform-invoke.md)"},{"content":"Describes how to declare method parameters and pass arguments to functions exported by unmanaged libraries.","pos":[10484,10591]},{"pos":[10596,10667],"content":"<bpt id=\"p1\">[</bpt>Marshaling Data with COM Interop<ept id=\"p1\">](marshaling-data-with-com-interop.md)</ept>","source":"[Marshaling Data with COM Interop](marshaling-data-with-com-interop.md)"},{"content":"Describes how to customize COM wrappers to alter marshaling behavior.","pos":[10668,10737]},{"pos":[10742,10828],"content":"<bpt id=\"p1\">[</bpt>How to: Migrate Managed-Code DCOM to WCF<ept id=\"p1\">](how-to-migrate-managed-code-dcom-to-wcf.md)</ept>","source":"[How to: Migrate Managed-Code DCOM to WCF](how-to-migrate-managed-code-dcom-to-wcf.md)"},{"content":"Describes how to migrate from DCOM to WCF.","pos":[10829,10871]},{"pos":[10876,10952],"content":"<bpt id=\"p1\">[</bpt>How to: Map HRESULTs and Exceptions<ept id=\"p1\">](how-to-map-hresults-and-exceptions.md)</ept>","source":"[How to: Map HRESULTs and Exceptions](how-to-map-hresults-and-exceptions.md)"},{"content":"Describes how to map custom exceptions to HRESULTs and provides the complete mapping from each HRESULT to its comparable exception class in the .NET Framework.","pos":[10953,11112]},{"pos":[11117,11242],"content":"<bpt id=\"p1\">[</bpt>Interoperating Using Generic Types<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms229590(v=vs.100))</ept>","source":"[Interoperating Using Generic Types](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms229590(v=vs.100))"},{"content":"Describes which actions are supported when using generic types for COM interoperability.","pos":[11243,11331]},{"pos":[11336,11382],"content":"<bpt id=\"p1\">[</bpt>Interoperating with Unmanaged Code<ept id=\"p1\">](index.md)</ept>","source":"[Interoperating with Unmanaged Code](index.md)"},{"content":"Describes interoperability services provided by the common language runtime.","pos":[11383,11459]},{"pos":[11464,11584],"content":"<bpt id=\"p1\">[</bpt>Advanced COM Interoperability<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bd9cdfyx(v=vs.100))</ept>","source":"[Advanced COM Interoperability](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bd9cdfyx(v=vs.100))"},{"content":"Provides links to more information about incorporating COM components into your .NET Framework application.","pos":[11585,11692]},{"pos":[11697,11828],"content":"<bpt id=\"p1\">[</bpt>Design Considerations for Interoperation<ept id=\"p1\">](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/61aax4kh(v=vs.100))</ept>","source":"[Design Considerations for Interoperation](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/61aax4kh(v=vs.100))"},{"content":"Provides tips for writing integrated COM components.","pos":[11829,11881]},{"pos":[11889,11908],"content":"<bpt id=\"p1\">[</bpt>Back to top<ept id=\"p1\">](#top)</ept>","source":"[Back to top](#top)"},{"pos":[11945,11954],"content":"Reference","linkify":"Reference","nodes":[{"content":"Reference","pos":[0,9]}]},{"pos":[12031,12050],"content":"<bpt id=\"p1\">[</bpt>Back to top<ept id=\"p1\">](#top)</ept>","source":"[Back to top](#top)"}]}